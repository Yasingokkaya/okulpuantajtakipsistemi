<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okul Puantaj Sistemi</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#192a56" />
    <link href="https://unpkg.com/slim-select@latest/dist/slimselect.css" rel="stylesheet">
    </link>
    <script src="https://unpkg.com/slim-select@latest/dist/slimselect.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        :root {
            --theme-primary: #192a56;
            --theme-accent: #f39c12;
            --sidebar-bg: var(--theme-primary);
            --sidebar-text: #e0e0e0;
            --sidebar-hover-bg: #2c3e50;
            --sidebar-active-bg: var(--theme-accent);
            --light-gray-color: #f4f7f9;
            --dark-text-color: #2c3e50;
            --border-color: #dee2e6;
            --white-color: #ffffff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light-gray-color);
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 230px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 100;

        }

        #settings .panel-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
        }



        .header-back-btn {
            background-color: var(--sidebar-hover-bg);
            padding: 6px 12px;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        #ders-programi .schedule-table th {
            text-align: center !important;
            vertical-align: middle !important;
        }

        #ders-programi .schedule-table thead th {
            background-color: var(--theme-primary);
            color: white;
            font-weight: 600;
            border-color: #12224A;
        }

        #ders-programi .schedule-table tbody th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
            border-color: #dee2e6;
        }

        .program-ust-kontrol {
            align-items: flex-end;
        }

        .program-ust-kontrol .btn,
        .program-ust-kontrol select,
        .program-ust-kontrol input {
            height: 42px;
            box-sizing: border-box;
            vertical-align: middle;
        }

        .program-ust-kontrol .view-toggle .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }


        #ders-programi .schedule-table {
            font-size: 0.85em;
        }

        #ders-programi .schedule-table th,
        #ders-programi .schedule-table td {
            height: 70px;
            padding: 4px;
        }

        #ders-programi .ders-karti {
            padding: 4px;
            font-size: 11px;
        }

        .ders-karti {
            position: relative;
        }

        .ders-karti::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 105%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #34495e;
            color: white;
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: pre;
            z-index: 10;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .ders-karti:hover::after {
            visibility: visible;
            opacity: 1;
        }


        .havuz-aciklama {
            font-size: 0.85em;
            color: #666;
            margin-top: -10px;
            margin-bottom: 10px;
        }

        .havuz-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .havuz-item {
            background-color: var(--white-color);
            border-left: 5px solid var(--info-color);
            border-radius: 6px;
            padding: 10px;
            font-weight: 500;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .havuz-item:hover {
            background-color: #eef1f3;
            border-left-color: var(--theme-accent);
        }

        .kalan-saat {
            background-color: var(--theme-accent);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .havuz-item.dragging {
            opacity: 0.5;
        }

        .schedule-table td.drag-over {
            background-color: #e6f7ff !important;
            border: 2px dashed var(--theme-primary) !important;
        }


        .program-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 25px;
            align-items: flex-start;
        }

        .kontrol-paneli .panel-body {
            padding: 15px;
        }

        .kontrol-paneli-bolumu {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .kontrol-paneli-bolumu h4 {
            margin-top: 0;
            color: var(--theme-primary);
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .havuz-aciklama {
            font-size: 0.85em;
            color: #666;
            margin-top: -10px;
            margin-bottom: 10px;
        }

        .havuz-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .havuz-item {
            background-color: var(--white-color);
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 10px;
            font-weight: 500;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .havuz-item:hover {
            background-color: #eef1f3;
        }

        .kalan-saat {
            background-color: var(--theme-accent);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .program-alani .taslak-etiketi {
            background-color: #fffbe6;
            color: #f39c12;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            border: 1px solid #f39c12;
            margin-left: auto;
        }

        .program-ust-kontrol {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .view-toggle,
        .program-actions {
            display: flex;
            gap: 5px;
        }

        .view-toggle .btn {
            background-color: #f0f0f0;
            color: #555;
            border: 1px solid #ccc;
        }

        .view-toggle .btn.active {
            background-color: var(--theme-primary);
            color: white;
            border-color: var(--theme-primary);
        }

        #ders-programi #tab-container {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 5px;
            background-color: #f8f9fa;
            display: block;
        }

        #ders-programi .tab-link {
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 2px;
            display: inline-block;
        }

        #ders-programi .schedule-table {
            font-size: 0.9em;
        }

        #ders-programi .schedule-table th,
        #ders-programi .schedule-table td {
            height: 90px;
        }

        #ders-programi .ders-karti {
            padding: 4px;
            font-size: 12px;
        }

        @media (max-width: 992px) {
            .program-layout {
                grid-template-columns: 1fr;
            }
        }


        #settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .settings-card {
            background-color: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .settings-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--theme-primary);
        }

        .settings-card .icon {
            font-size: 48px;

            display: block;
            margin-bottom: 15px;
        }


        .settings-card .title {
            font-weight: 600;
            color: var(--dark-text-color);
            font-size: 1em;
        }


        .btn-back-to-settings {
            background-color: var(--sidebar-hover-bg);
            color: var(--white-color);
            padding: 8px 16px;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }


        .ders-karti.has-conflict {
            border: 3px solid var(--danger-color) !important;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }

        .ders-karti.has-conflict::after {
            content: '⚠️';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 18px;
        }


        .btn-add {
            background-color: var(--success-color) !important;
        }



        #ogretmen-kural-tablosu th,
        #ogretmen-kural-tablosu td {
            height: 55px;
            padding: 6px;
            vertical-align: middle;
            text-align: center;
            border-color: #dee2e6;
        }

        #ogretmen-kural-tablosu tbody th {
            background-color: #f8f9fa;
            font-weight: 600;
            font-size: 12px;
            color: #495057;
        }

        #ogretmen-kural-tablosu thead th {
            background-color: #f1f3f5;
            font-weight: 600;
            color: #343a40;
        }

        #ogretmen-kural-tablosu td {
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            color: #333;
            transition: background-color 0.2s ease-in-out;
        }

        #ogretmen-kural-tablosu td.status-musait {
            background-color: #e8f5e9;
        }

        #ogretmen-kural-tablosu td.status-tercihen-bos {
            background-color: #fff9c4;
        }

        #ogretmen-kural-tablosu td.status-kesinlikle-bos {
            background-color: #ffebee;
        }

        #ogretmen-kural-tablosu td:hover {
            background-color: #e9ecef;
        }

        .btn-details {
            background-color: var(--info-color);
        }

        #personel-bilgileri-container .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px 25px;
        }

        #personel-bilgileri-container .info-item {
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        #personel-bilgileri-container .info-item label {
            font-size: 0.9em;
            color: #555;
            display: block;
            margin-bottom: 4px;
        }

        #personel-bilgileri-container .info-item span {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--dark-text-color);
        }

        .sidebar nav {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar nav::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar nav::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar nav::-webkit-scrollbar-thumb {
            background-color: var(--sidebar-hover-bg);
            border-radius: 10px;
            border: 2px solid var(--sidebar-bg);
        }

        .sidebar nav::-webkit-scrollbar-thumb:hover {
            background-color: var(--theme-accent);
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--sidebar-hover-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .sidebar-header img {
            width: 160px;
            height: auto;
            border-radius: 8px;
        }

        .sidebar-header span {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--white-color);
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .sidebar-nav li a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: background-color 0.2s, color 0.2s;
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .sidebar-nav li a:hover {
            background-color: var(--sidebar-hover-bg);
            color: var(--white-color);
        }

        .sidebar-nav li a.active {
            background-color: var(--sidebar-active-bg);
            color: var(--theme-primary);
            font-weight: bold;
        }

        .menu-item-group .accordion-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .menu-item-group .accordion-trigger::after {
            content: '▶';
            font-size: 0.7em;
            transition: transform 0.2s;
        }

        .menu-item-group.open>.accordion-trigger::after {
            transform: rotate(90deg);
        }

        .sub-menu {
            list-style: none;
            padding-left: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            background-color: rgba(0, 0, 0, 0.2);
        }

        .sidebar-footer a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .sidebar-footer a:hover {
            background-color: var(--danger-color);
            color: var(--white-color);
        }

        .menu-item-group.open .sub-menu {
            max-height: 500px;
        }

        .sub-menu li a {
            padding-left: 45px;
            font-size: 0.95em;
        }

        .sub-menu li a.active {
            color: var(--white-color);
            background-color: transparent;
            border-left-color: var(--theme-accent);
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 10px 0;
            border-top: 1px solid var(--sidebar-hover-bg);
            flex-shrink: 0;
        }

        .sidebar-footer a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .sidebar-footer a:hover {
            background-color: var(--danger-color);
            color: var(--white-color);
        }

        .sidebar-footer a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .sidebar-footer a:hover {
            background-color: var(--danger-color);
            color: var(--white-color);
        }

        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 25px;
            margin-left: 230px;
        }

        .module {
            display: none;
        }

        .module.active {
            display: block;
        }

        .panel {
            background-color: var(--white-color);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .panel-header {
            padding: 18px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h3 {
            margin: 0;
            font-size: 1.2em;
            color: var(--dark-text-color);
        }

        .panel-body {
            padding: 25px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(44, 62, 80, 0.85);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background-color: var(--light-gray-color);
            border-radius: 10px;
            width: 90%;
            max-width: 900px;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 25px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--white-color);
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2em;
            color: var(--theme-primary);
        }

        .close-modal {
            font-size: 1.8rem;
            font-weight: bold;
            color: #aaa;
            background: none;
            border: none;
            cursor: pointer;
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px 25px;
        }

        #gorevlendirme .form-container .form-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .button-group {
            text-align: right;
            margin-top: 15px;
        }

        .izin-hesaplama-alani {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 15px;
            margin-bottom: 20px;
        }

        #personel-izin-hakki,
        #izin-hesaplama-sonucu {
            flex: 1;
            padding: 12px;
            background-color: #eef1f3;
            border-radius: 6px;
            border: 1px solid #d8dde2;
            font-size: 14px;
            color: #37474f;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #izin-hesaplama-sonucu {
            font-weight: bold;
            background-color: #e6f7ff;
            border-color: #b3e0ff;
            color: #0056b3;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--white-color);
        }

        td.actions-cell {
            width: auto;
            min-width: 160px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .actions-cell .btn {
            flex: 1;
        }

        .btn-edit {
            background-color: var(--info-color);
        }

        .btn-delete {
            background-color: var(--danger-color);
        }

        .btn-save {
            padding: 12px 30px;
            background-color: var(--theme-accent);
        }

        .btn-header-add {
            background-color: var(--theme-accent);
            color: var(--white-color);
            font-weight: bold;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        table.staff-table {
            width: 100%;
            border-collapse: collapse;
        }

        table.staff-table th,
        table.staff-table td {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            text-align: left;
            vertical-align: middle;
        }

        table.staff-table th {
            background-color: var(--light-gray-color);
            font-weight: 600;
            color: var(--dark-text-color);
        }

        .radio-group {
            display: flex;
            align-items: center;
            gap: 25px;
            padding-top: 5px;
        }

        .radio-group div {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-group label {
            font-weight: normal;
            margin-bottom: 0;
        }

        .radio-group input {
            width: auto;
            margin-right: 0;
        }

        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 15px 20px;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.3s forwards;
        }

        .toast.success {
            background-color: var(--success-color);
        }

        .toast.error {
            background-color: var(--danger-color);
        }


        .filter-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .filter-container .form-group {
            margin-bottom: 0;
        }

        .toast.info {
            background-color: var(--info-color);
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .settings-tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .settings-tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 16px;
            border-bottom: 3px solid transparent;
        }

        .settings-tab-button.active {
            color: var(--theme-primary);
            border-bottom-color: var(--theme-primary);
            font-weight: 600;
        }

        .settings-tab-content {
            display: none;
            padding: 15px 25px 25px 25px;
        }

        .settings-tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .settings-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        .settings-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .add-setting-form {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .add-setting-form input,
        .add-setting-form select {
            margin-bottom: 0;
        }

        .add-setting-form button {
            flex-shrink: 0;
            height: 46px;
            background-color: var(--success-color);
        }

        .tab-container {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-link {
            padding: 12px 25px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 18px;
            font-weight: 500;
            color: #606770;
            border-bottom: 3px solid transparent;
        }

        .tab-link.active {
            color: #1877f2;
            border-bottom: 3px solid #1877f2;
        }

        .form-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f7f8fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        #ekleBtn {
            padding: 10px 20px;
            background-color: #42b72a;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            height: 46px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .schedule-table th,
        .schedule-table td {
            border: 1px solid #e9ebee;
            padding: 6px;
            text-align: center;
            height: 75px;
            vertical-align: top;
        }

        .ders-karti {
            background-color: #1877f2;
            color: white;
            padding: 6px;
            border-radius: 6px;
            font-size: 13px;
            height: calc(100% - 12px);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .detail-entry {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: flex-end;
            margin-top: 15px;
        }

        #edit-g-detay-ekle-btn {
            background-color: var(--success-color);
        }


        #gecici-detay-listesi {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }

        #g-detay-ekle-btn {
            background-color: #28a745;
        }

        #gecici-detay-listesi {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }

        #gecici-detay-listesi li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .delete-temp-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-weight: bold;
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 20px;
        }

        .gorevlendirme-table {
            width: 100%;
            border-collapse: collapse;
        }

        .gorevlendirme-table thead th {
            background-color: #343a40;
            color: white;
            font-weight: 600;
            padding: 12px;
            text-align: left;
        }

        .gorevlendirme-table tbody td {
            border-top: 1px solid var(--border-color);
            padding: 12px;
            vertical-align: middle;
        }

        .gorevlendirme-table tbody tr:hover {
            background-color: #f1f9ff;
        }

        .gorevlendirme-table .ders-detaylari {
            list-style-type: square;
            margin: 0;
            padding-left: 20px;
        }

        #nobet-rapor-tbody .btn-delete-nobet,
        #izin-kayitlari-tbody .btn-delete-izin {
            background-color: var(--danger-color);
            padding: 5px 10px;
            font-size: 12px;
        }

        .gorevlendirme-table tbody tr.renk-a {
            background-color: #fdfdfe;
        }

        .gorevlendirme-table tbody tr.renk-b {
            background-color: #f0f3f5;
        }

        .gorevlendirme-table tbody tr.renk-a:hover,
        .gorevlendirme-table tbody tr.renk-b:hover {
            background-color: #e6f7ff;
        }

        .puantaj .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .puantaj .controls-left,
        .puantaj .controls-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .puantaj .controls button,
        .puantaj .export-buttons button {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #btn-generate {
            background-color: #0056b3;
            color: white;
        }

        .puantaj .export-buttons button {
            background-color: #6c757d;
            color: white;
        }

        .puantaj .export-buttons button:hover,
        #btn-generate:hover {
            opacity: 0.85;
        }

        .puantaj-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        .puantaj-table th,
        .puantaj-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            vertical-align: middle;
            min-width: 40px;
        }

        .puantaj-table thead th {
            background-color: #343a40;
            color: white;
            font-weight: 600;
            padding: 10px 8px;
            position: sticky;
            top: 0;
            z-index: 2;
            font-size: 13px;
        }

        .puantaj-table tbody tr:hover>td {
            background-color: #f1f9ff;
        }

        .header-main-title {
            background-color: #495057 !important;
        }

        .col-personel {
            min-width: 200px;
            text-align: left;
            padding-left: 10px;
            position: sticky;
            left: 0;
            background-color: #fff;
            z-index: 1;
        }

        .puantaj-table tbody tr:hover .col-personel {
            background-color: #f1f9ff;
        }

        .col-unvan {
            min-width: 130px;
        }

        .col-day {
            min-width: 45px;
        }

        .puantaj-table {
            width: 100%;
            border-collapse: collapse;
        }

        .puantaj-table th,
        .puantaj-table td {
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: middle;
            font-size: 12px;
        }

        .puantaj-table thead th {
            background-color: #343a40 !important;
            color: white;
            font-weight: 600;
            padding: 10px 5px;
            position: sticky;
            top: 0;
            z-index: 2;
            font-size: 13px;
        }

        .puantaj-table .col-personel,
        .puantaj-table .col-unvan {
            min-width: 130px;
            font-weight: 500;
            line-height: 1.4;
            padding: 5px;
        }

        .puantaj-table .col-personel {
            position: sticky;
            left: 0;
            background-color: #fff;
            z-index: 1;
        }

        .personel-row-hours {
            border-bottom: 2px solid #adb5bd;
        }



        .vertical-divider {
            border-right: 2px solid #555;
        }

        .horizontal-divider>td {
            border-bottom: 2px solid #333;
        }

        @media print {
            .vertical-divider {
                border-right: 2px solid #000 !important;
            }

            .horizontal-divider>td {
                border-bottom: 2px solid #000 !important;
            }
        }


        @media print {

            .puantaj-table .personel-row-status>td {
                border-bottom: 1.5px solid #000 !important;
            }

            .puantaj-table .week-divider {
                border-right: 1.5px solid #000 !important;
            }
        }

        .puantaj-table tbody tr:hover>td {
            background-color: #f1f9ff !important;
        }

        .puantaj-table .status-cell {
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            height: 32px;
            border-bottom: 1px dashed #b0bec5;
        }

        .puantaj-table .hour-cell {
            font-size: 13px;
            color: #192a56;
            font-weight: 500;
            height: 32px;
        }

        .status-N {
            background-color: #E8F5E9;
            color: #1B5E20;
        }



        .puantaj-table .summary-yellow {
            background-color: #FFECB3;
            font-weight: bold;
        }

        .puantaj-table .summary-green {
            background-color: #C8E6C9;
            font-weight: bold;
        }

        .puantaj-table .summary-nobet {
            background-color: #FFE0B2;
            font-weight: bold;
        }

        .puantaj-table .summary-rehberlik {
            background-color: #C5CAE9;
            font-weight: bold;
        }


        .puantaj-table .summary-overtime {
            background-color: #FFCDD2;
            font-weight: bold;
        }



        .puantaj-table .summary-reason {
            background-color: #D2B4DE;
            font-weight: bold;
        }

        .puantaj-table .summary-missing-day {
            background-color: #AED6F1;
            font-weight: bold;
        }


        .puantaj-table .col-summary-count,
        .puantaj-table .social-section,
        .puantaj-table .total-worked-day {
            background-color: #E3F2FD !important;
            font-weight: 500;
        }

        .puantaj-table .total-worked-day {
            font-weight: bold;
        }

        .puantaj-table tbody tr:hover>td,
        .puantaj-table tbody tr:hover+.personel-row-hours>td {
            background-color: #f1f9ff;
        }

        .status-İ {
            background-color: #E6E6FA;
            color: #483D8B;
        }

        .status-Üİ {
            background-color: #EAECEE;
            color: #566573;
        }

        .status-K {
            background-color: #D7F9E9;
            color: #1B5E20;
        }

        .status-R {
            background-color: #FFEBEE;
            color: #B71C1C;
        }

        .status-UI {
            background-color: #E4E7EB;
            color: #37474f;
        }

        .status-S {
            background-color: #FFF9C4;
            color: #AF6000;
        }

        .status-Y {
            background-color: #D7F9E9;
            color: #1B5E20;
        }

        .status-E {
            background-color: #EEEEEE;
            color: #424242;
            font-weight: normal;
        }

        .status-RT {
            background-color: #D1EAFE;
            color: #0D47A1;
        }

        .status-RTÇ {
            background-color: #E1BEE7;
            color: #4A148C;
        }

        .status-HT {
            background-color: #FFEBCC;
            color: #B85B00;
        }

        .puantaj-legend {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            gap: 15px 25px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 13px;
        }

        .legend-color-box {
            width: 16px;
            height: 16px;
            border: 1px solid #bdbdbd;
            margin-right: 8px;
            display: inline-block;
        }

        .bottom-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .summary-totals,
        .approval-section {
            flex: 0 1 400px;
        }

        .summary-totals h3,
        .approval-section h3 {
            margin-top: 0;
            color: #495057;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #f1f1f1;
            font-size: 15px;
        }

        .total-line .label {
            font-weight: 500;
        }

        .total-line .value {
            font-weight: 700;
        }

        .approval-section {
            text-align: center;
        }

        .approval-section .name {
            margin-top: 40px;
            font-weight: 600;
        }

        #edit-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10;
            display: none;
        }

        #edit-modal-overlay .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 10px;
            z-index: 11;
            width: 350px;
        }

        #edit-modal-overlay .modal-buttons {
            text-align: right;
            margin-top: 20px;
        }

        #edit-modal-overlay .modal-buttons button {
            padding: 8px 16px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin-left: 10px;
        }

        #modal-save {
            background-color: #198754;
            color: white;
        }

        #modal-cancel {
            background-color: #6c757d;
            color: white;
        }

        @media print {

            @page {
                margin: 1cm;

            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body,
            html {
                background-color: #fff !important;
                font-size: 10pt;
                overflow: visible !important;
            }

            .main-content {
                padding: 0 !important;
                overflow: visible !important;
                margin-left: 0 !important;
            }

            .sidebar,
            .mobile-header,
            .panel-header,
            .controls.puantaj,
            .no-print,
            .modal-overlay,
            #add-staff-modal,
            #logout-btn,
            #btn-nobet-yazdir,
            #gorevlendirme .gorevlendirme-form-area {
                display: none !important;
            }


            #puantaj,
            #puantaj .panel,
            #puantaj-table-container {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
            }

            .puantaj-table {
                width: 100% !important;
                border-collapse: collapse !important;
            }

            .puantaj-table th,
            .puantaj-table td {
                border: 1px solid #999 !important;
                padding: 4px 2px !important;
                text-align: center !important;
                vertical-align: middle !important;
            }


            .puantaj-table thead th {
                font-size: 8pt !important;
                font-weight: bold !important;
                white-space: normal !important;
                vertical-align: bottom !important;
                padding-bottom: 6px !important;
            }

            .puantaj-table .col-personel,
            .puantaj-table .col-unvan {
                font-size: 9pt !important;
                text-align: left !important;
                padding-left: 5px !important;
                white-space: normal !important;
                vertical-align: middle !important;
            }

            .puantaj-table .col-personel {
                min-width: 90px !important;
            }

            .puantaj-table .col-unvan {
                min-width: 80px !important;
            }

            .puantaj-table .hour-cell {
                font-size: 9pt !important;
                font-weight: bold !important;
                color: #000 !important;
            }

            .puantaj-table .status-cell {
                font-size: 10pt !important;
                font-weight: bold !important;
            }


            .gorevlendirme-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 9pt;
            }

            .gorevlendirme-table th,
            .gorevlendirme-table td {
                border: 1px solid #666;
                padding: 8px;
                text-align: left;
            }

            .gorevlendirme-table th {
                background-color: #f0f0f0;
                font-weight: bold;
            }

            #puantaj-baslik {
                display: block !important;
                text-align: center !important;
                font-size: 14pt !important;
                font-weight: bold;
                margin-top: 20px;
                margin-bottom: 25px !important;
                color: black !important;
            }
        }


        @media print {

            body,
            html {
                background-color: #fff;
                overflow: visible;
                height: auto;
            }

            .sidebar,
            .panel-header,
            .form-container,
            #btn-nobet-yazdir {
                display: none !important;
            }

            .main-content {
                padding: 0;
                overflow: visible;
            }

            .module {
                display: none !important;
            }

            .module.active {
                display: block !important;
            }

            .panel {
                box-shadow: none;
                border: none;
            }

            #nobet-rapor-alani {
                display: block !important;
            }

            .table-container {
                overflow: visible;
                border: none;
            }

            .no-print {
                display: none !important;
            }
        }

        .ders-karti {
            position: relative;
        }

        .delete-lesson-btn {
            position: absolute;
            top: -2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.4);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            padding: 0;
        }

        .delete-lesson-btn:hover {
            background: var(--danger-color);
        }

        .mobile-header {
            display: none;
            background-color: var(--theme-primary);
            color: var(--white-color);
            padding: 10px 15px;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 101;
        }

        #hamburger-btn {
            background: none;
            border: none;
            color: var(--white-color);
            font-size: 28px;
            cursor: pointer;
            padding: 0 15px 0 0;
        }

        .mobile-title {
            font-size: 1.1em;
            font-weight: bold;
        }

        .mobile-logo {
            height: 35px;
            width: auto;
            margin-right: 15px;
        }




        @media (max-width: 768px) {
            .sidebar-header {
                display: none;
            }

            html,
            body {
                height: auto;
            }

            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 99;
                display: none;
                transition: background-color 0.3s ease-in-out;
            }

            .mobile-header {
                display: flex;
            }

            .app-container {
                flex-direction: column;
                height: auto;
            }

            .sidebar {
                position: fixed;
                left: -250px;
                top: 0;
                height: 100vh;
                width: 250px;
                z-index: 100;
                transition: left 0.3s ease-in-out;
                border-right: 1px solid var(--sidebar-hover-bg);
            }

            .sidebar.open {
                left: 0;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 15px;
            }


            #gorevlendirme .form-container .form-grid,
            #gorevlendirme .gorevlendirme-layout,
            .form-grid {
                grid-template-columns: 1fr;
            }

            .puantaj .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .puantaj .controls-left,
            .puantaj .controls-right {
                flex-direction: column;
                width: 100%;
            }

            .puantaj .controls button,
            .puantaj .export-buttons button {
                width: 100%;
            }
        }

        .overtime-reason-input {
            width: 95%;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px;
            box-sizing: border-box;
        }


        .missing-day-code-select {
            padding: 6px 4px;
            font-size: 13px;
            font-weight: bold;
            color: var(--theme-primary);

            .text-align-left {
                text-align: left !important;
            }

            .text-align-center {
                text-align: center !important;
            }

            width: 70px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 5px center;
            background-size: 1em;
        }


        td[style*="background-color"] .overtime-reason-input,
        td[style*="background-color"] .missing-day-code-select {
            background-color: transparent;
            border: 1px solid rgba(0, 0, 0, 0.25);
        }

        td[style*="background-color"] .input-wrapper {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
        }


        #versiyon-listesi li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            background-color: #fff;
        }

        .btn-delete-version {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
        }

        .btn-delete-version:hover {
            opacity: 0.85;
        }


        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .confirmation-buttons .btn {
            padding: 10px 25px;
            font-size: 16px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .card-icon {
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .card-content {
            flex-grow: 1;
        }

        .card-title {
            font-size: 1em;
            font-weight: 600;
            color: #555;
            margin: 0 0 5px 0;
        }

        .card-value {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--theme-primary);
            line-height: 1;
        }

        .card-description {
            font-size: 0.85em;
            color: #777;
        }

        .dashboard-card {
            background-color: var(--white-color);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            padding: 20px;
            gap: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 125px;
        }

        .card-list {
            font-size: 0.9em;
            color: #333;
            max-height: 60px;
            overflow-y: auto;
            width: 100%;
            padding-right: 5px;
        }

        .card-list span {
            display: block;
            padding: 2px 0;
        }

        .card-list .no-data {
            color: #888;
            font-style: italic;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .quick-action-btn {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px 20px;
            border-radius: 8px;
            text-decoration: none;
            color: var(--dark-text-color);
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }

        .quick-action-btn:hover {
            background-color: #e9ecef;
            border-color: #ced4da;
            color: var(--theme-primary);
        }


        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 7px solid #f3f3f3;
            border-top: 7px solid var(--theme-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .skeleton {
            animation: shimmer 1.5s infinite linear;
            background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
            background-size: 200% 100%;
            color: transparent;
            border-radius: 4px;
        }

        .skeleton-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .skeleton-cell {
            height: 48px;
            background-color: #e0e0e0;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .settings-card .icon .bi-people-fill {
            color: #e67e22;
        }

        .settings-card .icon .bi-tag-fill {
            color: #f1c40f;
        }

        .settings-card .icon .bi-airplane-fill {
            color: #3498db;
        }

        .settings-card .icon .bi-shield-fill-check {
            color: #27ae60;
        }

        .settings-card .icon .bi-book-half {
            color: #9b59b6;
        }

        .settings-card .icon .bi-building-fill {
            color: #e74c3c;
        }

        .settings-card .icon .bi-alarm-fill {
            color: #f39c12;
        }

        .settings-card .icon .bi-person-video3 {
            color: #1abc9c;
        }

        .settings-card .icon .bi-puzzle-fill {
            color: #8e44ad;
        }

        .settings-card .icon .bi-mortarboard-fill {
            color: #34495e;
        }

        .settings-card .icon .bi-bank {
            color: #7f8c8d;
        }

        .settings-card .icon .bi-globe {
            color: #2980b9;
        }

        .settings-card .icon .bi-calendar-week-fill {
            color: #d35400;
        }

        .settings-card .icon .bi {
            font-size: 48px;
            line-height: 1;
        }

        .ss-option {
            padding: 8px 12px !important;
            font-weight: 500;
        }

        .option-anaokulu {
            background-color: #fffbe6 !important;
            color: #8a6d3b !important;
        }

        .option-ilkokul {
            background-color: #e6f7ff !important;
            color: #31708f !important;
        }

        .option-ortaokul {
            background-color: #e8f5e9 !important;
            color: #3c763d !important;
        }

        .option-diger {
            background-color: #f8f9fa !important;
            color: #333 !important;
        }

        .sidebar-header .ss-main {
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="spinner-overlay" id="global-spinner">
        <div class="spinner"></div>
    </div>
    <header class="mobile-header">
        <button id="hamburger-btn">☰</button>
        <img src="logo.png" alt="Okul Logosu" class="mobile-logo">
        <span class="mobile-title">Okul Puantaj Sistemi</span>
    </header>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div id="login-panel"
        style="display: none; justify-content: center; align-items: center; height: 100vh; background-color: var(--light-gray-color);">
        <div
            style="width: 100%; max-width: 400px; padding: 40px; background: var(--white-color); border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <h2 style="text-align: center; color: var(--theme-primary); margin-bottom: 30px;">Okul Puantaj Sistemi Giriş
                Paneli</h2>
            <div class="form-group">
                <label for="login-email">E-posta Adresi</label>
                <input type="email" id="login-email" placeholder="ornek@mail.com">
            </div>
            <div class="form-group">
                <label for="login-password">Şifre</label>
                <input type="password" id="login-password">
            </div>
            <p id="login-error" style="color: var(--danger-color); text-align: center; display: none;"></p>
            <button id="login-btn" class="btn btn-save" style="width: 100%; padding: 15px; font-size: 16px;">Giriş
                Yap</button>
        </div>
    </div>
    <div id="toast-container"></div>
    <div class="app-container" style="display: none;">


        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" alt="Okul Puantaj Sistemi Logosu">
                <div id="school-selector-container" style="width: 100%; padding: 10px 0; display: none;">
                    <label for="school-selector" style="font-size: 0.8em; color: #bdc3c7;">Okul Değiştir</label>
                    <select id="school-selector">
                        <option>Yükleniyor...</option>
                    </select>
                </div>
            </div>

            <nav>
                <ul class="sidebar-nav">
                    <li><a class="nav-link active" data-target="dashboard">🏠 <span>Ana Sayfa</span></a></li>
                    <li class="menu-item-group">
                        <a class="accordion-trigger nav-link">👥 <span>Personel Yönetimi</span></a>
                        <ul class="sub-menu">
                            <li><a id="open-add-staff-modal"><span>Yeni Personel Ekle</span></a></li>
                            <li><a class="nav-link" data-target="staff-list"><span>Personel Listesi</span></a></li>
                        </ul>
                    </li>
                    <li><a class="nav-link" data-target="ders-programi">📅 <span>Ders Programı</span></a></li>
                    <li><a class="nav-link" data-target="gorevlendirme">📝 <span>Görevlendirmeler</span></a></li>
                    <li><a class="nav-link" data-target="nobet-takip">🛡️ <span>Nöbet Takip</span></a></li>
                    <li><a class="nav-link" data-target="izin-takip">✈️ <span>İzin Takip</span></a></li>
                    <li><a class="nav-link" data-target="puantaj">📊 <span>Puantaj Cetveli</span></a></li>
                    <li id="super-admin-link" style="display: none;"><a class="nav-link"
                            data-target="super-admin-panel">🔑 <span>Süper Admin</span></a></li>
                    <li><a class="nav-link" data-target="settings">⚙️ <span>Ayarlar</span></a></li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <a id="logout-btn" style="cursor: pointer;">🚪 <span>Çıkış Yap</span></a>
            </div>
        </aside>


        <main class="main-content">
            <div id="dashboard" class="module active">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-icon" style="background-color: #e6f7ff; color: #0056b3;">👥</div>
                        <div class="card-content">
                            <div class="card-title">Aktif Personel</div>
                            <div class="card-value" id="db-aktif-personel">Yükleniyor...</div>
                            <div class="card-description">Sistemde kayıtlı toplam personel</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-icon" style="background-color: #fffbe6; color: #f39c12;">🛡️</div>
                        <div class="card-content">
                            <div class="card-title">Bugün Nöbetçi Olanlar</div>
                            <div class="card-list" id="db-gunun-nobetcileri-list">Yükleniyor...</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-icon" style="background-color: #e6f7e9; color: #28a745;">✈️</div>
                        <div class="card-content">
                            <div class="card-title">Bugün İzinli Olanlar</div>
                            <div class="card-list" id="db-bugun-izinliler-list">Yükleniyor...</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-icon" style="background-color: #feefe8; color: #dc3545;">📝</div>
                        <div class="card-content">
                            <div class="card-title">Bugünkü Görevlendirmeler</div>
                            <div class="card-list" id="db-bugun-gorevli-list">Yükleniyor...</div>
                        </div>
                    </div>
                </div>
                <h3
                    style="margin-top: 35px; color: var(--dark-text-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
                    Aylık Özet</h3>
                <div class="dashboard-grid" style="margin-top: 20px;">

                    <div class="dashboard-card">
                        <div class="card-icon" style="background-color: #eefbec; color: #34a853;">➕</div>
                        <div class="card-content">
                            <div class="card-title">Bu Ayki Toplam Ek Ders</div>
                            <div class="card-value" id="db-aylik-ekders">...</div>
                            <div class="card-description">Tüm personel için</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-icon" style="background-color: #e9f2ff; color: #4285f4;">🛡️</div>
                        <div class="card-content">
                            <div class="card-title">Bu Ayki Toplam Nöbet</div>
                            <div class="card-value" id="db-aylik-nobet">...</div>
                            <div class="card-description">Ek ders karşılığı</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-icon" style="background-color: #fdf3e7; color: #fbbc05;">🧭</div>
                        <div class="card-content">
                            <div class="card-title">Bu Ayki Toplam Rehberlik</div>
                            <div class="card-value" id="db-aylik-rehberlik">...</div>
                            <div class="card-description">Ek ders karşılığı</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-icon" style="background-color: #feebee; color: #ea4335;">🩺</div>
                        <div class="card-content">
                            <div class="card-title">Bu Ay Raporlu Olanlar</div>
                            <div class="card-list" id="db-aylik-raporlular-list">Yükleniyor...</div>
                        </div>
                    </div>
                </div>
                <div class="panel" style="margin-top: 25px;">
                    <div class="panel-header">
                        <h3>Hızlı İşlemler</h3>
                    </div>
                    <div class="panel-body quick-actions">
                        <a class="quick-action-btn nav-link" data-target="staff-list">👥 Personel Listesi</a>
                        <a class="quick-action-btn nav-link" data-target="gorevlendirme">📝 Yeni Görevlendirme</a>
                        <a class="quick-action-btn nav-link" data-target="izin-takip">✈️ Yeni İzin Girişi</a>
                        <a class="quick-action-btn nav-link" data-target="puantaj">📊 Puantaj Cetveli</a>
                    </div>
                </div>
            </div>

            <div id="staff-list" class="module">
                <div class="panel">
                    <div class="panel-header">
                        <h3>Personel Listesi</h3>
                        <button id="add-staff-from-list-btn" class="btn-header-add">Yeni Personel Ekle</button>
                    </div>
                    <div class="panel-body">

                        <div class="filter-container">
                            <div class="form-group">
                                <label for="search-personel-input">Personel Adına Göre Ara</label>
                                <input type="text" id="search-personel-input" placeholder="İsim yazarak arayın...">
                            </div>
                            <div class="form-group">
                                <label for="filter-nevi-select">Personel Nevine Göre Filtrele</label>
                                <select id="filter-nevi-select">
                                    <option value="">Tüm Neviler</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filter-gorev-select">Göreve Göre Filtrele</label>
                                <select id="filter-gorev-select">
                                    <option value="">Tüm Görevler</option>
                                </select>
                            </div>
                            <div class="form-group" style="align-self: flex-end;">
                                <button id="clear-personel-filters-btn" class="btn"
                                    style="width:100%; background-color:#6c757d;">Filtreleri Temizle</button>
                            </div>
                        </div>
                        <div id="personel-table-area">
                        </div>

                    </div>
                </div>
            </div>
            <div id="ders-programi" class="module">
                <div class="program-layout">

                    <div class="kontrol-paneli">
                        <div class="panel">
                            <div class="panel-header">
                                <h3>Kontrol Paneli</h3>
                            </div>
                            <div class="panel-body">
                                <div class="kontrol-paneli-bolumu">
                                    <h4>Manuel Giriş / Hızlı Ekle</h4>
                                    <div class="form-group">
                                        <label>Gün</label>
                                        <select id="gun">
                                            <option value="Pazartesi">Pazartesi</option>
                                            <option value="Salı">Salı</option>
                                            <option value="Çarşamba">Çarşamba</option>
                                            <option value="Perşembe">Perşembe</option>
                                            <option value="Cuma">Cuma</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Ders Saati</label>
                                        <select id="saat"></select>
                                    </div>
                                    <div class="form-group">
                                        <label>Öğretmen</label>
                                        <select id="ogretmen">
                                            <option value="">Öğretmen Seçin...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Ders (Branş)</label>
                                        <select id="dersAdi">
                                            <option value="">Ders Seçin...</option>
                                        </select>
                                    </div>
                                    <button id="ekleBtn" class="btn"
                                        style="background-color: var(--theme-primary); width: 100%; padding: 10px;">Ekle</button>
                                </div>

                                <div class="kontrol-paneli-bolumu">
                                    <h4>Yerleştirme Havuzu</h4>
                                    <p class="havuz-aciklama">Kalan dersleri buradan programa sürükleyip bırakın.</p>
                                    <div id="yerlestirme-havuzu-container" class="havuz-container">
                                    </div>
                                </div>

                                <div class="kontrol-paneli-bolumu">
                                    <h4>Versiyon Yönetimi</h4>
                                    <p id="aktif-versiyon-bilgisi"
                                        style="font-weight: bold; color: var(--theme-primary); background-color: #eef1f3; padding: 8px; border-radius: 4px;">
                                    </p>
                                    <p class="havuz-aciklama">Geçmiş bir versiyonu yüklemek için listeden seçin.</p>
                                    <ul id="versiyon-listesi" class="settings-list"
                                        style="max-height: 150px; margin-top: 10px;"></ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="program-alani">
                        <div class="panel">
                            <div class="panel-header" style="flex-wrap: wrap; gap: 15px;">
                                <h3>Gelişmiş Ders Programı Planlayıcı</h3>
                            </div>
                            <div class="panel-body">
                                <div class="program-ust-kontrol">
                                    <div class="form-group">
                                        <label>Görünüm</label>
                                        <div class="view-toggle">
                                            <button id="sinif-gorunum-btn" class="btn active">Sınıf Görünümü</button>
                                            <button id="ogretmen-gorunum-btn" class="btn">Öğretmen Görünümü</button>
                                        </div>
                                    </div>
                                    <div class="form-group" style="flex-grow: 1;">
                                        <label id="grup-gorunum-label">Görüntülenecek Grup (Sınıf)</label>
                                        <select id="grup-secim-dropdown" class="form-control"
                                            style="padding: 10px; font-size: 15px;"></select>
                                    </div>
                                    <div class="form-group">
                                        <label>Programın Geçerlilik Başlangıç Tarihi</label>
                                        <input type="date" id="etkinTarihInput">
                                    </div>
                                    <div class="form-group">
                                        <label>İşlemler</label>
                                        <div class="program-actions">
                                            <button id="programi-kaydet-btn" class="btn"
                                                style="background-color: var(--theme-accent);">Kaydet</button>
                                            <button id="programi-yayinla-btn" class="btn"
                                                style="background-color: var(--success-color);">Yayınla</button>
                                            <button id="btn-otomatik-doldur" class="btn btn-add">Otomatik
                                                Doldur</button>
                                        </div>
                                    </div>
                                </div>
                                <div id="schedule-display-area" style="margin-top: 20px;"></div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div id="gorevlendirme" class="module">
                <div class="panel">
                    <div class="panel-header">
                        <h3>Detaylı Ders Görevlendirme</h3>
                    </div>
                    <div class="panel-body">
                        <div class="gorevlendirme-form-area no-print">
                            <div class="gorevlendirme-layout">
                                <div class="gorev-panel">
                                    <h4>Ana Bilgiler</h4>
                                    <div class="form-group">
                                        <label for="g-tarih">Tarih</label>
                                        <input type="date" id="g-tarih">
                                    </div>
                                    <div class="form-group">
                                        <label for="g-asil-ogretmen">Asıl Öğretmen</label>
                                        <select id="g-asil-ogretmen"></select>
                                    </div>
                                    <div class="form-group">
                                        <label for="g-gorevli-ogretmen">Görevli Öğretmen</label>
                                        <select id="g-gorevli-ogretmen"></select>
                                    </div>
                                    <div class="form-group">
                                        <label for="g-aciklama">Genel Açıklama</label>
                                        <input type="text" id="g-aciklama" placeholder="Örn: Öğretmenin raporlu olması">
                                    </div>
                                </div>
                                <div class="gorev-panel">
                                    <h4>Ders Dağılımı Detayları</h4>
                                    <div class="detail-entry">
                                        <div class="form-group"><label for="d-sinif-select">Sınıf</label><select
                                                id="d-sinif-select"></select></div>
                                        <div class="form-group"><label for="d-brans-select">Ders (Branş)</label><select
                                                id="d-brans-select"></select></div>
                                        <div class="form-group"><label for="d-saat-select">Saat</label><select
                                                id="d-saat-select"></select></div>
                                        <button id="g-detay-ekle-btn" class="btn">Ekle</button>
                                    </div>
                                    <ul id="gecici-detay-listesi"></ul>
                                    <button id="g-kaydet-btn" class="btn btn-save"
                                        style="width: 100%; margin-top: 15px; padding: 12px;">Tüm Görevlendirmeyi
                                        Kaydet</button>
                                </div>
                            </div>
                        </div>

                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-top: 40px;">
                            <h2 style="margin: 0;">Mevcut Görevlendirmeler</h2>
                            <button id="btn-gorev-yazdir" class="btn btn-header-add no-print"
                                style="background-color: var(--info-color);">Yazdır</button>
                        </div>
                        <div class="table-container">
                            <table class="gorevlendirme-table">
                                <thead>
                                    <tr>
                                        <th>Tarih</th>
                                        <th>Asıl Öğretmen</th>
                                        <th>Görevli Öğretmen</th>
                                        <th>Toplam Saat</th>
                                        <th>Ders Detayları</th>
                                        <th>Açıklama</th>
                                        <th class="no-print">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="gorevlendirme-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="nobet-takip" class="module">
                <div class="panel">
                    <div class="panel-header">
                        <h3>Nöbet Takip ve Raporlama</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-container"
                            style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 25px; border-radius: 8px; margin-bottom: 30px;">
                            <h3 style="margin-top:0; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">Yeni Nöbet
                                Girişi</h3>
                            <div class="form-grid"
                                style="grid-template-columns: 1fr 2fr 2fr 120px; align-items: flex-end;">
                                <div class="form-group"><label for="nobet-tarih">Tarih</label><input type="date"
                                        id="nobet-tarih"></div>
                                <div class="form-group"><label for="nobet-personel">Nöbetçi Personel</label><select
                                        id="nobet-personel">
                                        <option value="">Personel Seçiniz...</option>
                                    </select></div>
                                <div class="form-group"><label for="nobet-yeri">Nöbet Yeri</label><select
                                        id="nobet-yeri">
                                        <option value="">Nöbet Yeri Seçiniz...</option>
                                    </select></div>
                                <button id="nobet-ekle-btn" class="btn"
                                    style="background-color: #0056b3; height: 46px;">Nöbet Ekle</button>
                            </div>
                        </div>

                        <div class="form-container"
                            style="background-color: #eef1f3; border: 1px solid #d8dde2; padding: 25px; border-radius: 8px; margin-bottom: 30px;">
                            <h3 style="margin-top:0; border-bottom: 2px solid #ced4da; padding-bottom: 10px;">Aylık
                                Nöbet Çizelgesini Kopyala</h3>
                            <div class="form-grid"
                                style="grid-template-columns: 1fr 1fr 1fr 1fr 150px; align-items: flex-end; gap: 15px;">
                                <div class="form-group">
                                    <label for="copy-source-month">Kaynak Ay</label>
                                    <select id="copy-source-month"></select>
                                </div>
                                <div class="form-group">
                                    <label for="copy-source-year">Kaynak Yıl</label>
                                    <input type="number" id="copy-source-year" min="2020" max="2050"
                                        style="padding: 12px;">
                                </div>
                                <div class="form-group">
                                    <label for="copy-dest-month">Hedef Ay</label>
                                    <select id="copy-dest-month"></select>
                                </div>
                                <div class="form-group">
                                    <label for="copy-dest-year">Hedef Yıl</label>
                                    <input type="number" id="copy-dest-year" min="2020" max="2050"
                                        style="padding: 12px;">
                                </div>
                                <button id="copy-schedule-btn" class="btn"
                                    style="background-color: var(--theme-accent); height: 46px;">Çizelgeyi
                                    Kopyala</button>
                            </div>
                        </div>
                        <div id="nobet-rapor-alani">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <h3 style="margin-top: 40px; margin-bottom: 10px;">Aylık Nöbet Raporu</h3>
                                <div class="no-print" style="display: flex; gap: 10px;">
                                    <button id="btn-nobet-toplu-sil" class="btn btn-header-add"
                                        style="background-color: var(--danger-color);">Seçilenleri Sil</button>
                                    <button id="btn-nobet-yazdir" class="btn btn-header-add"
                                        style="background-color: var(--info-color);">Yazdır</button>
                                </div>
                            </div>
                            <div class="controls"
                                style="display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 25px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                                <div class="controls-left" style="display: flex; align-items: center; gap: 10px;">
                                    <select id="rapor-ay-sec"></select>
                                    <input type="number" id="rapor-yil-gir" min="2020" max="2050">
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="gorevlendirme-table">
                                    <thead>
                                        <tr>
                                            <th>Tarih</th>
                                            <th>Gün</th>
                                            <th>Nöbetçi Personel</th>
                                            <th>Nöbet Yeri</th>
                                            <th class="no-print">İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody id="nobet-rapor-tbody"></tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div id="izin-takip" class="module">
                <div class="panel">
                    <div class="panel-header">
                        <h3>İzin Takip ve Yönetim Modülü</h3>
                        <button id="open-toplu-izin-modal-btn" class="btn-header-add"
                            style="background-color: var(--success-color);">Toplu İzin Girişi</button>
                    </div>

                    <div class="panel-body">
                        <div class="form-container"
                            style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 25px; border-radius: 8px; margin-bottom: 40px;">
                            <h3 style="margin-top:0; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">Yeni İzin
                                Girişi</h3>
                            <div class="form-grid"
                                style="grid-template-columns: 2fr 1.5fr 1fr 1fr; align-items: flex-end;">
                                <div class="form-group">
                                    <label for="izin-personel">Personel</label>
                                    <select id="izin-personel">
                                        <option value="">Personel Seçiniz...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="izin-tipi">İzin Tipi</label>
                                    <select id="izin-tipi">
                                        <option value="">İzin Tipi Seçiniz...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="izin-baslangic">Başlangıç Tarihi</label>
                                    <input type="date" id="izin-baslangic">
                                </div>
                                <div class="form-group">
                                    <label for="izin-bitis">Bitiş Tarihi</label>
                                    <input type="date" id="izin-bitis">
                                </div>
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label for="izin-aciklama">Açıklama / Not</label>
                                    <input type="text" id="izin-aciklama" placeholder="İzinle ilgili kısa bir not...">
                                </div>
                            </div>
                            <div class="izin-hesaplama-alani">
                                <div id="personel-izin-hakki">
                                </div>
                                <div id="izin-hesaplama-sonucu">
                                </div>
                            </div>

                            <div class="button-group">
                                <button id="izin-kaydet-btn" class="btn btn-save">İzin Kaydını Oluştur</button>
                            </div>
                        </div>
                        <h3>Kayıtlı İzinler</h3>
                        <div class="table-container">
                            <table class="gorevlendirme-table">
                                <thead>
                                    <tr>
                                        <th>Personel Adı</th>
                                        <th>İzin Tipi</th>
                                        <th>Başlangıç</th>
                                        <th>Bitiş</th>
                                        <th>Süre (Gün)</th>
                                        <th>Açıklama</th>
                                        <th style="width: 200px;">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="izin-kayitlari-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="puantaj" class="module">
                <div class="panel">
                    <div class="panel-header">
                        <h3>Puantaj Cetveli</h3>
                    </div>
                    <div class="panel-body">
                        <div class="controls puantaj">

                            <div class="controls-left">
                                <select id="select-month"></select>
                                <input type="number" id="input-year" min="2020" max="2050">

                                <button id="btn-show-puantaj"
                                    style="background-color: #0d6efd; color: white; padding: 10px 15px; font-size: 14px; font-weight: 500; border-radius: 6px; border: 1px solid transparent; cursor: pointer;">
                                    Puantajı Göster
                                </button>

                                <button id="btn-generate"
                                    style="background-color: #ffc107; color: #000; padding: 10px 15px; font-size: 14px; font-weight: 500; border-radius: 6px; border: 1px solid transparent; cursor: pointer;">
                                    Yeni Puantaj Oluştur
                                </button>
                                <button id="btn-generate-individual"
                                    style="background-color: #17a2b8; color: white; padding: 10px 15px; font-size: 14px; font-weight: 500; border-radius: 6px; border: 1px solid transparent; cursor: pointer;">
                                    Seçili Personeli Hesapla
                                </button>
                            </div>

                            <div class="personel-filter-container"
                                style="display: flex; align-items: center; gap: 10px; border-left: 2px solid #ced4da; padding-left: 15px; margin-left: 5px; margin-top: 20px;">
                                <select id="personel-filter-select"
                                    style="padding: 9px; border-radius: 6px; border: 1px solid #ced4da; min-width: 200px;"></select>
                                <button id="btn-filter-personel" class="btn"
                                    style="background-color: #17a2b8;">Filtrele</button>
                                <button id="btn-clear-filter" class="btn"
                                    style="background-color: #6c757d;">Temizle</button>
                            </div>
                            <div class="bulk-update-container"
                                style="display: flex; flex-direction: column; gap: 10px; padding: 15px; background-color: #e9ecef; border-radius: 8px; border: 1px solid #ced4da; margin-top: 15px; grid-column: 1 / -1;">
                                <h4 style="margin: 0 0 5px 0; color: var(--theme-primary);">Toplu Güncelleme</h4>
                                <div
                                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; align-items: flex-end;">
                                    <div>
                                        <label for="bulk-update-day"
                                            style="font-size: 13px; font-weight: 500;">Uygulanacak Gün:</label>
                                        <select id="bulk-update-day" class="form-control"
                                            style="padding: 8px;"></select>
                                    </div>
                                    <div>
                                        <label for="bulk-update-group"
                                            style="font-size: 13px; font-weight: 500;">Personel Grubu:</label>
                                        <select id="bulk-update-group" class="form-control" style="padding: 8px;">
                                            <option value="Tümü">Tüm Personel</option>
                                            <option value="Belirli Süreli">Belirli Süreli</option>
                                            <option value="Belirsiz Süreli">Belirsiz Süreli</option>
                                            <option value="Kısmi Süreli">Kısmi Süreli</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="bulk-update-status" style="font-size: 13px; font-weight: 500;">Yeni
                                            Durum Kodu:</label>
                                        <select id="bulk-update-status" class="form-control"
                                            style="padding: 8px;"></select>
                                    </div>
                                    <button id="btn-bulk-update" class="btn"
                                        style="background-color: #6f42c1; color: white; height: 38px;">Uygula</button>
                                </div>
                            </div>


                            <div class="controls-right export-buttons">
                                <button id="btn-save-puantaj" style="background-color: #28a745;">Kaydet</button>
                                <button id="btn-lock-puantaj" style="background-color: #fd7e14;">Puantajı
                                    Kilitle</button>
                                <button id="btn-print">Yazdır</button>
                                <button id="btn-pdf">PDF İndir</button>
                                <button id="btn-excel">Excel İndir</button>
                                <button id="btn-delete-puantaj" style="background-color: var(--danger-color);">Puantajı
                                    Sil</button>
                            </div>
                        </div>
                        <div id="puantaj-table-container" class="table-container"></div>
                        <div id="puantaj-legend" class="puantaj-legend"></div>
                        <div id="bottom-section" class="bottom-section">
                            <div class="summary-totals">
                                <h3>Aylık Genel Toplamlar</h3>
                                <div class="total-line"><span class="label">Ek Ders Saati Toplamı:</span><span
                                        id="total-ekders" class="value">0</span></div>
                                <div class="total-line"><span class="label">Nöbet Toplamı:</span><span id="total-nobet"
                                        class="value">0</span></div>
                                <div class="total-line"><span class="label">Rehberlik Toplamı:</span><span
                                        id="total-rehberlik" class="value">0</span></div>
                            </div>
                            <div class="approval-section">
                                <h3>Onay</h3>
                                <div class="name">Adı Soyadı</div>
                                <div>Okul Müdürü</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div id="super-admin-panel" class="module">
                <div class="panel" style="margin-bottom: 25px;">
                    <div class="panel-header">
                        <h3>Yeni Okul Ekle</h3>
                    </div>
                    <div class="panel-body">
                        <form id="newSchoolForm">
                            <div class="form-group">
                                <label for="newSchoolName">Yeni Okulun Adı</label>
                                <input type="text" id="newSchoolName" placeholder="Örn: Özel İsabet İlkokulu" required>
                            </div>
                            <div class="button-group" style="margin-top: 25px;">
                                <button type="submit" class="btn btn-save">Yeni Okulu Kaydet</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <h3>Süper Admin Paneli - Yeni Okul Yöneticisi Ekle</h3>
                    </div>
                    <div class="panel-body">
                        <form id="newUserForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="newUserEmail">Yönetici E-posta Adresi</label>
                                    <input type="email" id="newUserEmail" required>
                                </div>
                                <div class="form-group">
                                    <label for="newUserPassword">Geçici Şifre</label>
                                    <input type="password" id="newUserPassword" required>
                                </div>
                                <div class="form-group">
                                    <label for="schoolSelect">Kullanıcının Atanacağı Okul</label>
                                    <select id="schoolSelect" required>
                                        <option value="">Okullar yükleniyor...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="button-group" style="margin-top: 25px;">
                                <button type="submit" class="btn btn-save">Yeni Yönetici Oluştur</button>
                            </div>
                        </form>
                        <div id="newUserStatus" style="margin-top: 20px; font-weight: bold;"></div>
                    </div>
                </div>

                <div class="panel" style="margin-top: 25px;">
                    <div class="panel-header">
                        <h3>Tüm Okullar ve Yöneticileri</h3>
                    </div>
                    <div class="panel-body" id="all-admins-list-container">
                    </div>
                </div>
            </div>
            <div id="settings" class="module">

                <div class="panel">
                    <div class="panel-header">
                        <button id="settings-back-btn" class="btn header-back-btn hidden">⬅️ Geri</button>

                        <h3 id="settings-panel-title">Uygulama Ayarları</h3>
                    </div>
                    <div class="panel-body">

                        <div id="settings-grid">
                            <div class="settings-card" data-tab="nevi">
                                <span class="icon"><i class="bi bi-people-fill"></i></span>
                                <span class="title">Personel Nevileri</span>
                            </div>
                            <div class="settings-card" data-tab="gorev">
                                <span class="icon"><i class="bi bi-tag-fill"></i></span>
                                <span class="title">Görevler/Branşlar</span>
                            </div>
                            <div class="settings-card" data-tab="izin-tipi">
                                <span class="icon"><i class="bi bi-airplane-fill"></i></span>
                                <span class="title">İzin Tipleri</span>
                            </div>
                            <div class="settings-card" data-tab="nobet-yeri">
                                <span class="icon"><i class="bi bi-shield-fill-check"></i></span>
                                <span class="title">Nöbet Yerleri</span>
                            </div>
                            <div class="settings-card" data-tab="ders">
                                <span class="icon"><i class="bi bi-book-half"></i></span>
                                <span class="title">Dersler</span>
                            </div>
                            <div class="settings-card" data-tab="sinif">
                                <span class="icon"><i class="bi bi-building-fill"></i></span>
                                <span class="title">Sınıflar</span>
                            </div>
                            <div class="settings-card" data-tab="zaman-cizelgesi">
                                <span class="icon"><i class="bi bi-alarm-fill"></i></span>
                                <span class="title">Zaman Çizelgesi</span>
                            </div>
                            <div class="settings-card" data-tab="ogretmen-kural">
                                <span class="icon"><i class="bi bi-person-video3"></i></span>
                                <span class="title">Öğretmen Kuralları</span>
                            </div>
                            <div class="settings-card" data-tab="ders-brans-kurallari">
                                <span class="icon"><i class="bi bi-puzzle-fill"></i></span>
                                <span class="title">Ders (Branş) Kuralları</span>
                            </div>
                            <div class="settings-card" data-tab="ogrenci-kurallari">
                                <span class="icon"><i class="bi bi-mortarboard-fill"></i></span>
                                <span class="title">Öğrenci Odaklı Kurallar</span>
                            </div>
                            <div class="settings-card" data-tab="derslik-yonetimi">
                                <span class="icon"><i class="bi bi-bank"></i></span>
                                <span class="title">Derslik Yönetimi</span>
                            </div>
                            <div class="settings-card" data-tab="genel-kurallar">
                                <span class="icon"><i class="bi bi-globe"></i></span>
                                <span class="title">Genel Kurallar</span>
                            </div>
                            <div class="settings-card" data-tab="seminer-donemi">
                                <span class="icon"><i class="bi bi-calendar-week-fill"></i></span>
                                <span class="title">Seminer Dönemleri</span>
                            </div>
                        </div>

                        <div id="nevi-tab" class="settings-tab-content">
                            <div class="add-setting-form">
                                <input type="text" id="add-nevi-input" placeholder="Yeni personel nevi adı...">
                                <button id="add-nevi-btn" class="btn">Ekle</button>
                            </div>
                            <ul id="nevi-list" class="settings-list"></ul>
                        </div>

                        <div id="gorev-tab" class="settings-tab-content">
                            <div class="add-setting-form">
                                <select id="gorev-nevi-select">
                                    <option value="">Önce Personel Nevi Seçin</option>
                                </select>
                                <input type="text" id="add-gorev-input" placeholder="Yeni görev/branş adı...">
                                <button id="add-gorev-btn" class="btn">Ekle</button>
                            </div>
                            <ul id="gorev-list" class="settings-list"></ul>
                        </div>

                        <div id="ders-tab" class="settings-tab-content">
                            <div class="add-setting-form"
                                style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px;">
                                <input type="text" id="add-ders-input"
                                    placeholder="Yeni dersin tam adı (Örn: Matematik)">
                                <input type="text" id="add-ders-kisaltma-input" placeholder="Kısaltma (Örn: MTM)"
                                    maxlength="3" style="text-transform: uppercase;">
                                <button id="add-ders-btn" class="btn">Ekle</button>
                            </div>
                            <ul id="ders-list" class="settings-list"></ul>
                        </div>

                        <div id="sinif-tab" class="settings-tab-content">
                            <div class="add-setting-form">
                                <input type="text" id="add-sinif-input" placeholder="Yeni sınıf adı...">
                                <button id="add-sinif-btn" class="btn">Ekle</button>
                            </div>
                            <ul id="sinif-list" class="settings-list"></ul>
                        </div>

                        <div id="nobet-yeri-tab" class="settings-tab-content">
                            <div class="add-setting-form">
                                <input type="text" id="add-nobet-yeri-input" placeholder="Yeni nöbet yeri adı...">
                                <button id="add-nobet-yeri-btn" class="btn">Ekle</button>
                            </div>
                            <ul id="nobet-yeri-list" class="settings-list"></ul>
                        </div>

                        <div id="izin-tipi-tab" class="settings-tab-content">
                            <div class="add-setting-form" style="grid-template-columns: 2fr 1fr auto; display: grid;">
                                <input type="text" id="add-izin-tipi-ad-input"
                                    placeholder="Yeni izin tipi adı (Örn: Yıllık İzin)">
                                <input type="text" id="add-izin-tipi-kod-input" placeholder="Puantaj Kodu (Örn: I)">
                                <button id="add-izin-tipi-btn" class="btn">Ekle</button>
                            </div>
                            <ul id="izin-tipi-list" class="settings-list"></ul>
                        </div>



                        <div id="zaman-cizelgesi-tab" class="settings-tab-content">

                            <p>Ders programı modülü, buradaki ayarlara göre otomatik olarak şekillenecektir.</p>
                            <div class="form-grid">
                                <div class="form-group"><label for="setting-dersBaslangic">Ders Başlama
                                        Saati</label><input type="time" id="setting-dersBaslangic"></div>
                                <div class="form-group"><label for="setting-toplamDers">Günlük Toplam Ders
                                        Sayısı</label><input type="number" id="setting-toplamDers" min="1"></div>
                                <div class="form-group"><label for="setting-dersSuresi">Ders Süresi
                                        (Dakika)</label><input type="number" id="setting-dersSuresi" min="1"></div>
                                <div class="form-group"><label for="setting-teneffusSuresi">Teneffüs Süresi
                                        (Dakika)</label><input type="number" id="setting-teneffusSuresi" min="0"></div>
                                <div class="form-group"><label for="setting-ogleArasiDersNo">Öğle Arası Kaçıncı Dersten
                                        Sonra?</label><input type="number" id="setting-ogleArasiDersNo" min="0"></div>
                                <div class="form-group"><label for="setting-ogleArasiSuresi">Öğle Arası Süresi
                                        (Dakika)</label><input type="number" id="setting-ogleArasiSuresi" min="0"></div>
                            </div>
                            <div class="button-group">
                                <button id="zaman-cizelgesi-kaydet-btn" class="btn btn-save">Çizelge Ayarlarını
                                    Kaydet</button>
                            </div>
                        </div>
                        <div id="ders-brans-kurallari-tab" class="settings-tab-content">
                            <h3 style="margin-top: 15px;">Ders (Branş) Kuralları</h3>
                            <p>Derslerin haftalık saatlerini, yerleşim tercihlerini ve diğer derslerle ilişkilerini
                                buradan yönetin.</p>
                            <div class="form-grid"
                                style="grid-template-columns: 1fr; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label for="ders-kural-filtre-sinif">Listeyi Sınıfa Göre Filtrele</label>
                                    <select id="ders-kural-filtre-sinif">
                                        <option value="">Tüm Sınıfları Göster</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-grid"
                                style="grid-template-columns: 1fr; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label>Lütfen Kural Eklenecek Dersi Seçerek Başlayın</label>
                                    <select id="kural-ders-sec"></select>
                                </div>
                            </div>
                            <div id="ders-kurali-detaylari" style="display: none;">
                                <div class="form-grid"
                                    style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); align-items: flex-start;">
                                    <input type="hidden" id="editing-ders-kurali-id" value="">
                                    <div class="form-group">
                                        <label>Sınıf Seviyesi</label>
                                        <select id="kural-seviye-sec" multiple style="min-height: 105px;"></select>
                                    </div>
                                    <div class="form-group">
                                        <label>Atanacak Öğretmen (İsteğe Bağlı)</label>
                                        <select id="kural-ogretmen-ata-sec"></select>
                                    </div>
                                    <div class="form-group">
                                        <label>Haftalık Ders Saati</label>
                                        <input type="number" id="kural-haftalik-saat" placeholder="Örn: 6">
                                    </div>
                                    <div class="form-group">
                                        <label>Günlük Max Saat</label>
                                        <input type="number" id="kural-gunluk-max-saat" placeholder="Örn: 2">
                                    </div>
                                </div>
                                <a href="#" id="toggle-detayli-kurallar"
                                    style="display: block; margin: 10px 0; color: var(--theme-primary); text-decoration: none; font-weight: 600;">▶
                                    Detaylı Kuralları Göster/Gizle</a>
                                <div id="detayli-kurallar-container"
                                    style="display: none; background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 10px;">
                                    <div class="form-grid"
                                        style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                        <div class="form-group"><label>Blok Ders</label><select id="kural-blok-ders">
                                                <option value="evet">Evet</option>
                                                <option value="hayir">Hayır</option>
                                            </select></div>
                                        <div class="form-group"><label>Gereken Derslik Tipi</label><select
                                                id="kural-derslik-tipi"></select></div>
                                        <div class="form-group"><label>Yerleşim Tercihi</label><select
                                                id="kural-yerlesim-tercihi">
                                                <option value="farketmez">Fark Etmez</option>
                                                <option value="sabah">Sadece Sabah</option>
                                                <option value="ogle">Sadece Öğleden Sonra</option>
                                                <option value="ilk_ders_olmasin">İlk Ders Olmasın</option>
                                                <option value="son_ders_olmasin">Son Ders Olmasin</option>
                                            </select></div>
                                    </div>
                                    <div class="form-group" style="margin-top: 15px;">
                                        <label>Birlikte Gitmemesi Gereken Dersler (Art arda gelmesin)</label>
                                        <select id="kural-yasakli-dersler-sec" multiple
                                            style="min-height: 100px;"></select>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 25px;">
                                    <button id="ders-kural-ekle-btn" class="btn btn-add"
                                        style="width:100%; padding: 12px;">Kural Ekle/Güncelle</button>
                                </div>
                            </div>
                            <div id="ders-kural-table-container" style="margin-top: 25px;">
                                <div id="ders-kural-filters" class="filter-container"
                                    style="grid-template-columns: repeat(3, 1fr); margin-bottom: 15px; display: none;">
                                    <div class="form-group">
                                        <label>Derse Göre Filtrele</label>
                                        <select id="kural-filter-ders-select">
                                            <option value="">Tüm Dersler</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Sınıfa Göre Filtrele</label>
                                        <select id="kural-filter-sinif-select">
                                            <option value="">Tüm Sınıflar</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Öğretmene Göre Filtrele</label>
                                        <select id="kural-filter-ogretmen-select">
                                            <option value="">Tüm Öğretmenler</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="staff-table" style="font-size: 0.9em;">
                                        <thead>
                                            <tr>
                                                <th>Ders (Branş)</th>
                                                <th>Sınıf</th>
                                                <th>Atanan Öğretmen</th>
                                                <th style="width: 120px;">Haftalık Saat</th>
                                                <th style="width: 120px;">Günlük Max Saat</th>
                                                <th style="width: 180px;">İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ders-kural-tbody">
                                        </tbody>
                                        <tfoot id="ders-kural-tfoot"
                                            style="font-weight: bold; background-color: #f8f9fa;">
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div id="ogrenci-kurallari-tab" class="settings-tab-content">
                            <h3 style="margin-top: 15px;">Öğrenci ve Sınıf Odaklı Kurallar</h3>
                            <div id="zor-ders-form-container">
                                <label>Zorlayıcı Derslerin Dağılımı</label>
                                <p style="font-size: 0.9em; margin-top: 0;">Öğrencilerin bir günde göreceği zor ders
                                    sayısını sınırlayın.</p>
                                <div class="add-setting-form" style="align-items: flex-end;">
                                    <select id="kural-zor-dersler-sec" multiple=""
                                        style="min-height: 100px; flex:3;"></select>
                                    <input type="number" id="kural-gunluk-max-zor-ders" placeholder="Max Sayı"
                                        style="flex:1;">
                                    <button id="zor-ders-kural-kaydet-btn" class="btn btn-save"
                                        style="flex:1;">Kaydet</button>
                                </div>
                            </div>
                            <div id="zor-ders-kural-gosterge"
                                style="display: none; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; justify-content: space-between; align-items: center;">
                                <div>
                                    <label
                                        style="font-weight: bold; color: var(--theme-primary); display: block; margin-bottom: 10px;">Tanımlanmış
                                        Kural</label>
                                    <div style="display: flex; align-items: baseline; gap: 25px;">
                                        <div>
                                            <p style="margin:0 0 5px 0;"><strong>Zorlayıcı olarak seçilen
                                                    dersler:</strong></p>
                                            <ul id="zor-dersler-gosterge-listesi"
                                                style="margin: 0; padding-left: 20px; list-style-type: square;"></ul>
                                        </div>
                                        <p><strong>Bir günde en fazla <span id="max-zor-ders-gosterge"
                                                    style="font-weight: bold; font-size: 1.2em;"></span> zor ders
                                                olabilir.</strong></p>
                                    </div>
                                </div>
                                <div class="button-group"
                                    style="text-align: right; flex-shrink: 0; padding-left: 20px;">
                                    <button id="zor-kural-duzenle-btn" class="btn btn-edit">Kuralı Düzenle</button>
                                    <button id="zor-kural-sil-btn" class="btn btn-delete">Kuralı Sil</button>
                                </div>
                            </div>
                        </div>

                        <div id="derslik-yonetimi-tab" class="settings-tab-content">
                            <h3 style="margin-top: 15px;">Derslik Yönetimi (Fiziksel Kısıtlar)</h3>
                            <p>Fen Lab, Spor Salonu gibi özel ve tek olan derslikleri tanımlayarak çakışmaları önleyin.
                            </p>
                            <div class="add-setting-form" style="align-items: flex-end;">
                                <input type="text" id="derslik-adi-input" placeholder="Örn: Fen Laboratuvarı"
                                    style="flex:2;">
                                <select id="derslik-tipi-select" style="flex:1;">
                                    <option value="Standart">Standart</option>
                                    <option value="Laboratuvar">Laboratuvar</option>
                                    <option value="Spor Salonu">Spor Salonu</option>
                                    <option value="Atölye">Atölye</option>
                                </select>
                                <button id="derslik-ekle-btn" class="btn btn-add" style="flex:1;">Yeni Derslik
                                    Ekle</button>
                            </div>
                            <ul id="derslik-listesi" class="settings-list"></ul>
                        </div>

                        <div id="genel-kurallar-tab" class="settings-tab-content">
                            <h3 style="margin-top: 15px;">Genel Kurallar (Tüm Okul İçin Geçerli)</h3>
                            <div class="form-group">
                                <label>Genel Bloke Zamanlar (Tören, Etkinlik vb.)</label>
                                <p style="font-size: 0.9em; margin-top: 0;">Burada seçilen zaman dilimlerine hiçbir
                                    sınıfa ders atanmaz.</p>
                                <div class="add-setting-form">
                                    <select id="genel-bloke-gun" style="flex:2;">
                                        <option>Pazartesi</option>
                                        <option>Salı</option>
                                        <option>Çarşamba</option>
                                        <option>Perşembe</option>
                                        <option>Cuma</option>
                                    </select>
                                    <select id="genel-bloke-saat" style="flex:1;"></select>
                                    <button id="genel-bloke-ekle-btn" class="btn btn-add" style="flex:1;">Bloke
                                        Et</button>
                                </div>
                                <ul id="genel-bloke-listesi" class="settings-list" style="max-height: 100px;"></ul>
                            </div>
                        </div>

                        <div id="seminer-donemi-tab" class="settings-tab-content">
                            <p>Belirli süreli personelin ek derslerinin farklı hesaplanacağı seminer, hizmet içi eğitim
                                gibi özel dönemleri buradan yönetebilirsiniz.</p>
                            <div class="add-setting-form"
                                style="grid-template-columns: 2fr 1fr 1fr auto; display: grid;">
                                <input type="text" id="add-seminer-donemi-ad-input"
                                    placeholder="Dönem Adı (Örn: Eylül Semineri)">
                                <input type="date" id="add-seminer-donemi-baslangic-input">
                                <input type="date" id="add-seminer-donemi-bitis-input">
                                <button id="add-seminer-donemi-btn" class="btn">Ekle</button>
                            </div>
                            <ul id="seminer-donemi-list" class="settings-list"></ul>
                        </div>
                        <div id="ogretmen-kural-modal" class="modal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3>Öğretmen Kurallarını Düzenle</h3>
                                    <button class="close-modal">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label for="kural-ogretmen-sec">Ayarları Düzenlenecek Öğretmen</label>
                                        <select id="kural-ogretmen-sec"></select>
                                    </div>
                                    <div id="ogretmen-kural-bilgi"
                                        style="background-color:#f8f9fa; border:1px solid #dee2e6; padding:15px 20px; border-radius:8px; margin-top: 20px; text-align: center;">
                                        <p style="margin:0; font-size:1em; color:var(--dark-text-color);">Kurallarını
                                            görüntülemek ve düzenlemek için lütfen yukarıdaki listeden bir öğretmen
                                            seçin.</p>
                                    </div>

                                    <div id="ogretmen-kural-formu"
                                        style="border-top: 1px solid var(--border-color); padding-top: 20px; display:none;">

                                        <div
                                            style="background-color:#f8f9fa; border:1px solid #dee2e6; padding:15px 20px; border-radius:8px; margin-bottom: 25px; font-size: 0.9em; line-height: 1.6;">
                                            <h4 style="margin-top:0; color:var(--dark-text-color);">Kişisel Zaman
                                                Planlaması
                                                (Bloke ve Tercih Edilmeyen Günler)</h4>
                                            <p style="margin-bottom:0;">Hücrelere tıklayarak algoritmanın ders atama
                                                davranışını
                                                kişisel programınıza göre şekillendirebilirsiniz.
                                            </p>
                                        </div>

                                        <div class="table-container" style="margin-bottom: 25px;">
                                            <table id="ogretmen-kural-tablosu" class="schedule-table"></table>
                                        </div>

                                        <div class="form-grid">
                                            <div class="form-group"><label for="ogretmen-max-gunluk-ders">Maksimum
                                                    Günlük Ders
                                                    Saati</label><input type="number" id="ogretmen-max-gunluk-ders"
                                                    placeholder="Örn: 8"></div>
                                            <div class="form-group"><label for="ogretmen-max-ardisik-ders">Maksimum
                                                    Ardışık Ders
                                                    Saati</label><input type="number" id="ogretmen-max-ardisik-ders"
                                                    placeholder="Örn: 3"></div>
                                            <div class="form-group"><label for="ogretmen-gunluk-denge">Günlük Ders Yükü
                                                    Dengesi
                                                    (Max Fark)</label><input type="number" id="ogretmen-gunluk-denge"
                                                    placeholder="Örn: 2 Saat"></div>
                                            <div class="form-group"><label for="ogretmen-max-bosluk">Gündeki Maksimum
                                                    Boşluk</label><input type="number" id="ogretmen-max-bosluk"
                                                    placeholder="Örn: 1 Saat"></div>
                                        </div>

                                        <div class="button-group" style="margin-top: 20px;">
                                            <button id="ogretmen-kural-kaydet-btn" class="btn btn-save"
                                                style="width: 100%;">Öğretmen Kurallarını Kaydet</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

        </main>

        <div id="edit-gorevlendirme-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Detaylı Ders Görevlendirme Düzenle</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editGorevlendirmeForm">
                        <input type="hidden" id="edit-g-id">
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="form-group">
                                <label for="edit-g-tarih">Tarih</label>
                                <input type="date" id="edit-g-tarih">
                            </div>
                            <div class="form-group">
                                <label for="edit-g-asil-ogretmen">Asıl Öğretmen</label>
                                <select id="edit-g-asil-ogretmen"></select>
                            </div>
                            <div class="form-group">
                                <label for="edit-g-gorevli-ogretmen">Görevli Öğretmen</label>
                                <select id="edit-g-gorevli-ogretmen"></select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="edit-g-aciklama">Genel Açıklama</label>
                            <input type="text" id="edit-g-aciklama">
                        </div>

                        <div class="detail-entry" style="margin-top: 25px;">
                            <div class="form-group"><label for="edit-d-sinif-select">Sınıf</label><select
                                    id="edit-d-sinif-select"></select></div>
                            <div class="form-group"><label for="edit-d-brans-select">Ders (Branş)</label><select
                                    id="edit-d-brans-select"></select></div>
                            <div class="form-group"><label for="edit-d-saat-select">Saat</label><select
                                    id="edit-d-saat-select"></select></div>
                            <button type="button" id="edit-g-detay-ekle-btn" class="btn">Ekle</button>
                        </div>
                        <ul id="edit-g-detay-listesi" style="list-style: none; padding: 0; margin-top: 15px;">
                        </ul>

                        <div class="button-group" style="margin-top:20px;">
                            <button type="submit" class="btn btn-save">Değişiklikleri Kaydet</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="edit-setting-modal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 id="edit-setting-modal-title">Ayar Adını Düzenle</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="edit-setting-input">Ad</label>
                        <input type="text" id="edit-setting-input">
                    </div>
                    <div class="form-group" id="edit-kisaltma-group" style="display: none;">
                        <label for="edit-setting-kisaltma-input">Kısaltma (3 Harf)</label>
                        <input type="text" id="edit-setting-kisaltma-input" maxlength="3"
                            style="text-transform: uppercase;">
                    </div>
                    <div class="button-group">
                        <button id="edit-setting-save-btn" class="btn btn-save">Değişiklikleri Kaydet</button>
                    </div>
                </div>
            </div>
        </div>



        <div id="add-staff-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title">Yeni Personel Ekle</h3><button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="personelForm"></form>
                </div>
            </div>
        </div>
        <div id="edit-modal-overlay" class="modal-overlay">
            <div class="modal-content">
                <h3 id="p-modal-title">Puantaj Günü Düzenle</h3>
                <div class="form-group"><label for="modal-status">Durum</label><select id="modal-status"></select></div>
                <div class="form-group"><label for="modal-hours">Çalışılan Ders Saati</label><input type="number"
                        id="modal-hours" min="0" max="12"></div>
                <div class="form-group"><label for="modal-notes">Açıklama</label><input type="text" id="modal-notes"
                        placeholder="Opsiyonel not..."></div>
                <div class="modal-buttons"><button id="modal-cancel" class="btn">İptal</button><button id="modal-save"
                        class="btn">Kaydet</button></div>
            </div>
        </div>
        <div id="edit-nobet-modal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>Nöbet Kaydını Düzenle</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="edit-nobet-form">
                        <input type="hidden" id="edit-nobet-id">
                        <div class="form-grid" style="grid-template-columns: 1fr 2fr 2fr; align-items: flex-end;">
                            <div class="form-group">
                                <label for="edit-nobet-tarih">Tarih</label>
                                <input type="date" id="edit-nobet-tarih">
                            </div>
                            <div class="form-group">
                                <label for="edit-nobet-personel">Nöbetçi Personel</label>
                                <select id="edit-nobet-personel"></select>
                            </div>
                            <div class="form-group">
                                <label for="edit-nobet-yeri">Nöbet Yeri</label>
                                <select id="edit-nobet-yeri"></select>
                            </div>
                        </div>
                        <div class="button-group" style="margin-top: 20px;">
                            <button type="submit" class="btn btn-save">Değişiklikleri Kaydet</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div id="toplu-izin-modal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3>Toplu İzin Girişi</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p
                        style="margin-top: 0; margin-bottom: 20px; background-color: #eef1f3; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6;">
                        Bu ekranı kullanarak seçili personellere aynı anda, belirtilen tarihler arasında izin
                        atayabilirsiniz. Bu işlem, her bir personel için ayrı bir izin kaydı oluşturacaktır.
                    </p>
                    <div class="form-grid"
                        style="grid-template-columns: 1fr 1fr 2fr; margin-bottom: 20px; align-items: flex-end;">
                        <div class="form-group">
                            <label for="toplu-izin-baslangic">Başlangıç Tarihi</label>
                            <input type="date" id="toplu-izin-baslangic">
                        </div>
                        <div class="form-group">
                            <label for="toplu-izin-bitis">Bitiş Tarihi</label>
                            <input type="date" id="toplu-izin-bitis">
                        </div>
                        <div class="form-group">
                            <label for="toplu-izin-tipi">İzin Tipi</label>
                            <select id="toplu-izin-tipi">
                                <option value="">İzin Tipi Seçiniz...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="margin-bottom: 10px;">İzin Atanacak Personeller</label>
                        <div id="toplu-personel-listesi"
                            style="height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 15px; border-radius: 6px; background: #fdfdfd; display: flex; flex-direction: column; gap: 8px;">
                            <p>Personel listesi yükleniyor...</p>
                        </div>
                    </div>
                    <div class="button-group" style="margin-top: 25px;">
                        <button id="toplu-izin-kaydet-btn" class="btn btn-save">Seçili Personellere İzin Ata</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="dilekce-date-modal" class="modal">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header">
                    <h3>Dilekçe Tarihini Belirtin</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Lütfen dilekçenin üzerinde görünecek resmi tarihi seçiniz.</p>
                    <div class="form-group">
                        <label for="dilekce-tarih-input">Dilekçe Tarihi</label>
                        <input type="date" id="dilekce-tarih-input">
                    </div>
                    <div class="button-group">
                        <button id="generate-dilekce-with-date-btn" class="btn btn-save">Dilekçeyi Oluştur</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="confirmation-modal" class="modal">
            <div class="modal-content" style="max-width: 500px; text-align: center;">
                <div class="modal-header">
                    <h3 id="confirmation-modal-title">İşlemi Onayla</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="confirmation-modal-message" style="font-size: 1.1em; line-height: 1.5;"></p>
                    <div class="confirmation-buttons" style="margin-top: 25px;">
                        <button id="confirm-cancel-btn" class="btn" style="background-color: #6c757d;">İptal</button>
                        <button id="confirm-action-btn" class="btn btn-confirm">Onayla</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="edit-izin-modal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3>İzin Kaydını Düzenle</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="edit-izin-form">
                        <input type="hidden" id="edit-izin-id">
                        <div class="form-grid" style="grid-template-columns: 2fr 1.5fr 1fr 1fr; align-items: flex-end;">
                            <div class="form-group">
                                <label for="edit-izin-personel">Personel</label>
                                <select id="edit-izin-personel" disabled></select>
                            </div>
                            <div class="form-group">
                                <label for="edit-izin-tipi">İzin Tipi</label>
                                <select id="edit-izin-tipi"></select>
                            </div>
                            <div class="form-group">
                                <label for="edit-izin-baslangic">Başlangıç Tarihi</label>
                                <input type="date" id="edit-izin-baslangic">
                            </div>
                            <div class="form-group">
                                <label for="edit-izin-bitis">Bitiş Tarihi</label>
                                <input type="date" id="edit-izin-bitis">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="edit-izin-aciklama">Açıklama / Not</label>
                                <input type="text" id="edit-izin-aciklama" placeholder="İzinle ilgili kısa bir not...">
                            </div>
                        </div>
                        <div class="button-group" style="margin-top: 25px;">
                            <button type="submit" class="btn btn-save">Değişiklikleri Kaydet</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div id="personel-detay-modal" class="modal">
            <div class="modal-content" style="max-width: 1000px;">
                <div class="modal-header">
                    <h3 id="personel-detay-modal-title">Personel Profili</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="settings-tabs" id="personel-detay-tabs">
                        <button class="settings-tab-button active" data-tab="detay-tab-bilgiler">Kişisel
                            Bilgiler</button>
                        <button class="settings-tab-button" data-tab="detay-tab-izinler">İzin Geçmişi</button>
                        <button class="settings-tab-button" data-tab="detay-tab-nobetler">Nöbet Geçmişi</button>
                        <button class="settings-tab-button" data-tab="detay-tab-hizmet">Hizmet Geçmişi</button>
                        <button class="settings-tab-button" data-tab="detay-tab-belgeler">Belgeler</button>
                    </div>

                    <div id="detay-tab-bilgiler" class="settings-tab-content active">
                        <div id="personel-bilgileri-container" style="padding: 20px;">
                            <p>Personel bilgileri yükleniyor...</p>
                        </div>
                    </div>

                    <div id="detay-tab-izinler" class="settings-tab-content">
                        <div id="personel-izin-gecmisi-container" class="table-container"
                            style="margin-top: 20px; max-height: 450px; overflow-y: auto;">
                            <p style="padding: 20px;">İzin geçmişi yükleniyor...</p>
                        </div>
                    </div>

                    <div id="detay-tab-nobetler" class="settings-tab-content">
                        <div id="personel-nobet-gecmisi-container" class="table-container"
                            style="margin-top: 20px; max-height: 450px; overflow-y: auto;">
                            <p style="padding: 20px;">Nöbet geçmişi yükleniyor...</p>
                        </div>
                    </div>

                    <div id="detay-tab-hizmet" class="settings-tab-content">
                    </div>

                    <div id="detay-tab-belgeler" class="settings-tab-content">
                        <p style="padding: 20px; text-align: center; color: #777;">Bu özellik yakında eklenecektir.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="edit-password-modal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 id="edit-password-modal-title">Şifreyi Değiştir</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="edit-password-form">
                        <input type="hidden" id="edit-password-uid">
                        <div class="form-group">
                            <label for="new-password">Yeni Şifre (En az 6 karakter)</label>
                            <input type="password" id="new-password" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">Yeni Şifre (Tekrar)</label>
                            <input type="password" id="confirm-password" required minlength="6">
                        </div>
                        <div class="button-group">
                            <button type="submit" class="btn btn-save">Şifreyi Güncelle</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>



        <template id="personel-form-template">
            <div class="form-grid">
                <div class="form-group">
                    <label for="ad_soyad">Adı Soyadı:</label>
                    <input type="text" id="ad_soyad" name="ad_soyad" required>
                </div>

                <div class="form-group">
                    <label for="tc_kimlik_no">T.C. Kimlik No:</label>
                    <input type="text" id="tc_kimlik_no" name="tc_kimlik_no">
                </div>
                <div class="form-group">
                    <label for="sgk_no">SGK No:</label>
                    <input type="text" id="sgk_no" name="sgk_no">
                </div>
                <div class="form-group">
                    <label for="personel_nevisi">Personel Nevisi:</label>
                    <select id="personel_nevisi" name="personel_nevisi" required>
                        <option value="" disabled selected>Seçim yapınız...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="gorevi_bransi">Görevi / Branşı:</label>
                    <select id="gorevi_bransi" name="gorevi_bransi" required>
                        <option value="" disabled selected>Önce Personel Nevisi seçin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sozlesme_turu">Sözleşme Türü:</label>
                    <select id="sozlesme_turu" name="sozlesme_turu">
                        <option value="Belirsiz Süreli">Belirsiz Süreli Sözleşme</option>
                        <option value="Belirli Süreli">Belirli Süreli Sözleşme</option>
                        <option value="Kısmi Süreli">Kısmi Süreli Sözleşme</option>
                    </select>
                </div>

                <div class="form-group full-width" id="kismi_zamanli_div"
                    style="display: none; background-color: #f0f3f5; padding: 15px; border-radius: 6px;">
                    <label style="font-weight: bold; color: var(--theme-primary); margin-bottom: 5px;">Kısmi Zamanlı
                        Çalışma Saatleri</label>
                    <p style="font-size: 0.9em; margin-top: 0;">Lütfen personelin haftalık çalışma günlerini ve günlük
                        saatlerini belirtin.</p>
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 20px;">

                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" id="pzts_calisiyor" name="kismi_gunler" value="Pazartesi"
                                    style="width: auto; margin-right: 8px;">
                                <label for="pzts_calisiyor" style="margin: 0; font-weight: normal;">Pazartesi</label>
                            </div>
                            <div>
                                <input type="number" id="pzts_saat" name="pzts_saat" min="0" max="12"
                                    style="width: 60px; padding: 8px;">
                                <span style="margin-left: 5px;">saat</span>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" id="sali_calisiyor" name="kismi_gunler" value="Salı"
                                    style="width: auto; margin-right: 8px;">
                                <label for="sali_calisiyor" style="margin: 0; font-weight: normal;">Salı</label>
                            </div>
                            <div>
                                <input type="number" id="sali_saat" name="sali_saat" min="0" max="12"
                                    style="width: 60px; padding: 8px;">
                                <span style="margin-left: 5px;">saat</span>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" id="crs_calisiyor" name="kismi_gunler" value="Çarşamba"
                                    style="width: auto; margin-right: 8px;">
                                <label for="crs_calisiyor" style="margin: 0; font-weight: normal;">Çarşamba</label>
                            </div>
                            <div>
                                <input type="number" id="crs_saat" name="crs_saat" min="0" max="12"
                                    style="width: 60px; padding: 8px;">
                                <span style="margin-left: 5px;">saat</span>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" id="prs_calisiyor" name="kismi_gunler" value="Perşembe"
                                    style="width: auto; margin-right: 8px;">
                                <label for="prs_calisiyor" style="margin: 0; font-weight: normal;">Perşembe</label>
                            </div>
                            <div>
                                <input type="number" id="prs_saat" name="prs_saat" min="0" max="12"
                                    style="width: 60px; padding: 8px;">
                                <span style="margin-left: 5px;">saat</span>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" id="cuma_calisiyor" name="kismi_gunler" value="Cuma"
                                    style="width: auto; margin-right: 8px;">
                                <label for="cuma_calisiyor" style="margin: 0; font-weight: normal;">Cuma</label>
                            </div>
                            <div>
                                <input type="number" id="cuma_saat" name="cuma_saat" min="0" max="12"
                                    style="width: 60px; padding: 8px;">
                                <span style="margin-left: 5px;">saat</span>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" id="cmrts_calisiyor" name="kismi_gunler" value="Cumartesi"
                                    style="width: auto; margin-right: 8px;">
                                <label for="cmrts_calisiyor" style="margin: 0; font-weight: normal;">Cumartesi</label>
                            </div>
                            <div>
                                <input type="number" id="cmrts_saat" name="cmrts_saat" min="0" max="12"
                                    style="width: 60px; padding: 8px;">
                                <span style="margin-left: 5px;">saat</span>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" id="pazar_calisiyor" name="kismi_gunler" value="Pazar"
                                    style="width: auto; margin-right: 8px;">
                                <label for="pazar_calisiyor" style="margin: 0; font-weight: normal;">Pazar</label>
                            </div>
                            <div>
                                <input type="number" id="pazar_saat" name="pazar_saat" min="0" max="12"
                                    style="width: 60px; padding: 8px;">
                                <span style="margin-left: 5px;">saat</span>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="form-group">
                    <label>Cinsiyet:</label>
                    <div class="radio-group">
                        <div><input type="radio" id="cinsiyet_kadin" name="cinsiyet" value="kadin" checked><label
                                for="cinsiyet_kadin">Kadın</label></div>
                        <div><input type="radio" id="cinsiyet_erkek" name="cinsiyet" value="erkek"><label
                                for="cinsiyet_erkek">Erkek</label></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Eş Durumu:</label>
                    <div class="radio-group">
                        <div><input type="radio" id="es_calismiyor" name="es_durumu" value="calismiyor" checked><label
                                for="es_calismiyor">Çalışmıyor</label></div>
                        <div><input type="radio" id="es_calisiyor" name="es_durumu" value="calisiyor"><label
                                for="es_calisiyor">Çalışıyor</label></div>
                        <div><input type="radio" id="es_bekar" name="es_durumu" value="bekar"><label
                                for="es_bekar">Bekar</label></div>
                    </div>
                </div>
                <div class="form-group" id="rehberlik_gorevi_div">
                    <label>Rehberlik Görevi Var Mı?:</label>
                    <div class="radio-group">
                        <div><input type="radio" id="rehberlik_yok" name="rehberlik_gorevi" value="hayir" checked><label
                                for="rehberlik_yok">Hayır</label></div>
                        <div><input type="radio" id="rehberlik_var" name="rehberlik_gorevi" value="evet"><label
                                for="rehberlik_var">Evet (Haftalık 2 Saat)</label></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="cocuk_0_6">Çocuk Sayısı (0-6 Yaş):</label>
                    <input type="number" id="cocuk_0_6" name="cocuk_0_6" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="cocuk_6_ustu">Çocuk Sayısı (6-18 Yaş):</label>
                    <input type="number" id="cocuk_6_ustu" name="cocuk_6_ustu" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="ise_giris">İşe Giriş Tarihi:</label>
                    <input type="date" id="ise_giris" name="ise_giris" required>
                </div>
                <div class="form-group">
                    <label for="isten_ayrilis">İşten Ayrılış Tarihi:</label>
                    <input type="date" id="isten_ayrilis" name="isten_ayrilis">
                </div>
                <div class="form-group" id="maas_karsiligi_div">
                    <label for="maas_karsiligi">Maaş Karşılığı Ders Saati:</label>
                    <input type="number" id="maas_karsiligi" name="maas_karsiligi" min="0" value="20">
                </div>
                <div class="form-group full-width">
                    <label for="aciklama">Açıklama:</label>
                    <textarea id="aciklama" name="aciklama" rows="3"></textarea>
                </div>
                <div class="form-group full-width button-group">
                    <button type="submit" class="btn btn-save">Personeli Kaydet</button>
                </div>
            </div>
        </template>

        <script type="module">





            async function handleAdminsListClick(e) {
                const button = e.target.closest('button');
                if (!button) return;

                const action = button.dataset.action;
                const uid = button.dataset.uid;
                const email = button.dataset.email;
                const okulId = button.dataset.okulId;
                const okulAdi = button.dataset.okulAdi;

                if (action === 'edit-password') {
                    openPasswordModal(uid, email);
                }

                if (action === 'delete-admin') {
                    showConfirmationModal(
                        `<strong>${email}</strong> e-posta adresli yöneticiyi kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`,
                        async () => {
                            showSpinner();
                            try {
                                const kullaniciSil = httpsCallable(functions, 'kullaniciSil');
                                await kullaniciSil({ uid: uid });
                                showToast(`Yönetici (${email}) başarıyla silindi.`, 'success');
                                await renderAllAdminsList();
                            } catch (error) {
                                console.error("Yönetici silinirken Firebase Function hatası:", error);
                                showToast(`Yönetici silinirken bir hata oluştu: ${error.message}`, 'error');
                            } finally {
                                hideSpinner();
                            }
                        }
                    );
                }

                if (action === 'toggle-status') {
                    showSpinner();
                    try {
                        const okulDocRef = doc(db, "okullar", okulId);
                        const okulDoc = await getDoc(okulDocRef);
                        const yeniDurum = okulDoc.data().durum === 'pasif' ? 'aktif' : 'pasif';
                        await updateDoc(okulDocRef, { durum: yeniDurum });
                        showToast('Okul durumu güncellendi.', 'success');
                        await renderAllAdminsList();
                        await populateSchoolsDropdown();
                    } catch (error) {
                        console.error("Okul durumu güncellenirken hata:", error);
                        showToast('Okul durumu güncellenemedi.', 'error');
                    } finally {
                        hideSpinner();
                    }
                }

                if (action === 'delete-school') {
                    showConfirmationModal(
                        `<strong>DİKKAT!</strong><br><br><strong>${okulAdi}</strong> adlı okulu ve bağlı yöneticileri kalıcı olarak silmek üzeresiniz. Bu işlem geri alınamaz.`,
                        async () => {
                            showSpinner();
                            try {
                                const okuluSil = httpsCallable(functions, 'okuluSil');
                                await okuluSil({ okulId: okulId });
                                showToast(`Okul (${okulAdi}) ve bağlı yöneticiler silindi.`, 'success');
                                await renderAllAdminsList();
                                await populateSchoolsDropdown();
                            } catch (error) {
                                console.error("Okul silinirken Firebase Function hatası:", error);
                                showToast(`Okul silinirken bir hata oluştu: ${error.message}`, 'error');
                            } finally {
                                hideSpinner();
                            }
                        }
                    );
                }
            }


            function initializeSuperAdminPanel() {
                const newSchoolForm = document.getElementById('newSchoolForm');
                newSchoolForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const okulAdiInput = document.getElementById('newSchoolName');
                    const okulAdi = okulAdiInput.value.trim();

                    if (!okulAdi) {
                        showToast('Okul adı boş bırakılamaz.', 'error');
                        return;
                    }

                    try {
                        showSpinner();
                        await addDoc(collection(db, "okullar"), {
                            adi: okulAdi
                        });
                        showToast(`'${okulAdi}' adlı okul başarıyla eklendi.`, 'success');
                        okulAdiInput.value = '';
                        populateSchoolsDropdown();
                        renderAllAdminsList();
                    } catch (error) {
                        console.error("Yeni okul eklenirken hata:", error);
                        showToast('Okul eklenirken bir hata oluştu.', 'error');
                    } finally {
                        hideSpinner();
                    }
                });

                populateSchoolsDropdown();
                renderAllAdminsList();

                const newUserForm = document.getElementById('newUserForm');


                if (!newUserForm.dataset.listenerAttached) {
                    newUserForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const email = document.getElementById('newUserEmail').value;
                        const password = document.getElementById('newUserPassword').value;
                        const okulId = document.getElementById('schoolSelect').value;
                        const statusDiv = document.getElementById('newUserStatus');

                        if (!email || !password || !okulId) {
                            statusDiv.textContent = 'Lütfen tüm alanları doldurun.';
                            statusDiv.style.color = 'red';
                            return;
                        }

                        statusDiv.textContent = 'Kullanıcı oluşturuluyor, lütfen bekleyin...';
                        statusDiv.style.color = 'orange';


                        const yeniKullaniciOlustur = httpsCallable(functions, 'yeniKullaniciOlustur');
                        try {
                            const result = await yeniKullaniciOlustur({
                                email: email,
                                password: password,
                                okulId: okulId,
                                rol: 'admin'
                            });
                            statusDiv.textContent = result.data.result;
                            statusDiv.style.color = 'green';
                            newUserForm.reset();
                            renderAllAdminsList();
                        } catch (error) {
                            console.error('Cloud function hatası:', error);
                            statusDiv.textContent = `Hata: ${error.message}`;
                            statusDiv.style.color = 'red';
                        }
                    });


                    newUserForm.dataset.listenerAttached = 'true';
                }

                const adminListContainer = document.getElementById('all-admins-list-container');
                if (adminListContainer && !adminListContainer.dataset.listenerAttached) {
                    adminListContainer.addEventListener('click', handleAdminsListClick);
                    adminListContainer.dataset.listenerAttached = 'true';
                }
            }


            async function renderAllAdminsList() {
                const container = document.getElementById('all-admins-list-container');
                container.style.display = 'grid';
                container.style.gridTemplateColumns = 'repeat(auto-fit, minmax(450px, 1fr))';
                container.style.gap = '20px';
                container.innerHTML = '<p style="grid-column: 1 / -1;">Yönetici listesi yükleniyor...</p>';

                const tumOkullariListele = httpsCallable(functions, 'tumOkullariListele');

                try {
                    const result = await tumOkullariListele();
                    const okullar = result.data.okullar;

                    if (!okullar || okullar.length === 0) {
                        container.innerHTML = '<p>Görüntülenecek okul veya yönetici bulunamadı.</p>';
                        return;
                    }

                    const aktifOkullar = okullar.filter(okul => okul.durum !== 'pasif').sort((a, b) => a.adi.localeCompare(b.adi));
                    const pasifOkullar = okullar.filter(okul => okul.durum === 'pasif').sort((a, b) => a.adi.localeCompare(b.adi));

                    let html = '';

                    const generateOkulHTML = (okul) => {
                        const isPassive = okul.durum === 'pasif';
                        const statusLabel = isPassive ? '<span style="color: #e74c3c; font-weight: bold;">(Pasif)</span>' : '';
                        const toggleStatusBtnText = isPassive ? 'Aktif Yap' : 'Pasif Yap';
                        const toggleStatusBtnClass = isPassive ? 'btn-add' : 'btn-edit';

                        let okulHTML = `
            <div class="kontrol-paneli-bolumu" style="margin-bottom: 20px; ${isPassive ? 'background-color: #fceae8;' : ''}">
                <div style="display:flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;">
                     <h4 style="margin: 0; color: var(--theme-primary);">
                        ${okul.adi || 'İsimsiz Okul'} ${statusLabel}
                     </h4>
                     <div style="display: flex; gap: 8px;">
                        <button class="btn ${toggleStatusBtnClass}" data-okul-id="${okul.id}" data-action="toggle-status" style="font-size: 12px; padding: 5px 10px;">${toggleStatusBtnText}</button>
                        <button class="btn btn-delete" data-okul-id="${okul.id}" data-okul-adi="${okul.adi}" data-action="delete-school" style="font-size: 12px; padding: 5px 10px;">Okulu Sil</button>
                     </div>
                </div>`;

                        if (okul.admins && okul.admins.length > 0) {
                            okulHTML += '<ul class="settings-list" style="margin-top: 0;">';
                            okul.admins.forEach(admin => {
                                okulHTML += `
                    <li style="display: flex; justify-content: space-between; align-items: center; padding: 10px;">
                        <span>${admin.email}</span>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-edit-password" data-uid="${admin.uid}" data-email="${admin.email}" data-action="edit-password" style="font-size: 12px; padding: 5px 10px; background-color: var(--theme-accent);">Şifre Değiştir</button>
                            <button class="btn btn-delete" data-uid="${admin.uid}" data-email="${admin.email}" data-action="delete-admin" style="font-size: 12px; padding: 5px 10px;">Yöneticiyi Sil</button>
                        </div>
                    </li>`;
                            });
                            okulHTML += '</ul>';
                        } else {
                            okulHTML += '<p style="font-style: italic; color: #666;">Bu okula atanmış bir yönetici bulunmuyor.</p>';
                        }
                        okulHTML += '</div>';
                        return okulHTML;
                    };

                    if (aktifOkullar.length > 0) {
                        html += '<div style="grid-column: 1 / -1;"><h3>Aktif Okullar</h3></div>';
                        aktifOkullar.forEach(okul => html += generateOkulHTML(okul));
                    }

                    if (pasifOkullar.length > 0) {
                        html += '<div style="grid-column: 1 / -1; margin-top: 20px; border-top: 2px solid #ccc; padding-top: 10px;"><h3>Pasif Okullar</h3></div>';
                        pasifOkullar.forEach(okul => html += generateOkulHTML(okul));
                    }

                    container.innerHTML = html;

                } catch (error) {
                    console.error("Yönetici listesi çekilirken hata:", error);
                    document.getElementById('all-admins-list-container').innerHTML = `<p style="color: red;">Yönetici listesi yüklenemedi: ${error.message}</p>`;
                }
            }


            async function populateSchoolsDropdown() {
                const select = document.getElementById('schoolSelect');
                try {
                    const q = query(collection(db, "okullar"), where("durum", "!=", "pasif"), orderBy("adi"));
                    const querySnapshot = await getDocs(q);

                    select.innerHTML = '<option value="">Lütfen bir okul seçin...</option>';

                    querySnapshot.forEach((doc) => {
                        const okulAdi = doc.data().adi;
                        const okulId = doc.id;
                        const option = new Option(okulAdi, okulId);
                        select.add(option);
                    });
                } catch (error) {
                    console.error("Okullar yüklenirken hata:", error);
                    select.innerHTML = '<option value="">Okullar yüklenemedi!</option>';
                }
            }

            function openPasswordModal(uid, email) {
                const modal = document.getElementById('edit-password-modal');
                const form = document.getElementById('edit-password-form');

                document.getElementById('edit-password-modal-title').textContent = `Şifreyi Değiştir: ${email}`;
                document.getElementById('edit-password-uid').value = uid;
                form.reset();
                modal.classList.add('open');
            }

            document.getElementById('edit-password-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const uid = document.getElementById('edit-password-uid').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                if (newPassword.length < 6) {
                    showToast('Şifre en az 6 karakter olmalıdır.', 'error');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    showToast('Girdiğiniz şifreler uyuşmuyor.', 'error');
                    return;
                }

                showToast('Şifre güncelleniyor...', 'info');
                const sifreGuncelle = httpsCallable(functions, 'sifreGuncelle');

                try {
                    const result = await sifreGuncelle({ uid: uid, newPassword: newPassword });
                    showToast(result.data.result, 'success');
                    document.getElementById('edit-password-modal').classList.remove('open');
                } catch (error) {
                    console.error('Şifre güncelleme hatası:', error);
                    showToast(`Hata: ${error.message}`, 'error');
                }
            });

            document.querySelectorAll('.modal .close-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.closest('.modal').classList.remove('open');
                });
            });


            function initializeMobileMenu() {
                const hamburgerBtn = document.getElementById('hamburger-btn');
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const navLinks = document.querySelectorAll('.sidebar .nav-link, .sidebar .sub-menu a');

                if (!hamburgerBtn || !sidebar || !overlay) return;

                const closeMenu = () => {
                    sidebar.classList.remove('open');
                    overlay.style.display = 'none';
                };

                const openMenu = () => {
                    sidebar.classList.add('open');
                    overlay.style.display = 'block';
                };

                hamburgerBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (sidebar.classList.contains('open')) {
                        closeMenu();
                    } else {
                        openMenu();
                    }
                });

                overlay.addEventListener('click', closeMenu);

                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        if (window.innerWidth <= 768) {
                            closeMenu();
                        }
                    });
                });
            }

            let isAppInitialized = false;
            function initializeApplicationUI() {
                if (isAppInitialized) return;

                const modal = document.getElementById('add-staff-modal');
                const personelForm = document.getElementById('personelForm');
                const openModal = (staffId = null, staffData = {}) => {
                    loadPersonelForm(staffId, staffData);
                    modal.classList.add('open');
                };
                const closeModal = () => modal.classList.remove('open');
                document.getElementById('open-add-staff-modal').addEventListener('click', () => openModal());
                document.getElementById('add-staff-from-list-btn').addEventListener('click', () => openModal());
                modal.querySelector('.close-modal').addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });

                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.id === 'open-add-staff-modal') return;
                    link.addEventListener('click', function (e) {
                        const targetId = this.dataset.target;


                        const okulGerektirenModuller = ['staff-list', 'ders-programi', 'gorevlendirme', 'nobet-takip', 'izin-takip', 'puantaj', 'settings'];
                        if (isCurrentUserSuperAdmin && !currentUserOkulId && okulGerektirenModuller.includes(targetId)) {
                            e.preventDefault();
                            e.stopPropagation(); // Diğer olayları durdur
                            showToast('Lütfen devam etmek için sol üst menüden bir okul seçin.', 'error');
                            return;
                        }

                        if (this.classList.contains('accordion-trigger')) {
                            e.preventDefault();
                            this.parentElement.classList.toggle('open');
                        }

                        if (targetId) {
                            e.preventDefault();
                            document.querySelectorAll('.nav-link, .accordion-trigger, .module').forEach(el => el.classList.remove('active'));
                            this.classList.add('active');
                            const parentGroup = this.closest('.menu-item-group');
                            if (parentGroup) {
                                parentGroup.querySelector('.accordion-trigger').classList.add('active');
                            }
                            document.getElementById(targetId).classList.add('active');
                            if (targetId === 'dashboard') renderDashboardData();
                            if (targetId === 'staff-list') fetchStaff();
                            if (targetId === 'settings') initializeSettings();
                            if (targetId === 'gorevlendirme') initializeGorevlendirme();
                            if (targetId === 'nobet-takip') initializeNobetTakip();
                            if (targetId === 'puantaj') initializePuantaj();
                            if (targetId === 'izin-takip') initializeIzinTakip();
                            if (targetId === 'ders-programi') initializeSchedule();
                            if (targetId === 'super-admin-panel') initializeSuperAdminPanel();
                        }
                    });
                });

                personelForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    showSpinner();
                    const editingId = e.target.dataset.editingId;
                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData.entries());
                    data.okulId = currentUserOkulId;
                    if (data.sozlesme_turu === 'Kısmi Süreli') {
                        data.kismi_zamanli_calisma = {};
                        const gunler = formData.getAll('kismi_gunler');
                        const gunMap = {
                            'Pazartesi': 'pzts_saat',
                            'Salı': 'sali_saat',
                            'Çarşamba': 'crs_saat',
                            'Perşembe': 'prs_saat',
                            'Cuma': 'cuma_saat',
                            'Cumartesi': 'cmrts_saat',
                            'Pazar': 'pazar_saat'
                        };
                        gunler.forEach(gunAdi => {
                            const saatInputAdi = gunMap[gunAdi];
                            if (saatInputAdi && data[saatInputAdi]) {
                                const saatDegeri = parseInt(data[saatInputAdi], 10);
                                if (!isNaN(saatDegeri)) {
                                    data.kismi_zamanli_calisma[gunAdi] = saatDegeri;
                                }
                            }
                        });
                        delete data.kismi_gunler;
                        Object.values(gunMap).forEach(inputAdi => delete data[inputAdi]);
                    }
                    try {
                        if (editingId) {
                            const personelRef = doc(db, "personel", editingId);
                            const docSnap = await getDoc(personelRef);
                            if (docSnap.exists()) {
                                const oldData = docSnap.data();
                                if (oldData.gorevi_bransi !== data.gorevi_bransi || oldData.sozlesme_turu !== data.sozlesme_turu) {
                                    await updateHizmetGecmisi(editingId, data);
                                }
                            }
                            await setDoc(personelRef, data, {
                                merge: true
                            });
                            showToast('Personel başarıyla güncellendi.');
                        } else {
                            const newDocRef = await addDoc(collection(db, "personel"), data);
                            await createInitialHizmetGecmisi(newDocRef.id, data);
                            showToast('Personel başarıyla eklendi.');
                        }
                        closeModal();
                        tumPersonelListesi = [];
                        if (document.getElementById('staff-list').classList.contains('active')) {
                            await fetchStaff();
                        }
                        await loadAndFilterPersonelList();
                    } catch (err) {
                        showToast('İşlem sırasında bir hata oluştu. Lütfen tekrar deneyin.', 'error');
                        console.error("Personel kaydetme/güncelleme hatası:", err);
                    } finally {
                        hideSpinner();
                    }
                });

                const personelDetayModal = document.getElementById('personel-detay-modal');
                document.getElementById('staff-list').addEventListener('click', (e) => {
                    if (e.target.classList.contains('btn-details')) {
                        const personelId = e.target.dataset.id;
                        openPersonelDetayModal(personelId);
                    }
                });
                personelDetayModal.querySelector('.close-modal').addEventListener('click', () => {
                    personelDetayModal.classList.remove('open');
                });
                personelDetayModal.addEventListener('click', (e) => {
                    if (e.target === personelDetayModal) {
                        personelDetayModal.classList.remove('open');
                    }
                });
                document.getElementById('personel-detay-tabs').addEventListener('click', e => {
                    if (e.target.matches('.settings-tab-button')) {
                        const targetTabId = e.target.dataset.tab;
                        personelDetayModal.querySelectorAll('.settings-tab-button, .settings-tab-content').forEach(el => {
                            el.classList.remove('active');
                        });
                        e.target.classList.add('active');
                        document.getElementById(targetTabId).classList.add('active');
                    }
                });
                document.getElementById('staff-list').addEventListener('click', async (e) => {
                    if (e.target.classList.contains('btn-delete')) {
                        const personelId = e.target.dataset.id;
                        const personelAdi = e.target.closest('tr').querySelector('td:nth-child(2)').textContent.trim();
                        showConfirmationModal(
                            `<strong>${personelAdi}</strong> adlı personeli kalıcı olarak silmek istediğinizden emin misiniz?`,
                            async () => {
                                await deleteDoc(doc(db, 'personel', personelId));
                                showToast('Personel silindi.');
                                fetchStaff();
                            }
                        );
                    }
                    if (e.target.classList.contains('btn-edit')) {
                        const docSnap = await getDoc(doc(db, 'personel', e.target.dataset.id));
                        if (docSnap.exists()) openModal(docSnap.id, docSnap.data());
                    }
                });
                document.getElementById('ekleBtn').addEventListener('click', addLesson);
                initializeMobileMenu();

                isAppInitialized = true;
            }

            let puantajInitialized = false;
            let puantajPersonelList = [];
            let puantajData = {};
            let overtimeReasons = {};
            let missingDayCodes = {};
            let isPuantajLocked = false;
            let currentPuantajDocRef = null;


            async function saveModalChanges() {
                const modalSaveBtn = document.getElementById('modal-save');
                const personelId = modalSaveBtn.dataset.personelId;
                const date = modalSaveBtn.dataset.date;
                if (!personelId || !date) {
                    showToast('Veri kaydedilirken bir hata oluştu.', 'error');
                    return;
                }
                const newCode = document.getElementById('modal-status').value;
                const newHours = parseFloat(document.getElementById('modal-hours').value) || 0;
                const newNotes = document.getElementById('modal-notes').value;
                if (puantajData[personelId] && puantajData[personelId].dailyData && puantajData[personelId].dailyData[date]) {
                    puantajData[personelId].dailyData[date] = {
                        code: newCode,
                        hours: newHours,
                        notes: newNotes
                    };
                } else {
                    if (!puantajData[personelId].dailyData) {
                        puantajData[personelId].dailyData = {};
                    }
                    puantajData[personelId].dailyData[date] = {
                        code: newCode,
                        hours: newHours,
                        notes: newNotes
                    };
                }
                document.getElementById('edit-modal-overlay').style.display = 'none';
                await savePuantajData();
                await loadPuantajDataForCurrentMonth();
            }



            async function fetchAndProcessSchedules() {
                const personelSchedules = {};
                if (!window.teacherList || !window.classList) {
                    console.error("Öğretmen veya Sınıf listesi yüklenemedi. Program verileri alınamıyor.");
                    return personelSchedules;
                }

                const teacherNameToIdMap = new Map(window.teacherList.map(t => [t.name, t.id]));
                const classVersionPromises = window.classList.map(async (className) => {
                    const sanitizedSinifAdi = `${currentUserOkulId}_${className.replace(/\//g, '-')}`;
                    const versionsRef = collection(db, "ders_programlari", sanitizedSinifAdi, "versiyonlar");
                    const snapshot = await getDocs(versionsRef);
                    return {
                        className,
                        versions: snapshot.docs
                    };
                });

                const allClassVersions = await Promise.all(classVersionPromises);

                for (const classData of allClassVersions) {
                    for (const versionDoc of classData.versions) {
                        const etkinTarih = versionDoc.id;
                        const scheduleData = versionDoc.data();
                        const gunlukSaatlerBuVersiyonIcin = {};

                        for (const gun in scheduleData) {
                            if (["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar"].includes(gun)) {
                                for (const saat in scheduleData[gun]) {
                                    const dersData = scheduleData[gun][saat];
                                    const ogretmenId = teacherNameToIdMap.get(dersData.ogretmen);

                                    if (ogretmenId) {
                                        if (!gunlukSaatlerBuVersiyonIcin[ogretmenId]) {
                                            gunlukSaatlerBuVersiyonIcin[ogretmenId] = { Pazartesi: 0, Salı: 0, Çarşamba: 0, Perşembe: 0, Cuma: 0 };
                                        }
                                        gunlukSaatlerBuVersiyonIcin[ogretmenId][gun] = (gunlukSaatlerBuVersiyonIcin[ogretmenId][gun] || 0) + 1;
                                    }
                                }
                            }
                        }

                        for (const ogretmenId in gunlukSaatlerBuVersiyonIcin) {
                            if (!personelSchedules[ogretmenId]) {
                                personelSchedules[ogretmenId] = [];
                            }
                            personelSchedules[ogretmenId].push({
                                tarih: etkinTarih,
                                gunlukSaatler: gunlukSaatlerBuVersiyonIcin[ogretmenId]
                            });
                        }
                    }
                }

                for (const ogretmenId in personelSchedules) {
                    personelSchedules[ogretmenId].sort((a, b) => new Date(b.tarih) - new Date(a.tarih));
                }

                return personelSchedules;
            }



            async function generateInitialPuantaj() {
                if (isPuantajLocked) {
                    showToast('Puantaj kilitli...', 'error');
                    return;
                }
                if (!confirm('Yeni bir puantaj oluşturulacak. Emin misiniz?')) {
                    return;
                }
                try {
                    const year = parseInt(document.getElementById('input-year').value);
                    const month = parseInt(document.getElementById('select-month').value);
                    showToast('Puantaj oluşturuluyor...');
                    const ayAdi = document.getElementById('select-month').options[month].text;
                    const baslikMetni = `ÖZEL İSABET ORTAOKULU ${year} YILI ${ayAdi.toLocaleUpperCase('tr-TR')} AYI PERSONEL PUANTAJ CETVELİ`;
                    const ayinIlkGunu = new Date(Date.UTC(year, month, 1));
                    const ayinSonGunu = new Date(Date.UTC(year, month + 1, 0));
                    let aktifPersonelList = puantajPersonelList.filter(personel => {
                        const girisStr = personel.ise_giris;
                        const ayrilisStr = personel.isten_ayrilis;
                        if (!girisStr) return false;
                        const girisDate = new Date(girisStr + 'T00:00:00Z');
                        if (isNaN(girisDate.getTime())) return false;
                        const iseBaslamisMi = girisDate <= ayinSonGunu;
                        let istenAyrilmamisMi = true;
                        if (ayrilisStr && ayrilisStr.trim() !== '' && ayrilisStr.trim() !== '---') {
                            const ayrilisDate = new Date(ayrilisStr + 'T00:00:00Z');
                            if (!isNaN(ayrilisDate.getTime())) {
                                istenAyrilmamisMi = ayrilisDate >= ayinIlkGunu;
                            }
                        }
                        return iseBaslamisMi && istenAyrilmamisMi;
                    });
                    const selectedPersonelId = document.getElementById('personel-filter-select').value;
                    if (selectedPersonelId !== 'all') {
                        aktifPersonelList = aktifPersonelList.filter(p => p.id === selectedPersonelId);
                    }
                    const [personelScheduleData, nobetVerisi, izinVerisi, seminarPeriods] = await Promise.all([
                        fetchAndProcessSchedules(year, month),
                        fetchAndCalculateNobetData(year, month),
                        fetchIzinDataForPuantaj(year, month),
                        fetchSeminarPeriods()
                    ]);
                    const gunlerTR = ["Pazar", "Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi"];
                    puantajData = {};
                    aktifPersonelList.forEach(personel => {
                        puantajData[personel.id] = {
                            ad: personel.ad,
                            unvan: personel.unvan,
                            neviAdi: personel.neviAdi,
                            sozlesmeTuru: personel.sozlesme_turu,
                            maasKarsiligi: personel.maasKarsiligi,
                            rehberlik_gorevi: personel.rehberlik_gorevi,
                            esDurumu: personel.esDurumu,
                            cocuk0_6: personel.cocuk0_6,
                            cocuk6_18: personel.cocuk6_18,
                            ise_giris: personel.ise_giris,
                            isten_ayrilis: personel.isten_ayrilis,
                            kismi_zamanli_calisma: personel.kismi_zamanli_calisma,
                            dailyData: {}
                        };
                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dateUTC = new Date(Date.UTC(year, month, day));
                            const dateString = dateUTC.toISOString().split('T')[0];
                            let code = '',
                                hours = 0;
                            if (personel.isten_ayrilis && personel.isten_ayrilis !== '---') {
                                const ayrilisTarihiUTC = new Date(personel.isten_ayrilis + 'T00:00:00Z');
                                if (dateUTC > ayrilisTarihiUTC) {
                                    puantajData[personel.id]['dailyData'][dateString] = {
                                        code: '',
                                        hours: 0,
                                        notes: ''
                                    };
                                    continue;
                                }
                            }
                            const isSeminarDay = seminarPeriods.some(p => dateUTC >= p.baslangic && dateUTC <= p.bitis);
                            if (isSeminarDay && personel.sozlesme_turu === 'Belirli Süreli') {
                                const dayOfWeek = dateUTC.getUTCDay();
                                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                                    code = 'N';
                                    hours = 8;
                                } else {
                                    code = 'HT';
                                    hours = 0;
                                }
                            } else {
                                const leaveCodeForDay = izinVerisi[personel.id]?.[dateString];
                                const dayOfWeek = dateUTC.getDay();
                                const dayOfWeekTR = gunlerTR[dayOfWeek];
                                if (leaveCodeForDay && (leaveCodeForDay === 'R' || leaveCodeForDay === 'Üİ')) {
                                    code = leaveCodeForDay;
                                }
                                if (code === '') {
                                    if (personel.sozlesme_turu === 'Kısmi Süreli') {
                                        if (isResmiTatil(dateUTC)) {
                                            code = 'E';
                                        } else {
                                            const gecerliProgramVersiyonu = personelScheduleData[personel.id]?.find(v => v.tarih <= dateString);
                                            const gununDersSaati = gecerliProgramVersiyonu?.gunlukSaatler?.[dayOfWeekTR] || 0;
                                            const scheduledHours = parseInt(personel.kismi_zamanli_calisma?.[dayOfWeekTR] || gununDersSaati || 0);
                                            code = (scheduledHours > 0) ? 'Y' : 'E';
                                            hours = scheduledHours;
                                        }
                                    } else {
                                        if (isResmiTatil(dateUTC)) {
                                            code = 'RT';
                                        } else {
                                            let isWeekend = (personel.sozlesme_turu === 'Belirli Süreli') ? (dayOfWeek === 6 || dayOfWeek === 0) : (dayOfWeek === 0);
                                            if (isWeekend) {
                                                code = 'HT';
                                            } else {
                                                code = 'N';
                                                const gecerliProgramVersiyonu = personelScheduleData[personel.id]?.find(v => v.tarih <= dateString);
                                                const gununDersSaati = gecerliProgramVersiyonu?.gunlukSaatler?.[dayOfWeekTR] || 0;
                                                if (personel.unvan && (personel.unvan.includes('Okul Müdürü') || personel.unvan.includes('Rehber Öğretmen') || personel.unvan.includes('Rehberlik'))) {
                                                    hours = 4;
                                                } else {
                                                    hours = (personel.sozlesme_turu === 'Belirsiz Süreli') ? 7.5 : gununDersSaati;
                                                }
                                            }
                                        }
                                    }
                                    if (leaveCodeForDay && (code === 'N' || code === 'Y')) {
                                        code = leaveCodeForDay;
                                        hours = 0;
                                    }
                                }
                            }
                            puantajData[personel.id]['dailyData'][dateString] = {
                                code,
                                hours,
                                notes: ''
                            };
                        }
                    });
                    const calculatedHoursMap = new Map();
                    const hourCalculationPromises = aktifPersonelList.map(async (personel) => {
                        const hours = await calculateMonthlyHours(personel.id);
                        calculatedHoursMap.set(personel.id, hours);
                    });
                    await Promise.all(hourCalculationPromises);
                    renderPuantajTable(nobetVerisi, aktifPersonelList, baslikMetni, calculatedHoursMap);
                    renderGrandTotals(nobetVerisi, aktifPersonelList, calculatedHoursMap);
                    renderLegend();
                    attachCellListeners();
                    showToast('Puantaj başarıyla oluşturuldu!', 'success');
                } catch (error) {
                    console.error("Puantaj oluşturulurken hata:", error);
                    showToast('Puantaj oluşturulamadı.', 'error');
                }
            }

            async function generateIndividualPuantaj() {
                const selectedPersonelId = document.getElementById('personel-filter-select').value;
                if (!selectedPersonelId || selectedPersonelId === 'all') {
                    showToast('Lütfen önce listeden bir personel seçin.', 'error');
                    return;
                }
                const personel = puantajPersonelList.find(p => p.id === selectedPersonelId);
                if (!personel) {
                    showToast('Seçilen personel verisi bulunamadı.', 'error');
                    return;
                }
                if (!confirm(`'${personel.ad}' için puantaj yeniden hazırlanacak. Bu personelin mevcut puantaj verileri sıfırlanacaktır. Devam etmek istiyor musunuz?`)) {
                    return;
                }
                try {
                    const year = parseInt(document.getElementById('input-year').value);
                    const month = parseInt(document.getElementById('select-month').value);
                    showToast(`'${personel.ad}' için puantaj hazırlanıyor...`);
                    const [scheduleData, izinVerisi] = await Promise.all([
                        fetchAndProcessSchedules(),
                        fetchIzinDataForPuantaj(year, month)
                    ]);
                    const gunlerTR = ["Pazar", "Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi"];
                    const individualPuantajData = {
                        ad: personel.ad,
                        unvan: personel.unvan,
                        neviAdi: personel.neviAdi,
                        sozlesmeTuru: personel.sozlesme_turu,
                        maasKarsiligi: personel.maasKarsiligi,
                        rehberlik_gorevi: personel.rehberlik_gorevi,
                        esDurumu: personel.esDurumu,
                        cocuk0_6: personel.cocuk0_6,
                        cocuk6_18: personel.cocuk6_18,
                        ise_giris: personel.ise_giris,
                        isten_ayrilis: personel.isten_ayrilis,
                        kismi_zamanli_calisma: personel.kismi_zamanli_calisma,
                        dailyData: {}
                    };
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateUTC = new Date(Date.UTC(year, month, day));
                        const dateString = dateUTC.toISOString().split('T')[0];
                        let code = '',
                            hours = 0;
                        if (personel.isten_ayrilis && personel.isten_ayrilis !== '---') {
                            const ayrilisTarihiUTC = new Date(personel.isten_ayrilis + 'T00:00:00Z');
                            if (dateUTC > ayrilisTarihiUTC) {
                                individualPuantajData.dailyData[dateString] = {
                                    code: '',
                                    hours: 0,
                                    notes: ''
                                };
                                continue;
                            }
                        }
                        const leaveCodeForDay = izinVerisi[personel.id]?.[dateString];
                        const dayOfWeek = dateUTC.getDay();
                        const dayOfWeekTR = gunlerTR[dayOfWeek];
                        if (leaveCodeForDay && (leaveCodeForDay === 'R' || leaveCodeForDay === 'Üİ')) {
                            code = leaveCodeForDay;
                        }
                        if (code === '') {
                            if (personel.sozlesme_turu === 'Kısmi Süreli') {
                                if (isResmiTatil(dateUTC)) {
                                    code = 'E';
                                } else {
                                    const scheduledHours = parseInt(personel.kismi_zamanli_calisma?.[dayOfWeekTR] || scheduleData[personel.id]?.[dayOfWeekTR] || 0);
                                    code = (scheduledHours > 0) ? 'Y' : 'E';
                                    hours = scheduledHours;
                                }
                            } else {
                                if (isResmiTatil(dateUTC)) {
                                    code = 'RT';
                                } else {
                                    let isWeekend = (personel.sozlesme_turu === 'Belirli Süreli') ? (dayOfWeek === 6 || dayOfWeek === 0) : (dayOfWeek === 0);
                                    if (isWeekend) {
                                        code = 'HT';
                                    } else {
                                        code = 'N';
                                        if (personel.unvan && (personel.unvan.includes('Okul Müdürü') || personel.unvan.includes('Rehber Öğretmen') || personel.unvan.includes('Rehberlik'))) {
                                            hours = 4;
                                        } else {
                                            hours = (personel.sozlesme_turu === 'Belirsiz Süreli') ? 7.5 : (scheduleData[personel.id]?.[dayOfWeekTR] || 0);
                                        }
                                    }
                                }
                            }
                            if (leaveCodeForDay && (code === 'N' || code === 'Y')) {
                                code = leaveCodeForDay;
                                hours = 0;
                            }
                        }
                        individualPuantajData.dailyData[dateString] = {
                            code,
                            hours,
                            notes: ''
                        };
                    }
                    puantajData[selectedPersonelId] = individualPuantajData;
                    showToast('Bireysel puantaj hazırlandı. Veritabanına kaydediliyor...', 'info');
                    await savePuantajData();
                    await loadPuantajDataForCurrentMonth();
                } catch (error) {
                    console.error("Bireysel puantaj oluşturulurken hata:", error);
                    showToast('Bireysel puantaj oluşturulamadı.', 'error');
                }
            }


            async function applyBulkUpdate() {
                const day = document.getElementById('bulk-update-day').value;
                const group = document.getElementById('bulk-update-group').value;
                const newStatusCode = document.getElementById('bulk-update-status').value;
                const year = parseInt(document.getElementById('input-year').value);
                const month = parseInt(document.getElementById('select-month').value);

                if (!day || !group || !newStatusCode) {
                    return showToast('Lütfen Gün, Grup ve Durum Kodu seçin.', 'error');
                }
                if (!puantajData || Object.keys(puantajData).length === 0) {
                    return showToast('Önce bir puantaj oluşturmalı veya yüklemelisiniz.', 'error');
                }

                const confirmationMessage = `'${group}' grubundaki tüm personel için ayın ${day}. gününün durumunu '${newStatusCode}' olarak değiştirmek istediğinizden emin misiniz?`;
                if (!confirm(confirmationMessage)) {
                    return;
                }

                const aktifPersonelList = puantajPersonelList.filter(personel => {
                    const ayrilisStr = personel.isten_ayrilis;
                    if (!ayrilisStr || ayrilisStr.trim() === '' || ayrilisStr.trim() === '---') return true;
                    const ayrilisDate = new Date(ayrilisStr + 'T00:00:00Z');
                    if (isNaN(ayrilisDate.getTime())) return true;
                    const ayrilisYear = ayrilisDate.getUTCFullYear();
                    const ayrilisMonth = ayrilisDate.getUTCMonth();
                    if (ayrilisYear > year) return true;
                    if (ayrilisYear === year && ayrilisMonth >= month) return true;
                    return false;
                });

                const targetPersonnel = aktifPersonelList.filter(p => {
                    if (group === 'Tümü') return true;
                    return p.sozlesme_turu === group;
                });

                if (targetPersonnel.length === 0) {
                    return showToast('Seçilen grupta güncellenecek personel bulunamadı.', 'info');
                }

                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                targetPersonnel.forEach(personel => {
                    if (puantajData[personel.id] && puantajData[personel.id].dailyData && puantajData[personel.id].dailyData[dateString]) {
                        puantajData[personel.id].dailyData[dateString].code = newStatusCode;
                    }
                });

                showToast('Güncelleme uygulanıyor...', 'info');
                const nobetVerisi = await fetchAndCalculateNobetData(year, month);

                const calculatedHoursMap = new Map();
                const hourCalculationPromises = aktifPersonelList.map(async (personel) => {
                    const hours = await calculateMonthlyHours(personel.id);
                    calculatedHoursMap.set(personel.id, hours);
                });
                await Promise.all(hourCalculationPromises);

                const ayAdi = document.getElementById('select-month').options[month].text;
                const baslikMetni = `ÖZEL İSABET ORTAOKULU ${year} YILI ${ayAdi.toLocaleUpperCase('tr-TR')} AYI PERSONEL PUANTAJ CETVELİ`;

                renderPuantajTable(nobetVerisi, aktifPersonelList, baslikMetni, calculatedHoursMap);
                renderGrandTotals(nobetVerisi, aktifPersonelList, calculatedHoursMap);
                attachCellListeners();

                showToast('Toplu güncelleme başarıyla uygulandı!', 'success');
            }

            function printPuantaj() {
                window.print();
            }

            function downloadPdf() {
                const year = document.getElementById('input-year').value;
                const monthName = document.getElementById('select-month').options[document.getElementById('select-month').selectedIndex].text;
                const puantajTabloAlani = document.getElementById('puantaj-table-container');
                if (!puantajData || Object.keys(puantajData).length === 0) {
                    showToast('PDF\'e aktarılacak puantaj verisi bulunmuyor.', 'error');
                    return;
                }
                showToast('PDF oluşturuluyor, lütfen bekleyin...', 'info');
                html2canvas(puantajTabloAlani, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const {
                        jsPDF
                    } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'pt',
                        format: 'a3'
                    });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasWidth / canvasHeight;
                    let imgWidth = pdfWidth - 40;
                    let imgHeight = imgWidth / ratio;
                    if (imgHeight > pdfHeight - 40) {
                        imgHeight = pdfHeight - 40;
                        imgWidth = imgHeight * ratio;
                    }
                    const x = (pdfWidth - imgWidth) / 2;
                    const y = (pdfHeight - imgHeight) / 2;
                    pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
                    pdf.save(`Puantaj_${monthName}_${year}.pdf`);
                    showToast('PDF başarıyla indirildi.', 'success');
                });
            }
            async function downloadExcel() {
                try {
                    showToast('Güncel personel verileri çekiliyor...', 'info');
                    const [personelSnap, gorevSnap, neviSnap] = await Promise.all([
                        getDocs(query(collection(db, "personel"), where("okulId", "==", currentUserOkulId), orderBy("ad_soyad"))),
                        getSettings('ayarlar_gorevler'),
                        getSettings('ayarlar_personel_nevileri')
                    ]);
                    const gorevMap = new Map(gorevSnap.docs.map(doc => [doc.id, doc.data().name]));
                    const neviMap = new Map(neviSnap.docs.map(doc => [doc.id, doc.data().name]));
                    const freshPersonelList = personelSnap.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ad: data.ad_soyad || 'İsimsiz',
                            unvan: gorevMap.get(data.gorevi_bransi) || 'Belirtilmemiş',
                            neviAdi: neviMap.get(data.personel_nevisi) || 'Bilinmiyor',
                            maasKarsiligi: parseInt(data.maas_karsiligi) || 20,
                            rehberlik_gorevi: data.rehberlik_gorevi || 'hayir',
                            esDurumu: data.es_durumu,
                            cocuk0_6: data.cocuk_0_6,
                            cocuk6_18: data.cocuk_6_ustu,
                            sozlesme_turu: data.sozlesme_turu || 'Belirsiz Süreli',
                            ise_giris: data.ise_giris || '---',
                            isten_ayrilis: data.isten_ayrilis || '---',
                            kismi_zamanli_calisma: data.kismi_zamanli_calisma || {}
                        };
                    });
                    const year = document.getElementById('input-year').value;
                    const month = parseInt(document.getElementById('select-month').value);
                    const monthName = document.getElementById('select-month').options[month].text;
                    const ayinIlkGunu = new Date(Date.UTC(year, month, 1));
                    const ayinSonGunu = new Date(Date.UTC(year, month + 1, 0));
                    const aktifPersonelList = freshPersonelList.filter(personel => {
                        const girisStr = personel.ise_giris;
                        const ayrilisStr = personel.isten_ayrilis;
                        if (!girisStr) return false;
                        const girisDate = new Date(girisStr + 'T00:00:00Z');
                        if (isNaN(girisDate.getTime())) return false;
                        const iseBaslamisMi = girisDate <= ayinSonGunu;
                        let istenAyrilmamisMi = true;
                        if (ayrilisStr && ayrilisStr.trim() !== '' && ayrilisStr.trim() !== '---') {
                            const ayrilisDate = new Date(ayrilisStr + 'T00:00:00Z');
                            if (!isNaN(ayrilisDate.getTime())) {
                                istenAyrilmamisMi = ayrilisDate >= ayinIlkGunu;
                            }
                        }
                        return iseBaslamisMi && istenAyrilmamisMi;
                    });
                    const selectedPersonelId = document.getElementById('personel-filter-select').value;
                    let personelToExport = aktifPersonelList;
                    if (selectedPersonelId && selectedPersonelId !== 'all') {
                        personelToExport = aktifPersonelList.filter(p => p.id === selectedPersonelId);
                    }
                    if (personelToExport.length === 0) {
                        showToast('Dışa aktarılacak personel bulunmuyor.', 'error');
                        return;
                    }
                    showToast('Filtrelenmiş Excel dosyası hazırlanıyor...', 'info');
                    const anaBaslik = `ÖZEL İSABET ORTAOKULU ${year} YILI ${monthName.toLocaleUpperCase('tr-TR')} AYI PERSONEL PUANTAJ CETVELİ`;
                    const nobetVerisi = await fetchAndCalculateNobetData(year, month);
                    const styleMap = {
                        'status-N': 'background-color:#E8F5E9; color:#1B5E20; font-weight:bold;',
                        'status-S': 'background-color:#FFF9C4; color:#AF6000; font-weight:bold;',
                        'status-HT': 'background-color:#FFEBCC; color:#B85B00; font-weight:bold;',
                        'status-RT': 'background-color:#D1EAFE; color:#0D47A1; font-weight:bold;',
                        'status-R': 'background-color:#FFEBEE; color:#B71C1C; font-weight:bold;',
                        'status-UI': 'background-color:#EAECEE; color:#566573; font-weight:bold;',
                        'status-Üİ': 'background-color:#EAECEE; color:#566573; font-weight:bold;',
                        'status-İ': 'background-color: #E6E6FA; color: #483D8B; font-weight:bold;',
                        'status-Y': 'background-color:#D7F9E9; color:#1B5E20; font-weight:bold;',
                        'status-K': 'background-color:#D7F9E9; color:#1B5E20; font-weight:bold;',
                        'status-E': 'background-color:#EEEEEE; color:#424242;',
                        'status-RTÇ': 'background-color: #E1BEE7; color: #4A148C; font-weight:bold;',
                        'summary-yellow': 'background-color:#FFECB3; font-weight:bold;',
                        'summary-green': 'background-color:#C8E6C9; font-weight:bold;',
                        'summary-nobet': 'background-color:#FFE0B2; font-weight:bold;',
                        'summary-rehberlik': 'background-color:#C5CAE9; font-weight:bold;',
                        'summary-overtime': 'background-color:#FFCDD2; font-weight:bold;',
                        'summary-count': 'background-color:#E3F2FD; font-weight:bold; width:35px; text-align: center;',
                        'summary-reason': 'background-color:#D2B4DE; font-weight:bold;',
                        'summary-missing-day': 'background-color:#AED6F1; font-weight:bold;',
                        'total-worked-day': 'background-color:#E3F2FD; font-weight:bold; text-align: center;',
                        'social-section': 'background-color:#E3F2FD;',
                        'header': 'background-color:#343a40; color:white; font-weight:600; text-align:center; vertical-align:middle; border:0.5pt solid #888888; font-size:9pt; white-space:nowrap;',
                        'group-header': 'background-color:#495057; color:white; font-weight:bold; text-align:left; padding-left:10px; font-size:13pt;',
                        'main-title': 'text-align:center; font-size:16pt; font-weight:bold; vertical-align:middle;',
                        'hour-cell': 'font-size:9pt; color:#192a56; font-weight:500; text-align:center; vertical-align:middle;',
                        'default-cell': 'text-align:center; vertical-align:middle; font-size:9pt;',
                        'personel-cell': 'text-align:left; vertical-align:middle; font-weight:bold; font-size:9pt;',
                        'unvan-cell': 'text-align:left; vertical-align:middle; font-size:9pt;',
                        'v-divider': 'border-right:1.5pt solid #333333;',
                        'h-divider': 'border-bottom:1.5pt solid #333333;',
                    };
                    let excelHtml = `<table width="100%"><tr><td colspan="50" style="${styleMap['main-title']}">${anaBaslik}</td></tr></table><br/>`;
                    const gunler = ['Paz', 'Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt'];
                    const gunBasliklari = ["N", "HT", "RT", "İ", "R", "Üİ", "S", "K", "RTÇ"];
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const grupluPersonel = {
                        'Belirsiz Süreli': personelToExport.filter(p => p.sozlesme_turu === 'Belirsiz Süreli'),
                        'Belirli Süreli': personelToExport.filter(p => p.sozlesme_turu === 'Belirli Süreli'),
                        'Kısmi Süreli': personelToExport.filter(p => p.sozlesme_turu === 'Kısmi Süreli')
                    };
                    const grupSiralama = ['Belirli Süreli', 'Belirsiz Süreli', 'Kısmi Süreli'];
                    const saatBasliklariConfig = {
                        'Belirsiz Süreli': {
                            headers: ["Aylık\nToplam", "Fazla\nMesai", "Mesai\nNedeni", "E. G.\nKodu"],
                            keys: ["genelToplam", "fazlaMesai", "mesaiNedeni", "eksikGunKodu"],
                            styleKeys: ["summary-yellow", "summary-overtime", "social-section", "summary-count"]
                        },
                        'Belirli Süreli': {
                            headers: ["Aylık\nToplam", "Ek\nDers", "Nöbet", "Rehberlik"],
                            keys: ["genelToplam", "ekDers", "nobet", "rehberlik"],
                            styleKeys: ["summary-yellow", "summary-green", "summary-nobet", "summary-rehberlik"]
                        },
                        'Kısmi Süreli': {
                            headers: ["Aylık\nToplam", "Ek\nDers", "Nöbet", "Rehberlik"],
                            keys: ["genelToplam", "ekDers", "nobet", "rehberlik"],
                            styleKeys: ["summary-yellow", "summary-green", "summary-nobet", "summary-rehberlik"]
                        }
                    };
                    excelHtml += '<table style="border-collapse:collapse;">';
                    grupSiralama.forEach(grupAdi => {
                        const personelGrubu = grupluPersonel[grupAdi];
                        if (!personelGrubu || personelGrubu.length === 0) return;
                        const saatConfig = saatBasliklariConfig[grupAdi];
                        const colspan = 3 + daysInMonth + saatConfig.headers.length + gunBasliklari.length + 4;
                        excelHtml += `<tr><td colspan="${colspan}" style="${styleMap['group-header']} border:0.5pt solid #888888;">${grupAdi} Puantaj Kayıtları</td></tr>`;
                        excelHtml += `<tr><th rowspan="2" style="${styleMap['header']}">Personel</th><th rowspan="2" style="${styleMap['header']}">Unvan</th><th rowspan="2" style="${styleMap['header']} ${styleMap['v-divider']}">İşe Giriş<br>İşten Çıkış</th><th colspan="${daysInMonth}" style="${styleMap['header']}">Aylık Puantaj Durumu</th><th colspan="${saatConfig.headers.length}" style="${styleMap['header']} ${styleMap['v-divider']}">Aylık Saat Toplamları</th><th colspan="${gunBasliklari.length}" style="${styleMap['header']} ${styleMap['v-divider']}">Aylık Gün Toplamları</th><th rowspan="2" style="${styleMap['header']} ${styleMap['v-divider']}">Sgk&nbsp;Prim&nbsp;Günü</th><th colspan="3" style="${styleMap['header']}">Sosyal Yardımlar</th><th rowspan="2" style="${styleMap['header']}">İmza</th></tr><tr>`;
                        for (let day = 1; day <= daysInMonth; day++) {
                            const date = new Date(year, month, day);
                            const dividerStyle = (date.getDay() === 0 || day === daysInMonth) ? styleMap['v-divider'] : '';
                            excelHtml += `<th style="${styleMap['header']} ${dividerStyle}">${day}<br>${gunler[date.getDay()]}</th>`;
                        }
                        saatConfig.headers.forEach(h => excelHtml += `<th style="${styleMap['header']} ${styleMap['v-divider']}">${h.replace('\n', '<br>')}</th>`);
                        gunBasliklari.forEach(h => excelHtml += `<th style="${styleMap['header']} ${styleMap['v-divider']}">${h}</th>`);
                        excelHtml += `<th style="${styleMap['header']}">Eş Durumu</th><th style="${styleMap['header']}">Çocuk 0-6</th><th style="${styleMap['header']}">Çocuk 6-18</th></tr>`;
                        personelGrubu.forEach(async (personel) => {
                            const pData = puantajData[personel.id] || {};
                            const monthlyHours = await calculateMonthlyHours(personel.id);
                            const nobetSaat = nobetVerisi[personel.id] || 0;
                            const rehberlikSaat = calculateEffectiveRehberlikHours(personel.id, year, month, puantajData);
                            const fazlaMesaiSaat = calculateFazlaMesai(personel.id);
                            const statusCounts = calculateStatusCounts(personel.id);
                            let sgkPrimGunu = new Date(year, month + 1, 0).getDate() - ((statusCounts.R || 0) + (statusCounts.Üİ || 0));
                            if (personel.sozlesme_turu === 'Kısmi Süreli') {
                                sgkPrimGunu = Math.round(monthlyHours.genelToplam / 7.5);
                            }
                            let ayrilisTarihiGoster = '---';
                            if (personel.isten_ayrilis && personel.isten_ayrilis.trim() !== '' && personel.isten_ayrilis.trim() !== '---') {
                                ayrilisTarihiGoster = formatDateDDMMYYYY(personel.isten_ayrilis);
                            }
                            let statusRowHtml = `<td rowspan="2" style="${styleMap['personel-cell']} border:0.5pt solid #888888;">${(personel.ad || '').replace('\n', '<br>')}</td><td rowspan="2" style="${styleMap['unvan-cell']} border:0.5pt solid #888888;">${(personel.unvan || '').replace('\n', '<br>')}</td><td rowspan="2" style="${styleMap['default-cell']} ${styleMap['v-divider']} border:0.5pt solid #888888;">${formatDateDDMMYYYY(personel.ise_giris)}<br>${ayrilisTarihiGoster}</td>`;
                            let hoursRowHtml = '';
                            for (let day = 1; day <= daysInMonth; day++) {
                                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                const dayData = pData.dailyData?.[dateString] || {};
                                const dayStyle = styleMap[`status-${dayData.code}`] || '';
                                const dividerStyle = (new Date(year, month, day).getDay() === 0 || day === daysInMonth) ? styleMap['v-divider'] : '';
                                statusRowHtml += `<td style="${styleMap['default-cell']} ${dayStyle} ${dividerStyle} border:0.5pt solid #888888;">${dayData.code || ''}</td>`;
                                const hourContent = (dayData.code === 'N' || dayData.code === 'RTÇ' || dayData.code === 'Y' || dayData.code === 'K') && dayData.hours > 0 ? dayData.hours : '';
                                hoursRowHtml += `<td style="mso-number-format:'0.#'; ${styleMap['hour-cell']} ${dividerStyle} ${styleMap['h-divider']} border:0.5pt solid #888888;">${hourContent}</td>`;
                            }
                            const saatDegerleri = {
                                genelToplam: monthlyHours.genelToplam,
                                fazlaMesai: fazlaMesaiSaat,
                                mesaiNedeni: overtimeReasons[personel.id] || '',
                                eksikGunKodu: missingDayCodes[personel.id] || '',
                                ekDers: monthlyHours.ekDers,
                                nobet: nobetSaat,
                                rehberlik: rehberlikSaat,
                                ht_saat: 0
                            };
                            saatConfig.keys.forEach((key, index) => {
                                let formatStyle = "mso-number-format:'General';";
                                if (key === 'mesaiNedeni' || key === 'eksikGunKodu') {
                                    formatStyle = "mso-number-format:'\\@';";
                                } else if (['genelToplam', 'fazlaMesai', 'ekDers'].includes(key)) {
                                    formatStyle = "mso-number-format:'0.#';";
                                }
                                statusRowHtml += `<td rowspan="2" style="${formatStyle} ${styleMap['default-cell']} ${styleMap[saatConfig.styleKeys[index]]} ${styleMap['v-divider']} border:0.5pt solid #888888;">${saatDegerleri[key]}</td>`;
                            });
                            gunBasliklari.forEach(h => {
                                statusRowHtml += `<td rowspan="2" style="${styleMap['summary-count']} ${styleMap['v-divider']} border:0.5pt solid #888888;">${statusCounts[h] || 0}</td>`;
                            });
                            statusRowHtml += `<td rowspan="2" style="${styleMap['total-worked-day']} ${styleMap['v-divider']} border:0.5pt solid #888888;">${sgkPrimGunu}</td><td rowspan="2" style="${styleMap['social-section']} border:0.5pt solid #888888;">${personel.esDurumu || ''}</td><td rowspan="2" style="${styleMap['social-section']} border:0.5pt solid #888888;">${personel.cocuk0_6 || ''}</td><td rowspan="2" style="${styleMap['social-section']} border:0.5pt solid #888888;">${personel.cocuk6_18 || ''}</td><td rowspan="2" style="border:0.5pt solid #888888;"></td>`;
                            excelHtml += `<tr>${statusRowHtml}</tr><tr>${hoursRowHtml}</tr>`;
                        });
                    });
                    excelHtml += '</table>';
                    const fullHtml = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head><meta charset="UTF-8"></head>
            <body>${excelHtml}</body>
            </html>`;
                    const blob = new Blob([fullHtml], {
                        type: 'application/vnd.ms-excel'
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Puantaj_${monthName}_${year}.xls`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('Excel dosyası başarıyla indirildi.', 'success');
                } catch (error) {
                    console.error("Excel oluşturulurken veya veriler çekilirken hata oluştu:", error);
                    showToast('Veriler çekilirken bir hata oluştu. Excel oluşturulamadı.', 'error');
                }
            }

            async function fetchAndCalculateNobetData(year, month) {
                const startDate = new Date(year, month, 1).toISOString().split('T')[0];
                const endDate = new Date(year, month + 1, 1).toISOString().split('T')[0];
                const q = query(collection(db, 'nobetler'), where("okulId", "==", currentUserOkulId), where('tarih', '>=', startDate), where('tarih', '<', endDate));
                const nobetSnap = await getDocs(q);
                const nobetHaftalari = {};
                const getWeekNumber = (d) => {
                    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                };
                nobetSnap.forEach(doc => {
                    const nobet = doc.data();
                    const tarih = new Date(nobet.tarih + 'T00:00:00');
                    const haftaNo = getWeekNumber(tarih);
                    if (!nobetHaftalari[nobet.personelId]) {
                        nobetHaftalari[nobet.personelId] = new Set();
                    }
                    nobetHaftalari[nobet.personelId].add(haftaNo);
                });
                const nobetEkDers = {};
                for (const personelId in nobetHaftalari) {
                    nobetEkDers[personelId] = nobetHaftalari[personelId].size * 3;
                }
                return nobetEkDers;
            }

            async function calculateMonthlyHours(personelId) {
                const personelPuantajVerisi = puantajData[personelId];
                if (!personelPuantajVerisi || !personelPuantajVerisi.dailyData) {
                    return { genelToplam: 0, ekDers: 0 };
                }

                const seminarPeriods = await fetchSeminarPeriods();

                const sozlesmeTuru = personelPuantajVerisi.sozlesmeTuru || '';
                const unvan = personelPuantajVerisi.unvan || '';

                let genelToplam = 0;
                let ekDers = 0;

                const dailyData = personelPuantajVerisi.dailyData;

                if (unvan.includes('Okul Müdürü') || unvan.includes('Rehber Öğretmen') || unvan.includes('Rehberlik')) {
                    if (sozlesmeTuru === 'Belirsiz Süreli') {
                        Object.values(dailyData).forEach(dayData => { if (dayData.code === 'N') genelToplam += (dayData.hours || 0); });
                    } else {
                        Object.values(dailyData).forEach(dayData => { if (['N', 'RTÇ', 'Y', 'K'].includes(dayData.code)) genelToplam += (dayData.hours || 0); });
                    }
                    Object.keys(dailyData).forEach(dateString => { if (['N', 'RTÇ'].includes(dailyData[dateString].code)) ekDers += 4; });
                    return { genelToplam, ekDers };
                }

                if (unvan.includes('Müdür Yardımcısı')) {
                    const yardimciSchedule = [0, 4, 4, 4, 3, 3, 0];
                    Object.keys(dailyData).forEach(dateString => {
                        if (['N', 'RTÇ'].includes(dailyData[dateString].code)) {
                            const date = new Date(dateString + 'T00:00:00');
                            ekDers += yardimciSchedule[date.getDay()];
                        }
                    });
                    genelToplam = ekDers;
                    return { genelToplam, ekDers };
                }

                Object.values(dailyData).forEach(dayData => {
                    if (['N', 'RTÇ', 'Y', 'K'].includes(dayData.code)) {
                        genelToplam += (dayData.hours || 0);
                    }
                });

                const neviAdi = personelPuantajVerisi.neviAdi || '';
                if (sozlesmeTuru === 'Kısmi Süreli' || !neviAdi.includes('Eğitim Personeli')) {
                    ekDers = genelToplam;
                } else {
                    let normalGunSaatleri = 0;
                    let seminarEkDers = 0;
                    const workWeeks = new Set();
                    const getWeek = (d) => { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - yearStart) / 86400000) + 1) / 7); };

                    for (const dateString in dailyData) {
                        const dayData = dailyData[dateString];
                        const dateUTC = new Date(dateString + 'T00:00:00Z');

                        const isSeminarDay = seminarPeriods.some(p => dateUTC >= p.baslangic && dateUTC <= p.bitis);

                        if (isSeminarDay && ['N', 'RTÇ', 'Y', 'K'].includes(dayData.code)) {
                            seminarEkDers += 4;
                            workWeeks.add(getWeek(dateUTC));
                        } else if (['N', 'RTÇ', 'Y', 'K'].includes(dayData.code)) {
                            normalGunSaatleri += (dayData.hours || 0);
                            workWeeks.add(getWeek(dateUTC));
                        }
                    }

                    const maasKarsiligiHaftalik = parseInt(personelPuantajVerisi.maasKarsiligi) || 0;
                    const toplamMaasKarsiligi = workWeeks.size * maasKarsiligiHaftalik;
                    const normalGunlerdenEkDers = Math.max(0, normalGunSaatleri - toplamMaasKarsiligi);

                    ekDers = normalGunlerdenEkDers + seminarEkDers;
                }

                return { genelToplam, ekDers: Math.round(ekDers) };
            }


            function renderPuantajTable(nobetVerisi, aktifPersonelListesi, baslikMetni, calculatedHoursMap) {
                const container = document.getElementById('puantaj-table-container');
                const year = parseInt(document.getElementById('input-year').value);
                const month = parseInt(document.getElementById('select-month').value);

                let finalHTML = `<h2 id="puantaj-baslik" style="text-align: center; color: var(--theme-primary); margin-bottom: 25px;">${baslikMetni}</h2>`;

                if (!aktifPersonelListesi || aktifPersonelListesi.length === 0 || !puantajData) {
                    container.innerHTML = `<div style="padding: 40px; text-align: center; background-color: #f8f9fa; border-radius: 8px;"><h4 style="color: var(--theme-primary);">Bu ay için görüntülenecek puantaj verisi veya aktif personel bulunmuyor.</h4></div>`;
                    return;
                }

                const personelPuantajData = Object.keys(puantajData).reduce((acc, personelId) => {
                    const personelInfo = aktifPersonelListesi.find(p => p.id === personelId);
                    if (personelInfo) {
                        acc[personelId] = { ...personelInfo, ...puantajData[personelId] };
                    }
                    return acc;
                }, {});

                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const gunler = ['Paz', 'Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt'];
                const grupSiralama = ['Belirli Süreli', 'Belirsiz Süreli', 'Kısmi Süreli'];

                const grupluPersonel = {
                    'Belirsiz Süreli': Object.values(personelPuantajData).filter(p => p.sozlesmeTuru === 'Belirsiz Süreli').sort((a, b) => a.ad.localeCompare(b.ad, 'tr')),
                    'Belirli Süreli': Object.values(personelPuantajData).filter(p => p.sozlesmeTuru === 'Belirli Süreli').sort((a, b) => a.ad.localeCompare(b.ad, 'tr')),
                    'Kısmi Süreli': Object.values(personelPuantajData).filter(p => p.sozlesmeTuru === 'Kısmi Süreli').sort((a, b) => a.ad.localeCompare(b.ad, 'tr'))
                };

                grupSiralama.forEach(grupAdi => {
                    const personelGrubu = grupluPersonel[grupAdi];
                    if (personelGrubu.length === 0) return;

                    const ayAdi = document.getElementById('select-month').options[month].text;
                    const yeniGrupBasligi = `${ayAdi} ${year} Ayı Personel Puantaj Kayıtları ( ${grupAdi.toLocaleUpperCase('tr-TR')} )`;
                    finalHTML += `<h3 style="margin-top: 30px; padding: 10px; background-color: #343a40; color: white; border-radius: 5px;">${yeniGrupBasligi}</h3>`;
                    let tableHTML = `<table class="puantaj-table"><thead><tr><th rowspan="2">Personel</th><th rowspan="2">Unvan</th><th rowspan="2" class="vertical-divider">İşe Giriş<br>İşten Çıkış</th><th colspan="${daysInMonth}">Aylık Puantaj Durumu</th><th colspan="${(grupAdi === 'Belirsiz Süreli') ? 4 : 4}" class="vertical-divider">Aylık Saat Toplamları</th><th colspan="9" class="vertical-divider">Aylık Gün Toplamları</th><th rowspan="2" class="vertical-divider">Sgk Prim Günü</th><th colspan="3">Sosyal Yardımlar</th><th rowspan="2">İmza</th></tr><tr>`;
                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const dividerClass = (new Date(year, month, day).getDay() === 0 || day === daysInMonth) ? 'vertical-divider' : '';
                        tableHTML += `<th class="col-day ${dividerClass}">${day}<br>${gunler[date.getDay()]}</th>`;
                    }
                    tableHTML += `<th>Aylık Toplam</th>${(grupAdi === 'Belirsiz Süreli') ? '<th>Fazla Mesai</th><th>Mesai Nedeni</th><th>E. G.<br>Kodu</th>' : `<th>Ek Ders</th><th>Nöbet</th><th class="vertical-divider">Rehberlik</th>`}<th>N</th><th>HT</th><th>RT</th><th>İ</th><th>R</th><th>Üİ</th><th>S</th><th>K</th><th class="vertical-divider">RTÇ</th><th>Eş Durumu</th><th>Çocuk 0-6</th><th>Çocuk 6-18</th></tr></thead><tbody>`;

                    personelGrubu.forEach(personel => {
                        if (!personel.dailyData) { return; }
                        let ayrilisTarihiGoster = '---';
                        if (personel.isten_ayrilis && personel.isten_ayrilis !== '---') {
                            const ayrilisDate = new Date(personel.isten_ayrilis + 'T00:00:00Z');
                            if (ayrilisDate.getUTCFullYear() === year && ayrilisDate.getUTCMonth() === month) {
                                ayrilisTarihiGoster = formatDateDDMMYYYY(personel.isten_ayrilis);
                            }
                        }

                        const monthlyHours = calculatedHoursMap.get(personel.id) || { genelToplam: 0, ekDers: 0 };

                        const nobetSaat = nobetVerisi[personel.id] || 0;
                        const rehberlikSaat = calculateEffectiveRehberlikHours(personel.id, year, month, personelPuantajData);
                        const statusCounts = calculateStatusCounts(personel.id);
                        let sgkPrimGunu = new Date(year, month + 1, 0).getDate() - ((statusCounts.R || 0) + (statusCounts.Üİ || 0));

                        tableHTML += `<tr class="personel-row-status"><td class="col-personel" rowspan="2">${personel.ad}</td><td class="col-unvan" rowspan="2">${personel.unvan}</td><td class="col-date vertical-divider" rowspan="2">${formatDateDDMMYYYY(personel.ise_giris)}<br>${ayrilisTarihiGoster}</td>`;
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const dayData = personel.dailyData[dateString] || { code: '', hours: 0 };
                            const dividerClass = (new Date(year, month, day).getDay() === 0 || day === daysInMonth) ? 'vertical-divider' : '';
                            tableHTML += `<td class="status-cell status-${dayData.code} ${dividerClass}" data-personel-id="${personel.id}" data-date="${dateString}">${dayData.code || ''}</td>`;
                        }

                        let eksikGunKoduSelect = '';
                        if (grupAdi === 'Belirsiz Süreli') {
                            let options = '<option value=""></option>';
                            eksikGunKodlari.forEach(item => {
                                const selected = (missingDayCodes[personel.id] === item.kod) ? 'selected' : '';
                                options += `<option value="${item.kod}" ${selected}>${item.kod} - ${item.aciklama}</option>`;
                            });
                            eksikGunKoduSelect = `<td rowspan="2" class="summary-missing-day"><select class="missing-day-code-select" data-personel-id="${personel.id}">${options}</select></td>`;
                        }
                        const fazlaMesaiSaat = (grupAdi === 'Belirsiz Süreli') ? calculateFazlaMesai(personel.id) : 0;
                        const mesaiNedeniInput = `<td rowspan="2" class="summary-reason"><input type="text" class="overtime-reason-input" data-personel-id="${personel.id}" value="${overtimeReasons[personel.id] || ''}"></td>`;

                        tableHTML += `<td class="summary-yellow" rowspan="2">${monthlyHours.genelToplam}</td>${(grupAdi === 'Belirsiz Süreli') ? `<td class="summary-overtime" rowspan="2">${fazlaMesaiSaat}</td>${mesaiNedeniInput}${eksikGunKoduSelect}` : `<td class="summary-green" rowspan="2">${monthlyHours.ekDers}</td><td class="summary-nobet" rowspan="2">${nobetSaat}</td><td class="summary-rehberlik vertical-divider" rowspan="2">${rehberlikSaat}</td>`}<td class="col-summary-count" rowspan="2">${statusCounts.N || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.HT || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.RT || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.İ || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.R || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.Üİ || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.S || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.K || 0}</td><td class="col-summary-count vertical-divider" rowspan="2">${statusCounts.RTÇ || 0}</td><td class="total-worked-day vertical-divider" rowspan="2">${sgkPrimGunu}</td><td class="social-section" rowspan="2">${personel.esDurumu === 'calismiyor' ? 'Çalışmıyor' : 'Bekar'}</td><td class="social-section" rowspan="2">${personel.cocuk0_6 || ''}</td><td class="social-section" rowspan="2">${personel.cocuk6_18 || ''}</td><td class="col-imza" rowspan="2"></td></tr>`;

                        tableHTML += `<tr class="personel-row-hours horizontal-divider">`;
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const dayData = personel.dailyData[dateString] || { code: '', hours: 0 };
                            const dividerClass = (new Date(year, month, day).getDay() === 0 || day === daysInMonth) ? 'vertical-divider' : '';
                            const hourContent = (dayData?.code === 'N' || dayData?.code === 'RTÇ' || dayData?.code === 'Y' || dayData?.code === 'K') && dayData?.hours > 0 ? dayData.hours : '';
                            tableHTML += `<td class="hour-cell ${dividerClass}">${hourContent}</td>`;
                        }
                        tableHTML += `</tr>`;
                    });
                    tableHTML += `</tbody></table>`;
                    finalHTML += tableHTML;
                });

                container.innerHTML = finalHTML;
                attachCellListeners();
                initializeCustomSelects();
            }

            function attachCellListeners() {
                const cells = document.querySelectorAll('.status-cell');
                cells.forEach(cell => {
                    cell.addEventListener('click', () => {
                        const personelId = cell.dataset.personelId;
                        const date = cell.dataset.date;
                        openEditModal(personelId, date);
                    });
                });
            }

            function renderGrandTotals(nobetVerisi = {}, personelListesi, calculatedHoursMap) {
                const year = parseInt(document.getElementById('input-year').value);
                const month = parseInt(document.getElementById('select-month').value);

                let totalEkders = 0, totalNobet = 0, totalRehberlik = 0;

                personelListesi.forEach(personel => {
                    const monthlyHours = calculatedHoursMap.get(personel.id) || { ekDers: 0 };

                    if (personel.neviAdi.includes('Eğitim Personeli') || personel.unvan.includes('Müdür')) {
                        totalEkders += monthlyHours.ekDers;
                    }

                    totalNobet += nobetVerisi[personel.id] || 0;
                    totalRehberlik += calculateEffectiveRehberlikHours(personel.id, year, month, puantajData);
                });

                document.getElementById('total-ekders').textContent = totalEkders + " Saat";
                document.getElementById('total-nobet').textContent = totalNobet + " Saat";
                document.getElementById('total-rehberlik').textContent = totalRehberlik + " Saat";
            }
            function calculateEffectiveRehberlikHours(personelId, year, month, allPuantajData) {
                const personel = puantajPersonelList.find(p => p.id === personelId);
                if (!personel || personel.rehberlik_gorevi !== 'evet' || !allPuantajData[personelId]) {
                    return 0;
                }

                let effectiveHours = 0;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const personelMonthData = allPuantajData[personelId].dailyData;

                if (!personelMonthData) {
                    return 0;
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, month, day);

                    if (currentDate.getDay() === 4) {
                        const dateString = currentDate.toISOString().split('T')[0];
                        const dayStatus = personelMonthData[dateString]?.code;

                        if (dayStatus === 'N') {
                            effectiveHours += 2;
                        }
                    }
                }
                return effectiveHours;
            }
            function renderLegend() {
                const legendContainer = document.getElementById('puantaj-legend');
                if (!legendContainer) return;
                legendContainer.innerHTML = '';
                const statusCodes = {
                    'N': 'Normal',
                    'HT': 'Hafta Sonu',
                    'RT': 'Resmi Tatil',
                    'İ': 'İzinli (Ücretli)',
                    'R': 'Raporlu',
                    'Üİ': 'Ücretsiz İzin',
                    'S': 'Yıllık İzin',
                    'K': 'Yarım Gün Çalışma',
                    'Y': 'Yarım Gün Çalışma (Kısmi)',
                    'RTÇ': 'Resmi Tatil Çalışması',
                    'E': 'Eksik Gün'
                };
                for (const code in statusCodes) {
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    item.innerHTML = `<span class="legend-color-box status-${code}"></span><b>(${code})</b>: ${statusCodes[code]}`;
                    legendContainer.appendChild(item);
                }
            }
            function calculateFazlaMesai(personelId) {
                const personelData = puantajData[personelId];
                if (!personelData || !personelData.dailyData) return 0;

                const weeklyHours = {};
                const getWeekNumber = (d) => {
                    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                };

                for (const dateString in personelData.dailyData) {
                    const dayData = personelData.dailyData[dateString];
                    if (dayData.code === 'N' || dayData.code === 'RTÇ' || dayData.code === 'Y' || dayData.code === 'K') {
                        const date = new Date(dateString + 'T00:00:00');
                        const weekNumber = getWeekNumber(date);

                        if (!weeklyHours[weekNumber]) {
                            weeklyHours[weekNumber] = 0;
                        }
                        weeklyHours[weekNumber] += (dayData.hours || 0);
                    }
                }

                let totalOvertime = 0;
                for (const week in weeklyHours) {
                    if (weeklyHours[week] > 45) {
                        totalOvertime += (weeklyHours[week] - 45);
                    }
                }
                return totalOvertime;
            }


            async function loadSharedData() {
                try {
                    // 1. ADIM: Gerekli olan TÜM verileri en başta, tek seferde çekiyoruz. (Hatanın çözüldüğü yer)
                    const [siniflarSnap, personelSnap, neviSnap, derslerSnap] = await Promise.all([
                        getSettings('ayarlar_siniflar'),
                        getDocs(query(collection(db, 'personel'), where("okulId", "==", currentUserOkulId), orderBy('ad_soyad'))),
                        getSettings('ayarlar_personel_nevileri'),
                        getSettings('ayarlar_dersler')
                    ]);

                    // 2. ADIM: Global değişkenleri dolduruyoruz.
                    window.classList = siniflarSnap.docs.map(d => d.data().name);

                    const egitimPersoneliNevi = neviSnap.docs.find(doc => doc.data().name.trim().includes('Eğitim Personeli'));
                    const egitimPersoneliNeviId = egitimPersoneliNevi ? egitimPersoneliNevi.id : null;

                    window.teacherList = personelSnap.docs
                        .filter(p => p.data().personel_nevisi === egitimPersoneliNeviId)
                        .map(doc => ({ id: doc.id, name: doc.data().ad_soyad }));

                    // 3. ADIM: Ders Kuralları filtresindeki açılır listeleri dolduruyoruz. (Bu kodlar artık doğru yerde)
                    const dersFiltreSelect = document.getElementById('kural-filter-ders-select');
                    const sinifFiltreSelect = document.getElementById('kural-filter-sinif-select');
                    const ogretmenFiltreSelect = document.getElementById('kural-filter-ogretmen-select');

                    // Listelerin içini temizleyip varsayılan seçeneği ekliyoruz ki her seferinde liste tekrar dolmasın.
                    dersFiltreSelect.innerHTML = '<option value="">Tüm Dersler</option>';
                    sinifFiltreSelect.innerHTML = '<option value="">Tüm Sınıflar</option>';
                    ogretmenFiltreSelect.innerHTML = '<option value="">Tüm Öğretmenler</option>';

                    derslerSnap.forEach(doc => dersFiltreSelect.add(new Option(doc.data().name, doc.id)));
                    siniflarSnap.forEach(doc => sinifFiltreSelect.add(new Option(doc.data().name, doc.data().name)));
                    personelSnap.forEach(doc => {
                        if (doc.data().personel_nevisi === egitimPersoneliNeviId) {
                            ogretmenFiltreSelect.add(new Option(doc.data().ad_soyad, doc.id));
                        }
                    });

                    // 4. ADIM: Filtre olay dinleyicilerini ekliyoruz.
                    dersFiltreSelect.addEventListener('change', loadAndRenderDersKurallari);
                    sinifFiltreSelect.addEventListener('change', loadAndRenderDersKurallari);
                    ogretmenFiltreSelect.addEventListener('change', loadAndRenderDersKurallari);

                    console.log("Paylaşılan veriler (Sınıflar, Öğretmenler, Dersler) başarıyla yüklendi.");

                } catch (error) {
                    console.error("Paylaşılan veriler yüklenirken kritik hata:", error);
                    showToast('Uygulama için temel veriler yüklenemedi. Ayarlarınızı kontrol edin.', 'error');
                }
            }

            function resetApplicationState(isFullReset = false) {
                console.log(`Uygulama durumu sıfırlanıyor... (Tam Sıfırlama: ${isFullReset})`);

                if (isFullReset) {
                    currentUserOkulId = null;
                    isCurrentUserSuperAdmin = false;
                }

                tumPersonelListesi = [];
                puantajData = {};
                overtimeReasons = {};
                missingDayCodes = {};
                isPuantajLocked = false;
                currentPuantajDocRef = null;
                window.tumProgramlar = {};
                window.classList = [];
                window.teacherList = [];
                geciciDetaylar = [];
                duzenlenenGorevDetaylari = [];

                document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
                document.getElementById('dashboard').classList.add('active');

                document.querySelectorAll('.nav-link, .accordion-trigger').forEach(el => el.classList.remove('active'));
                document.querySelector('.nav-link[data-target="dashboard"]').classList.add('active');

                const elementsToReset = {
                    'db-aktif-personel': { property: 'textContent', value: '...' },
                    'db-gunun-nobetcileri-list': { property: 'innerHTML', value: '...' },
                    'db-bugun-izinliler-list': { property: 'innerHTML', value: '...' },
                    'db-bugun-gorevli-list': { property: 'innerHTML', value: '...' },
                    'db-aylik-ekders': { property: 'textContent', value: '...' },
                    'db-aylik-nobet': { property: 'textContent', value: '...' },
                    'db-aylik-rehberlik': { property: 'textContent', value: '...' },
                    'db-aylik-raporlular-list': { property: 'innerHTML', value: '...' },
                    'personel-table-area': { property: 'innerHTML', value: '' },
                    'gorevlendirme-tbody': { property: 'innerHTML', value: '' },
                    'nobet-rapor-tbody': { property: 'innerHTML', value: '' },
                    'izin-kayitlari-tbody': { property: 'innerHTML', value: '' },
                    'puantaj-table-container': { property: 'innerHTML', value: '' },
                    'schedule-display-area': { property: 'innerHTML', value: '' },
                    'yerlestirme-havuzu-container': { property: 'innerHTML', value: '' },
                    'versiyon-listesi': { property: 'innerHTML', value: '' }
                };
                for (const id in elementsToReset) {
                    const el = document.getElementById(id);
                    if (el) {
                        el[elementsToReset[id].property] = elementsToReset[id].value;
                    }
                }

                if (isFullReset) {
                    const selectorContainer = document.getElementById('school-selector-container');
                    if (selectorContainer) selectorContainer.style.display = 'none';
                    if (window.schoolSlimSelect) {
                        window.schoolSlimSelect.setData([]);
                    }
                }
            }

            async function loadDataForCurrentSchool() {
                console.log(`Veriler yeni okul için yükleniyor: ${currentUserOkulId}`);


                await loadSharedData();



                const dashboardLink = document.querySelector('.nav-link[data-target="dashboard"]');
                if (dashboardLink) {

                    document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
                    document.getElementById('dashboard').classList.add('active');


                    document.querySelectorAll('.nav-link, .accordion-trigger').forEach(el => el.classList.remove('active'));
                    dashboardLink.classList.add('active');


                    await renderDashboardData();
                }
            }

            async function initializeSchoolSelector(okullar) { // Fonksiyon artık 'okullar' parametresini alıyor
                const selectorContainer = document.getElementById('school-selector-container');

                if (window.schoolSlimSelect) {
                    window.schoolSlimSelect.destroy();
                }

                // Veri çekme işlemi kaldırıldı, çünkü veri artık parametre olarak geliyor.
                if (okullar && okullar.length > 1) {
                    const dataForSlimSelect = okullar.map(okul => {
                        const okulAdiLower = okul.adi.toLowerCase();
                        let cssClass = 'option-diger';
                        if (okulAdiLower.includes('anaokulu')) {
                            cssClass = 'option-anaokulu';
                        } else if (okulAdiLower.includes('ilkokul')) {
                            cssClass = 'option-ilkokul';
                        } else if (okulAdiLower.includes('ortaokul')) {
                            cssClass = 'option-ortaokul';
                        }

                        return {
                            text: okul.adi,
                            value: okul.id,
                            class: cssClass
                        };
                    });

                    window.schoolSlimSelect = new SlimSelect({
                        select: '#school-selector',
                        settings: {
                            showSearch: false,
                            placeholderText: 'Okul Seçin',
                        },
                        data: dataForSlimSelect,
                        events: {
                            afterChange: async (newVal) => {
                                const yeniOkulId = newVal[0].value;
                                if (yeniOkulId === currentUserOkulId) return;

                                showSpinner();
                                resetApplicationState(false); // BU SATIRI EKLEYİN
                                currentUserOkulId = yeniOkulId;
                                await loadDataForCurrentSchool();
                                hideSpinner();
                            }
                        }
                    });

                    window.schoolSlimSelect.setSelected(currentUserOkulId);
                    selectorContainer.style.display = 'block'; // Menüyü görünür yapıyoruz.
                } else {
                    selectorContainer.style.display = 'none'; // Eğer 1'den fazla okul yoksa gizliyoruz.
                }
            }
            async function fetchIzinDataForPuantaj(year, month) {
                const startDate = new Date(Date.UTC(year, month, 1));
                const endDate = new Date(Date.UTC(year, month + 1, 0));
                const izinVerisi = {};

                try {
                    const [izinlerSnap, izinTipiSnap] = await Promise.all([
                        getDocs(query(
                            collection(db, 'izinler'),
                            where("okulId", "==", currentUserOkulId),
                            where('baslangicTarihi', '<=', endDate.toISOString().split('T')[0]),
                        )),
                        getSettings('ayarlar_izin_tipleri')
                    ]);

                    const izinTipiMap = new Map(izinTipiSnap.docs.map(doc => [doc.id, doc.data().kod]));

                    const relevantIzinler = izinlerSnap.docs.filter(doc => {
                        const bitisTarihi = doc.data().bitisTarihi;
                        return bitisTarihi >= startDate.toISOString().split('T')[0];
                    });

                    for (const doc of relevantIzinler) {
                        const izin = doc.data();
                        const personelId = izin.personelId;
                        const kod = izinTipiMap.get(izin.izinTipiId) || 'İ';

                        if (!izinVerisi[personelId]) {
                            izinVerisi[personelId] = {};
                        }

                        let currentDate = new Date(izin.baslangicTarihi + 'T00:00:00Z');
                        const endDateIzin = new Date(izin.bitisTarihi + 'T00:00:00Z');

                        while (currentDate <= endDateIzin) {
                            if (currentDate >= startDate && currentDate <= endDate) {
                                const dateString = currentDate.toISOString().split('T')[0];
                                izinVerisi[personelId][dateString] = kod;
                            }
                            currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                        }
                    }
                    return izinVerisi;

                } catch (error) {
                    console.error("İzin verileri çekilirken hata oluştu:", error);
                    showToast('Puantaj için izin verileri çekilemedi.', 'error');
                    return {};
                }
            }














            async function initializePuantaj() {
                if (puantajInitialized) {
                    await loadAndFilterPersonelList();
                    await loadPuantajDataForCurrentMonth();
                    return;
                }
                try {
                    await loadAndFilterPersonelList();
                    const selectMonth = document.getElementById('select-month');
                    const inputYear = document.getElementById('input-year');
                    const showBtn = document.getElementById('btn-show-puantaj');
                    const generateBtn = document.getElementById('btn-generate');
                    const printBtn = document.getElementById('btn-print');
                    const deleteBtn = document.getElementById('btn-delete-puantaj');
                    const pdfBtn = document.getElementById('btn-pdf');
                    const excelBtn = document.getElementById('btn-excel');
                    const modalOverlay = document.getElementById('edit-modal-overlay');
                    const modalSaveBtn = document.getElementById('modal-save');
                    const modalCancelBtn = document.getElementById('modal-cancel');
                    const savePuantajBtn = document.getElementById('btn-save-puantaj');
                    const lockPuantajBtn = document.getElementById('btn-lock-puantaj');
                    modalSaveBtn.addEventListener('click', saveModalChanges);
                    modalCancelBtn.addEventListener('click', () => {
                        modalOverlay.style.display = 'none';
                    });
                    const now = new Date();
                    const months = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
                    selectMonth.innerHTML = '';
                    months.forEach((m, i) => selectMonth.add(new Option(m, i)));
                    selectMonth.value = now.getMonth();
                    inputYear.value = now.getFullYear();
                    const statusCodes = {
                        'N': 'Normal',
                        'HT': 'Hafta Sonu',
                        'RT': 'Resmi Tatil',
                        'İ': 'İzinli (Ücretli)',
                        'R': 'Raporlu',
                        'Üİ': 'Ücretsiz İzin',
                        'S': 'Yıllık İzin',
                        'K': 'Yarım Gün Çalışma',
                        'Y': 'Yarım Gün Çalışma (Kısmi)',
                        'RTÇ': 'Resmi Tatil Çalışması',
                        'E': 'Eksik Gün'
                    };
                    const modalStatusSelect = document.getElementById('modal-status');
                    modalStatusSelect.innerHTML = '';
                    for (const code in statusCodes) modalStatusSelect.add(new Option(statusCodes[code], code));
                    if (!puantajInitialized) {
                        showBtn.addEventListener('click', loadPuantajDataForCurrentMonth);
                        generateBtn.addEventListener('click', generateInitialPuantaj);
                        document.getElementById('btn-generate-individual').addEventListener('click', generateIndividualPuantaj);
                        deleteBtn.addEventListener('click', deleteCurrentPuantaj);
                        savePuantajBtn.addEventListener('click', savePuantajData);
                        lockPuantajBtn.addEventListener('click', togglePuantajLock);
                        document.getElementById('btn-bulk-update').addEventListener('click', applyBulkUpdate);
                        printBtn.addEventListener('click', printPuantaj);
                        pdfBtn.addEventListener('click', downloadPdf);
                        excelBtn.addEventListener('click', downloadExcel);
                        selectMonth.addEventListener('change', loadPuantajDataForCurrentMonth);
                        inputYear.addEventListener('change', loadPuantajDataForCurrentMonth);
                        const bulkUpdateDaySelect = document.getElementById('bulk-update-day');
                        const bulkUpdateStatusSelect = document.getElementById('bulk-update-status');
                        const daysInMonth = new Date(inputYear.value, parseInt(selectMonth.value) + 1, 0).getDate();
                        bulkUpdateDaySelect.innerHTML = '';
                        for (let i = 1; i <= daysInMonth; i++) {
                            bulkUpdateDaySelect.add(new Option(i, i));
                        }
                        bulkUpdateStatusSelect.innerHTML = '';
                        for (const code in statusCodes) {
                            bulkUpdateStatusSelect.add(new Option(`${statusCodes[code]} (${code})`, code));
                        }
                        document.getElementById('btn-filter-personel').addEventListener('click', loadPuantajDataForCurrentMonth);
                        document.getElementById('btn-clear-filter').addEventListener('click', () => {
                            document.getElementById('personel-filter-select').value = 'all';
                            loadPuantajDataForCurrentMonth();
                        });
                    }
                    puantajInitialized = true;
                    await loadPuantajDataForCurrentMonth();
                } catch (error) {
                    console.error("Puantaj başlatılırken kritik hata:", error);
                    showToast('Puantaj modülü başlatılamadı. Lütfen Ayarlarınızı kontrol edin.', 'error');
                }
            }
            async function loadAndFilterPersonelList() {
                try {
                    const personelSnap = await getDocs(query(collection(db, "personel"), where("okulId", "==", currentUserOkulId), orderBy("ad_soyad")));
                    const gorevSnap = await getSettings('ayarlar_gorevler');
                    const neviSnap = await getSettings('ayarlar_personel_nevileri');
                    const gorevMap = new Map(gorevSnap.docs.map(doc => [doc.id, doc.data().name]));
                    const neviMap = new Map(neviSnap.docs.map(doc => [doc.id, doc.data().name]));
                    puantajPersonelList = personelSnap.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ad: data.ad_soyad || 'İsimsiz',
                            unvan: gorevMap.get(data.gorevi_bransi) || 'Belirtilmemiş',
                            neviAdi: neviMap.get(data.personel_nevisi) || 'Bilinmiyor',
                            maasKarsiligi: parseInt(data.maas_karsiligi) || 20,
                            rehberlik_gorevi: data.rehberlik_gorevi || 'hayir',
                            esDurumu: data.es_durumu,
                            cocuk0_6: data.cocuk_0_6,
                            cocuk6_18: data.cocuk_6_ustu,
                            sozlesme_turu: data.sozlesme_turu || 'Belirsiz Süreli',
                            ise_giris: data.ise_giris || '---',
                            isten_ayrilis: data.isten_ayrilis || '---',
                            kismi_zamanli_calisma: data.kismi_zamanli_calisma || {}
                        };
                    });
                    const personelFilterSelect = document.getElementById('personel-filter-select');
                    personelFilterSelect.innerHTML = '<option value="all">Tüm Personeli Göster</option>';
                    puantajPersonelList.forEach(personel => {
                        personelFilterSelect.add(new Option(personel.ad, personel.id));
                    });
                } catch (error) {
                    console.error("Personel listesi yüklenirken hata:", error);
                    showToast("Personel listesi yüklenemedi. Ayarlarınızı kontrol edin.", "error");
                }
            }

            function calculateStatusCounts(personelId) {
                const personelPuantajVerisi = puantajData[personelId];
                if (!personelPuantajVerisi || !personelPuantajVerisi.dailyData) {
                    return { N: 0, HT: 0, RT: 0, İ: 0, R: 0, Üİ: 0, S: 0, K: 0, RTÇ: 0 };
                }
                const counts = { N: 0, HT: 0, RT: 0, İ: 0, R: 0, Üİ: 0, S: 0, K: 0, RTÇ: 0 };
                for (const date in personelPuantajVerisi.dailyData) {
                    let dayCode = personelPuantajVerisi.dailyData[date].code;
                    if (dayCode === 'UI' || dayCode === 'üi') {
                        dayCode = 'Üİ';
                    }
                    if (dayCode === 'i' || dayCode === 'I') {
                        dayCode = 'İ';
                    }
                    if (counts.hasOwnProperty(dayCode)) {
                        counts[dayCode]++;
                    }
                }
                return counts;
            }

            function handleCustomSelectDisplay(selectElement) {
                if (!selectElement) return;
                Array.from(selectElement.options).forEach(option => {
                    if (option.value) {
                        const kodBilgisi = eksikGunKodlari.find(k => k.kod === option.value);
                        if (kodBilgisi) {
                            option.textContent = `${kodBilgisi.kod} - ${kodBilgisi.aciklama}`;
                        }
                    }
                });
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                if (selectedOption && selectedOption.value) {
                    selectedOption.textContent = selectedOption.value;
                }
            }

            function initializeCustomSelects() {
                const customSelects = document.querySelectorAll('.missing-day-code-select');
                customSelects.forEach(select => {
                    handleCustomSelectDisplay(select);
                    select.addEventListener('focus', () => {
                        Array.from(select.options).forEach(option => {
                            if (option.value) {
                                const kodBilgisi = eksikGunKodlari.find(k => k.kod === option.value);
                                if (kodBilgisi) {
                                    option.textContent = `${kodBilgisi.kod} - ${kodBilgisi.aciklama}`;
                                }
                            }
                        });
                    });
                    select.addEventListener('change', () => handleCustomSelectDisplay(select));
                    select.addEventListener('blur', () => handleCustomSelectDisplay(select));
                });
            }
            async function loadPuantajDataForCurrentMonth() {
                const year = document.getElementById('input-year').value;
                const month = document.getElementById('select-month').value;
                const docId = `${currentUserOkulId}_${year}-${String(parseInt(month) + 1).padStart(2, '0')}`;
                currentPuantajDocRef = doc(db, "kayitli_puantajlar", docId);
                const container = document.getElementById('puantaj-table-container');
                container.innerHTML = `<div style="padding: 40px; text-align: center; background-color: #f8f9fa; border-radius: 8px;"><h4>Puantaj verileri yükleniyor ve hesaplamalar yapılıyor...</h4></div>`;
                try {
                    const ayAdi = document.getElementById('select-month').options[month].text;
                    const baslikMetni = `ÖZEL İSABET ORTAOKULU ${year} YILI ${ayAdi.toLocaleUpperCase('tr-TR')} AYI PERSONEL PUANTAJ CETVELİ`;
                    const docSnap = await getDoc(currentPuantajDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        puantajData = data.puantajData || {};
                        overtimeReasons = data.overtimeReasons || {};
                        missingDayCodes = data.missingDayCodes || {};
                        isPuantajLocked = data.isLocked || false;
                        showToast('Kaydedilmiş puantaj verisi yüklendi.', 'success');
                    } else {
                        puantajData = {};
                        overtimeReasons = {};
                        missingDayCodes = {};
                        isPuantajLocked = false;
                        showToast('Bu ay için kaydedilmiş bir puantaj yok.', 'info');
                    }
                    updateLockStatusUI();
                    const ayinIlkGunu = new Date(Date.UTC(year, month, 1));
                    const ayinSonGunu = new Date(Date.UTC(year, month + 1, 0));
                    const aktifPersonelList = puantajPersonelList.filter(personel => {
                        const girisStr = personel.ise_giris;
                        const ayrilisStr = personel.isten_ayrilis;
                        if (!girisStr) return false;
                        const girisDate = new Date(girisStr + 'T00:00:00Z');
                        if (isNaN(girisDate.getTime())) return false;
                        const iseBaslamisMi = girisDate <= ayinSonGunu;
                        let istenAyrilmamisMi = true;
                        if (ayrilisStr && ayrilisStr.trim() !== '' && ayrilisStr.trim() !== '---') {
                            const ayrilisDate = new Date(ayrilisStr + 'T00:00:00Z');
                            if (!isNaN(ayrilisDate.getTime())) {
                                istenAyrilmamisMi = ayrilisDate >= ayinIlkGunu;
                            }
                        }
                        return iseBaslamisMi && istenAyrilmamisMi;
                    });
                    const selectedPersonelId = document.getElementById('personel-filter-select').value;
                    let displayList = aktifPersonelList;
                    if (selectedPersonelId && selectedPersonelId !== 'all') {
                        displayList = aktifPersonelList.filter(p => p.id === selectedPersonelId);
                    }
                    const nobetVerisi = await fetchAndCalculateNobetData(year, parseInt(month));
                    const calculatedHoursMap = new Map();
                    const hourCalculationPromises = displayList.map(async (personel) => {
                        const hours = await calculateMonthlyHours(personel.id);
                        calculatedHoursMap.set(personel.id, hours);
                    });
                    await Promise.all(hourCalculationPromises);
                    renderPuantajTable(nobetVerisi, displayList, baslikMetni, calculatedHoursMap);
                    renderGrandTotals(nobetVerisi, displayList, calculatedHoursMap);
                    renderLegend();
                    attachCellListeners();
                } catch (error) {
                    console.error("Puantaj verisi yüklenirken hata: ", error);
                    showToast("Puantaj verisi yüklenemedi.", "error");
                    container.innerHTML = `<div style="padding: 40px; text-align: center; background-color: #f8f9fa; border-radius: 8px;"><h4 style="color: var(--danger-color);">Puantaj yüklenirken bir hata oluştu. Lütfen Console'u kontrol edin.</h4></div>`;
                }
            }
            async function savePuantajData() {
                if (isPuantajLocked) {
                    showToast('Puantaj kilitli olduğu için kaydedilemez.', 'error');
                    return;
                }
                if (Object.keys(puantajData).length === 0) {
                    showToast('Kaydedilecek puantaj verisi bulunmuyor.', 'error');
                    return;
                }
                if (!currentPuantajDocRef) {
                    const year = document.getElementById('input-year').value;
                    const month = document.getElementById('select-month').value;
                    const docId = `${currentUserOkulId}_${year}-${String(parseInt(month) + 1).padStart(2, '0')}`;
                    currentPuantajDocRef = doc(db, "kayitli_puantajlar", docId);
                }
                const newOvertimeReasons = {};
                document.querySelectorAll('.overtime-reason-input').forEach(input => {
                    if (input.value.trim() !== '') {
                        newOvertimeReasons[input.dataset.personelId] = input.value.trim();
                    }
                });
                overtimeReasons = newOvertimeReasons;
                const newMissingDayCodes = {};
                document.querySelectorAll('.missing-day-code-select').forEach(select => {
                    if (select.value) {
                        newMissingDayCodes[select.dataset.personelId] = select.value;
                    }
                });
                missingDayCodes = newMissingDayCodes;
                try {
                    await setDoc(currentPuantajDocRef, {
                        puantajData: puantajData,
                        isLocked: isPuantajLocked,
                        overtimeReasons: overtimeReasons,
                        missingDayCodes: missingDayCodes
                    }, {
                        merge: true
                    });
                    showToast('Puantaj başarıyla kaydedildi!', 'success');
                } catch (error) {
                    console.error("Puantaj kaydedilirken hata: ", error);
                    showToast('Puantaj kaydedilemedi.', 'error');
                }
            }
            async function togglePuantajLock() {
                isPuantajLocked = !isPuantajLocked;
                try {
                    if (!currentPuantajDocRef) {
                        const year = document.getElementById('input-year').value;
                        const month = document.getElementById('select-month').value;
                        const docId = `${currentUserOkulId}_${year}-${String(parseInt(month) + 1).padStart(2, '0')}`;
                        currentPuantajDocRef = doc(db, "kayitli_puantajlar", docId);
                    }
                    await setDoc(currentPuantajDocRef, {
                        isLocked: isPuantajLocked
                    }, {
                        merge: true
                    });
                    showToast(isPuantajLocked ? 'Puantaj kilitlendi.' : 'Puantaj kilidi açıldı.', 'success');
                    updateLockStatusUI();
                } catch (error) {
                    console.error("Kilit durumu güncellenirken hata:", error);
                    showToast("Kilit durumu güncellenemedi.", "error");
                    isPuantajLocked = !isPuantajLocked;
                }
            }
            async function deleteCurrentPuantaj() {
                if (isPuantajLocked) {
                    showToast('Puantaj kilitli. Silmek için önce kilidi açmalısınız.', 'error');
                    return;
                }
                if (!currentPuantajDocRef) {
                    showToast('Bu ay için silinecek kayıtlı bir puantaj bulunmuyor.', 'error');
                    return;
                }
                const year = document.getElementById('input-year').value;
                const monthName = document.getElementById('select-month').options[document.getElementById('select-month').selectedIndex].text;
                if (!confirm(`${monthName} ${year} ayına ait puantaj cetvelini kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`)) {
                    return;
                }
                try {
                    await deleteDoc(currentPuantajDocRef);
                    puantajData = {};
                    isPuantajLocked = false;
                    currentPuantajDocRef = null;
                    updateLockStatusUI();
                    renderPuantajTable({}, [], '');
                    renderGrandTotals({}, []);
                    showToast('Puantaj başarıyla silindi.', 'success');
                } catch (error) {
                    console.error("Puantaj silinirken hata:", error);
                    showToast('Puantaj silinirken bir hata oluştu.', 'error');
                }
            }

            function updateLockStatusUI() {
                const lockBtn = document.getElementById('btn-lock-puantaj');
                const generateBtn = document.getElementById('btn-generate');
                if (isPuantajLocked) {
                    lockBtn.textContent = 'Kilidi Aç';
                    lockBtn.style.backgroundColor = '#17a2b8';
                    generateBtn.disabled = true;
                } else {
                    lockBtn.textContent = 'Puantajı Kilitle';
                    lockBtn.style.backgroundColor = '#fd7e14';
                    generateBtn.disabled = false;
                }
            }


            document.addEventListener('DOMContentLoaded', () => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        try {
                            const idTokenResult = await user.getIdTokenResult(true);
                            const claims = idTokenResult.claims;
                            isCurrentUserSuperAdmin = !!claims.superadmin;
                            const superAdminLink = document.getElementById('super-admin-link');

                            loginPanel.style.display = 'none';
                            appContainer.style.display = 'flex';

                            if (isCurrentUserSuperAdmin) {
                                superAdminLink.style.display = 'block';

                                const okullarQuery = query(collection(db, "okullar"), where("durum", "!=", "pasif"));
                                const okullarSnapshot = await getDocs(okullarQuery);
                                const okullar = okullarSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                                if (okullar.length > 0) {
                                    let varsayilanOkul = okullar.find(okul => okul.adi.toLowerCase().includes('ortaokul'));
                                    if (!varsayilanOkul) {
                                        varsayilanOkul = okullar[0];
                                    }
                                    currentUserOkulId = varsayilanOkul.id;

                                    await initializeSchoolSelector(okullar);
                                    if (window.schoolSlimSelect) {
                                        window.schoolSlimSelect.setSelected(currentUserOkulId);
                                    }
                                } else {
                                    showToast('Sistemde hiç aktif okul bulunamadı!', 'error');
                                    initializeApplicationUI();
                                    return;
                                }
                            } else {
                                currentUserOkulId = claims.okulId;
                                superAdminLink.style.display = 'none';
                                document.getElementById('school-selector-container').style.display = 'none';
                                if (!currentUserOkulId) {
                                    alert("Hata: Hesabınız bir okula atanmamış. Lütfen sistem yöneticisi ile iletişime geçin.");
                                    await signOut(auth);
                                    return;
                                }
                            }

                            await loadSharedData();
                            initializeApplicationUI();
                            await renderDashboardData();

                        } catch (error) {
                            console.error("Oturum doğrulanırken hata oluştu:", error);
                            alert("Oturum doğrulanırken bir hata oluştu. Lütfen tekrar giriş yapın.");
                            await signOut(auth);
                        }
                    } else {
                        currentUserOkulId = null;
                        isCurrentUserSuperAdmin = false;
                        loginPanel.style.display = 'flex';
                        appContainer.style.display = 'none';
                        resetApplicationState(true);
                    }
                });
            });

            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
            import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, deleteDoc, query, where, orderBy, documentId, limit, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
            import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
            import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

            const firebaseConfig = {
                apiKey: "AIzaSyBoSgNHT05FNKeswV0KCaKY4-Pz7jpwbXM",
                authDomain: "puantaj-fe3df.firebaseapp.com",
                projectId: "puantaj-fe3df",
                storageBucket: "puantaj-fe3df.appspot.com",
                messagingSenderId: "110213592906",
                appId: "1:110213592906:web:02a14675741fc63e15b3b3",
                measurementId: "G-JC71J8VRJW"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const functions = getFunctions(app);
            window.firebaseFunctions = functions;
            window.httpsCallable = httpsCallable;
            let currentUserOkulId = null;
            let isCurrentUserSuperAdmin = false;

            const auth = getAuth(app);
            window.auth = auth; // Konsoldan erişim için bu satırı ekleyin
            let zamanCizelgesiAyarlari = {};
            const loginPanel = document.getElementById('login-panel');
            const appContainer = document.querySelector('.app-container');


            const loginEmailInput = document.getElementById('login-email');
            const loginPasswordInput = document.getElementById('login-password');
            const loginError = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');

            loginBtn.addEventListener('click', async () => {
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                loginError.style.display = 'none';

                if (!email || !password) {
                    loginError.textContent = 'Lütfen e-posta ve şifre alanlarını doldurun.';
                    loginError.style.display = 'block';
                    return;
                }

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Giriş hatası:", error);
                    loginError.textContent = 'Giriş başarısız. Lütfen bilgilerinizi kontrol edin.';
                    loginError.style.display = 'block';
                }
            });

            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // Çıkış başarılı olduğunda state'i SIFIRLA
                    resetApplicationState();
                    showToast('Başarıyla çıkış yapıldı.', 'info');
                } catch (error) {
                    console.error("Çıkış hatası:", error);
                    showToast('Çıkış yapılırken bir hata oluştu.', 'error');
                }
            });

            function stringToColor(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                const h = hash % 360;
                return `hsl(${h}, ${60 + (hash % 20)}%, ${75 + (hash % 10)}%)`;
            }

            function getContrastColor(bgColor) {
                const lightness = parseInt(bgColor.substring(bgColor.lastIndexOf(',') + 1, bgColor.lastIndexOf('%')).trim());
                return (lightness > 65) ? 'black' : 'white';
            }

            function showSpinner() {
                document.getElementById('global-spinner').style.display = 'flex';
            }

            function showConfirmationModal(message, onConfirm, buttonText = 'Onayla', buttonStyle = 'save') {
                const modal = document.getElementById('confirmation-modal');
                const messageEl = document.getElementById('confirmation-modal-message');
                const confirmBtn = document.getElementById('confirm-action-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                const closeModalBtn = modal.querySelector('.close-modal');
                messageEl.innerHTML = message;
                confirmBtn.textContent = buttonText;
                confirmBtn.classList.remove('btn-delete', 'btn-save', 'btn-add');
                if (buttonStyle === 'delete') {
                    confirmBtn.classList.add('btn-delete');
                } else if (buttonStyle === 'add') {
                    confirmBtn.classList.add('btn-add');
                } else {
                    confirmBtn.classList.add('btn-save');
                }
                modal.classList.add('open');
                const close = () => {
                    modal.classList.remove('open');
                };
                const confirmAction = () => {
                    onConfirm();
                    close();
                };
                confirmBtn.onclick = confirmAction;
                cancelBtn.onclick = close;
                closeModalBtn.onclick = close;
            }

            function hideSpinner() {
                document.getElementById('global-spinner').style.display = 'none';
            }
            const eksikGunKodlari = [{
                kod: "01",
                aciklama: "İstirahat"
            }, {
                kod: "03",
                aciklama: "Disiplin cezası"
            }, {
                kod: "04",
                aciklama: "Gözaltına alınma"
            }, {
                kod: "05",
                aciklama: "Tutukluluk"
            }, {
                kod: "06",
                aciklama: "Kısmi istihdam"
            }, {
                kod: "07",
                aciklama: "Puantaj kayıtları"
            }, {
                kod: "08",
                aciklama: "Grev"
            }, {
                kod: "09",
                aciklama: "Lokavt"
            }, {
                kod: "10",
                aciklama: "Genel hayatı etkileyen olaylar"
            }, {
                kod: "11",
                aciklama: "Doğal afet"
            }, {
                kod: "12",
                aciklama: "Birden fazla"
            }, {
                kod: "13",
                aciklama: "Diğer nedenler"
            }, {
                kod: "15",
                aciklama: "Devamsızlık"
            }, {
                kod: "16",
                aciklama: "Fesih tarihinde çalışmamış"
            }, {
                kod: "17",
                aciklama: "Ev hizmetlerinde 30 günden az çalışma"
            }, {
                kod: "18",
                aciklama: "Kısa çalışma ödeneği"
            }, {
                kod: "19",
                aciklama: "Ücretsiz Doğum İzni"
            }, {
                kod: "20",
                aciklama: "Ücretsiz Yol İzni"
            }, {
                kod: "21",
                aciklama: "Diğer Ücretsiz İzin"
            }, {
                kod: "22",
                aciklama: "5434 SK. ek 76, GM 192"
            }, {
                kod: "23",
                aciklama: "Yarım çalışma ödeneği"
            }, {
                kod: "24",
                aciklama: "Yarım çalışma ödeneği ve diğer nedenler"
            }, {
                kod: "25",
                aciklama: "Diğer belge/kanun türlerinden gün tamamlama"
            }, {
                kod: "26",
                aciklama: "Kısmi istihdama izin verilen yabancı uyruklu sigortalı"
            }, {
                kod: "27",
                aciklama: "Kısa çalışma ödeneği ve diğer nedenler"
            }, {
                kod: "28",
                aciklama: "Pandemi Ücretsiz İzin (4857 Geç.10.Md.)"
            }, {
                kod: "29",
                aciklama: "Pandemi Ücretsiz İzin ve diğer nedenler"
            }];

            const resmiTatiller = {
                "sabit": [{
                    ay: 0,
                    gun: 1,
                    ad: "Yılbaşı"
                }, {
                    ay: 3,
                    gun: 23,
                    ad: "Ulusal Egemenlik ve Çocuk Bayramı"
                }, {
                    ay: 4,
                    gun: 1,
                    ad: "Emek ve Dayanışma Günü"
                }, {
                    ay: 4,
                    gun: 19,
                    ad: "Atatürk'ü Anma, Gençlik ve Spor Bayramı"
                }, {
                    ay: 6,
                    gun: 15,
                    ad: "Demokrasi ve Milli Birlik Günü"
                }, {
                    ay: 7,
                    gun: 30,
                    ad: "Zafer Bayramı"
                }, {
                    ay: 9,
                    gun: 29,
                    ad: "Cumhuriyet Bayramı"
                }],
                "degisken": {
                    "2024": [{
                        ay: 3,
                        gun: 9,
                        ad: "Ramazan Bayramı Arifesi"
                    }, {
                        ay: 3,
                        gun: 10,
                        ad: "Ramazan Bayramı 1. Gün"
                    }, {
                        ay: 3,
                        gun: 11,
                        ad: "Ramazan Bayramı 2. Gün"
                    }, {
                        ay: 3,
                        gun: 12,
                        ad: "Ramazan Bayramı 3. Gün"
                    }, {
                        ay: 5,
                        gun: 15,
                        ad: "Kurban Bayramı Arifesi"
                    }, {
                        ay: 5,
                        gun: 16,
                        ad: "Kurban Bayramı 1. Gün"
                    }, {
                        ay: 5,
                        gun: 17,
                        ad: "Kurban Bayramı 2. Gün"
                    }, {
                        ay: 5,
                        gun: 18,
                        ad: "Kurban Bayramı 3. Gün"
                    }, {
                        ay: 5,
                        gun: 19,
                        ad: "Kurban Bayramı 4. Gün"
                    }],
                    "2025": [{
                        ay: 2,
                        gun: 29,
                        ad: "Ramazan Bayramı Arifesi"
                    }, {
                        ay: 2,
                        gun: 30,
                        ad: "Ramazan Bayramı 1. Gün"
                    }, {
                        ay: 2,
                        gun: 31,
                        ad: "Ramazan Bayramı 2. Gün"
                    }, {
                        ay: 3,
                        gun: 1,
                        ad: "Ramazan Bayramı 3. Gün"
                    }, {
                        ay: 5,
                        gun: 5,
                        ad: "Kurban Bayramı Arifesi"
                    }, {
                        ay: 5,
                        gun: 6,
                        ad: "Kurban Bayramı 1. Gün"
                    }, {
                        ay: 5,
                        gun: 7,
                        ad: "Kurban Bayramı 2. Gün"
                    }, {
                        ay: 5,
                        gun: 8,
                        ad: "Kurban Bayramı 3. Gün"
                    }, {
                        ay: 5,
                        gun: 9,
                        ad: "Kurban Bayramı 4. Gün"
                    }],
                    "2026": [{
                        ay: 2,
                        gun: 18,
                        ad: "Ramazan Bayramı Arifesi"
                    }, {
                        ay: 2,
                        gun: 19,
                        ad: "Ramazan Bayramı 1. Gün"
                    }, {
                        ay: 2,
                        gun: 20,
                        ad: "Ramazan Bayramı 2. Gün"
                    }, {
                        ay: 2,
                        gun: 21,
                        ad: "Ramazan Bayramı 3. Gün"
                    }, {
                        ay: 4,
                        gun: 25,
                        ad: "Kurban Bayramı Arifesi"
                    }, {
                        ay: 4,
                        gun: 26,
                        ad: "Kurban Bayramı 1. Gün"
                    }, {
                        ay: 4,
                        gun: 27,
                        ad: "Kurban Bayramı 2. Gün"
                    }, {
                        ay: 4,
                        gun: 28,
                        ad: "Kurban Bayramı 3. Gün"
                    }, {
                        ay: 4,
                        gun: 29,
                        ad: "Kurban Bayramı 4. Gün"
                    }],
                    "2027": [{
                        ay: 2,
                        gun: 8,
                        ad: "Ramazan Bayramı Arifesi"
                    }, {
                        ay: 2,
                        gun: 9,
                        ad: "Ramazan Bayramı 1. Gün"
                    }, {
                        ay: 2,
                        gun: 10,
                        ad: "Ramazan Bayramı 2. Gün"
                    }, {
                        ay: 2,
                        gun: 11,
                        ad: "Ramazan Bayramı 3. Gün"
                    }, {
                        ay: 4,
                        gun: 15,
                        ad: "Kurban Bayramı Arifesi"
                    }, {
                        ay: 4,
                        gun: 16,
                        ad: "Kurban Bayramı 1. Gün"
                    }, {
                        ay: 4,
                        gun: 17,
                        ad: "Kurban Bayramı 2. Gün"
                    }, {
                        ay: 4,
                        gun: 18,
                        ad: "Kurban Bayramı 3. Gün"
                    }, {
                        ay: 4,
                        gun: 19,
                        ad: "Kurban Bayramı 4. Gün"
                    }],
                    "2028": [{
                        ay: 1,
                        gun: 27,
                        ad: "Ramazan Bayramı Arifesi"
                    }, {
                        ay: 1,
                        gun: 28,
                        ad: "Ramazan Bayramı 1. Gün"
                    }, {
                        ay: 1,
                        gun: 29,
                        ad: "Ramazan Bayramı 2. Gün"
                    }, {
                        ay: 1,
                        gun: 30,
                        ad: "Ramazan Bayramı 3. Gün"
                    }, {
                        ay: 4,
                        gun: 3,
                        ad: "Kurban Bayramı Arifesi"
                    }, {
                        ay: 4,
                        gun: 4,
                        ad: "Kurban Bayramı 1. Gün"
                    }, {
                        ay: 4,
                        gun: 5,
                        ad: "Kurban Bayramı 2. Gün"
                    }, {
                        ay: 4,
                        gun: 6,
                        ad: "Kurban Bayramı 3. Gün"
                    }, {
                        ay: 4,
                        gun: 7,
                        ad: "Kurban Bayramı 4. Gün"
                    }]
                }
            };
            let tumPersonelListesi = [];

            function formatDateDDMMYYYY(dateString) {
                if (!dateString || typeof dateString !== 'string') return '---';
                const parts = dateString.split('-');
                if (parts.length !== 3) return dateString;
                const [year, month, day] = parts;
                return `${day}.${month}.${year}`;
            }

            function isResmiTatil(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const day = date.getDate();
                if (resmiTatiller.sabit.some(t => t.ay === month && t.gun === day)) {
                    return true;
                }
                const yilinTatilleri = resmiTatiller.degisken[year];
                if (yilinTatilleri && yilinTatilleri.some(t => t.ay === month && t.gun === day)) {
                    return true;
                }
                return false;
            }

            function showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s forwards';
                    toast.addEventListener('animationend', () => toast.remove());
                }, 3000);
            }
            async function openPersonelDetayModal(personelId) {
                const modal = document.getElementById('personel-detay-modal');
                const title = document.getElementById('personel-detay-modal-title');
                const bilgilerContainer = document.getElementById('personel-bilgileri-container');
                const izinContainer = document.getElementById('personel-izin-gecmisi-container');
                const nobetContainer = document.getElementById('personel-nobet-gecmisi-container');
                const hizmetContainer = document.getElementById('detay-tab-hizmet');
                title.textContent = 'Personel Profili Yükleniyor...';
                bilgilerContainer.innerHTML = '<p>Kişisel bilgiler yükleniyor...</p>';
                izinContainer.innerHTML = '<p style="padding: 20px;">İzin geçmişi yükleniyor...</p>';
                nobetContainer.innerHTML = '<p style="padding: 20px;">Nöbet geçmişi yükleniyor...</p>';
                hizmetContainer.innerHTML = '<p style="padding: 20px;">Hizmet geçmişi yükleniyor...</p>';
                modal.classList.add('open');
                showSpinner();
                try {
                    const [
                        personelDoc, izinSnap, nobetSnap, izinTipiSnap, nobetYeriSnap,
                        neviSnap, gorevSnap, hizmetGecmisiSnap
                    ] = await Promise.all([
                        getDoc(doc(db, 'personel', personelId)),
                        getDocs(query(collection(db, 'izinler'), where('personelId', '==', personelId), where("okulId", "==", currentUserOkulId), orderBy('baslangicTarihi', 'desc'))),
                        getDocs(query(collection(db, 'nobetler'), where('personelId', '==', personelId), where("okulId", "==", currentUserOkulId), orderBy('tarih', 'desc'))),
                        getSettings('ayarlar_izin_tipleri'),
                        getSettings('ayarlar_nobet_yerleri'),
                        getSettings('ayarlar_personel_nevileri'),
                        getSettings('ayarlar_gorevler'),
                        getDocs(query(collection(db, 'personel', personelId, 'hizmetGecmisi'), orderBy('baslangicTarihi', 'desc')))
                    ]);
                    if (!personelDoc.exists()) {
                        throw new Error('Personel bulunamadı!');
                    }
                    const personel = personelDoc.data();
                    title.textContent = `${personel.ad_soyad} - Personel Profili`;
                    const izinTipiDataMap = new Map(izinTipiSnap.docs.map(d => [d.id, d.data()]));
                    const nobetYeriMap = new Map(nobetYeriSnap.docs.map(d => [d.id, d.data().name]));
                    const neviMap = new Map(neviSnap.docs.map(d => [d.id, d.data().name]));
                    const gorevMap = new Map(gorevSnap.docs.map(d => [d.id, d.data().name]));
                    const kismiCalismaHTML = personel.kismi_zamanli_calisma ? Object.entries(personel.kismi_zamanli_calisma)
                        .map(([gun, saat]) => `<span>${gun}: ${saat} saat</span>`).join('') : 'Yok';
                    bilgilerContainer.innerHTML = `
            <div class="info-grid">
                <div class="info-item"><label>Ad Soyad</label><span>${personel.ad_soyad || '---'}</span></div>
                <div class="info-item"><label>T.C. Kimlik No</label><span>${personel.tc_kimlik_no || '---'}</span></div>
                <div class="info-item"><label>SGK No</label><span>${personel.sgk_no || '---'}</span></div>
                <div class="info-item"><label>Personel Nevisi</label><span>${neviMap.get(personel.personel_nevisi) || '---'}</span></div>
                <div class="info-item"><label>Görevi / Branşı</label><span>${gorevMap.get(personel.gorevi_bransi) || '---'}</span></div>
                <div class="info-item"><label>Sözleşme Türü</label><span>${personel.sozlesme_turu || '---'}</span></div>
                <div class="info-item"><label>İşe Giriş Tarihi</label><span>${formatDateDDMMYYYY(personel.ise_giris)}</span></div>
                <div class="info-item"><label>İşten Ayrılış Tarihi</label><span>${formatDateDDMMYYYY(personel.isten_ayrilis) || 'Devam Ediyor'}</span></div>
                <div class="info-item"><label>Cinsiyet</label><span>${personel.cinsiyet === 'kadin' ? 'Kadın' : 'Erkek'}</span></div>
                <div class="info-item"><label>Eş Durumu</label><span>${personel.es_durumu || '---'}</span></div>
                <div class="info-item"><label>Çocuk Sayısı (0-6 Yaş)</label><span>${personel.cocuk_0_6 || '0'}</span></div>
                <div class="info-item"><label>Çocuk Sayısı (6-18 Yaş)</label><span>${personel.cocuk_6_ustu || '0'}</span></div>
                <div class="info-item full-width"><label>Açıklama</label><span>${personel.aciklama || 'Yok'}</span></div>
                ${personel.sozlesme_turu === 'Kısmi Süreli' ? `
                <div class="info-item full-width"><label>Kısmi Çalışma Saatleri</label><div class="card-list" style="max-height: 80px;">${kismiCalismaHTML}</div></div>` : ''}
            </div>
        `;
                    if (izinSnap.empty) {
                        izinContainer.innerHTML = '<p style="padding: 20px; text-align: center;">Bu personele ait izin kaydı bulunmamaktadır.</p>';
                    } else {
                        let izinTableHTML = '<table class="gorevlendirme-table"><thead><tr><th>İzin Tipi</th><th>Başlangıç</th><th>Bitiş</th><th>Süre</th><th>Açıklama</th></tr></thead><tbody>';
                        izinSnap.forEach(doc => {
                            const izin = doc.data();
                            const izinTipiVerisi = izinTipiDataMap.get(izin.izinTipiId) || {
                                name: 'Bilinmiyor',
                                kod: ''
                            };
                            const sure = calculateNetIzinSuresi(izin.baslangicTarihi, izin.bitisTarihi, personel, izinTipiVerisi.kod);
                            const sureEtiketi = (izinTipiVerisi.kod === 'R' || izinTipiVerisi.kod === 'Üİ') ? 'gün' : 'iş günü';
                            izinTableHTML += `
                    <tr>
                        <td>${izinTipiVerisi.name}</td>
                        <td>${formatDateDDMMYYYY(izin.baslangicTarihi)}</td>
                        <td>${formatDateDDMMYYYY(izin.bitisTarihi)}</td>
                        <td>${sure} ${sureEtiketi}</td>
                        <td>${izin.aciklama || '---'}</td>
                    </tr>
                `;
                        });
                        izinContainer.innerHTML = izinTableHTML + '</tbody></table>';
                    }
                    if (nobetSnap.empty) {
                        nobetContainer.innerHTML = '<p style="padding: 20px; text-align: center;">Bu personele ait nöbet kaydı bulunmamaktadır.</p>';
                    } else {
                        const gunlerTR = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
                        let nobetTableHTML = '<table class="gorevlendirme-table"><thead><tr><th>Tarih</th><th>Gün</th><th>Nöbet Yeri</th></tr></thead><tbody>';
                        nobetSnap.forEach(doc => {
                            const nobet = doc.data();
                            const tarih = new Date(nobet.tarih + 'T00:00:00Z');
                            nobetTableHTML += `
                    <tr>
                        <td>${formatDateDDMMYYYY(nobet.tarih)}</td>
                        <td>${gunlerTR[tarih.getUTCDay()]}</td>
                        <td>${nobetYeriMap.get(nobet.nobetYeriId) || 'Bilinmiyor'}</td>
                    </tr>
                `;
                        });
                        nobetContainer.innerHTML = nobetTableHTML + '</tbody></table>';
                    }
                    if (hizmetGecmisiSnap.empty) {
                        hizmetContainer.innerHTML = '<p style="padding: 20px; text-align: center;">Bu personele ait hizmet geçmişi kaydı bulunmamaktadır.</p>';
                    } else {
                        let hizmetTableHTML = '<div class="table-container" style="margin-top: 20px;"><table class="gorevlendirme-table"><thead><tr><th>Görev / Unvan</th><th>Sözleşme Türü</th><th>Başlangıç Tarihi</th><th>Bitiş Tarihi</th></tr></thead><tbody>';
                        hizmetGecmisiSnap.forEach(doc => {
                            const kayit = doc.data();
                            const gorevAdi = gorevMap.get(kayit.gorevId) || 'Bilinmiyor';
                            const bitisTarihi = kayit.bitisTarihi ? formatDateDDMMYYYY(kayit.bitisTarihi) : '<strong>Devam Ediyor</strong>';
                            hizmetTableHTML += `
                    <tr>
                        <td>${gorevAdi}</td>
                        <td>${kayit.sozlesmeTuru || '---'}</td>
                        <td>${formatDateDDMMYYYY(kayit.baslangicTarihi)}</td>
                        <td>${bitisTarihi}</td>
                    </tr>
                `;
                        });
                        hizmetContainer.innerHTML = hizmetTableHTML + '</tbody></table></div>';
                    }
                } catch (error) {
                    console.error("Personel detayları yüklenirken hata:", error);
                    title.textContent = 'Hata!';
                    bilgilerContainer.innerHTML = `<p style="color:red;">Personel bilgileri yüklenemedi: ${error.message}</p>`;
                    izinContainer.innerHTML = `<p style="color:red; padding: 20px;">İzin geçmişi yüklenemedi: ${error.message}</p>`;
                    nobetContainer.innerHTML = `<p style="color:red; padding: 20px;">Nöbet geçmişi yüklenemedi: ${error.message}</p>`;
                    hizmetContainer.innerHTML = `<p style="color:red; padding: 20px;">Hizmet geçmişi yüklenemedi: ${error.message}</p>`;
                } finally {
                    hideSpinner();
                }
            }

            function safeSetContent(id, content, isHtml = false) {
                const el = document.getElementById(id);
                if (el) {
                    el[isHtml ? 'innerHTML' : 'textContent'] = content;
                }
            }

            async function renderDashboardData() {

                if (isCurrentUserSuperAdmin && !currentUserOkulId) {
                    const dashboardGrid = document.querySelector('#dashboard .dashboard-grid');
                    if (dashboardGrid) {
                        dashboardGrid.innerHTML = `
                        <div class="panel" style="grid-column: 1 / -1; padding: 40px; text-align: center;">
                            <h3 style="color: var(--theme-primary);">Süper Admin Paneline Hoş Geldiniz</h3>
                            <p style="font-size: 1.1em; margin-top: 15px;">
                                Bir okulun verilerini görüntülemek için lütfen sol üstteki menüden <strong>bir okul seçin</strong>.
                            </p>
                        </div>`;
                    }

                    safeSetContent('db-aylik-ekders', '-');
                    safeSetContent('db-aylik-nobet', '-');
                    safeSetContent('db-aylik-rehberlik', '-');
                    safeSetContent('db-aylik-raporlular-list', '<span class="no-data">Okul seçilmedi.</span>', true);
                    return;
                }

                showSpinner();


                safeSetContent('db-aktif-personel', '...');
                safeSetContent('db-gunun-nobetcileri-list', 'Yükleniyor...', true);
                safeSetContent('db-bugun-izinliler-list', 'Yükleniyor...', true);
                safeSetContent('db-bugun-gorevli-list', 'Yükleniyor...', true);
                safeSetContent('db-aylik-ekders', '...');
                safeSetContent('db-aylik-nobet', '...');
                safeSetContent('db-aylik-rehberlik', '...');
                safeSetContent('db-aylik-raporlular-list', 'Yükleniyor...', true);

                try {
                    if (!currentUserOkulId) {
                        throw new Error("Kullanıcı okul kimliği bulunamadı. Oturum başlatılamadı.");
                    }

                    const today = new Date();
                    const todayString = today.toISOString().split('T')[0];
                    const currentYear = today.getFullYear();
                    const currentMonth = today.getMonth();
                    const puantajDocId = `${currentUserOkulId}_${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

                    const [
                        personelSnap, nobetSnap, izinSnap, gorevSnap, nobetYeriSnap,
                        izinTipiSnap, puantajDocSnap
                    ] = await Promise.all([
                        getDocs(query(collection(db, "personel"), where("okulId", "==", currentUserOkulId))),
                        getDocs(query(collection(db, "nobetler"), where("okulId", "==", currentUserOkulId), where("tarih", "==", todayString))),
                        getDocs(query(collection(db, "izinler"), where("okulId", "==", currentUserOkulId), where("baslangicTarihi", "<=", todayString))),
                        getDocs(query(collection(db, "ders_gorevlendirmeleri"), where("okulId", "==", currentUserOkulId), where("tarih", "==", todayString))),
                        getSettings('ayarlar_nobet_yerleri'),
                        getSettings('ayarlar_izin_tipleri'),
                        getDoc(doc(db, "kayitli_puantajlar", puantajDocId))
                    ]);

                    const personelMap = new Map(personelSnap.docs.map(doc => [doc.id, doc.data().ad_soyad]));
                    const nobetYeriMap = new Map(nobetYeriSnap.docs.map(doc => [doc.id, doc.data().name]));
                    const tumPersonelListesi = personelSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    const bugunTarihi = new Date();
                    bugunTarihi.setHours(0, 0, 0, 0);

                    const aktifPersonelListesi = tumPersonelListesi.filter(p => {
                        const ayrilisTarihiStr = p.isten_ayrilis;
                        if (!ayrilisTarihiStr || ayrilisTarihiStr.trim() === '') { return true; }
                        const ayrilisTarihi = new Date(ayrilisTarihiStr);
                        return ayrilisTarihi > bugunTarihi;
                    });

                    safeSetContent('db-aktif-personel', aktifPersonelListesi.length);

                    const nobetHtml = nobetSnap.empty ? '<span class="no-data">Bugün nöbetçi yok.</span>' : nobetSnap.docs.map(doc => `<span><strong>${personelMap.get(doc.data().personelId) || '?'}</strong> - ${nobetYeriMap.get(doc.data().nobetYeriId) || ''}</span>`).join('');
                    safeSetContent('db-gunun-nobetcileri-list', nobetHtml, true);

                    const bugunIzinliler = [];
                    izinSnap.forEach(doc => {
                        const izin = doc.data();
                        if (new Date(izin.bitisTarihi + 'T23:59:59') >= today) {
                            bugunIzinliler.push(personelMap.get(izin.personelId) || '?');
                        }
                    });
                    const izinHtml = bugunIzinliler.length === 0 ? '<span class="no-data">Bugün izinli personel yok.</span>' : bugunIzinliler.map(ad => `<span>${ad}</span>`).join('');
                    safeSetContent('db-bugun-izinliler-list', izinHtml, true);

                    const gorevHtml = gorevSnap.empty ? '<span class="no-data">Bugün görevlendirme yok.</span>' : gorevSnap.docs.map(d => `<span><strong>${personelMap.get(d.data().gorevliId) || '?'}</strong> (Yerine: ${personelMap.get(d.data().asilId) || '?'})</span>`).join('');
                    safeSetContent('db-bugun-gorevli-list', gorevHtml, true);

                    let totalEkders = 0, totalNobet = 0, totalRehberlik = 0;
                    const aylikPuantajVerisi = puantajDocSnap.exists() ? puantajDocSnap.data().puantajData : null;

                    if (aylikPuantajVerisi) {
                        const nobetVerisi = await fetchAndCalculateNobetData(currentYear, currentMonth);
                        const hourPromises = tumPersonelListesi.map(async (personel) => {
                            if (aylikPuantajVerisi[personel.id]) {
                                window.puantajData = aylikPuantajVerisi;
                                const monthlyHours = await calculateMonthlyHours(personel.id);
                                return {
                                    ekders: (personel.neviAdi?.includes('Eğitim Personeli') || personel.unvan?.includes('Müdür')) ? monthlyHours.ekDers : 0,
                                    nobet: nobetVerisi[personel.id] || 0,
                                    rehberlik: calculateEffectiveRehberlikHours(personel.id, currentYear, currentMonth, aylikPuantajVerisi)
                                };
                            }
                            return { ekders: 0, nobet: 0, rehberlik: 0 };
                        });
                        const results = await Promise.all(hourPromises);
                        results.forEach(result => {
                            totalEkders += result.ekders;
                            totalNobet += result.nobet;
                            totalRehberlik += result.rehberlik;
                        });
                    }

                    safeSetContent('db-aylik-ekders', totalEkders);
                    safeSetContent('db-aylik-nobet', totalNobet);
                    safeSetContent('db-aylik-rehberlik', totalRehberlik);

                    const raporluIzinTipi = izinTipiSnap.docs.find(doc => doc.data().kod === 'R');
                    let raporluHtml = '<span class="no-data">Rapor tanımı bulunamadı.</span>';
                    if (raporluIzinTipi) {
                        const raporluPersonelListesi = new Set();
                        const raporSorgusu = query(collection(db, "izinler"), where("okulId", "==", currentUserOkulId), where("izinTipiId", "==", raporluIzinTipi.id));
                        const raporluIzinlerSnap = await getDocs(raporSorgusu);
                        const ayinIlkGunu = new Date(currentYear, currentMonth, 1);
                        const ayinSonGunu = new Date(currentYear, currentMonth + 1, 0);
                        raporluIzinlerSnap.forEach(doc => {
                            const izin = doc.data();
                            if (new Date(izin.baslangicTarihi + 'T00:00:00') <= ayinSonGunu && new Date(izin.bitisTarihi + 'T23:59:59') >= ayinIlkGunu) {
                                const personelAdi = personelMap.get(izin.personelId);
                                if (personelAdi) raporluPersonelListesi.add(personelAdi);
                            }
                        });
                        raporluHtml = raporluPersonelListesi.size === 0 ? '<span class="no-data">Bu ay raporlu personel yok.</span>' : Array.from(raporluPersonelListesi).map(ad => `<span>${ad}</span>`).join('');
                    }
                    safeSetContent('db-aylik-raporlular-list', raporluHtml, true);

                } catch (error) {
                    console.error("Dashboard verisi çekilirken hata:", error);
                    safeSetContent('db-aktif-personel', 'Hata!');
                } finally {
                    hideSpinner();
                }
            }

            const getSettings = async (collectionName) => getDocs(query(collection(db, collectionName), where("okulId", "==", currentUserOkulId), orderBy("name")));
            const addSetting = (collectionName, data) => {
                const dataWithSchoolId = {
                    ...data,
                    okulId: currentUserOkulId
                };
                return addDoc(collection(db, collectionName), dataWithSchoolId);
            };
            const deleteSetting = (collectionName, id) => deleteDoc(doc(db, collectionName, id));


            async function renderSettingsList(collectionName, listElementId, relatedData) {
                const listElement = document.getElementById(listElementId);
                if (!listElement) return;
                listElement.innerHTML = '<li>Yükleniyor...</li>';
                try {
                    const snapshot = await getSettings(collectionName);
                    if (snapshot.empty) {
                        listElement.innerHTML = '<li>Henüz veri eklenmemiş.</li>';
                        return;
                    }
                    listElement.innerHTML = '';
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        const li = document.createElement('li');
                        let displayText = item.name;

                        if (collectionName === 'ayarlar_gorevler' && relatedData) {
                            const nevi = relatedData.find(n => n.id === item.neviId);
                            displayText = `${item.name} <small style="color: #555;">(${nevi ? nevi.name : 'Bilinmeyen'})</small>`;
                        }
                        if (collectionName === 'ayarlar_izin_tipleri') {
                            displayText = `${item.name} <strong style="color: var(--theme-accent);"> (Kod: ${item.kod})</strong>`;
                        }

                        if (collectionName === 'ayarlar_dersler') {
                            displayText = `${item.name} <strong style="color: var(--theme-accent);">(${item.kisaltma || '---'})</strong>`;
                        }



                        const kisaltmaDataAttribute = (collectionName === 'ayarlar_dersler') ? `data-kisaltma="${item.kisaltma || ''}"` : '';
                        li.innerHTML = `
                            <span>${displayText}</span>
                            <div class="actions-cell" style="width: auto; min-width: 120px;">
                                <button class="btn btn-edit btn-edit-setting" data-id="${doc.id}" data-collection="${collectionName}" data-name="${item.name}" ${kisaltmaDataAttribute}>Düzenle</button>
                                <button class="btn btn-delete btn-delete-setting" data-id="${doc.id}" data-collection="${collectionName}" data-name="${item.name}">Sil</button>
                            </div>
                        `;

                        listElement.appendChild(li);
                    });
                } catch (e) {
                    listElement.innerHTML = '<li>Veri yüklenemedi.</li>';
                    console.error("Error rendering settings:", e);
                }
            }

            function openSettingEditModal(id, collectionName, currentName, currentKisaltma = '') {
                const modal = document.getElementById('edit-setting-modal');
                const title = document.getElementById('edit-setting-modal-title');
                const nameInput = document.getElementById('edit-setting-input');
                const kisaltmaGroup = document.getElementById('edit-kisaltma-group');
                const kisaltmaInput = document.getElementById('edit-setting-kisaltma-input');
                const saveBtn = document.getElementById('edit-setting-save-btn');

                title.textContent = `"${currentName}" Adlı Ayarı Düzenle`;
                nameInput.value = currentName;
                saveBtn.dataset.id = id;
                saveBtn.dataset.collection = collectionName;


                if (collectionName === 'ayarlar_dersler') {
                    kisaltmaInput.value = currentKisaltma || '';
                    kisaltmaGroup.style.display = 'block';
                } else {
                    kisaltmaGroup.style.display = 'none';
                }

                modal.classList.add('open');
            }


            document.getElementById('edit-setting-save-btn').addEventListener('click', async () => {
                const saveBtn = document.getElementById('edit-setting-save-btn');
                const id = saveBtn.dataset.id;
                const collectionName = saveBtn.dataset.collection;
                const newName = document.getElementById('edit-setting-input').value.trim();
                const kisaltmaInput = document.getElementById('edit-setting-kisaltma-input');
                const newKisaltma = kisaltmaInput.value.trim().toUpperCase();

                if (!newName) {
                    return showToast('Ayar adı boş bırakılamaz.', 'error');
                }

                const dataToUpdate = { name: newName };

                if (collectionName === 'ayarlar_dersler') {
                    if (!newKisaltma) { return showToast('Kısaltma alanı boş bırakılamaz.', 'error'); }
                    if (newKisaltma.length > 3) { return showToast('Kısaltma en fazla 3 harf olmalıdır.', 'error'); }
                    dataToUpdate.kisaltma = newKisaltma;
                }

                try {
                    const docRef = doc(db, collectionName, id);
                    await setDoc(docRef, dataToUpdate, { merge: true });

                    showToast('Ayar başarıyla güncellendi.');
                    document.getElementById('edit-setting-modal').classList.remove('open');




                    switch (collectionName) {
                        case 'ayarlar_personel_nevileri':
                            await renderSettingsList(collectionName, 'nevi-list');
                            break;
                        case 'ayarlar_gorevler':
                            const neviSnapshot = await getSettings('ayarlar_personel_nevileri');
                            const personelNevileri = neviSnapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
                            await renderSettingsList(collectionName, 'gorev-list', personelNevileri);
                            break;
                        case 'ayarlar_izin_tipleri':
                            await renderSettingsList(collectionName, 'izin-tipi-list');
                            break;
                        case 'ayarlar_nobet_yerleri':
                            await renderSettingsList(collectionName, 'nobet-yeri-list');
                            break;
                        case 'ayarlar_dersler':
                            await renderSettingsList(collectionName, 'ders-list');
                            break;
                        case 'ayarlar_siniflar':
                            await renderSettingsList(collectionName, 'sinif-list');
                            break;
                        case 'ayarlar_derslikler':
                            await renderSettingsList(collectionName, 'derslik-listesi');
                            break;
                    }

                } catch (error) {
                    console.error("Ayar güncellenirken hata:", error);
                    showToast('Güncelleme sırasında bir hata oluştu.', 'error');
                }
            });


            async function loadGenelKurallar() {
                try {
                    const docRef = doc(db, "programlama_kurallari", currentUserOkulId);
                    const docSnap = await getDoc(docRef);
                    const derslerSnap = await getSettings('ayarlar_dersler');
                    const dersMap = new Map(derslerSnap.docs.map(doc => [doc.id, doc.data().name]));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        renderBlokeZamanListesi(data.blokeZamanlar || []);
                        renderZorDersKurali(data.zorDersler, data.maxZorDersSayisi, dersMap);
                    } else {
                        renderBlokeZamanListesi([]);
                        renderZorDersKurali(null, null, dersMap);
                    }
                } catch (e) {
                    console.error("Genel kurallar yüklenemedi:", e);
                }
            }
            async function saveGenelKurallar(data) {
                await setDoc(doc(db, "programlama_kurallari", currentUserOkulId), data, {
                    merge: true
                });
            }

            function renderBlokeZamanListesi(blokeZamanlar) {
                const listEl = document.getElementById('genel-bloke-listesi');
                if (!listEl) return;
                listEl.innerHTML = '';
                blokeZamanlar.forEach((zaman, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span><strong>${zaman.gun}</strong> - ${zaman.saat}. Ders</span>
                        <button class="btn btn-delete" data-index="${index}">Sil</button>`;
                    listEl.appendChild(li);
                });
                listEl.onclick = async (e) => {
                    if (e.target.classList.contains('btn-delete')) {
                        const indexToRemove = parseInt(e.target.dataset.index);
                        blokeZamanlar.splice(indexToRemove, 1);
                        await saveGenelKurallar({
                            blokeZamanlar
                        });
                        renderBlokeZamanListesi(blokeZamanlar);
                        showToast('Bloke zaman kaldırıldı.');
                    }
                };
            }
            async function loadAndRenderDersKurallari() {
                const tbody = document.getElementById('ders-kural-tbody');
                tbody.innerHTML = '<tr><td colspan="6">Yükleniyor...</td></tr>';

                try {

                    const [derslerSnap, personelSnap, dersKurallariSnap] = await Promise.all([
                        getSettings('ayarlar_dersler'),
                        getDocs(query(collection(db, 'personel'), where("okulId", "==", currentUserOkulId))),
                        getDocs(query(collection(db, "ders_kurallari"), where("okulId", "==", currentUserOkulId)))
                    ]);

                    const dersMap = new Map(derslerSnap.docs.map(doc => [doc.id, doc.data().name]));
                    const personelMap = new Map(personelSnap.docs.map(doc => [doc.id, doc.data().ad_soyad]));

                    const tumKurallar = dersKurallariSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));


                    document.getElementById('ders-kural-filters').style.display = 'grid';


                    const dersFilterId = document.getElementById('kural-filter-ders-select').value;
                    const sinifFilterName = document.getElementById('kural-filter-sinif-select').value;
                    const ogretmenFilterId = document.getElementById('kural-filter-ogretmen-select').value;

                    const filtrelenmisKurallar = tumKurallar.filter(kural => {
                        const dersMatch = !dersFilterId || kural.dersId === dersFilterId;
                        const sinifMatch = !sinifFilterName || kural.seviye === sinifFilterName;
                        const ogretmenMatch = !ogretmenFilterId || kural.atananOgretmenId === ogretmenFilterId;
                        return dersMatch && sinifMatch && ogretmenMatch;
                    });

                    tbody.innerHTML = '';
                    let toplamHaftalikSaat = 0;

                    if (filtrelenmisKurallar.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6">Bu filtrelere uygun kural bulunamadı.</td></tr>';
                    } else {
                        filtrelenmisKurallar.sort((a, b) => (dersMap.get(a.dersId) || '').localeCompare(dersMap.get(b.dersId) || '') || a.seviye.localeCompare(b.seviye)).forEach(kural => {
                            const dersAdi = dersMap.get(kural.dersId) || 'Bilinmeyen Ders';
                            const ogretmenAdi = personelMap.get(kural.atananOgretmenId) || '<span style="color:#888;">Atanmamış</span>';
                            const haftalikSaat = parseInt(kural.haftalikSaat) || 0;
                            toplamHaftalikSaat += haftalikSaat;

                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${dersAdi}</td>
                                <td>${kural.seviye}</td>
                                <td>${ogretmenAdi}</td>
                                <td>${haftalikSaat}</td>
                                <td>${kural.gunlukMaxSaat || '-'}</td>
                                <td class="actions-cell" style="width: auto; min-width: 150px;">
                                    <button class="btn btn-edit btn-edit-ders-kurali" data-id="${kural.id}" data-kural='${JSON.stringify(kural)}'>Düzenle</button>
                                    <button class="btn btn-delete btn-delete-setting" data-collection="ders_kurallari" data-id="${kural.id}" data-name="${dersAdi} (${kural.seviye})">Sil</button>
                                </td>
                            `;
                        });
                    }


                    const tfoot = document.getElementById('ders-kural-tfoot');
                    tfoot.innerHTML = `
                        <tr>
                            <td colspan="3" style="text-align: right;">Filtrelenmiş Toplam Haftalık Ders Saati:</td>
                            <td>${toplamHaftalikSaat}</td>
                            <td colspan="2"></td>
                        </tr>
                    `;

                } catch (e) {
                    tbody.innerHTML = `<tr><td colspan="6" style="color:red;">Hata: Kurallar yüklenemedi. ${e.message}</td></tr>`;
                    console.error("Ders kuralları yüklenirken hata:", e);
                }
            }

            function createVisualScheduler() {
                const table = document.getElementById('ogretmen-kural-tablosu');
                if (!table) return;
                table.innerHTML = '';
                const gunler = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma"];
                let thead = '<thead><tr><th>Saatler</th>';
                gunler.forEach(gun => thead += `<th>${gun}</th>`);
                thead += '</tr></thead>';
                table.innerHTML = thead;
                let tbody = '<tbody>';
                dersSaatleri.forEach(slot => {
                    tbody += `<tr><th>${slot.dersNo}. Ders<br><small>${slot.baslangic}-${slot.bitis}</small></th>`;
                    gunler.forEach(gun => {
                        tbody += `<td id="cell-${gun}-${slot.dersNo}" data-status="musait" class="status-musait"></td>`;
                    });
                    tbody += '</tr>';
                });
                tbody += '</tbody>';
                table.innerHTML += tbody;
                table.addEventListener('click', (e) => {
                    if (e.target.tagName === 'TD') {
                        const cell = e.target;
                        const currentStatus = cell.dataset.status;
                        let nextStatus = '';
                        let nextText = '';
                        switch (currentStatus) {
                            case 'musait':
                                nextStatus = 'tercihen-bos';
                                nextText = 'Tercihen Boş';
                                break;
                            case 'tercihen-bos':
                                nextStatus = 'kesinlikle-bos';
                                nextText = 'Kesinlikle Boş';
                                break;
                            case 'kesinlikle-bos':
                                nextStatus = 'musait';
                                nextText = '';
                                break;
                            default:
                                nextStatus = 'musait';
                                nextText = '';
                        }
                        cell.dataset.status = nextStatus;
                        cell.className = `status-${nextStatus}`;
                        cell.textContent = nextText;
                    }
                });
            }
            async function loadOgretmenKurallari(ogretmenId) {
                const form = document.getElementById('ogretmen-kural-formu');
                form.style.display = 'none';
                if (!ogretmenId) return;
                try {
                    const docRef = doc(db, "ogretmen_kurallari", ogretmenId);
                    const docSnap = await getDoc(docRef);
                    const data = docSnap.exists() ? docSnap.data() : {};
                    const zamanPlanlari = data.zamanPlanlari || {};
                    document.querySelectorAll('#ogretmen-kural-tablosu td').forEach(cell => {
                        const status = zamanPlanlari[cell.id] || 'musait';
                        let text = '';
                        if (status === 'tercihen-bos') text = 'Tercihen Boş';
                        else if (status === 'kesinlikle-bos') text = 'Kesinlikle Boş';
                        cell.dataset.status = status;
                        cell.className = `status-${status}`;
                        cell.textContent = text;
                    });
                    document.getElementById('ogretmen-max-gunluk-ders').value = data.maxGunlukDers || '';
                    document.getElementById('ogretmen-max-ardisik-ders').value = data.maxArdisikDers || '';
                    document.getElementById('ogretmen-gunluk-denge').value = data.gunlukDenge || '';
                    document.getElementById('ogretmen-max-bosluk').value = data.maxBosluk || '';
                    form.style.display = 'block';
                } catch (e) {
                    console.error("Öğretmen kuralları yüklenemedi:", e);
                    showToast("Öğretmen kuralları yüklenemedi.", "error");
                }
            }

            function renderZorDersKurali(zorDersler, maxSayi, dersMap) {
                const formContainer = document.getElementById('zor-ders-form-container');
                const gostergeContainer = document.getElementById('zor-ders-kural-gosterge');
                if (zorDersler && zorDersler.length > 0 && maxSayi) {
                    formContainer.style.display = 'none';
                    gostergeContainer.style.display = 'block';
                    const listeUL = document.getElementById('zor-dersler-gosterge-listesi');
                    listeUL.innerHTML = '';
                    zorDersler.forEach(dersId => {
                        const dersAdi = dersMap.get(dersId) || 'Bilinmeyen Ders';
                        const li = document.createElement('li');
                        li.textContent = dersAdi;
                        listeUL.appendChild(li);
                    });
                    document.getElementById('max-zor-ders-gosterge').textContent = maxSayi;
                } else {
                    formContainer.style.display = 'block';
                    gostergeContainer.style.display = 'none';
                }
            }
            async function saveOgretmenKurallari() {
                const ogretmenId = document.getElementById('kural-ogretmen-sec').value;
                if (!ogretmenId) {
                    return showToast('Lütfen önce kurallarını kaydedeceğiniz öğretmeni seçin.', 'error');
                }

                const zamanPlanlari = {};
                document.querySelectorAll('#ogretmen-kural-tablosu td').forEach(cell => {
                    if (cell.id) { // Sadece id'si olan (veri içeren) hücreleri al
                        zamanPlanlari[cell.id] = cell.dataset.status || 'musait';
                    }
                });

                const kuralData = {
                    okulId: currentUserOkulId,
                    zamanPlanlari,
                    maxGunlukDers: document.getElementById('ogretmen-max-gunluk-ders').value || null,
                    maxArdisikDers: document.getElementById('ogretmen-max-ardisik-ders').value || null,
                    gunlukDenge: document.getElementById('ogretmen-gunluk-denge').value || null,
                    maxBosluk: document.getElementById('ogretmen-max-bosluk').value || null,
                };

                try {
                    await setDoc(doc(db, "ogretmen_kurallari", ogretmenId), kuralData);
                    showToast('Öğretmen kuralları başarıyla kaydedildi.', 'success');
                } catch (e) {
                    console.error("Öğretmen kuralları kaydedilemedi:", e);
                    showToast('Kurallar kaydedilirken bir hata oluştu.', 'error');
                }
            }
            async function saveDersKurali() {
                const dersId = document.getElementById('kural-ders-sec').value;
                const secilenSeviyeler = Array.from(document.getElementById('kural-seviye-sec').selectedOptions).map(opt => opt.value);
                const editingId = document.getElementById('editing-ders-kurali-id').value;

                if (!dersId || secilenSeviyeler.length === 0) {
                    return showToast('Lütfen bir Ders ve en az bir Sınıf Seviyesi seçin.', 'error');
                }

                const kuralData = {
                    okulId: currentUserOkulId,
                    dersId: dersId,
                    atananOgretmenId: document.getElementById('kural-ogretmen-ata-sec').value || null,
                    haftalikSaat: document.getElementById('kural-haftalik-saat').value || null,
                    gunlukMaxSaat: document.getElementById('kural-gunluk-max-saat').value || null,
                    blokDers: document.getElementById('kural-blok-ders').value,
                    gerekenDerslikTipi: document.getElementById('kural-derslik-tipi').value,
                    yerlesimTercihi: document.getElementById('kural-yerlesim-tercihi').value,
                    yasakliDersler: Array.from(document.getElementById('kural-yasakli-dersler-sec').selectedOptions).map(opt => opt.value)
                };

                try {
                    if (editingId) {

                        const docRef = doc(db, "ders_kurallari", editingId);

                        await setDoc(docRef, { ...kuralData, seviye: secilenSeviyeler[0] }, { merge: true });
                        showToast('Ders kuralı başarıyla güncellendi.');
                    } else {

                        const promises = secilenSeviyeler.map(seviye => {
                            return addDoc(collection(db, "ders_kurallari"), { ...kuralData, seviye: seviye });
                        });
                        await Promise.all(promises);
                        showToast(`${secilenSeviyeler.length} sınıf seviyesi için ders kuralı başarıyla eklendi.`);
                    }


                    document.getElementById('ders-kurali-detaylari').style.display = 'none';
                    document.getElementById('ders-kural-ekle-btn').textContent = "Kural Ekle/Güncelle";
                    document.getElementById('editing-ders-kurali-id').value = '';
                    const seviyeSelect = document.getElementById('kural-seviye-sec');
                    seviyeSelect.disabled = false;
                    seviyeSelect.value = ''; // Seçimi temizle
                    document.getElementById('kural-ders-sec').value = '';
                    loadAndRenderDersKurallari();

                } catch (e) {
                    console.error("Ders kuralı kaydedilemedi:", e);
                    showToast('Kural kaydedilirken bir hata oluştu.', 'error');
                }
            }





            async function initializeSettings() {
                const settingsContainer = document.getElementById('settings');

                // --- BÖLÜM 1: BİR KERELİK KURULUM (Olay Dinleyicileri) ---
                // Bu bölüm, sadece ilk defa çalışır ve butonlara tıklama olaylarını ekler.
                if (settingsContainer.dataset.initialized !== 'true') {
                    console.log("Ayarlar modülü olay dinleyicileri ilk kez kuruluyor...");

                    const grid = document.getElementById('settings-grid');
                    const backBtn = document.getElementById('settings-back-btn');

                    grid.addEventListener('click', (e) => {
                        const card = e.target.closest('.settings-card');
                        if (!card) return;
                        const tabId = card.dataset.tab;
                        const cardTitle = card.querySelector('.title').textContent;
                        if (tabId === 'ogretmen-kural') {
                            const modal = document.getElementById('ogretmen-kural-modal');
                            if (modal) modal.classList.add('open');
                            return;
                        }
                        const targetPane = document.getElementById(`${tabId}-tab`);
                        if (targetPane) {
                            document.getElementById('settings-panel-title').textContent = cardTitle;
                            backBtn.classList.remove('hidden');
                            grid.style.display = 'none';
                            settingsContainer.querySelectorAll('.settings-tab-content').forEach(pane => pane.classList.remove('active'));
                            targetPane.classList.add('active');
                        }
                    });

                    if (backBtn) {
                        backBtn.addEventListener('click', () => {
                            document.getElementById('settings-panel-title').textContent = 'Uygulama Ayarları';
                            backBtn.classList.add('hidden');
                            settingsContainer.querySelectorAll('.settings-tab-content').forEach(pane => pane.classList.remove('active'));
                            grid.style.display = 'grid';
                        });
                    }

                    document.getElementById('add-nevi-btn').addEventListener('click', async () => {
                        const input = document.getElementById('add-nevi-input');
                        if (!input.value.trim()) return showToast('Lütfen bir nevi adı girin.', 'error');
                        await addSetting('ayarlar_personel_nevileri', { name: input.value.trim() });
                        showToast('Personel nevisi eklendi.');
                        input.value = '';
                        await renderSettingsList('ayarlar_personel_nevileri', 'nevi-list');
                    });

                    document.getElementById('add-ders-btn').addEventListener('click', async () => {
                        const adInput = document.getElementById('add-ders-input');
                        const kisaltmaInput = document.getElementById('add-ders-kisaltma-input');
                        if (!adInput.value.trim() || !kisaltmaInput.value.trim()) return showToast('Lütfen dersin tam adını ve kısaltmasını girin.', 'error');
                        await addSetting('ayarlar_dersler', { name: adInput.value.trim(), kisaltma: kisaltmaInput.value.trim().toUpperCase() });
                        showToast('Ders başarıyla eklendi.');
                        adInput.value = ''; kisaltmaInput.value = '';
                        await renderSettingsList('ayarlar_dersler', 'ders-list');
                    });

                    document.getElementById('add-gorev-btn').addEventListener('click', async () => {
                        const neviSelect = document.getElementById('gorev-nevi-select');
                        const input = document.getElementById('add-gorev-input');
                        if (!neviSelect.value || !input.value.trim()) return showToast('Lütfen nevi seçin ve görev adı girin.', 'error');
                        await addSetting('ayarlar_gorevler', { name: input.value.trim(), neviId: neviSelect.value });
                        showToast('Görev/Branş eklendi.');
                        input.value = '';
                        await renderSettingsList('ayarlar_gorevler', 'gorev-list', []); // Re-fetch inside render
                    });

                    document.getElementById('add-nobet-yeri-btn').addEventListener('click', async () => {
                        const input = document.getElementById('add-nobet-yeri-input');
                        if (!input.value.trim()) return showToast('Lütfen bir nöbet yeri adı girin.', 'error');
                        await addSetting('ayarlar_nobet_yerleri', { name: input.value.trim() });
                        showToast('Nöbet yeri eklendi.');
                        input.value = '';
                        await renderSettingsList('ayarlar_nobet_yerleri', 'nobet-yeri-list');
                    });

                    document.getElementById('add-sinif-btn').addEventListener('click', async () => {
                        const input = document.getElementById('add-sinif-input');
                        if (!input.value.trim()) return showToast('Lütfen bir sınıf adı girin.', 'error');
                        await addSetting('ayarlar_siniflar', { name: input.value.trim() });
                        showToast('Sınıf eklendi.');
                        input.value = '';
                        await renderSettingsList('ayarlar_siniflar', 'sinif-list');
                    });

                    document.getElementById('add-izin-tipi-btn').addEventListener('click', async () => {
                        const adInput = document.getElementById('add-izin-tipi-ad-input');
                        const kodInput = document.getElementById('add-izin-tipi-kod-input');
                        if (!adInput.value.trim() || !kodInput.value.trim()) return showToast('Lütfen izin tipi adı ve kodu girin.', 'error');
                        await addSetting('ayarlar_izin_tipleri', { name: adInput.value.trim(), kod: kodInput.value.trim().toUpperCase() });
                        showToast('İzin tipi eklendi.');
                        adInput.value = ''; kodInput.value = '';
                        await renderSettingsList('ayarlar_izin_tipleri', 'izin-tipi-list');
                    });

                    document.getElementById('add-seminer-donemi-btn').addEventListener('click', async () => {
                        const adInput = document.getElementById('add-seminer-donemi-ad-input');
                        const baslangicInput = document.getElementById('add-seminer-donemi-baslangic-input');
                        const bitisInput = document.getElementById('add-seminer-donemi-bitis-input');
                        if (!adInput.value || !baslangicInput.value || !bitisInput.value) return showToast('Lütfen tüm alanları doldurun.', 'error');
                        await addSetting('ayarlar_seminer_donemleri', { name: adInput.value, baslangic: baslangicInput.value, bitis: bitisInput.value });
                        showToast('Seminer dönemi eklendi.');
                        adInput.value = ''; baslangicInput.value = ''; bitisInput.value = '';
                        await renderSeminerDonemleri();
                    });

                    document.getElementById('zaman-cizelgesi-kaydet-btn').addEventListener('click', saveZamanCizelgesiAyarlari);
                    document.getElementById('ogretmen-kural-kaydet-btn').addEventListener('click', saveOgretmenKurallari);
                    document.getElementById('ders-kural-ekle-btn').addEventListener('click', saveDersKurali);
                    document.getElementById('derslik-ekle-btn').addEventListener('click', async () => {
                        const adInput = document.getElementById('derslik-adi-input');
                        const tipSelect = document.getElementById('derslik-tipi-select');
                        if (!adInput.value.trim()) return showToast('Lütfen bir derslik adı girin.', 'error');
                        await addSetting('ayarlar_derslikler', { name: adInput.value.trim(), type: tipSelect.value });
                        showToast('Derslik eklendi.');
                        adInput.value = '';
                        await renderSettingsList('ayarlar_derslikler', 'derslik-listesi');
                    });

                    settingsContainer.addEventListener('click', async (e) => {
                        const target = e.target;
                        if (!target.matches('.btn-delete-setting, .btn-edit-setting, .btn-edit-ders-kurali')) return;

                        const collectionName = target.dataset.collection;
                        const id = target.dataset.id;
                        const name = target.dataset.name;

                        if (target.matches('.btn-delete-setting')) {
                            showConfirmationModal(`<strong>${name}</strong> adlı kaydı silmek istediğinizden emin misiniz?`, async () => {
                                await deleteSetting(collectionName, id);
                                showToast('Kayıt başarıyla silindi.');
                                // Re-render the specific list
                                const listId = document.querySelector(`#${collectionName.replace('ayarlar_', '').replace(/_/g, '-')}-list, #${collectionName.replace(/_/g, '-')}-list, #${collectionName.replace(/_/g, '-')}-tbody`)?.id;
                                if (listId && listId.includes('tbody')) {
                                    await loadAndRenderDersKurallari();
                                } else if (listId) {
                                    await renderSettingsList(collectionName, listId);
                                }
                            });
                        }
                        if (target.matches('.btn-edit-setting')) {
                            openSettingEditModal(id, collectionName, name, target.dataset.kisaltma);
                        }
                        if (target.matches('.btn-edit-ders-kurali')) {
                            const kuralData = JSON.parse(target.dataset.kural);
                            document.getElementById('kural-ders-sec').value = kuralData.dersId;
                            document.getElementById('ders-kurali-detaylari').style.display = 'block';
                            document.getElementById('editing-ders-kurali-id').value = id;
                            document.getElementById('kural-seviye-sec').value = kuralData.seviye;
                            document.getElementById('kural-seviye-sec').disabled = true;
                            document.getElementById('kural-ogretmen-ata-sec').value = kuralData.atananOgretmenId || '';
                            document.getElementById('kural-haftalik-saat').value = kuralData.haftalikSaat || '';
                            document.getElementById('kural-gunluk-max-saat').value = kuralData.gunlukMaxSaat || '';
                            document.getElementById('ders-kural-ekle-btn').textContent = "Değişiklikleri Güncelle";
                        }
                    });

                    settingsContainer.dataset.initialized = 'true';
                }

                // --- BÖLÜM 2: VERİ YÜKLEME VE GÖRÜNTÜLEME ---
                // Bu bölüm, Ayarlar'a her tıklandığında çalışır ve güncel verileri çeker.
                try {
                    console.log(`Ayarlar verileri '${currentUserOkulId}' okulu için yeniden yükleniyor...`);
                    showSpinner();

                    const [neviSnapshot, derslerSnap, personelSnap, siniflarSnap, dersliklerSnap] = await Promise.all([
                        getSettings('ayarlar_personel_nevileri'),
                        getSettings('ayarlar_dersler'),
                        getDocs(query(collection(db, 'personel'), where("okulId", "==", currentUserOkulId), orderBy('ad_soyad'))),
                        getSettings('ayarlar_siniflar'),
                        getSettings('ayarlar_derslikler')
                    ]);

                    const personelNevileri = neviSnapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
                    const egitimPersoneliNevi = personelNevileri.find(nevi => nevi.name.trim().toLocaleLowerCase('tr-TR') === 'eğitim personeli');
                    const egitimPersoneliNeviId = egitimPersoneliNevi ? egitimPersoneliNevi.id : null;

                    // Filtreleri temizle ve yeniden doldur
                    const selectorsToPopulate = [
                        { id: 'kural-filter-ders-select', snap: derslerSnap, text: 'Tüm Dersler', valueKey: 'id' },
                        { id: 'kural-filter-sinif-select', snap: siniflarSnap, text: 'Tüm Sınıflar', valueKey: 'name' },
                        { id: 'gorev-nevi-select', snap: neviSnapshot, text: 'Personel Nevi Seçin...', valueKey: 'id' },
                        { id: 'kural-ogretmen-sec', snap: personelSnap, text: 'Lütfen Bir Öğretmen Seçin...', valueKey: 'id', filter: (d) => d.data().personel_nevisi === egitimPersoneliNeviId },
                        { id: 'kural-ogretmen-ata-sec', snap: personelSnap, text: 'Öğretmen Seç (İsteğe Bağlı)', valueKey: 'id', filter: (d) => d.data().personel_nevisi === egitimPersoneliNeviId },
                        { id: 'kural-seviye-sec', snap: siniflarSnap, text: '', valueKey: 'name', isMultiple: true },
                        { id: 'kural-ders-sec', snap: derslerSnap, text: 'Lütfen Bir Ders Seçin...', valueKey: 'id' }
                    ];

                    selectorsToPopulate.forEach(s => {
                        const select = document.getElementById(s.id);
                        if (select) {
                            select.innerHTML = s.text ? `<option value="">${s.text}</option>` : '';
                            s.snap.docs.forEach(doc => {
                                if (!s.filter || s.filter(doc)) {
                                    select.add(new Option(doc.data().ad_soyad || doc.data().name, s.valueKey === 'id' ? doc.id : doc.data().name));
                                }
                            });
                        }
                    });

                    // Tüm listeleri yeniden render et
                    await Promise.all([
                        loadZamanCizelgesiAyarlari(),
                        generateTimeSlots().then(createVisualScheduler),
                        loadGenelKurallar(),
                        renderSettingsList('ayarlar_personel_nevileri', 'nevi-list'),
                        renderSettingsList('ayarlar_gorevler', 'gorev-list', personelNevileri),
                        renderSettingsList('ayarlar_dersler', 'ders-list'),
                        renderSettingsList('ayarlar_siniflar', 'sinif-list'),
                        renderSettingsList('ayarlar_nobet_yerleri', 'nobet-yeri-list'),
                        renderSettingsList('ayarlar_izin_tipleri', 'izin-tipi-list'),
                        renderSettingsList('ayarlar_derslikler', 'derslik-listesi'),
                        renderSeminerDonemleri(),
                        loadAndRenderDersKurallari()
                    ]);

                } catch (error) {
                    console.error("Ayarlar verileri yüklenirken kritik bir hata oluştu:", error);
                    showToast('Ayarlar verileri yüklenemedi. Lütfen sayfayı yenileyin.', 'error');
                } finally {
                    hideSpinner();
                }
            }






            async function renderSeminerDonemleri() {
                const listElement = document.getElementById('seminer-donemi-list');
                if (!listElement) return;
                listElement.innerHTML = '<li>Yükleniyor...</li>';
                try {
                    const snapshot = await getDocs(query(collection(db, "ayarlar_seminer_donemleri"), where("okulId", "==", currentUserOkulId)));
                    if (snapshot.empty) {
                        listElement.innerHTML = '<li>Henüz seminer dönemi eklenmemiş.</li>';
                        return;
                    }
                    const donemler = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    donemler.sort((a, b) => new Date(b.baslangic) - new Date(a.baslangic));
                    listElement.innerHTML = '';
                    donemler.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                <span>
                    <strong>${item.name}</strong> 
                    <small>(${formatDateDDMMYYYY(item.baslangic)} - ${formatDateDDMMYYYY(item.bitis)})</small>
                </span>
                <div class="actions-cell" style="width: auto; min-width: 120px;">
                    <button class="btn btn-delete btn-delete-setting" data-id="${item.id}" data-collection="ayarlar_seminer_donemleri" data-name="${item.name}">Sil</button>
                </div>
            `;
                        listElement.appendChild(li);
                    });
                } catch (e) {
                    listElement.innerHTML = '<li>Veri yüklenemedi.</li>';
                    console.error("Error rendering seminer dönemleri:", e);
                }
            }



            async function fetchSeminarPeriods() {
                try {
                    const snapshot = await getDocs(query(collection(db, "ayarlar_seminer_donemleri"), where("okulId", "==", currentUserOkulId)));
                    return snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            baslangic: new Date(data.baslangic + 'T00:00:00Z'),
                            bitis: new Date(data.bitis + 'T23:59:59Z')
                        };
                    });
                } catch (error) {
                    console.error("Seminer dönemleri çekilirken hata:", error);
                    return [];
                }
            }
            async function saveZamanCizelgesiAyarlari() {
                const ayarlar = {
                    dersBaslangic: document.getElementById('setting-dersBaslangic').value,
                    toplamDers: document.getElementById('setting-toplamDers').value,
                    dersSuresi: document.getElementById('setting-dersSuresi').value,
                    teneffusSuresi: document.getElementById('setting-teneffusSuresi').value,
                    ogleArasiDersNo: document.getElementById('setting-ogleArasiDersNo').value,
                    ogleArasiSuresi: document.getElementById('setting-ogleArasiSuresi').value
                };
                try {
                    await setDoc(doc(db, "genel_ayarlar", currentUserOkulId), ayarlar);
                    showToast('Zaman çizelgesi ayarları başarıyla kaydedildi.');
                } catch (e) {
                    console.error("Zaman çizelgesi kaydedilirken hata:", e);
                    showToast('Ayarlar kaydedilirken bir hata oluştu.', 'error');
                }
            }
            async function loadZamanCizelgesiAyarlari() {
                const varsayilanAyarlar = {
                    dersBaslangic: '08:30',
                    toplamDers: '8',
                    dersSuresi: '40',
                    teneffusSuresi: '10',
                    ogleArasiDersNo: '4',
                    ogleArasiSuresi: '45'
                };

                if (!currentUserOkulId) {
                    console.error("Hata: Zaman çizelgesi ayarları yüklenemedi çünkü 'currentUserOkulId' tanımlı değil.");
                    zamanCizelgesiAyarlari = varsayilanAyarlar;
                } else {
                    try {
                        const docSnap = await getDoc(doc(db, "genel_ayarlar", currentUserOkulId));
                        if (docSnap.exists()) {
                            zamanCizelgesiAyarlari = docSnap.data();
                        } else {
                            zamanCizelgesiAyarlari = varsayilanAyarlar;
                        }
                    } catch (e) {
                        console.error("Zaman çizelgesi yüklenirken hata:", e);
                        zamanCizelgesiAyarlari = varsayilanAyarlar;
                    }
                }

                document.getElementById('setting-dersBaslangic').value = zamanCizelgesiAyarlari.dersBaslangic;
                document.getElementById('setting-toplamDers').value = zamanCizelgesiAyarlari.toplamDers;
                document.getElementById('setting-dersSuresi').value = zamanCizelgesiAyarlari.dersSuresi;
                document.getElementById('setting-teneffusSuresi').value = zamanCizelgesiAyarlari.teneffusSuresi;
                document.getElementById('setting-ogleArasiDersNo').value = zamanCizelgesiAyarlari.ogleArasiDersNo;
                document.getElementById('setting-ogleArasiSuresi').value = zamanCizelgesiAyarlari.ogleArasiSuresi;
            }

            function showStaffListSkeleton() {
                const tableArea = document.getElementById('personel-table-area');
                let skeletonHTML = '<div class="table-container"><table class="staff-table"><thead><tr><th>S.N.</th><th>Adı Soyadı</th><th>Cinsiyet</th><th>Personel Nevisi</th><th>Görevi / Branşı</th><th>İşe Giriş</th><th>İşten Ayrılış</th><th>İşlemler</th></tr></thead><tbody>';
                for (let i = 0; i < 5; i++) {
                    skeletonHTML += `
            <tr>
                <td><div class="skeleton skeleton-cell" style="width: 30px; height: 20px;"></div></td>
                <td><div class="skeleton skeleton-cell" style="width: 150px; height: 20px;"></div></td>
                <td><div class="skeleton skeleton-cell" style="width: 60px; height: 20px;"></div></td>
                <td><div class="skeleton skeleton-cell" style="width: 120px; height: 20px;"></div></td>
                <td><div class="skeleton skeleton-cell" style="width: 120px; height: 20px;"></div></td>
                <td><div class="skeleton skeleton-cell" style="width: 80px; height: 20px;"></div></td>
                <td><div class="skeleton skeleton-cell" style="width: 80px; height: 20px;"></div></td>
                <td><div class="skeleton skeleton-cell" style="width: 210px; height: 35px;"></div></td>
            </tr>
        `;
                }
                skeletonHTML += '</tbody></table></div>';
                tableArea.innerHTML = skeletonHTML;
            }
            async function fetchStaff() {
                if (tumPersonelListesi.length > 0) {
                    renderPersonelListesi();
                    return;
                }
                showStaffListSkeleton();
                try {
                    const [staffSnap, neviSnap, gorevSnap] = await Promise.all([
                        getDocs(query(collection(db, "personel"), where("okulId", "==", currentUserOkulId), orderBy("ad_soyad"))),
                        getSettings('ayarlar_personel_nevileri'),
                        getSettings('ayarlar_gorevler')
                    ]);
                    tumPersonelListesi = staffSnap.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    const neviSelect = document.getElementById('filter-nevi-select');
                    const gorevSelect = document.getElementById('filter-gorev-select');
                    neviSelect.length = 1;
                    gorevSelect.length = 1;
                    neviSnap.forEach(doc => neviSelect.add(new Option(doc.data().name, doc.id)));
                    gorevSnap.forEach(doc => gorevSelect.add(new Option(doc.data().name, doc.id)));
                    document.getElementById('search-personel-input').addEventListener('input', renderPersonelListesi);
                    neviSelect.addEventListener('change', renderPersonelListesi);
                    gorevSelect.addEventListener('change', renderPersonelListesi);
                    document.getElementById('clear-personel-filters-btn').addEventListener('click', () => {
                        document.getElementById('search-personel-input').value = '';
                        document.getElementById('filter-nevi-select').value = '';
                        document.getElementById('filter-gorev-select').value = '';
                        renderPersonelListesi();
                    });
                    renderPersonelListesi();
                } catch (e) {
                    document.getElementById('personel-table-area').innerHTML = '<p style="color:red;">Personel listesi yüklenemedi.</p>';
                    console.error("Personel listesi yüklenirken hata:", e);
                }
            }
            async function renderPersonelListesi() {
                const tableContainer = document.getElementById('personel-table-area');
                tableContainer.innerHTML = '<p>Personel listesi filtreleniyor...</p>';
                const searchValue = document.getElementById('search-personel-input').value.toLowerCase();
                const neviValue = document.getElementById('filter-nevi-select').value;
                const gorevValue = document.getElementById('filter-gorev-select').value;
                let filtrelenmisPersonel = tumPersonelListesi.filter(personel => {
                    const adSoyadMatch = !searchValue || personel.ad_soyad.toLowerCase().includes(searchValue);
                    const neviMatch = !neviValue || personel.personel_nevisi === neviValue;
                    const gorevMatch = !gorevValue || personel.gorevi_bransi === gorevValue;
                    return adSoyadMatch && neviMatch && gorevMatch;
                });
                const [neviSnap, gorevSnap] = await Promise.all([
                    getSettings('ayarlar_personel_nevileri'),
                    getSettings('ayarlar_gorevler')
                ]);
                const neviMap = new Map(neviSnap.docs.map(doc => [doc.id, doc.data().name]));
                const gorevMap = new Map(gorevSnap.docs.map(doc => [doc.id, doc.data().name]));
                const aktifPersonel = [];
                const ayrilanPersonel = [];
                const bugun = new Date();
                bugun.setHours(0, 0, 0, 0);
                filtrelenmisPersonel.forEach(personel => {
                    const ayrilisTarihiStr = personel.isten_ayrilis;
                    if (ayrilisTarihiStr && ayrilisTarihiStr.trim() !== '') {
                        const ayrilisTarihi = new Date(ayrilisTarihiStr);
                        if (!isNaN(ayrilisTarihi.getTime()) && ayrilisTarihi <= bugun) {
                            ayrilanPersonel.push(personel);
                        } else {
                            aktifPersonel.push(personel);
                        }
                    } else {
                        aktifPersonel.push(personel);
                    }
                });
                const createTableHTML = (personelListesi) => {
                    if (personelListesi.length === 0) {
                        return '<p style="padding: 15px; background-color: #f8f9fa; border-radius: 5px;">Bu kriterlere uyan personel bulunmamaktadır.</p>';
                    }
                    let tableHTML = `<div class="table-container"><table class="staff-table"><thead><tr><th>S.N.</th><th>Adı Soyadı</th><th>Cinsiyet</th><th>Personel Nevisi</th><th>Görevi / Branşı</th><th>İşe Giriş</th><th>İşten Ayrılış</th><th>İşlemler</th></tr></thead><tbody>`;
                    personelListesi.forEach((s, index) => {
                        const cinsiyet = s.cinsiyet === 'kadin' ? 'Kadın' : (s.cinsiyet === 'erkek' ? 'Erkek' : '---');
                        tableHTML += `<tr>
                            <td>${index + 1}</td>
                            <td>${s.ad_soyad || ''}</td>
                            <td>${cinsiyet}</td>
                            <td>${neviMap.get(s.personel_nevisi) || 'Bilinmiyor'}</td>
                            <td>${gorevMap.get(s.gorevi_bransi) || 'Bilinmiyor'}</td>
                            <td>${formatDateDDMMYYYY(s.ise_giris)}</td>
                            <td>${formatDateDDMMYYYY(s.isten_ayrilis)}</td>
                            <td class="actions-cell">
                                <button class="btn btn-details" data-id="${s.id}" style="background-color:#0dcaf0;">Detay</button>
                                <button class="btn btn-edit" data-id="${s.id}">Düzenle</button>
                                <button class="btn btn-delete" data-id="${s.id}">Sil</button>
                            </td>
                          </tr>`;
                    });
                    tableHTML += `</tbody></table></div>`;
                    return tableHTML;
                };
                let finalHTML = '<h3>Aktif Personel Listesi</h3>';
                finalHTML += createTableHTML(aktifPersonel);
                finalHTML += '<h3 style="margin-top: 40px; border-top: 2px solid #dee2e6; padding-top: 20px;">Ayrılan Personel Listesi</h3>';
                finalHTML += createTableHTML(ayrilanPersonel);
                tableContainer.innerHTML = finalHTML;
            }
            async function loadPersonelForm(staffId = null, staffData = null) {
                const template = document.getElementById('personel-form-template');
                const formContainer = document.getElementById('personelForm');
                formContainer.innerHTML = '';
                formContainer.appendChild(template.content.cloneNode(true));
                formContainer.dataset.editingId = staffId || '';
                document.getElementById('modal-title').textContent = staffId ? 'Personel Bilgilerini Düzenle' : 'Yeni Personel Ekle';
                const neviSelect = document.getElementById('personel_nevisi');
                const gorevSelect = document.getElementById('gorevi_bransi');
                const sozlesmeTuruSelect = document.getElementById('sozlesme_turu');
                const kismiZamanliDiv = document.getElementById('kismi_zamanli_div');
                const rehberlikGoreviDiv = document.getElementById('rehberlik_gorevi_div');
                const maasKarsiligiDiv = document.getElementById('maas_karsiligi_div');
                function updatePersonelFormVisibility() {
                    const selectedNeviText = neviSelect.options[neviSelect.selectedIndex]?.text || '';
                    const selectedContractType = sozlesmeTuruSelect.value;
                    kismiZamanliDiv.style.display = (selectedContractType === 'Kısmi Süreli') ? 'block' : 'none';
                    const isIndefinite = selectedContractType === 'Belirsiz Süreli';
                    rehberlikGoreviDiv.style.display = isIndefinite ? 'none' : 'block';
                    const isSupportStaff = selectedNeviText.includes('Destek Personeli');
                    maasKarsiligiDiv.style.display = (isIndefinite || isSupportStaff) ? 'none' : 'block';
                }
                const neviSnapshot = await getSettings('ayarlar_personel_nevileri');
                neviSnapshot.forEach(doc => neviSelect.add(new Option(doc.data().name, doc.id)));
                neviSelect.addEventListener('change', async () => {
                    const neviId = neviSelect.value;
                    gorevSelect.innerHTML = '<option value="">Yükleniyor...</option>';
                    if (!neviId) {
                        gorevSelect.innerHTML = '<option value="">Önce Personel Nevi Seçin</option>';
                        return;
                    }
                    const q = query(collection(db, 'ayarlar_gorevler'), where("okulId", "==", currentUserOkulId), where('neviId', '==', neviId));
                    const gorevSnapshot = await getDocs(q);
                    gorevSelect.innerHTML = '<option value="">Seçim yapınız...</option>';
                    if (!gorevSnapshot.empty) {
                        gorevSnapshot.forEach(doc => gorevSelect.add(new Option(doc.data().name, doc.id)));
                    }
                    updatePersonelFormVisibility();
                });
                sozlesmeTuruSelect.addEventListener('change', updatePersonelFormVisibility);
                if (staffId && staffData) {
                    document.getElementById('ad_soyad').value = staffData.ad_soyad || '';
                    document.getElementById('tc_kimlik_no').value = staffData.tc_kimlik_no || '';
                    document.getElementById('sgk_no').value = staffData.sgk_no || '';
                    neviSelect.value = staffData.personel_nevisi || '';
                    const neviId = neviSelect.value;
                    gorevSelect.innerHTML = '<option value="">Yükleniyor...</option>';
                    if (neviId) {
                        const q = query(collection(db, 'ayarlar_gorevler'), where("okulId", "==", currentUserOkulId), where('neviId', '==', neviId));
                        const gorevSnapshot = await getDocs(q);
                        gorevSelect.innerHTML = '<option value="">Seçim yapınız...</option>';
                        gorevSnapshot.forEach(doc => gorevSelect.add(new Option(doc.data().name, doc.id)));
                    } else {
                        gorevSelect.innerHTML = '<option value="">Önce Personel Nevisi seçin</option>';
                    }
                    gorevSelect.value = staffData.gorevi_bransi || '';
                    sozlesmeTuruSelect.value = staffData.sozlesme_turu || 'Belirsiz Süreli';
                    if (staffData.cinsiyet) {
                        document.querySelector(`input[name="cinsiyet"][value="${staffData.cinsiyet}"]`).checked = true;
                    }
                    if (staffData.es_durumu) {
                        document.querySelector(`input[name="es_durumu"][value="${staffData.es_durumu}"]`).checked = true;
                    }
                    if (staffData.rehberlik_gorevi) {
                        document.querySelector(`input[name="rehberlik_gorevi"][value="${staffData.rehberlik_gorevi}"]`).checked = true;
                    }
                    document.getElementById('cocuk_0_6').value = staffData.cocuk_0_6 || '0';
                    document.getElementById('cocuk_6_ustu').value = staffData.cocuk_6_ustu || '0';
                    document.getElementById('ise_giris').value = staffData.ise_giris || '';
                    document.getElementById('isten_ayrilis').value = staffData.isten_ayrilis || '';
                    document.getElementById('aciklama').value = staffData.aciklama || '';
                    document.getElementById('maas_karsiligi').value = staffData.maas_karsiligi || '20';
                    if (staffData.kismi_zamanli_calisma) {
                        const gunMap = {
                            'Pazartesi': 'pzts',
                            'Salı': 'sali',
                            'Çarşamba': 'crs',
                            'Perşembe': 'prs',
                            'Cuma': 'cuma',
                            'Cumartesi': 'cmrts',
                            'Pazar': 'pazar'
                        };
                        for (const gun in staffData.kismi_zamanli_calisma) {
                            const shortDay = gunMap[gun];
                            if (shortDay) {
                                const checkbox = document.getElementById(`${shortDay}_calisiyor`);
                                const input = document.getElementById(`${shortDay}_saat`);
                                if (checkbox && input) {
                                    checkbox.checked = true;
                                    input.value = staffData.kismi_zamanli_calisma[gun];
                                }
                            }
                        }
                    }
                } else {
                    document.getElementById('ise_giris').valueAsDate = new Date();
                    document.getElementById('es_bekar').checked = true;
                }
                updatePersonelFormVisibility();
            }
            let currentView = 'sinif';
            let classList = [];
            let teacherList = [];
            const dersSaatleri = [];
            async function publishSchedule() {
                showConfirmationModal(
                    `<strong>Tüm Sınıfların Programı Yayınlanacak</strong><br><br>Bu işlem, mevcut programı tüm sınıflar için kaydedecek ve yayınlanmış olarak işaretleyecektir. Devam etmek istiyor musunuz?`,
                    () => saveAllSchedules(true),
                    'Evet, Yayınla',
                    'add'
                );
            }
            async function saveAllSchedules(isPublishing = false) {
                const etkinTarih = document.getElementById('etkinTarihInput').value;
                if (!etkinTarih) {
                    return showToast('İşlem yapmadan önce "Programın Geçerlilik Başlangıç Tarihi" seçilmelidir.', 'error');
                }
                if (!window.tumProgramlar || Object.keys(window.tumProgramlar).length === 0) {
                    return showToast('Kaydedilecek bir program verisi bulunmuyor.', 'info');
                }
                showSpinner();
                const actionText = isPublishing ? 'yayınlanıyor' : 'kaydediliyor';
                showToast(`Tüm programlar ${actionText}...`, 'info');
                try {
                    const savePromises = Object.keys(window.tumProgramlar).map(sinifAdi =>
                        saveScheduleForClass(sinifAdi, etkinTarih)
                    );
                    await Promise.all(savePromises);
                    const successMessage = `Tüm sınıfların programları başarıyla ${actionText}!`;
                    showToast(successMessage, 'success');
                    if (window.aktifGrup) {
                        renderVersionList(window.aktifGrup.replace(/\//g, '-'));
                    }
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    hideSpinner();
                }
            }
            async function saveScheduleForClass(sinifAdi, etkinTarih) {
                const sanitizedSinifAdi = `${currentUserOkulId}_${sinifAdi.replace(/\//g, '-')}`;
                const docRef = doc(db, "ders_programlari", sanitizedSinifAdi, "versiyonlar", etkinTarih);
                const dataToSave = {
                    ...window.tumProgramlar[sinifAdi],
                    okulId: currentUserOkulId
                };
                try {
                    await setDoc(docRef, dataToSave);
                } catch (error) {
                    throw new Error(`${sinifAdi} programı kaydedilemedi.`);
                }
            }
            async function initializeSchedule() {
                const displayArea = document.getElementById('schedule-display-area');
                displayArea.innerHTML = '<p>Ders programı verileri yükleniyor...</p>';

                try {
                    if (!currentUserOkulId) {
                        throw new Error('Ders programını görüntülemek için önce bir okul seçmelisiniz.');
                    }

                    await loadZamanCizelgesiAyarlari();

                    const derslerSnap = await getSettings('ayarlar_dersler');
                    const dersler = derslerSnap.docs.map(d => ({ id: d.id, name: d.data().name }));

                    const dersSelect = document.getElementById('dersAdi');
                    dersSelect.innerHTML = '<option value="">Ders Seçin...</option>';
                    dersler.forEach(ders => dersSelect.add(new Option(ders.name, ders.id)));

                    const ogretmenSelect = document.getElementById('ogretmen');
                    ogretmenSelect.innerHTML = '<option value="">Öğretmen Seçin...</option>';
                    window.teacherList.forEach(p => ogretmenSelect.add(new Option(p.name, p.id)));

                    window.tumProgramlar = {};
                    await generateTimeSlots();

                    if (!document.getElementById('sinif-gorunum-btn')._initialized) {
                        document.getElementById('sinif-gorunum-btn').addEventListener('click', () => switchView('sinif'));
                        document.getElementById('ogretmen-gorunum-btn').addEventListener('click', () => switchView('ogretmen'));
                        document.getElementById('grup-secim-dropdown').addEventListener('change', (e) => {
                            const selectedValue = e.target.value;
                            if (currentView === 'sinif') {
                                loadScheduleForClass(selectedValue);
                            } else {
                                const selectedOption = e.target.options[e.target.selectedIndex];
                                loadScheduleForTeacher(selectedValue, selectedOption.text);
                            }
                            renderYerlestirmeHavuzu();
                        });
                        document.getElementById('ekleBtn').addEventListener('click', () => addLesson(false));
                        document.getElementById('programi-kaydet-btn').addEventListener('click', () => saveAllSchedules(false));
                        document.getElementById('programi-yayinla-btn').addEventListener('click', publishSchedule);
                        document.getElementById('btn-otomatik-doldur').addEventListener('click', runAutomaticScheduler);
                        document.getElementById('sinif-gorunum-btn')._initialized = true;
                    }

                    await switchView('sinif');
                    await renderYerlestirmeHavuzu();

                } catch (error) {
                    console.error("Ders programı başlatılırken hata:", error);
                    displayArea.innerHTML = `<p style="color:red; font-weight:bold; text-align:center; line-height:1.6;">${error.message}</p>`;
                    showToast('Ders programı yüklenemedi.', 'error');
                }
            }
            async function switchView(viewType) {
                currentView = viewType;
                const sinifBtn = document.getElementById('sinif-gorunum-btn');
                const ogretmenBtn = document.getElementById('ogretmen-gorunum-btn');
                const label = document.getElementById('grup-gorunum-label');
                const dropdown = document.getElementById('grup-secim-dropdown');
                const displayArea = document.getElementById('schedule-display-area');

                dropdown.innerHTML = '';

                if (viewType === 'sinif') {
                    sinifBtn.classList.add('active');
                    ogretmenBtn.classList.remove('active');
                    label.textContent = 'Görüntülenecek Grup (Sınıf)';

                    if (!window.classList || window.classList.length === 0) {
                        displayArea.innerHTML = `<div style="text-align:center; padding: 40px; background-color: #fffbe6; border: 1px solid #ffe58f; border-radius: 8px;">
                            <h3 style="color: #8a6d3b;">Sınıf Bulunamadı</h3>
                            <p>Bu okul için henüz bir sınıf tanımlanmamış. Ders programı oluşturabilmek için lütfen önce <strong>Ayarlar > Sınıflar</strong> menüsünden en az bir sınıf ekleyin.</p>
                        </div>`;
                        return;
                    }

                    window.classList.forEach(sinif => dropdown.add(new Option(sinif, sinif)));
                    await loadScheduleForClass(window.classList[0]);

                } else {
                    sinifBtn.classList.remove('active');
                    ogretmenBtn.classList.add('active');
                    label.textContent = 'Görüntülenecek Grup (Öğretmen)';

                    if (!window.teacherList || window.teacherList.length === 0) {
                        displayArea.innerHTML = `<div style="text-align:center; padding: 40px; background-color: #e6f7ff; border: 1px solid #b3e0ff; border-radius: 8px;">
                            <h3 style="color: #31708f;">Öğretmen Bulunamadı</h3>
                            <p>Bu okul için "Eğitim Personeli" nevisine sahip personel bulunamadı. Lütfen önce <strong>Personel Yönetimi</strong> menüsünden öğretmen ekleyin.</p>
                        </div>`;
                        return;
                    }

                    window.teacherList.forEach(ogretmen => dropdown.add(new Option(ogretmen.name, ogretmen.id)));
                    await loadScheduleForTeacher(window.teacherList[0].id, window.teacherList[0].name);
                }
            }



            async function loadScheduleForClass(sinifAdi) {
                window.aktifGrup = sinifAdi;
                const sanitizedSinifAdi = `${currentUserOkulId}_${sinifAdi.replace(/\//g, '-')}`;
                document.getElementById('aktif-versiyon-bilgisi').textContent = 'En güncel versiyon yükleniyor...';
                try {
                    const versionsRef = collection(db, "ders_programlari", sanitizedSinifAdi, "versiyonlar");
                    const q = query(versionsRef, orderBy(documentId(), "desc"), limit(1));
                    const snapshot = await getDocs(q);
                    window.tumProgramlar[sinifAdi] = snapshot.empty ? {} : snapshot.docs[0].data();
                } catch (error) {
                    console.error("Ders programı yüklenirken hata:", error);
                }
                renderSchedule();
                renderVersionList(sinifAdi.replace(/\//g, '-'));
            }
            async function loadScheduleForTeacher(teacherId, teacherName) {
                window.aktifGrup = teacherName;
                showSpinner();
                for (const sinif of classList) {
                    if (!window.tumProgramlar[sinif]) await loadScheduleForClass(sinif);
                }
                let teacherSchedule = {};
                for (const sinifAdi in window.tumProgramlar) {
                    const sinifProgrami = window.tumProgramlar[sinifAdi];
                    for (const gun in sinifProgrami) {
                        for (const saat in sinifProgrami[gun]) {
                            const dersData = sinifProgrami[gun][saat];
                            if (dersData && dersData.ogretmen === teacherName) {
                                if (!teacherSchedule[gun]) teacherSchedule[gun] = {};
                                teacherSchedule[gun][saat] = {
                                    sinif: sinifAdi,
                                    dersAdi: dersData.dersAdi
                                };
                            }
                        }
                    }
                }
                window.tumProgramlar[teacherName] = teacherSchedule;
                hideSpinner();
                renderSchedule();
                document.getElementById('aktif-versiyon-bilgisi').textContent = `${teacherName} adlı öğretmenin programı görüntüleniyor.`;
                document.getElementById('versiyon-listesi').innerHTML = '<li>Öğretmen görünümünde versiyon listesi bulunmamaktadır.</li>';
            }

            function renderSchedule() {
                const displayArea = document.getElementById('schedule-display-area');
                const gunler = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma"];
                const ogleArasiDersNo = parseInt(zamanCizelgesiAyarlari.ogleArasiDersNo) || 4;
                let tableHTML = '<table class="schedule-table"><thead><tr><th>Saatler</th>';
                gunler.forEach(gun => tableHTML += `<th>${gun}</th>`);
                tableHTML += '</tr></thead><tbody>';
                const mevcutProgram = window.tumProgramlar[window.aktifGrup] || {};
                dersSaatleri.forEach((slot) => {
                    tableHTML += `<tr><th>${slot.dersNo}. Ders<br>${slot.baslangic}-${slot.bitis}</th>`;
                    gunler.forEach(gun => {
                        const dersData = mevcutProgram[gun]?.[slot.baslangic];
                        const conflictClass = dersData && dersData.hasConflict ? 'has-conflict' : '';
                        tableHTML += `<td data-gun="${gun}" data-saat="${slot.baslangic}">`;
                        if (dersData) {
                            const bgColor = stringToColor(dersData.dersAdi);
                            const textColor = getContrastColor(bgColor);
                            const tooltipText = `Öğretmen: ${dersData.ogretmen || 'Atanmamış'}`;
                            const strongText = currentView === 'sinif' ? dersData.ogretmen : dersData.sinif;
                            tableHTML += `<div class="ders-karti ${conflictClass}" 
                                   style="background-color: ${bgColor}; color: ${textColor};" 
                                   data-tooltip="${tooltipText}">
                                   <button class="delete-lesson-btn" title="Dersi Sil">×</button>
                                   <strong>${strongText || ''}</strong>
                                   <span>${dersData.dersAdi || ''}</span>
                              </div>`;
                        }
                        tableHTML += `</td>`;
                    });
                    tableHTML += '</tr>';
                    if (slot.dersNo === ogleArasiDersNo) {
                        tableHTML += '<tr><td colspan="6" style="background:#e9ecef;font-weight:bold; height: 35px; vertical-align: middle;">ÖĞLE ARASI</td></tr>';
                    }
                });
                displayArea.innerHTML = tableHTML + `</tbody></table>`;
                if (currentView === 'sinif') {
                    document.querySelectorAll('.delete-lesson-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const td = e.target.closest('td');
                            deleteLesson(td.dataset.gun, td.dataset.saat);
                        });
                    });
                    attachDragDropListeners();
                } else {
                    document.querySelectorAll('.delete-lesson-btn').forEach(btn => btn.style.display = 'none');
                }
            }
            async function renderVersionList(sinifAdi) {
                const sanitizedSinifAdi = `${currentUserOkulId}_${sinifAdi.replace(/\//g, '-')}`;
                const versiyonListesiUL = document.getElementById('versiyon-listesi');
                if (!versiyonListesiUL) return;
                versiyonListesiUL.innerHTML = '<li>Versiyonlar yükleniyor...</li>';
                const versionsRef = collection(db, "ders_programlari", sanitizedSinifAdi, "versiyonlar");
                const q = query(versionsRef, orderBy(documentId(), "desc"));
                try {
                    const snapshot = await getDocs(q);
                    versiyonListesiUL.innerHTML = '';
                    if (snapshot.empty) {
                        versiyonListesiUL.innerHTML = '<li>Bu sınıf için kayıtlı program versiyonu yok.</li>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                <a href="#" data-tarih="${doc.id}" style="text-decoration: none; color: #0056b3; font-weight: 500;">
                    ${formatDateDDMMYYYY(doc.id)} tarihli program
                </a>
                <button class="btn-delete-version" data-tarih="${doc.id}" data-sinif="${sinifAdi}">Sil</button>
            `;
                        versiyonListesiUL.appendChild(li);
                    });
                    versiyonListesiUL.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const target = e.target;
                        if (target.tagName === 'A') {
                            const tarih = target.dataset.tarih;
                            const docRef = doc(db, "ders_programlari", sanitizedSinifAdi, "versiyonlar", tarih);
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                window.tumProgramlar[window.aktifGrup] = docSnap.data();
                                renderSchedule();
                                document.getElementById('etkinTarihInput').value = tarih;
                                document.getElementById('aktif-versiyon-bilgisi').textContent = `Şu an ${formatDateDDMMYYYY(tarih)} tarihli versiyonu düzenliyorsunuz.`;
                                showToast(`${formatDateDDMMYYYY(tarih)} versiyonu yüklendi.`, 'info');
                            }
                        } else if (target.classList.contains('btn-delete-version')) {
                            const tarih = target.dataset.tarih;
                            deleteScheduleVersion(tarih);
                        }
                    });
                } catch (error) {
                    console.error("Versiyon listesi yüklenirken hata:", error);
                    versiyonListesiUL.innerHTML = '<li>Versiyonlar yüklenemedi.</li>';
                }
            }
            async function deleteScheduleVersion(tarih) {
                showConfirmationModal(
                    `<strong>${formatDateDDMMYYYY(tarih)}</strong> tarihli program versiyonu <strong>TÜM SINIFLARDAN</strong> kalıcı olarak silinecektir. Bu işlem geri alınamaz. Emin misiniz?`,
                    async () => {
                        showSpinner();
                        console.log(`Silme işlemi başlatıldı: ${tarih}`);
                        try {

                            const siniflarSnap = await getSettings('ayarlar_siniflar');
                            const anlikSinifListesi = siniflarSnap.docs.map(doc => doc.data().name);

                            if (anlikSinifListesi.length === 0) {
                                throw new Error("Veritabanında kayıtlı sınıf bulunamadığı için silme işlemi yapılamadı.");
                            }
                            console.log("Silme işlemi için bulunan sınıflar:", anlikSinifListesi.join(', '));


                            const deletePromises = anlikSinifListesi.map(sinifAdi => {
                                const sanitizedSinifAdi = `${currentUserOkulId}_${sinifAdi.replace(/\//g, '-')}`;
                                const docRef = doc(db, "ders_programlari", sanitizedSinifAdi, "versiyonlar", tarih);
                                return deleteDoc(docRef);
                            });

                            await Promise.all(deletePromises);

                            console.log("Tüm silme işlemleri başarıyla tamamlandı.");
                            showToast('Program versiyonu tüm sınıflardan başarıyla silindi.', 'success');


                            if (window.aktifGrup) {
                                await loadScheduleForClass(window.aktifGrup);
                                await renderYerlestirmeHavuzu();
                            }

                        } catch (error) {
                            console.error("!!! VERSİYON SİLME SIRASINDA KRİTİK HATA:", error);
                            showToast(`Silme işlemi başarısız oldu: ${error.message}`, 'error');
                        } finally {
                            hideSpinner();
                        }
                    }
                );
            }

            function generateTimeSlots() {
                dersSaatleri.length = 0;
                const baslangicSaatiStr = zamanCizelgesiAyarlari.dersBaslangic || '08:30';
                const toplamDers = parseInt(zamanCizelgesiAyarlari.toplamDers) || 8;
                const dersSuresi = parseInt(zamanCizelgesiAyarlari.dersSuresi) || 40;
                const teneffusSuresi = parseInt(zamanCizelgesiAyarlari.teneffusSuresi) || 10;
                const ogleArasiDersNo = parseInt(zamanCizelgesiAyarlari.ogleArasiDersNo) || 4;
                const ogleArasiSuresi = parseInt(zamanCizelgesiAyarlari.ogleArasiSuresi) || 45;
                let suankiZaman = new Date();
                const [saat, dakika] = baslangicSaatiStr.split(':');
                suankiZaman.setHours(parseInt(saat), parseInt(dakika), 0, 0);
                for (let i = 1; i <= toplamDers; i++) {
                    if (i > 1 && (i - 1) === ogleArasiDersNo) {
                        suankiZaman.setMinutes(suankiZaman.getMinutes() + ogleArasiSuresi);
                    }
                    let baslangic = new Date(suankiZaman);
                    suankiZaman.setMinutes(suankiZaman.getMinutes() + dersSuresi);
                    let bitis = new Date(suankiZaman);
                    dersSaatleri.push({
                        dersNo: i,
                        baslangic: baslangic.toTimeString().substring(0, 5),
                        bitis: bitis.toTimeString().substring(0, 5)
                    });
                    if (i < toplamDers && i !== ogleArasiDersNo) {
                        suankiZaman.setMinutes(suankiZaman.getMinutes() + teneffusSuresi);
                    }
                }
                const saatSelectleri = [document.getElementById('saat'), document.getElementById('genel-bloke-saat'), document.getElementById('d-saat-select'), document.getElementById('edit-d-saat-select')];
                saatSelectleri.forEach(select => {
                    if (select) {
                        const mevcutDeger = select.value;
                        select.innerHTML = '';
                        dersSaatleri.forEach(slot => select.add(new Option(`${slot.dersNo}. Ders (${slot.baslangic}-${slot.bitis})`, slot.dersNo)));
                        select.value = mevcutDeger;
                    }
                });
                return Promise.resolve();
            }

            function deleteLesson(gun, saat) {
                if (window.tumProgramlar[window.aktifGrup]?.[gun]?.[saat]) {
                    delete window.tumProgramlar[window.aktifGrup][gun][saat];
                    renderSchedule();
                    renderYerlestirmeHavuzu();
                    showToast('Ders kaldırıldı. Kaydetmeyi unutmayın.', 'info');
                }
            }
            async function addLesson(forceAdd = false) {
                const gun = document.getElementById('gun').value;
                const saatSelect = document.getElementById('saat');
                const ogretmenSelect = document.getElementById('ogretmen');
                const dersSelect = document.getElementById('dersAdi');

                const saatNo = parseInt(saatSelect.value);
                const ogretmenAdi = ogretmenSelect.options[ogretmenSelect.selectedIndex].text;
                const dersAdi = dersSelect.options[dersSelect.selectedIndex].text;

                if (!ogretmenAdi || !dersAdi || ogretmenSelect.value === "" || dersSelect.value === "" || !saatNo) {
                    return showToast('Lütfen Gün, Saat, Öğretmen ve Ders seçin.', 'error');
                }


                const saatSlot = dersSaatleri.find(slot => slot.dersNo === saatNo);
                if (!saatSlot) {
                    console.error("Seçilen ders saati için zaman dilimi bulunamadı:", saatNo);
                    return showToast('Geçersiz ders saati seçimi. Sayfayı yenileyin.', 'error');
                }
                const baslangicSaati = saatSlot.baslangic; // Program verisinde anahtar olarak bu kullanılmalı

                if (!window.tumProgramlar[window.aktifGrup]) {
                    window.tumProgramlar[window.aktifGrup] = {};
                }
                if (!window.tumProgramlar[window.aktifGrup][gun]) {
                    window.tumProgramlar[window.aktifGrup][gun] = {};
                }


                window.tumProgramlar[window.aktifGrup][gun][baslangicSaati] = {
                    ogretmen: ogretmenAdi,
                    dersAdi: dersAdi,
                    hasConflict: forceAdd
                };

                renderSchedule();
                showToast('Ders eklendi. Kaydetmeyi unutmayın.', 'info');
                renderYerlestirmeHavuzu();
            }

            async function runAutomaticScheduler() {
                showSpinner();
                showToast('Otomatik programlama başlatıldı...', 'info');
                console.log("--- Otomatik Doldurma Başlatıldı ---");
                try {
                    const [derslerSnap, siniflarSnap, personelSnap, dersKurallariSnap, ogretmenKurallariSnap, genelKurallarSnap] = await Promise.all([
                        getSettings('ayarlar_dersler'),
                        getSettings('ayarlar_siniflar'),
                        getDocs(query(collection(db, 'personel'), where("okulId", "==", currentUserOkulId))),
                        getDocs(query(collection(db, 'ders_kurallari'), where("okulId", "==", currentUserOkulId))),
                        getDocs(query(collection(db, 'ogretmen_kurallari'), where("okulId", "==", currentUserOkulId))),
                        getDoc(doc(db, 'programlama_kurallari', currentUserOkulId))
                    ]);

                    const dersMap = new Map(derslerSnap.docs.map(d => [d.id, d.data().name]));
                    const teacherMap = new Map(personelSnap.docs.map(d => [d.id, d.data().ad_soyad]));
                    const siniflar = siniflarSnap.docs.map(d => d.data().name);
                    const dersKuraliListesi = dersKurallariSnap.docs.map(d => ({ ...d.data(), id: d.id }));

                    let dersHavuzu = [];
                    dersKuraliListesi.forEach(kural => {
                        for (let i = 0; i < kural.haftalikSaat; i++) {
                            dersHavuzu.push({ ...kural, instanceId: `${kural.id}_${i}` });
                        }
                    });

                    console.log(`Toplam yerleştirilecek ders sayısı (dersHavuzu): ${dersHavuzu.length}`);
                    if (dersHavuzu.length === 0) {
                        hideSpinner();
                        return showToast('Yerleştirilecek ders bulunamadı. Lütfen Ders(Branş) Kurallarını kontrol edin.', 'error');
                    }

                    let programTaslagi = {};
                    siniflar.forEach(s => programTaslagi[s] = {});

                    const ogretmenKurallari = new Map(ogretmenKurallariSnap.docs.map(d => [d.id, d.data()]));
                    const genelKurallar = genelKurallarSnap.exists() ? genelKurallarSnap.data() : {};

                    const cozumBulundu = await solveScheduler(programTaslagi, dersHavuzu, { dersMap, teacherMap, ogretmenKurallari, genelKurallar });
                    console.log("Çözümleyici (solver) sonucu:", cozumBulundu);

                    window.tumProgramlar = programTaslagi;

                    let yerlesenDersSayisi = 0;
                    Object.values(programTaslagi).forEach(sinifProgrami => {
                        Object.values(sinifProgrami).forEach(gunProgrami => {
                            yerlesenDersSayisi += Object.keys(gunProgrami).length;
                        });
                    });
                    console.log(`Çözümleyici tarafından yerleştirilen ders sayısı: ${yerlesenDersSayisi}`);


                    renderSchedule();

                    const havuzContainer = document.getElementById('yerlestirme-havuzu-container');


                    if (yerlesenDersSayisi === dersHavuzu.length && cozumBulundu) {
                        showToast('Tüm dersler başarıyla yerleştirildi!', 'success');

                        havuzContainer.innerHTML = '<p style="text-align:center; padding: 20px; color:green; font-weight:bold;">Tüm dersler başarıyla yerleştirildi!</p>';
                    } else {
                        const kalanDersSayisi = dersHavuzu.length - yerlesenDersSayisi;
                        showToast(`Otomatik yerleştirme tamamlandı. ${kalanDersSayisi} ders yerleştirilemedi.`, 'info');
                        console.warn(`${kalanDersSayisi} ders yerleştirilemedi.`);

                        await renderYerlestirmeHavuzu();
                    }

                } catch (error) {
                    console.error("!!! OTOMATİK DOLDURMA SIRASINDA KRİTİK HATA:", error);
                    showToast(`Program oluşturulurken bir hata meydana geldi. Lütfen F12 ile konsolu kontrol edin.`, 'error');
                } finally {
                    hideSpinner();
                }
            }

            async function solveScheduler(schedule, derslerToPlace, dataMaps) {
                if (derslerToPlace.length === 0) {
                    return true;
                }
                const {
                    dersMap,
                    teacherMap
                } = dataMaps;
                const ders = derslerToPlace[0];
                const kalanDersler = derslerToPlace.slice(1);
                const sinifAdi = ders.seviye;
                const gunler = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma"];
                for (const gun of gunler) {
                    for (const saatSlot of dersSaatleri) {
                        const saat = saatSlot.baslangic;
                        const saatNo = saatSlot.dersNo;
                        if (isPlacementValid(schedule, ders, sinifAdi, gun, saat, saatNo, dataMaps)) {
                            if (!schedule[sinifAdi][gun]) schedule[sinifAdi][gun] = {};
                            schedule[sinifAdi][gun][saat] = {
                                ogretmen: teacherMap.get(ders.atananOgretmenId),
                                dersAdi: dersMap.get(ders.dersId)
                            };
                            if (await solveScheduler(schedule, kalanDersler, dataMaps)) {
                                return true;
                            }
                            delete schedule[sinifAdi][gun][saat];
                        }
                    }
                }
                return false;
            }

            function isPlacementValid(schedule, ders, sinifAdi, gun, saat, saatNo, dataMaps) {
                const {
                    teacherMap,
                    ogretmenKurallari,
                    genelKurallar
                } = dataMaps;
                if (schedule[sinifAdi]?.[gun]?.[saat]) {
                    return false;
                }
                const ogretmenId = ders.atananOgretmenId;
                for (const s in schedule) {
                    if (schedule[s]?.[gun]?.[saat]?.ogretmen === teacherMap.get(ogretmenId)) {
                        return false;
                    }
                }
                if (genelKurallar.blokeZamanlar?.some(z => z.gun === gun && parseInt(z.saat) === saatNo)) {
                    return false;
                }
                const kural = ogretmenKurallari.get(ogretmenId);
                if (kural?.zamanPlanlari?.[`cell-${gun}-${saatNo}`] === 'kesinlikle-bos') {
                    return false;
                }
                return true;
            }
            async function renderYerlestirmeHavuzu() {
                const havuzContainer = document.getElementById('yerlestirme-havuzu-container');
                if (!havuzContainer) return;
                havuzContainer.innerHTML = '<p>Havuz hesaplanıyor...</p>';

                try {
                    const [dersKurallariSnap, derslerSnap, personelSnap, siniflarSnap] = await Promise.all([
                        getDocs(query(collection(db, 'ders_kurallari'), where("okulId", "==", currentUserOkulId))),
                        getSettings('ayarlar_dersler'),
                        getDocs(query(collection(db, 'personel'), where("okulId", "==", currentUserOkulId))),
                        getSettings('ayarlar_siniflar')
                    ]);

                    const dersMap = new Map(derslerSnap.docs.map(d => [d.id, d.data().name]));
                    const teacherMap = new Map(personelSnap.docs.map(d => [d.id, d.data().ad_soyad]));
                    const localClassList = siniflarSnap.docs.map(d => d.data().name);

                    const yerlesmisDersSayaci = {};
                    for (const sinifAdi in window.tumProgramlar) {
                        if (!localClassList.includes(sinifAdi)) continue;
                        for (const gun in window.tumProgramlar[sinifAdi]) {
                            for (const saat in window.tumProgramlar[sinifAdi][gun]) {
                                const dersData = window.tumProgramlar[sinifAdi][gun][saat];
                                if (dersData && dersData.kuralId) {
                                    const key = dersData.kuralId;
                                    yerlesmisDersSayaci[key] = (yerlesmisDersSayaci[key] || 0) + 1;
                                }
                            }
                        }
                    }

                    const selectedClass = document.getElementById('grup-secim-dropdown').value;
                    const isClassView = document.getElementById('sinif-gorunum-btn').classList.contains('active');
                    let havuzDolu = false;
                    havuzContainer.innerHTML = '';

                    dersKurallariSnap.forEach(doc => {
                        const kural = doc.data();
                        const kuralinSinifi = kural.seviye;




                        if (isClassView && kuralinSinifi !== selectedClass) {
                            return; // Bu `return`, forEach içinde `continue` gibi çalışır.
                        }

                        const kuralId = doc.id;
                        const gerekenSaat = parseInt(kural.haftalikSaat) || 0;
                        const yerlesmisSaat = yerlesmisDersSayaci[kuralId] || 0;
                        const kalanSaat = gerekenSaat - yerlesmisSaat;

                        if (kalanSaat > 0) {
                            havuzDolu = true;
                            const dersAdi = dersMap.get(kural.dersId) || 'Bilinmeyen Ders';
                            const ogretmenAdi = teacherMap.get(kural.atananOgretmenId) || 'Otomatik';

                            const havuzItem = document.createElement('div');
                            havuzItem.className = 'havuz-item';
                            havuzItem.draggable = true;
                            havuzItem.innerHTML = `
                                <div>
                                    <strong>${dersAdi}</strong>
                                    <small style="color:#555;">(${kuralinSinifi} / ${ogretmenAdi})</small>
                                </div>
                                <span class="kalan-saat">${kalanSaat}</span>`;

                            havuzItem.dataset.kuralId = kuralId;
                            havuzItem.dataset.dersAdi = dersAdi;
                            havuzItem.dataset.ogretmenAdi = ogretmenAdi;
                            havuzItem.dataset.sinifAdi = kuralinSinifi;

                            havuzItem.addEventListener('dragstart', (e) => {
                                e.target.classList.add('dragging');
                                e.dataTransfer.setData('application/json', JSON.stringify({
                                    dersAdi: e.target.dataset.dersAdi,
                                    ogretmenAdi: e.target.dataset.ogretmenAdi,
                                    sinifAdi: e.target.dataset.sinifAdi,
                                    kuralId: e.target.dataset.kuralId
                                }));
                            });
                            havuzItem.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
                            havuzContainer.appendChild(havuzItem);
                        }
                    });

                    if (!havuzDolu) {
                        const message = (isClassView && selectedClass) ?
                            `<p style="text-align:center; color:green; font-weight:bold;">'${selectedClass}' sınıfının tüm dersleri yerleştirilmiş!</p>` :
                            '<p style="text-align:center;">Yerleştirilecek ders bulunmuyor.</p>';
                        havuzContainer.innerHTML = message;
                    }

                } catch (error) {
                    console.error("Yerleştirme havuzu oluşturulurken hata:", error);
                    havuzContainer.innerHTML = '<p style="color:red;">Havuz yüklenemedi.</p>';
                }
            }

            function attachDragDropListeners() {
                const cells = document.querySelectorAll('#schedule-display-area .schedule-table td');
                cells.forEach(cell => {
                    cell.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        const sinifGorunumuAktif = document.getElementById('sinif-gorunum-btn').classList.contains('active');
                        if (sinifGorunumuAktif) {
                            e.currentTarget.classList.add('drag-over');
                        }
                    });
                    cell.addEventListener('dragleave', (e) => {
                        e.currentTarget.classList.remove('drag-over');
                    });
                    cell.addEventListener('drop', async (e) => {
                        e.preventDefault();
                        e.currentTarget.classList.remove('drag-over');
                        const sinifGorunumuAktif = document.getElementById('sinif-gorunum-btn').classList.contains('active');
                        if (!sinifGorunumuAktif) {
                            return;
                        }
                        const data = JSON.parse(e.dataTransfer.getData('application/json'));

                        if (data.sinifAdi !== window.aktifGrup) {
                            return;
                        }
                        const gun = e.currentTarget.dataset.gun;
                        const saat = e.currentTarget.dataset.saat;
                        if (!window.tumProgramlar[data.sinifAdi]) window.tumProgramlar[data.sinifAdi] = {};
                        if (!window.tumProgramlar[data.sinifAdi][gun]) window.tumProgramlar[data.sinifAdi][gun] = {};

                        const dersObjesi = {
                            ogretmen: data.ogretmenAdi,
                            dersAdi: data.dersAdi,
                            kuralId: data.kuralId
                        };
                        window.tumProgramlar[data.sinifAdi][gun][saat] = dersObjesi;

                        await renderYerlestirmeHavuzu();
                        renderSchedule();

                        showToast('Ders programa eklendi. Kaydetmeyi unutmayın.', 'info');
                    });
                });
            }
            let geciciDetaylar = [];
            let duzenlenenGorevDetaylari = [];
            let gorevlendirmeInitialized = false;
            async function populateOgretmenSelectsForGorevlendirme() {
                const gAsilOgretmen = document.getElementById('g-asil-ogretmen');
                const gGorevliOgretmen = document.getElementById('g-gorevli-ogretmen');
                if (!gAsilOgretmen || !gGorevliOgretmen) return;
                gAsilOgretmen.innerHTML = '<option value="">Yükleniyor...</option>';
                gGorevliOgretmen.innerHTML = '<option value="">Yükleniyor...</option>';
                try {
                    const [personelSnap, neviSnap, gorevSnap] = await Promise.all([
                        getDocs(query(collection(db, 'personel'), where("okulId", "==", currentUserOkulId))),
                        getSettings('ayarlar_personel_nevileri'),
                        getSettings('ayarlar_gorevler')
                    ]);
                    const egitimPersoneliNevi = neviSnap.docs.find(doc => doc.data().name.includes('Eğitim Personeli'));
                    const egitimPersoneliNeviId = egitimPersoneliNevi ? egitimPersoneliNevi.id : null;
                    const idariGorevler = new Set();
                    gorevSnap.forEach(doc => {
                        const gorevAdi = doc.data().name.toLowerCase();
                        if (gorevAdi.includes('müdür') || gorevAdi.includes('rehber öğretmen')) {
                            idariGorevler.add(doc.id);
                        }
                    });
                    const gosterilecekPersoneller = [];
                    personelSnap.forEach(doc => {
                        const personel = {
                            id: doc.id,
                            ...doc.data()
                        };
                        const isEgitimPersoneli = personel.personel_nevisi === egitimPersoneliNeviId;
                        const isIdariGorevli = idariGorevler.has(personel.gorevi_bransi);
                        if (isEgitimPersoneli || isIdariGorevli) {
                            gosterilecekPersoneller.push(personel);
                        }
                    });
                    gAsilOgretmen.innerHTML = '<option value="">Seçiniz...</option>';
                    gGorevliOgretmen.innerHTML = '<option value="">Seçiniz...</option>';
                    gosterilecekPersoneller.forEach(p => {
                        gAsilOgretmen.add(new Option(p.ad_soyad, p.id));
                        gGorevliOgretmen.add(new Option(p.ad_soyad, p.id));
                    });
                } catch (e) {
                    console.error("Görevlendirilecek öğretmenler yüklenemedi:", e);
                    showToast('Öğretmen listesi yüklenemedi.', 'error');
                }
            }
            async function initializeGorevlendirme() {
                if (gorevlendirmeInitialized) return;
                const gDetayEkleBtn = document.getElementById('g-detay-ekle-btn');
                const gKaydetBtn = document.getElementById('g-kaydet-btn');
                const geciciListeUL = document.getElementById('gecici-detay-listesi');
                const gorevlendirmeTbody = document.getElementById('gorevlendirme-tbody');
                const sinifSelect = document.getElementById('d-sinif-select');
                const bransSelect = document.getElementById('d-brans-select');
                const saatSelect = document.getElementById('d-saat-select');
                const yazdirBtn = document.getElementById('btn-gorev-yazdir');
                if (sinifSelect && sinifSelect.options.length === 0) {
                    const siniflarSnap = await getSettings('ayarlar_siniflar');
                    siniflarSnap.forEach(doc => sinifSelect.add(new Option(doc.data().name, doc.data().name)));
                }

                if (bransSelect && bransSelect.options.length === 0) {
                    const derslerSnap = await getSettings('ayarlar_dersler');
                    derslerSnap.forEach(doc => bransSelect.add(new Option(doc.data().name, doc.data().name)));
                }
                await generateTimeSlots();
                if (saatSelect && saatSelect.options.length === 0) {
                    saatSelect.innerHTML = '<option value="">Ders Saati Seçin...</option>';
                    dersSaatleri.forEach(slot => {
                        saatSelect.add(new Option(`${slot.dersNo}. Ders (${slot.baslangic}-${slot.bitis})`, slot.dersNo));
                    });
                }
                await populateOgretmenSelectsForGorevlendirme();
                await renderGorevlendirmeTable();
                if (gDetayEkleBtn) gDetayEkleBtn.addEventListener('click', addDetay);
                if (gKaydetBtn) gKaydetBtn.addEventListener('click', addGorevlendirme);
                if (yazdirBtn) yazdirBtn.addEventListener('click', () => window.print());
                if (geciciListeUL) geciciListeUL.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-temp-btn')) {
                        const index = parseInt(e.target.dataset.index);
                        geciciDetaylar.splice(index, 1);
                        renderGeciciDetayListesi();
                    }
                });
                if (gorevlendirmeTbody) gorevlendirmeTbody.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const id = target.dataset.id;
                    if (target.classList.contains('btn-delete-gorev')) {
                        if (confirm('Bu görevlendirme kaydını silmek istediğinizden emin misiniz?')) {
                            await deleteDoc(doc(db, 'ders_gorevlendirmeleri', id));
                            showToast('Görevlendirme başarıyla silindi.');
                            await renderGorevlendirmeTable();
                        }
                    }
                    if (target.classList.contains('btn-edit-gorev')) {
                        openEditGorevlendirmeModal(id);
                    }
                });
                const editDetayEkleBtn = document.getElementById('edit-g-detay-ekle-btn');
                if (editDetayEkleBtn) editDetayEkleBtn.addEventListener('click', () => {
                    const sinif = document.getElementById('edit-d-sinif-select').value;
                    const brans = document.getElementById('edit-d-brans-select').value;
                    const saat = parseInt(document.getElementById('edit-d-saat-select').value);
                    if (!sinif || !brans || !saat) {
                        return showToast('Lütfen Sınıf, Branş ve Saat seçimi yapın.', 'error');
                    }
                    duzenlenenGorevDetaylari.push({
                        sinif,
                        brans,
                        saat
                    });
                    renderDuzenlenenDetayListesi();
                });
                const editDetayListesi = document.getElementById('edit-g-detay-listesi');
                if (editDetayListesi) editDetayListesi.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-temp-btn')) {
                        const index = parseInt(e.target.dataset.index);
                        duzenlenenGorevDetaylari.splice(index, 1);
                        renderDuzenlenenDetayListesi();
                    }
                });
                const editForm = document.getElementById('editGorevlendirmeForm');
                if (editForm) editForm.addEventListener('submit', saveGorevlendirmeChanges);
                const closeModalBtn = document.querySelector('#edit-gorevlendirme-modal .close-modal');
                if (closeModalBtn) closeModalBtn.addEventListener('click', () => {
                    document.getElementById('edit-gorevlendirme-modal').classList.remove('open');
                });
                gorevlendirmeInitialized = true;
            }
            async function renderGorevlendirmeTable() {
                const gTbody = document.getElementById('gorevlendirme-tbody');
                gTbody.innerHTML = '<tr><td colspan="7">Görevlendirmeler yükleniyor...</td></tr>';
                try {
                    const [gorevlendirmeSnap, personelSnap] = await Promise.all([
                        getDocs(query(collection(db, 'ders_gorevlendirmeleri'), where("okulId", "==", currentUserOkulId), orderBy("tarih", "desc"))),
                        getDocs(query(collection(db, 'personel'), where("okulId", "==", currentUserOkulId)))
                    ]);
                    const personelMap = new Map();
                    personelSnap.forEach(doc => personelMap.set(doc.id, doc.data().ad_soyad));
                    if (gorevlendirmeSnap.empty) {
                        gTbody.innerHTML = '<tr><td colspan="7">Kayıtlı görevlendirme bulunamadı.</td></tr>';
                        return;
                    }
                    gTbody.innerHTML = '';
                    gorevlendirmeSnap.forEach(doc => {
                        const g = doc.data();
                        const asil = personelMap.get(g.asilId) || 'Bilinmiyor';
                        const gorevli = personelMap.get(g.gorevliId) || 'Bilinmiyor';
                        let detaylarHTML = '<ul class="ders-detaylari">';
                        g.detaylar.forEach(d => {
                            detaylarHTML += `<li>${d.sinif} / ${d.brans} (${d.saat}. Ders)</li>`;
                        });
                        detaylarHTML += '</ul>';
                        const row = gTbody.insertRow();
                        row.innerHTML = `
                <td>${new Date(g.tarih).toLocaleDateString('tr-TR')}</td>
                <td>${asil}</td>
                <td>${gorevli}</td>
                <td><b>${g.toplamSaat}</b></td>
                <td>${detaylarHTML}</td>
                <td>${g.aciklama}</td>
                <td class="actions-cell no-print">
                   <button class="btn btn-edit btn-edit-gorev" data-id="${doc.id}">Düzenle</button>
                   <button class="btn btn-delete btn-delete-gorev" data-id="${doc.id}">Sil</button>
                </td>
            `;
                    });
                } catch (e) {
                    console.error("Görevlendirmeler yüklenemedi:", e);
                    showToast('Görevlendirmeler yüklenemedi.', 'error');
                    gTbody.innerHTML = '<tr><td colspan="7" style="color:red;">Veri yüklenirken bir hata oluştu.</td></tr>';
                }
            }

            function renderGeciciDetayListesi() {
                const geciciListeUL = document.getElementById('gecici-detay-listesi');
                geciciListeUL.innerHTML = '';
                geciciDetaylar.forEach((detay, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span><b>${detay.sinif} / ${detay.brans}</b> - ${detay.saat}. Ders</span> <button class="delete-temp-btn" data-index="${index}">Sil</button>`;
                    geciciListeUL.appendChild(li);
                });
            }

            function renderDuzenlenenDetayListesi() {
                const listeUL = document.getElementById('edit-g-detay-listesi');
                listeUL.innerHTML = '';
                duzenlenenGorevDetaylari.forEach((detay, index) => {
                    const li = document.createElement('li');
                    li.style.cssText = "display: flex; justify-content: space-between; align-items: center; background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 8px;";
                    li.innerHTML = `
                    <span><b>${detay.sinif} / ${detay.brans}</b> - ${detay.saat}. Ders</span>
                    <button type="button" class="delete-temp-btn" data-index="${index}" style="background: none; border: none; color: var(--danger-color); cursor: pointer; font-weight: bold;">Sil</button>
                `;
                    listeUL.appendChild(li);
                });
            }

            function addDetay() {
                const dSinifSelect = document.getElementById('d-sinif-select');
                const dBransSelect = document.getElementById('d-brans-select');
                const dSaatSelect = document.getElementById('d-saat-select');
                const sinif = dSinifSelect.value;
                const brans = dBransSelect.value;
                const saat = parseInt(dSaatSelect.value);
                if (!sinif || !brans || !saat) {
                    alert('Lütfen Sınıf, Branş ve Saat seçimi yapın.');
                    return;
                }
                geciciDetaylar.push({
                    sinif,
                    brans,
                    saat
                });
                renderGeciciDetayListesi();
                dSinifSelect.value = '';
                dBransSelect.value = '';
                dSaatSelect.value = '';
            }
            async function addGorevlendirme() {
                const gTarih = document.getElementById('g-tarih'),
                    gAsilOgretmen = document.getElementById('g-asil-ogretmen'),
                    gGorevliOgretmen = document.getElementById('g-gorevli-ogretmen'),
                    gAciklama = document.getElementById('g-aciklama');
                const tarih = gTarih.value,
                    asilId = gAsilOgretmen.value,
                    gorevliId = gGorevliOgretmen.value,
                    aciklama = gAciklama.value.trim();
                if (!tarih || !asilId || !gorevliId) {
                    alert('Lütfen ana bilgilerdeki tüm zorunlu alanları doldurun.');
                    return;
                }
                if (geciciDetaylar.length === 0) {
                    alert('Lütfen en az bir ders dağılımı detayı ekleyin.');
                    return;
                }
                const toplamSaat = geciciDetaylar.length;
                const yeniGorevlendirme = {
                    okulId: currentUserOkulId,
                    tarih,
                    asilId,
                    gorevliId,
                    toplamSaat,
                    aciklama,
                    detaylar: geciciDetaylar,
                    kayitTarihi: new Date().toISOString()
                };
                try {
                    await addDoc(collection(db, 'ders_gorevlendirmeleri'), yeniGorevlendirme);
                    showToast('Görevlendirme başarıyla kaydedildi.');
                    geciciDetaylar = [];
                    renderGeciciDetayListesi();
                    gTarih.value = '';
                    gAsilOgretmen.value = '';
                    gGorevliOgretmen.value = '';
                    gAciklama.value = '';
                    await renderGorevlendirmeTable();
                } catch (e) {
                    console.error("Görevlendirme kaydedilemedi:", e);
                    showToast('Görevlendirme kaydedilirken bir hata oluştu.', 'error');
                }
            }
            async function openEditGorevlendirmeModal(id) {
                const modal = document.getElementById('edit-gorevlendirme-modal');
                duzenlenenGorevDetaylari = [];
                const sinifSelect = document.getElementById('edit-d-sinif-select');
                if (sinifSelect.options.length <= 0) {
                    const [siniflarSnap, derslerSnap] = await Promise.all([
                        getSettings('ayarlar_siniflar'), getSettings('ayarlar_dersler')
                    ]);
                    siniflarSnap.forEach(doc => sinifSelect.add(new Option(doc.data().name, doc.data().name)));
                    const bransSelect = document.getElementById('edit-d-brans-select');
                    derslerSnap.forEach(doc => bransSelect.add(new Option(doc.data().name, doc.data().name)));
                    await generateTimeSlots();
                    const saatSelect = document.getElementById('edit-d-saat-select');
                    saatSelect.innerHTML = '<option value="">Ders Saati Seçin...</option>';
                    dersSaatleri.forEach(slot => {
                        saatSelect.add(new Option(`${slot.dersNo}. Ders (${slot.baslangic}-${slot.bitis})`, slot.dersNo));
                    });
                    const asilSelect = document.getElementById('edit-g-asil-ogretmen');
                    const gorevliSelect = document.getElementById('edit-g-gorevli-ogretmen');
                    const personelSnap = await getDocs(query(collection(db, 'personel'), where("okulId", "==", currentUserOkulId)));
                    personelSnap.forEach(doc => {
                        const p = {
                            id: doc.id,
                            ...doc.data()
                        };
                        asilSelect.add(new Option(p.ad_soyad, p.id));
                        gorevliSelect.add(new Option(p.ad_soyad, p.id));
                    });
                }
                try {
                    const docSnap = await getDoc(doc(db, "ders_gorevlendirmeleri", id));
                    if (!docSnap.exists()) {
                        showToast('Görevlendirme kaydı bulunamadı.', 'error');
                        return;
                    }
                    const data = docSnap.data();
                    document.getElementById('edit-g-id').value = id;
                    document.getElementById('edit-g-tarih').value = data.tarih;
                    document.getElementById('edit-g-aciklama').value = data.aciklama || '';
                    document.getElementById('edit-g-asil-ogretmen').value = data.asilId;
                    document.getElementById('edit-g-gorevli-ogretmen').value = data.gorevliId;
                    if (data.detaylar) {
                        duzenlenenGorevDetaylari = [...data.detaylar];
                    }
                    renderDuzenlenenDetayListesi();
                    modal.classList.add('open');
                } catch (error) {
                    console.error("Görevlendirme düzenleme verisi çekilirken hata:", error);
                    showToast("Veri yüklenirken bir hata oluştu.", "error");
                }
            }
            async function saveGorevlendirmeChanges(event) {
                event.preventDefault();
                const id = document.getElementById('edit-g-id').value;
                if (!id) {
                    showToast('Kaydedilecek görevlendirme bulunamadı.', 'error');
                    return;
                }
                if (duzenlenenGorevDetaylari.length === 0) {
                    return showToast('Lütfen en az bir ders dağılımı detayı ekleyin.', 'error');
                }
                const toplamSaat = duzenlenenGorevDetaylari.length;
                const updatedData = {
                    tarih: document.getElementById('edit-g-tarih').value,
                    asilId: document.getElementById('edit-g-asil-ogretmen').value,
                    gorevliId: document.getElementById('edit-g-gorevli-ogretmen').value,
                    aciklama: document.getElementById('edit-g-aciklama').value.trim(),
                    detaylar: duzenlenenGorevDetaylari,
                    toplamSaat: toplamSaat
                };
                if (!updatedData.tarih || !updatedData.asilId || !updatedData.gorevliId) {
                    return showToast("Lütfen Tarih ve Öğretmen alanlarını doldurun.", "error");
                }
                try {
                    const gorevRef = doc(db, 'ders_gorevlendirmeleri', id);
                    await setDoc(gorevRef, updatedData, {
                        merge: true
                    });
                    showToast('Görevlendirme başarıyla güncellendi.');
                    document.getElementById('edit-gorevlendirme-modal').classList.remove('open');
                    await renderGorevlendirmeTable();
                } catch (error) {
                    console.error("Görevlendirme güncelleme hatası:", error);
                    showToast('Güncelleme sırasında bir hata oluştu.', 'error');
                }
            }
            async function addNobet() {
                const tarihInput = document.getElementById('nobet-tarih');
                const personelSelect = document.getElementById('nobet-personel');
                const yerSelect = document.getElementById('nobet-yeri');
                const tarih = tarihInput.value;
                const personelId = personelSelect.value;
                const nobetYeriId = yerSelect.value;
                if (!tarih || !personelId || !nobetYeriId) {
                    showToast('Lütfen Tarih, Personel ve Nöbet Yeri seçin.', 'error');
                    return;
                }
                try {
                    await addDoc(collection(db, 'nobetler'), {
                        okulId: currentUserOkulId,
                        tarih: tarih,
                        personelId: personelId,
                        nobetYeriId: nobetYeriId
                    });
                    showToast('Nöbet başarıyla eklendi.', 'success');
                    tarihInput.value = '';
                    personelSelect.value = '';
                    yerSelect.value = '';
                    const year = parseInt(document.getElementById('rapor-yil-gir').value);
                    const month = parseInt(document.getElementById('rapor-ay-sec').value);
                    await renderNobetRaporu(year, month);
                } catch (error) {
                    console.error("Nöbet eklenirken hata: ", error);
                    showToast('Nöbet eklenirken bir hata oluştu.', 'error');
                }
            }
            async function deleteSelectedNobetler() {
                const selectedCheckboxes = document.querySelectorAll('.nobet-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    showToast('Lütfen silmek için en az bir nöbet seçin.', 'error');
                    return;
                }
                if (!confirm(`${selectedCheckboxes.length} adet nöbet kaydını silmek istediğinizden emin misiniz?`)) {
                    return;
                }
                const deletePromises = [];
                selectedCheckboxes.forEach(checkbox => {
                    const nobetId = checkbox.dataset.id;
                    deletePromises.push(deleteDoc(doc(db, 'nobetler', nobetId)));
                });
                try {
                    await Promise.all(deletePromises);
                    showToast(`${selectedCheckboxes.length} nöbet kaydı başarıyla silindi.`, 'success');
                    const year = parseInt(document.getElementById('rapor-yil-gir').value);
                    const month = parseInt(document.getElementById('rapor-ay-sec').value);
                    await renderNobetRaporu(year, month);
                } catch (error) {
                    console.error("Toplu nöbet silme hatası:", error);
                    showToast('Nöbetler silinirken bir hata oluştu.', 'error');
                }
            }
            let nobetTakipInitialized = false;
            async function initializeNobetTakip() {
                if (nobetTakipInitialized) return;
                nobetTakipInitialized = true;
                const personelSelect = document.getElementById('nobet-personel');
                const yerSelect = document.getElementById('nobet-yeri');
                const raporAySec = document.getElementById('rapor-ay-sec');
                const raporYilGir = document.getElementById('rapor-yil-gir');
                const nobetEkleBtn = document.getElementById('nobet-ekle-btn');
                const nobetRaporTbody = document.getElementById('nobet-rapor-tbody');
                const yazdirBtn = document.getElementById('btn-nobet-yazdir');
                const topluSilBtn = document.getElementById('btn-nobet-toplu-sil');
                const copySourceMonth = document.getElementById('copy-source-month');
                const copySourceYear = document.getElementById('copy-source-year');
                const copyDestMonth = document.getElementById('copy-dest-month');
                const copyDestYear = document.getElementById('copy-dest-year');
                const copyBtn = document.getElementById('copy-schedule-btn');
                const editModal = document.getElementById('edit-nobet-modal');
                const editForm = document.getElementById('edit-nobet-form');
                const personelSnap = await getDocs(query(collection(db, 'personel'), where("okulId", "==", currentUserOkulId)));
                const nobetYeriSnap = await getSettings('ayarlar_nobet_yerleri');
                const personelOptions = personelSnap.docs.map(doc => `<option value="${doc.id}">${doc.data().ad_soyad}</option>`).join('');
                personelSelect.innerHTML = '<option value="">Personel Seçiniz...</option>' + personelOptions;
                document.getElementById('edit-nobet-personel').innerHTML = personelOptions;
                const yerOptions = nobetYeriSnap.docs.map(doc => `<option value="${doc.id}">${doc.data().name}</option>`).join('');
                yerSelect.innerHTML = '<option value="">Nöbet Yeri Seçiniz...</option>' + yerOptions;
                document.getElementById('edit-nobet-yeri').innerHTML = yerOptions;
                const now = new Date();
                const aylar = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
                [raporAySec, copySourceMonth, copyDestMonth].forEach(select => {
                    select.innerHTML = '';
                    aylar.forEach((ay, index) => select.add(new Option(ay, index)));
                });
                raporAySec.value = now.getMonth();
                raporYilGir.value = now.getFullYear();
                const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0);
                copySourceMonth.value = prevMonth.getMonth();
                copySourceYear.value = prevMonth.getFullYear();
                copyDestMonth.value = now.getMonth();
                copyDestYear.value = now.getFullYear();
                const renderRapor = () => renderNobetRaporu(parseInt(raporYilGir.value), parseInt(raporAySec.value));
                renderRapor();
                raporAySec.addEventListener('change', renderRapor);
                raporYilGir.addEventListener('change', renderRapor);
                copyBtn.addEventListener('click', copyNobetSchedule);
                yazdirBtn.addEventListener('click', () => window.print());
                nobetEkleBtn.addEventListener('click', addNobet);
                topluSilBtn.addEventListener('click', deleteSelectedNobetler);
                editModal.querySelector('.close-modal').addEventListener('click', () => editModal.classList.remove('open'));
                editForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveNobetChanges();
                });
                nobetRaporTbody.addEventListener('click', async (e) => {
                    const target = e.target;
                    if (target.classList.contains('btn-delete-nobet')) {
                        if (confirm('Bu nöbet kaydını silmek istediğinizden emin misiniz?')) {
                            await deleteDoc(doc(db, 'nobetler', target.dataset.id));
                            showToast('Nöbet kaydı silindi.');
                            renderRapor();
                        }
                    }
                    if (target.classList.contains('btn-edit-nobet')) {
                        openNobetEditModal(target.dataset.id);
                    }
                });
            }

            async function renderNobetRaporu(year, month) {
                const tbody = document.getElementById('nobet-rapor-tbody');
                const thead = tbody.closest('table').querySelector('thead tr');
                thead.innerHTML = `
        <th class="no-print" style="width: 40px;"><input type="checkbox" id="select-all-nobet" title="Tümünü Seç"></th>
        <th>Tarih</th>
        <th>Gün</th>
        <th>Nöbetçi Personel</th>
        <th>Nöbet Yeri</th>
        <th class="no-print">İşlemler</th>
    `;
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Rapor oluşturuluyor...</td></tr>`;
                const startDateString = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                let endYear = year;
                let endMonth = month + 2;
                if (endMonth > 12) {
                    endMonth = 1;
                    endYear++;
                }
                const endDateString = `${endYear}-${String(endMonth).padStart(2, '0')}-01`;
                const q = query(
                    collection(db, 'nobetler'),
                    where("okulId", "==", currentUserOkulId),
                    where('tarih', '>=', startDateString),
                    where('tarih', '<', endDateString),
                    orderBy('tarih')
                );
                const [nobetSnap, personelSnap, yerSnap] = await Promise.all([
                    getDocs(q),
                    getDocs(query(collection(db, 'personel'), where("okulId", "==", currentUserOkulId))),
                    getSettings('ayarlar_nobet_yerleri')
                ]);
                const personelMap = new Map(personelSnap.docs.map(doc => [doc.id, doc.data().ad_soyad]));
                const yerMap = new Map(yerSnap.docs.map(doc => [doc.id, doc.data().name]));
                if (nobetSnap.empty) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Seçili ay için nöbet kaydı bulunamadı.</td></tr>`;
                    return;
                }
                tbody.innerHTML = '';
                const gunlerTR = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
                let sonTarih = null;
                let renkIndex = 0;
                const renkler = ['renk-a', 'renk-b'];
                nobetSnap.forEach(doc => {
                    const nobet = doc.data();
                    const tarih = new Date(nobet.tarih + 'T00:00:00Z');
                    if (sonTarih !== nobet.tarih) {
                        sonTarih = nobet.tarih;
                        renkIndex = (renkIndex + 1) % 2;
                    }
                    const row = tbody.insertRow();
                    row.className = renkler[renkIndex];
                    row.innerHTML = `
            <td class="no-print" style="text-align: center;">
                <input type="checkbox" class="nobet-checkbox" data-id="${doc.id}">
            </td>
            <td>${tarih.toLocaleDateString('tr-TR', { timeZone: 'UTC' })}</td>
            <td>${gunlerTR[tarih.getUTCDay()]}</td>
            <td>${personelMap.get(nobet.personelId) || 'Bilinmiyor'}</td>
            <td>${yerMap.get(nobet.nobetYeriId) || 'Bilinmiyor'}</td>
            <td class="actions-cell no-print">
                <button class="btn btn-edit btn-edit-nobet" data-id="${doc.id}">Düzenle</button>
                <button class="btn btn-delete btn-delete-nobet" data-id="${doc.id}">Sil</button>
            </td>
        `;
                });
                document.getElementById('select-all-nobet').addEventListener('change', (e) => {
                    document.querySelectorAll('.nobet-checkbox').forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                });
            }
            async function openNobetEditModal(id) {
                const modal = document.getElementById('edit-nobet-modal');
                try {
                    const docRef = doc(db, 'nobetler', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('edit-nobet-id').value = id;
                        document.getElementById('edit-nobet-tarih').value = data.tarih;
                        document.getElementById('edit-nobet-personel').value = data.personelId;
                        document.getElementById('edit-nobet-yeri').value = data.nobetYeriId;
                        modal.classList.add('open');
                    } else {
                        showToast('Nöbet kaydı bulunamadı.', 'error');
                    }
                } catch (error) {
                    console.error("Nöbet düzenleme verisi çekilirken hata:", error);
                    showToast('Veri yüklenemedi.', 'error');
                }
            }
            async function saveNobetChanges() {
                const modal = document.getElementById('edit-nobet-modal');
                const id = document.getElementById('edit-nobet-id').value;
                const updatedData = {
                    tarih: document.getElementById('edit-nobet-tarih').value,
                    personelId: document.getElementById('edit-nobet-personel').value,
                    nobetYeriId: document.getElementById('edit-nobet-yeri').value,
                };
                if (!updatedData.tarih || !updatedData.personelId || !updatedData.nobetYeriId) {
                    return showToast('Lütfen tüm alanları doldurun.', 'error');
                }
                try {
                    await updateDoc(doc(db, 'nobetler', id), updatedData);
                    showToast('Nöbet kaydı başarıyla güncellendi.');
                    modal.classList.remove('open');
                    const year = parseInt(document.getElementById('rapor-yil-gir').value);
                    const month = parseInt(document.getElementById('rapor-ay-sec').value);
                    await renderNobetRaporu(year, month);
                } catch (error) {
                    console.error("Nöbet güncellenirken hata:", error);
                    showToast('Güncelleme sırasında bir hata oluştu.', 'error');
                }
            }
            async function copyNobetSchedule() {
                const sourceYear = parseInt(document.getElementById('copy-source-year').value);
                const sourceMonth = parseInt(document.getElementById('copy-source-month').value);
                const destYear = parseInt(document.getElementById('copy-dest-year').value);
                const destMonth = parseInt(document.getElementById('copy-dest-month').value);
                if (sourceYear === destYear && sourceMonth === destMonth) {
                    return showToast('Kaynak ve hedef ay aynı olamaz.', 'error');
                }
                const kaynakAyAdi = document.getElementById('copy-source-month').options[sourceMonth].text;
                const hedefAyAdi = document.getElementById('copy-dest-month').options[destMonth].text;
                if (!confirm(`${kaynakAyAdi} ${sourceYear} ayındaki nöbet düzenini, ${hedefAyAdi} ${destYear} ayına kopyalamak istediğinizden emin misiniz?`)) {
                    return;
                }
                showToast('Akıllı kopyalama işlemi başlatıldı...', 'info');
                const sourceStartDate = new Date(Date.UTC(sourceYear, sourceMonth, 1)).toISOString().split('T')[0];
                const sourceEndDate = new Date(Date.UTC(sourceYear, sourceMonth + 1, 1)).toISOString().split('T')[0];
                const q = query(collection(db, 'nobetler'), where("okulId", "==", currentUserOkulId), where('tarih', '>=', sourceStartDate), where('tarih', '<', sourceEndDate));
                const nobetSnap = await getDocs(q);
                if (nobetSnap.empty) {
                    return showToast('Kaynak ayda kopyalanacak nöbet kaydı bulunamadı.', 'error');
                }
                const rosterTemplate = {
                    1: new Set(),
                    2: new Set(),
                    3: new Set(),
                    4: new Set(),
                    5: new Set()
                };
                nobetSnap.forEach(doc => {
                    const nobet = doc.data();
                    const tarihUTC = new Date(nobet.tarih + 'T00:00:00Z');
                    const dayOfWeek = tarihUTC.getUTCDay();
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                        const dutyIdentifier = JSON.stringify({
                            p: nobet.personelId,
                            y: nobet.nobetYeriId
                        });
                        rosterTemplate[dayOfWeek].add(dutyIdentifier);
                    }
                });
                let kopyalananKayitSayisi = 0;
                const promises = [];
                const daysInDestMonth = new Date(destYear, destMonth + 1, 0).getDate();
                for (let day = 1; day <= daysInDestMonth; day++) {
                    const hedefTarihUTC = new Date(Date.UTC(destYear, destMonth, day));
                    const dayOfWeek = hedefTarihUTC.getUTCDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6 || !rosterTemplate[dayOfWeek] || rosterTemplate[dayOfWeek].size === 0) {
                        continue;
                    }
                    rosterTemplate[dayOfWeek].forEach(dutyJson => {
                        const dutyInfo = JSON.parse(dutyJson);
                        const yeniNobet = {
                            okulId: currentUserOkulId,
                            personelId: dutyInfo.p,
                            nobetYeriId: dutyInfo.y,
                            tarih: hedefTarihUTC.toISOString().split('T')[0]
                        };
                        promises.push(addDoc(collection(db, 'nobetler'), yeniNobet));
                        kopyalananKayitSayisi++;
                    });
                }
                if (kopyalananKayitSayisi === 0) {
                    return showToast('Kaynak aydaki nöbetlerle eşleşen, hedef ayda uygun bir gün bulunamadı.', 'info');
                }
                try {
                    await Promise.all(promises);
                    showToast(`${kopyalananKayitSayisi} nöbet kaydı başarıyla kopyalandı!`, 'success');
                    document.getElementById('rapor-ay-sec').value = destMonth;
                    document.getElementById('rapor-yil-gir').value = destYear;
                    renderNobetRaporu(destYear, destMonth);
                } catch (error) {
                    console.error("Kopyalama sırasında hata:", error);
                    showToast('Nöbetler kopyalanırken bir hata oluştu.', 'error');
                }
            }
            async function openIzinEditModal(izinId) {
                const modal = document.getElementById('edit-izin-modal');
                const form = document.getElementById('edit-izin-form');
                try {
                    const izinDoc = await getDoc(doc(db, 'izinler', izinId));
                    if (!izinDoc.exists()) {
                        showToast('Düzenlenecek izin kaydı bulunamadı.', 'error');
                        return;
                    }
                    const izinData = izinDoc.data();
                    form.querySelector('#edit-izin-id').value = izinId;
                    form.querySelector('#edit-izin-baslangic').value = izinData.baslangicTarihi;
                    form.querySelector('#edit-izin-bitis').value = izinData.bitisTarihi;
                    form.querySelector('#edit-izin-aciklama').value = izinData.aciklama || '';
                    const personelSelect = form.querySelector('#edit-izin-personel');
                    const izinTipiSelect = form.querySelector('#edit-izin-tipi');
                    const personelDoc = await getDoc(doc(db, 'personel', izinData.personelId));
                    personelSelect.innerHTML = `<option>${personelDoc.exists() ? personelDoc.data().ad_soyad : 'Bilinmeyen Personel'}</option>`;
                    const izinTipiSnap = await getSettings('ayarlar_izin_tipleri');
                    izinTipiSelect.innerHTML = '<option value="">İzin Tipi Seçiniz...</option>';
                    izinTipiSnap.forEach(doc => izinTipiSelect.add(new Option(doc.data().name, doc.id)));
                    izinTipiSelect.value = izinData.izinTipiId;
                    modal.classList.add('open');
                } catch (error) {
                    console.error("İzin düzenleme penceresi açılırken hata:", error);
                    showToast('Veriler yüklenirken bir hata oluştu.', 'error');
                }
            }
            let izinTakipInitialized = false;
            async function initializeIzinTakip() {
                if (izinTakipInitialized) return;
                izinTakipInitialized = true;
                const personelSelect = document.getElementById('izin-personel');
                const izinTipiSelect = document.getElementById('izin-tipi');
                const baslangicInput = document.getElementById('izin-baslangic');
                const bitisInput = document.getElementById('izin-bitis');
                const kaydetBtn = document.getElementById('izin-kaydet-btn');
                const tbody = document.getElementById('izin-kayitlari-tbody');
                const izinHakkiDiv = document.getElementById('personel-izin-hakki');
                const hesaplamaSonucuDiv = document.getElementById('izin-hesaplama-sonucu');
                const [personelSnap, izinTipiSnap] = await Promise.all([
                    getDocs(query(collection(db, 'personel'), where("okulId", "==", currentUserOkulId), orderBy('ad_soyad'))),
                    getSettings('ayarlar_izin_tipleri')
                ]);
                const staffListForLeave = personelSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                personelSelect.innerHTML = '<option value="">Personel Seçiniz...</option>';
                staffListForLeave.forEach(p => personelSelect.add(new Option(p.ad_soyad, p.id)));
                izinTipiSelect.innerHTML = '<option value="">İzin Tipi Seçiniz...</option>';
                izinTipiSnap.forEach(doc => izinTipiSelect.add(new Option(doc.data().name, doc.id)));

                function updateIzinHesaplamalari() {
                    const personelId = personelSelect.value;
                    const baslangicTarihi = baslangicInput.value;
                    const bitisTarihi = bitisInput.value;
                    const seciliPersonel = staffListForLeave.find(p => p.id === personelId);
                    if (seciliPersonel) {
                        const hakEdilenGun = calculateYillikIzinHakki(seciliPersonel.ise_giris);
                        izinHakkiDiv.innerHTML = `Personelin yasal izin hakkı: <strong>${hakEdilenGun} iş günü</strong>`;
                    } else {
                        izinHakkiDiv.innerHTML = 'Yasal izin hakkı için personel seçiniz.';
                    }
                    if (baslangicTarihi && bitisTarihi && seciliPersonel) {
                        if (new Date(bitisTarihi) < new Date(baslangicTarihi)) {
                            hesaplamaSonucuDiv.style.color = 'var(--danger-color)';
                            hesaplamaSonucuDiv.innerHTML = 'Bitiş tarihi başlangıçtan önce olamaz!';
                            return;
                        }
                        const netGun = calculateNetIzinSuresi(baslangicTarihi, bitisTarihi, seciliPersonel);
                        hesaplamaSonucuDiv.style.color = '#0056b3';
                        hesaplamaSonucuDiv.innerHTML = `Kullanılacak net izin süresi: <strong>${netGun} iş günü</strong>`;
                    } else {
                        hesaplamaSonucuDiv.innerHTML = 'Net süre için personel ve tarih aralığı seçiniz.';
                    }
                }
                personelSelect.addEventListener('change', updateIzinHesaplamalari);
                baslangicInput.addEventListener('change', updateIzinHesaplamalari);
                bitisInput.addEventListener('change', updateIzinHesaplamalari);
                await renderIzinKayitlari();
                kaydetBtn.addEventListener('click', async () => {
                    const personelId = personelSelect.value;
                    const izinTipiId = izinTipiSelect.value;
                    const baslangicTarihi = baslangicInput.value;
                    const bitisTarihi = bitisInput.value;
                    const aciklama = document.getElementById('izin-aciklama').value.trim();
                    if (!personelId || !izinTipiId || !baslangicTarihi || !bitisTarihi) {
                        return showToast('Lütfen tüm zorunlu alanları doldurun.', 'error');
                    }
                    if (new Date(bitisTarihi) < new Date(baslangicTarihi)) {
                        return showToast('Bitiş tarihi başlangıç tarihinden önce olamaz.', 'error');
                    }
                    await addDoc(collection(db, 'izinler'), {
                        okulId: currentUserOkulId,
                        personelId,
                        izinTipiId,
                        baslangicTarihi,
                        bitisTarihi,
                        aciklama,
                        olusturmaTuru: 'manuel'
                    });
                    showToast('İzin başarıyla kaydedildi.');
                    await renderIzinKayitlari();
                    personelSelect.value = '';
                    izinTipiSelect.value = '';
                    baslangicInput.value = '';
                    bitisInput.value = '';
                    document.getElementById('izin-aciklama').value = '';
                    updateIzinHesaplamalari();
                });
                tbody.addEventListener('click', async (e) => {
                    const target = e.target;
                    if (!target.dataset.id) return;
                    const id = target.dataset.id;
                    if (target.classList.contains('btn-edit-izin')) {
                        openIzinEditModal(id);
                    }
                    if (target.classList.contains('btn-delete-izin')) {
                        if (confirm('Bu izin kaydını kalıcı olarak silmek istediğinizden emin misiniz?')) {
                            try {
                                await deleteDoc(doc(db, 'izinler', id));
                                showToast('İzin kaydı başarıyla silindi.');
                                await renderIzinKayitlari();
                            } catch (err) {
                                showToast('Silme işlemi sırasında bir hata oluştu.', 'error');
                                console.error("İzin silme hatası:", err);
                            }
                        }
                    }
                    if (target.classList.contains('btn-print-dilekce')) {
                        const modal = document.getElementById('dilekce-date-modal');
                        const dateInput = document.getElementById('dilekce-tarih-input');
                        const generateBtn = document.getElementById('generate-dilekce-with-date-btn');
                        const closeModalBtn = modal.querySelector('.close-modal');
                        dateInput.valueAsDate = new Date();
                        generateBtn.dataset.izinId = id;
                        modal.classList.add('open');
                        const handleGenerateClick = async () => {
                            const dilekceTarihi = dateInput.value;
                            const izinIdForDilekce = generateBtn.dataset.izinId;
                            if (!dilekceTarihi) {
                                showToast('Lütfen bir dilekçe tarihi seçin.', 'error');
                                return;
                            }
                            await generateDilekce(izinIdForDilekce, dilekceTarihi);
                            modal.classList.remove('open');
                        };
                        generateBtn.addEventListener('click', handleGenerateClick, {
                            once: true
                        });
                        closeModalBtn.onclick = () => {
                            modal.classList.remove('open');
                            generateBtn.removeEventListener('click', handleGenerateClick);
                        };
                    }
                });
            }
            const editForm = document.getElementById('edit-izin-form');
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = editForm.querySelector('#edit-izin-id').value;
                const updatedData = {
                    izinTipiId: editForm.querySelector('#edit-izin-tipi').value,
                    baslangicTarihi: editForm.querySelector('#edit-izin-baslangic').value,
                    bitisTarihi: editForm.querySelector('#edit-izin-bitis').value,
                    aciklama: editForm.querySelector('#edit-izin-aciklama').value.trim()
                };
                if (!updatedData.izinTipiId || !updatedData.baslangicTarihi || !updatedData.bitisTarihi) {
                    return showToast('Lütfen tüm zorunlu alanları doldurun.', 'error');
                }
                try {
                    const izinRef = doc(db, 'izinler', id);
                    await setDoc(izinRef, updatedData, {
                        merge: true
                    });
                    showToast('İzin kaydı başarıyla güncellendi.');
                    document.getElementById('edit-izin-modal').classList.remove('open');
                    await renderIzinKayitlari();
                } catch (error) {
                    console.error("İzin güncelleme hatası:", error);
                    showToast('Güncelleme sırasında bir hata oluştu.', 'error');
                }
            });
            const editModal = document.getElementById('edit-izin-modal');
            editModal.querySelector('.close-modal').addEventListener('click', () => editModal.classList.remove('open'));
            editModal.addEventListener('click', (e) => {
                if (e.target === editModal) editModal.classList.remove('open');
            });
            async function openTopluIzinModal() {
                const modal = document.getElementById('toplu-izin-modal');
                const personelListContainer = document.getElementById('toplu-personel-listesi');
                const izinTipiSelect = document.getElementById('toplu-izin-tipi');
                personelListContainer.innerHTML = '<p>Personel listesi yükleniyor...</p>';
                izinTipiSelect.innerHTML = '<option value="">Yükleniyor...</option>';
                try {
                    const [personelSnap, izinTipiSnap] = await Promise.all([
                        getDocs(query(collection(db, 'personel'), where("okulId", "==", currentUserOkulId), orderBy('ad_soyad'))),
                        getSettings('ayarlar_izin_tipleri')
                    ]);
                    personelListContainer.innerHTML = '';
                    if (personelSnap.empty) {
                        personelListContainer.innerHTML = '<p>Sistemde kayıtlı personel bulunamadı.</p>';
                    } else {
                        personelSnap.forEach(doc => {
                            const p = doc.data();
                            const personelDiv = document.createElement('div');
                            personelDiv.style.cssText = 'display: flex; align-items: center;';
                            personelDiv.innerHTML = `
                    <input type="checkbox" id="p-check-${doc.id}" value="${doc.id}" style="width:auto; margin-right: 10px; flex-shrink: 0;">
                    <label for="p-check-${doc.id}" style="margin-bottom:0; font-weight: normal; cursor:pointer;">${p.ad_soyad}</label>
                `;
                            personelListContainer.appendChild(personelDiv);
                        });
                    }
                    izinTipiSelect.innerHTML = '<option value="">İzin Tipi Seçiniz...</option>';
                    if (!izinTipiSnap.empty) {
                        izinTipiSnap.forEach(doc => {
                            izinTipiSelect.add(new Option(doc.data().name, doc.id));
                        });
                    }
                    modal.classList.add('open');
                } catch (error) {
                    console.error("Toplu izin modalı hazırlanırken hata:", error);
                    showToast('Gerekli veriler yüklenemedi.', 'error');
                }
            }
            async function saveTopluIzin() {
                const baslangicTarihi = document.getElementById('toplu-izin-baslangic').value;
                const bitisTarihi = document.getElementById('toplu-izin-bitis').value;
                const izinTipiId = document.getElementById('toplu-izin-tipi').value;
                const personelCheckboxes = document.querySelectorAll('#toplu-personel-listesi input[type="checkbox"]:checked');
                if (!baslangicTarihi || !bitisTarihi || !izinTipiId) {
                    return showToast('Lütfen başlangıç/bitiş tarihi ve izin tipi seçin.', 'error');
                }
                if (new Date(bitisTarihi) < new Date(baslangicTarihi)) {
                    return showToast('Bitiş tarihi başlangıç tarihinden önce olamaz.', 'error');
                }
                if (personelCheckboxes.length === 0) {
                    return showToast('Lütfen en az bir personel seçin.', 'error');
                }
                const seciliPersonelIDs = Array.from(personelCheckboxes).map(cb => cb.value);
                showToast(`${seciliPersonelIDs.length} personel için izinler kaydediliyor...`, 'info');
                const promises = seciliPersonelIDs.map(personelId => {
                    const yeniIzin = {
                        okulId: currentUserOkulId,
                        personelId: personelId,
                        izinTipiId: izinTipiId,
                        baslangicTarihi: baslangicTarihi,
                        bitisTarihi: bitisTarihi,
                        aciklama: 'Toplu olarak eklendi.',
                        olusturmaTuru: 'toplu'
                    };
                    return addDoc(collection(db, 'izinler'), yeniIzin);
                });
                try {
                    await Promise.all(promises);
                    showToast(`${seciliPersonelIDs.length} personelin izin kaydı başarıyla oluşturuldu.`, 'success');
                    document.getElementById('toplu-izin-modal').classList.remove('open');
                    await renderIzinKayitlari();
                } catch (error) {
                    console.error("Toplu izinler kaydedilirken hata:", error);
                    showToast('Kayıt sırasında bir hata oluştu.', 'error');
                }
            }

            function calculateYillikIzinHakki(iseGirisTarihi) {
                if (!iseGirisTarihi) return 0;
                const iseGiris = new Date(iseGirisTarihi);
                const bugun = new Date();
                const kidemMs = bugun.getTime() - iseGiris.getTime();
                const kidemYil = kidemMs / (1000 * 60 * 60 * 24 * 365.25);
                if (kidemYil >= 1 && kidemYil < 5) return 14;
                if (kidemYil >= 5 && kidemYil < 15) return 20;
                if (kidemYil >= 15) return 26;
                return 0;
            }

            function calculateNetIzinSuresi(startDateStr, endDateStr, personel, izinTipiKodu) {
                if (!startDateStr || !endDateStr || !personel) return 0;
                const startDate = new Date(startDateStr + 'T00:00:00');
                const endDate = new Date(endDateStr + 'T00:00:00');
                if (endDate < startDate) return 0;
                if (izinTipiKodu === 'R' || izinTipiKodu === 'Üİ') {
                    const diffTime = Math.abs(endDate - startDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    return diffDays;
                } else {
                    let netGunSayisi = 0;
                    let mevcutTarih = new Date(startDate);
                    while (mevcutTarih <= endDate) {
                        const dayOfWeek = mevcutTarih.getDay();
                        let isWeekend = false;
                        if (personel.sozlesme_turu === 'Belirli Süreli') {
                            if (dayOfWeek === 0 || dayOfWeek === 6) isWeekend = true;
                        } else {
                            if (dayOfWeek === 0) isWeekend = true;
                        }
                        if (!isWeekend && !isResmiTatil(mevcutTarih)) {
                            netGunSayisi++;
                        }
                        mevcutTarih.setDate(mevcutTarih.getDate() + 1);
                    }
                    return netGunSayisi;
                }
            }
            async function renderIzinKayitlari() {
                const tbody = document.getElementById('izin-kayitlari-tbody');
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">İzin kayıtları yükleniyor...</td></tr>`;
                const [izinSnap, personelSnap, izinTipiSnap] = await Promise.all([
                    getDocs(query(collection(db, 'izinler'), where("okulId", "==", currentUserOkulId), orderBy('baslangicTarihi', 'desc'))),
                    getDocs(query(collection(db, 'personel'), where("okulId", "==", currentUserOkulId))),
                    getSettings('ayarlar_izin_tipleri')
                ]);
                const izinTipiDataMap = new Map(izinTipiSnap.docs.map(doc => [doc.id, doc.data()]));
                const personelDataMap = new Map(personelSnap.docs.map(doc => [doc.id, {
                    id: doc.id,
                    ...doc.data()
                }]));
                if (izinSnap.empty) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Kayıtlı izin bulunamadı.</td></tr>`;
                    return;
                }
                tbody.innerHTML = '';
                izinSnap.forEach(doc => {
                    const izin = doc.data();
                    const personel = personelDataMap.get(izin.personelId);
                    if (!personel) {
                        console.warn(`ID'si ${doc.id} olan izin kaydına bağlı personel (${izin.personelId}) bulunamadı. Listede gösterilmeyecek.`);
                        return;
                    }
                    const baslangic = new Date(izin.baslangicTarihi + 'T00:00:00');
                    const bitis = new Date(izin.bitisTarihi + 'T00:00:00');
                    const izinTipi = izinTipiDataMap.get(izin.izinTipiId);
                    const izinTipiKodu = izinTipi ? izinTipi.kod : '';
                    const sure = calculateNetIzinSuresi(izin.baslangicTarihi, izin.bitisTarihi, personel, izinTipiKodu);
                    const sureEtiketi = (izinTipiKodu === 'R' || izinTipiKodu === 'Üİ') ? 'gün' : 'iş günü';
                    const row = tbody.insertRow();
                    row.innerHTML = `
            <td>${personel.ad_soyad || 'Bilinmiyor'}</td>
            <td>${izinTipi ? izinTipi.name : 'Bilinmiyor'}</td>
            <td>${baslangic.toLocaleDateString('tr-TR')}</td>
            <td>${bitis.toLocaleDateString('tr-TR')}</td>
            <td>${sure} ${sureEtiketi}</td> <td>${izin.aciklama || '-'}</td>
            <td class="actions-cell">
    <td class="actions-cell">
    <button class="btn btn-print-dilekce" data-id="${doc.id}" style="background-color:#0dcaf0;">Dilekçe</button>
    <button class="btn btn-edit btn-edit-izin" data-id="${doc.id}">Düzenle</button>
    <button class="btn btn-delete-izin btn-delete" data-id="${doc.id}">Sil</button>
</td>
        `;
                });
            }
            async function generateDilekce(izinId, dilekceTarihiStr) {
                const izinDoc = await getDoc(doc(db, 'izinler', izinId));
                if (!izinDoc.exists()) {
                    showToast('İzin kaydı bulunamadı.', 'error');
                    return;
                }
                const izin = izinDoc.data();
                const [personelDoc, izinTipiDoc, gorevSnap] = await Promise.all([
                    getDoc(doc(db, 'personel', izin.personelId)),
                    getDoc(doc(db, 'ayarlar_izin_tipleri', izin.izinTipiId)),
                    getSettings('ayarlar_gorevler')
                ]);
                if (!personelDoc.exists() || !izinTipiDoc.exists()) {
                    showToast('Personel veya İzin Tipi tanımı bulunamadı.', 'error');
                    return;
                }
                const personel = personelDoc.data();
                const izinTipi = izinTipiDoc.data();
                const gorevMap = new Map(gorevSnap.docs.map(doc => [doc.id, doc.data().name]));
                const iseBaslama = new Date(izin.bitisTarihi + 'T00:00:00');
                iseBaslama.setDate(iseBaslama.getDate() + 1);
                const baslangicTR = formatDateDDMMYYYY(izin.baslangicTarihi);
                const bitisTR = formatDateDDMMYYYY(izin.bitisTarihi);
                const iseBaslamaTR = iseBaslama.toLocaleDateString('tr-TR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const iseGirisTR = formatDateDDMMYYYY(personel.ise_giris);
                const dilekceTarihiTR = formatDateDDMMYYYY(dilekceTarihiStr);
                const gorevi = gorevMap.get(personel.gorevi_bransi) || 'Belirtilmemiş';
                const baslangicYili = new Date(izin.baslangicTarihi + 'T00:00:00').getFullYear();
                let izinIstekMetni = `Okulunuzdaki ${baslangicYili} yılına ait yıllık ücretli iznimi, ${baslangicTR} tarihinden itibaren kullanmak istiyorum.`;
                if (!izinTipi.name.toLowerCase().includes('yıllık')) {
                    izinIstekMetni = `${izin.aciklama || 'Mazeretimden'} dolayı ${baslangicTR} - ${bitisTR} tarihleri arasında izinli sayılmamı talep ediyorum.`;
                }
                const dilekceHTML = `
        <!DOCTYPE html><html lang="tr"><head><meta charset="UTF-8"><title>İzin Formu - ${personel.ad_soyad}</title>
        <style>
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 11pt; margin: 1.0cm; line-height: 1.3; }
            h2, .header-section { text-align: center; }
            .info-table, .footer-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
            .info-table td { padding: 8px; border: 1px solid #ccc; }
            .info-table td:first-child { width: 180px; font-weight: bold; background-color: #f2f2f2; }
            .footer-table td { text-align: left; padding: 8px 4px; }
            .footer-table td:nth-child(2) { font-weight: bold; }
            .content { text-indent: 1.5em; margin-bottom: 25px; }
            .date-signature-block { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40px; }
            .date-signature-block { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40px; }
            .approval-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; text-align: center; }
        </style></head><body>
            <div>
                <h2>${izinTipi.name.toLocaleUpperCase('tr-TR')} İSTEK FORMU</h2>
                <div class="header-section"><h3>ÖZEL İSABET ORTAOKULU MÜDÜRLÜĞÜNE</h3></div>
                <p style="text-align:right;">TAVŞANLI</p>
                <table class="info-table">
                    <tr><td>ADI SOYADI</td><td>: ${personel.ad_soyad || ''}</td></tr>
                    <tr><td>T.C. KİMLİK NO</td><td>: ${personel.tc_kimlik_no || ''}</td></tr>
                    <tr><td>SGK NO</td><td>: ${personel.sgk_no || ''}</td></tr>
                    <tr><td>İŞE GİRİŞ TARİHİ</td><td>: ${iseGirisTR}</td></tr>
                    <tr><td>GÖREVİ</td><td>: ${gorevi}</td></tr>
                    <tr><td>GÖREV YERİ ADRESİ</td><td>: Hanımçeşme Mah. Gündüz Sokak No:13 TAVŞANLI/KÜTAHYA</td></tr>
                </table>
                <p class="content">${izinIstekMetni}</p>
                <p>Gereğini arz ederim.</p>
                <div class="date-signature-block">
                    <div><b>Tarih: ${dilekceTarihiTR}</b></div>
                    <div>
                        İzin Talep Eden<br><br>
                        ${personel.ad_soyad}<br>
                        (İmza)
                    </div>
                </div>
                <div class="approval-section">
                    <p>Yukarıda belirtilen tarihlerde ${izinTipi.name.toLowerCase()} kullanması uygundur.</p>
                    <div style="margin-top: 50px;">Okul Müdürü<br>(İmza)</div>
                </div>
                <h4 style="margin-top: 50px; margin-bottom: 15px; border-bottom: 1px solid #000; padding-bottom: 5px;">İzin Bölümünce Doldurulacak</h4>
                <table class="footer-table">
                    <tr>
                        <td>İzine Çıkış Tarihi</td><td>: ${baslangicTR}</td><td>İmza:</td>
                    </tr>
                    <tr>
                        <td>İzin Bitiş Tarihi</td><td>: ${bitisTR}</td><td>İmza:</td>
                    </tr>
                    <tr>
                        <td>İşe Başlama Tarihi</td><td>: ${iseBaslamaTR}</td><td>İmza:</td>
                    </tr>
                </table>
            </div>
        </body></html>`;
                const win = window.open('', '_blank');
                win.document.write(dilekceHTML);
                win.document.close();
                setTimeout(() => win.print(), 500);
            }

        </script>

        <div id="edit-nobet-modal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>Nöbet Kaydını Düzenle</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="edit-nobet-form">
                        <input type="hidden" id="edit-nobet-id">
                        <div class="form-grid" style="grid-template-columns: 1fr 2fr 2fr; align-items: flex-end;">
                            <div class="form-group">
                                <label for="edit-nobet-tarih">Tarih</label>
                                <input type="date" id="edit-nobet-tarih">
                            </div>
                            <div class="form-group">
                                <label for="edit-nobet-personel">Nöbetçi Personel</label>
                                <select id="edit-nobet-personel"></select>
                            </div>
                            <div class="form-group">
                                <label for="edit-nobet-yeri">Nöbet Yeri</label>
                                <select id="edit-nobet-yeri"></select>
                            </div>
                        </div>
                        <div class="button-group" style="margin-top: 20px;">
                            <button type="submit" class="btn btn-save">Değişiklikleri Kaydet</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div id="toplu-izin-modal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3>Toplu İzin Girişi</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p
                        style="margin-top: 0; margin-bottom: 20px; background-color: #eef1f3; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6;">
                        Bu ekranı kullanarak seçili personellere aynı anda, belirtilen tarihler arasında izin
                        atayabilirsiniz. Bu işlem, her bir personel için ayrı bir izin kaydı oluşturacaktır.
                    </p>
                    <div class="form-grid"
                        style="grid-template-columns: 1fr 1fr 2fr; margin-bottom: 20px; align-items: flex-end;">
                        <div class="form-group">
                            <label for="toplu-izin-baslangic">Başlangıç Tarihi</label>
                            <input type="date" id="toplu-izin-baslangic">
                        </div>
                        <div class="form-group">
                            <label for="toplu-izin-bitis">Bitiş Tarihi</label>
                            <input type="date" id="toplu-izin-bitis">
                        </div>
                        <div class="form-group">
                            <label for="toplu-izin-tipi">İzin Tipi</label>
                            <select id="toplu-izin-tipi">
                                <option value="">İzin Tipi Seçiniz...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="margin-bottom: 10px;">İzin Atanacak Personeller</label>
                        <div id="toplu-personel-listesi"
                            style="height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 15px; border-radius: 6px; background: #fdfdfd; display: flex; flex-direction: column; gap: 8px;">
                            <p>Personel listesi yükleniyor...</p>
                        </div>
                    </div>
                    <div class="button-group" style="margin-top: 25px;">
                        <button id="toplu-izin-kaydet-btn" class="btn btn-save">Seçili Personellere İzin Ata</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="dilekce-date-modal" class="modal">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header">
                    <h3>Dilekçe Tarihini Belirtin</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Lütfen dilekçenin üzerinde görünecek resmi tarihi seçiniz.</p>
                    <div class="form-group">
                        <label for="dilekce-tarih-input">Dilekçe Tarihi</label>
                        <input type="date" id="dilekce-tarih-input">
                    </div>
                    <div class="button-group">
                        <button id="generate-dilekce-with-date-btn" class="btn btn-save">Dilekçeyi Oluştur</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="confirmation-modal" class="modal">
            <div class="modal-content" style="max-width: 500px; text-align: center;">
                <div class="modal-header">
                    <h3 id="confirmation-modal-title">İşlemi Onayla</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="confirmation-modal-message" style="font-size: 1.1em; line-height: 1.5;"></p>
                    <div class="confirmation-buttons" style="margin-top: 25px;">
                        <button id="confirm-cancel-btn" class="btn" style="background-color: #6c757d;">İptal</button>
                        <button id="confirm-action-btn" class="btn btn-confirm">Onayla</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="edit-izin-modal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3>İzin Kaydını Düzenle</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="edit-izin-form">
                        <input type="hidden" id="edit-izin-id">
                        <div class="form-grid" style="grid-template-columns: 2fr 1.5fr 1fr 1fr; align-items: flex-end;">
                            <div class="form-group">
                                <label for="edit-izin-personel">Personel</label>
                                <select id="edit-izin-personel" disabled></select>
                            </div>
                            <div class="form-group">
                                <label for="edit-izin-tipi">İzin Tipi</label>
                                <select id="edit-izin-tipi"></select>
                            </div>
                            <div class="form-group">
                                <label for="edit-izin-baslangic">Başlangıç Tarihi</label>
                                <input type="date" id="edit-izin-baslangic">
                            </div>
                            <div class="form-group">
                                <label for="edit-izin-bitis">Bitiş Tarihi</label>
                                <input type="date" id="edit-izin-bitis">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="edit-izin-aciklama">Açıklama / Not</label>
                                <input type="text" id="edit-izin-aciklama" placeholder="İzinle ilgili kısa bir not...">
                            </div>
                        </div>
                        <div class="button-group" style="margin-top: 25px;">
                            <button type="submit" class="btn btn-save">Değişiklikleri Kaydet</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div id="personel-detay-modal" class="modal">
            <div class="modal-content" style="max-width: 1000px;">
                <div class="modal-header">
                    <h3 id="personel-detay-modal-title">Personel Profili</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="settings-tabs" id="personel-detay-tabs">
                        <button class="settings-tab-button active" data-tab="detay-tab-bilgiler">Kişisel
                            Bilgiler</button>
                        <button class="settings-tab-button" data-tab="detay-tab-izinler">İzin Geçmişi</button>
                        <button class="settings-tab-button" data-tab="detay-tab-nobetler">Nöbet Geçmişi</button>
                        <button class="settings-tab-button" data-tab="detay-tab-hizmet">Hizmet Geçmişi</button>
                        <button class="settings-tab-button" data-tab="detay-tab-belgeler">Belgeler</button>
                    </div>

                    <div id="detay-tab-bilgiler" class="settings-tab-content active">
                        <div id="personel-bilgileri-container" style="padding: 20px;">
                            <p>Personel bilgileri yükleniyor...</p>
                        </div>
                    </div>

                    <div id="detay-tab-izinler" class="settings-tab-content">
                        <div id="personel-izin-gecmisi-container" class="table-container"
                            style="margin-top: 20px; max-height: 450px; overflow-y: auto;">
                            <p style="padding: 20px;">İzin geçmişi yükleniyor...</p>
                        </div>
                    </div>

                    <div id="detay-tab-nobetler" class="settings-tab-content">
                        <div id="personel-nobet-gecmisi-container" class="table-container"
                            style="margin-top: 20px; max-height: 450px; overflow-y: auto;">
                            <p style="padding: 20px;">Nöbet geçmişi yükleniyor...</p>
                        </div>
                    </div>

                    <div id="detay-tab-hizmet" class="settings-tab-content">
                    </div>

                    <div id="detay-tab-belgeler" class="settings-tab-content">
                        <p style="padding: 20px; text-align: center; color: #777;">Bu özellik yakında eklenecektir.</p>
                    </div>
                </div>
            </div>
        </div>

        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('service-worker.js').then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
                });
            }
        </script>
</body>

</html>