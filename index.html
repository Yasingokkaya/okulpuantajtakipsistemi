<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okul Puantaj Sistemi</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#192a56"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        :root {
            --theme-primary: #192a56; --theme-accent: #f39c12; --sidebar-bg: var(--theme-primary);
            --sidebar-text: #e0e0e0; --sidebar-hover-bg: #2c3e50; --sidebar-active-bg: var(--theme-accent);
            --light-gray-color: #f4f7f9; --dark-text-color: #2c3e50; --border-color: #dee2e6;
            --white-color: #ffffff; --success-color: #28a745; --danger-color: #dc3545; --info-color: #17a2b8;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--light-gray-color); }
        .app-container { display: flex; height: 100vh; }
        .sidebar {
    width: 230px;
    background-color: var(--sidebar-bg);
    color: var(--sidebar-text);
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    /* EKLENEN YENÄ° KODLAR BAÅLANGICI */
    position: fixed; /* Kenar Ã§ubuÄŸu ekrana sabitler */
    top: 0;
    left: 0;
    height: 100%; /* YÃ¼ksekliÄŸi ekranÄ±n tamamÄ± yapar */
    z-index: 100; /* DiÄŸer elemanlarÄ±n Ã¼zerinde kalmasÄ±nÄ± saÄŸlar */
    /* EKLENEN YENÄ° KODLAR BÄ°TÄ°ÅÄ° */
}
.sidebar nav {
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
    }
    
    .sidebar nav::-webkit-scrollbar {
        width: 8px;
    }
    .sidebar nav::-webkit-scrollbar-track {
        background: transparent;
    }
    .sidebar nav::-webkit-scrollbar-thumb {
        background-color: var(--sidebar-hover-bg);
        border-radius: 10px;
        border: 2px solid var(--sidebar-bg);
    }
    .sidebar nav::-webkit-scrollbar-thumb:hover {
        background-color: var(--theme-accent);
    }
        /* LOGO VE YENÄ° BAÅLIK Ä°Ã‡Ä°N GÃœNCELLENMÄ°Å STÄ°L */
.sidebar-header {
    padding: 15px;
    border-bottom: 1px solid var(--sidebar-hover-bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
}
.sidebar-header img {
    width: 160px; /* Yeni logo iÃ§in daha geniÅŸ bir boyut */
    height: auto; /* Resim oranÄ±nÄ± korur */
    border-radius: 8px; /* KenarlarÄ± hafifÃ§e yuvarlatÄ±r, daha modern bir gÃ¶rÃ¼nÃ¼m iÃ§in (isteÄŸe baÄŸlÄ±) */
}
.sidebar-header span {
    font-size: 1.1em;
    font-weight: bold;
    color: var(--white-color);
}
        .sidebar-nav { list-style: none; padding: 0; margin: 20px 0; }
        .sidebar-nav li a { display: flex; align-items: center; gap: 10px; padding: 15px 20px; color: var(--sidebar-text); text-decoration: none; transition: background-color 0.2s, color 0.2s; border-left: 4px solid transparent; cursor: pointer; }
        .sidebar-nav li a:hover { background-color: var(--sidebar-hover-bg); color: var(--white-color); }
        .sidebar-nav li a.active { background-color: var(--sidebar-active-bg); color: var(--theme-primary); font-weight: bold; }
        .menu-item-group .accordion-trigger { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .menu-item-group .accordion-trigger::after { content: 'â–¶'; font-size: 0.7em; transition: transform 0.2s; }
        .menu-item-group.open > .accordion-trigger::after { transform: rotate(90deg); }
        .sub-menu { list-style: none; padding-left: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; background-color: rgba(0,0,0,0.2); }

.sidebar-footer a {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 20px;
    color: var(--sidebar-text);
    text-decoration: none;
    transition: background-color 0.2s;
}
.sidebar-footer a:hover {
    background-color: var(--danger-color);
    color: var(--white-color);
}
        .menu-item-group.open .sub-menu { max-height: 500px; }
        .sub-menu li a { padding-left: 45px; font-size: 0.95em; }
        .sub-menu li a.active { color: var(--white-color); background-color: transparent; border-left-color: var(--theme-accent); }
.sidebar-footer {
    margin-top: auto; /* Bu sihirli satÄ±r, elemanÄ± en alta iter */
    padding: 10px 0;
    border-top: 1px solid var(--sidebar-hover-bg);
    flex-shrink: 0;
}
.sidebar-footer a {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 20px;
    color: var(--sidebar-text);
    text-decoration: none;
    transition: background-color 0.2s;
}
.sidebar-footer a:hover {
    background-color: var(--danger-color);
    color: var(--white-color);
}
.sidebar-footer a {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 20px;
    color: var(--sidebar-text);
    text-decoration: none;
    transition: background-color 0.2s;
}
.sidebar-footer a:hover {
    background-color: var(--danger-color);
    color: var(--white-color);
}
        .main-content { flex-grow: 1; overflow-y: auto; padding: 25px; margin-left: 230px; /* Kenar menÃ¼ geniÅŸliÄŸi kadar soldan boÅŸluk */ }
        .module { display: none; }
        .module.active { display: block; }
        .panel { background-color: var(--white-color); border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .panel-header { padding: 18px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .panel-header h3 { margin: 0; font-size: 1.2em; color: var(--dark-text-color); }
        .panel-body { padding: 25px; }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(44, 62, 80, 0.85); /* <-- GÃœNCELLENDÄ° */
            -webkit-backdrop-filter: blur(4px); /* <-- YENÄ° EKLENDÄ° */
            backdrop-filter: blur(4px); /* <-- YENÄ° EKLENDÄ° */
            justify-content: center; 
            align-items: center; 
        }
        .modal.open { display: flex; }
        .modal-content { background-color: var(--light-gray-color); border-radius: 10px; width: 90%; max-width: 900px; max-height: 95vh; display: flex; flex-direction: column; animation: fadeIn 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 25px; border-bottom: 1px solid var(--border-color); background-color: var(--white-color); border-top-left-radius: 10px; border-top-right-radius: 10px; }
        .modal-header h3 { margin: 0; font-size: 1.2em; color: var(--theme-primary); }
        .close-modal { font-size: 1.8rem; font-weight: bold; color: #aaa; background: none; border: none; cursor: pointer; }
        .modal-body { padding: 25px; overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px 25px; }
        #gorevlendirme .form-container .form-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid var(--border-color); }
        .full-width { grid-column: 1 / -1; }
        .button-group { text-align: right; margin-top: 15px; }
.izin-hesaplama-alani {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        #personel-izin-hakki, #izin-hesaplama-sonucu {
            flex: 1;
            padding: 12px;
            background-color: #eef1f3;
            border-radius: 6px;
            border: 1px solid #d8dde2;
            font-size: 14px;
            color: #37474f;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #izin-hesaplama-sonucu {
            font-weight: bold;
            background-color: #e6f7ff;
            border-color: #b3e0ff;
            color: #0056b3;
        }
        .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--white-color); }
        td.actions-cell { width: auto; min-width: 160px; display: flex; gap: 8px; align-items: center; }
        .actions-cell .btn { flex: 1; }
        .btn-edit { background-color: var(--info-color); }
        .btn-delete { background-color: var(--danger-color); }
        .btn-save { padding: 12px 30px; background-color: var(--theme-accent); }
        .btn-header-add { background-color: var(--theme-accent); color: var(--white-color); font-weight: bold; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; transition: opacity 0.2s; }
        table.staff-table { width: 100%; border-collapse: collapse; }
        table.staff-table th, table.staff-table td { padding: 12px 15px; border: 1px solid var(--border-color); text-align: left; vertical-align: middle; }
        table.staff-table th { background-color: var(--light-gray-color); font-weight: 600; color: var(--dark-text-color); }
        .radio-group { display: flex; align-items: center; gap: 25px; padding-top: 5px; }
        .radio-group div { display: flex; align-items: center; gap: 8px; }
        .radio-group label { font-weight: normal; margin-bottom: 0; }
        .radio-group input { width: auto; margin-right: 0; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 20px; color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateX(100%); animation: slideIn 0.3s forwards; }
        .toast.success { background-color: var(--success-color); }
.toast.error { background-color: var(--danger-color); }

/* YENÄ° EKLENEN BÄ°LGÄ° UYARISI STÄ°LÄ° */
.toast.info { background-color: var(--info-color); }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } } @keyframes slideOut { to { opacity: 0; transform: translateX(100%); } }
        .settings-tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .settings-tab-button { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; border-bottom: 3px solid transparent; }
        .settings-tab-button.active { color: var(--theme-primary); border-bottom-color: var(--theme-primary); font-weight: 600; }
        .settings-tab-content { display: none; }
        .settings-tab-content.active { display: block; animation: fadeIn 0.5s; }
        .settings-list { list-style: none; padding: 0; margin-top: 20px; max-height: 250px; overflow-y: auto; }
        .settings-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; }
        .settings-list .btn-delete-setting { background-color: var(--danger-color); font-size: 12px; padding: 5px 10px; }
        .add-setting-form { display: flex; gap: 10px; align-items: flex-end; }
        .add-setting-form input, .add-setting-form select { margin-bottom: 0; }
        .add-setting-form button { flex-shrink: 0; height: 46px; background-color: var(--success-color); }
        .tab-container { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-link { padding: 12px 25px; cursor: pointer; border: none; background-color: transparent; font-size: 18px; font-weight: 500; color: #606770; border-bottom: 3px solid transparent; }
        .tab-link.active { color: #1877f2; border-bottom: 3px solid #1877f2; }
        .form-container { display: flex; justify-content: center; align-items: flex-end; gap: 15px; margin-bottom: 30px; padding: 20px; background-color: #f7f8fa; border: 1px solid #ddd; border-radius: 8px; flex-wrap: wrap; }
        #ekleBtn { padding: 10px 20px; background-color: #42b72a; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; height: 46px; }
        .schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .schedule-table th, .schedule-table td { border: 1px solid #e9ebee; padding: 6px; text-align: center; height: 75px; vertical-align: top; }
        .ders-karti { background-color: #1877f2; color: white; padding: 6px; border-radius: 6px; font-size: 13px; height: calc(100% - 12px); box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .detail-entry {
    display: grid;
    /* ÃœÃ§Ã¼ncÃ¼ sÃ¼tunu da esnek (1fr) yaparak alanlarÄ± eÅŸitliyoruz */
    grid-template-columns: 1fr 1fr 1fr auto;
    gap: 15px;
    align-items: flex-end;
    margin-top: 15px;
}
        #edit-g-detay-ekle-btn { background-color: var(--success-color); }


#gecici-detay-listesi { 
    list-style: none; 
    padding: 0; 
    margin-top: 15px; 
}
        #g-detay-ekle-btn { background-color: #28a745; }
        #gecici-detay-listesi { list-style: none; padding: 0; margin-top: 15px; }
        #gecici-detay-listesi li { display: flex; justify-content: space-between; align-items: center; background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 8px; }
        .delete-temp-btn { background: none; border: none; color: var(--danger-color); cursor: pointer; font-weight: bold; }
        .table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-top: 20px;}
        .gorevlendirme-table { width: 100%; border-collapse: collapse; }
        .gorevlendirme-table thead th { background-color: #343a40; color: white; font-weight: 600; padding: 12px; text-align: left; }
        .gorevlendirme-table tbody td { border-top: 1px solid var(--border-color); padding: 12px; vertical-align: middle; }
        .gorevlendirme-table tbody tr:hover { background-color: #f1f9ff; }
        .gorevlendirme-table .ders-detaylari { list-style-type: square; margin: 0; padding-left: 20px; }
        #nobet-rapor-tbody .btn-delete-nobet, #izin-kayitlari-tbody .btn-delete-izin { background-color: var(--danger-color); padding: 5px 10px; font-size: 12px; }
        .gorevlendirme-table tbody tr.renk-a {
        background-color: #fdfdfe; /* Ã‡ok aÃ§Ä±k bir gri tonu */
}
       .gorevlendirme-table tbody tr.renk-b {
       background-color: #f0f3f5; /* Biraz daha belirgin bir gri tonu */
}
      .gorevlendirme-table tbody tr.renk-a:hover,
      .gorevlendirme-table tbody tr.renk-b:hover {
      background-color: #e6f7ff; /* Fare ile Ã¼zerine gelindiÄŸindeki renk */
}
        .puantaj .controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 25px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; }
        .puantaj .controls-left, .puantaj .controls-right { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .puantaj .controls button, .puantaj .export-buttons button { padding: 10px 15px; border-radius: 6px; border: 1px solid #ced4da; font-size: 14px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        #btn-generate { background-color: #0056b3; color: white; }
        .puantaj .export-buttons button { background-color: #6c757d; color: white; }
        .puantaj .export-buttons button:hover, #btn-generate:hover { opacity: 0.85; }
        .puantaj-table { width: 100%; border-collapse: collapse; table-layout: auto; }
        .puantaj-table th, .puantaj-table td { border: 1px solid #dee2e6; padding: 8px; text-align: center; font-size: 12px; vertical-align: middle; min-width: 40px; }
        .puantaj-table thead th { background-color: #343a40; color: white; font-weight: 600; padding: 10px 8px; position: sticky; top: 0; z-index: 2; font-size: 13px; }
        .puantaj-table tbody tr:hover > td { background-color: #f1f9ff; }
        .header-main-title { background-color: #495057 !important; }
        .col-personel { min-width: 200px; text-align: left; padding-left: 10px; position: sticky; left: 0; background-color: #fff; z-index: 1; }
        .puantaj-table tbody tr:hover .col-personel { background-color: #f1f9ff; }
        .col-unvan { min-width: 130px; } .col-day { min-width: 45px; } 

/* === PUANTAJ TABLOSU Ä°Ã‡Ä°N HÄ°ZALAMA VE Ã‡Ä°ZGÄ° EKLENMÄ°Å GÃœNCEL STÄ°L BLOÄU === */

/* Genel tablo ayarlarÄ± */
.puantaj-table {
    width: 100%;
    border-collapse: collapse;
}
.puantaj-table th, .puantaj-table td {
    border: 1px solid #dee2e6;
    text-align: center; /* TÃ¼m hÃ¼creleri yatayda ortala */
    vertical-align: middle; /* TÃ¼m hÃ¼creleri dikeyde ortala */
    font-size: 12px;
}

/* Tablo BaÅŸlÄ±klarÄ± */
.puantaj-table thead th {
    background-color: #343a40 !important;
    color: white;
    font-weight: 600;
    padding: 10px 5px;
    position: sticky;
    top: 0;
    z-index: 2;
    font-size: 13px;
}

/* GÃœNCELLEME: Personel ve Unvan sÃ¼tunlarÄ± da merkeze hizalandÄ± */
.puantaj-table .col-personel, .puantaj-table .col-unvan {
    min-width: 130px;
    font-weight: 500;
    line-height: 1.4;
    padding: 5px; /* Hizalama iÃ§in padding ayarlandÄ± */
}
.puantaj-table .col-personel {
    position: sticky;
    left: 0;
    background-color: #fff;
    z-index: 1;
}

/* Her personel satÄ±rÄ±nÄ±n altÄ±nÄ± belirginleÅŸtirme */
.personel-row-hours {
    border-bottom: 2px solid #adb5bd;
}

/* ================================================= */
        /* === YENÄ° Ã‡Ä°ZÄ°MÄ°NÄ°ZE GÃ–RE GÃœNCELLENMÄ°Å STÄ°LLER === */
        /* ================================================= */
        
        /* Dikey ayÄ±rÄ±cÄ± Ã§izginin stilini tanÄ±mlar */
        .vertical-divider {
            border-right: 2px solid #555;
        }

        /* Her personelin altÄ±nÄ± ayÄ±ran yatay Ã§izgiyi tanÄ±mlar */
        .horizontal-divider > td {
            border-bottom: 2px solid #333;
        }

        @media print {
            .vertical-divider {
                border-right: 2px solid #000 !important;
            }
            .horizontal-divider > td {
                border-bottom: 2px solid #000 !important;
            }
        }
        
    
        @media print {
            /* YazdÄ±rÄ±rken yatay Ã§izginin siyah ve belirgin olmasÄ±nÄ± saÄŸlar */
            .puantaj-table .personel-row-status > td {
                border-bottom: 1.5px solid #000 !important;
            }

            /* YazdÄ±rÄ±rken dikey Ã§izginin siyah ve belirgin olmasÄ±nÄ± saÄŸlar */
            .puantaj-table .week-divider {
                border-right: 1.5px solid #000 !important;
            }
        }

/* Ãœzerine gelince her iki satÄ±rÄ±n da rengini deÄŸiÅŸtirme */
.puantaj-table tbody tr:hover > td {
    background-color: #f1f9ff !important;
}

/* Durum Kodu HÃ¼cresi */
.puantaj-table .status-cell {
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    height: 32px;
    /* YENÄ°: Durum ve saat satÄ±rlarÄ± arasÄ±na ayÄ±rÄ±cÄ± Ã§izgi eklendi */
    border-bottom: 1px dashed #b0bec5;
}

/* Saat HÃ¼cresi */
.puantaj-table .hour-cell {
    font-size: 13px;
    color: #192a56;
    font-weight: 500;
    height: 32px;
}

.status-N {
    background-color: #E8F5E9; /* Ã‡ok AÃ§Ä±k YeÅŸil */
    color: #1B5E20;      /* Koyu YeÅŸil YazÄ± Rengi */
}
        

        /* YENÄ° EKLENEN KOD BÄ°TÄ°ÅÄ° */

/* Ã–zet SÃ¼tunlarÄ± Arka Plan Renkleri */
.puantaj-table .summary-yellow { background-color: #FFECB3; font-weight: bold; }
.puantaj-table .summary-green { background-color: #C8E6C9; font-weight: bold; }
.puantaj-table .summary-nobet { background-color: #FFE0B2; font-weight: bold;}
.puantaj-table .summary-rehberlik { background-color: #C5CAE9; font-weight: bold;}
/* Fazla Mesai sÃ¼tunu iÃ§in yeni stil */

.puantaj-table .summary-overtime { 
    background-color: #FFCDD2; /* AÃ§Ä±k KÄ±rmÄ±zÄ± */
    font-weight: bold; 
}



/* Fazla Mesai Nedeni sÃ¼tunu iÃ§in yeni stil */
.puantaj-table .summary-reason {
    background-color: #D2B4DE; /* AÃ§Ä±k Leylak */
    font-weight: bold;
}

/* Eksik GÃ¼n Kodu sÃ¼tunu iÃ§in yeni stil */
.puantaj-table .summary-missing-day {
    background-color: #AED6F1; /* AÃ§Ä±k GÃ¶k Mavisi */
    font-weight: bold;
}


.puantaj-table .col-summary-count,
.puantaj-table .social-section,
.puantaj-table .total-worked-day {
    background-color: #E3F2FD !important;
    font-weight: 500;
}
.puantaj-table .total-worked-day {
    font-weight: bold;
}

        /* Var olan kuralÄ± gÃ¼ncelleme */
        .puantaj-table tbody tr:hover > td, 
        .puantaj-table tbody tr:hover + .personel-row-hours > td {
             background-color: #f1f9ff;
        }
        .status-Ä° {
    background-color: #E6E6FA; /* AÃ§Ä±k Lavanta */
    color: #483D8B;      /* Koyu Eflatun YazÄ± Rengi */
}
.status-ÃœÄ° {
    background-color: #EAECEE; /* AÃ§Ä±k NÃ¶tr Gri */
    color: #566573;      /* Koyu Gri YazÄ± Rengi */
}
        .status-K { background-color: #D7F9E9; color: #1B5E20; } /* YarÄ±m GÃ¼n (Tam zamanlÄ± iÃ§in) */
        .status-R { background-color: #FFEBEE; color: #B71C1C; } .status-UI { background-color: #E4E7EB; color: #37474f; }
        .status-S { background-color: #FFF9C4; color: #AF6000; } /* YÄ±llÄ±k Ä°zin */
        .status-Y { background-color: #D7F9E9; color: #1B5E20; } /* YarÄ±m GÃ¼n (Eski K'nÄ±n yeni adÄ±) */
        .status-E { background-color: #EEEEEE; color: #424242; font-weight: normal; } /* Eksik GÃ¼n */
         .status-RT { 
    background-color: #D1EAFE; /* AÃ§Ä±k Mavi */
    color: #0D47A1;      /* Koyu Mavi YazÄ± */
}
        .status-RTÃ‡ { background-color: #E1BEE7; color: #4A148C; } /* Resmi Tatil Ã‡alÄ±ÅŸmasÄ± */
        .status-HT { background-color: #FFEBCC; color: #B85B00; } /* Hafta Sonu */
        .puantaj-legend { margin-top: 25px; padding-top: 15px; border-top: 1px solid #dee2e6; display: flex; flex-wrap: wrap; gap: 15px 25px; justify-content: center; }
        .legend-item { display: flex; align-items: center; font-size: 13px; }
        .legend-color-box { width: 16px; height: 16px; border: 1px solid #bdbdbd; margin-right: 8px; display: inline-block; }
        .bottom-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; flex-wrap: wrap; }
        .summary-totals, .approval-section { flex: 0 1 400px; /* Kutunun esnememesini ve maksimum 400px geniÅŸliÄŸinde olmasÄ±nÄ± saÄŸlar */ }
        .summary-totals h3, .approval-section h3 { margin-top: 0; color: #495057; }
        .total-line { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f1f1f1; font-size: 15px; }
        .total-line .label { font-weight: 500; } .total-line .value { font-weight: 700; }
        .approval-section { text-align: center; } .approval-section .name { margin-top: 40px; font-weight: 600; }
        #edit-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 10; display: none; }
        #edit-modal-overlay .modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 10px; z-index: 11; width: 350px; }
        #edit-modal-overlay .modal-buttons { text-align: right; margin-top: 20px; }
        #edit-modal-overlay .modal-buttons button { padding: 8px 16px; border-radius: 5px; border: none; cursor: pointer; margin-left: 10px; }
        #modal-save { background-color: #198754; color: white; }
        #modal-cancel { background-color: #6c757d; color: white; }
     
@media print {
    /* ------------------------------------------------------------- */
    /* 1. GENEL YAZDIRMA AYARLARI                                    */
    /* ------------------------------------------------------------- */
    @page {
        margin: 1cm; /* Sayfa kenar boÅŸluklarÄ± */
    }

    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    body, html {
        background-color: #fff !important;
        font-size: 10pt; /* VarsayÄ±lan okunaklÄ± font boyutu */
        overflow: visible !important;
    }

    .main-content {
        padding: 0 !important;
        overflow: visible !important;
        margin-left: 0 !important;
    }

  /* Ãœst barÄ± gizlemek iÃ§in .mobile-header eklendi */
.sidebar, .mobile-header, .panel-header, .controls.puantaj, .no-print,
.modal-overlay, #add-staff-modal, #logout-btn, #btn-nobet-yazdir,
#gorevlendirme .gorevlendirme-form-area {
    display: none !important;
}

    /* ------------------------------------------------------------- */
    /* 2. PUANTAJ CETVELÄ° YAZDIRMA AYARLARI                          */
    /* ------------------------------------------------------------- */
    #puantaj, #puantaj .panel, #puantaj-table-container { 
        box-shadow: none !important; 
        border: none !important; 
        padding: 0 !important; 
        margin: 0 !important;
        overflow: visible !important;
    }

    .puantaj-table {
        width: 100% !important;
        border-collapse: collapse !important;
    }
    
    .puantaj-table th, .puantaj-table td {
        border: 1px solid #999 !important; /* Ã‡izgiler daha gÃ¶rÃ¼nÃ¼r yapÄ±ldÄ± */
        padding: 4px 2px !important; /* HÃ¼cre iÃ§i boÅŸluklar ayarlandÄ± */
        text-align: center !important;
        vertical-align: middle !important;
    }


    /* Ä°STEK 1: SÃ¼tun baÅŸlÄ±klarÄ± artÄ±k alta kayacak */
    .puantaj-table thead th {
        font-size: 8pt !important;
        font-weight: bold !important;
        white-space: normal !important; /* Bu kural uzun baÅŸlÄ±klarÄ±n alta kaymasÄ±nÄ± saÄŸlar */
        vertical-align: bottom !important; /* Alta kayan yazÄ±larÄ± aÅŸaÄŸÄ±ya hizalar */
        padding-bottom: 6px !important;
    }
    
    .puantaj-table .col-personel, .puantaj-table .col-unvan {
    font-size: 9pt !important;
    text-align: left !important;
    padding-left: 5px !important;
    white-space: normal !important; /* Uzun isimlerin ve unvanlarÄ±n alta kaymasÄ±nÄ± saÄŸlar */
    vertical-align: middle !important;
}

/* Personel adÄ± sÃ¼tunu iÃ§in minimum geniÅŸlik ayarÄ± (DARALTILDI) */
.puantaj-table .col-personel {
    min-width: 90px !important;
}

/* Unvan sÃ¼tunu iÃ§in minimum geniÅŸlik ayarÄ± (DARALTILDI) */
.puantaj-table .col-unvan {
    min-width: 80px !important;
}

    /* Ä°STEK 2: Saat sayÄ±larÄ± bÃ¼yÃ¼tÃ¼ldÃ¼ ve kalÄ±n yapÄ±ldÄ± */
    .puantaj-table .hour-cell {
        font-size: 9pt !important;
        font-weight: bold !important;
        color: #000 !important;
    }
    
    /* Okunabilirlik iÃ§in puantaj kodlarÄ± (N, R, I) da bÃ¼yÃ¼tÃ¼ldÃ¼ */
    .puantaj-table .status-cell {
        font-size: 10pt !important;
        font-weight: bold !important;
    }


    /* ------------------------------------------------------------- */
    /* 3. DÄ°ÄER MODÃœLLERÄ°N YAZDIRMA AYARLARI (KORUNUYOR)            */
    /* ------------------------------------------------------------- */
    .gorevlendirme-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 9pt;
    }
    .gorevlendirme-table th, .gorevlendirme-table td {
        border: 1px solid #666;
        padding: 8px;
        text-align: left;
    }
    .gorevlendirme-table th {
        background-color: #f0f0f0;
        font-weight: bold;
    }
/* YAZDIRMA Ä°Ã‡Ä°N YENÄ° EKLENEN BAÅLIK STÄ°LÄ° */
            #puantaj-baslik {
                display: block !important; /* BaÅŸlÄ±ÄŸÄ±n her zaman gÃ¶rÃ¼nÃ¼r olmasÄ±nÄ± saÄŸlar */
                text-align: center !important; /* BaÅŸlÄ±ÄŸÄ± ortalar */
                font-size: 14pt !important; /* YazdÄ±rma iÃ§in okunaklÄ± bir boyut */
                font-weight: bold;
                margin-top: 20px; /* SayfanÄ±n Ã¼stÃ¼nden boÅŸluk bÄ±rakÄ±r */
                margin-bottom: 25px !important; /* Tablo ile arasÄ±na boÅŸluk koyar */
                color: black !important; /* YazÄ±cÄ±da her zaman siyah gÃ¶rÃ¼nmesini saÄŸlar */
            }
}
/* EKLENECEK KOD BÄ°TÄ°ÅÄ° */
        
        @media print {
            body, html {
                background-color: #fff;
                overflow: visible;
                height: auto;
            }
            .sidebar, .panel-header, .form-container, #btn-nobet-yazdir {
                display: none !important;
            }
            .main-content {
                padding: 0;
                overflow: visible;
            }
            .module {
                display: none !important;
            }
            .module.active {
                display: block !important;
            }
            .panel {
                box-shadow: none;
                border: none;
            }
            #nobet-rapor-alani {
                display: block !important;
            }
            .table-container {
                overflow: visible;
                border: none;
            }
            .no-print {
                display: none !important;
            }
        }
.ders-karti {
    position: relative; /* Silme butonu iÃ§in konumlandÄ±rma */
}
.delete-lesson-btn {
    position: absolute;
    top: -2px;
    right: 2px;
    background: rgba(0,0,0,0.4);
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    padding: 0;
}
.delete-lesson-btn:hover {
    background: var(--danger-color);
}
.mobile-header {
    display: none; /* VarsayÄ±lan olarak (masaÃ¼stÃ¼nde) gizli */
    background-color: var(--theme-primary);
    color: var(--white-color);
    padding: 10px 15px;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 101; /* Kenar menÃ¼sÃ¼nÃ¼n Ã¼zerinde kalmasÄ± iÃ§in */
}

#hamburger-btn {
    background: none;
    border: none;
    color: var(--white-color);
    font-size: 28px;
    cursor: pointer;
    padding: 0 15px 0 0;
}

.mobile-title {
    font-size: 1.1em;
    font-weight: bold;
}
/* === MOBÄ°L LOGO Ä°Ã‡Ä°N YENÄ° EKLENEN STÄ°L === */
.mobile-logo {
    height: 35px; /* Mobil Ã¼st bar iÃ§in uygun bir yÃ¼kseklik */
    width: auto;
    margin-right: 15px; /* YazÄ± ile arasÄ±na boÅŸluk koyar */
}



/* === GÃœNCELLENMÄ°Å MOBÄ°L GÃ–RÃœNÃœM KURALLARI === */

@media (max-width: 768px) {
.sidebar-header {
    display: none;
}
    /* KaydÄ±rma sorununu Ã§Ã¶zen kural */
    html, body {
        height: auto; 
        overflow-x: hidden; 
    }

    /* Hamburger menÃ¼ iÃ§in Ã¼st baÅŸlÄ±ÄŸÄ± gÃ¶steren kural */
    .mobile-header {
        display: flex;
    }

    .app-container {
        flex-direction: column;
        height: auto; 
    }

    /* Kenar menÃ¼sÃ¼nÃ¼ gizleyen ve aÃ§Ä±lÄ±r hale getiren kurallar */
    .sidebar {
        position: fixed; 
        left: -250px; 
        top: 0;
        height: 100vh; 
        width: 250px; 
        z-index: 100;
        transition: left 0.3s ease-in-out; 
        border-right: 1px solid var(--sidebar-hover-bg);
    }
    
    .sidebar.open {
        left: 0; /* MenÃ¼yÃ¼ gÃ¶rÃ¼nÃ¼r yapar */
    }

    .main-content {
        margin-left: 0; 
        width: 100%;
        padding: 15px;
    }
    
    /* DiÄŸer mobil kurallarÄ±nÄ±z */
    #gorevlendirme .form-container .form-grid,
    #gorevlendirme .gorevlendirme-layout,
    .form-grid {
        grid-template-columns: 1fr;
    }

    .puantaj .controls {
        flex-direction: column;
        align-items: stretch;
    }

    .puantaj .controls-left, .puantaj .controls-right {
        flex-direction: column;
        width: 100%;
    }
    .puantaj .controls button, .puantaj .export-buttons button {
        width: 100%;
    }
}

.overtime-reason-input {
    width: 95%;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 4px;
    box-sizing: border-box;
}
/* ================================================= */
/* EKSÄ°K GÃœN KODU SEÃ‡Ä°M KUTUSU Ä°Ã‡Ä°N DÃœZELTME         */
/* ================================================= */
.missing-day-code-select {
    padding: 6px 4px; /* Ä°Ã§ boÅŸluk azaltÄ±ldÄ± */
    font-size: 13px;  /* YazÄ± boyutu ayarlandÄ± */
    font-weight: bold;
    color: var(--theme-primary); /* YazÄ± rengi belirginleÅŸtirildi */
 /* SeÃ§im kutusu iÃ§in Ã¶zel hizalama sÄ±nÄ±flarÄ± */
.text-align-left {
    text-align: left !important;
}
.text-align-center {
    text-align: center !important;
}
    width: 70px; /* GeniÅŸlik sabitlendi */
    -webkit-appearance: none; /* TarayÄ±cÄ± varsayÄ±lan stillerini sÄ±fÄ±rlama */
    -moz-appearance: none;
    appearance: none;
    /* Ã–zel ok ikonu ekleme */
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 5px center;
    background-size: 1em;
}
/* ================================================= */
/* RENK PALETÄ° HÃœCRE GÃ–RÃœNÃœM DÃœZELTMESÄ°              */
/* ================================================= */

/* Renkli hÃ¼crelerin iÃ§indeki metin ve seÃ§im kutularÄ±nÄ±n arka planÄ±nÄ± ÅŸeffaf yapar */
td[style*="background-color"] .overtime-reason-input,
td[style*="background-color"] .missing-day-code-select {
    background-color: transparent;
    border: 1px solid rgba(0, 0, 0, 0.25); /* Renk Ã¼zerindeyken hafif bir kenarlÄ±k */
}

/* Renk seÃ§icinin etrafÄ±ndaki sarmalayÄ±cÄ±ya daha iyi bir gÃ¶rÃ¼nÃ¼m verir */
td[style*="background-color"] .input-wrapper {
    background-color: rgba(255, 255, 255, 0.2); /* Rengi biraz aÃ§ar */
    border-radius: 5px;
}

/* ======================= BUNU <style> Ä°Ã‡Ä°NE EKLEYÄ°N ======================= */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}
.card-icon {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
}
.card-content {
    flex-grow: 1;
}
.card-title {
    font-size: 1em;
    font-weight: 600;
    color: #555;
    margin: 0 0 5px 0;
}
.card-value {
    font-size: 2.2em;
    font-weight: bold;
    color: var(--theme-primary);
    line-height: 1;
}
.card-description {
    font-size: 0.85em;
    color: #777;
}
/* =================== YERÄ°NE BUNLARI EKLEYÄ°N ================== */
.dashboard-card {
    background-color: var(--white-color);
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    display: flex;
    align-items: center;
    padding: 20px;
    gap: 20px;
    transition: transform 0.2s, box-shadow 0.2s;
    min-height: 125px; /* TÃ¼m kartlarÄ±n minimum yÃ¼ksekliÄŸini eÅŸitler */
}
.card-list {
    font-size: 0.9em;
    color: #333;
    max-height: 60px; /* Kart yÃ¼ksekliÄŸine uygun max-height */
    overflow-y: auto; /* TaÅŸma durumunda dikey scrollbar ekler */
    width: 100%;
    padding-right: 5px; /* KaydÄ±rma Ã§ubuÄŸu iÃ§in boÅŸluk */
}
/* ============================================================= */
.card-list span {
    display: block;
    padding: 2px 0;
}
.card-list .no-data {
    color: #888;
    font-style: italic;
}
.quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}
.quick-action-btn {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 12px 20px;
    border-radius: 8px;
    text-decoration: none;
    color: var(--dark-text-color);
    font-weight: 600;
    transition: all 0.2s;
    cursor: pointer;
}
.quick-action-btn:hover {
    background-color: #e9ecef;
    border-color: #ced4da;
    color: var(--theme-primary);
}
/* ========================================================================= */
</style>
</head>
<body>
<header class="mobile-header">
        <button id="hamburger-btn">â˜°</button>
        <img src="logo.png" alt="Okul Logosu" class="mobile-logo">
        <span class="mobile-title">Okul Puantaj Sistemi</span>
    </header>
<div id="login-panel" style="display: none; justify-content: center; align-items: center; height: 100vh; background-color: var(--light-gray-color);">
    <div style="width: 100%; max-width: 400px; padding: 40px; background: var(--white-color); border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <h2 style="text-align: center; color: var(--theme-primary); margin-bottom: 30px;">Okul Puantaj Sistemi GiriÅŸ Paneli</h2>
        <div class="form-group">
            <label for="login-email">E-posta Adresi</label>
            <input type="email" id="login-email" placeholder="ornek@mail.com">
        </div>
        <div class="form-group">
            <label for="login-password">Åifre</label>
            <input type="password" id="login-password">
        </div>
        <p id="login-error" style="color: var(--danger-color); text-align: center; display: none;"></p>
        <button id="login-btn" class="btn btn-save" style="width: 100%; padding: 15px; font-size: 16px;">GiriÅŸ Yap</button>
    </div>
</div>
    <div id="toast-container"></div>
    <div class="app-container" style="display: none;">


        <aside class="sidebar">
    <div class="sidebar-header">
    <img src="logo.png" alt="Okul Puantaj Sistemi Logosu">
</div>

    <nav>
        <ul class="sidebar-nav">
            <li><a class="nav-link active" data-target="dashboard">ğŸ  <span>Ana Sayfa</span></a></li>
            <li class="menu-item-group">
                <a class="accordion-trigger">ğŸ‘¥ <span>Personel YÃ¶netimi</span></a>
                <ul class="sub-menu">
                    <li><a id="open-add-staff-modal"><span>Yeni Personel Ekle</span></a></li>
                    <li><a class="nav-link" data-target="staff-list"><span>Personel Listesi</span></a></li>
                </ul>
            </li>
            <li><a class="nav-link" data-target="ders-programi">ğŸ“… <span>Ders ProgramÄ±</span></a></li>
            <li><a class="nav-link" data-target="gorevlendirme">ğŸ“ <span>GÃ¶revlendirmeler</span></a></li>
            <li><a class="nav-link" data-target="nobet-takip">ğŸ›¡ï¸ <span>NÃ¶bet Takip</span></a></li>
            <li><a class="nav-link" data-target="izin-takip">âœˆï¸ <span>Ä°zin Takip</span></a></li>
            <li><a class="nav-link" data-target="puantaj">ğŸ“Š <span>Puantaj Cetveli</span></a></li>
            <li><a class="nav-link" data-target="settings">âš™ï¸ <span>Ayarlar</span></a></li>
        </ul>
    </nav>

    <div class="sidebar-footer">
        <a id="logout-btn" style="cursor: pointer;">ğŸšª <span>Ã‡Ä±kÄ±ÅŸ Yap</span></a>
    </div>
</aside>
                    

        <main class="main-content">
            <div id="dashboard" class="module active">
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <div class="card-icon" style="background-color: #e6f7ff; color: #0056b3;">ğŸ‘¥</div>
            <div class="card-content">
                <div class="card-title">Aktif Personel</div>
                <div class="card-value" id="db-aktif-personel">YÃ¼kleniyor...</div>
                <div class="card-description">Sistemde kayÄ±tlÄ± toplam personel</div>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="card-icon" style="background-color: #fffbe6; color: #f39c12;">ğŸ›¡ï¸</div>
            <div class="card-content">
                <div class="card-title">BugÃ¼n NÃ¶betÃ§i Olanlar</div>
                <div class="card-list" id="db-gunun-nobetcileri-list">YÃ¼kleniyor...</div>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="card-icon" style="background-color: #e6f7e9; color: #28a745;">âœˆï¸</div>
            <div class="card-content">
                <div class="card-title">BugÃ¼n Ä°zinli Olanlar</div>
                <div class="card-list" id="db-bugun-izinliler-list">YÃ¼kleniyor...</div>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="card-icon" style="background-color: #feefe8; color: #dc3545;">ğŸ“</div>
            <div class="card-content">
                <div class="card-title">BugÃ¼nkÃ¼ GÃ¶revlendirmeler</div>
                <div class="card-list" id="db-bugun-gorevli-list">YÃ¼kleniyor...</div>
            </div>
        </div>
    </div>
<h3 style="margin-top: 35px; color: var(--dark-text-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">AylÄ±k Ã–zet</h3>
<div class="dashboard-grid" style="margin-top: 20px;">

    <div class="dashboard-card">
        <div class="card-icon" style="background-color: #eefbec; color: #34a853;">â•</div>
        <div class="card-content">
            <div class="card-title">Bu Ayki Toplam Ek Ders</div>
            <div class="card-value" id="db-aylik-ekders">...</div>
            <div class="card-description">TÃ¼m personel iÃ§in</div>
        </div>
    </div>

    <div class="dashboard-card">
        <div class="card-icon" style="background-color: #e9f2ff; color: #4285f4;">ğŸ›¡ï¸</div>
        <div class="card-content">
            <div class="card-title">Bu Ayki Toplam NÃ¶bet</div>
            <div class="card-value" id="db-aylik-nobet">...</div>
            <div class="card-description">Ek ders karÅŸÄ±lÄ±ÄŸÄ±</div>
        </div>
    </div>

    <div class="dashboard-card">
        <div class="card-icon" style="background-color: #fdf3e7; color: #fbbc05;">ğŸ§­</div>
        <div class="card-content">
            <div class="card-title">Bu Ayki Toplam Rehberlik</div>
            <div class="card-value" id="db-aylik-rehberlik">...</div>
            <div class="card-description">Ek ders karÅŸÄ±lÄ±ÄŸÄ±</div>
        </div>
    </div>

    <div class="dashboard-card">
        <div class="card-icon" style="background-color: #feebee; color: #ea4335;">ğŸ©º</div>
        <div class="card-content">
            <div class="card-title">Bu Ay Raporlu Olanlar</div>
            <div class="card-list" id="db-aylik-raporlular-list">YÃ¼kleniyor...</div>
        </div>
    </div>
</div>
    <div class="panel" style="margin-top: 25px;">
        <div class="panel-header"><h3>HÄ±zlÄ± Ä°ÅŸlemler</h3></div>
        <div class="panel-body quick-actions">
            <a class="quick-action-btn nav-link" data-target="staff-list">ğŸ‘¥ Personel Listesi</a>
            <a class="quick-action-btn nav-link" data-target="gorevlendirme">ğŸ“ Yeni GÃ¶revlendirme</a>
            <a class="quick-action-btn nav-link" data-target="izin-takip">âœˆï¸ Yeni Ä°zin GiriÅŸi</a>
            <a class="quick-action-btn nav-link" data-target="puantaj">ğŸ“Š Puantaj Cetveli</a>
        </div>
    </div>
</div>
            <div id="staff-list" class="module"><div class="panel"><div class="panel-header"><h3>Personel Listesi</h3><button id="add-staff-from-list-btn" class="btn-header-add">Yeni Personel Ekle</button></div><div class="panel-body"><p>Personel listesi yÃ¼kleniyor...</p></div></div></div>
            <div id="ders-programi" class="module"><div class="panel"><div class="panel-header"><h3>SÄ±nÄ±f BazlÄ± Ders ProgramÄ±</h3></div><div class="panel-body"><div id="tab-container"></div><div class="form-container"><div class="form-group"><label>Saat</label><select id="saat"></select></div><div class="form-group"><label>GÃ¼n</label><select id="gun">
    <option value="Pazartesi">Pazartesi</option>
    <option value="SalÄ±">SalÄ±</option>
    <option value="Ã‡arÅŸamba">Ã‡arÅŸamba</option>
    <option value="PerÅŸembe">PerÅŸembe</option>
    <option value="Cuma">Cuma</option>
</select></div><div class="form-group"><label>Ã–ÄŸretmen</label><select id="ogretmen"><option value="">Ã–ÄŸretmen SeÃ§in...</option></select></div><div class="form-group"><label>Ders (BranÅŸ)</label><select id="dersAdi"><option value="">Ders SeÃ§in...</option></select></div><button id="ekleBtn" class="btn">Ders Ekle</button></div><div id="schedule-display-area"></div></div></div></div>
            <div id="gorevlendirme" class="module">
    <div class="panel">
        <div class="panel-header">
            <h3>DetaylÄ± Ders GÃ¶revlendirme</h3>
        </div>
        <div class="panel-body">
            <div class="gorevlendirme-form-area no-print">
                <div class="gorevlendirme-layout">
                    <div class="gorev-panel">
                        <h4>Ana Bilgiler</h4>
                        <div class="form-group">
                            <label for="g-tarih">Tarih</label>
                            <input type="date" id="g-tarih">
                        </div>
                        <div class="form-group">
                            <label for="g-asil-ogretmen">AsÄ±l Ã–ÄŸretmen</label>
                            <select id="g-asil-ogretmen"></select>
                        </div>
                        <div class="form-group">
                            <label for="g-gorevli-ogretmen">GÃ¶revli Ã–ÄŸretmen</label>
                            <select id="g-gorevli-ogretmen"></select>
                        </div>
                        <div class="form-group">
                            <label for="g-aciklama">Genel AÃ§Ä±klama</label>
                            <input type="text" id="g-aciklama" placeholder="Ã–rn: Ã–ÄŸretmenin raporlu olmasÄ±">
                        </div>
                    </div>
                    <div class="gorev-panel">
                        <h4>Ders DaÄŸÄ±lÄ±mÄ± DetaylarÄ±</h4>
                        <div class="detail-entry">
                            <div class="form-group"><label for="d-sinif-select">SÄ±nÄ±f</label><select id="d-sinif-select"></select></div>
                            <div class="form-group"><label for="d-brans-select">Ders (BranÅŸ)</label><select id="d-brans-select"></select></div>
                            <div class="form-group"><label for="d-saat-select">Saat</label><select id="d-saat-select"></select></div>
                            <button id="g-detay-ekle-btn" class="btn">Ekle</button>
                        </div>
                        <ul id="gecici-detay-listesi"></ul>
                        <button id="g-kaydet-btn" class="btn btn-save" style="width: 100%; margin-top: 15px; padding: 12px;">TÃ¼m GÃ¶revlendirmeyi Kaydet</button>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 40px;">
                <h2 style="margin: 0;">Mevcut GÃ¶revlendirmeler</h2>
                <button id="btn-gorev-yazdir" class="btn btn-header-add no-print" style="background-color: var(--info-color);">YazdÄ±r</button>
            </div>
            <div class="table-container">
                <table class="gorevlendirme-table">
                    <thead>
                        <tr><th>Tarih</th><th>AsÄ±l Ã–ÄŸretmen</th><th>GÃ¶revli Ã–ÄŸretmen</th><th>Toplam Saat</th><th>Ders DetaylarÄ±</th><th>AÃ§Ä±klama</th><th class="no-print">Ä°ÅŸlemler</th></tr>
                    </thead>
                    <tbody id="gorevlendirme-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
            <div id="nobet-takip" class="module">
    <div class="panel">
        <div class="panel-header"><h3>NÃ¶bet Takip ve Raporlama</h3></div>
        <div class="panel-body">
            <div class="form-container" style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 25px; border-radius: 8px; margin-bottom: 30px;">
                <h3 style="margin-top:0; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">Yeni NÃ¶bet GiriÅŸi</h3>
                <div class="form-grid" style="grid-template-columns: 1fr 2fr 2fr 120px; align-items: flex-end;">
                    <div class="form-group"><label for="nobet-tarih">Tarih</label><input type="date" id="nobet-tarih"></div>
                    <div class="form-group"><label for="nobet-personel">NÃ¶betÃ§i Personel</label><select id="nobet-personel"><option value="">Personel SeÃ§iniz...</option></select></div>
                    <div class="form-group"><label for="nobet-yeri">NÃ¶bet Yeri</label><select id="nobet-yeri"><option value="">NÃ¶bet Yeri SeÃ§iniz...</option></select></div>
                    <button id="nobet-ekle-btn" class="btn" style="background-color: #0056b3; height: 46px;">NÃ¶bet Ekle</button>
                </div>
            </div>

            <div class="form-container" style="background-color: #eef1f3; border: 1px solid #d8dde2; padding: 25px; border-radius: 8px; margin-bottom: 30px;">
                <h3 style="margin-top:0; border-bottom: 2px solid #ced4da; padding-bottom: 10px;">AylÄ±k NÃ¶bet Ã‡izelgesini Kopyala</h3>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr 150px; align-items: flex-end; gap: 15px;">
                    <div class="form-group">
                        <label for="copy-source-month">Kaynak Ay</label>
                        <select id="copy-source-month"></select>
                    </div>
                    <div class="form-group">
                        <label for="copy-source-year">Kaynak YÄ±l</label>
                        <input type="number" id="copy-source-year" min="2020" max="2050" style="padding: 12px;">
                    </div>
                    <div class="form-group">
                        <label for="copy-dest-month">Hedef Ay</label>
                        <select id="copy-dest-month"></select>
                    </div>
                    <div class="form-group">
                        <label for="copy-dest-year">Hedef YÄ±l</label>
                        <input type="number" id="copy-dest-year" min="2020" max="2050" style="padding: 12px;">
                    </div>
                    <button id="copy-schedule-btn" class="btn" style="background-color: var(--theme-accent); height: 46px;">Ã‡izelgeyi Kopyala</button>
                </div>
            </div>
            <div id="nobet-rapor-alani">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
    <h3 style="margin-top: 40px; margin-bottom: 10px;">AylÄ±k NÃ¶bet Raporu</h3>
    <div class="no-print" style="display: flex; gap: 10px;">
        <button id="btn-nobet-toplu-sil" class="btn btn-header-add" style="background-color: var(--danger-color);">SeÃ§ilenleri Sil</button>
        <button id="btn-nobet-yazdir" class="btn btn-header-add" style="background-color: var(--info-color);">YazdÄ±r</button>
    </div>
</div>
                <div class="controls" style="display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 25px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                    <div class="controls-left" style="display: flex; align-items: center; gap: 10px;">
                        <select id="rapor-ay-sec"></select>
                        <input type="number" id="rapor-yil-gir" min="2020" max="2050">
                    </div>
                </div>
                <div class="table-container">
                    <table class="gorevlendirme-table"><thead><tr><th>Tarih</th><th>GÃ¼n</th><th>NÃ¶betÃ§i Personel</th><th>NÃ¶bet Yeri</th><th class="no-print">Ä°ÅŸlemler</th></tr></thead><tbody id="nobet-rapor-tbody"></tbody></table>
                </div>
            </div>
           
        </div>
    </div>
</div>
            <div id="izin-takip" class="module">
                <div class="panel">
                    <div class="panel-header">
                        <h3>Ä°zin Takip ve YÃ¶netim ModÃ¼lÃ¼</h3>
                        <button id="open-toplu-izin-modal-btn" class="btn-header-add" style="background-color: var(--success-color);">Toplu Ä°zin GiriÅŸi</button>
                    </div>
            
                    <div class="panel-body">
                        <div class="form-container" style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 25px; border-radius: 8px; margin-bottom: 40px;">
                            <h3 style="margin-top:0; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">Yeni Ä°zin GiriÅŸi</h3>
                            <div class="form-grid" style="grid-template-columns: 2fr 1.5fr 1fr 1fr; align-items: flex-end;">
                                <div class="form-group">
                                    <label for="izin-personel">Personel</label>
                                    <select id="izin-personel"><option value="">Personel SeÃ§iniz...</option></select>
                                </div>
                                <div class="form-group">
                                    <label for="izin-tipi">Ä°zin Tipi</label>
                                    <select id="izin-tipi"><option value="">Ä°zin Tipi SeÃ§iniz...</option></select>
                                </div>
                                <div class="form-group">
                                    <label for="izin-baslangic">BaÅŸlangÄ±Ã§ Tarihi</label>
                                    <input type="date" id="izin-baslangic">
                                </div>
                                <div class="form-group">
                                    <label for="izin-bitis">BitiÅŸ Tarihi</label>
                                    <input type="date" id="izin-bitis">
                                </div>
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label for="izin-aciklama">AÃ§Ä±klama / Not</label>
                                    <input type="text" id="izin-aciklama" placeholder="Ä°zinle ilgili kÄ±sa bir not...">
                                </div>
                            </div>
                            <div class="izin-hesaplama-alani">
                                <div id="personel-izin-hakki">
                                    </div>
                                <div id="izin-hesaplama-sonucu">
                                    </div>
                            </div>

                            <div class="button-group">
                                <button id="izin-kaydet-btn" class="btn btn-save">Ä°zin KaydÄ±nÄ± OluÅŸtur</button>
                            </div>
                        </div>
                        <h3>KayÄ±tlÄ± Ä°zinler</h3>
                        <div class="table-container">
                            <table class="gorevlendirme-table">
                                <thead>
                                    <tr><th>Personel AdÄ±</th><th>Ä°zin Tipi</th><th>BaÅŸlangÄ±Ã§</th><th>BitiÅŸ</th><th>SÃ¼re (GÃ¼n)</th><th>AÃ§Ä±klama</th><th style="width: 200px;">Ä°ÅŸlemler</th></tr>
                                </thead>
                                <tbody id="izin-kayitlari-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="puantaj" class="module">
                <div class="panel">
                    <div class="panel-header"><h3>Puantaj Cetveli</h3></div>
                    <div class="panel-body">
                        <div class="controls puantaj">
                         
                            <div class="controls-left">
    <select id="select-month"></select>
    <input type="number" id="input-year" min="2020" max="2050">

    <button id="btn-show-puantaj" style="background-color: #0d6efd; color: white; padding: 10px 15px; font-size: 14px; font-weight: 500; border-radius: 6px; border: 1px solid transparent; cursor: pointer;">
        PuantajÄ± GÃ¶ster
    </button>

    <button id="btn-generate" style="background-color: #ffc107; color: #000; padding: 10px 15px; font-size: 14px; font-weight: 500; border-radius: 6px; border: 1px solid transparent; cursor: pointer;">
        Yeni Puantaj OluÅŸtur
    </button>
<button id="btn-generate-individual" style="background-color: #17a2b8; color: white; padding: 10px 15px; font-size: 14px; font-weight: 500; border-radius: 6px; border: 1px solid transparent; cursor: pointer;">
        SeÃ§ili Personeli Hesapla
    </button>
</div>

<div class="personel-filter-container" style="display: flex; align-items: center; gap: 10px; border-left: 2px solid #ced4da; padding-left: 15px; margin-left: 5px; margin-top: 20px;">
    <select id="personel-filter-select" style="padding: 9px; border-radius: 6px; border: 1px solid #ced4da; min-width: 200px;"></select>
    <button id="btn-filter-personel" class="btn" style="background-color: #17a2b8;">Filtrele</button>
    <button id="btn-clear-filter" class="btn" style="background-color: #6c757d;">Temizle</button>
</div>
<div class="bulk-update-container" style="display: flex; flex-direction: column; gap: 10px; padding: 15px; background-color: #e9ecef; border-radius: 8px; border: 1px solid #ced4da; margin-top: 15px; grid-column: 1 / -1;">
    <h4 style="margin: 0 0 5px 0; color: var(--theme-primary);">Toplu GÃ¼ncelleme</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; align-items: flex-end;">
        <div>
            <label for="bulk-update-day" style="font-size: 13px; font-weight: 500;">Uygulanacak GÃ¼n:</label>
            <select id="bulk-update-day" class="form-control" style="padding: 8px;"></select>
        </div>
        <div>
            <label for="bulk-update-group" style="font-size: 13px; font-weight: 500;">Personel Grubu:</label>
            <select id="bulk-update-group" class="form-control" style="padding: 8px;">
                <option value="TÃ¼mÃ¼">TÃ¼m Personel</option>
                <option value="Belirli SÃ¼reli">Belirli SÃ¼reli</option>
                <option value="Belirsiz SÃ¼reli">Belirsiz SÃ¼reli</option>
                <option value="KÄ±smi SÃ¼reli">KÄ±smi SÃ¼reli</option>
            </select>
        </div>
        <div>
            <label for="bulk-update-status" style="font-size: 13px; font-weight: 500;">Yeni Durum Kodu:</label>
            <select id="bulk-update-status" class="form-control" style="padding: 8px;"></select>
        </div>
        <button id="btn-bulk-update" class="btn" style="background-color: #6f42c1; color: white; height: 38px;">Uygula</button>
    </div>
</div>


                            <div class="controls-right export-buttons">
    <button id="btn-save-puantaj" style="background-color: #28a745;">Kaydet</button>
    <button id="btn-lock-puantaj" style="background-color: #fd7e14;">PuantajÄ± Kilitle</button>
    <button id="btn-print">YazdÄ±r</button>
    <button id="btn-pdf">PDF Ä°ndir</button>
    <button id="btn-excel">Excel Ä°ndir</button>
    <button id="btn-delete-puantaj" style="background-color: var(--danger-color);">PuantajÄ± Sil</button>
</div>
                        </div>
                        <div id="puantaj-table-container" class="table-container"></div>
                        <div id="puantaj-legend" class="puantaj-legend"></div>
                        <div id="bottom-section" class="bottom-section">
                            <div class="summary-totals">
                                <h3>AylÄ±k Genel Toplamlar</h3>
                                <div class="total-line"><span class="label">Ek Ders Saati ToplamÄ±:</span><span id="total-ekders" class="value">0</span></div>
                                <div class="total-line"><span class="label">NÃ¶bet ToplamÄ±:</span><span id="total-nobet" class="value">0</span></div>
                                <div class="total-line"><span class="label">Rehberlik ToplamÄ±:</span><span id="total-rehberlik" class="value">0</span></div>
                            </div>
                            <div class="approval-section">
                                <h3>Onay</h3>
                                <div class="name">AdÄ± SoyadÄ±</div>
                                <div>Okul MÃ¼dÃ¼rÃ¼</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings" class="module">
                <div class="panel">
                    <div class="panel-header"><h3>Uygulama AyarlarÄ±</h3></div>
                    <div class="panel-body">
                        <div class="settings-tabs">
                            <button class="settings-tab-button active" data-tab="nevi">Personel Nevileri</button>
                            <button class="settings-tab-button" data-tab="gorev">GÃ¶revler/BranÅŸlar</button>
                            <button class="settings-tab-button" data-tab="ders">Dersler</button>
                            <button class="settings-tab-button" data-tab="sinif">SÄ±nÄ±flar</button>
                            <button class="settings-tab-button" data-tab="nobet-yeri">NÃ¶bet Yerleri</button>
                            <button class="settings-tab-button" data-tab="izin-tipi">Ä°zin Tipleri</button>
                            <button class="settings-tab-button" data-tab="zaman-cizelgesi">Zaman Ã‡izelgesi</button>
                        </div>
                        <div id="nevi-tab" class="settings-tab-content active">
    <h3>Personel Nevi YÃ¶netimi</h3>
    <div class="add-setting-form">
        <input type="text" id="add-nevi-input" placeholder="Yeni personel nevi adÄ±...">
        <button id="add-nevi-btn" class="btn">Ekle</button>
    </div>
    <ul id="nevi-list" class="settings-list"></ul>
</div>
                        <div id="gorev-tab" class="settings-tab-content"><h3>GÃ¶rev/BranÅŸ YÃ¶netimi</h3><div class="add-setting-form"><select id="gorev-nevi-select"><option value="">Ã–nce Personel Nevi SeÃ§in</option></select><input type="text" id="add-gorev-input" placeholder="Yeni gÃ¶rev/branÅŸ adÄ±..."><button id="add-gorev-btn" class="btn">Ekle</button></div><ul id="gorev-list" class="settings-list"></ul></div>
                        <div id="ders-tab" class="settings-tab-content"><h3>Ders YÃ¶netimi</h3><div class="add-setting-form"><input type="text" id="add-ders-input" placeholder="Yeni ders adÄ±..."><button id="add-ders-btn" class="btn">Ekle</button></div><ul id="ders-list" class="settings-list"></ul></div>
                        <div id="sinif-tab" class="settings-tab-content"><h3>SÄ±nÄ±f YÃ¶netimi</h3><div class="add-setting-form"><input type="text" id="add-sinif-input" placeholder="Yeni sÄ±nÄ±f adÄ±..."><button id="add-sinif-btn" class="btn">Ekle</button></div><ul id="sinif-list" class="settings-list"></ul></div>
                        <div id="nobet-yeri-tab" class="settings-tab-content"><h3>NÃ¶bet Yeri YÃ¶netimi</h3><div class="add-setting-form"><input type="text" id="add-nobet-yeri-input" placeholder="Yeni nÃ¶bet yeri adÄ±..."><button id="add-nobet-yeri-btn" class="btn">Ekle</button></div><ul id="nobet-yeri-list" class="settings-list"></ul></div>
                        <div id="izin-tipi-tab" class="settings-tab-content"><h3>Ä°zin Tipi YÃ¶netimi</h3><div class="add-setting-form" style="grid-template-columns: 2fr 1fr auto; display: grid;"><input type="text" id="add-izin-tipi-ad-input" placeholder="Yeni izin tipi adÄ± (Ã–rn: YÄ±llÄ±k Ä°zin)"><input type="text" id="add-izin-tipi-kod-input" placeholder="Puantaj Kodu (Ã–rn: I)"><button id="add-izin-tipi-btn" class="btn">Ekle</button></div><ul id="izin-tipi-list" class="settings-list"></ul></div>
                        <div id="zaman-cizelgesi-tab" class="settings-tab-content">
                            <h3>Zaman Ã‡izelgesi AyarlarÄ±</h3>
                            <p>Ders programÄ± modÃ¼lÃ¼, buradaki ayarlara gÃ¶re otomatik olarak ÅŸekillenecektir.</p>
                            <div class="form-grid">
                                <div class="form-group"><label for="setting-dersBaslangic">Ders BaÅŸlama Saati</label><input type="time" id="setting-dersBaslangic"></div>
                                <div class="form-group"><label for="setting-toplamDers">GÃ¼nlÃ¼k Toplam Ders SayÄ±sÄ±</label><input type="number" id="setting-toplamDers" min="1"></div>
                                <div class="form-group"><label for="setting-dersSuresi">Ders SÃ¼resi (Dakika)</label><input type="number" id="setting-dersSuresi" min="1"></div>
                                <div class="form-group"><label for="setting-teneffusSuresi">TeneffÃ¼s SÃ¼resi (Dakika)</label><input type="number" id="setting-teneffusSuresi" min="0"></div>
                                <div class="form-group"><label for="setting-ogleArasiDersNo">Ã–ÄŸle ArasÄ± KaÃ§Ä±ncÄ± Dersten Sonra?</label><input type="number" id="setting-ogleArasiDersNo" min="0"></div>
                                <div class="form-group"><label for="setting-ogleArasiSuresi">Ã–ÄŸle ArasÄ± SÃ¼resi (Dakika)</label><input type="number" id="setting-ogleArasiSuresi" min="0"></div>
                            </div>
                            <div class="button-group">
                                <button id="zaman-cizelgesi-kaydet-btn" class="btn btn-save">Ã‡izelge AyarlarÄ±nÄ± Kaydet</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            

            
            
            
        </main> <div id="edit-gorevlendirme-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>DetaylÄ± Ders GÃ¶revlendirme DÃ¼zenle</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editGorevlendirmeForm">
                <input type="hidden" id="edit-g-id">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label for="edit-g-tarih">Tarih</label>
                        <input type="date" id="edit-g-tarih">
                    </div>
                    <div class="form-group">
                        <label for="edit-g-asil-ogretmen">AsÄ±l Ã–ÄŸretmen</label>
                        <select id="edit-g-asil-ogretmen"></select>
                    </div>
                    <div class="form-group">
                        <label for="edit-g-gorevli-ogretmen">GÃ¶revli Ã–ÄŸretmen</label>
                        <select id="edit-g-gorevli-ogretmen"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-g-aciklama">Genel AÃ§Ä±klama</label>
                    <input type="text" id="edit-g-aciklama">
                </div>
                
                <div class="detail-entry" style="margin-top: 25px;">
                    <div class="form-group"><label for="edit-d-sinif-select">SÄ±nÄ±f</label><select id="edit-d-sinif-select"></select></div>
                    <div class="form-group"><label for="edit-d-brans-select">Ders (BranÅŸ)</label><select id="edit-d-brans-select"></select></div>
                    <div class="form-group"><label for="edit-d-saat-select">Saat</label><select id="edit-d-saat-select"></select></div>
                    <button type="button" id="edit-g-detay-ekle-btn" class="btn">Ekle</button>
                </div>
                <ul id="edit-g-detay-listesi" style="list-style: none; padding: 0; margin-top: 15px;">
                </ul>
                
                <div class="button-group" style="margin-top:20px;">
                    <button type="submit" class="btn btn-save">DeÄŸiÅŸiklikleri Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>
        
<div id="edit-setting-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="edit-setting-modal-title">Ayar AdÄ±nÄ± DÃ¼zenle</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="edit-setting-input">Yeni Ad</label>
                <input type="text" id="edit-setting-input">
            </div>
            <div class="button-group">
                <button id="edit-setting-save-btn" class="btn btn-save">DeÄŸiÅŸiklikleri Kaydet</button>
            </div>
        </div>
    </div>
</div>



    <div id="add-staff-modal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="modal-title">Yeni Personel Ekle</h3><button class="close-modal">&times;</button></div><div class="modal-body"><form id="personelForm"></form></div></div></div>
    <div id="edit-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="p-modal-title">Puantaj GÃ¼nÃ¼ DÃ¼zenle</h3><div class="form-group"><label for="modal-status">Durum</label><select id="modal-status"></select></div><div class="form-group"><label for="modal-hours">Ã‡alÄ±ÅŸÄ±lan Ders Saati</label><input type="number" id="modal-hours" min="0" max="12"></div><div class="form-group"><label for="modal-notes">AÃ§Ä±klama</label><input type="text" id="modal-notes" placeholder="Opsiyonel not..."></div><div class="modal-buttons"><button id="modal-cancel" class="btn">Ä°ptal</button><button id="modal-save" class="btn">Kaydet</button></div></div></div>
    
    <template id="personel-form-template">
    <div class="form-grid">
        <div class="form-group">
            <label for="ad_soyad">AdÄ± SoyadÄ±:</label>
            <input type="text" id="ad_soyad" name="ad_soyad" required>
        </div>

        <div class="form-group">
            <label for="tc_kimlik_no">T.C. Kimlik No:</label>
            <input type="text" id="tc_kimlik_no" name="tc_kimlik_no">
        </div>
        <div class="form-group">
            <label for="sgk_no">SGK No:</label>
            <input type="text" id="sgk_no" name="sgk_no">
        </div>
        <div class="form-group">
            <label for="personel_nevisi">Personel Nevisi:</label>
            <select id="personel_nevisi" name="personel_nevisi" required>
                <option value="" disabled selected>SeÃ§im yapÄ±nÄ±z...</option>
            </select>
        </div>
        <div class="form-group">
            <label for="gorevi_bransi">GÃ¶revi / BranÅŸÄ±:</label>
            <select id="gorevi_bransi" name="gorevi_bransi" required>
                <option value="" disabled selected>Ã–nce Personel Nevisi seÃ§in</option>
            </select>
        </div>
        <div class="form-group">
            <label for="sozlesme_turu">SÃ¶zleÅŸme TÃ¼rÃ¼:</label>
            <select id="sozlesme_turu" name="sozlesme_turu">
                <option value="Belirsiz SÃ¼reli">Belirsiz SÃ¼reli SÃ¶zleÅŸme</option>
                <option value="Belirli SÃ¼reli">Belirli SÃ¼reli SÃ¶zleÅŸme</option>
                <option value="KÄ±smi SÃ¼reli">KÄ±smi SÃ¼reli SÃ¶zleÅŸme</option>
            </select>
        </div>

        <div class="form-group full-width" id="kismi_zamanli_div" style="display: none; background-color: #f0f3f5; padding: 15px; border-radius: 6px;">
            <label style="font-weight: bold; color: var(--theme-primary); margin-bottom: 5px;">KÄ±smi ZamanlÄ± Ã‡alÄ±ÅŸma Saatleri</label>
            <p style="font-size: 0.9em; margin-top: 0;">LÃ¼tfen personelin haftalÄ±k Ã§alÄ±ÅŸma gÃ¼nlerini ve gÃ¼nlÃ¼k saatlerini belirtin.</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 20px;">

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="pzts_calisiyor" name="kismi_gunler" value="Pazartesi" style="width: auto; margin-right: 8px;">
                        <label for="pzts_calisiyor" style="margin: 0; font-weight: normal;">Pazartesi</label>
                    </div>
                    <div>
                        <input type="number" id="pzts_saat" name="pzts_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="sali_calisiyor" name="kismi_gunler" value="SalÄ±" style="width: auto; margin-right: 8px;">
                        <label for="sali_calisiyor" style="margin: 0; font-weight: normal;">SalÄ±</label>
                    </div>
                    <div>
                        <input type="number" id="sali_saat" name="sali_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="crs_calisiyor" name="kismi_gunler" value="Ã‡arÅŸamba" style="width: auto; margin-right: 8px;">
                        <label for="crs_calisiyor" style="margin: 0; font-weight: normal;">Ã‡arÅŸamba</label>
                    </div>
                    <div>
                        <input type="number" id="crs_saat" name="crs_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="prs_calisiyor" name="kismi_gunler" value="PerÅŸembe" style="width: auto; margin-right: 8px;">
                        <label for="prs_calisiyor" style="margin: 0; font-weight: normal;">PerÅŸembe</label>
                    </div>
                    <div>
                        <input type="number" id="prs_saat" name="prs_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="cuma_calisiyor" name="kismi_gunler" value="Cuma" style="width: auto; margin-right: 8px;">
                        <label for="cuma_calisiyor" style="margin: 0; font-weight: normal;">Cuma</label>
                    </div>
                    <div>
                        <input type="number" id="cuma_saat" name="cuma_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="cmrts_calisiyor" name="kismi_gunler" value="Cumartesi" style="width: auto; margin-right: 8px;">
                        <label for="cmrts_calisiyor" style="margin: 0; font-weight: normal;">Cumartesi</label>
                    </div>
                    <div>
                        <input type="number" id="cmrts_saat" name="cmrts_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="pazar_calisiyor" name="kismi_gunler" value="Pazar" style="width: auto; margin-right: 8px;">
                        <label for="pazar_calisiyor" style="margin: 0; font-weight: normal;">Pazar</label>
                    </div>
                    <div>
                        <input type="number" id="pazar_saat" name="pazar_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

            </div>
        </div>
        <div class="form-group">
            <label>Cinsiyet:</label>
            <div class="radio-group">
                <div><input type="radio" id="cinsiyet_kadin" name="cinsiyet" value="kadin" checked><label for="cinsiyet_kadin">KadÄ±n</label></div>
                <div><input type="radio" id="cinsiyet_erkek" name="cinsiyet" value="erkek"><label for="cinsiyet_erkek">Erkek</label></div>
            </div>
        </div>
        <div class="form-group">
            <label>EÅŸ Durumu:</label>
            <div class="radio-group">
                <div><input type="radio" id="es_calismiyor" name="es_durumu" value="calismiyor" checked><label for="es_calismiyor">Ã‡alÄ±ÅŸmÄ±yor</label></div>
                <div><input type="radio" id="es_calisiyor" name="es_durumu" value="calisiyor"><label for="es_calisiyor">Ã‡alÄ±ÅŸÄ±yor</label></div>
                <div><input type="radio" id="es_bekar" name="es_durumu" value="bekar"><label for="es_bekar">Bekar</label></div>
            </div>
        </div>
         <div class="form-group" id="rehberlik_gorevi_div">
        <label>Rehberlik GÃ¶revi Var MÄ±?:</label>
        <div class="radio-group">
            <div><input type="radio" id="rehberlik_yok" name="rehberlik_gorevi" value="hayir" checked><label for="rehberlik_yok">HayÄ±r</label></div>
            <div><input type="radio" id="rehberlik_var" name="rehberlik_gorevi" value="evet"><label for="rehberlik_var">Evet (HaftalÄ±k 2 Saat)</label></div>
        </div>
    </div>
        <div class="form-group">
            <label for="cocuk_0_6">Ã‡ocuk SayÄ±sÄ± (0-6 YaÅŸ):</label>
            <input type="number" id="cocuk_0_6" name="cocuk_0_6" min="0" value="0">
        </div>
        <div class="form-group">
            <label for="cocuk_6_ustu">Ã‡ocuk SayÄ±sÄ± (6-18 YaÅŸ):</label>
            <input type="number" id="cocuk_6_ustu" name="cocuk_6_ustu" min="0" value="0">
        </div>
        <div class="form-group">
            <label for="ise_giris">Ä°ÅŸe GiriÅŸ Tarihi:</label>
            <input type="date" id="ise_giris" name="ise_giris" required>
        </div>
        <div class="form-group">
            <label for="isten_ayrilis">Ä°ÅŸten AyrÄ±lÄ±ÅŸ Tarihi:</label>
            <input type="date" id="isten_ayrilis" name="isten_ayrilis">
        </div>
        <div class="form-group" id="maas_karsiligi_div">
            <label for="maas_karsiligi">MaaÅŸ KarÅŸÄ±lÄ±ÄŸÄ± Ders Saati:</label>
            <input type="number" id="maas_karsiligi" name="maas_karsiligi" min="0" value="20">
        </div>
        <div class="form-group full-width">
            <label for="aciklama">AÃ§Ä±klama:</label>
            <textarea id="aciklama" name="aciklama" rows="3"></textarea>
        </div>
        <div class="form-group full-width button-group">
            <button type="submit" class="btn btn-save">Personeli Kaydet</button>
        </div>
    </div>
</template>
    
    <script type="module">
 // =================================================================
// 1. ADIM: BU KOD BLOÄUNU OLDUÄU GÄ°BÄ° EKLEYÄ°N
// =================================================================
const eksikGunKodlari = [
    { kod: "01", aciklama: "Ä°stirahat" }, { kod: "03", aciklama: "Disiplin cezasÄ±" },
    { kod: "04", aciklama: "GÃ¶zaltÄ±na alÄ±nma" }, { kod: "05", aciklama: "Tutukluluk" },
    { kod: "06", aciklama: "KÄ±smi istihdam" }, { kod: "07", aciklama: "Puantaj kayÄ±tlarÄ±" },
    { kod: "08", aciklama: "Grev" }, { kod: "09", aciklama: "Lokavt" },
    { kod: "10", aciklama: "Genel hayatÄ± etkileyen olaylar" }, { kod: "11", aciklama: "DoÄŸal afet" },
    { kod: "12", aciklama: "Birden fazla" }, { kod: "13", aciklama: "DiÄŸer nedenler" },
    { kod: "15", aciklama: "DevamsÄ±zlÄ±k" }, { kod: "16", aciklama: "Fesih tarihinde Ã§alÄ±ÅŸmamÄ±ÅŸ" },
    { kod: "17", aciklama: "Ev hizmetlerinde 30 gÃ¼nden az Ã§alÄ±ÅŸma" }, { kod: "18", aciklama: "KÄ±sa Ã§alÄ±ÅŸma Ã¶deneÄŸi" },
    { kod: "19", aciklama: "Ãœcretsiz DoÄŸum Ä°zni" }, { kod: "20", aciklama: "Ãœcretsiz Yol Ä°zni" },
    { kod: "21", aciklama: "DiÄŸer Ãœcretsiz Ä°zin" }, { kod: "22", aciklama: "5434 SK. ek 76, GM 192" },
    { kod: "23", aciklama: "YarÄ±m Ã§alÄ±ÅŸma Ã¶deneÄŸi" }, { kod: "24", aciklama: "YarÄ±m Ã§alÄ±ÅŸma Ã¶deneÄŸi ve diÄŸer nedenler" },
    { kod: "25", aciklama: "DiÄŸer belge/kanun tÃ¼rlerinden gÃ¼n tamamlama" }, { kod: "26", aciklama: "KÄ±smi istihdama izin verilen yabancÄ± uyruklu sigortalÄ±" },
    { kod: "27", aciklama: "KÄ±sa Ã§alÄ±ÅŸma Ã¶deneÄŸi ve diÄŸer nedenler" }, { kod: "28", aciklama: "Pandemi Ãœcretsiz Ä°zin (4857 GeÃ§.10.Md.)" },
    { kod: "29", aciklama: "Pandemi Ãœcretsiz Ä°zin ve diÄŸer nedenler" }
];
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
    apiKey: "AIzaSyBoSgNHT05FNKeswV0KCaKY4-Pz7jpwbXM",
    authDomain: "puantaj-fe3df.firebaseapp.com",
    projectId: "puantaj-fe3df",
    storageBucket: "puantaj-fe3df.appspot.com", // <-- DOÄRU ADRES
    messagingSenderId: "110213592906",
    appId: "1:110213592906:web:02a14675741fc63e15b3b3",
    measurementId: "G-JC71J8VRJW"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
// YENÄ° EKLENECEK DEÄÄ°ÅKENLER
const auth = getAuth(app);
const loginPanel = document.getElementById('login-panel');
const appContainer = document.querySelector('.app-container');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const loginEmailInput = document.getElementById('login-email');
const loginPasswordInput = document.getElementById('login-password');
const loginError = document.getElementById('login-error');
// --- TÃœRKÄ°YE RESMÄ° TATÄ°LLER VERÄ° BANKASI (2024-2028) ---
const resmiTatiller = {
    "sabit": [
        { ay: 0, gun: 1, ad: "YÄ±lbaÅŸÄ±" },
        { ay: 3, gun: 23, ad: "Ulusal Egemenlik ve Ã‡ocuk BayramÄ±" },
        { ay: 4, gun: 1, ad: "Emek ve DayanÄ±ÅŸma GÃ¼nÃ¼" },
        { ay: 4, gun: 19, ad: "AtatÃ¼rk'Ã¼ Anma, GenÃ§lik ve Spor BayramÄ±" },
        { ay: 6, gun: 15, ad: "Demokrasi ve Milli Birlik GÃ¼nÃ¼" },
        { ay: 7, gun: 30, ad: "Zafer BayramÄ±" },
        { ay: 9, gun: 29, ad: "Cumhuriyet BayramÄ±" }
    ],
    "degisken": {
        "2024": [
            { ay: 3, gun: 9, ad: "Ramazan BayramÄ± Arifesi" }, { ay: 3, gun: 10, ad: "Ramazan BayramÄ± 1. GÃ¼n" }, { ay: 3, gun: 11, ad: "Ramazan BayramÄ± 2. GÃ¼n" }, { ay: 3, gun: 12, ad: "Ramazan BayramÄ± 3. GÃ¼n" },
            { ay: 5, gun: 15, ad: "Kurban BayramÄ± Arifesi" }, { ay: 5, gun: 16, ad: "Kurban BayramÄ± 1. GÃ¼n" }, { ay: 5, gun: 17, ad: "Kurban BayramÄ± 2. GÃ¼n" }, { ay: 5, gun: 18, ad: "Kurban BayramÄ± 3. GÃ¼n" }, { ay: 5, gun: 19, ad: "Kurban BayramÄ± 4. GÃ¼n" }
        ],
        "2025": [
            { ay: 2, gun: 29, ad: "Ramazan BayramÄ± Arifesi" }, { ay: 2, gun: 30, ad: "Ramazan BayramÄ± 1. GÃ¼n" }, { ay: 2, gun: 31, ad: "Ramazan BayramÄ± 2. GÃ¼n" }, { ay: 3, gun: 1, ad: "Ramazan BayramÄ± 3. GÃ¼n" },
            { ay: 5, gun: 5, ad: "Kurban BayramÄ± Arifesi" }, { ay: 5, gun: 6, ad: "Kurban BayramÄ± 1. GÃ¼n" }, { ay: 5, gun: 7, ad: "Kurban BayramÄ± 2. GÃ¼n" }, { ay: 5, gun: 8, ad: "Kurban BayramÄ± 3. GÃ¼n" }, { ay: 5, gun: 9, ad: "Kurban BayramÄ± 4. GÃ¼n" }
        ],
        "2026": [
            { ay: 2, gun: 18, ad: "Ramazan BayramÄ± Arifesi" }, { ay: 2, gun: 19, ad: "Ramazan BayramÄ± 1. GÃ¼n" }, { ay: 2, gun: 20, ad: "Ramazan BayramÄ± 2. GÃ¼n" }, { ay: 2, gun: 21, ad: "Ramazan BayramÄ± 3. GÃ¼n" },
            { ay: 4, gun: 25, ad: "Kurban BayramÄ± Arifesi" }, { ay: 4, gun: 26, ad: "Kurban BayramÄ± 1. GÃ¼n" }, { ay: 4, gun: 27, ad: "Kurban BayramÄ± 2. GÃ¼n" }, { ay: 4, gun: 28, ad: "Kurban BayramÄ± 3. GÃ¼n" }, { ay: 4, gun: 29, ad: "Kurban BayramÄ± 4. GÃ¼n" }
        ],
        "2027": [
            { ay: 2, gun: 8, ad: "Ramazan BayramÄ± Arifesi" }, { ay: 2, gun: 9, ad: "Ramazan BayramÄ± 1. GÃ¼n" }, { ay: 2, gun: 10, ad: "Ramazan BayramÄ± 2. GÃ¼n" }, { ay: 2, gun: 11, ad: "Ramazan BayramÄ± 3. GÃ¼n" },
            { ay: 4, gun: 15, ad: "Kurban BayramÄ± Arifesi" }, { ay: 4, gun: 16, ad: "Kurban BayramÄ± 1. GÃ¼n" }, { ay: 4, gun: 17, ad: "Kurban BayramÄ± 2. GÃ¼n" }, { ay: 4, gun: 18, ad: "Kurban BayramÄ± 3. GÃ¼n" }, { ay: 4, gun: 19, ad: "Kurban BayramÄ± 4. GÃ¼n" }
        ],
        "2028": [
            { ay: 1, gun: 27, ad: "Ramazan BayramÄ± Arifesi" }, { ay: 1, gun: 28, ad: "Ramazan BayramÄ± 1. GÃ¼n" }, { ay: 1, gun: 29, ad: "Ramazan BayramÄ± 2. GÃ¼n" }, { ay: 1, gun: 30, ad: "Ramazan BayramÄ± 3. GÃ¼n" },
            { ay: 4, gun: 3, ad: "Kurban BayramÄ± Arifesi" }, { ay: 4, gun: 4, ad: "Kurban BayramÄ± 1. GÃ¼n" }, { ay: 4, gun: 5, ad: "Kurban BayramÄ± 2. GÃ¼n" }, { ay: 4, gun: 6, ad: "Kurban BayramÄ± 3. GÃ¼n" }, { ay: 4, gun: 7, ad: "Kurban BayramÄ± 4. GÃ¼n" }
        ]
    }
};
function formatDateDDMMYYYY(dateString) {
    if (!dateString || typeof dateString !== 'string') return '---';
    const parts = dateString.split('-');
    if (parts.length !== 3) return dateString;
    const [year, month, day] = parts;
    return `${day}.${month}.${year}`;
}

// Belirtilen bir tarihin resmi tatil olup olmadÄ±ÄŸÄ±nÄ± kontrol eden yardÄ±mcÄ± fonksiyon
function isResmiTatil(date) {
    const year = date.getFullYear();
    const month = date.getMonth();
    const day = date.getDate();

    // Sabit tatilleri kontrol et
    if (resmiTatiller.sabit.some(t => t.ay === month && t.gun === day)) {
        return true;
    }

    // DeÄŸiÅŸken (dini) tatilleri kontrol et
    const yilinTatilleri = resmiTatiller.degisken[year];
    if (yilinTatilleri && yilinTatilleri.some(t => t.ay === month && t.gun === day)) {
        return true;
    }

    return false;
}

        // --- GENEL FONKSÄ°YONLAR ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'slideOut 0.3s forwards'; toast.addEventListener('animationend', () => toast.remove()); }, 3000);
        }

/* ======================= ESKÄ° renderDashboardData FONKSÄ°YONUNU SÄ°LÄ°P BUNU EKLEYÄ°N ======================= */
async function renderDashboardData() {
    const today = new Date();
    const todayString = today.toISOString().split('T')[0];
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth(); // 0-11

    // Gerekli DOM elemanlarÄ±nÄ± seÃ§
    const personelValueEl = document.getElementById('db-aktif-personel');
    const nobetListEl = document.getElementById('db-gunun-nobetcileri-list');
    const izinListEl = document.getElementById('db-bugun-izinliler-list');
    const gorevListEl = document.getElementById('db-bugun-gorevli-list');
    // Yeni kartlarÄ±n elemanlarÄ±
    const aylikEkdersEl = document.getElementById('db-aylik-ekders');
    const aylikNobetEl = document.getElementById('db-aylik-nobet');
    const aylikRehberlikEl = document.getElementById('db-aylik-rehberlik');
    const aylikRaporluListEl = document.getElementById('db-aylik-raporlular-list');

    // YÃ¼kleniyor... durumunu ayarla
    [personelValueEl, aylikEkdersEl, aylikNobetEl, aylikRehberlikEl].forEach(el => el.textContent = '...');
    [nobetListEl, izinListEl, gorevListEl, aylikRaporluListEl].forEach(el => el.innerHTML = 'YÃ¼kleniyor...');

    try {
        // AylÄ±k puantaj dÃ¶kÃ¼man ID'sini oluÅŸtur
        const puantajDocId = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

        // TÃ¼m veritabanÄ± sorgularÄ±nÄ± aynÄ± anda baÅŸlat
        const [
            personelSnap, nobetSnap, izinSnap, gorevSnap, nobetYeriSnap,
            izinTipiSnap, puantajDocSnap
        ] = await Promise.all([
            getDocs(query(collection(db, "personel"))),
            getDocs(query(collection(db, "nobetler"), where("tarih", "==", todayString))),
            getDocs(query(collection(db, "izinler"), where("baslangicTarihi", "<=", todayString))),
            getDocs(query(collection(db, "ders_gorevlendirmeleri"), where("tarih", "==", todayString))),
            getSettings('ayarlar_nobet_yerleri'),
            getSettings('ayarlar_izin_tipleri'),
            getDoc(doc(db, "kayitli_puantajlar", puantajDocId))
        ]);

        const personelMap = new Map(personelSnap.docs.map(doc => [doc.id, doc.data().ad_soyad]));
        const nobetYeriMap = new Map(nobetYeriSnap.docs.map(doc => [doc.id, doc.data().name]));
        const tumPersonelListesi = personelSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // --- GÃœNLÃœK KARTLARIN DOLDURULMASI (MEVCUT KOD) ---
        personelValueEl.textContent = personelSnap.size;
        if (nobetSnap.empty) { nobetListEl.innerHTML = '<span class="no-data">BugÃ¼n nÃ¶betÃ§i yok.</span>'; } 
        else { nobetListEl.innerHTML = nobetSnap.docs.map(doc => `<span><strong>${personelMap.get(doc.data().personelId) || '?'}</strong> - ${nobetYeriMap.get(doc.data().nobetYeriId) || ''}</span>`).join(''); }

        const bugunIzinliler = [];
        izinSnap.forEach(doc => {
            const izin = doc.data();
            if (new Date(izin.bitisTarihi + 'T23:59:59') >= today) {
                bugunIzinliler.push(personelMap.get(izin.personelId) || '?');
            }
        });
        if (bugunIzinliler.length === 0) { izinListEl.innerHTML = '<span class="no-data">BugÃ¼n izinli personel yok.</span>'; }
        else { izinListEl.innerHTML = bugunIzinliler.map(ad => `<span>${ad}</span>`).join(''); }

        if (gorevSnap.empty) { gorevListEl.innerHTML = '<span class="no-data">BugÃ¼n gÃ¶revlendirme yok.</span>'; }
        else { gorevListEl.innerHTML = gorevSnap.docs.map(d => `<span><strong>${personelMap.get(d.data().gorevliId) || '?'}</strong> (Yerine: ${personelMap.get(d.data().asilId) || '?'})</span>`).join(''); }

        // --- YENÄ° EKLENEN AYLIK Ã–ZET KARTLARININ DOLDURULMASI ---
        let totalEkders = 0, totalNobet = 0, totalRehberlik = 0;
        const aylikPuantajVerisi = puantajDocSnap.exists() ? puantajDocSnap.data().puantajData : null;

        if (aylikPuantajVerisi) {
            const nobetVerisi = await fetchAndCalculateNobetData(currentYear, currentMonth);

            tumPersonelListesi.forEach(personel => {
                // Puantaj verisi olan personeller iÃ§in hesaplama yap
                if (aylikPuantajVerisi[personel.id]) {
                    // Global puantajData deÄŸiÅŸkenini geÃ§ici olarak bu ayÄ±n verisiyle doldur
                    window.puantajData = aylikPuantajVerisi; 

                    if (personel.neviAdi?.includes('EÄŸitim Personeli') || personel.unvan?.includes('MÃ¼dÃ¼r')) {
                       totalEkders += calculateMonthlyHours(personel.id).ekDers;
                    }
                    totalNobet += nobetVerisi[personel.id] || 0;
                    totalRehberlik += calculateEffectiveRehberlikHours(personel.id, currentYear, currentMonth, aylikPuantajVerisi);
                }
            });
        }

        aylikEkdersEl.textContent = totalEkders;
        aylikNobetEl.textContent = totalNobet;
        aylikRehberlikEl.textContent = totalRehberlik;

        // Bu ay raporlu olanlarÄ± bulma
        const raporluIzinTipi = izinTipiSnap.docs.find(doc => doc.data().kod === 'R');
        if (raporluIzinTipi) {
            const ayinIlkGunu = new Date(currentYear, currentMonth, 1);
            const ayinSonGunu = new Date(currentYear, currentMonth + 1, 0);
            const raporluPersonelListesi = new Set();

            const raporSorgusu = query(collection(db, "izinler"), where("izinTipiId", "==", raporluIzinTipi.id));
            const raporluIzinlerSnap = await getDocs(raporSorgusu);

            raporluIzinlerSnap.forEach(doc => {
                const izin = doc.data();
                const baslangic = new Date(izin.baslangicTarihi + 'T00:00:00');
                const bitis = new Date(izin.bitisTarihi + 'T23:59:59');
                // Ä°zin aralÄ±ÄŸÄ± bu ay ile kesiÅŸiyor mu kontrolÃ¼
                if (baslangic <= ayinSonGunu && bitis >= ayinIlkGunu) {
                    const personelAdi = personelMap.get(izin.personelId);
                    if (personelAdi) raporluPersonelListesi.add(personelAdi);
                }
            });

            if (raporluPersonelListesi.size === 0) {
                aylikRaporluListEl.innerHTML = '<span class="no-data">Bu ay raporlu personel yok.</span>';
            } else {
                aylikRaporluListEl.innerHTML = Array.from(raporluPersonelListesi).map(ad => `<span>${ad}</span>`).join('');
            }
        } else {
             aylikRaporluListEl.innerHTML = '<span class="no-data">Rapor tanÄ±mÄ± bulunamadÄ±.</span>';
        }

    } catch (error) {
        console.error("Dashboard verisi Ã§ekilirken hata:", error);
        personelValueEl.textContent = 'Hata!';
        [nobetListEl, izinListEl, gorevListEl, aylikRaporluListEl].forEach(el => el.innerHTML = '<span class="no-data" style="color:red;">Veri yÃ¼klenemedi.</span>');
        [aylikEkdersEl, aylikNobetEl, aylikRehberlikEl].forEach(el => el.textContent = 'X');
    }
}
/* ======================================================================================================== */


        // --- AYARLAR VERÄ°TABANI Ä°ÅLEMLERÄ° ---
        const getSettings = async (collectionName) => getDocs(query(collection(db, collectionName), orderBy("name")));
        const addSetting = (collectionName, data) => addDoc(collection(db, collectionName), data);
        const deleteSetting = (collectionName, id) => deleteDoc(doc(db, collectionName, id));

        // --- AYARLAR MODÃœLÃœ YÃ–NETÄ°MÄ° ---
        async function renderSettingsList(collectionName, listElementId, relatedData) {
            const listElement = document.getElementById(listElementId);
            if (!listElement) return;
            listElement.innerHTML = '<li>YÃ¼kleniyor...</li>';
            try {
                const snapshot = await getSettings(collectionName);
                if (snapshot.empty) { listElement.innerHTML = '<li>HenÃ¼z veri eklenmemiÅŸ.</li>'; return; }
                listElement.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = doc.data(); const li = document.createElement('li'); let displayText = item.name;
                    if (collectionName === 'ayarlar_gorevler' && relatedData) {
                        const nevi = relatedData.find(n => n.id === item.neviId);
                        displayText = `${item.name} <small style="color: #555;">(${nevi ? nevi.name : 'Bilinmeyen'})</small>`;
                    }
                    if (collectionName === 'ayarlar_izin_tipleri') {
                        displayText = `${item.name} <strong style="color: var(--theme-accent);"> (Kod: ${item.kod})</strong>`;
                    }
                    li.innerHTML = `
    <span>${displayText}</span>
    <div class="actions-cell" style="width: auto; min-width: 120px;">
        <button class="btn btn-edit btn-edit-setting" data-id="${doc.id}" data-collection="${collectionName}" data-name="${item.name}">DÃ¼zenle</button>
        <button class="btn btn-delete btn-delete-setting" data-id="${doc.id}" data-collection="${collectionName}">Sil</button>
    </div>
`;
                    listElement.appendChild(li);
                });
            } catch (e) { listElement.innerHTML = '<li>Veri yÃ¼klenemedi.</li>'; console.error("Error rendering settings:", e); }
        }
        
        async function initializeSettings() {
            const tabsContainer = document.querySelector('.settings-tabs');
            if (tabsContainer.dataset.initialized) return;
            tabsContainer.dataset.initialized = 'true';
            const neviSnapshot = await getSettings('ayarlar_personel_nevileri');
            const personelNevileri = neviSnapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
            const renderAll = () => Promise.all([ renderSettingsList('ayarlar_personel_nevileri', 'nevi-list'), renderSettingsList('ayarlar_gorevler', 'gorev-list', personelNevileri), renderSettingsList('ayarlar_dersler', 'ders-list'), renderSettingsList('ayarlar_siniflar', 'sinif-list'), renderSettingsList('ayarlar_nobet_yerleri', 'nobet-yeri-list'), renderSettingsList('ayarlar_izin_tipleri', 'izin-tipi-list') ]);
            const populateGorevNeviSelect = () => { const select = document.getElementById('gorev-nevi-select'); select.innerHTML = '<option value="">Personel Nevi SeÃ§in</option>'; personelNevileri.forEach(nevi => select.add(new Option(nevi.name, nevi.id))); };
            await renderAll();
            populateGorevNeviSelect();
            document.getElementById('add-nevi-btn').addEventListener('click', async () => {
    const input = document.getElementById('add-nevi-input');
    const neviAdi = input.value.trim();
    if (neviAdi) {
        await addSetting('ayarlar_personel_nevileri', { name: neviAdi });
        showToast('Personel nevisi baÅŸarÄ±yla eklendi.');
        input.value = ''; // Ekleme sonrasÄ± input alanÄ±nÄ± temizle
        await renderSettingsList('ayarlar_personel_nevileri', 'nevi-list'); // Listeyi anÄ±nda gÃ¼ncelle
    }
});
            document.getElementById('add-gorev-btn').addEventListener('click', async () => { const input = document.getElementById('add-gorev-input'); const neviSelect = document.getElementById('gorev-nevi-select'); if(input.value.trim() && neviSelect.value) { await addSetting('ayarlar_gorevler', { name: input.value.trim(), neviId: neviSelect.value }); input.value = ''; await renderSettingsList('ayarlar_gorevler', 'gorev-list', personelNevileri); } });
            document.getElementById('add-ders-btn').addEventListener('click', async () => { const input = document.getElementById('add-ders-input'); if(input.value.trim()) { await addSetting('ayarlar_dersler', { name: input.value.trim() }); input.value = ''; await renderSettingsList('ayarlar_dersler', 'ders-list'); } });
            document.getElementById('add-sinif-btn').addEventListener('click', async () => { const input = document.getElementById('add-sinif-input'); if(input.value.trim()) { await addSetting('ayarlar_siniflar', { name: input.value.trim() }); input.value = ''; await renderSettingsList('ayarlar_siniflar', 'sinif-list'); } });
            document.getElementById('add-nobet-yeri-btn').addEventListener('click', async () => { const input = document.getElementById('add-nobet-yeri-input'); if(input.value.trim()) { await addSetting('ayarlar_nobet_yerleri', { name: input.value.trim() }); input.value = ''; await renderSettingsList('ayarlar_nobet_yerleri', 'nobet-yeri-list'); } });
            document.getElementById('add-izin-tipi-btn').addEventListener('click', async () => {
                const adInput = document.getElementById('add-izin-tipi-ad-input'); const kodInput = document.getElementById('add-izin-tipi-kod-input');
                const ad = adInput.value.trim(); const kod = kodInput.value.trim().toUpperCase();
                if(ad && kod) { await addSetting('ayarlar_izin_tipleri', { name: ad, kod: kod }); adInput.value = ''; kodInput.value = ''; await renderSettingsList('ayarlar_izin_tipleri', 'izin-tipi-list'); } 
                else { showToast('Ä°zin AdÄ± ve Puantaj Kodu alanlarÄ± zorunludur.', 'error'); }
            });
            document.querySelector('#settings .panel-body').addEventListener('click', async (e) => {
    const target = e.target;

    // Silme Ä°ÅŸlemi
    if (target.classList.contains('btn-delete-setting')) {
        const { id, collection } = target.dataset;
        if (confirm('Bu Ã¶ÄŸeyi silmek istediÄŸinizden emin misiniz?')) {
            await deleteSetting(collection, id);
            showToast('Ayar baÅŸarÄ±yla silindi.');
            if (collection === 'ayarlar_personel_nevileri') {
                location.reload();
            } else {
                await renderAll();
            }
        }
    }

    // DÃ¼zenleme Ä°ÅŸlemi
    if (target.classList.contains('btn-edit-setting')) {
        const { id, collection, name } = target.dataset;
        const modal = document.getElementById('edit-setting-modal');
        const input = document.getElementById('edit-setting-input');
        const saveBtn = document.getElementById('edit-setting-save-btn');

        input.value = name;
        modal.querySelector('.close-modal').onclick = () => modal.style.display = 'none';

        saveBtn.onclick = async () => {
            const newName = input.value.trim();
            if (newName && newName !== name) {
                await setDoc(doc(db, collection, id), { name: newName }, { merge: true });
                showToast('Ayar baÅŸarÄ±yla gÃ¼ncellendi.');
                modal.style.display = 'none';
                if (collection === 'ayarlar_personel_nevileri') {
                    location.reload();
                } else {
                    await renderAll();
                }
            } else {
                modal.style.display = 'none';
            }
        };

        modal.style.display = 'flex';
    }
});
// YENÄ° EKLENECEK SATIRLAR
await loadZamanCizelgesiAyarlari();
document.getElementById('zaman-cizelgesi-kaydet-btn').addEventListener('click', saveZamanCizelgesiAyarlari);
// YENÄ° EKLENECEK generateTimeSlots FONKSÄ°YONU
async function generateTimeSlots() {
    dersSaatleri.length = 0;
    try {
        const docSnap = await getDoc(doc(db, "genel_ayarlar", "zamanCizelgesi"));
        const ayarlar = docSnap.exists() ? docSnap.data() : {};
        const DERS_BASLANGIC_STR = ayarlar.dersBaslangic || '08:30';
        const TOPLAM_DERS_SAYISI = parseInt(ayarlar.toplamDers) || 8;
        const DERS_SURESI_DK = parseInt(ayarlar.dersSuresi) || 40;
        const TENEFUS_SURESI_DK = parseInt(ayarlar.teneffusSuresi) || 10;
        const OGLE_ARASI_DERS_NO = parseInt(ayarlar.ogleArasiDersNo) || 4;
        const OGLE_ARASI_SURESI_DK = parseInt(ayarlar.ogleArasiSuresi) || 45;
        const [saat, dakika] = DERS_BASLANGIC_STR.split(':').map(Number);
        let suankiZaman = new Date();
        suankiZaman.setHours(saat, dakika, 0, 0);
        for (let i = 1; i <= TOPLAM_DERS_SAYISI; i++) {
            const baslangic = new Date(suankiZaman);
            suankiZaman.setMinutes(suankiZaman.getMinutes() + DERS_SURESI_DK);
            const bitis = new Date(suankiZaman);
            dersSaatleri.push({ dersNo: i, baslangic: baslangic.toTimeString().substring(0, 5), bitis: bitis.toTimeString().substring(0, 5) });
            if (i === OGLE_ARASI_DERS_NO) {
                suankiZaman.setMinutes(suankiZaman.getMinutes() + OGLE_ARASI_SURESI_DK);
            } else if (i < TOPLAM_DERS_SAYISI) {
                suankiZaman.setMinutes(suankiZaman.getMinutes() + TENEFUS_SURESI_DK);
            }
        }
    } catch(e) {
        console.error("Zaman aralÄ±klarÄ± oluÅŸturulurken hata:", e);
        showToast('Zaman aralÄ±klarÄ± ayarlarÄ± okunamadÄ±!', 'error');
    }
    const saatSelect = document.getElementById('saat');
    if (saatSelect) {
        saatSelect.innerHTML = '';
        dersSaatleri.forEach(slot => saatSelect.add(new Option(`${slot.dersNo}. Ders (${slot.baslangic}-${slot.bitis})`, slot.baslangic)));
    }
}
            tabsContainer.addEventListener('click', e => { if (e.target.matches('.settings-tab-button')) { document.querySelectorAll('.settings-tab-button, .settings-tab-content').forEach(el => el.classList.remove('active')); e.target.classList.add('active'); document.getElementById(`${e.target.dataset.tab}-tab`).classList.add('active'); 
        } 
    });
}
// YENÄ° EKLENECEK FONKSÄ°YONLAR
async function saveZamanCizelgesiAyarlari() {
    const ayarlar = {
        dersBaslangic: document.getElementById('setting-dersBaslangic').value,
        toplamDers: document.getElementById('setting-toplamDers').value,
        dersSuresi: document.getElementById('setting-dersSuresi').value,
        teneffusSuresi: document.getElementById('setting-teneffusSuresi').value,
        ogleArasiDersNo: document.getElementById('setting-ogleArasiDersNo').value,
        ogleArasiSuresi: document.getElementById('setting-ogleArasiSuresi').value
    };
    try {
        await setDoc(doc(db, "genel_ayarlar", "zamanCizelgesi"), ayarlar);
        showToast('Zaman Ã§izelgesi ayarlarÄ± baÅŸarÄ±yla kaydedildi.');
    } catch (e) {
        console.error("Zaman Ã§izelgesi kaydedilirken hata:", e);
        showToast('Ayarlar kaydedilirken bir hata oluÅŸtu.', 'error');
    }
}

async function loadZamanCizelgesiAyarlari() {
    try {
        const docSnap = await getDoc(doc(db, "genel_ayarlar", "zamanCizelgesi"));
        if (docSnap.exists()) {
            const ayarlar = docSnap.data();
            document.getElementById('setting-dersBaslangic').value = ayarlar.dersBaslangic || '08:30';
            document.getElementById('setting-toplamDers').value = ayarlar.toplamDers || '8';
            document.getElementById('setting-dersSuresi').value = ayarlar.dersSuresi || '40';
            document.getElementById('setting-teneffusSuresi').value = ayarlar.teneffusSuresi || '10';
            document.getElementById('setting-ogleArasiDersNo').value = ayarlar.ogleArasiDersNo || '4';
            document.getElementById('setting-ogleArasiSuresi').value = ayarlar.ogleArasiSuresi || '45';
        } else {
            // VarsayÄ±lan deÄŸerleri ayarla
            document.getElementById('setting-dersBaslangic').value = '08:30';
            document.getElementById('setting-toplamDers').value = '8';
            document.getElementById('setting-dersSuresi').value = '40';
            document.getElementById('setting-teneffusSuresi').value = '10';
            document.getElementById('setting-ogleArasiDersNo').value = '4';
            document.getElementById('setting-ogleArasiSuresi').value = '45';
        }
    } catch (e) {
        console.error("Zaman Ã§izelgesi yÃ¼klenirken hata:", e);
    }
}
      


          
       // BU FONKSÄ°YONUN TAMAMINI YAPIÅTIRIN
async function fetchStaff() {
    const listContainer = document.querySelector('#staff-list .panel-body');
    listContainer.innerHTML = '<p>Personel listesi yÃ¼kleniyor...</p>';
    try {
        const personelSorgusu = query(collection(db, "personel"), orderBy("ad_soyad"));
        const [staffSnap, neviSnap, gorevSnap] = await Promise.all([
            getDocs(personelSorgusu),
            getSettings('ayarlar_personel_nevileri'),
            getSettings('ayarlar_gorevler')
        ]);

        const neviMap = Object.fromEntries(neviSnap.docs.map(doc => [doc.id, doc.data().name]));
        const gorevMap = Object.fromEntries(gorevSnap.docs.map(doc => [doc.id, doc.data().name]));

        if (staffSnap.empty) {
            listContainer.innerHTML = '<p>HenÃ¼z kayÄ±tlÄ± personel bulunmamaktadÄ±r.</p>';
            return;
        }

        const aktifPersonel = [];
        const ayrilanPersonel = [];
        const bugun = new Date();
        const ayinIlkGunu = new Date(bugun.getFullYear(), bugun.getMonth(), 1);

        staffSnap.forEach(doc => {
            const personel = { id: doc.id, ...doc.data() };
            const ayrilisTarihiStr = personel.isten_ayrilis;

            if (ayrilisTarihiStr && ayrilisTarihiStr.trim() !== '') {
                const ayrilisTarihi = new Date(ayrilisTarihiStr);
                if (!isNaN(ayrilisTarihi.getTime()) && ayrilisTarihi < ayinIlkGunu) {
                    ayrilanPersonel.push(personel);
                } else {
                    aktifPersonel.push(personel);
                }
            } else {
                aktifPersonel.push(personel);
            }
        });

        // Verilen listeye gÃ¶re HTML tablosu oluÅŸturan yardÄ±mcÄ± fonksiyon GÃœNCELLENDÄ°
        const createTableHTML = (personelListesi) => {
            if (personelListesi.length === 0) {
                return '<p style="padding: 15px; background-color: #f8f9fa; border-radius: 5px;">Bu listede gÃ¶sterilecek personel bulunmamaktadÄ±r.</p>';
            }
            // *** YENÄ° SÃœTUN BAÅLIKLARI: S.N. ve Cinsiyet eklendi ***
            let tableHTML = `<div class="table-container"><table class="staff-table"><thead><tr><th>S.N.</th><th>AdÄ± SoyadÄ±</th><th>Cinsiyet</th><th>Personel Nevisi</th><th>GÃ¶revi / BranÅŸÄ±</th><th>Ä°ÅŸe GiriÅŸ</th><th>Ä°ÅŸten AyrÄ±lÄ±ÅŸ</th><th>Ä°ÅŸlemler</th></tr></thead><tbody>`;
            
            // *** YENÄ° SATIR Ä°Ã‡ERÄ°ÄÄ°: SÄ±ra numarasÄ± ve cinsiyet bilgisi eklendi ***
            personelListesi.forEach((s, index) => {
                const cinsiyet = s.cinsiyet === 'kadin' ? 'KadÄ±n' : (s.cinsiyet === 'erkek' ? 'Erkek' : '---');
                tableHTML += `<tr>
                                <td>${index + 1}</td>
                                <td>${s.ad_soyad || ''}</td>
                                <td>${cinsiyet}</td>
                                <td>${neviMap[s.personel_nevisi] || 'Bilinmiyor'}</td>
                                <td>${gorevMap[s.gorevi_bransi] || 'Bilinmiyor'}</td>
                                <td>${formatDateDDMMYYYY(s.ise_giris)}</td>
                                <td>${formatDateDDMMYYYY(s.isten_ayrilis)}</td>
                                <td class="actions-cell"><button class="btn btn-edit" data-id="${s.id}">DÃ¼zenle</button><button class="btn btn-delete" data-id="${s.id}">Sil</button></td>
                              </tr>`;
            });
            tableHTML += `</tbody></table></div>`;
            return tableHTML;
        };

        let finalHTML = '<h3>Aktif Personel Listesi</h3>';
        finalHTML += createTableHTML(aktifPersonel);
        finalHTML += '<h3 style="margin-top: 40px; border-top: 2px solid #dee2e6; padding-top: 20px;">AyrÄ±lan Personel Listesi</h3>';
        finalHTML += createTableHTML(ayrilanPersonel);

        listContainer.innerHTML = finalHTML;

    } catch (e) {
        listContainer.innerHTML = '<p style="color:red;">Personel listesi yÃ¼klenemedi.</p>';
        console.error(e);
    }
}
  
        async function loadPersonelForm(staffId = null, staffData = null) {
    const template = document.getElementById('personel-form-template');
    const formContainer = document.getElementById('personelForm');
    formContainer.innerHTML = ''; // Formu temizle
    formContainer.appendChild(template.content.cloneNode(true));

    formContainer.dataset.editingId = staffId || '';
    document.getElementById('modal-title').textContent = staffId ? 'Personel Bilgilerini DÃ¼zenle' : 'Yeni Personel Ekle';

    const neviSelect = document.getElementById('personel_nevisi');
    const gorevSelect = document.getElementById('gorevi_bransi');
    const sozlesmeTuruSelect = document.getElementById('sozlesme_turu');
    const kismiZamanliDiv = document.getElementById('kismi_zamanli_div');
    const rehberlikGoreviDiv = document.getElementById('rehberlik_gorevi_div');
    const maasKarsiligiDiv = document.getElementById('maas_karsiligi_div');

    function updatePersonelFormVisibility() {
        const selectedNeviText = neviSelect.options[neviSelect.selectedIndex]?.text || '';
        const selectedContractType = sozlesmeTuruSelect.value;
        kismiZamanliDiv.style.display = (selectedContractType === 'KÄ±smi SÃ¼reli') ? 'block' : 'none';
        const isIndefinite = selectedContractType === 'Belirsiz SÃ¼reli';
        rehberlikGoreviDiv.style.display = isIndefinite ? 'none' : 'block';
        const isSupportStaff = selectedNeviText.includes('Destek Personeli');
        maasKarsiligiDiv.style.display = (isIndefinite || isSupportStaff) ? 'none' : 'block';
    }

    const neviSnapshot = await getSettings('ayarlar_personel_nevileri');
    neviSnapshot.forEach(doc => neviSelect.add(new Option(doc.data().name, doc.id)));

    // Olay Dinleyicisi: Nevi deÄŸiÅŸtiÄŸinde GÃ¶rev listesini doldurur
    neviSelect.addEventListener('change', async () => {
        const neviId = neviSelect.value;
        gorevSelect.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
        if (!neviId) {
            gorevSelect.innerHTML = '<option value="">Ã–nce Personel Nevi SeÃ§in</option>';
            return;
        }
        const q = query(collection(db, 'ayarlar_gorevler'), where('neviId', '==', neviId));
        const gorevSnapshot = await getDocs(q);
        gorevSelect.innerHTML = '<option value="">SeÃ§im yapÄ±nÄ±z...</option>';
        if (!gorevSnapshot.empty) {
            gorevSnapshot.forEach(doc => gorevSelect.add(new Option(doc.data().name, doc.id)));
        }
        updatePersonelFormVisibility();
    });

    sozlesmeTuruSelect.addEventListener('change', updatePersonelFormVisibility);

    // Formu doldurma (DÃ¼zenleme modu iÃ§in)
    if (staffId && staffData) {
        document.getElementById('ad_soyad').value = staffData.ad_soyad || '';
        document.getElementById('tc_kimlik_no').value = staffData.tc_kimlik_no || '';
        document.getElementById('sgk_no').value = staffData.sgk_no || '';
        
        // 1. Personel Nevisini ayarla
        neviSelect.value = staffData.personel_nevisi || '';
        
        // --- Ã–NEMLÄ° DÃœZELTME BAÅLANGICI ---
        // HatalÄ± olan dispatchEvent kaldÄ±rÄ±larak, gÃ¶rev listesi manuel olarak ve doÄŸru zamanlamayla dolduruluyor.
        
        // 2. GÃ¶rev listesini, seÃ§ilen Nevi'ye gÃ¶re DOLDUR ve bitmesini BEKLE (await)
        const neviId = neviSelect.value;
        gorevSelect.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
        if (neviId) {
            const q = query(collection(db, 'ayarlar_gorevler'), where('neviId', '==', neviId));
            const gorevSnapshot = await getDocs(q);
            gorevSelect.innerHTML = '<option value="">SeÃ§im yapÄ±nÄ±z...</option>';
            gorevSnapshot.forEach(doc => gorevSelect.add(new Option(doc.data().name, doc.id)));
        } else {
            gorevSelect.innerHTML = '<option value="">Ã–nce Personel Nevisi seÃ§in</option>';
        }

        // 3. ArtÄ±k liste dolu olduÄŸu iÃ§in personelin mevcut GÃ–REVÄ°NÄ° SEÃ‡
        gorevSelect.value = staffData.gorevi_bransi || '';
        // --- Ã–NEMLÄ° DÃœZELTME BÄ°TÄ°ÅÄ° ---

        sozlesmeTuruSelect.value = staffData.sozlesme_turu || 'Belirsiz SÃ¼reli';
        
        // YAPIÅTIRILACAK YENÄ° KOD BLOÄU
        if (staffData.cinsiyet) {
            document.querySelector(`input[name="cinsiyet"][value="${staffData.cinsiyet}"]`).checked = true;
        }
        if (staffData.es_durumu) {
            document.querySelector(`input[name="es_durumu"][value="${staffData.es_durumu}"]`).checked = true;
        }
        if (staffData.rehberlik_gorevi) {
            document.querySelector(`input[name="rehberlik_gorevi"][value="${staffData.rehberlik_gorevi}"]`).checked = true;
        }
        
        document.getElementById('cocuk_0_6').value = staffData.cocuk_0_6 || '0';
        document.getElementById('cocuk_6_ustu').value = staffData.cocuk_6_ustu || '0';
        document.getElementById('ise_giris').value = staffData.ise_giris || '';
        document.getElementById('isten_ayrilis').value = staffData.isten_ayrilis || '';
        document.getElementById('aciklama').value = staffData.aciklama || '';
        document.getElementById('maas_karsiligi').value = staffData.maas_karsiligi || '20';

        if (staffData.kismi_zamanli_calisma) {
            const gunMap = { 'Pazartesi': 'pzts', 'SalÄ±': 'sali', 'Ã‡arÅŸamba': 'crs', 'PerÅŸembe': 'prs', 'Cuma': 'cuma', 'Cumartesi': 'cmrts', 'Pazar': 'pazar' };
            for (const gun in staffData.kismi_zamanli_calisma) {
                const shortDay = gunMap[gun];
                if (shortDay) {
                    const checkbox = document.getElementById(`${shortDay}_calisiyor`);
                    const input = document.getElementById(`${shortDay}_saat`);
                    if (checkbox && input) {
                        checkbox.checked = true;
                        input.value = staffData.kismi_zamanli_calisma[gun];
                    }
                }
            }
        }
    } else {
        document.getElementById('ise_giris').valueAsDate = new Date();
        document.getElementById('es_bekar').checked = true;
    }

    updatePersonelFormVisibility();
}
        
        // YENÄ° EKLENECEK GÃœNCEL FONKSÄ°YON
let scheduleInitialized = false;
async function initializeSchedule() {
    if (scheduleInitialized) return;

    try {
        const [siniflarSnap, derslerSnap, personelSnap, neviSnap, gorevSnap] = await Promise.all([
            getSettings('ayarlar_siniflar'),
            getSettings('ayarlar_dersler'),
            getDocs(query(collection(db, 'personel'))),
            getSettings('ayarlar_personel_nevileri'),
            getSettings('ayarlar_gorevler')
        ]);

        const egitimPersoneliNevi = neviSnap.docs.find(doc => doc.data().name.includes('EÄŸitim Personeli'));
        const egitimPersoneliNeviId = egitimPersoneliNevi ? egitimPersoneliNevi.id : null;
        
        // Rehber Ã–ÄŸretmen filtresi iÃ§in kullanÄ±lan deÄŸiÅŸkenler kaldÄ±rÄ±ldÄ±.
        
        const siniflar = siniflarSnap.docs.map(d => d.data().name);
        const dersler = derslerSnap.docs.map(d => d.data().name);

        const personeller = personelSnap.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(p => {
                // FÄ°LTRE DEÄÄ°ÅÄ°KLÄ°ÄÄ°: ArtÄ±k sadece personelin "EÄŸitim Personeli" olup olmadÄ±ÄŸÄ± kontrol ediliyor.
                // Rehber Ã¶ÄŸretmen olup olmamasÄ± listeye eklenmesine engel deÄŸil.
                const isEgitimPersoneli = p.personel_nevisi === egitimPersoneliNeviId;
                return isEgitimPersoneli;
            })
            .map(p => p.ad_soyad);

        const dersSelect = document.getElementById('dersAdi');
        dersSelect.innerHTML = '<option value="">Ders SeÃ§in...</option>';
        dersler.forEach(ders => dersSelect.add(new Option(ders, ders)));

        const ogretmenSelect = document.getElementById('ogretmen');
        ogretmenSelect.innerHTML = '<option value="">Ã–ÄŸretmen SeÃ§in...</option>';
        personeller.forEach(p => ogretmenSelect.add(new Option(p, p)));

        if (siniflar.length === 0) {
            document.getElementById('schedule-display-area').innerHTML = '<p>LÃ¼tfen "Ayarlar" menÃ¼sÃ¼nden en az bir sÄ±nÄ±f ekleyin.</p>';
            return;
        }
        
        window.aktifSinif = siniflar[0];
        window.tumProgramlar = {};

        await generateTimeSlots();
        createTabs(siniflar);
        
        await loadScheduleForClass(window.aktifSinif);

        scheduleInitialized = true;

    } catch (error) {
        console.error("Ders programÄ± baÅŸlatÄ±lÄ±rken hata:", error);
        showToast('Ders programÄ± yÃ¼klenemedi. AyarlarÄ±nÄ±zÄ± kontrol edin.', 'error');
    }
}
        const dersSaatleri = [];
        function generateTimeSlots() {
            dersSaatleri.length = 0; let suankiZaman = new Date(); suankiZaman.setHours(9, 30, 0, 0);
            for (let i = 1; i <= 8; i++) {
                let baslangic = new Date(suankiZaman); suankiZaman.setMinutes(suankiZaman.getMinutes() + 40); let bitis = new Date(suankiZaman);
                dersSaatleri.push({ dersNo: i, baslangic: baslangic.toTimeString().substring(0, 5), bitis: bitis.toTimeString().substring(0, 5) });
                if (i === 4) suankiZaman.setMinutes(suankiZaman.getMinutes() + 60);
                else if (i < 8) suankiZaman.setMinutes(suankiZaman.getMinutes() + 10);
            }
            const saatSelect = document.getElementById('saat'); saatSelect.innerHTML = '';
            dersSaatleri.forEach(slot => saatSelect.add(new Option(`${slot.dersNo}. Ders (${slot.baslangic}-${slot.bitis})`, slot.baslangic)));
        }
        function createTabs(siniflar) {
            const tabContainer = document.getElementById('tab-container');
            tabContainer.innerHTML = '';
            siniflar.forEach(sinif => {
                const tab = document.createElement('button');
                tab.className = 'tab-link';
                if (sinif === window.aktifSinif) tab.classList.add('active');
                tab.textContent = sinif;
                tab.addEventListener('click', () => {
                    window.aktifSinif = sinif;
                    document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    // YENÄ°: Taba tÄ±klanÄ±nca ilgili sÄ±nÄ±fÄ±n programÄ±nÄ± veritabanÄ±ndan yÃ¼kle
                    loadScheduleForClass(sinif);
                });
                tabContainer.appendChild(tab);
            });
        }
        function renderSchedule() {
            const displayArea = document.getElementById('schedule-display-area');
            const gunler = ["Pazartesi", "SalÄ±", "Ã‡arÅŸamba", "PerÅŸembe", "Cuma"];
            let tableHTML = '<table class="schedule-table"><thead><tr><th>Saatler</th>';
            gunler.forEach(gun => tableHTML += `<th>${gun}</th>`);
            tableHTML += '</tr></thead><tbody>';

            const mevcutProgram = window.tumProgramlar[window.aktifSinif] || {};

            dersSaatleri.forEach((slot) => {
                tableHTML += `<tr><th>${slot.dersNo}. Ders<br>${slot.baslangic}-${slot.bitis}</th>`;
                gunler.forEach(gun => {
                    const dersData = mevcutProgram[gun]?.[slot.baslangic];
                    // YENÄ°: Silme butonu eklendi ve data-attributelarÄ± olan td elementi gÃ¼ncellendi
                    tableHTML += `<td data-gun="${gun}" data-saat="${slot.baslangic}">
                        ${dersData ? `
                        <div class="ders-karti">
                            <button class="delete-lesson-btn" title="Dersi Sil">Ã—</button>
                            <strong>${dersData.ogretmen}</strong>
                            <span>${dersData.dersAdi}</span>
                        </div>` : ''}
                    </td>`;
                });
                tableHTML += '</tr>';
                if (slot.dersNo === 4) {
                    tableHTML += '<tr><td colspan="6" style="background:#e9ecef;font-weight:bold;">Ã–ÄLE ARASI</td></tr>';
                }
            });
            displayArea.innerHTML = tableHTML + `</tbody></table>`;

            // YENÄ°: Silme butonu iÃ§in olay dinleyici ekleniyor
            document.querySelectorAll('.delete-lesson-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // DiÄŸer tÄ±klama olaylarÄ±nÄ± engelle
                    const td = e.target.closest('td');
                    const gun = td.dataset.gun;
                    const saat = td.dataset.saat;
                    deleteLesson(gun, saat);
                });
            });
        }
async function loadScheduleForClass(sinifAdi) {
            try {
                // SÄ±nÄ±f adÄ±ndaki '/' karakterini '-' ile deÄŸiÅŸtiriyoruz.
                const sanitizedSinifAdi = sinifAdi.replace(/\//g, '-');
                const docRef = doc(db, "ders_programlari", sanitizedSinifAdi);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    window.tumProgramlar[sinifAdi] = docSnap.data();
                } else {
                    window.tumProgramlar[sinifAdi] = {};
                }
            } catch (error) {
                console.error("Ders programÄ± yÃ¼klenirken hata:", error);
                window.tumProgramlar[sinifAdi] = {}; 
            }
            renderSchedule();
        }
       

        function deleteLesson(gun, saat) {
             if (confirm(`${gun} gÃ¼nÃ¼ ${saat} saatindeki dersi silmek istediÄŸinizden emin misiniz?`)) {
                if (window.tumProgramlar[window.aktifSinif]?.[gun]?.[saat]) {
                    // 1. GeÃ§ici deÄŸiÅŸkenden dersi sil
                    delete window.tumProgramlar[window.aktifSinif][gun][saat];
                    // 2. Tabloyu gÃ¼ncel haliyle yeniden Ã§iz
                    renderSchedule();
                    // 3. DeÄŸiÅŸikliÄŸi veritabanÄ±na kaydet
                    saveScheduleForClass(window.aktifSinif);
                }
            }
        }
        function addLesson() {
            const gun = document.getElementById('gun').value; const saat = document.getElementById('saat').value; const ogretmen = document.getElementById('ogretmen').value; const dersAdi = document.getElementById('dersAdi').value;
            if (!ogretmen || !dersAdi) return showToast('LÃ¼tfen Ã–ÄŸretmen ve Ders seÃ§in.', 'error');

            // GeÃ§ici deÄŸiÅŸkende ilgili gÃ¼n objesi yoksa oluÅŸtur
            if (!window.tumProgramlar[window.aktifSinif]) {
                 window.tumProgramlar[window.aktifSinif] = {};
            }
            if (!window.tumProgramlar[window.aktifSinif][gun]) {
                window.tumProgramlar[window.aktifSinif][gun] = {};
            }

            // 1. Dersi geÃ§ici deÄŸiÅŸkene ekle
            window.tumProgramlar[window.aktifSinif][gun][saat] = { ogretmen, dersAdi };
            // 2. Tabloyu yeniden Ã§izerek anÄ±nda gÃ¶ster
            renderSchedule();
            // 3. YENÄ°: DeÄŸiÅŸikliÄŸi veritabanÄ±na otomatik kaydet
            saveScheduleForClass(window.aktifSinif);
        }
async function saveScheduleForClass(sinifAdi) {
    // Firestore'da "9/A" gibi document ID'leri geÃ§ersizdir.
    // YÃ¼kleme fonksiyonunda olduÄŸu gibi '/' karakterini '-' ile deÄŸiÅŸtiriyoruz.
    const sanitizedSinifAdi = sinifAdi.replace(/\//g, '-');
    const docRef = doc(db, "ders_programlari", sanitizedSinifAdi);
    const dataToSave = window.tumProgramlar[sinifAdi] || {};

    try {
        // setDoc komutu ile ilgili sÄ±nÄ±fÄ±n tÃ¼m programÄ±nÄ± tek seferde kaydediyoruz.
        // Bu komut, dÃ¶kÃ¼man yoksa oluÅŸturur, varsa Ã¼zerine yazar.
        await setDoc(docRef, dataToSave);
        showToast(`${sinifAdi} iÃ§in program baÅŸarÄ±yla kaydedildi.`, 'success');
    } catch (error) {
        console.error("Ders programÄ± kaydedilirken hata oluÅŸtu:", error);
        showToast('Program kaydedilirken bir hata meydana geldi.', 'error');
    }
}

         let geciciDetaylar = [];
         let duzenlenenGorevDetaylari = []; //
         let gorevlendirmeInitialized = false;

        async function populateOgretmenSelectsForGorevlendirme() {
    const gAsilOgretmen = document.getElementById('g-asil-ogretmen');
    const gGorevliOgretmen = document.getElementById('g-gorevli-ogretmen');
    if (!gAsilOgretmen || !gGorevliOgretmen) return;

    gAsilOgretmen.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
    gGorevliOgretmen.innerHTML = '<option value="">YÃ¼kleniyor...</option>';

    try {
        const [personelSnap, neviSnap, gorevSnap] = await Promise.all([
            getDocs(collection(db, 'personel')),
            getSettings('ayarlar_personel_nevileri'),
            getSettings('ayarlar_gorevler')
        ]);

        const egitimPersoneliNevi = neviSnap.docs.find(doc => doc.data().name.includes('EÄŸitim Personeli'));
        const egitimPersoneliNeviId = egitimPersoneliNevi ? egitimPersoneliNevi.id : null;

        const idariGorevler = new Set();
        gorevSnap.forEach(doc => {
            const gorevAdi = doc.data().name.toLowerCase();
            if (gorevAdi.includes('mÃ¼dÃ¼r') || gorevAdi.includes('rehber Ã¶ÄŸretmen')) {
                idariGorevler.add(doc.id);
            }
        });

        const gosterilecekPersoneller = [];
        personelSnap.forEach(doc => {
            const personel = { id: doc.id, ...doc.data() };
            const isEgitimPersoneli = personel.personel_nevisi === egitimPersoneliNeviId;
            const isIdariGorevli = idariGorevler.has(personel.gorevi_bransi);
            if (isEgitimPersoneli || isIdariGorevli) {
                gosterilecekPersoneller.push(personel);
            }
        });

        gAsilOgretmen.innerHTML = '<option value="">SeÃ§iniz...</option>';
        gGorevliOgretmen.innerHTML = '<option value="">SeÃ§iniz...</option>';
        gosterilecekPersoneller.forEach(p => {
            gAsilOgretmen.add(new Option(p.ad_soyad, p.id));
            gGorevliOgretmen.add(new Option(p.ad_soyad, p.id));
        });

    } catch(e) {
        console.error("GÃ¶revlendirilecek Ã¶ÄŸretmenler yÃ¼klenemedi:", e);
        showToast('Ã–ÄŸretmen listesi yÃ¼klenemedi.', 'error');
    }
}

async function initializeGorevlendirme() {
    if (gorevlendirmeInitialized) return;

    const gDetayEkleBtn = document.getElementById('g-detay-ekle-btn');
    const gKaydetBtn = document.getElementById('g-kaydet-btn');
    const geciciListeUL = document.getElementById('gecici-detay-listesi');
    const gorevlendirmeTbody = document.getElementById('gorevlendirme-tbody');
    const sinifSelect = document.getElementById('d-sinif-select');
    const bransSelect = document.getElementById('d-brans-select');
    const saatSelect = document.getElementById('d-saat-select');
    const yazdirBtn = document.getElementById('btn-gorev-yazdir');

    if (sinifSelect && sinifSelect.options.length === 0) {
        const siniflarSnap = await getSettings('ayarlar_siniflar');
        siniflarSnap.forEach(doc => sinifSelect.add(new Option(doc.data().name, doc.data().name)));
    }
    if (bransSelect && bransSelect.options.length === 0) {
        const derslerSnap = await getSettings('ayarlar_dersler');
        derslerSnap.forEach(doc => bransSelect.add(new Option(doc.data().name, doc.data().name)));
    }
    await generateTimeSlots(); 
    
    if (saatSelect && saatSelect.options.length === 0) {
        saatSelect.innerHTML = '<option value="">Ders Saati SeÃ§in...</option>';
        dersSaatleri.forEach(slot => {
            saatSelect.add(new Option(`${slot.dersNo}. Ders (${slot.baslangic}-${slot.bitis})`, slot.dersNo));
        });
    }

    await populateOgretmenSelectsForGorevlendirme();
    await renderGorevlendirmeTable();

    if(gDetayEkleBtn) gDetayEkleBtn.addEventListener('click', addDetay);
    if(gKaydetBtn) gKaydetBtn.addEventListener('click', addGorevlendirme);
    if(yazdirBtn) yazdirBtn.addEventListener('click', () => window.print());

    if(geciciListeUL) geciciListeUL.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-temp-btn')) {
            const index = parseInt(e.target.dataset.index);
            geciciDetaylar.splice(index, 1);
            renderGeciciDetayListesi();
        }
    });
    if(gorevlendirmeTbody) gorevlendirmeTbody.addEventListener('click', async (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const id = target.dataset.id;
        if (target.classList.contains('btn-delete-gorev')) {
            if (confirm('Bu gÃ¶revlendirme kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?')) {
                await deleteDoc(doc(db, 'ders_gorevlendirmeleri', id));
                showToast('GÃ¶revlendirme baÅŸarÄ±yla silindi.');
                await renderGorevlendirmeTable();
            }
        }
        if (target.classList.contains('btn-edit-gorev')) {
            openEditGorevlendirmeModal(id);
        }
    });

    const editDetayEkleBtn = document.getElementById('edit-g-detay-ekle-btn');
    if(editDetayEkleBtn) editDetayEkleBtn.addEventListener('click', () => {
        const sinif = document.getElementById('edit-d-sinif-select').value;
        const brans = document.getElementById('edit-d-brans-select').value;
        const saat = parseInt(document.getElementById('edit-d-saat-select').value);
        if (!sinif || !brans || !saat) {
            return showToast('LÃ¼tfen SÄ±nÄ±f, BranÅŸ ve Saat seÃ§imi yapÄ±n.', 'error');
        }
        duzenlenenGorevDetaylari.push({ sinif, brans, saat });
        renderDuzenlenenDetayListesi();
    });

    const editDetayListesi = document.getElementById('edit-g-detay-listesi');
    if(editDetayListesi) editDetayListesi.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-temp-btn')) {
            const index = parseInt(e.target.dataset.index);
            duzenlenenGorevDetaylari.splice(index, 1);
            renderDuzenlenenDetayListesi();
        }
    });
    
    const editForm = document.getElementById('editGorevlendirmeForm');
    if(editForm) editForm.addEventListener('submit', saveGorevlendirmeChanges);
    
    const closeModalBtn = document.querySelector('#edit-gorevlendirme-modal .close-modal');
    if(closeModalBtn) closeModalBtn.addEventListener('click', () => {
        document.getElementById('edit-gorevlendirme-modal').classList.remove('open');
    });

    gorevlendirmeInitialized = true;
}

async function renderGorevlendirmeTable() {
    const gTbody = document.getElementById('gorevlendirme-tbody');
    gTbody.innerHTML = '<tr><td colspan="7">GÃ¶revlendirmeler yÃ¼kleniyor...</td></tr>';

    try {
        const [gorevlendirmeSnap, personelSnap] = await Promise.all([
            getDocs(query(collection(db, 'ders_gorevlendirmeleri'), orderBy("tarih", "desc"))),
            getDocs(collection(db, 'personel'))
        ]);
        const personelMap = new Map();
        personelSnap.forEach(doc => personelMap.set(doc.id, doc.data().ad_soyad));

        if (gorevlendirmeSnap.empty) {
            gTbody.innerHTML = '<tr><td colspan="7">KayÄ±tlÄ± gÃ¶revlendirme bulunamadÄ±.</td></tr>';
            return;
        }

        gTbody.innerHTML = '';
        gorevlendirmeSnap.forEach(doc => {
            const g = doc.data();
            const asil = personelMap.get(g.asilId) || 'Bilinmiyor';
            const gorevli = personelMap.get(g.gorevliId) || 'Bilinmiyor';
            let detaylarHTML = '<ul class="ders-detaylari">';
            g.detaylar.forEach(d => {
                detaylarHTML += `<li>${d.sinif} / ${d.brans} (${d.saat}. Ders)</li>`;
            });
            detaylarHTML += '</ul>';
            const row = gTbody.insertRow();

            row.innerHTML = `
                <td>${new Date(g.tarih).toLocaleDateString('tr-TR')}</td>
                <td>${asil}</td>
                <td>${gorevli}</td>
                <td><b>${g.toplamSaat}</b></td>
                <td>${detaylarHTML}</td>
                <td>${g.aciklama}</td>
                <td class="actions-cell no-print">
                   <button class="btn btn-edit btn-edit-gorev" data-id="${doc.id}">DÃ¼zenle</button>
                   <button class="btn btn-delete btn-delete-gorev" data-id="${doc.id}">Sil</button>
                </td>
            `;
        });
    } catch (e) {
        console.error("GÃ¶revlendirmeler yÃ¼klenemedi:", e);
        showToast('GÃ¶revlendirmeler yÃ¼klenemedi.', 'error');
        gTbody.innerHTML = '<tr><td colspan="7" style="color:red;">Veri yÃ¼klenirken bir hata oluÅŸtu.</td></tr>';
    }
}
        function renderGeciciDetayListesi() {
            const geciciListeUL = document.getElementById('gecici-detay-listesi'); geciciListeUL.innerHTML = '';
            geciciDetaylar.forEach((detay, index) => { const li = document.createElement('li'); li.innerHTML = `<span><b>${detay.sinif} / ${detay.brans}</b> - ${detay.saat}. Ders</span> <button class="delete-temp-btn" data-index="${index}">Sil</button>`; geciciListeUL.appendChild(li); });
        }
        
function renderDuzenlenenDetayListesi() {
            const listeUL = document.getElementById('edit-g-detay-listesi');
            listeUL.innerHTML = '';
            duzenlenenGorevDetaylari.forEach((detay, index) => {
                const li = document.createElement('li');
                li.style.cssText = "display: flex; justify-content: space-between; align-items: center; background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 8px;";
                li.innerHTML = `
                    <span><b>${detay.sinif} / ${detay.brans}</b> - ${detay.saat}. Ders</span>
                    <button type="button" class="delete-temp-btn" data-index="${index}" style="background: none; border: none; color: var(--danger-color); cursor: pointer; font-weight: bold;">Sil</button>
                `;
                listeUL.appendChild(li);
            });
        }
        function addDetay() {
            // ID'ler yeni select'lere gÃ¶re gÃ¼ncellendi
            const dSinifSelect = document.getElementById('d-sinif-select');
            const dBransSelect = document.getElementById('d-brans-select');
            const dSaatSelect = document.getElementById('d-saat-select');

            const sinif = dSinifSelect.value;
            const brans = dBransSelect.value;
            const saat = parseInt(dSaatSelect.value);

            if (!sinif || !brans || !saat) {
                alert('LÃ¼tfen SÄ±nÄ±f, BranÅŸ ve Saat seÃ§imi yapÄ±n.');
                return;
            }
            geciciDetaylar.push({ sinif, brans, saat });
            renderGeciciDetayListesi();
            
            // SeÃ§im sonrasÄ± listeleri sÄ±fÄ±rla
            dSinifSelect.value = '';
            dBransSelect.value = '';
            dSaatSelect.value = '';
        }
        async function addGorevlendirme() {
            const gTarih = document.getElementById('g-tarih'), gAsilOgretmen = document.getElementById('g-asil-ogretmen'), gGorevliOgretmen = document.getElementById('g-gorevli-ogretmen'), gAciklama = document.getElementById('g-aciklama');
            const tarih = gTarih.value, asilId = gAsilOgretmen.value, gorevliId = gGorevliOgretmen.value, aciklama = gAciklama.value.trim();
            if (!tarih || !asilId || !gorevliId) { alert('LÃ¼tfen ana bilgilerdeki tÃ¼m zorunlu alanlarÄ± doldurun.'); return; }
            if (geciciDetaylar.length === 0) { alert('LÃ¼tfen en az bir ders daÄŸÄ±lÄ±mÄ± detayÄ± ekleyin.'); return; }
            // Toplam saat, artÄ±k eklenen ders listesindeki eleman sayÄ±sÄ±dÄ±r.
            const toplamSaat = geciciDetaylar.length;
            const yeniGorevlendirme = { tarih, asilId, gorevliId, toplamSaat, aciklama, detaylar: geciciDetaylar, kayitTarihi: new Date().toISOString() };
            try {
                await addDoc(collection(db, 'ders_gorevlendirmeleri'), yeniGorevlendirme);
                showToast('GÃ¶revlendirme baÅŸarÄ±yla kaydedildi.');
                geciciDetaylar = []; renderGeciciDetayListesi();
                gTarih.value = ''; gAsilOgretmen.value = ''; gGorevliOgretmen.value = ''; gAciklama.value = '';
                await renderGorevlendirmeTable();
            } catch(e) { console.error("GÃ¶revlendirme kaydedilemedi:", e); showToast('GÃ¶revlendirme kaydedilirken bir hata oluÅŸtu.', 'error'); }
        }

        async function openEditGorevlendirmeModal(id) {
            const modal = document.getElementById('edit-gorevlendirme-modal');
            duzenlenenGorevDetaylari = []; // Listeyi her aÃ§Ä±lÄ±ÅŸta sÄ±fÄ±rla

            // Modal iÃ§indeki select'leri doldurma (eÄŸer boÅŸsa)
            const sinifSelect = document.getElementById('edit-d-sinif-select');
            if(sinifSelect.options.length <= 0) { // <= 1 yerine <= 0 daha doÄŸru olabilir
                const [siniflarSnap, derslerSnap] = await Promise.all([
                    getSettings('ayarlar_siniflar'), getSettings('ayarlar_dersler')
                ]);
                siniflarSnap.forEach(doc => sinifSelect.add(new Option(doc.data().name, doc.data().name)));
                
                const bransSelect = document.getElementById('edit-d-brans-select');
                derslerSnap.forEach(doc => bransSelect.add(new Option(doc.data().name, doc.data().name)));
                
                await generateTimeSlots(); // Ders saatlerini yÃ¼kle
                const saatSelect = document.getElementById('edit-d-saat-select');
                saatSelect.innerHTML = '<option value="">Ders Saati SeÃ§in...</option>'; // MenÃ¼yÃ¼ temizle ve varsayÄ±lan ekle
                dersSaatleri.forEach(slot => {
                    saatSelect.add(new Option(`${slot.dersNo}. Ders (${slot.baslangic}-${slot.bitis})`, slot.dersNo));
                });

                const asilSelect = document.getElementById('edit-g-asil-ogretmen');
                const gorevliSelect = document.getElementById('edit-g-gorevli-ogretmen');
                const personelSnap = await getDocs(collection(db, 'personel'));
                personelSnap.forEach(doc => {
                    const p = { id: doc.id, ...doc.data() };
                    asilSelect.add(new Option(p.ad_soyad, p.id));
                    gorevliSelect.add(new Option(p.ad_soyad, p.id));
                });
            }

            try {
                const docSnap = await getDoc(doc(db, "ders_gorevlendirmeleri", id));
                if (!docSnap.exists()) {
                    showToast('GÃ¶revlendirme kaydÄ± bulunamadÄ±.', 'error');
                    return;
                }
                const data = docSnap.data();

                // Formun ana alanlarÄ±nÄ± doldur
                document.getElementById('edit-g-id').value = id;
                document.getElementById('edit-g-tarih').value = data.tarih;
                document.getElementById('edit-g-aciklama').value = data.aciklama || '';
                document.getElementById('edit-g-asil-ogretmen').value = data.asilId;
                document.getElementById('edit-g-gorevli-ogretmen').value = data.gorevliId;

                // DetaylarÄ± geÃ§ici listeye kopyala ve ekranda Ã§iz
                if (data.detaylar) {
                    duzenlenenGorevDetaylari = [...data.detaylar];
                }
                renderDuzenlenenDetayListesi();
                
                modal.classList.add('open');
            } catch (error) {
                console.error("GÃ¶revlendirme dÃ¼zenleme verisi Ã§ekilirken hata:", error);
                showToast("Veri yÃ¼klenirken bir hata oluÅŸtu.", "error");
            }
        }

        async function saveGorevlendirmeChanges(event) {
            event.preventDefault();
            const id = document.getElementById('edit-g-id').value;
            if (!id) {
                showToast('Kaydedilecek gÃ¶revlendirme bulunamadÄ±.', 'error');
                return;
            }

            if (duzenlenenGorevDetaylari.length === 0) {
                return showToast('LÃ¼tfen en az bir ders daÄŸÄ±lÄ±mÄ± detayÄ± ekleyin.', 'error');
            }

            // Toplam saati gÃ¼ncel listeden tekrar hesapla
            const toplamSaat = duzenlenenGorevDetaylari.length;

            const updatedData = {
                tarih: document.getElementById('edit-g-tarih').value,
                asilId: document.getElementById('edit-g-asil-ogretmen').value,
                gorevliId: document.getElementById('edit-g-gorevli-ogretmen').value,
                aciklama: document.getElementById('edit-g-aciklama').value.trim(),
                detaylar: duzenlenenGorevDetaylari, // GÃ¼ncellenmiÅŸ ders listesi
                toplamSaat: toplamSaat // Yeni toplam saat
            };

            if (!updatedData.tarih || !updatedData.asilId || !updatedData.gorevliId) {
                return showToast("LÃ¼tfen Tarih ve Ã–ÄŸretmen alanlarÄ±nÄ± doldurun.", "error");
            }

            try {
                const gorevRef = doc(db, 'ders_gorevlendirmeleri', id);
                await setDoc(gorevRef, updatedData); // Merge yerine tam dÃ¶kÃ¼manÄ± set et
                showToast('GÃ¶revlendirme baÅŸarÄ±yla gÃ¼ncellendi.');
                document.getElementById('edit-gorevlendirme-modal').classList.remove('open');
                await renderGorevlendirmeTable();
            } catch (error) {
                console.error("GÃ¶revlendirme gÃ¼ncelleme hatasÄ±:", error);
                showToast('GÃ¼ncelleme sÄ±rasÄ±nda bir hata oluÅŸtu.', 'error');
            }
        }
// YENÄ° EKLENECEK KOD
async function addNobet() {
    const tarihInput = document.getElementById('nobet-tarih');
    const personelSelect = document.getElementById('nobet-personel');
    const yerSelect = document.getElementById('nobet-yeri');

    const tarih = tarihInput.value;
    const personelId = personelSelect.value;
    const nobetYeriId = yerSelect.value;

    if (!tarih || !personelId || !nobetYeriId) {
        showToast('LÃ¼tfen Tarih, Personel ve NÃ¶bet Yeri seÃ§in.', 'error');
        return;
    }

    try {
        await addDoc(collection(db, 'nobetler'), {
            tarih: tarih,
            personelId: personelId,
            nobetYeriId: nobetYeriId
        });

        showToast('NÃ¶bet baÅŸarÄ±yla eklendi.', 'success');
        
        // Formu temizle
        tarihInput.value = '';
        personelSelect.value = '';
        yerSelect.value = '';
        
        // Raporu yenile
        const year = parseInt(document.getElementById('rapor-yil-gir').value);
        const month = parseInt(document.getElementById('rapor-ay-sec').value);
        await renderNobetRaporu(year, month);

    } catch (error) {
        console.error("NÃ¶bet eklenirken hata: ", error);
        showToast('NÃ¶bet eklenirken bir hata oluÅŸtu.', 'error');
    }
}


// BU YENÄ° FONKSÄ°YONU OLDUÄU GÄ°BÄ° EKLEYÄ°N
async function deleteSelectedNobetler() {
    const selectedCheckboxes = document.querySelectorAll('.nobet-checkbox:checked');

    if (selectedCheckboxes.length === 0) {
        showToast('LÃ¼tfen silmek iÃ§in en az bir nÃ¶bet seÃ§in.', 'error');
        return;
    }

    if (!confirm(`${selectedCheckboxes.length} adet nÃ¶bet kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?`)) {
        return;
    }

    const deletePromises = [];
    selectedCheckboxes.forEach(checkbox => {
        const nobetId = checkbox.dataset.id;
        deletePromises.push(deleteDoc(doc(db, 'nobetler', nobetId)));
    });

    try {
        await Promise.all(deletePromises);
        showToast(`${selectedCheckboxes.length} nÃ¶bet kaydÄ± baÅŸarÄ±yla silindi.`, 'success');
        
        // Raporu yenile
        const year = parseInt(document.getElementById('rapor-yil-gir').value);
        const month = parseInt(document.getElementById('rapor-ay-sec').value);
        await renderNobetRaporu(year, month);
    } catch (error) {
        console.error("Toplu nÃ¶bet silme hatasÄ±:", error);
        showToast('NÃ¶betler silinirken bir hata oluÅŸtu.', 'error');
    }
}

let nobetTakipInitialized = false;
// YENÄ° EKLENECEK GÃœNCEL FONKSÄ°YON
async function initializeNobetTakip() {
    if (nobetTakipInitialized) return;
    nobetTakipInitialized = true;

    // Ana Elementler
    const personelSelect = document.getElementById('nobet-personel');
    const yerSelect = document.getElementById('nobet-yeri');
    const raporAySec = document.getElementById('rapor-ay-sec');
    const raporYilGir = document.getElementById('rapor-yil-gir');
    const nobetEkleBtn = document.getElementById('nobet-ekle-btn');
    const nobetRaporTbody = document.getElementById('nobet-rapor-tbody');
    const yazdirBtn = document.getElementById('btn-nobet-yazdir');
    // Yeni butonlar eklendi
    const topluSilBtn = document.getElementById('btn-nobet-toplu-sil');

    // Kopyalama Formu Elementleri
    const copySourceMonth = document.getElementById('copy-source-month');
    const copySourceYear = document.getElementById('copy-source-year');
    const copyDestMonth = document.getElementById('copy-dest-month');
    const copyDestYear = document.getElementById('copy-dest-year');
    const copyBtn = document.getElementById('copy-schedule-btn');

    // DÃ¼zenleme ModalÄ± Elementleri
    const editModal = document.getElementById('edit-nobet-modal');
    const editForm = document.getElementById('edit-nobet-form');
    
    // Select'leri Doldurma (Bu kÄ±sÄ±m aynÄ± kalÄ±yor)
    const personelSnap = await getDocs(collection(db, 'personel'));
    const nobetYeriSnap = await getSettings('ayarlar_nobet_yerleri');
    const personelOptions = personelSnap.docs.map(doc => `<option value="${doc.id}">${doc.data().ad_soyad}</option>`).join('');
    personelSelect.innerHTML = '<option value="">Personel SeÃ§iniz...</option>' + personelOptions;
    document.getElementById('edit-nobet-personel').innerHTML = personelOptions;
    const yerOptions = nobetYeriSnap.docs.map(doc => `<option value="${doc.id}">${doc.data().name}</option>`).join('');
    yerSelect.innerHTML = '<option value="">NÃ¶bet Yeri SeÃ§iniz...</option>' + yerOptions;
    document.getElementById('edit-nobet-yeri').innerHTML = yerOptions;

    // Ay Select'lerini Doldurma (Bu kÄ±sÄ±m aynÄ± kalÄ±yor)
    const now = new Date();
    const aylar = ["Ocak", "Åubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];
    [raporAySec, copySourceMonth, copyDestMonth].forEach(select => {
        select.innerHTML = '';
        aylar.forEach((ay, index) => select.add(new Option(ay, index)));
    });
    raporAySec.value = now.getMonth();
    raporYilGir.value = now.getFullYear();
    const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0); // Bir Ã¶nceki ay iÃ§in
    copySourceMonth.value = prevMonth.getMonth();
    copySourceYear.value = prevMonth.getFullYear();
    copyDestMonth.value = now.getMonth();
    copyDestYear.value = now.getFullYear();

    const renderRapor = () => renderNobetRaporu(parseInt(raporYilGir.value), parseInt(raporAySec.value));
    renderRapor();

    // Olay Dinleyicileri
    raporAySec.addEventListener('change', renderRapor);
    raporYilGir.addEventListener('change', renderRapor);
    copyBtn.addEventListener('click', copyNobetSchedule);
    yazdirBtn.addEventListener('click', () => window.print());
    nobetEkleBtn.addEventListener('click', addNobet); // Bu satÄ±r bir Ã¶nceki adÄ±mda dÃ¼zeltilmiÅŸti
    
    // Yeni toplu silme butonu iÃ§in olay dinleyici eklendi
    topluSilBtn.addEventListener('click', deleteSelectedNobetler);
    
    editModal.querySelector('.close-modal').addEventListener('click', () => editModal.classList.remove('open'));
    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveNobetChanges();
    });

    nobetRaporTbody.addEventListener('click', async (e) => {
        const target = e.target;
        // Checkbox'lara tÄ±klama olayÄ±nÄ± dÄ±ÅŸarÄ±da tutuyoruz Ã§Ã¼nkÃ¼ o "TÃ¼mÃ¼nÃ¼ SeÃ§" ile yÃ¶netiliyor.
        if (target.classList.contains('btn-delete-nobet')) {
            if (confirm('Bu nÃ¶bet kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?')) {
                await deleteDoc(doc(db, 'nobetler', target.dataset.id));
                showToast('NÃ¶bet kaydÄ± silindi.');
                renderRapor();
            }
        }
        if (target.classList.contains('btn-edit-nobet')) {
            openNobetEditModal(target.dataset.id);
        }
    });
}
 // YERÄ°NE EKLENECEK DÃœZELTÄ°LMÄ°Å FONKSÄ°YON
async function renderNobetRaporu(year, month) {
    const tbody = document.getElementById('nobet-rapor-tbody');
    const thead = tbody.closest('table').querySelector('thead tr');
    thead.innerHTML = `
        <th class="no-print" style="width: 40px;"><input type="checkbox" id="select-all-nobet" title="TÃ¼mÃ¼nÃ¼ SeÃ§"></th>
        <th>Tarih</th>
        <th>GÃ¼n</th>
        <th>NÃ¶betÃ§i Personel</th>
        <th>NÃ¶bet Yeri</th>
        <th class="no-print">Ä°ÅŸlemler</th>
    `;

    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Rapor oluÅŸturuluyor...</td></tr>`;

    // --- SAAT DÄ°LÄ°MÄ° SORUNUNU GÄ°DEREN DEÄÄ°ÅÄ°KLÄ°K ---
    // Sorgu iÃ§in gereken tarih metinlerini, saat dilimi hatalarÄ±nÄ± Ã¶nlemek iÃ§in doÄŸrudan oluÅŸturuyoruz.
    // BaÅŸlangÄ±Ã§ tarihi, seÃ§ilen ayÄ±n 1. gÃ¼nÃ¼dÃ¼r.
    const startDateString = `${year}-${String(month + 1).padStart(2, '0')}-01`;

    // BitiÅŸ tarihi, bir sonraki ayÄ±n 1. gÃ¼nÃ¼dÃ¼r (sorgu < olduÄŸu iÃ§in o gÃ¼n dahil edilmez).
    let endYear = year;
    let endMonth = month + 2; // month 0-index'li olduÄŸu iÃ§in sonraki ayÄ± bulmak iÃ§in 2 ekliyoruz.
    if (endMonth > 12) {
        endMonth = 1;
        endYear++;
    }
    const endDateString = `${endYear}-${String(endMonth).padStart(2, '0')}-01`;
    
    const q = query(
        collection(db, 'nobetler'), 
        where('tarih', '>=', startDateString), 
        where('tarih', '<', endDateString), 
        orderBy('tarih')
    );
    // --- DEÄÄ°ÅÄ°KLÄ°K SONU ---

    const [nobetSnap, personelSnap, yerSnap] = await Promise.all([
        getDocs(q),
        getDocs(collection(db, 'personel')),
        getSettings('ayarlar_nobet_yerleri')
    ]);

    const personelMap = new Map(personelSnap.docs.map(doc => [doc.id, doc.data().ad_soyad]));
    const yerMap = new Map(yerSnap.docs.map(doc => [doc.id, doc.data().name]));

    if (nobetSnap.empty) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">SeÃ§ili ay iÃ§in nÃ¶bet kaydÄ± bulunamadÄ±.</td></tr>`;
        return;
    }

    tbody.innerHTML = '';
    const gunlerTR = ['Pazar', 'Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi'];
    
    let sonTarih = null;
    let renkIndex = 0;
    const renkler = ['renk-a', 'renk-b'];

    nobetSnap.forEach(doc => {
        const nobet = doc.data();
        // Tarihi UTC olarak ele alarak saat dilimi sorunlarÄ±nÄ± engelliyoruz.
        const tarih = new Date(nobet.tarih + 'T00:00:00Z');
        
        if (sonTarih !== nobet.tarih) {
            sonTarih = nobet.tarih;
            renkIndex = (renkIndex + 1) % 2;
        }
        
        const row = tbody.insertRow();
        row.className = renkler[renkIndex];

        row.innerHTML = `
            <td class="no-print" style="text-align: center;">
                <input type="checkbox" class="nobet-checkbox" data-id="${doc.id}">
            </td>
            <td>${tarih.toLocaleDateString('tr-TR', { timeZone: 'UTC' })}</td>
            <td>${gunlerTR[tarih.getUTCDay()]}</td>
            <td>${personelMap.get(nobet.personelId) || 'Bilinmiyor'}</td>
            <td>${yerMap.get(nobet.nobetYeriId) || 'Bilinmiyor'}</td>
            <td class="actions-cell no-print">
                <button class="btn btn-edit btn-edit-nobet" data-id="${doc.id}">DÃ¼zenle</button>
                <button class="btn btn-delete btn-delete-nobet" data-id="${doc.id}">Sil</button>
            </td>
        `;
    });

    document.getElementById('select-all-nobet').addEventListener('change', (e) => {
        document.querySelectorAll('.nobet-checkbox').forEach(checkbox => {
            checkbox.checked = e.target.checked;
        });
    });
}


async function openNobetEditModal(id) {
    const modal = document.getElementById('edit-nobet-modal');
    try {
        const docRef = doc(db, 'nobetler', id);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('edit-nobet-id').value = id;
            document.getElementById('edit-nobet-tarih').value = data.tarih;
            document.getElementById('edit-nobet-personel').value = data.personelId;
            document.getElementById('edit-nobet-yeri').value = data.nobetYeriId;
            modal.classList.add('open');
        } else {
            showToast('NÃ¶bet kaydÄ± bulunamadÄ±.', 'error');
        }
    } catch (error) {
        console.error("NÃ¶bet dÃ¼zenleme verisi Ã§ekilirken hata:", error);
        showToast('Veri yÃ¼klenemedi.', 'error');
    }
}

async function saveNobetChanges() {
    const modal = document.getElementById('edit-nobet-modal');
    const id = document.getElementById('edit-nobet-id').value;
    const updatedData = {
        tarih: document.getElementById('edit-nobet-tarih').value,
        personelId: document.getElementById('edit-nobet-personel').value,
        nobetYeriId: document.getElementById('edit-nobet-yeri').value,
    };

    if (!updatedData.tarih || !updatedData.personelId || !updatedData.nobetYeriId) {
        return showToast('LÃ¼tfen tÃ¼m alanlarÄ± doldurun.', 'error');
    }

    try {
        await setDoc(doc(db, 'nobetler', id), updatedData);
        showToast('NÃ¶bet kaydÄ± baÅŸarÄ±yla gÃ¼ncellendi.');
        modal.classList.remove('open');
        // Raporu gÃ¼ncel haliyle yeniden Ã§iz
        const year = parseInt(document.getElementById('rapor-yil-gir').value);
        const month = parseInt(document.getElementById('rapor-ay-sec').value);
        await renderNobetRaporu(year, month);
    } catch (error) {
        console.error("NÃ¶bet gÃ¼ncellenirken hata:", error);
        showToast('GÃ¼ncelleme sÄ±rasÄ±nda bir hata oluÅŸtu.', 'error');
    }
}
// ==========================================================
// YERÄ°NE EKLENECEK YENÄ° VE DOÄRU Ã‡ALIÅAN FONKSÄ°YON
// ==========================================================
async function copyNobetSchedule() {
    const sourceYear = parseInt(document.getElementById('copy-source-year').value);
    const sourceMonth = parseInt(document.getElementById('copy-source-month').value);
    const destYear = parseInt(document.getElementById('copy-dest-year').value);
    const destMonth = parseInt(document.getElementById('copy-dest-month').value);

    if (sourceYear === destYear && sourceMonth === destMonth) {
        return showToast('Kaynak ve hedef ay aynÄ± olamaz.', 'error');
    }
    const kaynakAyAdi = document.getElementById('copy-source-month').options[sourceMonth].text;
    const hedefAyAdi = document.getElementById('copy-dest-month').options[destMonth].text;
    if (!confirm(`${kaynakAyAdi} ${sourceYear} ayÄ±ndaki nÃ¶bet dÃ¼zenini, ${hedefAyAdi} ${destYear} ayÄ±na kopyalamak istediÄŸinizden emin misiniz?`)) {
        return;
    }
    
    showToast('AkÄ±llÄ± kopyalama iÅŸlemi baÅŸlatÄ±ldÄ±...', 'info');

    // AdÄ±m 1: Kaynak aydaki nÃ¶betleri Ã§ek ve hafta gÃ¼nlerine gÃ¶re BENZERSÄ°Z bir ÅŸablon oluÅŸtur.
    const sourceStartDate = new Date(Date.UTC(sourceYear, sourceMonth, 1)).toISOString().split('T')[0];
    const sourceEndDate = new Date(Date.UTC(sourceYear, sourceMonth + 1, 1)).toISOString().split('T')[0];
    const q = query(collection(db, 'nobetler'), where('tarih', '>=', sourceStartDate), where('tarih', '<', sourceEndDate));
    
    const nobetSnap = await getDocs(q);
    if (nobetSnap.empty) {
        return showToast('Kaynak ayda kopyalanacak nÃ¶bet kaydÄ± bulunamadÄ±.', 'error');
    }

    // rosterTemplate[1] -> Pazartesi gÃ¶revlileri, rosterTemplate[5] -> Cuma gÃ¶revlileri
    const rosterTemplate = { 1: new Set(), 2: new Set(), 3: new Set(), 4: new Set(), 5: new Set() };

    nobetSnap.forEach(doc => {
        const nobet = doc.data();
        // Saat dilimi sorunlarÄ±nÄ± Ã¶nlemek iÃ§in tarihi UTC olarak ele alÄ±yoruz.
        const tarihUTC = new Date(nobet.tarih + 'T00:00:00Z');
        const dayOfWeek = tarihUTC.getUTCDay(); // 0=Pazar, 1=Pazartesi, ..., 6=Cumartesi

        // Sadece hafta iÃ§i (Pzt-Cuma) nÃ¶betlerini dikkate al
        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
            // MÃ¼kerrer kaydÄ± Ã¶nlemek iÃ§in Set'e personel ve yer bilgisini ekle
            const dutyIdentifier = JSON.stringify({ p: nobet.personelId, y: nobet.nobetYeriId });
            rosterTemplate[dayOfWeek].add(dutyIdentifier);
        }
    });

    // AdÄ±m 2: Hedef aydaki tÃ¼m gÃ¼nleri gez ve ÅŸablonu uygula
    let kopyalananKayitSayisi = 0;
    const promises = [];
    const daysInDestMonth = new Date(destYear, destMonth + 1, 0).getDate();

    for (let day = 1; day <= daysInDestMonth; day++) {
        const hedefTarihUTC = new Date(Date.UTC(destYear, destMonth, day));
        const dayOfWeek = hedefTarihUTC.getUTCDay();

        // EÄŸer gÃ¼n hafta sonuysa (Pazar veya Cumartesi) veya o gÃ¼ne ait ÅŸablon boÅŸsa atla
        if (dayOfWeek === 0 || dayOfWeek === 6 || !rosterTemplate[dayOfWeek] || rosterTemplate[dayOfWeek].size === 0) {
            continue;
        }

        // Åablondaki her bir nÃ¶betÃ§iyi bu gÃ¼ne ata
        rosterTemplate[dayOfWeek].forEach(dutyJson => {
            const dutyInfo = JSON.parse(dutyJson);
            const yeniNobet = {
                personelId: dutyInfo.p,
                nobetYeriId: dutyInfo.y,
                tarih: hedefTarihUTC.toISOString().split('T')[0]
            };
            promises.push(addDoc(collection(db, 'nobetler'), yeniNobet));
            kopyalananKayitSayisi++;
        });
    }

    if (kopyalananKayitSayisi === 0) {
        return showToast('Kaynak aydaki nÃ¶betlerle eÅŸleÅŸen, hedef ayda uygun bir gÃ¼n bulunamadÄ±.', 'info');
    }

    try {
        await Promise.all(promises);
        showToast(`${kopyalananKayitSayisi} nÃ¶bet kaydÄ± baÅŸarÄ±yla kopyalandÄ±!`, 'success');
        // Raporu kopyalanan aya ayarla ve yenile
        document.getElementById('rapor-ay-sec').value = destMonth;
        document.getElementById('rapor-yil-gir').value = destYear;
        renderNobetRaporu(destYear, destMonth);
    } catch (error) {
        console.error("Kopyalama sÄ±rasÄ±nda hata:", error);
        showToast('NÃ¶betler kopyalanÄ±rken bir hata oluÅŸtu.', 'error');
    }
}
async function openIzinEditModal(izinId) {
    const modal = document.getElementById('edit-izin-modal');
    const form = document.getElementById('edit-izin-form');
    
    try {
        const izinDoc = await getDoc(doc(db, 'izinler', izinId));
        if (!izinDoc.exists()) {
            showToast('DÃ¼zenlenecek izin kaydÄ± bulunamadÄ±.', 'error');
            return;
        }
        const izinData = izinDoc.data();

        // Formu doldur
        form.querySelector('#edit-izin-id').value = izinId;
        form.querySelector('#edit-izin-baslangic').value = izinData.baslangicTarihi;
        form.querySelector('#edit-izin-bitis').value = izinData.bitisTarihi;
        form.querySelector('#edit-izin-aciklama').value = izinData.aciklama || '';

        const personelSelect = form.querySelector('#edit-izin-personel');
        const izinTipiSelect = form.querySelector('#edit-izin-tipi');

        // Personel adÄ±nÄ± getir ve seÃ§ili yap (deÄŸiÅŸtirilemez)
        const personelDoc = await getDoc(doc(db, 'personel', izinData.personelId));
        personelSelect.innerHTML = `<option>${personelDoc.exists() ? personelDoc.data().ad_soyad : 'Bilinmeyen Personel'}</option>`;
        
        // Ä°zin tiplerini doldur ve mevcut olanÄ± seÃ§ili yap
        const izinTipiSnap = await getSettings('ayarlar_izin_tipleri');
        izinTipiSelect.innerHTML = '<option value="">Ä°zin Tipi SeÃ§iniz...</option>';
        izinTipiSnap.forEach(doc => izinTipiSelect.add(new Option(doc.data().name, doc.id)));
        izinTipiSelect.value = izinData.izinTipiId;

        modal.classList.add('open');
    } catch (error) {
        console.error("Ä°zin dÃ¼zenleme penceresi aÃ§Ä±lÄ±rken hata:", error);
        showToast('Veriler yÃ¼klenirken bir hata oluÅŸtu.', 'error');
    }
}
let izinTakipInitialized = false;
// MEVCUT initializeIzinTakip FONKSÄ°YONUNU BU BLOK Ä°LE KOMPLE DEÄÄ°ÅTÄ°RÄ°N
async function initializeIzinTakip() {
    if (izinTakipInitialized) return;
    izinTakipInitialized = true;

    const personelSelect = document.getElementById('izin-personel');
    const izinTipiSelect = document.getElementById('izin-tipi');
    const baslangicInput = document.getElementById('izin-baslangic');
    const bitisInput = document.getElementById('izin-bitis');
    const kaydetBtn = document.getElementById('izin-kaydet-btn');
    const tbody = document.getElementById('izin-kayitlari-tbody');
    const izinHakkiDiv = document.getElementById('personel-izin-hakki');
    const hesaplamaSonucuDiv = document.getElementById('izin-hesaplama-sonucu');

    const [personelSnap, izinTipiSnap] = await Promise.all([
        getDocs(query(collection(db, 'personel'), orderBy('ad_soyad'))),
        getSettings('ayarlar_izin_tipleri')
    ]);
    const staffListForLeave = personelSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    personelSelect.innerHTML = '<option value="">Personel SeÃ§iniz...</option>';
    staffListForLeave.forEach(p => personelSelect.add(new Option(p.ad_soyad, p.id)));
    izinTipiSelect.innerHTML = '<option value="">Ä°zin Tipi SeÃ§iniz...</option>';
    izinTipiSnap.forEach(doc => izinTipiSelect.add(new Option(doc.data().name, doc.id)));

    function updateIzinHesaplamalari() {
        const personelId = personelSelect.value;
        const baslangicTarihi = baslangicInput.value;
        const bitisTarihi = bitisInput.value;
        const seciliPersonel = staffListForLeave.find(p => p.id === personelId);

        if (seciliPersonel) {
            const hakEdilenGun = calculateYillikIzinHakki(seciliPersonel.ise_giris);
            izinHakkiDiv.innerHTML = `Personelin yasal izin hakkÄ±: <strong>${hakEdilenGun} iÅŸ gÃ¼nÃ¼</strong>`;
        } else {
            izinHakkiDiv.innerHTML = 'Yasal izin hakkÄ± iÃ§in personel seÃ§iniz.';
        }

        if (baslangicTarihi && bitisTarihi && seciliPersonel) {
            if (new Date(bitisTarihi) < new Date(baslangicTarihi)) {
                hesaplamaSonucuDiv.style.color = 'var(--danger-color)';
                hesaplamaSonucuDiv.innerHTML = 'BitiÅŸ tarihi baÅŸlangÄ±Ã§tan Ã¶nce olamaz!';
                return;
            }
            // DEÄÄ°ÅÄ°KLÄ°K BURADA: Fonksiyona artÄ±k 'seciliPersonel' nesnesini de gÃ¶nderiyoruz.
            const netGun = calculateNetIzinSuresi(baslangicTarihi, bitisTarihi, seciliPersonel);
            hesaplamaSonucuDiv.style.color = '#0056b3';
            hesaplamaSonucuDiv.innerHTML = `KullanÄ±lacak net izin sÃ¼resi: <strong>${netGun} iÅŸ gÃ¼nÃ¼</strong>`;
        } else {
            hesaplamaSonucuDiv.innerHTML = 'Net sÃ¼re iÃ§in personel ve tarih aralÄ±ÄŸÄ± seÃ§iniz.';
        }
    }

    personelSelect.addEventListener('change', updateIzinHesaplamalari);
    baslangicInput.addEventListener('change', updateIzinHesaplamalari);
    bitisInput.addEventListener('change', updateIzinHesaplamalari);
    
    await renderIzinKayitlari();

    kaydetBtn.addEventListener('click', async () => {
        const personelId = personelSelect.value;
        const izinTipiId = izinTipiSelect.value;
        const baslangicTarihi = baslangicInput.value;
        const bitisTarihi = bitisInput.value;
        const aciklama = document.getElementById('izin-aciklama').value.trim();

        if (!personelId || !izinTipiId || !baslangicTarihi || !bitisTarihi) {
            return showToast('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun.', 'error');
        }
        if (new Date(bitisTarihi) < new Date(baslangicTarihi)) {
            return showToast('BitiÅŸ tarihi baÅŸlangÄ±Ã§ tarihinden Ã¶nce olamaz.', 'error');
        }
        
        await addDoc(collection(db, 'izinler'), { personelId, izinTipiId, baslangicTarihi, bitisTarihi, aciklama, olusturmaTuru: 'manuel' });
        showToast('Ä°zin baÅŸarÄ±yla kaydedildi.');
        await renderIzinKayitlari();
        
        personelSelect.value = '';
        izinTipiSelect.value = '';
        baslangicInput.value = '';
        bitisInput.value = '';
        document.getElementById('izin-aciklama').value = '';
        updateIzinHesaplamalari();
    });

    tbody.addEventListener('click', async (e) => {
        const target = e.target;
        if (!target.dataset.id) return;
        const id = target.dataset.id;
        
        // =======================================================
        // YENÄ° DÃœZENLEME KODU BURADA OLMALI
        // =======================================================
        if (target.classList.contains('btn-edit-izin')) {
            openIzinEditModal(id);
        }
        // =======================================================

        // SÄ°ZÄ°N PAYLAÅTIÄINIZ VE SÄ°LÄ°NMEYECEK OLAN "SÄ°L" KODU
        if (target.classList.contains('btn-delete-izin')) {
            if (confirm('Bu izin kaydÄ±nÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?')) {
                try {
                    await deleteDoc(doc(db, 'izinler', id));
                    showToast('Ä°zin kaydÄ± baÅŸarÄ±yla silindi.');
                    await renderIzinKayitlari();
                } catch (err) {
                    showToast('Silme iÅŸlemi sÄ±rasÄ±nda bir hata oluÅŸtu.', 'error');
                    console.error("Ä°zin silme hatasÄ±:", err);
                }
            }
        }

        if (target.classList.contains('btn-print-dilekce')) {
            const modal = document.getElementById('dilekce-date-modal');
            const dateInput = document.getElementById('dilekce-tarih-input');
            const generateBtn = document.getElementById('generate-dilekce-with-date-btn');
            const closeModalBtn = modal.querySelector('.close-modal');

            dateInput.valueAsDate = new Date();
            generateBtn.dataset.izinId = id;

            modal.classList.add('open');

            const handleGenerateClick = async () => {
                const dilekceTarihi = dateInput.value;
                const izinIdForDilekce = generateBtn.dataset.izinId;
                if (!dilekceTarihi) {
                    showToast('LÃ¼tfen bir dilekÃ§e tarihi seÃ§in.', 'error');
                    return;
                }
                await generateDilekce(izinIdForDilekce, dilekceTarihi);
                modal.classList.remove('open');
            };

            generateBtn.addEventListener('click', handleGenerateClick, { once: true });

            closeModalBtn.onclick = () => {
                modal.classList.remove('open');
                generateBtn.removeEventListener('click', handleGenerateClick);
            };
        }
    });
}


const editForm = document.getElementById('edit-izin-form');
    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = editForm.querySelector('#edit-izin-id').value;
        const updatedData = {
            izinTipiId: editForm.querySelector('#edit-izin-tipi').value,
            baslangicTarihi: editForm.querySelector('#edit-izin-baslangic').value,
            bitisTarihi: editForm.querySelector('#edit-izin-bitis').value,
            aciklama: editForm.querySelector('#edit-izin-aciklama').value.trim()
        };

        if (!updatedData.izinTipiId || !updatedData.baslangicTarihi || !updatedData.bitisTarihi) {
            return showToast('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun.', 'error');
        }
        
        try {
            const izinRef = doc(db, 'izinler', id);
            await setDoc(izinRef, updatedData, { merge: true }); // merge:true ile personelId korunur
            showToast('Ä°zin kaydÄ± baÅŸarÄ±yla gÃ¼ncellendi.');
            document.getElementById('edit-izin-modal').classList.remove('open');
            await renderIzinKayitlari();
        } catch (error) {
            console.error("Ä°zin gÃ¼ncelleme hatasÄ±:", error);
            showToast('GÃ¼ncelleme sÄ±rasÄ±nda bir hata oluÅŸtu.', 'error');
        }
    });
    
    // DÃ¼zenleme penceresi kapatma butonlarÄ±
    const editModal = document.getElementById('edit-izin-modal');
    editModal.querySelector('.close-modal').addEventListener('click', () => editModal.classList.remove('open'));
    editModal.addEventListener('click', (e) => {
        if (e.target === editModal) editModal.classList.remove('open');
    });

    

async function openTopluIzinModal() {
    const modal = document.getElementById('toplu-izin-modal');
    const personelListContainer = document.getElementById('toplu-personel-listesi');
    const izinTipiSelect = document.getElementById('toplu-izin-tipi');

    personelListContainer.innerHTML = '<p>Personel listesi yÃ¼kleniyor...</p>';
    izinTipiSelect.innerHTML = '<option value="">YÃ¼kleniyor...</option>';

    try {
        const [personelSnap, izinTipiSnap] = await Promise.all([
            getDocs(query(collection(db, 'personel'), orderBy('ad_soyad'))),
            getSettings('ayarlar_izin_tipleri')
        ]);

        personelListContainer.innerHTML = '';
        if(personelSnap.empty) {
            personelListContainer.innerHTML = '<p>Sistemde kayÄ±tlÄ± personel bulunamadÄ±.</p>';
        } else {
            personelSnap.forEach(doc => {
                const p = doc.data();
                const personelDiv = document.createElement('div');
                personelDiv.style.cssText = 'display: flex; align-items: center;';
                personelDiv.innerHTML = `
                    <input type="checkbox" id="p-check-${doc.id}" value="${doc.id}" style="width:auto; margin-right: 10px; flex-shrink: 0;">
                    <label for="p-check-${doc.id}" style="margin-bottom:0; font-weight: normal; cursor:pointer;">${p.ad_soyad}</label>
                `;
                personelListContainer.appendChild(personelDiv);
            });
        }

        izinTipiSelect.innerHTML = '<option value="">Ä°zin Tipi SeÃ§iniz...</option>';
        if(!izinTipiSnap.empty) {
                izinTipiSnap.forEach(doc => {
                izinTipiSelect.add(new Option(doc.data().name, doc.id));
            });
        }

        modal.classList.add('open');

    } catch (error) {
        console.error("Toplu izin modalÄ± hazÄ±rlanÄ±rken hata:", error);
        showToast('Gerekli veriler yÃ¼klenemedi.', 'error');
    }
}

async function saveTopluIzin() {
    const baslangicTarihi = document.getElementById('toplu-izin-baslangic').value;
    const bitisTarihi = document.getElementById('toplu-izin-bitis').value;
    const izinTipiId = document.getElementById('toplu-izin-tipi').value;
    const personelCheckboxes = document.querySelectorAll('#toplu-personel-listesi input[type="checkbox"]:checked');

    if (!baslangicTarihi || !bitisTarihi || !izinTipiId) {
        return showToast('LÃ¼tfen baÅŸlangÄ±Ã§/bitiÅŸ tarihi ve izin tipi seÃ§in.', 'error');
    }
    if (new Date(bitisTarihi) < new Date(baslangicTarihi)) {
        return showToast('BitiÅŸ tarihi baÅŸlangÄ±Ã§ tarihinden Ã¶nce olamaz.', 'error');
    }
    if (personelCheckboxes.length === 0) {
        return showToast('LÃ¼tfen en az bir personel seÃ§in.', 'error');
    }

    const seciliPersonelIDs = Array.from(personelCheckboxes).map(cb => cb.value);
    showToast(`${seciliPersonelIDs.length} personel iÃ§in izinler kaydediliyor...`, 'info');

    const promises = seciliPersonelIDs.map(personelId => {
        const yeniIzin = {
            personelId: personelId,
            izinTipiId: izinTipiId,
            baslangicTarihi: baslangicTarihi,
            bitisTarihi: bitisTarihi,
            aciklama: 'Toplu olarak eklendi.',
            olusturmaTuru: 'toplu'
        };
        return addDoc(collection(db, 'izinler'), yeniIzin);
    });

    try {
        await Promise.all(promises);
        showToast(`${seciliPersonelIDs.length} personelin izin kaydÄ± baÅŸarÄ±yla oluÅŸturuldu.`, 'success');
        document.getElementById('toplu-izin-modal').classList.remove('open');
        await renderIzinKayitlari();
    } catch (error) {
        console.error("Toplu izinler kaydedilirken hata:", error);
        showToast('KayÄ±t sÄ±rasÄ±nda bir hata oluÅŸtu.', 'error');
    }
}

// BU Ä°KÄ° YENÄ° FONKSÄ°YONU EKLEYÄ°N

/**
 * Personelin iÅŸe giriÅŸ tarihine gÃ¶re yÄ±llÄ±k Ã¼cretli izin hakkÄ±nÄ± hesaplar.
 * @param {string} iseGirisTarihi - Personelin 'YYYY-MM-DD' formatÄ±ndaki iÅŸe giriÅŸ tarihi.
 * @returns {number} Hak edilen yÄ±llÄ±k izin gÃ¼nÃ¼ sayÄ±sÄ±.
 */
function calculateYillikIzinHakki(iseGirisTarihi) {
    if (!iseGirisTarihi) return 0;
    const iseGiris = new Date(iseGirisTarihi);
    const bugun = new Date();
    const kidemMs = bugun.getTime() - iseGiris.getTime();
    const kidemYil = kidemMs / (1000 * 60 * 60 * 24 * 365.25);

    if (kidemYil >= 1 && kidemYil < 5) return 14;
    if (kidemYil >= 5 && kidemYil < 15) return 20;
    if (kidemYil >= 15) return 26;
    return 0; // 1 yÄ±ldan az kÄ±demi olanlar iÃ§in
}

/**
/**
 * Ä°ki tarih arasÄ±ndaki net iÅŸ gÃ¼nÃ¼ sayÄ±sÄ±nÄ± personelin sÃ¶zleÅŸme tÃ¼rÃ¼ne gÃ¶re hesaplar.
 * Belirsiz SÃ¼reli iÃ§in sadece Pazar, Belirli SÃ¼reli iÃ§in Cmt/Paz tatil kabul edilir.
 * @param {string} startDateStr - BaÅŸlangÄ±Ã§ tarihi 'YYYY-MM-DD'.
 * @param {string} endDateStr - BitiÅŸ tarihi 'YYYY-MM-DD'.
 * @param {object} personel - HakkÄ±nda hesaplama yapÄ±lan personelin nesnesi. sozlesme_turu iÃ§ermelidir.
 * @returns {number} Net izin gÃ¼nÃ¼ sayÄ±sÄ±.
 */
// BU YENÄ° FONKSÄ°YONU EKLEYÄ°N
function calculateNetIzinSuresi(startDateStr, endDateStr, personel, izinTipiKodu) {
    if (!startDateStr || !endDateStr || !personel) return 0;

    const startDate = new Date(startDateStr + 'T00:00:00');
    const endDate = new Date(endDateStr + 'T00:00:00');

    if (endDate < startDate) return 0;
    
    // YENÄ° KURAL: EÄŸer izin tipi Raporlu (R) veya Ãœcretsiz Ä°zin (UI) ise,
    // hafta sonu/resmi tatil dinlemeden tÃ¼m takvim gÃ¼nlerini say.
    // DÃ¼zeltme: 'UI' kontrolÃ¼, 'ÃœÄ°' olarak gÃ¼ncellendi.
    if (izinTipiKodu === 'R' || izinTipiKodu === 'ÃœÄ°') {
        const diffTime = Math.abs(endDate - startDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        return diffDays;
    } 
    // DiÄŸer tÃ¼m izin tÃ¼rleri iÃ§in (YÄ±llÄ±k Ä°zin vb.) eski iÅŸ gÃ¼nÃ¼ hesaplama mantÄ±ÄŸÄ± devam eder.
    else {
        let netGunSayisi = 0;
        let mevcutTarih = new Date(startDate);

        while (mevcutTarih <= endDate) {
            const dayOfWeek = mevcutTarih.getDay();
            let isWeekend = false;

            if (personel.sozlesme_turu === 'Belirli SÃ¼reli') {
                if (dayOfWeek === 0 || dayOfWeek === 6) isWeekend = true;
            } else {
                if (dayOfWeek === 0) isWeekend = true;
            }

            if (!isWeekend && !isResmiTatil(mevcutTarih)) {
                netGunSayisi++;
            }
            mevcutTarih.setDate(mevcutTarih.getDate() + 1);
        }
        return netGunSayisi;
    }
}
// BU FONKSÄ°YONUN TAMAMINI YENÄ°SÄ°YLE DEÄÄ°ÅTÄ°RÄ°N
async function renderIzinKayitlari() {
    const tbody = document.getElementById('izin-kayitlari-tbody');
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Ä°zin kayÄ±tlarÄ± yÃ¼kleniyor...</td></tr>`;

    const [izinSnap, personelSnap, izinTipiSnap] = await Promise.all([
        getDocs(query(collection(db, 'izinler'), orderBy('baslangicTarihi', 'desc'))),
        getDocs(collection(db, 'personel')),
        getSettings('ayarlar_izin_tipleri')
    ]);
    
    // GÃœNCELLEME 1: ArtÄ±k sadece izin adÄ±nÄ± deÄŸil, kodunu da iÃ§eren tÃ¼m veriyi saklÄ±yoruz.
    const izinTipiDataMap = new Map(izinTipiSnap.docs.map(doc => [doc.id, doc.data()]));
    const personelDataMap = new Map(personelSnap.docs.map(doc => [doc.id, { id: doc.id, ...doc.data() }]));

    if (izinSnap.empty) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">KayÄ±tlÄ± izin bulunamadÄ±.</td></tr>`;
        return;
    }

    tbody.innerHTML = '';
    izinSnap.forEach(doc => {
        const izin = doc.data();
        const personel = personelDataMap.get(izin.personelId);
        
        if (!personel) {
            console.warn(`ID'si ${doc.id} olan izin kaydÄ±na baÄŸlÄ± personel (${izin.personelId}) bulunamadÄ±. Listede gÃ¶sterilmeyecek.`);
            return;
        }

        const baslangic = new Date(izin.baslangicTarihi + 'T00:00:00');
        const bitis = new Date(izin.bitisTarihi + 'T00:00:00');
        
        // GÃœNCELLEME 2: Ä°zin tipinin kodunu haritadan alÄ±yoruz.
        const izinTipi = izinTipiDataMap.get(izin.izinTipiId);
        const izinTipiKodu = izinTipi ? izinTipi.kod : '';
        // SÃ¼re hesaplanÄ±rken izin kodunu da gÃ¶nderiyoruz.
        const sure = calculateNetIzinSuresi(izin.baslangicTarihi, izin.bitisTarihi, personel, izinTipiKodu);
        
        // GÃœNCELLEME 3: Ä°zin koduna gÃ¶re doÄŸru etiketi ("gÃ¼n" veya "iÅŸ gÃ¼nÃ¼") seÃ§iyoruz.
        const sureEtiketi = (izinTipiKodu === 'R' || izinTipiKodu === 'ÃœÄ°') ? 'gÃ¼n' : 'iÅŸ gÃ¼nÃ¼';
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${personel.ad_soyad || 'Bilinmiyor'}</td>
            <td>${izinTipi ? izinTipi.name : 'Bilinmiyor'}</td>
            <td>${baslangic.toLocaleDateString('tr-TR')}</td>
            <td>${bitis.toLocaleDateString('tr-TR')}</td>
            <td>${sure} ${sureEtiketi}</td> <td>${izin.aciklama || '-'}</td>
            <td class="actions-cell">
    <td class="actions-cell">
    <button class="btn btn-print-dilekce" data-id="${doc.id}" style="background-color:#0dcaf0;">DilekÃ§e</button>
    <button class="btn btn-edit btn-edit-izin" data-id="${doc.id}">DÃ¼zenle</button>
    <button class="btn btn-delete-izin btn-delete" data-id="${doc.id}">Sil</button>
</td>
        `;
    });
}


async function generateDilekce(izinId, dilekceTarihiStr) {
    const izinDoc = await getDoc(doc(db, 'izinler', izinId));
    if (!izinDoc.exists()) {
        showToast('Ä°zin kaydÄ± bulunamadÄ±.', 'error');
        return;
    }
    const izin = izinDoc.data();

    const [personelDoc, izinTipiDoc, gorevSnap] = await Promise.all([
        getDoc(doc(db, 'personel', izin.personelId)),
        getDoc(doc(db, 'ayarlar_izin_tipleri', izin.izinTipiId)),
        getSettings('ayarlar_gorevler')
    ]);

    if (!personelDoc.exists() || !izinTipiDoc.exists()) {
        showToast('Personel veya Ä°zin Tipi tanÄ±mÄ± bulunamadÄ±.', 'error');
        return;
    }

    const personel = personelDoc.data();
    const izinTipi = izinTipiDoc.data();
    const gorevMap = new Map(gorevSnap.docs.map(doc => [doc.id, doc.data().name]));
    const iseBaslama = new Date(izin.bitisTarihi + 'T00:00:00');
    iseBaslama.setDate(iseBaslama.getDate() + 1);

    const baslangicTR = formatDateDDMMYYYY(izin.baslangicTarihi);
    const bitisTR = formatDateDDMMYYYY(izin.bitisTarihi);
    const iseBaslamaTR = iseBaslama.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const iseGirisTR = formatDateDDMMYYYY(personel.ise_giris);
    const dilekceTarihiTR = formatDateDDMMYYYY(dilekceTarihiStr);
    const gorevi = gorevMap.get(personel.gorevi_bransi) || 'BelirtilmemiÅŸ';
    const baslangicYili = new Date(izin.baslangicTarihi + 'T00:00:00').getFullYear();

    let izinIstekMetni = `Okulunuzdaki ${baslangicYili} yÄ±lÄ±na ait yÄ±llÄ±k Ã¼cretli iznimi, ${baslangicTR} tarihinden itibaren kullanmak istiyorum.`;
    if (!izinTipi.name.toLowerCase().includes('yÄ±llÄ±k')) {
        izinIstekMetni = `${izin.aciklama || 'Mazeretimden'} dolayÄ± ${baslangicTR} - ${bitisTR} tarihleri arasÄ±nda izinli sayÄ±lmamÄ± talep ediyorum.`;
    }

    const dilekceHTML = `
        <!DOCTYPE html><html lang="tr"><head><meta charset="UTF-8"><title>Ä°zin Formu - ${personel.ad_soyad}</title>
        <style>
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 11pt; margin: 1.0cm; line-height: 1.3; }
            h2, .header-section { text-align: center; }
            .info-table, .footer-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
            .info-table td { padding: 8px; border: 1px solid #ccc; }
            .info-table td:first-child { width: 180px; font-weight: bold; background-color: #f2f2f2; }
            .footer-table td { text-align: left; padding: 8px 4px; }
            .footer-table td:nth-child(2) { font-weight: bold; }
            .content { text-indent: 1.5em; margin-bottom: 25px; }
            .date-signature-block { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40px; }


.date-signature-block { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40px; }
.approval-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; text-align: center; }
        </style></head><body>
            <div>
                <h2>${izinTipi.name.toLocaleUpperCase('tr-TR')} Ä°STEK FORMU</h2>
                <div class="header-section"><h3>Ã–ZEL Ä°SABET ORTAOKULU MÃœDÃœRLÃœÄÃœNE</h3></div>
                <p style="text-align:right;">TAVÅANLI</p>
                
                <table class="info-table">
                    <tr><td>ADI SOYADI</td><td>: ${personel.ad_soyad || ''}</td></tr>
                    <tr><td>T.C. KÄ°MLÄ°K NO</td><td>: ${personel.tc_kimlik_no || ''}</td></tr>
                    <tr><td>SGK NO</td><td>: ${personel.sgk_no || ''}</td></tr>
                    <tr><td>Ä°ÅE GÄ°RÄ°Å TARÄ°HÄ°</td><td>: ${iseGirisTR}</td></tr>
                    <tr><td>GÃ–REVÄ°</td><td>: ${gorevi}</td></tr>
                    <tr><td>GÃ–REV YERÄ° ADRESÄ°</td><td>: HanÄ±mÃ§eÅŸme Mah. GÃ¼ndÃ¼z Sokak No:13 TAVÅANLI/KÃœTAHYA</td></tr>
                </table>

                <p class="content">${izinIstekMetni}</p>
                <p>GereÄŸini arz ederim.</p>

                <div class="date-signature-block">
                    <div><b>Tarih: ${dilekceTarihiTR}</b></div>
                    <div>
                        Ä°zin Talep Eden<br><br>
                        ${personel.ad_soyad}<br>
                        (Ä°mza)
                    </div>
                </div>

                <div class="approval-section">
                    <p>YukarÄ±da belirtilen tarihlerde ${izinTipi.name.toLowerCase()} kullanmasÄ± uygundur.</p>
                    <div style="margin-top: 50px;">Okul MÃ¼dÃ¼rÃ¼<br>(Ä°mza)</div>
                </div>

                <h4 style="margin-top: 50px; margin-bottom: 15px; border-bottom: 1px solid #000; padding-bottom: 5px;">Ä°zin BÃ¶lÃ¼mÃ¼nce Doldurulacak</h4>
                <table class="footer-table">
                    <tr>
                        <td>Ä°zine Ã‡Ä±kÄ±ÅŸ Tarihi</td><td>: ${baslangicTR}</td><td>Ä°mza:</td>
                    </tr>
                    <tr>
                        <td>Ä°zin BitiÅŸ Tarihi</td><td>: ${bitisTR}</td><td>Ä°mza:</td>
                    </tr>
                    <tr>
                        <td>Ä°ÅŸe BaÅŸlama Tarihi</td><td>: ${iseBaslamaTR}</td><td>Ä°mza:</td>
                    </tr>
                </table>
            </div>
        </body></html>`;

    const win = window.open('', '_blank');
    win.document.write(dilekceHTML);
    win.document.close();
    setTimeout(() => win.print(), 500);
}

// --- PUANTAJ CETVELÄ° YÃ–NETÄ°MÄ° ---


/**
 * Verilen metni (isim, unvan vb.) boÅŸluk karakterlerinden bÃ¶lerek
 * HTML'de alt satÄ±ra geÃ§meyi saÄŸlayan <br> etiketi ile birleÅŸtirir.
 * @param {string} text - BiÃ§imlendirilecek metin.
 * @returns {string} HTML formatÄ±nda alt alta yazÄ±lmÄ±ÅŸ metin.
 */
function formatTextForWrapping(text) {
    if (!text) return '';
    return text.replace(/ /g, '<br>');
}

/**
 * Puantaj verilerini kullanarak HTML tablosunu oluÅŸturur ve ekranda gÃ¶sterir.
 * Her personel iÃ§in iki ayrÄ± satÄ±r (durum ve saat) oluÅŸturur.
 * @param {object} nobetVerisi - Personellerin aylÄ±k nÃ¶bet saatlerini iÃ§eren nesne.
 */

// LÃœTFEN MEVCUT ÃœÃ‡ FONKSÄ°YONU SÄ°LÄ°P, YERÄ°NE BU BLOÄUN TAMAMINI YAPIÅTIRIN

// --- 1. FONKSÄ°YON: PUANTAJ DÃœZENLEME PENCERESÄ° ---
// Bu fonksiyon, manuel dÃ¼zenleme yaptÄ±ÄŸÄ±nÄ±zda aÃ§Ä±lan pencerenin doÄŸru Ã§alÄ±ÅŸmasÄ±nÄ± saÄŸlar.
function initializePuantaj() {
    if (puantajInitialized) {
        loadPuantajDataForCurrentMonth();
        return;
    }

    try {
        const personelSnap = getDocs(collection(db, "personel"));
        const gorevSnap = getSettings('ayarlar_gorevler');
        const neviSnap = getSettings('ayarlar_personel_nevileri');

        Promise.all([personelSnap, gorevSnap, neviSnap]).then(async ([personelDocs, gorevDocs, neviDocs]) => {
            const gorevMap = new Map(gorevDocs.docs.map(doc => [doc.id, doc.data().name]));
            const neviMap = new Map(neviDocs.docs.map(doc => [doc.id, doc.data().name]));
            puantajPersonelList = personelDocs.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id, ad: data.ad_soyad || 'Ä°simsiz', unvan: gorevMap.get(data.gorevi_bransi) || 'BelirtilmemiÅŸ',
                    neviAdi: neviMap.get(data.personel_nevisi) || 'Bilinmiyor', maasKarsiligi: parseInt(data.maas_karsiligi) || 20,
                    rehberlik_gorevi: data.rehberlik_gorevi || 'hayir', esDurumu: data.es_durumu, cocuk0_6: data.cocuk_0_6,
                    cocuk6_18: data.cocuk_6_ustu, sozlesme_turu: data.sozlesme_turu || 'Belirsiz SÃ¼reli', ise_giris: data.ise_giris || '---',
                    isten_ayrilis: data.isten_ayrilis || '---', kismi_zamanli_calisma: data.kismi_zamanli_calisma || {}
                };
            });



                puantajPersonelList.sort((a, b) => a.ad.localeCompare(b.ad, 'tr'));
                const selectMonth = document.getElementById('select-month'),
                inputYear = document.getElementById('input-year'),
                showBtn = document.getElementById('btn-show-puantaj'),
                generateBtn = document.getElementById('btn-generate'),
                printBtn = document.getElementById('btn-print'),
                deleteBtn = document.getElementById('btn-delete-puantaj'),
                pdfBtn = document.getElementById('btn-pdf'),
                excelBtn = document.getElementById('btn-excel'),
                modalOverlay = document.getElementById('edit-modal-overlay'),
                modalSaveBtn = document.getElementById('modal-save'),
                modalCancelBtn = document.getElementById('modal-cancel'),
                savePuantajBtn = document.getElementById('btn-save-puantaj'),
                lockPuantajBtn = document.getElementById('btn-lock-puantaj');

            modalSaveBtn.addEventListener('click', saveModalChanges);
            modalCancelBtn.addEventListener('click', () => { modalOverlay.style.display = 'none'; });

            const now = new Date(), months = ["Ocak", "Åubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];
            selectMonth.innerHTML = '';
            months.forEach((m, i) => selectMonth.add(new Option(m, i)));
            selectMonth.value = now.getMonth();
            inputYear.value = now.getFullYear();

            // NÄ°HAÄ° DÃœZELTME: "Ä°zinli (Ãœcretli)" iÃ§in kod artÄ±k noktalÄ± bÃ¼yÃ¼k 'Ä°'.
            const statusCodes = { 'N': 'Normal', 'HT': 'Hafta Sonu', 'RT': 'Resmi Tatil', 'Ä°': 'Ä°zinli (Ãœcretli)', 'R': 'Raporlu', 'UI': 'Ãœcretsiz Ä°zin', 'S': 'YÄ±llÄ±k Ä°zin', 'K': 'YarÄ±m GÃ¼n Ã‡alÄ±ÅŸma', 'Y': 'YarÄ±m GÃ¼n Ã‡alÄ±ÅŸma (KÄ±smi)', 'RTÃ‡': 'Resmi Tatil Ã‡alÄ±ÅŸmasÄ±', 'E': 'Eksik GÃ¼n' };
            const modalStatusSelect = document.getElementById('modal-status');
            modalStatusSelect.innerHTML = '';
            for(const code in statusCodes) modalStatusSelect.add(new Option(statusCodes[code], code));

            if(!puantajInitialized) {
                showBtn.addEventListener('click', loadPuantajDataForCurrentMonth); generateBtn.addEventListener('click', generateInitialPuantaj);
                document.getElementById('btn-generate-individual').addEventListener('click', generateIndividualPuantaj);
                deleteBtn.addEventListener('click', deleteCurrentPuantaj);
                deleteBtn.addEventListener('click', deleteCurrentPuantaj); savePuantajBtn.addEventListener('click', savePuantajData);
                lockPuantajBtn.addEventListener('click', togglePuantajLock); document.getElementById('btn-bulk-update').addEventListener('click', applyBulkUpdate);
                printBtn.addEventListener('click', printPuantaj); pdfBtn.addEventListener('click', downloadPdf); excelBtn.addEventListener('click', downloadExcel);
                selectMonth.addEventListener('change', loadPuantajDataForCurrentMonth); inputYear.addEventListener('change', loadPuantajDataForCurrentMonth);
                const bulkUpdateDaySelect = document.getElementById('bulk-update-day');
                const bulkUpdateStatusSelect = document.getElementById('bulk-update-status');
                const daysInMonth = new Date(inputYear.value, parseInt(selectMonth.value) + 1, 0).getDate();
                bulkUpdateDaySelect.innerHTML = '';
                for (let i = 1; i <= daysInMonth; i++) { bulkUpdateDaySelect.add(new Option(i, i)); }
                bulkUpdateStatusSelect.innerHTML = '';
                for(const code in statusCodes) { bulkUpdateStatusSelect.add(new Option(`${statusCodes[code]} (${code})`, code)); }
            }
            puantajInitialized = true;
const personelFilterSelect = document.getElementById('personel-filter-select');
        personelFilterSelect.innerHTML = '<option value="all">TÃ¼m Personeli GÃ¶ster</option>';
        puantajPersonelList.forEach(personel => {
            personelFilterSelect.add(new Option(personel.ad, personel.id));
        });

        // Filtrele ve Temizle butonlarÄ±na tÄ±klama olaylarÄ±nÄ± ekler
        document.getElementById('btn-filter-personel').addEventListener('click', loadPuantajDataForCurrentMonth);
        document.getElementById('btn-clear-filter').addEventListener('click', () => {
            document.getElementById('personel-filter-select').value = 'all';
            loadPuantajDataForCurrentMonth();
        });
            await loadPuantajDataForCurrentMonth();
        });
    } catch (error) {
        console.error("Puantaj baÅŸlatÄ±lÄ±rken kritik hata:", error);
        showToast('Puantaj modÃ¼lÃ¼ baÅŸlatÄ±lamadÄ±. LÃ¼tfen AyarlarÄ±nÄ±zÄ± kontrol edin.', 'error');
    }
}


// MEVCUT FONKSÄ°YONU SÄ°LÄ°P, YERÄ°NE BU YENÄ° VERSÄ°YONU YAPIÅTIRIN
function calculateStatusCounts(personelId) {
    const personelData = puantajData[personelId];
    if (!personelData) return {};

    // DÃœZELTME: Toplamlar artÄ±k 'ÃœÄ°' harflerine gÃ¶re baÅŸlatÄ±lÄ±yor.
    const counts = { N: 0, HT: 0, RT: 0, Ä°: 0, R: 0, ÃœÄ°: 0, S: 0, K: 0, RTÃ‡: 0 };
    
    for (const date in personelData) {
        let dayCode = personelData[date].code;

        // TutarlÄ±lÄ±k iÃ§in eski 'UI' kodunu 'ÃœÄ°' olarak kabul et
        if (dayCode === 'UI') {
            dayCode = 'ÃœÄ°';
        }
        // TutarlÄ±lÄ±k iÃ§in kÃ¼Ã§Ã¼k 'Ã¼i' kodunu da 'ÃœÄ°' olarak kabul et
        if (dayCode === 'Ã¼i') {
            dayCode = 'ÃœÄ°';
        }

        // NoktalÄ± bÃ¼yÃ¼k 'Ä°' iÃ§in tutarlÄ±lÄ±k kontrolÃ¼
        if (dayCode === 'i' || dayCode === 'I') {
            dayCode = 'Ä°';
        }

        if (counts.hasOwnProperty(dayCode)) {
            counts[dayCode]++;
        }
    }
    return counts;
}

// =================================================================
// EKSÄ°K GÃœN KODU SEÃ‡Ä°M KUTUSU Ä°Ã‡Ä°N Ã–ZEL GÃ–RÃœNÃœM FONKSÄ°YONLARI
// =================================================================

// SeÃ§im kutusunun gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelleyen ana fonksiyon
function handleCustomSelectDisplay(selectElement) {
    if (!selectElement) return;

    // Ã–nce tÃ¼m seÃ§eneklerin metnini orijinal haline (Kod - AÃ§Ä±klama) dÃ¶ndÃ¼r
    Array.from(selectElement.options).forEach(option => {
        if (option.value) { // BoÅŸ seÃ§enek hariÃ§
            const kodBilgisi = eksikGunKodlari.find(k => k.kod === option.value);
            if (kodBilgisi) {
                option.textContent = `${kodBilgisi.kod} - ${kodBilgisi.aciklama}`;
            }
        }
    });

    // ArdÄ±ndan, sadece seÃ§ili olan seÃ§eneÄŸin metnini sadece kod olarak ayarla
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    if (selectedOption && selectedOption.value) {
        selectedOption.textContent = selectedOption.value;
    }
}

// TÃ¼m Ã¶zel seÃ§im kutularÄ±na olay dinleyicileri ekleyen ve ilk gÃ¶rÃ¼nÃ¼mÃ¼ ayarlayan fonksiyon
function initializeCustomSelects() {
    const customSelects = document.querySelectorAll('.missing-day-code-select');
    customSelects.forEach(select => {
        // Sayfa yÃ¼klendiÄŸinde mevcut seÃ§ili deÄŸeri doÄŸru formatla gÃ¶ster
        handleCustomSelectDisplay(select);

        // Kutuyu aÃ§madan hemen Ã¶nce (focus) tÃ¼m aÃ§Ä±klamalarÄ± tekrar gÃ¶ster
        select.addEventListener('focus', () => {
            Array.from(select.options).forEach(option => {
                if (option.value) {
                    const kodBilgisi = eksikGunKodlari.find(k => k.kod === option.value);
                    if (kodBilgisi) {
                        option.textContent = `${kodBilgisi.kod} - ${kodBilgisi.aciklama}`;
                    }
                }
            });
        });

        // Bir seÃ§im yapÄ±ldÄ±ÄŸÄ±nda veya kutudan Ã§Ä±kÄ±ldÄ±ÄŸÄ±nda (change, blur) gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
        select.addEventListener('change', () => handleCustomSelectDisplay(select));
        select.addEventListener('blur', () => handleCustomSelectDisplay(select));
    });
}
function renderPuantajTable(nobetVerisi, aktifPersonelListesi, baslikMetni) {
    const container = document.getElementById('puantaj-table-container');
    const year = parseInt(document.getElementById('input-year').value);
    const month = parseInt(document.getElementById('select-month').value);

    let finalHTML = `<h2 id="puantaj-baslik" style="text-align: center; color: var(--theme-primary); margin-bottom: 25px;">${baslikMetni}</h2>`;

    if (!aktifPersonelListesi || aktifPersonelListesi.length === 0 || !puantajData) {
        container.innerHTML = `<div style="padding: 40px; text-align: center; background-color: #f8f9fa; border-radius: 8px;"><h4 style="color: var(--theme-primary);">Bu ay iÃ§in gÃ¶rÃ¼ntÃ¼lenecek puantaj verisi veya aktif personel bulunmuyor.</h4></div>`;
        return;
    }

    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const gunler = ['Paz', 'Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt'];
    const grupluPersonel = {
        'Belirsiz SÃ¼reli': aktifPersonelListesi.filter(p => p.sozlesme_turu === 'Belirsiz SÃ¼reli'),
        'Belirli SÃ¼reli': aktifPersonelListesi.filter(p => p.sozlesme_turu === 'Belirli SÃ¼reli'),
        'KÄ±smi SÃ¼reli': aktifPersonelListesi.filter(p => p.sozlesme_turu === 'KÄ±smi SÃ¼reli')
    };
    
    for (const grupAdi in grupluPersonel) {
        const personelGrubu = grupluPersonel[grupAdi];
        if (personelGrubu.length === 0) continue;
        const ayAdi = document.getElementById('select-month').options[month].text;
        const yeniGrupBasligi = `${ayAdi} ${year} AyÄ± Personel Puantaj KayÄ±tlarÄ± ( ${grupAdi.toLocaleUpperCase('tr-TR')} )`;
        finalHTML += `<h3 style="margin-top: 30px; padding: 10px; background-color: #343a40; color: white; border-radius: 5px;">${yeniGrupBasligi}</h3>`;
        
        // DEÄÄ°ÅÄ°KLÄ°K: Belirsiz SÃ¼reli grup iÃ§in colspan 4'e Ã§Ä±karÄ±ldÄ±.
        let tableHTML = `<table class="puantaj-table"><thead><tr><th rowspan="2">Personel</th><th rowspan="2">Unvan</th><th rowspan="2" class="vertical-divider">Ä°ÅŸe GiriÅŸ<br>Ä°ÅŸten Ã‡Ä±kÄ±ÅŸ</th><th colspan="${daysInMonth}">AylÄ±k Puantaj Durumu</th><th colspan="${(grupAdi === 'Belirsiz SÃ¼reli') ? 4 : 4}" class="vertical-divider">AylÄ±k Saat ToplamlarÄ±</th><th colspan="9" class="vertical-divider">AylÄ±k GÃ¼n ToplamlarÄ±</th><th rowspan="2" class="vertical-divider">Sgk Prim GÃ¼nÃ¼</th><th colspan="3">Sosyal YardÄ±mlar</th><th rowspan="2">Ä°mza</th></tr><tr>`;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dividerClass = (new Date(year, month, day).getDay() === 0 || day === daysInMonth) ? 'vertical-divider' : '';
            tableHTML += `<th class="col-day ${dividerClass}">${day}<br>${gunler[date.getDay()]}</th>`;
        }
        
        tableHTML += `<th>AylÄ±k Toplam</th>${(grupAdi === 'Belirsiz SÃ¼reli') ? '<th>Fazla Mesai</th><th>Mesai Nedeni</th><th>E. G.<br>Kodu</th>' : `<th>Ek Ders</th><th>NÃ¶bet</th><th class="vertical-divider">Rehberlik</th>`}<th>N</th><th>HT</th><th>RT</th><th>Ä°</th><th>R</th><th>ÃœÄ°</th><th>S</th><th>K</th><th class="vertical-divider">RTÃ‡</th><th>EÅŸ Durumu</th><th>Ã‡ocuk 0-6</th><th>Ã‡ocuk 6-18</th></tr></thead><tbody>`;

        personelGrubu.forEach(personel => {
            const personelPuantajData = puantajData[personel.id];
            if (!personelPuantajData) { return; }
            let ayrilisTarihiGoster = '---';
            if (personel.isten_ayrilis) {
                const ayrilisDate = new Date(personel.isten_ayrilis + 'T00:00:00Z');
                if (ayrilisDate.getUTCFullYear() === year && ayrilisDate.getUTCMonth() === month) {
                    ayrilisTarihiGoster = formatDateDDMMYYYY(personel.isten_ayrilis);
                }
            }
            const monthlyHours = calculateMonthlyHours(personel.id);
            const nobetSaat = nobetVerisi[personel.id] || 0;
            const rehberlikSaat = calculateEffectiveRehberlikHours(personel.id, year, month, puantajData);
            const statusCounts = calculateStatusCounts(personel.id);
            let sgkPrimGunu = new Date(year, month + 1, 0).getDate() - ((statusCounts.R || 0) + (statusCounts.ÃœÄ° || 0));

            tableHTML += `<tr class="personel-row-status"><td class="col-personel" rowspan="2">${personel.ad}</td><td class="col-unvan" rowspan="2">${personel.unvan}</td><td class="col-date vertical-divider" rowspan="2">${formatDateDDMMYYYY(personel.ise_giris)}<br>${ayrilisTarihiGoster}</td>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = personelPuantajData[dateString] || { code: '', hours: 0 };
                const dividerClass = (new Date(year, month, day).getDay() === 0 || day === daysInMonth) ? 'vertical-divider' : '';
                tableHTML += `<td class="status-cell status-${dayData.code} ${dividerClass}" data-personel-id="${personel.id}" data-date="${dateString}">${dayData.code || ''}</td>`;
            }
            
           let eksikGunKoduSelect = '';
            if (grupAdi === 'Belirsiz SÃ¼reli') {
                let options = '<option value=""></option>'; // VarsayÄ±lan boÅŸ seÃ§enek
                eksikGunKodlari.forEach(item => {
                    const selected = (missingDayCodes[personel.id] === item.kod) ? 'selected' : '';
                    // Listede hem kod hem de aÃ§Ä±klama her zaman tam olarak oluÅŸturulur
                    options += `<option value="${item.kod}" ${selected}>${item.kod} - ${item.aciklama}</option>`;
                });
                eksikGunKoduSelect = `<td rowspan="2" class="summary-missing-day"><select class="missing-day-code-select" data-personel-id="${personel.id}">${options}</select></td>`;
            }
            const fazlaMesaiSaat = (grupAdi === 'Belirsiz SÃ¼reli') ? calculateFazlaMesai(personel.id) : 0;
            const mesaiNedeniInput = `<td rowspan="2" class="summary-reason"><input type="text" class="overtime-reason-input" data-personel-id="${personel.id}" value="${overtimeReasons[personel.id] || ''}"></td>`;
            
            tableHTML += `<td class="summary-yellow" rowspan="2">${monthlyHours.genelToplam}</td>${(grupAdi === 'Belirsiz SÃ¼reli') ? `<td class="summary-overtime" rowspan="2">${fazlaMesaiSaat}</td>${mesaiNedeniInput}${eksikGunKoduSelect}` : `<td class="summary-green" rowspan="2">${monthlyHours.ekDers}</td><td class="summary-nobet" rowspan="2">${nobetSaat}</td><td class="summary-rehberlik vertical-divider" rowspan="2">${rehberlikSaat}</td>`}<td class="col-summary-count" rowspan="2">${statusCounts.N || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.HT || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.RT || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.Ä° || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.R || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.ÃœÄ° || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.S || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.K || 0}</td><td class="col-summary-count vertical-divider" rowspan="2">${statusCounts.RTÃ‡ || 0}</td><td class="total-worked-day vertical-divider" rowspan="2">${sgkPrimGunu}</td><td class="social-section" rowspan="2">${personel.esDurumu === 'calismiyor' ? 'Ã‡alÄ±ÅŸmÄ±yor' : 'Bekar'}</td><td class="social-section" rowspan="2">${personel.cocuk0_6 || ''}</td><td class="social-section" rowspan="2">${personel.cocuk6_18 || ''}</td><td class="col-imza" rowspan="2"></td></tr>`;
            
            tableHTML += `<tr class="personel-row-hours horizontal-divider">`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = personelPuantajData[dateString] || { code: '', hours: 0 };
                const dividerClass = (new Date(year, month, day).getDay() === 0 || day === daysInMonth) ? 'vertical-divider' : '';
                // EKLENECEK YENÄ° SATIR
                const hourContent = (dayData?.code === 'N' || dayData?.code === 'RTÃ‡' || dayData?.code === 'Y' || dayData?.code === 'K') && dayData?.hours > 0 ? dayData.hours : '';
                tableHTML += `<td class="hour-cell ${dividerClass}">${hourContent}</td>`;
            }
            tableHTML += `</tr>`;
        });
        tableHTML += `</tbody></table>`;
        finalHTML += tableHTML;
    }
    
    container.innerHTML = finalHTML;
    attachCellListeners();
    initializeCustomSelects();
}

// =================================================================
// EKLEME Ä°ÅLEMÄ° BURADA BÄ°TÄ°YOR
// =================================================================
let puantajInitialized = false;
let puantajPersonelList = [];
let puantajData = {};
let overtimeReasons = {}; // Fazla mesai nedenlerini tutacak nesne
let missingDayCodes = {}; // Eksik gÃ¼n kodlarÄ±nÄ± tutacak nesne

// YENÄ° EKLENEN DEÄÄ°ÅKENLER
let isPuantajLocked = false; 
let currentPuantajDocRef = null;
// =================== 1. ADIM: EKSÄ°K FONKSÄ°YONLARI BURAYA EKLEYÄ°N ===================

// MEVCUT HATALI FONKSÄ°YONU SÄ°LÄ°P, YERÄ°NE BU DOÄRU VERSÄ°YONU YAPIÅTIRIN

async function loadPuantajDataForCurrentMonth() {
    const year = document.getElementById('input-year').value;
    const month = document.getElementById('select-month').value;
    const docId = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}`;
    currentPuantajDocRef = doc(db, "kayitli_puantajlar", docId);
    try {
        const ayAdi = document.getElementById('select-month').options[month].text;
        const baslikMetni = `Ã–ZEL Ä°SABET ORTAOKULU ${year} YILI ${ayAdi.toLocaleUpperCase('tr-TR')} AYI PERSONEL PUANTAJ CETVELÄ°`;

        const docSnap = await getDoc(currentPuantajDocRef);
       if (docSnap.exists()) {
            const data = docSnap.data();
            puantajData = data.puantajData || {};
            overtimeReasons = data.overtimeReasons || {}; 
            missingDayCodes = data.missingDayCodes || {}; // Eksik gÃ¼n kodlarÄ±nÄ± yÃ¼kle
            isPuantajLocked = data.isLocked || false;
            showToast('KaydedilmiÅŸ puantaj verisi yÃ¼klendi.', 'success');
        } else {
            puantajData = {};
            overtimeReasons = {}; 
            missingDayCodes = {}; // Puantaj yoksa kodlarÄ± da sÄ±fÄ±rla
            isPuantajLocked = false;
            showToast('Bu ay iÃ§in kaydedilmiÅŸ bir puantaj yok.', 'info');
        }
        updateLockStatusUI();

        // === BAÅLANGIÃ‡: DOÄRU FÄ°LTRELEME MANTIÄI ===
    const ayinIlkGunu = new Date(Date.UTC(year, month, 1));
    const ayinSonGunu = new Date(Date.UTC(year, month + 1, 0));

    const aktifPersonelList = puantajPersonelList.filter(personel => {
        const girisStr = personel.ise_giris;
        const ayrilisStr = personel.isten_ayrilis;

        // Ä°ÅŸe giriÅŸ tarihi yoksa veya geÃ§ersizse personeli gÃ¶sterme.
        if (!girisStr) return false;
        const girisDate = new Date(girisStr + 'T00:00:00Z');
        if (isNaN(girisDate.getTime())) return false;

        // Kural 1: Ä°ÅŸe giriÅŸ tarihi, baktÄ±ÄŸÄ±mÄ±z ayÄ±n son gÃ¼nÃ¼nden sonra olamaz.
        const iseBaslamisMi = girisDate <= ayinSonGunu;

        // Kural 2: Ä°ÅŸten ayrÄ±lÄ±ÅŸ tarihi, baktÄ±ÄŸÄ±mÄ±z ayÄ±n ilk gÃ¼nÃ¼nden Ã¶nce olamaz.
        let istenAyrilmamisMi = true; // VarsayÄ±lan olarak true
        if (ayrilisStr && ayrilisStr.trim() !== '' && ayrilisStr.trim() !== '---') {
            const ayrilisDate = new Date(ayrilisStr + 'T00:00:00Z');
            if (!isNaN(ayrilisDate.getTime())) {
                istenAyrilmamisMi = ayrilisDate >= ayinIlkGunu;
            }
        }

        // Personel, ancak her iki kuralÄ± da saÄŸlÄ±yorsa o ayÄ±n listesinde yer alabilir.
        return iseBaslamisMi && istenAyrilmamisMi;
    });
    // === BÄ°TÄ°Å: DOÄRU FÄ°LTRELEME MANTIÄI ===

        // =======================================================
        // FÄ°LTRELEME MANTIÄI BURADA UYGULANIYOR
        // =======================================================
        const selectedPersonelId = document.getElementById('personel-filter-select').value;
        let displayList = aktifPersonelList; // VarsayÄ±lan olarak tÃ¼m aktif personel listesi atanÄ±yor

        if (selectedPersonelId && selectedPersonelId !== 'all') {
            // EÄŸer belirli bir personel seÃ§ilmiÅŸse, 'displayList' filtrelenmiÅŸ sonuÃ§la gÃ¼ncelleniyor
            displayList = aktifPersonelList.filter(p => p.id === selectedPersonelId);
        }
        // =======================================================

        const nobetVerisi = await fetchAndCalculateNobetData(year, parseInt(month));
        
        // DEÄÄ°ÅÄ°KLÄ°K BURADA: Tablo, filtrelenmiÅŸ olan 'displayList' ile Ã§iziliyor.
        renderPuantajTable(nobetVerisi, displayList, baslikMetni);
        
        renderGrandTotals(nobetVerisi, displayList);
        renderLegend();
        attachCellListeners();
    } catch (error) {
        console.error("Puantaj verisi yÃ¼klenirken hata: ", error);
        showToast("Puantaj verisi yÃ¼klenemedi.", "error");
    }
}

async function savePuantajData() {
    if (isPuantajLocked) {
        showToast('Puantaj kilitli olduÄŸu iÃ§in kaydedilemez.', 'error');
        return;
    }
    if (Object.keys(puantajData).length === 0) {
        showToast('Kaydedilecek puantaj verisi bulunmuyor.', 'error');
        return;
    }

    // YENÄ° EKLENEN KONTROL BLOÄU BAÅLANGICI
    // EÄŸer dÃ¶kÃ¼man referansÄ± henÃ¼z oluÅŸturulmadÄ±ysa (Ã¶rneÄŸin yeni puantaj sonrasÄ±),
    // o anki ay ve yÄ±la gÃ¶re referansÄ± burada oluÅŸtur.
    if (!currentPuantajDocRef) {
        const year = document.getElementById('input-year').value;
        const month = document.getElementById('select-month').value;
        const docId = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}`;
        currentPuantajDocRef = doc(db, "kayitli_puantajlar", docId);
    }
    // YENÄ° EKLENEN KONTROL BLOÄU BÄ°TÄ°ÅÄ°

    // Mesai nedenlerini topla
    const newOvertimeReasons = {};
    document.querySelectorAll('.overtime-reason-input').forEach(input => {
        if (input.value.trim() !== '') {
            newOvertimeReasons[input.dataset.personelId] = input.value.trim();
        }
    });
    overtimeReasons = newOvertimeReasons;

    // Eksik gÃ¼n kodlarÄ±nÄ± topla
    const newMissingDayCodes = {};
    document.querySelectorAll('.missing-day-code-select').forEach(select => {
        if (select.value) {
            newMissingDayCodes[select.dataset.personelId] = select.value;
        }
    });
    missingDayCodes = newMissingDayCodes;

    try {
        // ArtÄ±k currentPuantajDocRef'in null olmama garantisi var.
        await setDoc(currentPuantajDocRef, {
            puantajData: puantajData,
            isLocked: isPuantajLocked,
            overtimeReasons: overtimeReasons,
            missingDayCodes: missingDayCodes
        }, { merge: true });
        showToast('Puantaj baÅŸarÄ±yla kaydedildi!', 'success');
    } catch (error) {
        console.error("Puantaj kaydedilirken hata: ", error);
        showToast('Puantaj kaydedilemedi.', 'error');
    }
}
async function togglePuantajLock() {
    isPuantajLocked = !isPuantajLocked; // Kilit durumunu tersine Ã§evir

    try {
        if (!currentPuantajDocRef) {
             const year = document.getElementById('input-year').value;
             const month = document.getElementById('select-month').value;
             const docId = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}`;
             currentPuantajDocRef = doc(db, "kayitli_puantajlar", docId);
        }
        await setDoc(currentPuantajDocRef, { isLocked: isPuantajLocked }, { merge: true });
        showToast(isPuantajLocked ? 'Puantaj kilitlendi.' : 'Puantaj kilidi aÃ§Ä±ldÄ±.', 'success');
        updateLockStatusUI();
    } catch (error) {
        console.error("Kilit durumu gÃ¼ncellenirken hata:", error);
        showToast("Kilit durumu gÃ¼ncellenemedi.", "error");
        isPuantajLocked = !isPuantajLocked; // Hata olursa durumu geri al
    }
}

// YENÄ° EKLENEN SÄ°LME FONKSÄ°YONU
async function deleteCurrentPuantaj() {
    if (isPuantajLocked) {
        showToast('Puantaj kilitli. Silmek iÃ§in Ã¶nce kilidi aÃ§malÄ±sÄ±nÄ±z.', 'error');
        return;
    }

    if (!currentPuantajDocRef) {
        showToast('Bu ay iÃ§in silinecek kayÄ±tlÄ± bir puantaj bulunmuyor.', 'error');
        return;
    }

    const year = document.getElementById('input-year').value;
    const monthName = document.getElementById('select-month').options[document.getElementById('select-month').selectedIndex].text;

    if (!confirm(`${monthName} ${year} ayÄ±na ait puantaj cetvelini kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.`)) {
        return;
    }

    try {
        await deleteDoc(currentPuantajDocRef);

        // Lokal verileri ve arayÃ¼zÃ¼ temizle
        puantajData = {};
        isPuantajLocked = false;
        currentPuantajDocRef = null;

        updateLockStatusUI();
        renderPuantajTable({}); // Tabloyu boÅŸaltarak "veri yok" mesajÄ±nÄ± gÃ¶ster
        renderGrandTotals({}, []); // Genel toplamlarÄ± sÄ±fÄ±rla

        showToast('Puantaj baÅŸarÄ±yla silindi.', 'success');

    } catch (error) {
        console.error("Puantaj silinirken hata:", error);
        showToast('Puantaj silinirken bir hata oluÅŸtu.', 'error');
    }
}

// YENÄ° FONKSÄ°YON: Kilit butonunun metnini ve rengini gÃ¼nceller.
function updateLockStatusUI() {
    const lockBtn = document.getElementById('btn-lock-puantaj');
    const generateBtn = document.getElementById('btn-generate');

    if (isPuantajLocked) {
        lockBtn.textContent = 'Kilidi AÃ§';
        lockBtn.style.backgroundColor = '#17a2b8';
        generateBtn.disabled = true;
    } else {
        lockBtn.textContent = 'PuantajÄ± Kilitle';
        lockBtn.style.backgroundColor = '#fd7e14';
        generateBtn.disabled = false;
    }
}


// MEVCUT fetchIzinDataForPuantaj FONKSÄ°YONUNU SÄ°LÄ°P, BU NÄ°HAÄ° VERSÄ°YONU YAPIÅTIRIN
// === BAÅLANGIÃ‡: MEVCUT FONKSÄ°YONU BU BLOK Ä°LE DEÄÄ°ÅTÄ°RÄ°N ===
async function fetchIzinDataForPuantaj(year, month) {
    const ayinIlkGunu = new Date(year, month, 1);
    const ayinSonGunu = new Date(year, month + 1, 0);
    const ayinSonGunuStr = ayinSonGunu.toISOString().split('T')[0];

    const q = query(collection(db, 'izinler'), where('baslangicTarihi', '<=', ayinSonGunuStr));

    const [izinSnap, izinTipiSnap] = await Promise.all([getDocs(q), getSettings('ayarlar_izin_tipleri')]);
    const izinTipiKodMap = new Map(izinTipiSnap.docs.map(doc => [doc.id, doc.data().kod]));
    const izinVerisi = {};

    izinSnap.forEach(doc => {
        const izin = doc.data();
        const personelId = izin.personelId;

        if (!izin.baslangicTarihi || !izin.bitisTarihi) {
            console.error(`HATA: ID'si ${doc.id} olan izin kaydÄ±nda tarih eksik.`, izin);
            return;
        }

        // --- SAAT DÄ°LÄ°MÄ° SORUNUNU Ã‡Ã–ZEN DEÄÄ°ÅÄ°KLÄ°K ---
        // Tarihleri yerel saat yerine UTC (Evrensel Saat) olarak oluÅŸturuyoruz.
        // 'T00:00:00Z' ifadesi, saati UTC'ye gÃ¶re gece yarÄ±sÄ± olarak ayarlar.
        const baslangicTarihiUTC = new Date(izin.baslangicTarihi + 'T00:00:00Z');
        const bitisTarihiUTC = new Date(izin.bitisTarihi + 'T00:00:00Z');

        if (isNaN(baslangicTarihiUTC.getTime()) || isNaN(bitisTarihiUTC.getTime())) {
            console.error(`HATA: ID'si ${doc.id} olan izin kaydÄ±ndaki tarih formatÄ± geÃ§ersiz.`, izin);
            return;
        }

        // bitisTarihiUTC, ayÄ±n ilk gÃ¼nÃ¼nden sonraysa veya eÅŸitse iÅŸleme devam et
        if (bitisTarihiUTC >= ayinIlkGunu) {
            if (!izinVerisi[personelId]) {
                izinVerisi[personelId] = {};
            }
            const izinKodu = izinTipiKodMap.get(izin.izinTipiId) || 'I';

            // DÃ¶ngÃ¼yÃ¼ UTC tarihleri Ã¼zerinden kuruyoruz.
            let d = new Date(baslangicTarihiUTC);
            while (d <= bitisTarihiUTC) {
                // Sadece ilgili aydaki gÃ¼nleri iÅŸle (yÄ±l ve ay kontrolÃ¼ UTC'ye gÃ¶re yapÄ±lÄ±r)
                if (d.getUTCFullYear() === year && d.getUTCMonth() === month) {
                    // Tarih dizesini de UTC'ye gÃ¶re oluÅŸturup 'Z'yi kaldÄ±rÄ±yoruz.
                    const dateString = d.toISOString().split('T')[0];
                    izinVerisi[personelId][dateString] = izinKodu;
                }
                // Bir sonraki gÃ¼ne geÃ§erken de UTC metodunu kullanÄ±yoruz.
                d.setUTCDate(d.getUTCDate() + 1);
            }
        }
    });
    return izinVerisi;
}
// === BÄ°TÄ°Å: DEÄÄ°ÅTÄ°RME Ä°ÅLEMÄ° BURADA BÄ°TER ===
async function fetchAndCalculateNobetData(year, month) {
    const startDate = new Date(year, month, 1).toISOString().split('T')[0];
    const endDate = new Date(year, month + 1, 1).toISOString().split('T')[0];
    const q = query(collection(db, 'nobetler'), where('tarih', '>=', startDate), where('tarih', '<', endDate));
    const nobetSnap = await getDocs(q);
    const nobetHaftalari = {};
    const getWeekNumber = (d) => { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); };
    nobetSnap.forEach(doc => {
        const nobet = doc.data(); const tarih = new Date(nobet.tarih + 'T00:00:00'); const haftaNo = getWeekNumber(tarih);
        if (!nobetHaftalari[nobet.personelId]) nobetHaftalari[nobet.personelId] = new Set();
        nobetHaftalari[nobet.personelId].add(haftaNo);
    });
    const nobetEkDers = {};
    for (const personelId in nobetHaftalari) { nobetEkDers[personelId] = nobetHaftalari[personelId].size * 3; }
    return nobetEkDers;
}

async function fetchAndProcessSchedules() {
    const scheduleData = {}; // SonuÃ§: { personelId: { 'Pazartesi': 5, 'Sali': 4 ... } }

    try {
        const [scheduleSnap, personelSnap] = await Promise.all([
            getDocs(collection(db, "ders_programlari")),
            getDocs(collection(db, "personel"))
        ]);

        // EÄER HÄ°Ã‡ DERS PROGRAMI YOKSA UYARI VER VE BOÅ DÃ–N
        if (scheduleSnap.empty) {
            console.warn("UYARI: Firestore 'ders_programlari' koleksiyonunda hiÃ§ veri bulunamadÄ±. Saatler 0 olarak hesaplanacak.");
            return {};
        }

        // Personel adÄ±ndan ID'ye bir harita oluÅŸturuyoruz.
        const personelAdindanIdMap = new Map();
        personelSnap.forEach(doc => {
            personelAdindanIdMap.set(doc.data().ad_soyad, doc.id);
        });

        // TÃ¼m ders programlarÄ±nÄ± gez
        scheduleSnap.forEach(doc => {
            const program = doc.data();
            for (const gun in program) {
                const gununDersleri = program[gun];
                for (const saat in gununDersleri) {
                    const dersDetayi = gununDersleri[saat];
                    if (!dersDetayi || !dersDetayi.ogretmen) continue; // Ders detayÄ± veya Ã¶ÄŸretmen yoksa atla

                    const personelAdi = dersDetayi.ogretmen;
                    const personelId = personelAdindanIdMap.get(personelAdi);

                    // --- EN Ã–NEMLÄ° GÃœNCELLEME BURADA ---
                    // EÄŸer Ã¶ÄŸretmen adÄ± personel listesinde bulunduysa iÅŸlem yap. BulunmadÄ±ysa hata vermeden atla.
                    if (personelId) {
                        if (!scheduleData[personelId]) {
                            scheduleData[personelId] = {};
                        }
                        if (!scheduleData[personelId][gun]) {
                            scheduleData[personelId][gun] = 0;
                        }
                        scheduleData[personelId][gun]++;
                    } else {
                        // EÅŸleÅŸmeyen Ã¶ÄŸretmeni konsola yazdÄ±r, bu sayede hatayÄ± kolayca bulabilirsiniz.
                        console.warn(`DÄ°KKAT: Ders programÄ±ndaki "${personelAdi}" isimli Ã¶ÄŸretmen, personel listesinde bulunamadÄ±. Bu ders saati puantaja eklenmeyecek.`);
                    }
                }
            }
        });
        
        return scheduleData;

    } catch (error) {
        console.error("Ders programlarÄ± iÅŸlenirken kritik bir hata oluÅŸtu:", error);
        showToast("Ders programÄ± verisi okunamadÄ±! Konsolu kontrol edin.", "error");
        return {};
    }
}
    async function generateInitialPuantaj() {
    if (isPuantajLocked) {
        showToast('Puantaj kilitli...', 'error');
        return;
    }
    if (!confirm('Yeni bir puantaj oluÅŸturulacak. Emin misiniz?')) {
        return;
    }
    try {
        const year = parseInt(document.getElementById('input-year').value);
        const month = parseInt(document.getElementById('select-month').value);
        showToast('Puantaj oluÅŸturuluyor...');

        const ayAdi = document.getElementById('select-month').options[month].text;
        const baslikMetni = `Ã–ZEL Ä°SABET ORTAOKULU ${year} YILI ${ayAdi.toLocaleUpperCase('tr-TR')} AYI PERSONEL PUANTAJ CETVELÄ°`;
        
        // === BAÅLANGIÃ‡: DOÄRU FÄ°LTRELEME MANTIÄI ===
    const ayinIlkGunu = new Date(Date.UTC(year, month, 1));
    const ayinSonGunu = new Date(Date.UTC(year, month + 1, 0));

    let aktifPersonelList = puantajPersonelList.filter(personel => {
        const girisStr = personel.ise_giris;
        const ayrilisStr = personel.isten_ayrilis;

        // Ä°ÅŸe giriÅŸ tarihi yoksa veya geÃ§ersizse personeli gÃ¶sterme.
        if (!girisStr) return false;
        const girisDate = new Date(girisStr + 'T00:00:00Z');
        if (isNaN(girisDate.getTime())) return false;

        // Kural 1: Ä°ÅŸe giriÅŸ tarihi, baktÄ±ÄŸÄ±mÄ±z ayÄ±n son gÃ¼nÃ¼nden sonra olamaz.
        const iseBaslamisMi = girisDate <= ayinSonGunu;

        // Kural 2: Ä°ÅŸten ayrÄ±lÄ±ÅŸ tarihi, baktÄ±ÄŸÄ±mÄ±z ayÄ±n ilk gÃ¼nÃ¼nden Ã¶nce olamaz.
        let istenAyrilmamisMi = true; // VarsayÄ±lan olarak true
        if (ayrilisStr && ayrilisStr.trim() !== '' && ayrilisStr.trim() !== '---') {
            const ayrilisDate = new Date(ayrilisStr + 'T00:00:00Z');
            if (!isNaN(ayrilisDate.getTime())) {
                istenAyrilmamisMi = ayrilisDate >= ayinIlkGunu;
            }
        }

        // Personel, ancak her iki kuralÄ± da saÄŸlÄ±yorsa o ayÄ±n listesinde yer alabilir.
        return iseBaslamisMi && istenAyrilmamisMi;
    });
    // === BÄ°TÄ°Å: DOÄRU FÄ°LTRELEME MANTIÄI ===

        const selectedPersonelId = document.getElementById('personel-filter-select').value;
        if (selectedPersonelId !== 'all') {
            aktifPersonelList = aktifPersonelList.filter(p => p.id === selectedPersonelId);
        }
        
        const [scheduleData, nobetVerisi, izinVerisi] = await Promise.all([
            fetchAndProcessSchedules(),
            fetchAndCalculateNobetData(year, month),
            fetchIzinDataForPuantaj(year, month)
        ]);
        const gunlerTR = ["Pazar", "Pazartesi", "SalÄ±", "Ã‡arÅŸamba", "PerÅŸembe", "Cuma", "Cumartesi"];
        puantajData = {};

        aktifPersonelList.forEach(personel => {
            puantajData[personel.id] = {};
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateUTC = new Date(Date.UTC(year, month, day));
                const dateString = dateUTC.toISOString().split('T')[0];
                let code = '', hours = 0;
                if (personel.isten_ayrilis) {
                    const ayrilisTarihiUTC = new Date(personel.isten_ayrilis + 'T00:00:00Z');
                    if (dateUTC > ayrilisTarihiUTC) {
                        puantajData[personel.id][dateString] = { code: '', hours: 0, notes: '' };
                        continue;
                    }
                }
                const leaveCodeForDay = izinVerisi[personel.id]?.[dateString];
                const dayOfWeek = dateUTC.getDay();
                const dayOfWeekTR = gunlerTR[dayOfWeek];
                if (leaveCodeForDay && (leaveCodeForDay === 'R' || leaveCodeForDay === 'ÃœÄ°')) {
                    code = leaveCodeForDay;
                }
                if (code === '') {
                    if (personel.sozlesme_turu === 'KÄ±smi SÃ¼reli') {
                        if (isResmiTatil(dateUTC)) { code = 'E'; } 
                        else {
                            const scheduledHours = parseInt(personel.kismi_zamanli_calisma?.[dayOfWeekTR] || scheduleData[personel.id]?.[dayOfWeekTR] || 0);
                            code = (scheduledHours > 0) ? 'Y' : 'E';
                            hours = scheduledHours;
                        }
                    } else {
                        if (isResmiTatil(dateUTC)) { code = 'RT'; } 
                        else {
                            let isWeekend = (personel.sozlesme_turu === 'Belirli SÃ¼reli') ? (dayOfWeek === 6 || dayOfWeek === 0) : (dayOfWeek === 0);
                            if (isWeekend) { code = 'HT'; } 
                            else {
                                code = 'N';
                                // *** YENÄ° KONTROL: "Rehberlik" kelimesi de eklendi ***
                                if (personel.unvan && (personel.unvan.includes('Okul MÃ¼dÃ¼rÃ¼') || personel.unvan.includes('Rehber Ã–ÄŸretmen') || personel.unvan.includes('Rehberlik'))) {
                                    hours = 4;
                                } else {
                                    hours = (personel.sozlesme_turu === 'Belirsiz SÃ¼reli') ? 7.5 : (scheduleData[personel.id]?.[dayOfWeekTR] || 0);
                                }
                            }
                        }
                    }
                    if (leaveCodeForDay && (code === 'N' || code === 'Y')) {
                         code = leaveCodeForDay;
                         hours = 0;
                    }
                }
                puantajData[personel.id][dateString] = { code, hours, notes: '' };
            }
        });

        renderPuantajTable(nobetVerisi, aktifPersonelList, baslikMetni);
        renderGrandTotals(nobetVerisi);
        renderLegend();
        attachCellListeners();
        showToast('Puantaj baÅŸarÄ±yla oluÅŸturuldu!', 'success');
    } catch (error) {
        console.error("Puantaj oluÅŸturulurken hata:", error);
        showToast('Puantaj oluÅŸturulamadÄ±.', 'error');
    }
}
// =================================================================
// YENÄ° EKLENEN BÄ°REYSEL PUANTAJ HAZIRLAMA FONKSÄ°YONU
// =================================================================
async function generateIndividualPuantaj() {
    const selectedPersonelId = document.getElementById('personel-filter-select').value;

    // 1. AdÄ±m: Listeden bir personel seÃ§ilip seÃ§ilmediÄŸini kontrol et
    if (!selectedPersonelId || selectedPersonelId === 'all') {
        showToast('LÃ¼tfen Ã¶nce listeden bir personel seÃ§in.', 'error');
        return;
    }

    const personel = puantajPersonelList.find(p => p.id === selectedPersonelId);
    if (!personel) {
        showToast('SeÃ§ilen personel verisi bulunamadÄ±.', 'error');
        return;
    }

    if (!confirm(`'${personel.ad}' iÃ§in puantaj yeniden hazÄ±rlanacak. Bu personelin mevcut puantaj verileri sÄ±fÄ±rlanacaktÄ±r. Devam etmek istiyor musunuz?`)) {
        return;
    }

    try {
        const year = parseInt(document.getElementById('input-year').value);
        const month = parseInt(document.getElementById('select-month').value);
        showToast(`'${personel.ad}' iÃ§in puantaj hazÄ±rlanÄ±yor...`);

        // 2. AdÄ±m: PuantajÄ± oluÅŸturmak iÃ§in gerekli verileri (izinler, ders programÄ± vb.) Ã§ek
        const [scheduleData, izinVerisi] = await Promise.all([
            fetchAndProcessSchedules(),
            fetchIzinDataForPuantaj(year, month)
        ]);
        const gunlerTR = ["Pazar", "Pazartesi", "SalÄ±", "Ã‡arÅŸamba", "PerÅŸembe", "Cuma", "Cumartesi"];
        
        const individualPuantajData = {}; // Sadece bu personel iÃ§in geÃ§ici veri nesnesi
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // 3. AdÄ±m: SeÃ§ili personel iÃ§in ayÄ±n her gÃ¼nÃ¼nÃ¼ gezerek puantaj verisi oluÅŸtur
        for (let day = 1; day <= daysInMonth; day++) {
            const dateUTC = new Date(Date.UTC(year, month, day));
            const dateString = dateUTC.toISOString().split('T')[0];
            let code = '', hours = 0;

            // Personel iÅŸten ayrÄ±ldÄ±ysa, ayrÄ±lÄ±ÅŸ tarihinden sonraki gÃ¼nleri boÅŸ bÄ±rak
            if (personel.isten_ayrilis && personel.isten_ayrilis !== '---') {
                const ayrilisTarihiUTC = new Date(personel.isten_ayrilis + 'T00:00:00Z');
                if (dateUTC > ayrilisTarihiUTC) {
                    individualPuantajData[dateString] = { code: '', hours: 0, notes: '' };
                    continue;
                }
            }

            // Standart puantaj oluÅŸturma mantÄ±ÄŸÄ±nÄ± uygula (izin, tatil, normal gÃ¼n vb.)
            const leaveCodeForDay = izinVerisi[personel.id]?.[dateString];
            const dayOfWeek = dateUTC.getDay();
            const dayOfWeekTR = gunlerTR[dayOfWeek];

            if (leaveCodeForDay && (leaveCodeForDay === 'R' || leaveCodeForDay === 'ÃœÄ°')) {
                code = leaveCodeForDay;
            }

            if (code === '') {
                if (personel.sozlesme_turu === 'KÄ±smi SÃ¼reli') {
                    if (isResmiTatil(dateUTC)) { code = 'E'; } 
                    else {
                        const scheduledHours = parseInt(personel.kismi_zamanli_calisma?.[dayOfWeekTR] || scheduleData[personel.id]?.[dayOfWeekTR] || 0);
                        code = (scheduledHours > 0) ? 'Y' : 'E';
                        hours = scheduledHours;
                    }
                } else { // Belirli ve Belirsiz SÃ¼reli
                    if (isResmiTatil(dateUTC)) { code = 'RT'; } 
                    else {
                        let isWeekend = (personel.sozlesme_turu === 'Belirli SÃ¼reli') ? (dayOfWeek === 6 || dayOfWeek === 0) : (dayOfWeek === 0);
                        if (isWeekend) { code = 'HT'; } 
                        else {
                            code = 'N';
                            if (personel.unvan && (personel.unvan.includes('Okul MÃ¼dÃ¼rÃ¼') || personel.unvan.includes('Rehber Ã–ÄŸretmen') || personel.unvan.includes('Rehberlik'))) {
                                hours = 4;
                            } else {
                                hours = (personel.sozlesme_turu === 'Belirsiz SÃ¼reli') ? 7.5 : (scheduleData[personel.id]?.[dayOfWeekTR] || 0);
                            }
                        }
                    }
                }

                if (leaveCodeForDay && (code === 'N' || code === 'Y')) {
                     code = leaveCodeForDay;
                     hours = 0;
                }
            }
            individualPuantajData[dateString] = { code, hours, notes: '' };
        }

        // 4. AdÄ±m: En Ã–nemli KÄ±sÄ±m -> DiÄŸerlerini silmeden SADECE bu personelin verisini gÃ¼ncelle
        puantajData[selectedPersonelId] = individualPuantajData;

        // 5. AdÄ±m: DeÄŸiÅŸikliÄŸi kalÄ±cÄ± hale getir ve ekranÄ± yenile
        showToast('Bireysel puantaj hazÄ±rlandÄ±. VeritabanÄ±na kaydediliyor...', 'info');
        await savePuantajData();
        await loadPuantajDataForCurrentMonth(); // EkranÄ± en gÃ¼ncel haliyle yeniden yÃ¼kle

    } catch (error) {
        console.error("Bireysel puantaj oluÅŸturulurken hata:", error);
        showToast('Bireysel puantaj oluÅŸturulamadÄ±.', 'error');
    }
}
function calculateMonthlyHours(personelId) {
    const personel = puantajPersonelList.find(p => p.id == personelId);
    const personelData = puantajData[personelId];
    if (!personel || !personelData) return { genelToplam: 0, ekDers: 0 };

    let genelToplam = 0;
    let ekDers = 0;
    const unvan = personel.unvan || '';

    // YÃ¶netici personel ve Rehber Ã–ÄŸretmen iÃ§in Ã¶zel durumlar
    // *** YENÄ° KONTROL: "Rehberlik" kelimesi de eklendi ***
    if (unvan.includes('Okul MÃ¼dÃ¼rÃ¼') || unvan.includes('Rehber Ã–ÄŸretmen') || unvan.includes('Rehberlik')) {
        // AdÄ±m 1: GerÃ§ek Ã§alÄ±ÅŸtÄ±ÄŸÄ± saatleri toplayarak 'genelToplam'Ä± hesapla.
        if (personel.sozlesme_turu === 'Belirsiz SÃ¼reli') {
            Object.values(personelData).forEach(dayData => {
                if (dayData.code === 'N') {
                    genelToplam += (dayData.hours || 0);
                }
            });
        } else { // DiÄŸer sÃ¶zleÅŸme tÃ¼rleri iÃ§in
            Object.values(personelData).forEach(dayData => {
                if (dayData.code === 'N' || dayData.code === 'RTÃ‡' || dayData.code === 'Y' || dayData.code === 'K') {
                    genelToplam += (dayData.hours || 0);
                }
            });
        }

        // AdÄ±m 2: Ã–zel ek ders kuralÄ±nÄ± uygula (gÃ¼nde 4 saat).
        Object.keys(personelData).forEach(dateString => {
            const dayData = personelData[dateString];
            if (dayData.code === 'N' || dayData.code === 'RTÃ‡') {
                ekDers += 4;
            }
        });
        
        // AdÄ±m 3: DoÄŸru hesaplanmÄ±ÅŸ deÄŸerleri dÃ¶ndÃ¼r.
        return { genelToplam, ekDers };
    }

    if (unvan.includes('MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±')) { 
        const yardimciSchedule = [0, 4, 4, 4, 3, 3, 0]; 
        Object.keys(personelData).forEach(dateString => { 
            const dayData = personelData[dateString]; 
            if (dayData.code === 'N' || dayData.code === 'RTÃ‡') { 
                const date = new Date(dateString + 'T00:00:00'); 
                const dayOfWeek = date.getDay(); 
                ekDers += yardimciSchedule[dayOfWeek]; 
            } 
        }); 
        genelToplam = ekDers; 
        return { genelToplam, ekDers }; 
    }

    // DiÄŸer tÃ¼m personeller iÃ§in 'genelToplam' hesaplamasÄ±
    if (personel.sozlesme_turu === 'Belirsiz SÃ¼reli') {
        Object.values(personelData).forEach(dayData => {
            if (dayData.code === 'N') {
                genelToplam += (dayData.hours || 0);
            }
        });
    } else {
        Object.values(personelData).forEach(dayData => {
            if (dayData.code === 'N' || dayData.code === 'RTÃ‡' || dayData.code === 'Y' || dayData.code === 'K') {
                genelToplam += (dayData.hours || 0);
            }
        });
    }

    // DiÄŸer tÃ¼m personeller iÃ§in 'ekDers' hesaplamasÄ±
    if (personel.sozlesme_turu === 'KÄ±smi SÃ¼reli') {
        ekDers = 0;
    }
    else if (!personel.neviAdi.includes('EÄŸitim Personeli')) {
        ekDers = genelToplam;
    }
    else {
        const maasKarsiligiHaftalik = parseInt(personel.maasKarsiligi) || 0;
        if (maasKarsiligiHaftalik === 0) {
            ekDers = genelToplam;
        } else {
            const workWeeks = new Set();
            const getWeek = (d) => { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - yearStart) / 86400000) + 1) / 7); };

            Object.keys(personelData).forEach(dateString => {
                if (personelData[dateString].code === 'N' || personelData[dateString].code === 'RTÃ‡' || personelData[dateString].code === 'Y' || personelData[dateString].code === 'K') {
                    workWeeks.add(getWeek(new Date(dateString + 'T00:00:00')));
                }
            });
            const toplamMaasKarsiligi = workWeeks.size * maasKarsiligiHaftalik;
            ekDers = Math.max(0, genelToplam - toplamMaasKarsiligi);
        }
    }

    return { genelToplam, ekDers: Math.round(ekDers) };
}
function calculateFazlaMesai(personelId) {
    const personelData = puantajData[personelId];
    if (!personelData) return 0;

    const weeklyHours = {};
    // Bir tarihin hangi haftaya ait olduÄŸunu bulan yardÄ±mcÄ± fonksiyon
    const getWeekNumber = (d) => {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    };

    // Her gÃ¼nÃ¼n saatini ilgili haftanÄ±n toplamÄ±na ekle
    for (const dateString in personelData) {
        const dayData = personelData[dateString];
        // Sadece Ã§alÄ±ÅŸÄ±lan gÃ¼nlerin saatlerini hesaba kat
        if (dayData.code === 'N' || dayData.code === 'RTÃ‡' || dayData.code === 'Y' || dayData.code === 'K') {
            const date = new Date(dateString + 'T00:00:00');
            const weekNumber = getWeekNumber(date);
            
            if (!weeklyHours[weekNumber]) {
                weeklyHours[weekNumber] = 0;
            }
            weeklyHours[weekNumber] += (dayData.hours || 0);
        }
    }

    let totalOvertime = 0;
    // Her haftanÄ±n toplam saatini kontrol et ve 45'i aÅŸan kÄ±smÄ± fazla mesaiye ekle
    for (const week in weeklyHours) {
        if (weeklyHours[week] > 45) {
            totalOvertime += (weeklyHours[week] - 45);
        }
    }

    return totalOvertime;
}
// YENÄ° EKLENECEK FONKSÄ°YON
function calculateEffectiveRehberlikHours(personelId, year, month, allPuantajData) {
    const personel = puantajPersonelList.find(p => p.id === personelId);
    // Personelin rehberlik gÃ¶revi yoksa veya veri bulunamazsa 0 dÃ¶n
    if (!personel || personel.rehberlik_gorevi !== 'evet' || !allPuantajData[personelId]) {
        return 0;
    }

    let effectiveHours = 0;
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const personelMonthData = allPuantajData[personelId];

    // AyÄ±n her gÃ¼nÃ¼nÃ¼ dÃ¶ngÃ¼ye al
    for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(year, month, day);

        // EÄŸer gÃ¼n PerÅŸembe ise (Pazar=0, Pzt=1... PerÅŸembe=4)
        if (currentDate.getDay() === 4) {
            const dateString = currentDate.toISOString().split('T')[0];
            const dayStatus = personelMonthData[dateString]?.code;

            // Sadece normal Ã§alÄ±ÅŸma gÃ¼nÃ¼yse ('N') rehberlik saati ekle.
            // DiÄŸer tÃ¼m durumlar (I, R, S, RT vb.) iÃ§in ekleme yapma.
            if (dayStatus === 'N') {
                effectiveHours += 2;
            }
        }
    }
    return effectiveHours;
}


function renderLegend() {
    const legendContainer = document.getElementById('puantaj-legend');
    if(!legendContainer) return;
    legendContainer.innerHTML = '';
    
     const statusCodes = { 'N': 'Normal', 'HT': 'Hafta Sonu', 'RT': 'Resmi Tatil', 'Ä°': 'Ä°zinli (Ãœcretli)', 'R': 'Raporlu', 'ÃœÄ°': 'Ãœcretsiz Ä°zin', 'S': 'YÄ±llÄ±k Ä°zin', 'K': 'YarÄ±m GÃ¼n Ã‡alÄ±ÅŸma', 'Y': 'YarÄ±m GÃ¼n Ã‡alÄ±ÅŸma (KÄ±smi)', 'RTÃ‡': 'Resmi Tatil Ã‡alÄ±ÅŸmasÄ±', 'E': 'Eksik GÃ¼n' };
    for (const code in statusCodes) {
        const item = document.createElement('div'); item.className = 'legend-item';
        item.innerHTML = `<span class="legend-color-box status-${code}"></span><b>(${code})</b>: ${statusCodes[code]}`;
        legendContainer.appendChild(item);
    }
}


// ======================= YERÄ°NE BU YENÄ° FONKSÄ°YONU EKLEYÄ°N =======================
function renderGrandTotals(nobetVerisi = {}, personelListesi) {
    const year = parseInt(document.getElementById('input-year').value);
    const month = parseInt(document.getElementById('select-month').value);

    let totalEkders = 0, totalNobet = 0, totalRehberlik = 0;

    // DEÄÄ°ÅÄ°KLÄ°K: ArtÄ±k tÃ¼m listeyi deÄŸil, fonksiyona gÃ¶nderilen
    // filtrelenmiÅŸ listeyi (personelListesi) kullanÄ±yoruz.
    personelListesi.forEach(personel => {
        if (personel.neviAdi.includes('EÄŸitim Personeli') || personel.unvan.includes('MÃ¼dÃ¼r')) {
            totalEkders += calculateMonthlyHours(personel.id).ekDers;
        }

        totalNobet += nobetVerisi[personel.id] || 0;
        totalRehberlik += calculateEffectiveRehberlikHours(personel.id, year, month, puantajData);
    });

    document.getElementById('total-ekders').textContent = totalEkders + " Saat";
    document.getElementById('total-nobet').textContent = totalNobet + " Saat";
    document.getElementById('total-rehberlik').textContent = totalRehberlik + " Saat";
}
// ==============================================================================
    
        

        function openEditModal(personelId, date) {
            const personel = puantajPersonelList.find(p => p.id == personelId);
            const dayData = puantajData[personelId]?.[date];
            if(!personel || !dayData) return;
            document.getElementById('p-modal-title').textContent = `${personel.ad} - ${formatDateDDMMYYYY(date)}`;
            document.getElementById('modal-status').value = dayData.code;
            document.getElementById('modal-hours').value = dayData.hours;
            document.getElementById('modal-notes').value = dayData.notes;
            const modalSaveBtn = document.getElementById('modal-save');
            modalSaveBtn.dataset.personelId = personelId;
            modalSaveBtn.dataset.date = date;
            document.getElementById('edit-modal-overlay').style.display = 'flex';
        }




        // MEVCUT downloadPdf FONKSÄ°YONUNU SÄ°LÄ°P BUNU EKLEYÄ°N
function downloadPdf() {
    const year = document.getElementById('input-year').value;
    const monthName = document.getElementById('select-month').options[document.getElementById('select-month').selectedIndex].text;
    const puantajTabloAlani = document.getElementById('puantaj-table-container');

    if (!puantajData || Object.keys(puantajData).length === 0) {
        showToast('PDF\'e aktarÄ±lacak puantaj verisi bulunmuyor.', 'error');
        return;
    }

    showToast('PDF oluÅŸturuluyor, lÃ¼tfen bekleyin...', 'info');

    // html2canvas kÃ¼tÃ¼phanesi ile puantaj alanÄ±nÄ±n resmini Ã§ekiyoruz
    html2canvas(puantajTabloAlani, {
        scale: 2, // GÃ¶rÃ¼ntÃ¼ kalitesini artÄ±rmak iÃ§in Ã¶lÃ§eÄŸi 2 katÄ±na Ã§Ä±kar
        useCORS: true,
        logging: false,
        // YENÄ° EKLENEN Ã–NEMLÄ° AYAR: Arka plan renklerinin Ã§izilmesini saÄŸlar.
        backgroundColor: '#ffffff' // Beyaz bir arka plan belirleyerek ÅŸeffaflÄ±ÄŸÄ± Ã¶nler
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        
        // PDF'i A3 boyutunda ve yatay olarak oluÅŸturuyoruz ki tablo sÄ±ÄŸsÄ±n
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'pt',
            format: 'a3'
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const ratio = canvasWidth / canvasHeight;

        // Resmin oranÄ±nÄ± koruyarak PDF'e sÄ±ÄŸdÄ±r
        let imgWidth = pdfWidth - 40; // Kenarlardan 20'ÅŸer puan boÅŸluk
        let imgHeight = imgWidth / ratio;

        // EÄŸer yÃ¼kseklik sayfaya sÄ±ÄŸmazsa, yÃ¼ksekliÄŸe gÃ¶re yeniden Ã¶lÃ§ekle
        if (imgHeight > pdfHeight - 40) {
            imgHeight = pdfHeight - 40;
            imgWidth = imgHeight * ratio;
        }

        const x = (pdfWidth - imgWidth) / 2;
        const y = (pdfHeight - imgHeight) / 2;

        pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
        pdf.save(`Puantaj_${monthName}_${year}.pdf`);
        showToast('PDF baÅŸarÄ±yla indirildi.', 'success');
    });
}

async function downloadExcel() {
    const year = document.getElementById('input-year').value;
    const month = parseInt(document.getElementById('select-month').value);
    const monthName = document.getElementById('select-month').options[month].text;

    // === BAÅLANGIÃ‡: DOÄRU FÄ°LTRELEME MANTIÄI ===
    const ayinIlkGunu = new Date(Date.UTC(year, month, 1));
    const ayinSonGunu = new Date(Date.UTC(year, month + 1, 0));

    const aktifPersonelList = puantajPersonelList.filter(personel => {
        const girisStr = personel.ise_giris;
        const ayrilisStr = personel.isten_ayrilis;

        if (!girisStr) return false;
        const girisDate = new Date(girisStr + 'T00:00:00Z');
        if (isNaN(girisDate.getTime())) return false;

        const iseBaslamisMi = girisDate <= ayinSonGunu;
        
        let istenAyrilmamisMi = true;
        if (ayrilisStr && ayrilisStr.trim() !== '' && ayrilisStr.trim() !== '---') {
            const ayrilisDate = new Date(ayrilisStr + 'T00:00:00Z');
            if (!isNaN(ayrilisDate.getTime())) {
                istenAyrilmamisMi = ayrilisDate >= ayinIlkGunu;
            }
        }
        return iseBaslamisMi && istenAyrilmamisMi;
    });
    // === BÄ°TÄ°Å: DOÄRU FÄ°LTRELEME MANTIÄI ===

    // Ekrandaki personel filtresini (dropdown) uygula
    const selectedPersonelId = document.getElementById('personel-filter-select').value;
    let personelToExport = aktifPersonelList;

    if (selectedPersonelId && selectedPersonelId !== 'all') {
        personelToExport = aktifPersonelList.filter(p => p.id === selectedPersonelId);
    }
    
    if (personelToExport.length === 0) {
        showToast('DÄ±ÅŸa aktarÄ±lacak personel bulunmuyor.', 'error');
        return;
    }

    showToast('FiltrelenmiÅŸ Excel dosyasÄ± hazÄ±rlanÄ±yor...', 'info');

    // Bu noktadan sonra fonksiyonun geri kalanÄ± (HTML tablo oluÅŸturma kÄ±smÄ±) aynÄ± kalabilir.
    // Fonksiyonunuzun geri kalanÄ±nÄ± buraya olduÄŸu gibi yapÄ±ÅŸtÄ±rÄ±n...
    const anaBaslik = `Ã–ZEL Ä°SABET ORTAOKULU ${year} YILI ${monthName.toLocaleUpperCase('tr-TR')} AYI PERSONEL PUANTAJ CETVELÄ°`;
    const nobetVerisi = await fetchAndCalculateNobetData(year, month);

    const styleMap = {
        'status-N': 'background-color:#E8F5E9; color:#1B5E20; font-weight:bold;', 'status-S': 'background-color:#FFF9C4; color:#AF6000; font-weight:bold;',
        'status-HT': 'background-color:#FFEBCC; color:#B85B00; font-weight:bold;', 'status-RT': 'background-color:#D1EAFE; color:#0D47A1; font-weight:bold;',
        'status-R': 'background-color:#FFEBEE; color:#B71C1C; font-weight:bold;', 'status-UI': 'background-color:#EAECEE; color:#566573; font-weight:bold;',
        'status-ÃœÄ°': 'background-color:#EAECEE; color:#566573; font-weight:bold;', 'status-Ä°': 'background-color: #E6E6FA; color: #483D8B; font-weight:bold;',
        'status-Y': 'background-color:#D7F9E9; color:#1B5E20; font-weight:bold;', 'status-K': 'background-color:#D7F9E9; color:#1B5E20; font-weight:bold;',
        'status-E': 'background-color:#EEEEEE; color:#424242;', 'status-RTÃ‡': 'background-color: #E1BEE7; color: #4A148C; font-weight:bold;',
        'summary-yellow': 'background-color:#FFECB3; font-weight:bold;', 'summary-green': 'background-color:#C8E6C9; font-weight:bold;',
        'summary-nobet': 'background-color:#FFE0B2; font-weight:bold;', 'summary-rehberlik': 'background-color:#C5CAE9; font-weight:bold;',
        'summary-overtime': 'background-color:#FFCDD2; font-weight:bold;', 'summary-count': 'background-color:#E3F2FD; font-weight:bold; width:35px;',
        'summary-reason': 'background-color:#D2B4DE; font-weight:bold;', 'summary-missing-day': 'background-color:#AED6F1; font-weight:bold;',
        'total-worked-day': 'background-color:#E3F2FD; font-weight:bold;', 'social-section': 'background-color:#E3F2FD;',
        'header': 'background-color:#343a40; color:white; font-weight:600; text-align:center; vertical-align:middle; border:0.5pt solid #888888; font-size:9pt; white-space:nowrap;',
        'group-header': 'background-color:#495057; color:white; font-weight:bold; text-align:left; padding-left:10px; font-size:13pt;',
        'main-title': 'text-align:center; font-size:16pt; font-weight:bold; vertical-align:middle;',
        'hour-cell': 'font-size:9pt; color:#192a56; font-weight:500; text-align:center; vertical-align:middle;',
        'default-cell': 'text-align:center; vertical-align:middle; font-size:9pt;',
        'personel-cell': 'text-align:left; vertical-align:middle; font-weight:bold; font-size:9pt;',
        'unvan-cell': 'text-align:left; vertical-align:middle; font-size:9pt;',
        'v-divider': 'border-right:1.5pt solid #333333;', 'h-divider': 'border-bottom:1.5pt solid #333333;',
    };
    let excelHtml = `<table width="100%"><tr><td colspan="50" style="${styleMap['main-title']}">${anaBaslik}</td></tr></table><br/>`;
    const gunler = ['Paz', 'Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt'];
    const gunBasliklari = ["N", "HT", "RT", "Ä°", "R", "ÃœÄ°", "S", "K", "RTÃ‡"];
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const grupluPersonel = {
        'Belirsiz SÃ¼reli': personelToExport.filter(p => p.sozlesme_turu === 'Belirsiz SÃ¼reli'),
        'Belirli SÃ¼reli': personelToExport.filter(p => p.sozlesme_turu === 'Belirli SÃ¼reli'),
        'KÄ±smi SÃ¼reli': personelToExport.filter(p => p.sozlesme_turu === 'KÄ±smi SÃ¼reli')
    };
    const saatBasliklariConfig = {
        'Belirsiz SÃ¼reli': { headers: ["AylÄ±k\nToplam", "Fazla\nMesai", "Mesai\nNedeni", "E. G.\nKodu"], keys: ["genelToplam", "fazlaMesai", "mesaiNedeni", "eksikGunKodu"], styleKeys: ["summary-yellow", "summary-overtime", "social-section", "summary-count"] },
        'Belirli SÃ¼reli': { headers: ["AylÄ±k\nToplam", "Ek\nDers", "NÃ¶bet", "Rehberlik"], keys: ["genelToplam", "ekDers", "nobet", "rehberlik"], styleKeys: ["summary-yellow", "summary-green", "summary-nobet", "summary-rehberlik"] },
        'KÄ±smi SÃ¼reli':    { headers: ["AylÄ±k\nToplam", "Ek\nDers", "NÃ¶bet", "Rehberlik"], keys: ["genelToplam", "ekDers", "nobet", "rehberlik"], styleKeys: ["summary-yellow", "summary-green", "summary-nobet", "summary-rehberlik"] }
    };
    excelHtml += '<table style="border-collapse:collapse;">';
    for (const grupAdi in grupluPersonel) {
        const personelGrubu = grupluPersonel[grupAdi];
        if (personelGrubu.length === 0) continue;
        const saatConfig = saatBasliklariConfig[grupAdi];
        const colspan = 3 + daysInMonth + saatConfig.headers.length + gunBasliklari.length + 4;
        excelHtml += `<tr><td colspan="${colspan}" style="${styleMap['group-header']} border:0.5pt solid #888888;">${grupAdi} Puantaj KayÄ±tlarÄ±</td></tr>`;
        excelHtml += `<tr><th rowspan="2" style="${styleMap['header']}">Personel</th><th rowspan="2" style="${styleMap['header']}">Unvan</th><th rowspan="2" style="${styleMap['header']} ${styleMap['v-divider']}">Ä°ÅŸe GiriÅŸ<br>Ä°ÅŸten Ã‡Ä±kÄ±ÅŸ</th><th colspan="${daysInMonth}" style="${styleMap['header']}">AylÄ±k Puantaj Durumu</th><th colspan="${saatConfig.headers.length}" style="${styleMap['header']} ${styleMap['v-divider']}">AylÄ±k Saat ToplamlarÄ±</th><th colspan="${gunBasliklari.length}" style="${styleMap['header']} ${styleMap['v-divider']}">AylÄ±k GÃ¼n ToplamlarÄ±</th><th rowspan="2" style="${styleMap['header']} ${styleMap['v-divider']}">Sgk&nbsp;Prim&nbsp;GÃ¼nÃ¼</th><th colspan="3" style="${styleMap['header']}">Sosyal YardÄ±mlar</th><th rowspan="2" style="${styleMap['header']}">Ä°mza</th></tr><tr>`;
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dividerStyle = (date.getDay() === 0 || day === daysInMonth) ? styleMap['v-divider'] : '';
            excelHtml += `<th style="${styleMap['header']} ${dividerStyle}">${day}<br>${gunler[date.getDay()]}</th>`;
        }
        saatConfig.headers.forEach(h => excelHtml += `<th style="${styleMap['header']} ${styleMap['v-divider']}">${h.replace('\n', '<br>')}</th>`);
        gunBasliklari.forEach(h => excelHtml += `<th style="${styleMap['header']} ${styleMap['v-divider']}">${h}</th>`);
        excelHtml += `<th style="${styleMap['header']}">EÅŸ Durumu</th><th style="${styleMap['header']}">Ã‡ocuk 0-6</th><th style="${styleMap['header']}">Ã‡ocuk 6-18</th></tr>`;
        personelGrubu.forEach(personel => {
            const pData = puantajData[personel.id] || {};
            const monthlyHours = calculateMonthlyHours(personel.id);
            const nobetSaat = nobetVerisi[personel.id] || 0;
            const rehberlikSaat = calculateEffectiveRehberlikHours(personel.id, year, month, puantajData);
            const fazlaMesaiSaat = calculateFazlaMesai(personel.id);
            const statusCounts = calculateStatusCounts(personel.id);
            let sgkPrimGunu = new Date(year, month + 1, 0).getDate() - ((statusCounts.R || 0) + (statusCounts.ÃœÄ° || 0));
            if(personel.sozlesme_turu === 'KÄ±smi SÃ¼reli') { sgkPrimGunu = Math.round(monthlyHours.genelToplam / 7.5); }
            let ayrilisTarihiGoster = '---';
            if (personel.isten_ayrilis && personel.isten_ayrilis !== '---') {
                const ayrilisDate = new Date(personel.isten_ayrilis + 'T00:00:00Z');
                if (ayrilisDate.getUTCFullYear() === year && ayrilisDate.getUTCMonth() === month) {
                    ayrilisTarihiGoster = formatDateDDMMYYYY(personel.isten_ayrilis);
                }
            }
           let statusRowHtml = `<td rowspan="2" style="${styleMap['personel-cell']} border:0.5pt solid #888888;">${(personel.ad || '').replace('\n', '<br>')}</td><td rowspan="2" style="${styleMap['unvan-cell']} border:0.5pt solid #888888;">${(personel.unvan || '').replace('\n', '<br>')}</td><td rowspan="2" style="${styleMap['default-cell']} ${styleMap['v-divider']} border:0.5pt solid #888888;">${formatDateDDMMYYYY(personel.ise_giris)}<br>${ayrilisTarihiGoster}</td>`;
            let hoursRowHtml = '';
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = pData[dateString] || {};
                const dayStyle = styleMap[`status-${dayData.code}`] || '';
                const dividerStyle = (new Date(year, month, day).getDay() === 0 || day === daysInMonth) ? styleMap['v-divider'] : '';
                statusRowHtml += `<td style="${styleMap['default-cell']} ${dayStyle} ${dividerStyle} border:0.5pt solid #888888;">${dayData.code || ''}</td>`;
                const hourContent = (dayData.code === 'N' || dayData.code === 'RTÃ‡' || dayData.code === 'Y' || dayData.code === 'K') && dayData.hours > 0 ? dayData.hours : '';
                hoursRowHtml += `<td style="mso-number-format:'\\@'; ${styleMap['hour-cell']} ${dividerStyle} ${styleMap['h-divider']} border:0.5pt solid #888888;">${hourContent}</td>`;
            }
            const saatDegerleri = { 
                genelToplam: monthlyHours.genelToplam, 
                fazlaMesai: fazlaMesaiSaat, 
                mesaiNedeni: overtimeReasons[personel.id] || '', 
                eksikGunKodu: missingDayCodes[personel.id] || '',
                ekDers: monthlyHours.ekDers, 
                nobet: nobetSaat, 
                rehberlik: rehberlikSaat, 
                ht_saat: 0 
            };
            saatConfig.keys.forEach((key, index) => {
                 statusRowHtml += `<td rowspan="2" style="mso-number-format:'\\@'; ${styleMap['default-cell']} ${styleMap[saatConfig.styleKeys[index]]} ${styleMap['v-divider']} border:0.5pt solid #888888;">${saatDegerleri[key]}</td>`;
            });
            gunBasliklari.forEach(h => {
                statusRowHtml += `<td rowspan="2" style="${styleMap['summary-count']} ${styleMap['v-divider']} border:0.5pt solid #888888;">${statusCounts[h] || 0}</td>`;
            });
            statusRowHtml += `<td rowspan="2" style="${styleMap['total-worked-day']} ${styleMap['v-divider']} border:0.5pt solid #888888;">${sgkPrimGunu}</td><td rowspan="2" style="${styleMap['social-section']} border:0.5pt solid #888888;">${personel.esDurumu || ''}</td><td rowspan="2" style="${styleMap['social-section']} border:0.5pt solid #888888;">${personel.cocuk0_6 || ''}</td><td rowspan="2" style="${styleMap['social-section']} border:0.5pt solid #888888;">${personel.cocuk6_18 || ''}</td><td rowspan="2" style="border:0.5pt solid #888888;"></td>`;
            excelHtml += `<tr>${statusRowHtml}</tr><tr>${hoursRowHtml}</tr>`;
        });
    }
    excelHtml += '</table>';
    const fullHtml = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
        <head><meta charset="UTF-8">
            </head>
        <body>${excelHtml}</body>
        </html>`;
    const blob = new Blob([fullHtml], { type: 'application/vnd.ms-excel' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Puantaj_${monthName}_${year}.xls`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Excel dosyasÄ± baÅŸarÄ±yla indirildi.', 'success');
}


async function saveModalChanges() {
    const modalSaveBtn = document.getElementById('modal-save');
    const personelId = modalSaveBtn.dataset.personelId;
    const date = modalSaveBtn.dataset.date;

    if (!personelId || !date) {
        showToast('Veri kaydedilirken bir hata oluÅŸtu.', 'error');
        return;
    }

    const newCode = document.getElementById('modal-status').value;
    const newHours = parseFloat(document.getElementById('modal-hours').value) || 0;
    const newNotes = document.getElementById('modal-notes').value;

    if (puantajData[personelId] && puantajData[personelId][date]) {
        puantajData[personelId][date] = {
            code: newCode,
            hours: newHours,
            notes: newNotes
        };
    }

    document.getElementById('edit-modal-overlay').style.display = 'none';
    
    // DeÄŸiÅŸiklikleri veritabanÄ±na kalÄ±cÄ± olarak kaydetmek iÃ§in ana kaydetme fonksiyonunu Ã§aÄŸÄ±rÄ±yoruz.
    await savePuantajData(); // <-- YENÄ° EKLENEN SATIR

    // Tabloyu ve toplamlarÄ± yeniden Ã§izmek iÃ§in ilgili fonksiyonlarÄ± tekrar Ã§aÄŸÄ±r.
    // Not: savePuantajData zaten baÅŸarÄ±lÄ± bir toast mesajÄ± gÃ¶sterdiÄŸi iÃ§in aÅŸaÄŸÄ±daki satÄ±rÄ± kaldÄ±rabilir veya deÄŸiÅŸtirebilirsiniz.
    const year = parseInt(document.getElementById('input-year').value);
    const month = parseInt(document.getElementById('select-month').value);
    const nobetVerisi = await fetchAndCalculateNobetData(year, month);
    
    // Bu kÄ±sÄ±m aslÄ±nda savePuantajData'dan sonra tekrar tabloyu en gÃ¼ncel haliyle Ã§izmek iÃ§in
    // loadPuantajDataForCurrentMonth fonksiyonunu Ã§aÄŸÄ±rmak daha doÄŸru olabilir ama mevcut yapÄ± da iÅŸ gÃ¶rÃ¼r.
    await loadPuantajDataForCurrentMonth(); // Tabloyu veritabanÄ±ndan gelen son haliyle yeniden yÃ¼klemesi daha garanti.
    
    // showToast('GÃ¼ncelleme baÅŸarÄ±yla veritabanÄ±na kaydedildi.', 'success'); // Ä°steÄŸe baÄŸlÄ± olarak bu mesajÄ± kullanabilirsiniz.
}
// =================== 3. ADIM BÄ°TÄ°ÅÄ° ===================
function printPuantaj() {
    window.print();
}

// BU YENÄ° VE GÃœNCELLENMÄ°Å FONKSÄ°YONU EKLEYÄ°N
async function applyBulkUpdate() {
    const day = document.getElementById('bulk-update-day').value;
    const group = document.getElementById('bulk-update-group').value;
    const newStatusCode = document.getElementById('bulk-update-status').value;
    const year = parseInt(document.getElementById('input-year').value);
    const month = parseInt(document.getElementById('select-month').value);

    if (!day || !group || !newStatusCode) {
        return showToast('LÃ¼tfen GÃ¼n, Grup ve Durum Kodu seÃ§in.', 'error');
    }
    if (!puantajData || Object.keys(puantajData).length === 0) {
        return showToast('Ã–nce bir puantaj oluÅŸturmalÄ± veya yÃ¼klemelisiniz.', 'error');
    }

    const confirmationMessage = `'${group}' grubundaki tÃ¼m personel iÃ§in ayÄ±n ${day}. gÃ¼nÃ¼nÃ¼n durumunu '${newStatusCode}' olarak deÄŸiÅŸtirmek istediÄŸinizden emin misiniz?`;
    if (!confirm(confirmationMessage)) {
        return;
    }

    // DÃœZELTME 1: Ã–nce o ay iÃ§in aktif olan tÃ¼m personeli buluyoruz.
    const aktifPersonelList = puantajPersonelList.filter(personel => {
        const ayrilisStr = personel.isten_ayrilis;
        if (!ayrilisStr || ayrilisStr.trim() === '' || ayrilisStr.trim() === '---') return true;
        const ayrilisDate = new Date(ayrilisStr + 'T00:00:00Z');
        if (isNaN(ayrilisDate.getTime())) return true;
        const ayrilisYear = ayrilisDate.getUTCFullYear();
        const ayrilisMonth = ayrilisDate.getUTCMonth();
        if (ayrilisYear > year) return true;
        if (ayrilisYear === year && ayrilisMonth >= month) return true;
        return false;
    });

    // Åimdi, aktif personel listesinden kullanÄ±cÄ±nÄ±n seÃ§tiÄŸi grubu filtreliyoruz.
    const targetPersonnel = aktifPersonelList.filter(p => {
        if (group === 'TÃ¼mÃ¼') return true;
        return p.sozlesme_turu === group;
    });

    if (targetPersonnel.length === 0) {
        return showToast('SeÃ§ilen grupta gÃ¼ncellenecek personel bulunamadÄ±.', 'info');
    }

    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

    targetPersonnel.forEach(personel => {
        if (puantajData[personel.id] && puantajData[personel.id][dateString]) {
            puantajData[personel.id][dateString].code = newStatusCode;
        }
    });

    showToast('GÃ¼ncelleme uygulanÄ±yor...', 'info');
    const nobetVerisi = await fetchAndCalculateNobetData(year, month);

    // DÃœZELTME 2: Tabloyu Ã§izen fonksiyona artÄ±k aktif personel listesini de gÃ¶nderiyoruz.
    renderPuantajTable(nobetVerisi, aktifPersonelList);
    renderGrandTotals(nobetVerisi, aktifPersonelList);    attachCellListeners();

    showToast('Toplu gÃ¼ncelleme baÅŸarÄ±yla uygulandÄ±!', 'success');
}


// OlasÄ± bir sonraki hatayÄ± Ã¶nlemek iÃ§in: Eksik attachCellListeners fonksiyonu
function attachCellListeners() {
    const cells = document.querySelectorAll('.status-cell');
    cells.forEach(cell => {
        cell.addEventListener('click', () => {
            const personelId = cell.dataset.personelId;
            const date = cell.dataset.date;
            openEditModal(personelId, date);
        });
    });
}


        document.addEventListener('DOMContentLoaded', () => {
// === MOBÄ°L HAMBURGER MENÃœ MANTIÄI ===
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const sidebar = document.querySelector('.sidebar');
        
        if (hamburgerBtn) {
            hamburgerBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // DiÄŸer tÄ±klama olaylarÄ±nÄ± engelle
                sidebar.classList.toggle('open');
            });
        }
        
        // MenÃ¼deki bir linke tÄ±klandÄ±ÄŸÄ±nda menÃ¼nÃ¼n otomatik kapanmasÄ±nÄ± saÄŸla
        sidebar.addEventListener('click', (e) => {
            if (e.target.closest('a')) {
                sidebar.classList.remove('open');
            }
        });

        // MenÃ¼ dÄ±ÅŸÄ±na tÄ±klandÄ±ÄŸÄ±nda menÃ¼yÃ¼ kapat
        document.body.addEventListener('click', (e) => {
            if (sidebar.classList.contains('open') && !sidebar.contains(e.target)) {
                 sidebar.classList.remove('open');
            }
        });
    // KULLANICI DURUMUNU KONTROL EDEN ANA YAPI
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // KULLANICI GÄ°RÄ°Å YAPMIÅSA:
            loginPanel.style.display = 'none';
            appContainer.style.display = 'flex';

renderDashboardData(); // <--- YENÄ° EKLENEN SATIR BU

            

            // --- UYGULAMA BAÅLATMA KODLARI (SADECE GÄ°RÄ°Å YAPILDIÄINDA Ã‡ALIÅIR) ---
            const modal = document.getElementById('add-staff-modal');
            const personelForm = document.getElementById('personelForm');
            const openModal = (staffId=null, staffData={}) => { loadPersonelForm(staffId, staffData); modal.classList.add('open'); };
            const closeModal = () => modal.classList.remove('open');

            document.getElementById('open-add-staff-modal').addEventListener('click', () => openModal());
            document.getElementById('add-staff-from-list-btn').addEventListener('click', () => openModal());
            modal.querySelector('.close-modal').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });


            // ======================= YERÄ°NE BU DOÄRU KOD BLOÄUNU EKLEYÄ°N =======================
document.querySelectorAll('.nav-link, .sub-menu a').forEach(link => {
    // MenÃ¼deki "Yeni Personel Ekle" butonu ayrÄ± yÃ¶netildiÄŸi iÃ§in onu hariÃ§ tutuyoruz
    if (link.id === 'open-add-staff-modal') return;

    link.addEventListener('click', function(e) {
        // EÄŸer linkin bir hedefi varsa, varsayÄ±lan tÄ±klama eylemini engelle
        if (this.dataset.target) e.preventDefault();
        
        const targetId = this.dataset.target;
        if (!targetId) return; // EÄŸer linkin bir hedefi yoksa fonksiyondan Ã§Ä±k

        // TÃ¼m menÃ¼ linklerinden ve iÃ§erik modÃ¼llerinden 'active' sÄ±nÄ±fÄ±nÄ± kaldÄ±r
        document.querySelectorAll('.nav-link, .accordion-trigger, .module').forEach(el => el.classList.remove('active'));
        
        // TÄ±klanan linke ve eÄŸer varsa ana menÃ¼ grubuna 'active' sÄ±nÄ±fÄ±nÄ± ekle
        this.classList.add('active');
        if (this.closest('.menu-item-group')) {
            this.closest('.menu-item-group').querySelector('a').classList.add('active');
        }
        
        // Hedef iÃ§erik modÃ¼lÃ¼nÃ¼ gÃ¶rÃ¼nÃ¼r yap
        document.getElementById(targetId).classList.add('active');

        // Hangi modÃ¼lÃ¼n aktif olduÄŸuna baÄŸlÄ± olarak ilgili fonksiyonu Ã§aÄŸÄ±r
        if (targetId === 'dashboard') renderDashboardData(); // Dashboard yenileme eklendi
        if (targetId === 'staff-list') fetchStaff();
        if (targetId === 'settings') initializeSettings();
        if (targetId === 'gorevlendirme') initializeGorevlendirme(); 
        if (targetId === 'nobet-takip') initializeNobetTakip();
        if (targetId === 'puantaj') initializePuantaj();
        if (targetId === 'izin-takip') initializeIzinTakip();
        if (targetId === 'ders-programi') initializeSchedule();
    });
});
// ==============================================================================

            document.querySelectorAll('.accordion-trigger').forEach(acc => acc.addEventListener('click', e => { e.preventDefault(); acc.parentElement.classList.toggle('open'); }));

            personelForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const editingId = e.target.dataset.editingId;
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    // KÄ±smi sÃ¼reli Ã§alÄ±ÅŸma verilerini gÃ¼venli bir ÅŸekilde iÅŸle
    if (data.sozlesme_turu === 'KÄ±smi SÃ¼reli') {
        data.kismi_zamanli_calisma = {};
        const gunler = formData.getAll('kismi_gunler'); // SeÃ§ili tÃ¼m gÃ¼nler
        const gunMap = {
            'Pazartesi': 'pzts_saat',
            'SalÄ±': 'sali_saat',
            'Ã‡arÅŸamba': 'crs_saat',
            'PerÅŸembe': 'prs_saat',
            'Cuma': 'cuma_saat',
            'Cumartesi': 'cmrts_saat',
            'Pazar': 'pazar_saat'
        };

        gunler.forEach(gunAdi => {
            const saatInputAdi = gunMap[gunAdi];
            // EÄŸer gÃ¼n haritada varsa ve ilgili saat input'u doluysa veriyi iÅŸle
            if (saatInputAdi && data[saatInputAdi]) {
                const saatDegeri = parseInt(data[saatInputAdi], 10);
                if (!isNaN(saatDegeri)) { // SayÄ±sal bir deÄŸer olduÄŸundan emin ol
                    data.kismi_zamanli_calisma[gunAdi] = saatDegeri;
                }
            }
        });

        // Ana 'data' objesinden artÄ±k gereksiz olan geÃ§ici anahtarlarÄ± temizle
        delete data.kismi_gunler;
        Object.values(gunMap).forEach(inputAdi => delete data[inputAdi]);
    }

    try {
        if (editingId) {
            await setDoc(doc(db, "personel", editingId), data, { merge: true });
            showToast('Personel baÅŸarÄ±yla gÃ¼ncellendi.');
        } else {
            await addDoc(collection(db, "personel"), data);
            showToast('Personel baÅŸarÄ±yla eklendi.');
        }
        closeModal();
        // EÄŸer personel listesi ekranÄ± aktifse, listeyi yenile
        if (document.getElementById('staff-list').classList.contains('active')) {
            fetchStaff();
        }
    } catch (err) {
        showToast('Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.', 'error');
        console.error("Personel kaydetme/gÃ¼ncelleme hatasÄ±:", err);
    }
});
            document.getElementById('staff-list').addEventListener('click', async (e) => {
                if(e.target.classList.contains('btn-delete')) { if (confirm('Bu personeli silmek istediÄŸinizden emin misiniz?')) { await deleteDoc(doc(db, 'personel', e.target.dataset.id)); showToast('Personel silindi.'); fetchStaff(); } }
                if(e.target.classList.contains('btn-edit')) { const docSnap = await getDoc(doc(db, 'personel', e.target.dataset.id)); if(docSnap.exists()) openModal(docSnap.id, docSnap.data()); }
            });

            document.getElementById('ekleBtn').addEventListener('click', addLesson);

        } else {
            // KULLANICI GÄ°RÄ°Å YAPMAMIÅSA VEYA Ã‡IKIÅ YAPTIYSA:
            loginPanel.style.display = 'flex';
            appContainer.style.display = 'none';
        }
    });

    // GÄ°RÄ°Å VE Ã‡IKIÅ BUTONLARINA OLAYLARI EKLEME
    loginBtn.addEventListener('click', async () => {
        const email = loginEmailInput.value;
        const password = loginPasswordInput.value;
        loginError.style.display = 'none';

        try {
            await signInWithEmailAndPassword(auth, email, password);
            // BaÅŸarÄ±lÄ± giriÅŸ sonrasÄ± onAuthStateChanged tetiklenecek ve paneli gÃ¶sterecek.
        } catch (error) {
            loginError.textContent = "HatalÄ± e-posta veya ÅŸifre.";
            loginError.style.display = 'block';
            console.error("GiriÅŸ HatasÄ±:", error);
        }
    });

    logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    ;
                }
            });
});

    </script>

<div id="edit-nobet-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>NÃ¶bet KaydÄ±nÄ± DÃ¼zenle</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-nobet-form">
                    <input type="hidden" id="edit-nobet-id">
                    <div class="form-grid" style="grid-template-columns: 1fr 2fr 2fr; align-items: flex-end;">
                        <div class="form-group">
                            <label for="edit-nobet-tarih">Tarih</label>
                            <input type="date" id="edit-nobet-tarih">
                        </div>
                        <div class="form-group">
                            <label for="edit-nobet-personel">NÃ¶betÃ§i Personel</label>
                            <select id="edit-nobet-personel"></select>
                        </div>
                        <div class="form-group">
                            <label for="edit-nobet-yeri">NÃ¶bet Yeri</label>
                            <select id="edit-nobet-yeri"></select>
                        </div>
                    </div>
                    <div class="button-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-save">DeÄŸiÅŸiklikleri Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
<div id="toplu-izin-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3>Toplu Ä°zin GiriÅŸi</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-top: 0; margin-bottom: 20px; background-color: #eef1f3; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6;">
                Bu ekranÄ± kullanarak seÃ§ili personellere aynÄ± anda, belirtilen tarihler arasÄ±nda izin atayabilirsiniz. Bu iÅŸlem, her bir personel iÃ§in ayrÄ± bir izin kaydÄ± oluÅŸturacaktÄ±r.
            </p>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 2fr; margin-bottom: 20px; align-items: flex-end;">
                <div class="form-group">
                    <label for="toplu-izin-baslangic">BaÅŸlangÄ±Ã§ Tarihi</label>
                    <input type="date" id="toplu-izin-baslangic">
                </div>
                <div class="form-group">
                    <label for="toplu-izin-bitis">BitiÅŸ Tarihi</label>
                    <input type="date" id="toplu-izin-bitis">
                </div>
                <div class="form-group">
                    <label for="toplu-izin-tipi">Ä°zin Tipi</label>
                    <select id="toplu-izin-tipi">
                        <option value="">Ä°zin Tipi SeÃ§iniz...</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label style="margin-bottom: 10px;">Ä°zin Atanacak Personeller</label>
                <div id="toplu-personel-listesi" style="height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 15px; border-radius: 6px; background: #fdfdfd; display: flex; flex-direction: column; gap: 8px;">
                    <p>Personel listesi yÃ¼kleniyor...</p>
                </div>
            </div>
            <div class="button-group" style="margin-top: 25px;">
                <button id="toplu-izin-kaydet-btn" class="btn btn-save">SeÃ§ili Personellere Ä°zin Ata</button>
            </div>
        </div>
    </div>
</div>
<div id="dilekce-date-modal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
            <h3>DilekÃ§e Tarihini Belirtin</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p>LÃ¼tfen dilekÃ§enin Ã¼zerinde gÃ¶rÃ¼necek resmi tarihi seÃ§iniz.</p>
            <div class="form-group">
                <label for="dilekce-tarih-input">DilekÃ§e Tarihi</label>
                <input type="date" id="dilekce-tarih-input">
            </div>
            <div class="button-group">
                <button id="generate-dilekce-with-date-btn" class="btn btn-save">DilekÃ§eyi OluÅŸtur</button>
            </div>
        </div>
    </div>
</div>
<div id="edit-izin-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3>Ä°zin KaydÄ±nÄ± DÃ¼zenle</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="edit-izin-form">
                <input type="hidden" id="edit-izin-id">
                <div class="form-grid" style="grid-template-columns: 2fr 1.5fr 1fr 1fr; align-items: flex-end;">
                    <div class="form-group">
                        <label for="edit-izin-personel">Personel</label>
                        <select id="edit-izin-personel" disabled></select>
                    </div>
                    <div class="form-group">
                        <label for="edit-izin-tipi">Ä°zin Tipi</label>
                        <select id="edit-izin-tipi"></select>
                    </div>
                    <div class="form-group">
                        <label for="edit-izin-baslangic">BaÅŸlangÄ±Ã§ Tarihi</label>
                        <input type="date" id="edit-izin-baslangic">
                    </div>
                    <div class="form-group">
                        <label for="edit-izin-bitis">BitiÅŸ Tarihi</label>
                        <input type="date" id="edit-izin-bitis">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="edit-izin-aciklama">AÃ§Ä±klama / Not</label>
                        <input type="text" id="edit-izin-aciklama" placeholder="Ä°zinle ilgili kÄ±sa bir not...">
                    </div>
                </div>
                <div class="button-group" style="margin-top: 25px;">
                    <button type="submit" class="btn btn-save">DeÄŸiÅŸiklikleri Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js').then(registration => {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
      }, err => {
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }
</script>
</body>
</html>