<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okul Puantaj Sistemi</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#192a56"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        :root {
            --theme-primary: #192a56; --theme-accent: #f39c12; --sidebar-bg: var(--theme-primary);
            --sidebar-text: #e0e0e0; --sidebar-hover-bg: #2c3e50; --sidebar-active-bg: var(--theme-accent);
            --light-gray-color: #f4f7f9; --dark-text-color: #2c3e50; --border-color: #dee2e6;
            --white-color: #ffffff; --success-color: #28a745; --danger-color: #dc3545; --info-color: #17a2b8;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--light-gray-color); }
        .app-container { display: flex; height: 100vh; }
        .sidebar {
    width: 230px;
    background-color: var(--sidebar-bg);
    color: var(--sidebar-text);
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    /* EKLENEN YENİ KODLAR BAŞLANGICI */
    position: fixed; /* Kenar çubuğu ekrana sabitler */
    top: 0;
    left: 0;
    height: 100%; /* Yüksekliği ekranın tamamı yapar */
    z-index: 100; /* Diğer elemanların üzerinde kalmasını sağlar */
    /* EKLENEN YENİ KODLAR BİTİŞİ */
}
.sidebar nav {
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
    }
    
    .sidebar nav::-webkit-scrollbar {
        width: 8px;
    }
    .sidebar nav::-webkit-scrollbar-track {
        background: transparent;
    }
    .sidebar nav::-webkit-scrollbar-thumb {
        background-color: var(--sidebar-hover-bg);
        border-radius: 10px;
        border: 2px solid var(--sidebar-bg);
    }
    .sidebar nav::-webkit-scrollbar-thumb:hover {
        background-color: var(--theme-accent);
    }
        /* LOGO VE YENİ BAŞLIK İÇİN GÜNCELLENMİŞ STİL */
.sidebar-header {
    padding: 15px;
    border-bottom: 1px solid var(--sidebar-hover-bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
}
.sidebar-header img {
    width: 160px; /* Yeni logo için daha geniş bir boyut */
    height: auto; /* Resim oranını korur */
    border-radius: 8px; /* Kenarları hafifçe yuvarlatır, daha modern bir görünüm için (isteğe bağlı) */
}
.sidebar-header span {
    font-size: 1.1em;
    font-weight: bold;
    color: var(--white-color);
}
        .sidebar-nav { list-style: none; padding: 0; margin: 20px 0; }
        .sidebar-nav li a { display: flex; align-items: center; gap: 10px; padding: 15px 20px; color: var(--sidebar-text); text-decoration: none; transition: background-color 0.2s, color 0.2s; border-left: 4px solid transparent; cursor: pointer; }
        .sidebar-nav li a:hover { background-color: var(--sidebar-hover-bg); color: var(--white-color); }
        .sidebar-nav li a.active { background-color: var(--sidebar-active-bg); color: var(--theme-primary); font-weight: bold; }
        .menu-item-group .accordion-trigger { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .menu-item-group .accordion-trigger::after { content: '▶'; font-size: 0.7em; transition: transform 0.2s; }
        .menu-item-group.open > .accordion-trigger::after { transform: rotate(90deg); }
        .sub-menu { list-style: none; padding-left: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; background-color: rgba(0,0,0,0.2); }

.sidebar-footer a {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 20px;
    color: var(--sidebar-text);
    text-decoration: none;
    transition: background-color 0.2s;
}
.sidebar-footer a:hover {
    background-color: var(--danger-color);
    color: var(--white-color);
}
        .menu-item-group.open .sub-menu { max-height: 500px; }
        .sub-menu li a { padding-left: 45px; font-size: 0.95em; }
        .sub-menu li a.active { color: var(--white-color); background-color: transparent; border-left-color: var(--theme-accent); }
.sidebar-footer {
    margin-top: auto; /* Bu sihirli satır, elemanı en alta iter */
    padding: 10px 0;
    border-top: 1px solid var(--sidebar-hover-bg);
    flex-shrink: 0;
}
.sidebar-footer a {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 20px;
    color: var(--sidebar-text);
    text-decoration: none;
    transition: background-color 0.2s;
}
.sidebar-footer a:hover {
    background-color: var(--danger-color);
    color: var(--white-color);
}
.sidebar-footer a {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 20px;
    color: var(--sidebar-text);
    text-decoration: none;
    transition: background-color 0.2s;
}
.sidebar-footer a:hover {
    background-color: var(--danger-color);
    color: var(--white-color);
}
        .main-content { flex-grow: 1; overflow-y: auto; padding: 25px; margin-left: 230px; /* Kenar menü genişliği kadar soldan boşluk */ }
        .module { display: none; }
        .module.active { display: block; }
        .panel { background-color: var(--white-color); border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .panel-header { padding: 18px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .panel-header h3 { margin: 0; font-size: 1.2em; color: var(--dark-text-color); }
        .panel-body { padding: 25px; }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(44, 62, 80, 0.85); /* <-- GÜNCELLENDİ */
            -webkit-backdrop-filter: blur(4px); /* <-- YENİ EKLENDİ */
            backdrop-filter: blur(4px); /* <-- YENİ EKLENDİ */
            justify-content: center; 
            align-items: center; 
        }
        .modal.open { display: flex; }
        .modal-content { background-color: var(--light-gray-color); border-radius: 10px; width: 90%; max-width: 900px; max-height: 95vh; display: flex; flex-direction: column; animation: fadeIn 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 25px; border-bottom: 1px solid var(--border-color); background-color: var(--white-color); border-top-left-radius: 10px; border-top-right-radius: 10px; }
        .modal-header h3 { margin: 0; font-size: 1.2em; color: var(--theme-primary); }
        .close-modal { font-size: 1.8rem; font-weight: bold; color: #aaa; background: none; border: none; cursor: pointer; }
        .modal-body { padding: 25px; overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px 25px; }
        #gorevlendirme .form-container .form-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid var(--border-color); }
        .full-width { grid-column: 1 / -1; }
        .button-group { text-align: right; margin-top: 15px; }
.izin-hesaplama-alani {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        #personel-izin-hakki, #izin-hesaplama-sonucu {
            flex: 1;
            padding: 12px;
            background-color: #eef1f3;
            border-radius: 6px;
            border: 1px solid #d8dde2;
            font-size: 14px;
            color: #37474f;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #izin-hesaplama-sonucu {
            font-weight: bold;
            background-color: #e6f7ff;
            border-color: #b3e0ff;
            color: #0056b3;
        }
        .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--white-color); }
        td.actions-cell { width: auto; min-width: 160px; display: flex; gap: 8px; align-items: center; }
        .actions-cell .btn { flex: 1; }
        .btn-edit { background-color: var(--info-color); }
        .btn-delete { background-color: var(--danger-color); }
        .btn-save { padding: 12px 30px; background-color: var(--theme-accent); }
        .btn-header-add { background-color: var(--theme-accent); color: var(--white-color); font-weight: bold; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; transition: opacity 0.2s; }
        table.staff-table { width: 100%; border-collapse: collapse; }
        table.staff-table th, table.staff-table td { padding: 12px 15px; border: 1px solid var(--border-color); text-align: left; vertical-align: middle; }
        table.staff-table th { background-color: var(--light-gray-color); font-weight: 600; color: var(--dark-text-color); }
        .radio-group { display: flex; align-items: center; gap: 25px; padding-top: 5px; }
        .radio-group div { display: flex; align-items: center; gap: 8px; }
        .radio-group label { font-weight: normal; margin-bottom: 0; }
        .radio-group input { width: auto; margin-right: 0; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 20px; color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateX(100%); animation: slideIn 0.3s forwards; }
        .toast.success { background-color: var(--success-color); }
.toast.error { background-color: var(--danger-color); }

/* YENİ EKLENEN BİLGİ UYARISI STİLİ */
.toast.info { background-color: var(--info-color); }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } } @keyframes slideOut { to { opacity: 0; transform: translateX(100%); } }
        .settings-tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .settings-tab-button { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; border-bottom: 3px solid transparent; }
        .settings-tab-button.active { color: var(--theme-primary); border-bottom-color: var(--theme-primary); font-weight: 600; }
        .settings-tab-content { display: none; }
        .settings-tab-content.active { display: block; animation: fadeIn 0.5s; }
        .settings-list { list-style: none; padding: 0; margin-top: 20px; max-height: 250px; overflow-y: auto; }
        .settings-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; }
        .settings-list .btn-delete-setting { background-color: var(--danger-color); font-size: 12px; padding: 5px 10px; }
        .add-setting-form { display: flex; gap: 10px; align-items: flex-end; }
        .add-setting-form input, .add-setting-form select { margin-bottom: 0; }
        .add-setting-form button { flex-shrink: 0; height: 46px; background-color: var(--success-color); }
        .tab-container { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-link { padding: 12px 25px; cursor: pointer; border: none; background-color: transparent; font-size: 18px; font-weight: 500; color: #606770; border-bottom: 3px solid transparent; }
        .tab-link.active { color: #1877f2; border-bottom: 3px solid #1877f2; }
        .form-container { display: flex; justify-content: center; align-items: flex-end; gap: 15px; margin-bottom: 30px; padding: 20px; background-color: #f7f8fa; border: 1px solid #ddd; border-radius: 8px; flex-wrap: wrap; }
        #ekleBtn { padding: 10px 20px; background-color: #42b72a; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; height: 46px; }
        .schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .schedule-table th, .schedule-table td { border: 1px solid #e9ebee; padding: 6px; text-align: center; height: 75px; vertical-align: top; }
        .ders-karti { background-color: #1877f2; color: white; padding: 6px; border-radius: 6px; font-size: 13px; height: calc(100% - 12px); box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .detail-entry {
    display: grid;
    /* Üçüncü sütunu da esnek (1fr) yaparak alanları eşitliyoruz */
    grid-template-columns: 1fr 1fr 1fr auto;
    gap: 15px;
    align-items: flex-end;
    margin-top: 15px;
}
        #edit-g-detay-ekle-btn { background-color: var(--success-color); }


#gecici-detay-listesi { 
    list-style: none; 
    padding: 0; 
    margin-top: 15px; 
}
        #g-detay-ekle-btn { background-color: #28a745; }
        #gecici-detay-listesi { list-style: none; padding: 0; margin-top: 15px; }
        #gecici-detay-listesi li { display: flex; justify-content: space-between; align-items: center; background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 8px; }
        .delete-temp-btn { background: none; border: none; color: var(--danger-color); cursor: pointer; font-weight: bold; }
        .table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-top: 20px;}
        .gorevlendirme-table { width: 100%; border-collapse: collapse; }
        .gorevlendirme-table thead th { background-color: #343a40; color: white; font-weight: 600; padding: 12px; text-align: left; }
        .gorevlendirme-table tbody td { border-top: 1px solid var(--border-color); padding: 12px; vertical-align: middle; }
        .gorevlendirme-table tbody tr:hover { background-color: #f1f9ff; }
        .gorevlendirme-table .ders-detaylari { list-style-type: square; margin: 0; padding-left: 20px; }
        #nobet-rapor-tbody .btn-delete-nobet, #izin-kayitlari-tbody .btn-delete-izin { background-color: var(--danger-color); padding: 5px 10px; font-size: 12px; }
        .gorevlendirme-table tbody tr.renk-a {
        background-color: #fdfdfe; /* Çok açık bir gri tonu */
}
       .gorevlendirme-table tbody tr.renk-b {
       background-color: #f0f3f5; /* Biraz daha belirgin bir gri tonu */
}
      .gorevlendirme-table tbody tr.renk-a:hover,
      .gorevlendirme-table tbody tr.renk-b:hover {
      background-color: #e6f7ff; /* Fare ile üzerine gelindiğindeki renk */
}
        .puantaj .controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 25px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; }
        .puantaj .controls-left, .puantaj .controls-right { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .puantaj .controls button, .puantaj .export-buttons button { padding: 10px 15px; border-radius: 6px; border: 1px solid #ced4da; font-size: 14px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        #btn-generate { background-color: #0056b3; color: white; }
        .puantaj .export-buttons button { background-color: #6c757d; color: white; }
        .puantaj .export-buttons button:hover, #btn-generate:hover { opacity: 0.85; }
        .puantaj-table { width: 100%; border-collapse: collapse; table-layout: auto; }
        .puantaj-table th, .puantaj-table td { border: 1px solid #dee2e6; padding: 8px; text-align: center; font-size: 12px; vertical-align: middle; min-width: 40px; }
        .puantaj-table thead th { background-color: #343a40; color: white; font-weight: 600; padding: 10px 8px; position: sticky; top: 0; z-index: 2; font-size: 13px; }
        .puantaj-table tbody tr:hover > td { background-color: #f1f9ff; }
        .header-main-title { background-color: #495057 !important; }
        .col-personel { min-width: 200px; text-align: left; padding-left: 10px; position: sticky; left: 0; background-color: #fff; z-index: 1; }
        .puantaj-table tbody tr:hover .col-personel { background-color: #f1f9ff; }
        .col-unvan { min-width: 130px; } .col-day { min-width: 45px; } 

/* === PUANTAJ TABLOSU İÇİN HİZALAMA VE ÇİZGİ EKLENMİŞ GÜNCEL STİL BLOĞU === */

/* Genel tablo ayarları */
.puantaj-table {
    width: 100%;
    border-collapse: collapse;
}
.puantaj-table th, .puantaj-table td {
    border: 1px solid #dee2e6;
    text-align: center; /* Tüm hücreleri yatayda ortala */
    vertical-align: middle; /* Tüm hücreleri dikeyde ortala */
    font-size: 12px;
}

/* Tablo Başlıkları */
.puantaj-table thead th {
    background-color: #343a40 !important;
    color: white;
    font-weight: 600;
    padding: 10px 5px;
    position: sticky;
    top: 0;
    z-index: 2;
    font-size: 13px;
}

/* GÜNCELLEME: Personel ve Unvan sütunları da merkeze hizalandı */
.puantaj-table .col-personel, .puantaj-table .col-unvan {
    min-width: 130px;
    font-weight: 500;
    line-height: 1.4;
    padding: 5px; /* Hizalama için padding ayarlandı */
}
.puantaj-table .col-personel {
    position: sticky;
    left: 0;
    background-color: #fff;
    z-index: 1;
}

/* Her personel satırının altını belirginleştirme */
.personel-row-hours {
    border-bottom: 2px solid #adb5bd;
}

/* ================================================= */
        /* === YENİ ÇİZİMİNİZE GÖRE GÜNCELLENMİŞ STİLLER === */
        /* ================================================= */
        
        /* Dikey ayırıcı çizginin stilini tanımlar */
        .vertical-divider {
            border-right: 2px solid #555;
        }

        /* Her personelin altını ayıran yatay çizgiyi tanımlar */
        .horizontal-divider > td {
            border-bottom: 2px solid #333;
        }

        @media print {
            .vertical-divider {
                border-right: 2px solid #000 !important;
            }
            .horizontal-divider > td {
                border-bottom: 2px solid #000 !important;
            }
        }
        
    
        @media print {
            /* Yazdırırken yatay çizginin siyah ve belirgin olmasını sağlar */
            .puantaj-table .personel-row-status > td {
                border-bottom: 1.5px solid #000 !important;
            }

            /* Yazdırırken dikey çizginin siyah ve belirgin olmasını sağlar */
            .puantaj-table .week-divider {
                border-right: 1.5px solid #000 !important;
            }
        }

/* Üzerine gelince her iki satırın da rengini değiştirme */
.puantaj-table tbody tr:hover > td {
    background-color: #f1f9ff !important;
}

/* Durum Kodu Hücresi */
.puantaj-table .status-cell {
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    height: 32px;
    /* YENİ: Durum ve saat satırları arasına ayırıcı çizgi eklendi */
    border-bottom: 1px dashed #b0bec5;
}

/* Saat Hücresi */
.puantaj-table .hour-cell {
    font-size: 13px;
    color: #192a56;
    font-weight: 500;
    height: 32px;
}

.status-N {
    background-color: #E8F5E9; /* Çok Açık Yeşil */
    color: #1B5E20;      /* Koyu Yeşil Yazı Rengi */
}
        

        /* YENİ EKLENEN KOD BİTİŞİ */

/* Özet Sütunları Arka Plan Renkleri */
.puantaj-table .summary-yellow { background-color: #FFECB3; font-weight: bold; }
.puantaj-table .summary-green { background-color: #C8E6C9; font-weight: bold; }
.puantaj-table .summary-nobet { background-color: #FFE0B2; font-weight: bold;}
.puantaj-table .summary-rehberlik { background-color: #C5CAE9; font-weight: bold;}
/* Fazla Mesai sütunu için yeni stil */

.puantaj-table .summary-overtime { 
    background-color: #FFCDD2; /* Açık Kırmızı */
    font-weight: bold; 
}



/* Fazla Mesai Nedeni sütunu için yeni stil */
.puantaj-table .summary-reason {
    background-color: #D2B4DE; /* Açık Leylak */
    font-weight: bold;
}

/* Eksik Gün Kodu sütunu için yeni stil */
.puantaj-table .summary-missing-day {
    background-color: #AED6F1; /* Açık Gök Mavisi */
    font-weight: bold;
}


.puantaj-table .col-summary-count,
.puantaj-table .social-section,
.puantaj-table .total-worked-day {
    background-color: #E3F2FD !important;
    font-weight: 500;
}
.puantaj-table .total-worked-day {
    font-weight: bold;
}

        /* Var olan kuralı güncelleme */
        .puantaj-table tbody tr:hover > td, 
        .puantaj-table tbody tr:hover + .personel-row-hours > td {
             background-color: #f1f9ff;
        }
        .status-İ {
    background-color: #E6E6FA; /* Açık Lavanta */
    color: #483D8B;      /* Koyu Eflatun Yazı Rengi */
}
.status-Üİ {
    background-color: #EAECEE; /* Açık Nötr Gri */
    color: #566573;      /* Koyu Gri Yazı Rengi */
}
        .status-K { background-color: #D7F9E9; color: #1B5E20; } /* Yarım Gün (Tam zamanlı için) */
        .status-R { background-color: #FFEBEE; color: #B71C1C; } .status-UI { background-color: #E4E7EB; color: #37474f; }
        .status-S { background-color: #FFF9C4; color: #AF6000; } /* Yıllık İzin */
        .status-Y { background-color: #D7F9E9; color: #1B5E20; } /* Yarım Gün (Eski K'nın yeni adı) */
        .status-E { background-color: #EEEEEE; color: #424242; font-weight: normal; } /* Eksik Gün */
         .status-RT { 
    background-color: #D1EAFE; /* Açık Mavi */
    color: #0D47A1;      /* Koyu Mavi Yazı */
}
        .status-RTÇ { background-color: #E1BEE7; color: #4A148C; } /* Resmi Tatil Çalışması */
        .status-HT { background-color: #FFEBCC; color: #B85B00; } /* Hafta Sonu */
        .puantaj-legend { margin-top: 25px; padding-top: 15px; border-top: 1px solid #dee2e6; display: flex; flex-wrap: wrap; gap: 15px 25px; justify-content: center; }
        .legend-item { display: flex; align-items: center; font-size: 13px; }
        .legend-color-box { width: 16px; height: 16px; border: 1px solid #bdbdbd; margin-right: 8px; display: inline-block; }
        .bottom-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; flex-wrap: wrap; }
        .summary-totals, .approval-section { flex: 0 1 400px; /* Kutunun esnememesini ve maksimum 400px genişliğinde olmasını sağlar */ }
        .summary-totals h3, .approval-section h3 { margin-top: 0; color: #495057; }
        .total-line { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f1f1f1; font-size: 15px; }
        .total-line .label { font-weight: 500; } .total-line .value { font-weight: 700; }
        .approval-section { text-align: center; } .approval-section .name { margin-top: 40px; font-weight: 600; }
        #edit-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 10; display: none; }
        #edit-modal-overlay .modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 10px; z-index: 11; width: 350px; }
        #edit-modal-overlay .modal-buttons { text-align: right; margin-top: 20px; }
        #edit-modal-overlay .modal-buttons button { padding: 8px 16px; border-radius: 5px; border: none; cursor: pointer; margin-left: 10px; }
        #modal-save { background-color: #198754; color: white; }
        #modal-cancel { background-color: #6c757d; color: white; }
     
@media print {
    /* ------------------------------------------------------------- */
    /* 1. GENEL YAZDIRMA AYARLARI                                    */
    /* ------------------------------------------------------------- */
    @page {
        margin: 1cm; /* Sayfa kenar boşlukları */
    }

    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    body, html {
        background-color: #fff !important;
        font-size: 10pt; /* Varsayılan okunaklı font boyutu */
        overflow: visible !important;
    }

    .main-content {
        padding: 0 !important;
        overflow: visible !important;
        margin-left: 0 !important;
    }

  /* Üst barı gizlemek için .mobile-header eklendi */
.sidebar, .mobile-header, .panel-header, .controls.puantaj, .no-print,
.modal-overlay, #add-staff-modal, #logout-btn, #btn-nobet-yazdir,
#gorevlendirme .gorevlendirme-form-area {
    display: none !important;
}

    /* ------------------------------------------------------------- */
    /* 2. PUANTAJ CETVELİ YAZDIRMA AYARLARI                          */
    /* ------------------------------------------------------------- */
    #puantaj, #puantaj .panel, #puantaj-table-container { 
        box-shadow: none !important; 
        border: none !important; 
        padding: 0 !important; 
        margin: 0 !important;
        overflow: visible !important;
    }

    .puantaj-table {
        width: 100% !important;
        border-collapse: collapse !important;
    }
    
    .puantaj-table th, .puantaj-table td {
        border: 1px solid #999 !important; /* Çizgiler daha görünür yapıldı */
        padding: 4px 2px !important; /* Hücre içi boşluklar ayarlandı */
        text-align: center !important;
        vertical-align: middle !important;
    }


    /* İSTEK 1: Sütun başlıkları artık alta kayacak */
    .puantaj-table thead th {
        font-size: 8pt !important;
        font-weight: bold !important;
        white-space: normal !important; /* Bu kural uzun başlıkların alta kaymasını sağlar */
        vertical-align: bottom !important; /* Alta kayan yazıları aşağıya hizalar */
        padding-bottom: 6px !important;
    }
    
    .puantaj-table .col-personel, .puantaj-table .col-unvan {
    font-size: 9pt !important;
    text-align: left !important;
    padding-left: 5px !important;
    white-space: normal !important; /* Uzun isimlerin ve unvanların alta kaymasını sağlar */
    vertical-align: middle !important;
}

/* Personel adı sütunu için minimum genişlik ayarı (DARALTILDI) */
.puantaj-table .col-personel {
    min-width: 90px !important;
}

/* Unvan sütunu için minimum genişlik ayarı (DARALTILDI) */
.puantaj-table .col-unvan {
    min-width: 80px !important;
}

    /* İSTEK 2: Saat sayıları büyütüldü ve kalın yapıldı */
    .puantaj-table .hour-cell {
        font-size: 9pt !important;
        font-weight: bold !important;
        color: #000 !important;
    }
    
    /* Okunabilirlik için puantaj kodları (N, R, I) da büyütüldü */
    .puantaj-table .status-cell {
        font-size: 10pt !important;
        font-weight: bold !important;
    }


    /* ------------------------------------------------------------- */
    /* 3. DİĞER MODÜLLERİN YAZDIRMA AYARLARI (KORUNUYOR)            */
    /* ------------------------------------------------------------- */
    .gorevlendirme-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 9pt;
    }
    .gorevlendirme-table th, .gorevlendirme-table td {
        border: 1px solid #666;
        padding: 8px;
        text-align: left;
    }
    .gorevlendirme-table th {
        background-color: #f0f0f0;
        font-weight: bold;
    }
/* YAZDIRMA İÇİN YENİ EKLENEN BAŞLIK STİLİ */
            #puantaj-baslik {
                display: block !important; /* Başlığın her zaman görünür olmasını sağlar */
                text-align: center !important; /* Başlığı ortalar */
                font-size: 14pt !important; /* Yazdırma için okunaklı bir boyut */
                font-weight: bold;
                margin-top: 20px; /* Sayfanın üstünden boşluk bırakır */
                margin-bottom: 25px !important; /* Tablo ile arasına boşluk koyar */
                color: black !important; /* Yazıcıda her zaman siyah görünmesini sağlar */
            }
}
/* EKLENECEK KOD BİTİŞİ */
        
        @media print {
            body, html {
                background-color: #fff;
                overflow: visible;
                height: auto;
            }
            .sidebar, .panel-header, .form-container, #btn-nobet-yazdir {
                display: none !important;
            }
            .main-content {
                padding: 0;
                overflow: visible;
            }
            .module {
                display: none !important;
            }
            .module.active {
                display: block !important;
            }
            .panel {
                box-shadow: none;
                border: none;
            }
            #nobet-rapor-alani {
                display: block !important;
            }
            .table-container {
                overflow: visible;
                border: none;
            }
            .no-print {
                display: none !important;
            }
        }
.ders-karti {
    position: relative; /* Silme butonu için konumlandırma */
}
.delete-lesson-btn {
    position: absolute;
    top: -2px;
    right: 2px;
    background: rgba(0,0,0,0.4);
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    padding: 0;
}
.delete-lesson-btn:hover {
    background: var(--danger-color);
}
.mobile-header {
    display: none; /* Varsayılan olarak (masaüstünde) gizli */
    background-color: var(--theme-primary);
    color: var(--white-color);
    padding: 10px 15px;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 101; /* Kenar menüsünün üzerinde kalması için */
}

#hamburger-btn {
    background: none;
    border: none;
    color: var(--white-color);
    font-size: 28px;
    cursor: pointer;
    padding: 0 15px 0 0;
}

.mobile-title {
    font-size: 1.1em;
    font-weight: bold;
}
/* === MOBİL LOGO İÇİN YENİ EKLENEN STİL === */
.mobile-logo {
    height: 35px; /* Mobil üst bar için uygun bir yükseklik */
    width: auto;
    margin-right: 15px; /* Yazı ile arasına boşluk koyar */
}



/* === GÜNCELLENMİŞ MOBİL GÖRÜNÜM KURALLARI === */

@media (max-width: 768px) {
.sidebar-header {
    display: none;
}
    /* Kaydırma sorununu çözen kural */
    html, body {
        height: auto; 
        overflow-x: hidden; 
    }

    /* Hamburger menü için üst başlığı gösteren kural */
    .mobile-header {
        display: flex;
    }

    .app-container {
        flex-direction: column;
        height: auto; 
    }

    /* Kenar menüsünü gizleyen ve açılır hale getiren kurallar */
    .sidebar {
        position: fixed; 
        left: -250px; 
        top: 0;
        height: 100vh; 
        width: 250px; 
        z-index: 100;
        transition: left 0.3s ease-in-out; 
        border-right: 1px solid var(--sidebar-hover-bg);
    }
    
    .sidebar.open {
        left: 0; /* Menüyü görünür yapar */
    }

    .main-content {
        margin-left: 0; 
        width: 100%;
        padding: 15px;
    }
    
    /* Diğer mobil kurallarınız */
    #gorevlendirme .form-container .form-grid,
    #gorevlendirme .gorevlendirme-layout,
    .form-grid {
        grid-template-columns: 1fr;
    }

    .puantaj .controls {
        flex-direction: column;
        align-items: stretch;
    }

    .puantaj .controls-left, .puantaj .controls-right {
        flex-direction: column;
        width: 100%;
    }
    .puantaj .controls button, .puantaj .export-buttons button {
        width: 100%;
    }
}

.overtime-reason-input {
    width: 95%;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 4px;
    box-sizing: border-box;
}
/* ================================================= */
/* EKSİK GÜN KODU SEÇİM KUTUSU İÇİN DÜZELTME         */
/* ================================================= */
.missing-day-code-select {
    padding: 6px 4px; /* İç boşluk azaltıldı */
    font-size: 13px;  /* Yazı boyutu ayarlandı */
    font-weight: bold;
    color: var(--theme-primary); /* Yazı rengi belirginleştirildi */
 /* Seçim kutusu için özel hizalama sınıfları */
.text-align-left {
    text-align: left !important;
}
.text-align-center {
    text-align: center !important;
}
    width: 70px; /* Genişlik sabitlendi */
    -webkit-appearance: none; /* Tarayıcı varsayılan stillerini sıfırlama */
    -moz-appearance: none;
    appearance: none;
    /* Özel ok ikonu ekleme */
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 5px center;
    background-size: 1em;
}
/* ================================================= */
/* RENK PALETİ HÜCRE GÖRÜNÜM DÜZELTMESİ              */
/* ================================================= */

/* Renkli hücrelerin içindeki metin ve seçim kutularının arka planını şeffaf yapar */
td[style*="background-color"] .overtime-reason-input,
td[style*="background-color"] .missing-day-code-select {
    background-color: transparent;
    border: 1px solid rgba(0, 0, 0, 0.25); /* Renk üzerindeyken hafif bir kenarlık */
}

/* Renk seçicinin etrafındaki sarmalayıcıya daha iyi bir görünüm verir */
td[style*="background-color"] .input-wrapper {
    background-color: rgba(255, 255, 255, 0.2); /* Rengi biraz açar */
    border-radius: 5px;
}

/* ======================= BUNU <style> İÇİNE EKLEYİN ======================= */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}
.card-icon {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
}
.card-content {
    flex-grow: 1;
}
.card-title {
    font-size: 1em;
    font-weight: 600;
    color: #555;
    margin: 0 0 5px 0;
}
.card-value {
    font-size: 2.2em;
    font-weight: bold;
    color: var(--theme-primary);
    line-height: 1;
}
.card-description {
    font-size: 0.85em;
    color: #777;
}
/* =================== YERİNE BUNLARI EKLEYİN ================== */
.dashboard-card {
    background-color: var(--white-color);
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    display: flex;
    align-items: center;
    padding: 20px;
    gap: 20px;
    transition: transform 0.2s, box-shadow 0.2s;
    min-height: 125px; /* Tüm kartların minimum yüksekliğini eşitler */
}
.card-list {
    font-size: 0.9em;
    color: #333;
    max-height: 60px; /* Kart yüksekliğine uygun max-height */
    overflow-y: auto; /* Taşma durumunda dikey scrollbar ekler */
    width: 100%;
    padding-right: 5px; /* Kaydırma çubuğu için boşluk */
}
/* ============================================================= */
.card-list span {
    display: block;
    padding: 2px 0;
}
.card-list .no-data {
    color: #888;
    font-style: italic;
}
.quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}
.quick-action-btn {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 12px 20px;
    border-radius: 8px;
    text-decoration: none;
    color: var(--dark-text-color);
    font-weight: 600;
    transition: all 0.2s;
    cursor: pointer;
}
.quick-action-btn:hover {
    background-color: #e9ecef;
    border-color: #ced4da;
    color: var(--theme-primary);
}
/* ========================================================================= */
</style>
</head>
<body>
<header class="mobile-header">
        <button id="hamburger-btn">☰</button>
        <img src="logo.png" alt="Okul Logosu" class="mobile-logo">
        <span class="mobile-title">Okul Puantaj Sistemi</span>
    </header>
<div id="login-panel" style="display: none; justify-content: center; align-items: center; height: 100vh; background-color: var(--light-gray-color);">
    <div style="width: 100%; max-width: 400px; padding: 40px; background: var(--white-color); border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <h2 style="text-align: center; color: var(--theme-primary); margin-bottom: 30px;">Okul Puantaj Sistemi Giriş Paneli</h2>
        <div class="form-group">
            <label for="login-email">E-posta Adresi</label>
            <input type="email" id="login-email" placeholder="ornek@mail.com">
        </div>
        <div class="form-group">
            <label for="login-password">Şifre</label>
            <input type="password" id="login-password">
        </div>
        <p id="login-error" style="color: var(--danger-color); text-align: center; display: none;"></p>
        <button id="login-btn" class="btn btn-save" style="width: 100%; padding: 15px; font-size: 16px;">Giriş Yap</button>
    </div>
</div>
    <div id="toast-container"></div>
    <div class="app-container" style="display: none;">


        <aside class="sidebar">
    <div class="sidebar-header">
    <img src="logo.png" alt="Okul Puantaj Sistemi Logosu">
</div>

    <nav>
        <ul class="sidebar-nav">
            <li><a class="nav-link active" data-target="dashboard">🏠 <span>Ana Sayfa</span></a></li>
            <li class="menu-item-group">
                <a class="accordion-trigger">👥 <span>Personel Yönetimi</span></a>
                <ul class="sub-menu">
                    <li><a id="open-add-staff-modal"><span>Yeni Personel Ekle</span></a></li>
                    <li><a class="nav-link" data-target="staff-list"><span>Personel Listesi</span></a></li>
                </ul>
            </li>
            <li><a class="nav-link" data-target="ders-programi">📅 <span>Ders Programı</span></a></li>
            <li><a class="nav-link" data-target="gorevlendirme">📝 <span>Görevlendirmeler</span></a></li>
            <li><a class="nav-link" data-target="nobet-takip">🛡️ <span>Nöbet Takip</span></a></li>
            <li><a class="nav-link" data-target="izin-takip">✈️ <span>İzin Takip</span></a></li>
            <li><a class="nav-link" data-target="puantaj">📊 <span>Puantaj Cetveli</span></a></li>
            <li><a class="nav-link" data-target="settings">⚙️ <span>Ayarlar</span></a></li>
        </ul>
    </nav>

    <div class="sidebar-footer">
        <a id="logout-btn" style="cursor: pointer;">🚪 <span>Çıkış Yap</span></a>
    </div>
</aside>
                    

        <main class="main-content">
            <div id="dashboard" class="module active">
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <div class="card-icon" style="background-color: #e6f7ff; color: #0056b3;">👥</div>
            <div class="card-content">
                <div class="card-title">Aktif Personel</div>
                <div class="card-value" id="db-aktif-personel">Yükleniyor...</div>
                <div class="card-description">Sistemde kayıtlı toplam personel</div>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="card-icon" style="background-color: #fffbe6; color: #f39c12;">🛡️</div>
            <div class="card-content">
                <div class="card-title">Bugün Nöbetçi Olanlar</div>
                <div class="card-list" id="db-gunun-nobetcileri-list">Yükleniyor...</div>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="card-icon" style="background-color: #e6f7e9; color: #28a745;">✈️</div>
            <div class="card-content">
                <div class="card-title">Bugün İzinli Olanlar</div>
                <div class="card-list" id="db-bugun-izinliler-list">Yükleniyor...</div>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="card-icon" style="background-color: #feefe8; color: #dc3545;">📝</div>
            <div class="card-content">
                <div class="card-title">Bugünkü Görevlendirmeler</div>
                <div class="card-list" id="db-bugun-gorevli-list">Yükleniyor...</div>
            </div>
        </div>
    </div>
<h3 style="margin-top: 35px; color: var(--dark-text-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">Aylık Özet</h3>
<div class="dashboard-grid" style="margin-top: 20px;">

    <div class="dashboard-card">
        <div class="card-icon" style="background-color: #eefbec; color: #34a853;">➕</div>
        <div class="card-content">
            <div class="card-title">Bu Ayki Toplam Ek Ders</div>
            <div class="card-value" id="db-aylik-ekders">...</div>
            <div class="card-description">Tüm personel için</div>
        </div>
    </div>

    <div class="dashboard-card">
        <div class="card-icon" style="background-color: #e9f2ff; color: #4285f4;">🛡️</div>
        <div class="card-content">
            <div class="card-title">Bu Ayki Toplam Nöbet</div>
            <div class="card-value" id="db-aylik-nobet">...</div>
            <div class="card-description">Ek ders karşılığı</div>
        </div>
    </div>

    <div class="dashboard-card">
        <div class="card-icon" style="background-color: #fdf3e7; color: #fbbc05;">🧭</div>
        <div class="card-content">
            <div class="card-title">Bu Ayki Toplam Rehberlik</div>
            <div class="card-value" id="db-aylik-rehberlik">...</div>
            <div class="card-description">Ek ders karşılığı</div>
        </div>
    </div>

    <div class="dashboard-card">
        <div class="card-icon" style="background-color: #feebee; color: #ea4335;">🩺</div>
        <div class="card-content">
            <div class="card-title">Bu Ay Raporlu Olanlar</div>
            <div class="card-list" id="db-aylik-raporlular-list">Yükleniyor...</div>
        </div>
    </div>
</div>
    <div class="panel" style="margin-top: 25px;">
        <div class="panel-header"><h3>Hızlı İşlemler</h3></div>
        <div class="panel-body quick-actions">
            <a class="quick-action-btn nav-link" data-target="staff-list">👥 Personel Listesi</a>
            <a class="quick-action-btn nav-link" data-target="gorevlendirme">📝 Yeni Görevlendirme</a>
            <a class="quick-action-btn nav-link" data-target="izin-takip">✈️ Yeni İzin Girişi</a>
            <a class="quick-action-btn nav-link" data-target="puantaj">📊 Puantaj Cetveli</a>
        </div>
    </div>
</div>
            <div id="staff-list" class="module"><div class="panel"><div class="panel-header"><h3>Personel Listesi</h3><button id="add-staff-from-list-btn" class="btn-header-add">Yeni Personel Ekle</button></div><div class="panel-body"><p>Personel listesi yükleniyor...</p></div></div></div>
            <div id="ders-programi" class="module"><div class="panel"><div class="panel-header"><h3>Sınıf Bazlı Ders Programı</h3></div><div class="panel-body"><div id="tab-container"></div><div class="form-container"><div class="form-group"><label>Saat</label><select id="saat"></select></div><div class="form-group"><label>Gün</label><select id="gun">
    <option value="Pazartesi">Pazartesi</option>
    <option value="Salı">Salı</option>
    <option value="Çarşamba">Çarşamba</option>
    <option value="Perşembe">Perşembe</option>
    <option value="Cuma">Cuma</option>
</select></div><div class="form-group"><label>Öğretmen</label><select id="ogretmen"><option value="">Öğretmen Seçin...</option></select></div><div class="form-group"><label>Ders (Branş)</label><select id="dersAdi"><option value="">Ders Seçin...</option></select></div><button id="ekleBtn" class="btn">Ders Ekle</button></div><div id="schedule-display-area"></div></div></div></div>
            <div id="gorevlendirme" class="module">
    <div class="panel">
        <div class="panel-header">
            <h3>Detaylı Ders Görevlendirme</h3>
        </div>
        <div class="panel-body">
            <div class="gorevlendirme-form-area no-print">
                <div class="gorevlendirme-layout">
                    <div class="gorev-panel">
                        <h4>Ana Bilgiler</h4>
                        <div class="form-group">
                            <label for="g-tarih">Tarih</label>
                            <input type="date" id="g-tarih">
                        </div>
                        <div class="form-group">
                            <label for="g-asil-ogretmen">Asıl Öğretmen</label>
                            <select id="g-asil-ogretmen"></select>
                        </div>
                        <div class="form-group">
                            <label for="g-gorevli-ogretmen">Görevli Öğretmen</label>
                            <select id="g-gorevli-ogretmen"></select>
                        </div>
                        <div class="form-group">
                            <label for="g-aciklama">Genel Açıklama</label>
                            <input type="text" id="g-aciklama" placeholder="Örn: Öğretmenin raporlu olması">
                        </div>
                    </div>
                    <div class="gorev-panel">
                        <h4>Ders Dağılımı Detayları</h4>
                        <div class="detail-entry">
                            <div class="form-group"><label for="d-sinif-select">Sınıf</label><select id="d-sinif-select"></select></div>
                            <div class="form-group"><label for="d-brans-select">Ders (Branş)</label><select id="d-brans-select"></select></div>
                            <div class="form-group"><label for="d-saat-select">Saat</label><select id="d-saat-select"></select></div>
                            <button id="g-detay-ekle-btn" class="btn">Ekle</button>
                        </div>
                        <ul id="gecici-detay-listesi"></ul>
                        <button id="g-kaydet-btn" class="btn btn-save" style="width: 100%; margin-top: 15px; padding: 12px;">Tüm Görevlendirmeyi Kaydet</button>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 40px;">
                <h2 style="margin: 0;">Mevcut Görevlendirmeler</h2>
                <button id="btn-gorev-yazdir" class="btn btn-header-add no-print" style="background-color: var(--info-color);">Yazdır</button>
            </div>
            <div class="table-container">
                <table class="gorevlendirme-table">
                    <thead>
                        <tr><th>Tarih</th><th>Asıl Öğretmen</th><th>Görevli Öğretmen</th><th>Toplam Saat</th><th>Ders Detayları</th><th>Açıklama</th><th class="no-print">İşlemler</th></tr>
                    </thead>
                    <tbody id="gorevlendirme-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
            <div id="nobet-takip" class="module">
    <div class="panel">
        <div class="panel-header"><h3>Nöbet Takip ve Raporlama</h3></div>
        <div class="panel-body">
            <div class="form-container" style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 25px; border-radius: 8px; margin-bottom: 30px;">
                <h3 style="margin-top:0; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">Yeni Nöbet Girişi</h3>
                <div class="form-grid" style="grid-template-columns: 1fr 2fr 2fr 120px; align-items: flex-end;">
                    <div class="form-group"><label for="nobet-tarih">Tarih</label><input type="date" id="nobet-tarih"></div>
                    <div class="form-group"><label for="nobet-personel">Nöbetçi Personel</label><select id="nobet-personel"><option value="">Personel Seçiniz...</option></select></div>
                    <div class="form-group"><label for="nobet-yeri">Nöbet Yeri</label><select id="nobet-yeri"><option value="">Nöbet Yeri Seçiniz...</option></select></div>
                    <button id="nobet-ekle-btn" class="btn" style="background-color: #0056b3; height: 46px;">Nöbet Ekle</button>
                </div>
            </div>

            <div class="form-container" style="background-color: #eef1f3; border: 1px solid #d8dde2; padding: 25px; border-radius: 8px; margin-bottom: 30px;">
                <h3 style="margin-top:0; border-bottom: 2px solid #ced4da; padding-bottom: 10px;">Aylık Nöbet Çizelgesini Kopyala</h3>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr 150px; align-items: flex-end; gap: 15px;">
                    <div class="form-group">
                        <label for="copy-source-month">Kaynak Ay</label>
                        <select id="copy-source-month"></select>
                    </div>
                    <div class="form-group">
                        <label for="copy-source-year">Kaynak Yıl</label>
                        <input type="number" id="copy-source-year" min="2020" max="2050" style="padding: 12px;">
                    </div>
                    <div class="form-group">
                        <label for="copy-dest-month">Hedef Ay</label>
                        <select id="copy-dest-month"></select>
                    </div>
                    <div class="form-group">
                        <label for="copy-dest-year">Hedef Yıl</label>
                        <input type="number" id="copy-dest-year" min="2020" max="2050" style="padding: 12px;">
                    </div>
                    <button id="copy-schedule-btn" class="btn" style="background-color: var(--theme-accent); height: 46px;">Çizelgeyi Kopyala</button>
                </div>
            </div>
            <div id="nobet-rapor-alani">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
    <h3 style="margin-top: 40px; margin-bottom: 10px;">Aylık Nöbet Raporu</h3>
    <div class="no-print" style="display: flex; gap: 10px;">
        <button id="btn-nobet-toplu-sil" class="btn btn-header-add" style="background-color: var(--danger-color);">Seçilenleri Sil</button>
        <button id="btn-nobet-yazdir" class="btn btn-header-add" style="background-color: var(--info-color);">Yazdır</button>
    </div>
</div>
                <div class="controls" style="display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 25px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                    <div class="controls-left" style="display: flex; align-items: center; gap: 10px;">
                        <select id="rapor-ay-sec"></select>
                        <input type="number" id="rapor-yil-gir" min="2020" max="2050">
                    </div>
                </div>
                <div class="table-container">
                    <table class="gorevlendirme-table"><thead><tr><th>Tarih</th><th>Gün</th><th>Nöbetçi Personel</th><th>Nöbet Yeri</th><th class="no-print">İşlemler</th></tr></thead><tbody id="nobet-rapor-tbody"></tbody></table>
                </div>
            </div>
           
        </div>
    </div>
</div>
            <div id="izin-takip" class="module">
                <div class="panel">
                    <div class="panel-header">
                        <h3>İzin Takip ve Yönetim Modülü</h3>
                        <button id="open-toplu-izin-modal-btn" class="btn-header-add" style="background-color: var(--success-color);">Toplu İzin Girişi</button>
                    </div>
            
                    <div class="panel-body">
                        <div class="form-container" style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 25px; border-radius: 8px; margin-bottom: 40px;">
                            <h3 style="margin-top:0; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">Yeni İzin Girişi</h3>
                            <div class="form-grid" style="grid-template-columns: 2fr 1.5fr 1fr 1fr; align-items: flex-end;">
                                <div class="form-group">
                                    <label for="izin-personel">Personel</label>
                                    <select id="izin-personel"><option value="">Personel Seçiniz...</option></select>
                                </div>
                                <div class="form-group">
                                    <label for="izin-tipi">İzin Tipi</label>
                                    <select id="izin-tipi"><option value="">İzin Tipi Seçiniz...</option></select>
                                </div>
                                <div class="form-group">
                                    <label for="izin-baslangic">Başlangıç Tarihi</label>
                                    <input type="date" id="izin-baslangic">
                                </div>
                                <div class="form-group">
                                    <label for="izin-bitis">Bitiş Tarihi</label>
                                    <input type="date" id="izin-bitis">
                                </div>
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label for="izin-aciklama">Açıklama / Not</label>
                                    <input type="text" id="izin-aciklama" placeholder="İzinle ilgili kısa bir not...">
                                </div>
                            </div>
                            <div class="izin-hesaplama-alani">
                                <div id="personel-izin-hakki">
                                    </div>
                                <div id="izin-hesaplama-sonucu">
                                    </div>
                            </div>

                            <div class="button-group">
                                <button id="izin-kaydet-btn" class="btn btn-save">İzin Kaydını Oluştur</button>
                            </div>
                        </div>
                        <h3>Kayıtlı İzinler</h3>
                        <div class="table-container">
                            <table class="gorevlendirme-table">
                                <thead>
                                    <tr><th>Personel Adı</th><th>İzin Tipi</th><th>Başlangıç</th><th>Bitiş</th><th>Süre (Gün)</th><th>Açıklama</th><th style="width: 200px;">İşlemler</th></tr>
                                </thead>
                                <tbody id="izin-kayitlari-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="puantaj" class="module">
                <div class="panel">
                    <div class="panel-header"><h3>Puantaj Cetveli</h3></div>
                    <div class="panel-body">
                        <div class="controls puantaj">
                         
                            <div class="controls-left">
    <select id="select-month"></select>
    <input type="number" id="input-year" min="2020" max="2050">

    <button id="btn-show-puantaj" style="background-color: #0d6efd; color: white; padding: 10px 15px; font-size: 14px; font-weight: 500; border-radius: 6px; border: 1px solid transparent; cursor: pointer;">
        Puantajı Göster
    </button>

    <button id="btn-generate" style="background-color: #ffc107; color: #000; padding: 10px 15px; font-size: 14px; font-weight: 500; border-radius: 6px; border: 1px solid transparent; cursor: pointer;">
        Yeni Puantaj Oluştur
    </button>
<button id="btn-generate-individual" style="background-color: #17a2b8; color: white; padding: 10px 15px; font-size: 14px; font-weight: 500; border-radius: 6px; border: 1px solid transparent; cursor: pointer;">
        Seçili Personeli Hesapla
    </button>
</div>

<div class="personel-filter-container" style="display: flex; align-items: center; gap: 10px; border-left: 2px solid #ced4da; padding-left: 15px; margin-left: 5px; margin-top: 20px;">
    <select id="personel-filter-select" style="padding: 9px; border-radius: 6px; border: 1px solid #ced4da; min-width: 200px;"></select>
    <button id="btn-filter-personel" class="btn" style="background-color: #17a2b8;">Filtrele</button>
    <button id="btn-clear-filter" class="btn" style="background-color: #6c757d;">Temizle</button>
</div>
<div class="bulk-update-container" style="display: flex; flex-direction: column; gap: 10px; padding: 15px; background-color: #e9ecef; border-radius: 8px; border: 1px solid #ced4da; margin-top: 15px; grid-column: 1 / -1;">
    <h4 style="margin: 0 0 5px 0; color: var(--theme-primary);">Toplu Güncelleme</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; align-items: flex-end;">
        <div>
            <label for="bulk-update-day" style="font-size: 13px; font-weight: 500;">Uygulanacak Gün:</label>
            <select id="bulk-update-day" class="form-control" style="padding: 8px;"></select>
        </div>
        <div>
            <label for="bulk-update-group" style="font-size: 13px; font-weight: 500;">Personel Grubu:</label>
            <select id="bulk-update-group" class="form-control" style="padding: 8px;">
                <option value="Tümü">Tüm Personel</option>
                <option value="Belirli Süreli">Belirli Süreli</option>
                <option value="Belirsiz Süreli">Belirsiz Süreli</option>
                <option value="Kısmi Süreli">Kısmi Süreli</option>
            </select>
        </div>
        <div>
            <label for="bulk-update-status" style="font-size: 13px; font-weight: 500;">Yeni Durum Kodu:</label>
            <select id="bulk-update-status" class="form-control" style="padding: 8px;"></select>
        </div>
        <button id="btn-bulk-update" class="btn" style="background-color: #6f42c1; color: white; height: 38px;">Uygula</button>
    </div>
</div>


                            <div class="controls-right export-buttons">
    <button id="btn-save-puantaj" style="background-color: #28a745;">Kaydet</button>
    <button id="btn-lock-puantaj" style="background-color: #fd7e14;">Puantajı Kilitle</button>
    <button id="btn-print">Yazdır</button>
    <button id="btn-pdf">PDF İndir</button>
    <button id="btn-excel">Excel İndir</button>
    <button id="btn-delete-puantaj" style="background-color: var(--danger-color);">Puantajı Sil</button>
</div>
                        </div>
                        <div id="puantaj-table-container" class="table-container"></div>
                        <div id="puantaj-legend" class="puantaj-legend"></div>
                        <div id="bottom-section" class="bottom-section">
                            <div class="summary-totals">
                                <h3>Aylık Genel Toplamlar</h3>
                                <div class="total-line"><span class="label">Ek Ders Saati Toplamı:</span><span id="total-ekders" class="value">0</span></div>
                                <div class="total-line"><span class="label">Nöbet Toplamı:</span><span id="total-nobet" class="value">0</span></div>
                                <div class="total-line"><span class="label">Rehberlik Toplamı:</span><span id="total-rehberlik" class="value">0</span></div>
                            </div>
                            <div class="approval-section">
                                <h3>Onay</h3>
                                <div class="name">Adı Soyadı</div>
                                <div>Okul Müdürü</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings" class="module">
                <div class="panel">
                    <div class="panel-header"><h3>Uygulama Ayarları</h3></div>
                    <div class="panel-body">
                        <div class="settings-tabs">
                            <button class="settings-tab-button active" data-tab="nevi">Personel Nevileri</button>
                            <button class="settings-tab-button" data-tab="gorev">Görevler/Branşlar</button>
                            <button class="settings-tab-button" data-tab="ders">Dersler</button>
                            <button class="settings-tab-button" data-tab="sinif">Sınıflar</button>
                            <button class="settings-tab-button" data-tab="nobet-yeri">Nöbet Yerleri</button>
                            <button class="settings-tab-button" data-tab="izin-tipi">İzin Tipleri</button>
                            <button class="settings-tab-button" data-tab="zaman-cizelgesi">Zaman Çizelgesi</button>
                        </div>
                        <div id="nevi-tab" class="settings-tab-content active">
    <h3>Personel Nevi Yönetimi</h3>
    <div class="add-setting-form">
        <input type="text" id="add-nevi-input" placeholder="Yeni personel nevi adı...">
        <button id="add-nevi-btn" class="btn">Ekle</button>
    </div>
    <ul id="nevi-list" class="settings-list"></ul>
</div>
                        <div id="gorev-tab" class="settings-tab-content"><h3>Görev/Branş Yönetimi</h3><div class="add-setting-form"><select id="gorev-nevi-select"><option value="">Önce Personel Nevi Seçin</option></select><input type="text" id="add-gorev-input" placeholder="Yeni görev/branş adı..."><button id="add-gorev-btn" class="btn">Ekle</button></div><ul id="gorev-list" class="settings-list"></ul></div>
                        <div id="ders-tab" class="settings-tab-content"><h3>Ders Yönetimi</h3><div class="add-setting-form"><input type="text" id="add-ders-input" placeholder="Yeni ders adı..."><button id="add-ders-btn" class="btn">Ekle</button></div><ul id="ders-list" class="settings-list"></ul></div>
                        <div id="sinif-tab" class="settings-tab-content"><h3>Sınıf Yönetimi</h3><div class="add-setting-form"><input type="text" id="add-sinif-input" placeholder="Yeni sınıf adı..."><button id="add-sinif-btn" class="btn">Ekle</button></div><ul id="sinif-list" class="settings-list"></ul></div>
                        <div id="nobet-yeri-tab" class="settings-tab-content"><h3>Nöbet Yeri Yönetimi</h3><div class="add-setting-form"><input type="text" id="add-nobet-yeri-input" placeholder="Yeni nöbet yeri adı..."><button id="add-nobet-yeri-btn" class="btn">Ekle</button></div><ul id="nobet-yeri-list" class="settings-list"></ul></div>
                        <div id="izin-tipi-tab" class="settings-tab-content"><h3>İzin Tipi Yönetimi</h3><div class="add-setting-form" style="grid-template-columns: 2fr 1fr auto; display: grid;"><input type="text" id="add-izin-tipi-ad-input" placeholder="Yeni izin tipi adı (Örn: Yıllık İzin)"><input type="text" id="add-izin-tipi-kod-input" placeholder="Puantaj Kodu (Örn: I)"><button id="add-izin-tipi-btn" class="btn">Ekle</button></div><ul id="izin-tipi-list" class="settings-list"></ul></div>
                        <div id="zaman-cizelgesi-tab" class="settings-tab-content">
                            <h3>Zaman Çizelgesi Ayarları</h3>
                            <p>Ders programı modülü, buradaki ayarlara göre otomatik olarak şekillenecektir.</p>
                            <div class="form-grid">
                                <div class="form-group"><label for="setting-dersBaslangic">Ders Başlama Saati</label><input type="time" id="setting-dersBaslangic"></div>
                                <div class="form-group"><label for="setting-toplamDers">Günlük Toplam Ders Sayısı</label><input type="number" id="setting-toplamDers" min="1"></div>
                                <div class="form-group"><label for="setting-dersSuresi">Ders Süresi (Dakika)</label><input type="number" id="setting-dersSuresi" min="1"></div>
                                <div class="form-group"><label for="setting-teneffusSuresi">Teneffüs Süresi (Dakika)</label><input type="number" id="setting-teneffusSuresi" min="0"></div>
                                <div class="form-group"><label for="setting-ogleArasiDersNo">Öğle Arası Kaçıncı Dersten Sonra?</label><input type="number" id="setting-ogleArasiDersNo" min="0"></div>
                                <div class="form-group"><label for="setting-ogleArasiSuresi">Öğle Arası Süresi (Dakika)</label><input type="number" id="setting-ogleArasiSuresi" min="0"></div>
                            </div>
                            <div class="button-group">
                                <button id="zaman-cizelgesi-kaydet-btn" class="btn btn-save">Çizelge Ayarlarını Kaydet</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            

            
            
            
        </main> <div id="edit-gorevlendirme-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Detaylı Ders Görevlendirme Düzenle</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editGorevlendirmeForm">
                <input type="hidden" id="edit-g-id">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label for="edit-g-tarih">Tarih</label>
                        <input type="date" id="edit-g-tarih">
                    </div>
                    <div class="form-group">
                        <label for="edit-g-asil-ogretmen">Asıl Öğretmen</label>
                        <select id="edit-g-asil-ogretmen"></select>
                    </div>
                    <div class="form-group">
                        <label for="edit-g-gorevli-ogretmen">Görevli Öğretmen</label>
                        <select id="edit-g-gorevli-ogretmen"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-g-aciklama">Genel Açıklama</label>
                    <input type="text" id="edit-g-aciklama">
                </div>
                
                <div class="detail-entry" style="margin-top: 25px;">
                    <div class="form-group"><label for="edit-d-sinif-select">Sınıf</label><select id="edit-d-sinif-select"></select></div>
                    <div class="form-group"><label for="edit-d-brans-select">Ders (Branş)</label><select id="edit-d-brans-select"></select></div>
                    <div class="form-group"><label for="edit-d-saat-select">Saat</label><select id="edit-d-saat-select"></select></div>
                    <button type="button" id="edit-g-detay-ekle-btn" class="btn">Ekle</button>
                </div>
                <ul id="edit-g-detay-listesi" style="list-style: none; padding: 0; margin-top: 15px;">
                </ul>
                
                <div class="button-group" style="margin-top:20px;">
                    <button type="submit" class="btn btn-save">Değişiklikleri Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>
        
<div id="edit-setting-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="edit-setting-modal-title">Ayar Adını Düzenle</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="edit-setting-input">Yeni Ad</label>
                <input type="text" id="edit-setting-input">
            </div>
            <div class="button-group">
                <button id="edit-setting-save-btn" class="btn btn-save">Değişiklikleri Kaydet</button>
            </div>
        </div>
    </div>
</div>



    <div id="add-staff-modal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="modal-title">Yeni Personel Ekle</h3><button class="close-modal">&times;</button></div><div class="modal-body"><form id="personelForm"></form></div></div></div>
    <div id="edit-modal-overlay" class="modal-overlay"><div class="modal-content"><h3 id="p-modal-title">Puantaj Günü Düzenle</h3><div class="form-group"><label for="modal-status">Durum</label><select id="modal-status"></select></div><div class="form-group"><label for="modal-hours">Çalışılan Ders Saati</label><input type="number" id="modal-hours" min="0" max="12"></div><div class="form-group"><label for="modal-notes">Açıklama</label><input type="text" id="modal-notes" placeholder="Opsiyonel not..."></div><div class="modal-buttons"><button id="modal-cancel" class="btn">İptal</button><button id="modal-save" class="btn">Kaydet</button></div></div></div>
    
    <template id="personel-form-template">
    <div class="form-grid">
        <div class="form-group">
            <label for="ad_soyad">Adı Soyadı:</label>
            <input type="text" id="ad_soyad" name="ad_soyad" required>
        </div>

        <div class="form-group">
            <label for="tc_kimlik_no">T.C. Kimlik No:</label>
            <input type="text" id="tc_kimlik_no" name="tc_kimlik_no">
        </div>
        <div class="form-group">
            <label for="sgk_no">SGK No:</label>
            <input type="text" id="sgk_no" name="sgk_no">
        </div>
        <div class="form-group">
            <label for="personel_nevisi">Personel Nevisi:</label>
            <select id="personel_nevisi" name="personel_nevisi" required>
                <option value="" disabled selected>Seçim yapınız...</option>
            </select>
        </div>
        <div class="form-group">
            <label for="gorevi_bransi">Görevi / Branşı:</label>
            <select id="gorevi_bransi" name="gorevi_bransi" required>
                <option value="" disabled selected>Önce Personel Nevisi seçin</option>
            </select>
        </div>
        <div class="form-group">
            <label for="sozlesme_turu">Sözleşme Türü:</label>
            <select id="sozlesme_turu" name="sozlesme_turu">
                <option value="Belirsiz Süreli">Belirsiz Süreli Sözleşme</option>
                <option value="Belirli Süreli">Belirli Süreli Sözleşme</option>
                <option value="Kısmi Süreli">Kısmi Süreli Sözleşme</option>
            </select>
        </div>

        <div class="form-group full-width" id="kismi_zamanli_div" style="display: none; background-color: #f0f3f5; padding: 15px; border-radius: 6px;">
            <label style="font-weight: bold; color: var(--theme-primary); margin-bottom: 5px;">Kısmi Zamanlı Çalışma Saatleri</label>
            <p style="font-size: 0.9em; margin-top: 0;">Lütfen personelin haftalık çalışma günlerini ve günlük saatlerini belirtin.</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 20px;">

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="pzts_calisiyor" name="kismi_gunler" value="Pazartesi" style="width: auto; margin-right: 8px;">
                        <label for="pzts_calisiyor" style="margin: 0; font-weight: normal;">Pazartesi</label>
                    </div>
                    <div>
                        <input type="number" id="pzts_saat" name="pzts_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="sali_calisiyor" name="kismi_gunler" value="Salı" style="width: auto; margin-right: 8px;">
                        <label for="sali_calisiyor" style="margin: 0; font-weight: normal;">Salı</label>
                    </div>
                    <div>
                        <input type="number" id="sali_saat" name="sali_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="crs_calisiyor" name="kismi_gunler" value="Çarşamba" style="width: auto; margin-right: 8px;">
                        <label for="crs_calisiyor" style="margin: 0; font-weight: normal;">Çarşamba</label>
                    </div>
                    <div>
                        <input type="number" id="crs_saat" name="crs_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="prs_calisiyor" name="kismi_gunler" value="Perşembe" style="width: auto; margin-right: 8px;">
                        <label for="prs_calisiyor" style="margin: 0; font-weight: normal;">Perşembe</label>
                    </div>
                    <div>
                        <input type="number" id="prs_saat" name="prs_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="cuma_calisiyor" name="kismi_gunler" value="Cuma" style="width: auto; margin-right: 8px;">
                        <label for="cuma_calisiyor" style="margin: 0; font-weight: normal;">Cuma</label>
                    </div>
                    <div>
                        <input type="number" id="cuma_saat" name="cuma_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="cmrts_calisiyor" name="kismi_gunler" value="Cumartesi" style="width: auto; margin-right: 8px;">
                        <label for="cmrts_calisiyor" style="margin: 0; font-weight: normal;">Cumartesi</label>
                    </div>
                    <div>
                        <input type="number" id="cmrts_saat" name="cmrts_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="pazar_calisiyor" name="kismi_gunler" value="Pazar" style="width: auto; margin-right: 8px;">
                        <label for="pazar_calisiyor" style="margin: 0; font-weight: normal;">Pazar</label>
                    </div>
                    <div>
                        <input type="number" id="pazar_saat" name="pazar_saat" min="0" max="12" style="width: 60px; padding: 8px;">
                        <span style="margin-left: 5px;">saat</span>
                    </div>
                </div>

            </div>
        </div>
        <div class="form-group">
            <label>Cinsiyet:</label>
            <div class="radio-group">
                <div><input type="radio" id="cinsiyet_kadin" name="cinsiyet" value="kadin" checked><label for="cinsiyet_kadin">Kadın</label></div>
                <div><input type="radio" id="cinsiyet_erkek" name="cinsiyet" value="erkek"><label for="cinsiyet_erkek">Erkek</label></div>
            </div>
        </div>
        <div class="form-group">
            <label>Eş Durumu:</label>
            <div class="radio-group">
                <div><input type="radio" id="es_calismiyor" name="es_durumu" value="calismiyor" checked><label for="es_calismiyor">Çalışmıyor</label></div>
                <div><input type="radio" id="es_calisiyor" name="es_durumu" value="calisiyor"><label for="es_calisiyor">Çalışıyor</label></div>
                <div><input type="radio" id="es_bekar" name="es_durumu" value="bekar"><label for="es_bekar">Bekar</label></div>
            </div>
        </div>
         <div class="form-group" id="rehberlik_gorevi_div">
        <label>Rehberlik Görevi Var Mı?:</label>
        <div class="radio-group">
            <div><input type="radio" id="rehberlik_yok" name="rehberlik_gorevi" value="hayir" checked><label for="rehberlik_yok">Hayır</label></div>
            <div><input type="radio" id="rehberlik_var" name="rehberlik_gorevi" value="evet"><label for="rehberlik_var">Evet (Haftalık 2 Saat)</label></div>
        </div>
    </div>
        <div class="form-group">
            <label for="cocuk_0_6">Çocuk Sayısı (0-6 Yaş):</label>
            <input type="number" id="cocuk_0_6" name="cocuk_0_6" min="0" value="0">
        </div>
        <div class="form-group">
            <label for="cocuk_6_ustu">Çocuk Sayısı (6-18 Yaş):</label>
            <input type="number" id="cocuk_6_ustu" name="cocuk_6_ustu" min="0" value="0">
        </div>
        <div class="form-group">
            <label for="ise_giris">İşe Giriş Tarihi:</label>
            <input type="date" id="ise_giris" name="ise_giris" required>
        </div>
        <div class="form-group">
            <label for="isten_ayrilis">İşten Ayrılış Tarihi:</label>
            <input type="date" id="isten_ayrilis" name="isten_ayrilis">
        </div>
        <div class="form-group" id="maas_karsiligi_div">
            <label for="maas_karsiligi">Maaş Karşılığı Ders Saati:</label>
            <input type="number" id="maas_karsiligi" name="maas_karsiligi" min="0" value="20">
        </div>
        <div class="form-group full-width">
            <label for="aciklama">Açıklama:</label>
            <textarea id="aciklama" name="aciklama" rows="3"></textarea>
        </div>
        <div class="form-group full-width button-group">
            <button type="submit" class="btn btn-save">Personeli Kaydet</button>
        </div>
    </div>
</template>
    
    <script type="module">
 // =================================================================
// 1. ADIM: BU KOD BLOĞUNU OLDUĞU GİBİ EKLEYİN
// =================================================================
const eksikGunKodlari = [
    { kod: "01", aciklama: "İstirahat" }, { kod: "03", aciklama: "Disiplin cezası" },
    { kod: "04", aciklama: "Gözaltına alınma" }, { kod: "05", aciklama: "Tutukluluk" },
    { kod: "06", aciklama: "Kısmi istihdam" }, { kod: "07", aciklama: "Puantaj kayıtları" },
    { kod: "08", aciklama: "Grev" }, { kod: "09", aciklama: "Lokavt" },
    { kod: "10", aciklama: "Genel hayatı etkileyen olaylar" }, { kod: "11", aciklama: "Doğal afet" },
    { kod: "12", aciklama: "Birden fazla" }, { kod: "13", aciklama: "Diğer nedenler" },
    { kod: "15", aciklama: "Devamsızlık" }, { kod: "16", aciklama: "Fesih tarihinde çalışmamış" },
    { kod: "17", aciklama: "Ev hizmetlerinde 30 günden az çalışma" }, { kod: "18", aciklama: "Kısa çalışma ödeneği" },
    { kod: "19", aciklama: "Ücretsiz Doğum İzni" }, { kod: "20", aciklama: "Ücretsiz Yol İzni" },
    { kod: "21", aciklama: "Diğer Ücretsiz İzin" }, { kod: "22", aciklama: "5434 SK. ek 76, GM 192" },
    { kod: "23", aciklama: "Yarım çalışma ödeneği" }, { kod: "24", aciklama: "Yarım çalışma ödeneği ve diğer nedenler" },
    { kod: "25", aciklama: "Diğer belge/kanun türlerinden gün tamamlama" }, { kod: "26", aciklama: "Kısmi istihdama izin verilen yabancı uyruklu sigortalı" },
    { kod: "27", aciklama: "Kısa çalışma ödeneği ve diğer nedenler" }, { kod: "28", aciklama: "Pandemi Ücretsiz İzin (4857 Geç.10.Md.)" },
    { kod: "29", aciklama: "Pandemi Ücretsiz İzin ve diğer nedenler" }
];
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
    apiKey: "AIzaSyBoSgNHT05FNKeswV0KCaKY4-Pz7jpwbXM",
    authDomain: "puantaj-fe3df.firebaseapp.com",
    projectId: "puantaj-fe3df",
    storageBucket: "puantaj-fe3df.appspot.com", // <-- DOĞRU ADRES
    messagingSenderId: "110213592906",
    appId: "1:110213592906:web:02a14675741fc63e15b3b3",
    measurementId: "G-JC71J8VRJW"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
// YENİ EKLENECEK DEĞİŞKENLER
const auth = getAuth(app);
const loginPanel = document.getElementById('login-panel');
const appContainer = document.querySelector('.app-container');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const loginEmailInput = document.getElementById('login-email');
const loginPasswordInput = document.getElementById('login-password');
const loginError = document.getElementById('login-error');
// --- TÜRKİYE RESMİ TATİLLER VERİ BANKASI (2024-2028) ---
const resmiTatiller = {
    "sabit": [
        { ay: 0, gun: 1, ad: "Yılbaşı" },
        { ay: 3, gun: 23, ad: "Ulusal Egemenlik ve Çocuk Bayramı" },
        { ay: 4, gun: 1, ad: "Emek ve Dayanışma Günü" },
        { ay: 4, gun: 19, ad: "Atatürk'ü Anma, Gençlik ve Spor Bayramı" },
        { ay: 6, gun: 15, ad: "Demokrasi ve Milli Birlik Günü" },
        { ay: 7, gun: 30, ad: "Zafer Bayramı" },
        { ay: 9, gun: 29, ad: "Cumhuriyet Bayramı" }
    ],
    "degisken": {
        "2024": [
            { ay: 3, gun: 9, ad: "Ramazan Bayramı Arifesi" }, { ay: 3, gun: 10, ad: "Ramazan Bayramı 1. Gün" }, { ay: 3, gun: 11, ad: "Ramazan Bayramı 2. Gün" }, { ay: 3, gun: 12, ad: "Ramazan Bayramı 3. Gün" },
            { ay: 5, gun: 15, ad: "Kurban Bayramı Arifesi" }, { ay: 5, gun: 16, ad: "Kurban Bayramı 1. Gün" }, { ay: 5, gun: 17, ad: "Kurban Bayramı 2. Gün" }, { ay: 5, gun: 18, ad: "Kurban Bayramı 3. Gün" }, { ay: 5, gun: 19, ad: "Kurban Bayramı 4. Gün" }
        ],
        "2025": [
            { ay: 2, gun: 29, ad: "Ramazan Bayramı Arifesi" }, { ay: 2, gun: 30, ad: "Ramazan Bayramı 1. Gün" }, { ay: 2, gun: 31, ad: "Ramazan Bayramı 2. Gün" }, { ay: 3, gun: 1, ad: "Ramazan Bayramı 3. Gün" },
            { ay: 5, gun: 5, ad: "Kurban Bayramı Arifesi" }, { ay: 5, gun: 6, ad: "Kurban Bayramı 1. Gün" }, { ay: 5, gun: 7, ad: "Kurban Bayramı 2. Gün" }, { ay: 5, gun: 8, ad: "Kurban Bayramı 3. Gün" }, { ay: 5, gun: 9, ad: "Kurban Bayramı 4. Gün" }
        ],
        "2026": [
            { ay: 2, gun: 18, ad: "Ramazan Bayramı Arifesi" }, { ay: 2, gun: 19, ad: "Ramazan Bayramı 1. Gün" }, { ay: 2, gun: 20, ad: "Ramazan Bayramı 2. Gün" }, { ay: 2, gun: 21, ad: "Ramazan Bayramı 3. Gün" },
            { ay: 4, gun: 25, ad: "Kurban Bayramı Arifesi" }, { ay: 4, gun: 26, ad: "Kurban Bayramı 1. Gün" }, { ay: 4, gun: 27, ad: "Kurban Bayramı 2. Gün" }, { ay: 4, gun: 28, ad: "Kurban Bayramı 3. Gün" }, { ay: 4, gun: 29, ad: "Kurban Bayramı 4. Gün" }
        ],
        "2027": [
            { ay: 2, gun: 8, ad: "Ramazan Bayramı Arifesi" }, { ay: 2, gun: 9, ad: "Ramazan Bayramı 1. Gün" }, { ay: 2, gun: 10, ad: "Ramazan Bayramı 2. Gün" }, { ay: 2, gun: 11, ad: "Ramazan Bayramı 3. Gün" },
            { ay: 4, gun: 15, ad: "Kurban Bayramı Arifesi" }, { ay: 4, gun: 16, ad: "Kurban Bayramı 1. Gün" }, { ay: 4, gun: 17, ad: "Kurban Bayramı 2. Gün" }, { ay: 4, gun: 18, ad: "Kurban Bayramı 3. Gün" }, { ay: 4, gun: 19, ad: "Kurban Bayramı 4. Gün" }
        ],
        "2028": [
            { ay: 1, gun: 27, ad: "Ramazan Bayramı Arifesi" }, { ay: 1, gun: 28, ad: "Ramazan Bayramı 1. Gün" }, { ay: 1, gun: 29, ad: "Ramazan Bayramı 2. Gün" }, { ay: 1, gun: 30, ad: "Ramazan Bayramı 3. Gün" },
            { ay: 4, gun: 3, ad: "Kurban Bayramı Arifesi" }, { ay: 4, gun: 4, ad: "Kurban Bayramı 1. Gün" }, { ay: 4, gun: 5, ad: "Kurban Bayramı 2. Gün" }, { ay: 4, gun: 6, ad: "Kurban Bayramı 3. Gün" }, { ay: 4, gun: 7, ad: "Kurban Bayramı 4. Gün" }
        ]
    }
};
function formatDateDDMMYYYY(dateString) {
    if (!dateString || typeof dateString !== 'string') return '---';
    const parts = dateString.split('-');
    if (parts.length !== 3) return dateString;
    const [year, month, day] = parts;
    return `${day}.${month}.${year}`;
}

// Belirtilen bir tarihin resmi tatil olup olmadığını kontrol eden yardımcı fonksiyon
function isResmiTatil(date) {
    const year = date.getFullYear();
    const month = date.getMonth();
    const day = date.getDate();

    // Sabit tatilleri kontrol et
    if (resmiTatiller.sabit.some(t => t.ay === month && t.gun === day)) {
        return true;
    }

    // Değişken (dini) tatilleri kontrol et
    const yilinTatilleri = resmiTatiller.degisken[year];
    if (yilinTatilleri && yilinTatilleri.some(t => t.ay === month && t.gun === day)) {
        return true;
    }

    return false;
}

        // --- GENEL FONKSİYONLAR ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'slideOut 0.3s forwards'; toast.addEventListener('animationend', () => toast.remove()); }, 3000);
        }

/* ======================= ESKİ renderDashboardData FONKSİYONUNU SİLİP BUNU EKLEYİN ======================= */
async function renderDashboardData() {
    const today = new Date();
    const todayString = today.toISOString().split('T')[0];
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth(); // 0-11

    // Gerekli DOM elemanlarını seç
    const personelValueEl = document.getElementById('db-aktif-personel');
    const nobetListEl = document.getElementById('db-gunun-nobetcileri-list');
    const izinListEl = document.getElementById('db-bugun-izinliler-list');
    const gorevListEl = document.getElementById('db-bugun-gorevli-list');
    // Yeni kartların elemanları
    const aylikEkdersEl = document.getElementById('db-aylik-ekders');
    const aylikNobetEl = document.getElementById('db-aylik-nobet');
    const aylikRehberlikEl = document.getElementById('db-aylik-rehberlik');
    const aylikRaporluListEl = document.getElementById('db-aylik-raporlular-list');

    // Yükleniyor... durumunu ayarla
    [personelValueEl, aylikEkdersEl, aylikNobetEl, aylikRehberlikEl].forEach(el => el.textContent = '...');
    [nobetListEl, izinListEl, gorevListEl, aylikRaporluListEl].forEach(el => el.innerHTML = 'Yükleniyor...');

    try {
        // Aylık puantaj döküman ID'sini oluştur
        const puantajDocId = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

        // Tüm veritabanı sorgularını aynı anda başlat
        const [
            personelSnap, nobetSnap, izinSnap, gorevSnap, nobetYeriSnap,
            izinTipiSnap, puantajDocSnap
        ] = await Promise.all([
            getDocs(query(collection(db, "personel"))),
            getDocs(query(collection(db, "nobetler"), where("tarih", "==", todayString))),
            getDocs(query(collection(db, "izinler"), where("baslangicTarihi", "<=", todayString))),
            getDocs(query(collection(db, "ders_gorevlendirmeleri"), where("tarih", "==", todayString))),
            getSettings('ayarlar_nobet_yerleri'),
            getSettings('ayarlar_izin_tipleri'),
            getDoc(doc(db, "kayitli_puantajlar", puantajDocId))
        ]);

        const personelMap = new Map(personelSnap.docs.map(doc => [doc.id, doc.data().ad_soyad]));
        const nobetYeriMap = new Map(nobetYeriSnap.docs.map(doc => [doc.id, doc.data().name]));
        const tumPersonelListesi = personelSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // --- GÜNLÜK KARTLARIN DOLDURULMASI (MEVCUT KOD) ---
        personelValueEl.textContent = personelSnap.size;
        if (nobetSnap.empty) { nobetListEl.innerHTML = '<span class="no-data">Bugün nöbetçi yok.</span>'; } 
        else { nobetListEl.innerHTML = nobetSnap.docs.map(doc => `<span><strong>${personelMap.get(doc.data().personelId) || '?'}</strong> - ${nobetYeriMap.get(doc.data().nobetYeriId) || ''}</span>`).join(''); }

        const bugunIzinliler = [];
        izinSnap.forEach(doc => {
            const izin = doc.data();
            if (new Date(izin.bitisTarihi + 'T23:59:59') >= today) {
                bugunIzinliler.push(personelMap.get(izin.personelId) || '?');
            }
        });
        if (bugunIzinliler.length === 0) { izinListEl.innerHTML = '<span class="no-data">Bugün izinli personel yok.</span>'; }
        else { izinListEl.innerHTML = bugunIzinliler.map(ad => `<span>${ad}</span>`).join(''); }

        if (gorevSnap.empty) { gorevListEl.innerHTML = '<span class="no-data">Bugün görevlendirme yok.</span>'; }
        else { gorevListEl.innerHTML = gorevSnap.docs.map(d => `<span><strong>${personelMap.get(d.data().gorevliId) || '?'}</strong> (Yerine: ${personelMap.get(d.data().asilId) || '?'})</span>`).join(''); }

        // --- YENİ EKLENEN AYLIK ÖZET KARTLARININ DOLDURULMASI ---
        let totalEkders = 0, totalNobet = 0, totalRehberlik = 0;
        const aylikPuantajVerisi = puantajDocSnap.exists() ? puantajDocSnap.data().puantajData : null;

        if (aylikPuantajVerisi) {
            const nobetVerisi = await fetchAndCalculateNobetData(currentYear, currentMonth);

            tumPersonelListesi.forEach(personel => {
                // Puantaj verisi olan personeller için hesaplama yap
                if (aylikPuantajVerisi[personel.id]) {
                    // Global puantajData değişkenini geçici olarak bu ayın verisiyle doldur
                    window.puantajData = aylikPuantajVerisi; 

                    if (personel.neviAdi?.includes('Eğitim Personeli') || personel.unvan?.includes('Müdür')) {
                       totalEkders += calculateMonthlyHours(personel.id).ekDers;
                    }
                    totalNobet += nobetVerisi[personel.id] || 0;
                    totalRehberlik += calculateEffectiveRehberlikHours(personel.id, currentYear, currentMonth, aylikPuantajVerisi);
                }
            });
        }

        aylikEkdersEl.textContent = totalEkders;
        aylikNobetEl.textContent = totalNobet;
        aylikRehberlikEl.textContent = totalRehberlik;

        // Bu ay raporlu olanları bulma
        const raporluIzinTipi = izinTipiSnap.docs.find(doc => doc.data().kod === 'R');
        if (raporluIzinTipi) {
            const ayinIlkGunu = new Date(currentYear, currentMonth, 1);
            const ayinSonGunu = new Date(currentYear, currentMonth + 1, 0);
            const raporluPersonelListesi = new Set();

            const raporSorgusu = query(collection(db, "izinler"), where("izinTipiId", "==", raporluIzinTipi.id));
            const raporluIzinlerSnap = await getDocs(raporSorgusu);

            raporluIzinlerSnap.forEach(doc => {
                const izin = doc.data();
                const baslangic = new Date(izin.baslangicTarihi + 'T00:00:00');
                const bitis = new Date(izin.bitisTarihi + 'T23:59:59');
                // İzin aralığı bu ay ile kesişiyor mu kontrolü
                if (baslangic <= ayinSonGunu && bitis >= ayinIlkGunu) {
                    const personelAdi = personelMap.get(izin.personelId);
                    if (personelAdi) raporluPersonelListesi.add(personelAdi);
                }
            });

            if (raporluPersonelListesi.size === 0) {
                aylikRaporluListEl.innerHTML = '<span class="no-data">Bu ay raporlu personel yok.</span>';
            } else {
                aylikRaporluListEl.innerHTML = Array.from(raporluPersonelListesi).map(ad => `<span>${ad}</span>`).join('');
            }
        } else {
             aylikRaporluListEl.innerHTML = '<span class="no-data">Rapor tanımı bulunamadı.</span>';
        }

    } catch (error) {
        console.error("Dashboard verisi çekilirken hata:", error);
        personelValueEl.textContent = 'Hata!';
        [nobetListEl, izinListEl, gorevListEl, aylikRaporluListEl].forEach(el => el.innerHTML = '<span class="no-data" style="color:red;">Veri yüklenemedi.</span>');
        [aylikEkdersEl, aylikNobetEl, aylikRehberlikEl].forEach(el => el.textContent = 'X');
    }
}
/* ======================================================================================================== */


        // --- AYARLAR VERİTABANI İŞLEMLERİ ---
        const getSettings = async (collectionName) => getDocs(query(collection(db, collectionName), orderBy("name")));
        const addSetting = (collectionName, data) => addDoc(collection(db, collectionName), data);
        const deleteSetting = (collectionName, id) => deleteDoc(doc(db, collectionName, id));

        // --- AYARLAR MODÜLÜ YÖNETİMİ ---
        async function renderSettingsList(collectionName, listElementId, relatedData) {
            const listElement = document.getElementById(listElementId);
            if (!listElement) return;
            listElement.innerHTML = '<li>Yükleniyor...</li>';
            try {
                const snapshot = await getSettings(collectionName);
                if (snapshot.empty) { listElement.innerHTML = '<li>Henüz veri eklenmemiş.</li>'; return; }
                listElement.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = doc.data(); const li = document.createElement('li'); let displayText = item.name;
                    if (collectionName === 'ayarlar_gorevler' && relatedData) {
                        const nevi = relatedData.find(n => n.id === item.neviId);
                        displayText = `${item.name} <small style="color: #555;">(${nevi ? nevi.name : 'Bilinmeyen'})</small>`;
                    }
                    if (collectionName === 'ayarlar_izin_tipleri') {
                        displayText = `${item.name} <strong style="color: var(--theme-accent);"> (Kod: ${item.kod})</strong>`;
                    }
                    li.innerHTML = `
    <span>${displayText}</span>
    <div class="actions-cell" style="width: auto; min-width: 120px;">
        <button class="btn btn-edit btn-edit-setting" data-id="${doc.id}" data-collection="${collectionName}" data-name="${item.name}">Düzenle</button>
        <button class="btn btn-delete btn-delete-setting" data-id="${doc.id}" data-collection="${collectionName}">Sil</button>
    </div>
`;
                    listElement.appendChild(li);
                });
            } catch (e) { listElement.innerHTML = '<li>Veri yüklenemedi.</li>'; console.error("Error rendering settings:", e); }
        }
        
        async function initializeSettings() {
            const tabsContainer = document.querySelector('.settings-tabs');
            if (tabsContainer.dataset.initialized) return;
            tabsContainer.dataset.initialized = 'true';
            const neviSnapshot = await getSettings('ayarlar_personel_nevileri');
            const personelNevileri = neviSnapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
            const renderAll = () => Promise.all([ renderSettingsList('ayarlar_personel_nevileri', 'nevi-list'), renderSettingsList('ayarlar_gorevler', 'gorev-list', personelNevileri), renderSettingsList('ayarlar_dersler', 'ders-list'), renderSettingsList('ayarlar_siniflar', 'sinif-list'), renderSettingsList('ayarlar_nobet_yerleri', 'nobet-yeri-list'), renderSettingsList('ayarlar_izin_tipleri', 'izin-tipi-list') ]);
            const populateGorevNeviSelect = () => { const select = document.getElementById('gorev-nevi-select'); select.innerHTML = '<option value="">Personel Nevi Seçin</option>'; personelNevileri.forEach(nevi => select.add(new Option(nevi.name, nevi.id))); };
            await renderAll();
            populateGorevNeviSelect();
            document.getElementById('add-nevi-btn').addEventListener('click', async () => {
    const input = document.getElementById('add-nevi-input');
    const neviAdi = input.value.trim();
    if (neviAdi) {
        await addSetting('ayarlar_personel_nevileri', { name: neviAdi });
        showToast('Personel nevisi başarıyla eklendi.');
        input.value = ''; // Ekleme sonrası input alanını temizle
        await renderSettingsList('ayarlar_personel_nevileri', 'nevi-list'); // Listeyi anında güncelle
    }
});
            document.getElementById('add-gorev-btn').addEventListener('click', async () => { const input = document.getElementById('add-gorev-input'); const neviSelect = document.getElementById('gorev-nevi-select'); if(input.value.trim() && neviSelect.value) { await addSetting('ayarlar_gorevler', { name: input.value.trim(), neviId: neviSelect.value }); input.value = ''; await renderSettingsList('ayarlar_gorevler', 'gorev-list', personelNevileri); } });
            document.getElementById('add-ders-btn').addEventListener('click', async () => { const input = document.getElementById('add-ders-input'); if(input.value.trim()) { await addSetting('ayarlar_dersler', { name: input.value.trim() }); input.value = ''; await renderSettingsList('ayarlar_dersler', 'ders-list'); } });
            document.getElementById('add-sinif-btn').addEventListener('click', async () => { const input = document.getElementById('add-sinif-input'); if(input.value.trim()) { await addSetting('ayarlar_siniflar', { name: input.value.trim() }); input.value = ''; await renderSettingsList('ayarlar_siniflar', 'sinif-list'); } });
            document.getElementById('add-nobet-yeri-btn').addEventListener('click', async () => { const input = document.getElementById('add-nobet-yeri-input'); if(input.value.trim()) { await addSetting('ayarlar_nobet_yerleri', { name: input.value.trim() }); input.value = ''; await renderSettingsList('ayarlar_nobet_yerleri', 'nobet-yeri-list'); } });
            document.getElementById('add-izin-tipi-btn').addEventListener('click', async () => {
                const adInput = document.getElementById('add-izin-tipi-ad-input'); const kodInput = document.getElementById('add-izin-tipi-kod-input');
                const ad = adInput.value.trim(); const kod = kodInput.value.trim().toUpperCase();
                if(ad && kod) { await addSetting('ayarlar_izin_tipleri', { name: ad, kod: kod }); adInput.value = ''; kodInput.value = ''; await renderSettingsList('ayarlar_izin_tipleri', 'izin-tipi-list'); } 
                else { showToast('İzin Adı ve Puantaj Kodu alanları zorunludur.', 'error'); }
            });
            document.querySelector('#settings .panel-body').addEventListener('click', async (e) => {
    const target = e.target;

    // Silme İşlemi
    if (target.classList.contains('btn-delete-setting')) {
        const { id, collection } = target.dataset;
        if (confirm('Bu öğeyi silmek istediğinizden emin misiniz?')) {
            await deleteSetting(collection, id);
            showToast('Ayar başarıyla silindi.');
            if (collection === 'ayarlar_personel_nevileri') {
                location.reload();
            } else {
                await renderAll();
            }
        }
    }

    // Düzenleme İşlemi
    if (target.classList.contains('btn-edit-setting')) {
        const { id, collection, name } = target.dataset;
        const modal = document.getElementById('edit-setting-modal');
        const input = document.getElementById('edit-setting-input');
        const saveBtn = document.getElementById('edit-setting-save-btn');

        input.value = name;
        modal.querySelector('.close-modal').onclick = () => modal.style.display = 'none';

        saveBtn.onclick = async () => {
            const newName = input.value.trim();
            if (newName && newName !== name) {
                await setDoc(doc(db, collection, id), { name: newName }, { merge: true });
                showToast('Ayar başarıyla güncellendi.');
                modal.style.display = 'none';
                if (collection === 'ayarlar_personel_nevileri') {
                    location.reload();
                } else {
                    await renderAll();
                }
            } else {
                modal.style.display = 'none';
            }
        };

        modal.style.display = 'flex';
    }
});
// YENİ EKLENECEK SATIRLAR
await loadZamanCizelgesiAyarlari();
document.getElementById('zaman-cizelgesi-kaydet-btn').addEventListener('click', saveZamanCizelgesiAyarlari);
// YENİ EKLENECEK generateTimeSlots FONKSİYONU
async function generateTimeSlots() {
    dersSaatleri.length = 0;
    try {
        const docSnap = await getDoc(doc(db, "genel_ayarlar", "zamanCizelgesi"));
        const ayarlar = docSnap.exists() ? docSnap.data() : {};
        const DERS_BASLANGIC_STR = ayarlar.dersBaslangic || '08:30';
        const TOPLAM_DERS_SAYISI = parseInt(ayarlar.toplamDers) || 8;
        const DERS_SURESI_DK = parseInt(ayarlar.dersSuresi) || 40;
        const TENEFUS_SURESI_DK = parseInt(ayarlar.teneffusSuresi) || 10;
        const OGLE_ARASI_DERS_NO = parseInt(ayarlar.ogleArasiDersNo) || 4;
        const OGLE_ARASI_SURESI_DK = parseInt(ayarlar.ogleArasiSuresi) || 45;
        const [saat, dakika] = DERS_BASLANGIC_STR.split(':').map(Number);
        let suankiZaman = new Date();
        suankiZaman.setHours(saat, dakika, 0, 0);
        for (let i = 1; i <= TOPLAM_DERS_SAYISI; i++) {
            const baslangic = new Date(suankiZaman);
            suankiZaman.setMinutes(suankiZaman.getMinutes() + DERS_SURESI_DK);
            const bitis = new Date(suankiZaman);
            dersSaatleri.push({ dersNo: i, baslangic: baslangic.toTimeString().substring(0, 5), bitis: bitis.toTimeString().substring(0, 5) });
            if (i === OGLE_ARASI_DERS_NO) {
                suankiZaman.setMinutes(suankiZaman.getMinutes() + OGLE_ARASI_SURESI_DK);
            } else if (i < TOPLAM_DERS_SAYISI) {
                suankiZaman.setMinutes(suankiZaman.getMinutes() + TENEFUS_SURESI_DK);
            }
        }
    } catch(e) {
        console.error("Zaman aralıkları oluşturulurken hata:", e);
        showToast('Zaman aralıkları ayarları okunamadı!', 'error');
    }
    const saatSelect = document.getElementById('saat');
    if (saatSelect) {
        saatSelect.innerHTML = '';
        dersSaatleri.forEach(slot => saatSelect.add(new Option(`${slot.dersNo}. Ders (${slot.baslangic}-${slot.bitis})`, slot.baslangic)));
    }
}
            tabsContainer.addEventListener('click', e => { if (e.target.matches('.settings-tab-button')) { document.querySelectorAll('.settings-tab-button, .settings-tab-content').forEach(el => el.classList.remove('active')); e.target.classList.add('active'); document.getElementById(`${e.target.dataset.tab}-tab`).classList.add('active'); 
        } 
    });
}
// YENİ EKLENECEK FONKSİYONLAR
async function saveZamanCizelgesiAyarlari() {
    const ayarlar = {
        dersBaslangic: document.getElementById('setting-dersBaslangic').value,
        toplamDers: document.getElementById('setting-toplamDers').value,
        dersSuresi: document.getElementById('setting-dersSuresi').value,
        teneffusSuresi: document.getElementById('setting-teneffusSuresi').value,
        ogleArasiDersNo: document.getElementById('setting-ogleArasiDersNo').value,
        ogleArasiSuresi: document.getElementById('setting-ogleArasiSuresi').value
    };
    try {
        await setDoc(doc(db, "genel_ayarlar", "zamanCizelgesi"), ayarlar);
        showToast('Zaman çizelgesi ayarları başarıyla kaydedildi.');
    } catch (e) {
        console.error("Zaman çizelgesi kaydedilirken hata:", e);
        showToast('Ayarlar kaydedilirken bir hata oluştu.', 'error');
    }
}

async function loadZamanCizelgesiAyarlari() {
    try {
        const docSnap = await getDoc(doc(db, "genel_ayarlar", "zamanCizelgesi"));
        if (docSnap.exists()) {
            const ayarlar = docSnap.data();
            document.getElementById('setting-dersBaslangic').value = ayarlar.dersBaslangic || '08:30';
            document.getElementById('setting-toplamDers').value = ayarlar.toplamDers || '8';
            document.getElementById('setting-dersSuresi').value = ayarlar.dersSuresi || '40';
            document.getElementById('setting-teneffusSuresi').value = ayarlar.teneffusSuresi || '10';
            document.getElementById('setting-ogleArasiDersNo').value = ayarlar.ogleArasiDersNo || '4';
            document.getElementById('setting-ogleArasiSuresi').value = ayarlar.ogleArasiSuresi || '45';
        } else {
            // Varsayılan değerleri ayarla
            document.getElementById('setting-dersBaslangic').value = '08:30';
            document.getElementById('setting-toplamDers').value = '8';
            document.getElementById('setting-dersSuresi').value = '40';
            document.getElementById('setting-teneffusSuresi').value = '10';
            document.getElementById('setting-ogleArasiDersNo').value = '4';
            document.getElementById('setting-ogleArasiSuresi').value = '45';
        }
    } catch (e) {
        console.error("Zaman çizelgesi yüklenirken hata:", e);
    }
}
      


          
       // BU FONKSİYONUN TAMAMINI YAPIŞTIRIN
async function fetchStaff() {
    const listContainer = document.querySelector('#staff-list .panel-body');
    listContainer.innerHTML = '<p>Personel listesi yükleniyor...</p>';
    try {
        const personelSorgusu = query(collection(db, "personel"), orderBy("ad_soyad"));
        const [staffSnap, neviSnap, gorevSnap] = await Promise.all([
            getDocs(personelSorgusu),
            getSettings('ayarlar_personel_nevileri'),
            getSettings('ayarlar_gorevler')
        ]);

        const neviMap = Object.fromEntries(neviSnap.docs.map(doc => [doc.id, doc.data().name]));
        const gorevMap = Object.fromEntries(gorevSnap.docs.map(doc => [doc.id, doc.data().name]));

        if (staffSnap.empty) {
            listContainer.innerHTML = '<p>Henüz kayıtlı personel bulunmamaktadır.</p>';
            return;
        }

        const aktifPersonel = [];
        const ayrilanPersonel = [];
        const bugun = new Date();
        const ayinIlkGunu = new Date(bugun.getFullYear(), bugun.getMonth(), 1);

        staffSnap.forEach(doc => {
            const personel = { id: doc.id, ...doc.data() };
            const ayrilisTarihiStr = personel.isten_ayrilis;

            if (ayrilisTarihiStr && ayrilisTarihiStr.trim() !== '') {
                const ayrilisTarihi = new Date(ayrilisTarihiStr);
                if (!isNaN(ayrilisTarihi.getTime()) && ayrilisTarihi < ayinIlkGunu) {
                    ayrilanPersonel.push(personel);
                } else {
                    aktifPersonel.push(personel);
                }
            } else {
                aktifPersonel.push(personel);
            }
        });

        // Verilen listeye göre HTML tablosu oluşturan yardımcı fonksiyon GÜNCELLENDİ
        const createTableHTML = (personelListesi) => {
            if (personelListesi.length === 0) {
                return '<p style="padding: 15px; background-color: #f8f9fa; border-radius: 5px;">Bu listede gösterilecek personel bulunmamaktadır.</p>';
            }
            // *** YENİ SÜTUN BAŞLIKLARI: S.N. ve Cinsiyet eklendi ***
            let tableHTML = `<div class="table-container"><table class="staff-table"><thead><tr><th>S.N.</th><th>Adı Soyadı</th><th>Cinsiyet</th><th>Personel Nevisi</th><th>Görevi / Branşı</th><th>İşe Giriş</th><th>İşten Ayrılış</th><th>İşlemler</th></tr></thead><tbody>`;
            
            // *** YENİ SATIR İÇERİĞİ: Sıra numarası ve cinsiyet bilgisi eklendi ***
            personelListesi.forEach((s, index) => {
                const cinsiyet = s.cinsiyet === 'kadin' ? 'Kadın' : (s.cinsiyet === 'erkek' ? 'Erkek' : '---');
                tableHTML += `<tr>
                                <td>${index + 1}</td>
                                <td>${s.ad_soyad || ''}</td>
                                <td>${cinsiyet}</td>
                                <td>${neviMap[s.personel_nevisi] || 'Bilinmiyor'}</td>
                                <td>${gorevMap[s.gorevi_bransi] || 'Bilinmiyor'}</td>
                                <td>${formatDateDDMMYYYY(s.ise_giris)}</td>
                                <td>${formatDateDDMMYYYY(s.isten_ayrilis)}</td>
                                <td class="actions-cell"><button class="btn btn-edit" data-id="${s.id}">Düzenle</button><button class="btn btn-delete" data-id="${s.id}">Sil</button></td>
                              </tr>`;
            });
            tableHTML += `</tbody></table></div>`;
            return tableHTML;
        };

        let finalHTML = '<h3>Aktif Personel Listesi</h3>';
        finalHTML += createTableHTML(aktifPersonel);
        finalHTML += '<h3 style="margin-top: 40px; border-top: 2px solid #dee2e6; padding-top: 20px;">Ayrılan Personel Listesi</h3>';
        finalHTML += createTableHTML(ayrilanPersonel);

        listContainer.innerHTML = finalHTML;

    } catch (e) {
        listContainer.innerHTML = '<p style="color:red;">Personel listesi yüklenemedi.</p>';
        console.error(e);
    }
}
  
        async function loadPersonelForm(staffId = null, staffData = null) {
    const template = document.getElementById('personel-form-template');
    const formContainer = document.getElementById('personelForm');
    formContainer.innerHTML = ''; // Formu temizle
    formContainer.appendChild(template.content.cloneNode(true));

    formContainer.dataset.editingId = staffId || '';
    document.getElementById('modal-title').textContent = staffId ? 'Personel Bilgilerini Düzenle' : 'Yeni Personel Ekle';

    const neviSelect = document.getElementById('personel_nevisi');
    const gorevSelect = document.getElementById('gorevi_bransi');
    const sozlesmeTuruSelect = document.getElementById('sozlesme_turu');
    const kismiZamanliDiv = document.getElementById('kismi_zamanli_div');
    const rehberlikGoreviDiv = document.getElementById('rehberlik_gorevi_div');
    const maasKarsiligiDiv = document.getElementById('maas_karsiligi_div');

    function updatePersonelFormVisibility() {
        const selectedNeviText = neviSelect.options[neviSelect.selectedIndex]?.text || '';
        const selectedContractType = sozlesmeTuruSelect.value;
        kismiZamanliDiv.style.display = (selectedContractType === 'Kısmi Süreli') ? 'block' : 'none';
        const isIndefinite = selectedContractType === 'Belirsiz Süreli';
        rehberlikGoreviDiv.style.display = isIndefinite ? 'none' : 'block';
        const isSupportStaff = selectedNeviText.includes('Destek Personeli');
        maasKarsiligiDiv.style.display = (isIndefinite || isSupportStaff) ? 'none' : 'block';
    }

    const neviSnapshot = await getSettings('ayarlar_personel_nevileri');
    neviSnapshot.forEach(doc => neviSelect.add(new Option(doc.data().name, doc.id)));

    // Olay Dinleyicisi: Nevi değiştiğinde Görev listesini doldurur
    neviSelect.addEventListener('change', async () => {
        const neviId = neviSelect.value;
        gorevSelect.innerHTML = '<option value="">Yükleniyor...</option>';
        if (!neviId) {
            gorevSelect.innerHTML = '<option value="">Önce Personel Nevi Seçin</option>';
            return;
        }
        const q = query(collection(db, 'ayarlar_gorevler'), where('neviId', '==', neviId));
        const gorevSnapshot = await getDocs(q);
        gorevSelect.innerHTML = '<option value="">Seçim yapınız...</option>';
        if (!gorevSnapshot.empty) {
            gorevSnapshot.forEach(doc => gorevSelect.add(new Option(doc.data().name, doc.id)));
        }
        updatePersonelFormVisibility();
    });

    sozlesmeTuruSelect.addEventListener('change', updatePersonelFormVisibility);

    // Formu doldurma (Düzenleme modu için)
    if (staffId && staffData) {
        document.getElementById('ad_soyad').value = staffData.ad_soyad || '';
        document.getElementById('tc_kimlik_no').value = staffData.tc_kimlik_no || '';
        document.getElementById('sgk_no').value = staffData.sgk_no || '';
        
        // 1. Personel Nevisini ayarla
        neviSelect.value = staffData.personel_nevisi || '';
        
        // --- ÖNEMLİ DÜZELTME BAŞLANGICI ---
        // Hatalı olan dispatchEvent kaldırılarak, görev listesi manuel olarak ve doğru zamanlamayla dolduruluyor.
        
        // 2. Görev listesini, seçilen Nevi'ye göre DOLDUR ve bitmesini BEKLE (await)
        const neviId = neviSelect.value;
        gorevSelect.innerHTML = '<option value="">Yükleniyor...</option>';
        if (neviId) {
            const q = query(collection(db, 'ayarlar_gorevler'), where('neviId', '==', neviId));
            const gorevSnapshot = await getDocs(q);
            gorevSelect.innerHTML = '<option value="">Seçim yapınız...</option>';
            gorevSnapshot.forEach(doc => gorevSelect.add(new Option(doc.data().name, doc.id)));
        } else {
            gorevSelect.innerHTML = '<option value="">Önce Personel Nevisi seçin</option>';
        }

        // 3. Artık liste dolu olduğu için personelin mevcut GÖREVİNİ SEÇ
        gorevSelect.value = staffData.gorevi_bransi || '';
        // --- ÖNEMLİ DÜZELTME BİTİŞİ ---

        sozlesmeTuruSelect.value = staffData.sozlesme_turu || 'Belirsiz Süreli';
        
        // YAPIŞTIRILACAK YENİ KOD BLOĞU
        if (staffData.cinsiyet) {
            document.querySelector(`input[name="cinsiyet"][value="${staffData.cinsiyet}"]`).checked = true;
        }
        if (staffData.es_durumu) {
            document.querySelector(`input[name="es_durumu"][value="${staffData.es_durumu}"]`).checked = true;
        }
        if (staffData.rehberlik_gorevi) {
            document.querySelector(`input[name="rehberlik_gorevi"][value="${staffData.rehberlik_gorevi}"]`).checked = true;
        }
        
        document.getElementById('cocuk_0_6').value = staffData.cocuk_0_6 || '0';
        document.getElementById('cocuk_6_ustu').value = staffData.cocuk_6_ustu || '0';
        document.getElementById('ise_giris').value = staffData.ise_giris || '';
        document.getElementById('isten_ayrilis').value = staffData.isten_ayrilis || '';
        document.getElementById('aciklama').value = staffData.aciklama || '';
        document.getElementById('maas_karsiligi').value = staffData.maas_karsiligi || '20';

        if (staffData.kismi_zamanli_calisma) {
            const gunMap = { 'Pazartesi': 'pzts', 'Salı': 'sali', 'Çarşamba': 'crs', 'Perşembe': 'prs', 'Cuma': 'cuma', 'Cumartesi': 'cmrts', 'Pazar': 'pazar' };
            for (const gun in staffData.kismi_zamanli_calisma) {
                const shortDay = gunMap[gun];
                if (shortDay) {
                    const checkbox = document.getElementById(`${shortDay}_calisiyor`);
                    const input = document.getElementById(`${shortDay}_saat`);
                    if (checkbox && input) {
                        checkbox.checked = true;
                        input.value = staffData.kismi_zamanli_calisma[gun];
                    }
                }
            }
        }
    } else {
        document.getElementById('ise_giris').valueAsDate = new Date();
        document.getElementById('es_bekar').checked = true;
    }

    updatePersonelFormVisibility();
}
        
        // YENİ EKLENECEK GÜNCEL FONKSİYON
let scheduleInitialized = false;
async function initializeSchedule() {
    if (scheduleInitialized) return;

    try {
        const [siniflarSnap, derslerSnap, personelSnap, neviSnap, gorevSnap] = await Promise.all([
            getSettings('ayarlar_siniflar'),
            getSettings('ayarlar_dersler'),
            getDocs(query(collection(db, 'personel'))),
            getSettings('ayarlar_personel_nevileri'),
            getSettings('ayarlar_gorevler')
        ]);

        const egitimPersoneliNevi = neviSnap.docs.find(doc => doc.data().name.includes('Eğitim Personeli'));
        const egitimPersoneliNeviId = egitimPersoneliNevi ? egitimPersoneliNevi.id : null;
        
        // Rehber Öğretmen filtresi için kullanılan değişkenler kaldırıldı.
        
        const siniflar = siniflarSnap.docs.map(d => d.data().name);
        const dersler = derslerSnap.docs.map(d => d.data().name);

        const personeller = personelSnap.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(p => {
                // FİLTRE DEĞİŞİKLİĞİ: Artık sadece personelin "Eğitim Personeli" olup olmadığı kontrol ediliyor.
                // Rehber öğretmen olup olmaması listeye eklenmesine engel değil.
                const isEgitimPersoneli = p.personel_nevisi === egitimPersoneliNeviId;
                return isEgitimPersoneli;
            })
            .map(p => p.ad_soyad);

        const dersSelect = document.getElementById('dersAdi');
        dersSelect.innerHTML = '<option value="">Ders Seçin...</option>';
        dersler.forEach(ders => dersSelect.add(new Option(ders, ders)));

        const ogretmenSelect = document.getElementById('ogretmen');
        ogretmenSelect.innerHTML = '<option value="">Öğretmen Seçin...</option>';
        personeller.forEach(p => ogretmenSelect.add(new Option(p, p)));

        if (siniflar.length === 0) {
            document.getElementById('schedule-display-area').innerHTML = '<p>Lütfen "Ayarlar" menüsünden en az bir sınıf ekleyin.</p>';
            return;
        }
        
        window.aktifSinif = siniflar[0];
        window.tumProgramlar = {};

        await generateTimeSlots();
        createTabs(siniflar);
        
        await loadScheduleForClass(window.aktifSinif);

        scheduleInitialized = true;

    } catch (error) {
        console.error("Ders programı başlatılırken hata:", error);
        showToast('Ders programı yüklenemedi. Ayarlarınızı kontrol edin.', 'error');
    }
}
        const dersSaatleri = [];
        function generateTimeSlots() {
            dersSaatleri.length = 0; let suankiZaman = new Date(); suankiZaman.setHours(9, 30, 0, 0);
            for (let i = 1; i <= 8; i++) {
                let baslangic = new Date(suankiZaman); suankiZaman.setMinutes(suankiZaman.getMinutes() + 40); let bitis = new Date(suankiZaman);
                dersSaatleri.push({ dersNo: i, baslangic: baslangic.toTimeString().substring(0, 5), bitis: bitis.toTimeString().substring(0, 5) });
                if (i === 4) suankiZaman.setMinutes(suankiZaman.getMinutes() + 60);
                else if (i < 8) suankiZaman.setMinutes(suankiZaman.getMinutes() + 10);
            }
            const saatSelect = document.getElementById('saat'); saatSelect.innerHTML = '';
            dersSaatleri.forEach(slot => saatSelect.add(new Option(`${slot.dersNo}. Ders (${slot.baslangic}-${slot.bitis})`, slot.baslangic)));
        }
        function createTabs(siniflar) {
            const tabContainer = document.getElementById('tab-container');
            tabContainer.innerHTML = '';
            siniflar.forEach(sinif => {
                const tab = document.createElement('button');
                tab.className = 'tab-link';
                if (sinif === window.aktifSinif) tab.classList.add('active');
                tab.textContent = sinif;
                tab.addEventListener('click', () => {
                    window.aktifSinif = sinif;
                    document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    // YENİ: Taba tıklanınca ilgili sınıfın programını veritabanından yükle
                    loadScheduleForClass(sinif);
                });
                tabContainer.appendChild(tab);
            });
        }
        function renderSchedule() {
            const displayArea = document.getElementById('schedule-display-area');
            const gunler = ["Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma"];
            let tableHTML = '<table class="schedule-table"><thead><tr><th>Saatler</th>';
            gunler.forEach(gun => tableHTML += `<th>${gun}</th>`);
            tableHTML += '</tr></thead><tbody>';

            const mevcutProgram = window.tumProgramlar[window.aktifSinif] || {};

            dersSaatleri.forEach((slot) => {
                tableHTML += `<tr><th>${slot.dersNo}. Ders<br>${slot.baslangic}-${slot.bitis}</th>`;
                gunler.forEach(gun => {
                    const dersData = mevcutProgram[gun]?.[slot.baslangic];
                    // YENİ: Silme butonu eklendi ve data-attributeları olan td elementi güncellendi
                    tableHTML += `<td data-gun="${gun}" data-saat="${slot.baslangic}">
                        ${dersData ? `
                        <div class="ders-karti">
                            <button class="delete-lesson-btn" title="Dersi Sil">×</button>
                            <strong>${dersData.ogretmen}</strong>
                            <span>${dersData.dersAdi}</span>
                        </div>` : ''}
                    </td>`;
                });
                tableHTML += '</tr>';
                if (slot.dersNo === 4) {
                    tableHTML += '<tr><td colspan="6" style="background:#e9ecef;font-weight:bold;">ÖĞLE ARASI</td></tr>';
                }
            });
            displayArea.innerHTML = tableHTML + `</tbody></table>`;

            // YENİ: Silme butonu için olay dinleyici ekleniyor
            document.querySelectorAll('.delete-lesson-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Diğer tıklama olaylarını engelle
                    const td = e.target.closest('td');
                    const gun = td.dataset.gun;
                    const saat = td.dataset.saat;
                    deleteLesson(gun, saat);
                });
            });
        }
async function loadScheduleForClass(sinifAdi) {
            try {
                // Sınıf adındaki '/' karakterini '-' ile değiştiriyoruz.
                const sanitizedSinifAdi = sinifAdi.replace(/\//g, '-');
                const docRef = doc(db, "ders_programlari", sanitizedSinifAdi);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    window.tumProgramlar[sinifAdi] = docSnap.data();
                } else {
                    window.tumProgramlar[sinifAdi] = {};
                }
            } catch (error) {
                console.error("Ders programı yüklenirken hata:", error);
                window.tumProgramlar[sinifAdi] = {}; 
            }
            renderSchedule();
        }
       

        function deleteLesson(gun, saat) {
             if (confirm(`${gun} günü ${saat} saatindeki dersi silmek istediğinizden emin misiniz?`)) {
                if (window.tumProgramlar[window.aktifSinif]?.[gun]?.[saat]) {
                    // 1. Geçici değişkenden dersi sil
                    delete window.tumProgramlar[window.aktifSinif][gun][saat];
                    // 2. Tabloyu güncel haliyle yeniden çiz
                    renderSchedule();
                    // 3. Değişikliği veritabanına kaydet
                    saveScheduleForClass(window.aktifSinif);
                }
            }
        }
        function addLesson() {
            const gun = document.getElementById('gun').value; const saat = document.getElementById('saat').value; const ogretmen = document.getElementById('ogretmen').value; const dersAdi = document.getElementById('dersAdi').value;
            if (!ogretmen || !dersAdi) return showToast('Lütfen Öğretmen ve Ders seçin.', 'error');

            // Geçici değişkende ilgili gün objesi yoksa oluştur
            if (!window.tumProgramlar[window.aktifSinif]) {
                 window.tumProgramlar[window.aktifSinif] = {};
            }
            if (!window.tumProgramlar[window.aktifSinif][gun]) {
                window.tumProgramlar[window.aktifSinif][gun] = {};
            }

            // 1. Dersi geçici değişkene ekle
            window.tumProgramlar[window.aktifSinif][gun][saat] = { ogretmen, dersAdi };
            // 2. Tabloyu yeniden çizerek anında göster
            renderSchedule();
            // 3. YENİ: Değişikliği veritabanına otomatik kaydet
            saveScheduleForClass(window.aktifSinif);
        }
async function saveScheduleForClass(sinifAdi) {
    // Firestore'da "9/A" gibi document ID'leri geçersizdir.
    // Yükleme fonksiyonunda olduğu gibi '/' karakterini '-' ile değiştiriyoruz.
    const sanitizedSinifAdi = sinifAdi.replace(/\//g, '-');
    const docRef = doc(db, "ders_programlari", sanitizedSinifAdi);
    const dataToSave = window.tumProgramlar[sinifAdi] || {};

    try {
        // setDoc komutu ile ilgili sınıfın tüm programını tek seferde kaydediyoruz.
        // Bu komut, döküman yoksa oluşturur, varsa üzerine yazar.
        await setDoc(docRef, dataToSave);
        showToast(`${sinifAdi} için program başarıyla kaydedildi.`, 'success');
    } catch (error) {
        console.error("Ders programı kaydedilirken hata oluştu:", error);
        showToast('Program kaydedilirken bir hata meydana geldi.', 'error');
    }
}

         let geciciDetaylar = [];
         let duzenlenenGorevDetaylari = []; //
         let gorevlendirmeInitialized = false;

        async function populateOgretmenSelectsForGorevlendirme() {
    const gAsilOgretmen = document.getElementById('g-asil-ogretmen');
    const gGorevliOgretmen = document.getElementById('g-gorevli-ogretmen');
    if (!gAsilOgretmen || !gGorevliOgretmen) return;

    gAsilOgretmen.innerHTML = '<option value="">Yükleniyor...</option>';
    gGorevliOgretmen.innerHTML = '<option value="">Yükleniyor...</option>';

    try {
        const [personelSnap, neviSnap, gorevSnap] = await Promise.all([
            getDocs(collection(db, 'personel')),
            getSettings('ayarlar_personel_nevileri'),
            getSettings('ayarlar_gorevler')
        ]);

        const egitimPersoneliNevi = neviSnap.docs.find(doc => doc.data().name.includes('Eğitim Personeli'));
        const egitimPersoneliNeviId = egitimPersoneliNevi ? egitimPersoneliNevi.id : null;

        const idariGorevler = new Set();
        gorevSnap.forEach(doc => {
            const gorevAdi = doc.data().name.toLowerCase();
            if (gorevAdi.includes('müdür') || gorevAdi.includes('rehber öğretmen')) {
                idariGorevler.add(doc.id);
            }
        });

        const gosterilecekPersoneller = [];
        personelSnap.forEach(doc => {
            const personel = { id: doc.id, ...doc.data() };
            const isEgitimPersoneli = personel.personel_nevisi === egitimPersoneliNeviId;
            const isIdariGorevli = idariGorevler.has(personel.gorevi_bransi);
            if (isEgitimPersoneli || isIdariGorevli) {
                gosterilecekPersoneller.push(personel);
            }
        });

        gAsilOgretmen.innerHTML = '<option value="">Seçiniz...</option>';
        gGorevliOgretmen.innerHTML = '<option value="">Seçiniz...</option>';
        gosterilecekPersoneller.forEach(p => {
            gAsilOgretmen.add(new Option(p.ad_soyad, p.id));
            gGorevliOgretmen.add(new Option(p.ad_soyad, p.id));
        });

    } catch(e) {
        console.error("Görevlendirilecek öğretmenler yüklenemedi:", e);
        showToast('Öğretmen listesi yüklenemedi.', 'error');
    }
}

async function initializeGorevlendirme() {
    if (gorevlendirmeInitialized) return;

    const gDetayEkleBtn = document.getElementById('g-detay-ekle-btn');
    const gKaydetBtn = document.getElementById('g-kaydet-btn');
    const geciciListeUL = document.getElementById('gecici-detay-listesi');
    const gorevlendirmeTbody = document.getElementById('gorevlendirme-tbody');
    const sinifSelect = document.getElementById('d-sinif-select');
    const bransSelect = document.getElementById('d-brans-select');
    const saatSelect = document.getElementById('d-saat-select');
    const yazdirBtn = document.getElementById('btn-gorev-yazdir');

    if (sinifSelect && sinifSelect.options.length === 0) {
        const siniflarSnap = await getSettings('ayarlar_siniflar');
        siniflarSnap.forEach(doc => sinifSelect.add(new Option(doc.data().name, doc.data().name)));
    }
    if (bransSelect && bransSelect.options.length === 0) {
        const derslerSnap = await getSettings('ayarlar_dersler');
        derslerSnap.forEach(doc => bransSelect.add(new Option(doc.data().name, doc.data().name)));
    }
    await generateTimeSlots(); 
    
    if (saatSelect && saatSelect.options.length === 0) {
        saatSelect.innerHTML = '<option value="">Ders Saati Seçin...</option>';
        dersSaatleri.forEach(slot => {
            saatSelect.add(new Option(`${slot.dersNo}. Ders (${slot.baslangic}-${slot.bitis})`, slot.dersNo));
        });
    }

    await populateOgretmenSelectsForGorevlendirme();
    await renderGorevlendirmeTable();

    if(gDetayEkleBtn) gDetayEkleBtn.addEventListener('click', addDetay);
    if(gKaydetBtn) gKaydetBtn.addEventListener('click', addGorevlendirme);
    if(yazdirBtn) yazdirBtn.addEventListener('click', () => window.print());

    if(geciciListeUL) geciciListeUL.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-temp-btn')) {
            const index = parseInt(e.target.dataset.index);
            geciciDetaylar.splice(index, 1);
            renderGeciciDetayListesi();
        }
    });
    if(gorevlendirmeTbody) gorevlendirmeTbody.addEventListener('click', async (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const id = target.dataset.id;
        if (target.classList.contains('btn-delete-gorev')) {
            if (confirm('Bu görevlendirme kaydını silmek istediğinizden emin misiniz?')) {
                await deleteDoc(doc(db, 'ders_gorevlendirmeleri', id));
                showToast('Görevlendirme başarıyla silindi.');
                await renderGorevlendirmeTable();
            }
        }
        if (target.classList.contains('btn-edit-gorev')) {
            openEditGorevlendirmeModal(id);
        }
    });

    const editDetayEkleBtn = document.getElementById('edit-g-detay-ekle-btn');
    if(editDetayEkleBtn) editDetayEkleBtn.addEventListener('click', () => {
        const sinif = document.getElementById('edit-d-sinif-select').value;
        const brans = document.getElementById('edit-d-brans-select').value;
        const saat = parseInt(document.getElementById('edit-d-saat-select').value);
        if (!sinif || !brans || !saat) {
            return showToast('Lütfen Sınıf, Branş ve Saat seçimi yapın.', 'error');
        }
        duzenlenenGorevDetaylari.push({ sinif, brans, saat });
        renderDuzenlenenDetayListesi();
    });

    const editDetayListesi = document.getElementById('edit-g-detay-listesi');
    if(editDetayListesi) editDetayListesi.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-temp-btn')) {
            const index = parseInt(e.target.dataset.index);
            duzenlenenGorevDetaylari.splice(index, 1);
            renderDuzenlenenDetayListesi();
        }
    });
    
    const editForm = document.getElementById('editGorevlendirmeForm');
    if(editForm) editForm.addEventListener('submit', saveGorevlendirmeChanges);
    
    const closeModalBtn = document.querySelector('#edit-gorevlendirme-modal .close-modal');
    if(closeModalBtn) closeModalBtn.addEventListener('click', () => {
        document.getElementById('edit-gorevlendirme-modal').classList.remove('open');
    });

    gorevlendirmeInitialized = true;
}

async function renderGorevlendirmeTable() {
    const gTbody = document.getElementById('gorevlendirme-tbody');
    gTbody.innerHTML = '<tr><td colspan="7">Görevlendirmeler yükleniyor...</td></tr>';

    try {
        const [gorevlendirmeSnap, personelSnap] = await Promise.all([
            getDocs(query(collection(db, 'ders_gorevlendirmeleri'), orderBy("tarih", "desc"))),
            getDocs(collection(db, 'personel'))
        ]);
        const personelMap = new Map();
        personelSnap.forEach(doc => personelMap.set(doc.id, doc.data().ad_soyad));

        if (gorevlendirmeSnap.empty) {
            gTbody.innerHTML = '<tr><td colspan="7">Kayıtlı görevlendirme bulunamadı.</td></tr>';
            return;
        }

        gTbody.innerHTML = '';
        gorevlendirmeSnap.forEach(doc => {
            const g = doc.data();
            const asil = personelMap.get(g.asilId) || 'Bilinmiyor';
            const gorevli = personelMap.get(g.gorevliId) || 'Bilinmiyor';
            let detaylarHTML = '<ul class="ders-detaylari">';
            g.detaylar.forEach(d => {
                detaylarHTML += `<li>${d.sinif} / ${d.brans} (${d.saat}. Ders)</li>`;
            });
            detaylarHTML += '</ul>';
            const row = gTbody.insertRow();

            row.innerHTML = `
                <td>${new Date(g.tarih).toLocaleDateString('tr-TR')}</td>
                <td>${asil}</td>
                <td>${gorevli}</td>
                <td><b>${g.toplamSaat}</b></td>
                <td>${detaylarHTML}</td>
                <td>${g.aciklama}</td>
                <td class="actions-cell no-print">
                   <button class="btn btn-edit btn-edit-gorev" data-id="${doc.id}">Düzenle</button>
                   <button class="btn btn-delete btn-delete-gorev" data-id="${doc.id}">Sil</button>
                </td>
            `;
        });
    } catch (e) {
        console.error("Görevlendirmeler yüklenemedi:", e);
        showToast('Görevlendirmeler yüklenemedi.', 'error');
        gTbody.innerHTML = '<tr><td colspan="7" style="color:red;">Veri yüklenirken bir hata oluştu.</td></tr>';
    }
}
        function renderGeciciDetayListesi() {
            const geciciListeUL = document.getElementById('gecici-detay-listesi'); geciciListeUL.innerHTML = '';
            geciciDetaylar.forEach((detay, index) => { const li = document.createElement('li'); li.innerHTML = `<span><b>${detay.sinif} / ${detay.brans}</b> - ${detay.saat}. Ders</span> <button class="delete-temp-btn" data-index="${index}">Sil</button>`; geciciListeUL.appendChild(li); });
        }
        
function renderDuzenlenenDetayListesi() {
            const listeUL = document.getElementById('edit-g-detay-listesi');
            listeUL.innerHTML = '';
            duzenlenenGorevDetaylari.forEach((detay, index) => {
                const li = document.createElement('li');
                li.style.cssText = "display: flex; justify-content: space-between; align-items: center; background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 8px;";
                li.innerHTML = `
                    <span><b>${detay.sinif} / ${detay.brans}</b> - ${detay.saat}. Ders</span>
                    <button type="button" class="delete-temp-btn" data-index="${index}" style="background: none; border: none; color: var(--danger-color); cursor: pointer; font-weight: bold;">Sil</button>
                `;
                listeUL.appendChild(li);
            });
        }
        function addDetay() {
            // ID'ler yeni select'lere göre güncellendi
            const dSinifSelect = document.getElementById('d-sinif-select');
            const dBransSelect = document.getElementById('d-brans-select');
            const dSaatSelect = document.getElementById('d-saat-select');

            const sinif = dSinifSelect.value;
            const brans = dBransSelect.value;
            const saat = parseInt(dSaatSelect.value);

            if (!sinif || !brans || !saat) {
                alert('Lütfen Sınıf, Branş ve Saat seçimi yapın.');
                return;
            }
            geciciDetaylar.push({ sinif, brans, saat });
            renderGeciciDetayListesi();
            
            // Seçim sonrası listeleri sıfırla
            dSinifSelect.value = '';
            dBransSelect.value = '';
            dSaatSelect.value = '';
        }
        async function addGorevlendirme() {
            const gTarih = document.getElementById('g-tarih'), gAsilOgretmen = document.getElementById('g-asil-ogretmen'), gGorevliOgretmen = document.getElementById('g-gorevli-ogretmen'), gAciklama = document.getElementById('g-aciklama');
            const tarih = gTarih.value, asilId = gAsilOgretmen.value, gorevliId = gGorevliOgretmen.value, aciklama = gAciklama.value.trim();
            if (!tarih || !asilId || !gorevliId) { alert('Lütfen ana bilgilerdeki tüm zorunlu alanları doldurun.'); return; }
            if (geciciDetaylar.length === 0) { alert('Lütfen en az bir ders dağılımı detayı ekleyin.'); return; }
            // Toplam saat, artık eklenen ders listesindeki eleman sayısıdır.
            const toplamSaat = geciciDetaylar.length;
            const yeniGorevlendirme = { tarih, asilId, gorevliId, toplamSaat, aciklama, detaylar: geciciDetaylar, kayitTarihi: new Date().toISOString() };
            try {
                await addDoc(collection(db, 'ders_gorevlendirmeleri'), yeniGorevlendirme);
                showToast('Görevlendirme başarıyla kaydedildi.');
                geciciDetaylar = []; renderGeciciDetayListesi();
                gTarih.value = ''; gAsilOgretmen.value = ''; gGorevliOgretmen.value = ''; gAciklama.value = '';
                await renderGorevlendirmeTable();
            } catch(e) { console.error("Görevlendirme kaydedilemedi:", e); showToast('Görevlendirme kaydedilirken bir hata oluştu.', 'error'); }
        }

        async function openEditGorevlendirmeModal(id) {
            const modal = document.getElementById('edit-gorevlendirme-modal');
            duzenlenenGorevDetaylari = []; // Listeyi her açılışta sıfırla

            // Modal içindeki select'leri doldurma (eğer boşsa)
            const sinifSelect = document.getElementById('edit-d-sinif-select');
            if(sinifSelect.options.length <= 0) { // <= 1 yerine <= 0 daha doğru olabilir
                const [siniflarSnap, derslerSnap] = await Promise.all([
                    getSettings('ayarlar_siniflar'), getSettings('ayarlar_dersler')
                ]);
                siniflarSnap.forEach(doc => sinifSelect.add(new Option(doc.data().name, doc.data().name)));
                
                const bransSelect = document.getElementById('edit-d-brans-select');
                derslerSnap.forEach(doc => bransSelect.add(new Option(doc.data().name, doc.data().name)));
                
                await generateTimeSlots(); // Ders saatlerini yükle
                const saatSelect = document.getElementById('edit-d-saat-select');
                saatSelect.innerHTML = '<option value="">Ders Saati Seçin...</option>'; // Menüyü temizle ve varsayılan ekle
                dersSaatleri.forEach(slot => {
                    saatSelect.add(new Option(`${slot.dersNo}. Ders (${slot.baslangic}-${slot.bitis})`, slot.dersNo));
                });

                const asilSelect = document.getElementById('edit-g-asil-ogretmen');
                const gorevliSelect = document.getElementById('edit-g-gorevli-ogretmen');
                const personelSnap = await getDocs(collection(db, 'personel'));
                personelSnap.forEach(doc => {
                    const p = { id: doc.id, ...doc.data() };
                    asilSelect.add(new Option(p.ad_soyad, p.id));
                    gorevliSelect.add(new Option(p.ad_soyad, p.id));
                });
            }

            try {
                const docSnap = await getDoc(doc(db, "ders_gorevlendirmeleri", id));
                if (!docSnap.exists()) {
                    showToast('Görevlendirme kaydı bulunamadı.', 'error');
                    return;
                }
                const data = docSnap.data();

                // Formun ana alanlarını doldur
                document.getElementById('edit-g-id').value = id;
                document.getElementById('edit-g-tarih').value = data.tarih;
                document.getElementById('edit-g-aciklama').value = data.aciklama || '';
                document.getElementById('edit-g-asil-ogretmen').value = data.asilId;
                document.getElementById('edit-g-gorevli-ogretmen').value = data.gorevliId;

                // Detayları geçici listeye kopyala ve ekranda çiz
                if (data.detaylar) {
                    duzenlenenGorevDetaylari = [...data.detaylar];
                }
                renderDuzenlenenDetayListesi();
                
                modal.classList.add('open');
            } catch (error) {
                console.error("Görevlendirme düzenleme verisi çekilirken hata:", error);
                showToast("Veri yüklenirken bir hata oluştu.", "error");
            }
        }

        async function saveGorevlendirmeChanges(event) {
            event.preventDefault();
            const id = document.getElementById('edit-g-id').value;
            if (!id) {
                showToast('Kaydedilecek görevlendirme bulunamadı.', 'error');
                return;
            }

            if (duzenlenenGorevDetaylari.length === 0) {
                return showToast('Lütfen en az bir ders dağılımı detayı ekleyin.', 'error');
            }

            // Toplam saati güncel listeden tekrar hesapla
            const toplamSaat = duzenlenenGorevDetaylari.length;

            const updatedData = {
                tarih: document.getElementById('edit-g-tarih').value,
                asilId: document.getElementById('edit-g-asil-ogretmen').value,
                gorevliId: document.getElementById('edit-g-gorevli-ogretmen').value,
                aciklama: document.getElementById('edit-g-aciklama').value.trim(),
                detaylar: duzenlenenGorevDetaylari, // Güncellenmiş ders listesi
                toplamSaat: toplamSaat // Yeni toplam saat
            };

            if (!updatedData.tarih || !updatedData.asilId || !updatedData.gorevliId) {
                return showToast("Lütfen Tarih ve Öğretmen alanlarını doldurun.", "error");
            }

            try {
                const gorevRef = doc(db, 'ders_gorevlendirmeleri', id);
                await setDoc(gorevRef, updatedData); // Merge yerine tam dökümanı set et
                showToast('Görevlendirme başarıyla güncellendi.');
                document.getElementById('edit-gorevlendirme-modal').classList.remove('open');
                await renderGorevlendirmeTable();
            } catch (error) {
                console.error("Görevlendirme güncelleme hatası:", error);
                showToast('Güncelleme sırasında bir hata oluştu.', 'error');
            }
        }
// YENİ EKLENECEK KOD
async function addNobet() {
    const tarihInput = document.getElementById('nobet-tarih');
    const personelSelect = document.getElementById('nobet-personel');
    const yerSelect = document.getElementById('nobet-yeri');

    const tarih = tarihInput.value;
    const personelId = personelSelect.value;
    const nobetYeriId = yerSelect.value;

    if (!tarih || !personelId || !nobetYeriId) {
        showToast('Lütfen Tarih, Personel ve Nöbet Yeri seçin.', 'error');
        return;
    }

    try {
        await addDoc(collection(db, 'nobetler'), {
            tarih: tarih,
            personelId: personelId,
            nobetYeriId: nobetYeriId
        });

        showToast('Nöbet başarıyla eklendi.', 'success');
        
        // Formu temizle
        tarihInput.value = '';
        personelSelect.value = '';
        yerSelect.value = '';
        
        // Raporu yenile
        const year = parseInt(document.getElementById('rapor-yil-gir').value);
        const month = parseInt(document.getElementById('rapor-ay-sec').value);
        await renderNobetRaporu(year, month);

    } catch (error) {
        console.error("Nöbet eklenirken hata: ", error);
        showToast('Nöbet eklenirken bir hata oluştu.', 'error');
    }
}


// BU YENİ FONKSİYONU OLDUĞU GİBİ EKLEYİN
async function deleteSelectedNobetler() {
    const selectedCheckboxes = document.querySelectorAll('.nobet-checkbox:checked');

    if (selectedCheckboxes.length === 0) {
        showToast('Lütfen silmek için en az bir nöbet seçin.', 'error');
        return;
    }

    if (!confirm(`${selectedCheckboxes.length} adet nöbet kaydını silmek istediğinizden emin misiniz?`)) {
        return;
    }

    const deletePromises = [];
    selectedCheckboxes.forEach(checkbox => {
        const nobetId = checkbox.dataset.id;
        deletePromises.push(deleteDoc(doc(db, 'nobetler', nobetId)));
    });

    try {
        await Promise.all(deletePromises);
        showToast(`${selectedCheckboxes.length} nöbet kaydı başarıyla silindi.`, 'success');
        
        // Raporu yenile
        const year = parseInt(document.getElementById('rapor-yil-gir').value);
        const month = parseInt(document.getElementById('rapor-ay-sec').value);
        await renderNobetRaporu(year, month);
    } catch (error) {
        console.error("Toplu nöbet silme hatası:", error);
        showToast('Nöbetler silinirken bir hata oluştu.', 'error');
    }
}

let nobetTakipInitialized = false;
// YENİ EKLENECEK GÜNCEL FONKSİYON
async function initializeNobetTakip() {
    if (nobetTakipInitialized) return;
    nobetTakipInitialized = true;

    // Ana Elementler
    const personelSelect = document.getElementById('nobet-personel');
    const yerSelect = document.getElementById('nobet-yeri');
    const raporAySec = document.getElementById('rapor-ay-sec');
    const raporYilGir = document.getElementById('rapor-yil-gir');
    const nobetEkleBtn = document.getElementById('nobet-ekle-btn');
    const nobetRaporTbody = document.getElementById('nobet-rapor-tbody');
    const yazdirBtn = document.getElementById('btn-nobet-yazdir');
    // Yeni butonlar eklendi
    const topluSilBtn = document.getElementById('btn-nobet-toplu-sil');

    // Kopyalama Formu Elementleri
    const copySourceMonth = document.getElementById('copy-source-month');
    const copySourceYear = document.getElementById('copy-source-year');
    const copyDestMonth = document.getElementById('copy-dest-month');
    const copyDestYear = document.getElementById('copy-dest-year');
    const copyBtn = document.getElementById('copy-schedule-btn');

    // Düzenleme Modalı Elementleri
    const editModal = document.getElementById('edit-nobet-modal');
    const editForm = document.getElementById('edit-nobet-form');
    
    // Select'leri Doldurma (Bu kısım aynı kalıyor)
    const personelSnap = await getDocs(collection(db, 'personel'));
    const nobetYeriSnap = await getSettings('ayarlar_nobet_yerleri');
    const personelOptions = personelSnap.docs.map(doc => `<option value="${doc.id}">${doc.data().ad_soyad}</option>`).join('');
    personelSelect.innerHTML = '<option value="">Personel Seçiniz...</option>' + personelOptions;
    document.getElementById('edit-nobet-personel').innerHTML = personelOptions;
    const yerOptions = nobetYeriSnap.docs.map(doc => `<option value="${doc.id}">${doc.data().name}</option>`).join('');
    yerSelect.innerHTML = '<option value="">Nöbet Yeri Seçiniz...</option>' + yerOptions;
    document.getElementById('edit-nobet-yeri').innerHTML = yerOptions;

    // Ay Select'lerini Doldurma (Bu kısım aynı kalıyor)
    const now = new Date();
    const aylar = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
    [raporAySec, copySourceMonth, copyDestMonth].forEach(select => {
        select.innerHTML = '';
        aylar.forEach((ay, index) => select.add(new Option(ay, index)));
    });
    raporAySec.value = now.getMonth();
    raporYilGir.value = now.getFullYear();
    const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0); // Bir önceki ay için
    copySourceMonth.value = prevMonth.getMonth();
    copySourceYear.value = prevMonth.getFullYear();
    copyDestMonth.value = now.getMonth();
    copyDestYear.value = now.getFullYear();

    const renderRapor = () => renderNobetRaporu(parseInt(raporYilGir.value), parseInt(raporAySec.value));
    renderRapor();

    // Olay Dinleyicileri
    raporAySec.addEventListener('change', renderRapor);
    raporYilGir.addEventListener('change', renderRapor);
    copyBtn.addEventListener('click', copyNobetSchedule);
    yazdirBtn.addEventListener('click', () => window.print());
    nobetEkleBtn.addEventListener('click', addNobet); // Bu satır bir önceki adımda düzeltilmişti
    
    // Yeni toplu silme butonu için olay dinleyici eklendi
    topluSilBtn.addEventListener('click', deleteSelectedNobetler);
    
    editModal.querySelector('.close-modal').addEventListener('click', () => editModal.classList.remove('open'));
    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveNobetChanges();
    });

    nobetRaporTbody.addEventListener('click', async (e) => {
        const target = e.target;
        // Checkbox'lara tıklama olayını dışarıda tutuyoruz çünkü o "Tümünü Seç" ile yönetiliyor.
        if (target.classList.contains('btn-delete-nobet')) {
            if (confirm('Bu nöbet kaydını silmek istediğinizden emin misiniz?')) {
                await deleteDoc(doc(db, 'nobetler', target.dataset.id));
                showToast('Nöbet kaydı silindi.');
                renderRapor();
            }
        }
        if (target.classList.contains('btn-edit-nobet')) {
            openNobetEditModal(target.dataset.id);
        }
    });
}
 // YERİNE EKLENECEK DÜZELTİLMİŞ FONKSİYON
async function renderNobetRaporu(year, month) {
    const tbody = document.getElementById('nobet-rapor-tbody');
    const thead = tbody.closest('table').querySelector('thead tr');
    thead.innerHTML = `
        <th class="no-print" style="width: 40px;"><input type="checkbox" id="select-all-nobet" title="Tümünü Seç"></th>
        <th>Tarih</th>
        <th>Gün</th>
        <th>Nöbetçi Personel</th>
        <th>Nöbet Yeri</th>
        <th class="no-print">İşlemler</th>
    `;

    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Rapor oluşturuluyor...</td></tr>`;

    // --- SAAT DİLİMİ SORUNUNU GİDEREN DEĞİŞİKLİK ---
    // Sorgu için gereken tarih metinlerini, saat dilimi hatalarını önlemek için doğrudan oluşturuyoruz.
    // Başlangıç tarihi, seçilen ayın 1. günüdür.
    const startDateString = `${year}-${String(month + 1).padStart(2, '0')}-01`;

    // Bitiş tarihi, bir sonraki ayın 1. günüdür (sorgu < olduğu için o gün dahil edilmez).
    let endYear = year;
    let endMonth = month + 2; // month 0-index'li olduğu için sonraki ayı bulmak için 2 ekliyoruz.
    if (endMonth > 12) {
        endMonth = 1;
        endYear++;
    }
    const endDateString = `${endYear}-${String(endMonth).padStart(2, '0')}-01`;
    
    const q = query(
        collection(db, 'nobetler'), 
        where('tarih', '>=', startDateString), 
        where('tarih', '<', endDateString), 
        orderBy('tarih')
    );
    // --- DEĞİŞİKLİK SONU ---

    const [nobetSnap, personelSnap, yerSnap] = await Promise.all([
        getDocs(q),
        getDocs(collection(db, 'personel')),
        getSettings('ayarlar_nobet_yerleri')
    ]);

    const personelMap = new Map(personelSnap.docs.map(doc => [doc.id, doc.data().ad_soyad]));
    const yerMap = new Map(yerSnap.docs.map(doc => [doc.id, doc.data().name]));

    if (nobetSnap.empty) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Seçili ay için nöbet kaydı bulunamadı.</td></tr>`;
        return;
    }

    tbody.innerHTML = '';
    const gunlerTR = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
    
    let sonTarih = null;
    let renkIndex = 0;
    const renkler = ['renk-a', 'renk-b'];

    nobetSnap.forEach(doc => {
        const nobet = doc.data();
        // Tarihi UTC olarak ele alarak saat dilimi sorunlarını engelliyoruz.
        const tarih = new Date(nobet.tarih + 'T00:00:00Z');
        
        if (sonTarih !== nobet.tarih) {
            sonTarih = nobet.tarih;
            renkIndex = (renkIndex + 1) % 2;
        }
        
        const row = tbody.insertRow();
        row.className = renkler[renkIndex];

        row.innerHTML = `
            <td class="no-print" style="text-align: center;">
                <input type="checkbox" class="nobet-checkbox" data-id="${doc.id}">
            </td>
            <td>${tarih.toLocaleDateString('tr-TR', { timeZone: 'UTC' })}</td>
            <td>${gunlerTR[tarih.getUTCDay()]}</td>
            <td>${personelMap.get(nobet.personelId) || 'Bilinmiyor'}</td>
            <td>${yerMap.get(nobet.nobetYeriId) || 'Bilinmiyor'}</td>
            <td class="actions-cell no-print">
                <button class="btn btn-edit btn-edit-nobet" data-id="${doc.id}">Düzenle</button>
                <button class="btn btn-delete btn-delete-nobet" data-id="${doc.id}">Sil</button>
            </td>
        `;
    });

    document.getElementById('select-all-nobet').addEventListener('change', (e) => {
        document.querySelectorAll('.nobet-checkbox').forEach(checkbox => {
            checkbox.checked = e.target.checked;
        });
    });
}


async function openNobetEditModal(id) {
    const modal = document.getElementById('edit-nobet-modal');
    try {
        const docRef = doc(db, 'nobetler', id);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('edit-nobet-id').value = id;
            document.getElementById('edit-nobet-tarih').value = data.tarih;
            document.getElementById('edit-nobet-personel').value = data.personelId;
            document.getElementById('edit-nobet-yeri').value = data.nobetYeriId;
            modal.classList.add('open');
        } else {
            showToast('Nöbet kaydı bulunamadı.', 'error');
        }
    } catch (error) {
        console.error("Nöbet düzenleme verisi çekilirken hata:", error);
        showToast('Veri yüklenemedi.', 'error');
    }
}

async function saveNobetChanges() {
    const modal = document.getElementById('edit-nobet-modal');
    const id = document.getElementById('edit-nobet-id').value;
    const updatedData = {
        tarih: document.getElementById('edit-nobet-tarih').value,
        personelId: document.getElementById('edit-nobet-personel').value,
        nobetYeriId: document.getElementById('edit-nobet-yeri').value,
    };

    if (!updatedData.tarih || !updatedData.personelId || !updatedData.nobetYeriId) {
        return showToast('Lütfen tüm alanları doldurun.', 'error');
    }

    try {
        await setDoc(doc(db, 'nobetler', id), updatedData);
        showToast('Nöbet kaydı başarıyla güncellendi.');
        modal.classList.remove('open');
        // Raporu güncel haliyle yeniden çiz
        const year = parseInt(document.getElementById('rapor-yil-gir').value);
        const month = parseInt(document.getElementById('rapor-ay-sec').value);
        await renderNobetRaporu(year, month);
    } catch (error) {
        console.error("Nöbet güncellenirken hata:", error);
        showToast('Güncelleme sırasında bir hata oluştu.', 'error');
    }
}
// ==========================================================
// YERİNE EKLENECEK YENİ VE DOĞRU ÇALIŞAN FONKSİYON
// ==========================================================
async function copyNobetSchedule() {
    const sourceYear = parseInt(document.getElementById('copy-source-year').value);
    const sourceMonth = parseInt(document.getElementById('copy-source-month').value);
    const destYear = parseInt(document.getElementById('copy-dest-year').value);
    const destMonth = parseInt(document.getElementById('copy-dest-month').value);

    if (sourceYear === destYear && sourceMonth === destMonth) {
        return showToast('Kaynak ve hedef ay aynı olamaz.', 'error');
    }
    const kaynakAyAdi = document.getElementById('copy-source-month').options[sourceMonth].text;
    const hedefAyAdi = document.getElementById('copy-dest-month').options[destMonth].text;
    if (!confirm(`${kaynakAyAdi} ${sourceYear} ayındaki nöbet düzenini, ${hedefAyAdi} ${destYear} ayına kopyalamak istediğinizden emin misiniz?`)) {
        return;
    }
    
    showToast('Akıllı kopyalama işlemi başlatıldı...', 'info');

    // Adım 1: Kaynak aydaki nöbetleri çek ve hafta günlerine göre BENZERSİZ bir şablon oluştur.
    const sourceStartDate = new Date(Date.UTC(sourceYear, sourceMonth, 1)).toISOString().split('T')[0];
    const sourceEndDate = new Date(Date.UTC(sourceYear, sourceMonth + 1, 1)).toISOString().split('T')[0];
    const q = query(collection(db, 'nobetler'), where('tarih', '>=', sourceStartDate), where('tarih', '<', sourceEndDate));
    
    const nobetSnap = await getDocs(q);
    if (nobetSnap.empty) {
        return showToast('Kaynak ayda kopyalanacak nöbet kaydı bulunamadı.', 'error');
    }

    // rosterTemplate[1] -> Pazartesi görevlileri, rosterTemplate[5] -> Cuma görevlileri
    const rosterTemplate = { 1: new Set(), 2: new Set(), 3: new Set(), 4: new Set(), 5: new Set() };

    nobetSnap.forEach(doc => {
        const nobet = doc.data();
        // Saat dilimi sorunlarını önlemek için tarihi UTC olarak ele alıyoruz.
        const tarihUTC = new Date(nobet.tarih + 'T00:00:00Z');
        const dayOfWeek = tarihUTC.getUTCDay(); // 0=Pazar, 1=Pazartesi, ..., 6=Cumartesi

        // Sadece hafta içi (Pzt-Cuma) nöbetlerini dikkate al
        if (dayOfWeek >= 1 && dayOfWeek <= 5) {
            // Mükerrer kaydı önlemek için Set'e personel ve yer bilgisini ekle
            const dutyIdentifier = JSON.stringify({ p: nobet.personelId, y: nobet.nobetYeriId });
            rosterTemplate[dayOfWeek].add(dutyIdentifier);
        }
    });

    // Adım 2: Hedef aydaki tüm günleri gez ve şablonu uygula
    let kopyalananKayitSayisi = 0;
    const promises = [];
    const daysInDestMonth = new Date(destYear, destMonth + 1, 0).getDate();

    for (let day = 1; day <= daysInDestMonth; day++) {
        const hedefTarihUTC = new Date(Date.UTC(destYear, destMonth, day));
        const dayOfWeek = hedefTarihUTC.getUTCDay();

        // Eğer gün hafta sonuysa (Pazar veya Cumartesi) veya o güne ait şablon boşsa atla
        if (dayOfWeek === 0 || dayOfWeek === 6 || !rosterTemplate[dayOfWeek] || rosterTemplate[dayOfWeek].size === 0) {
            continue;
        }

        // Şablondaki her bir nöbetçiyi bu güne ata
        rosterTemplate[dayOfWeek].forEach(dutyJson => {
            const dutyInfo = JSON.parse(dutyJson);
            const yeniNobet = {
                personelId: dutyInfo.p,
                nobetYeriId: dutyInfo.y,
                tarih: hedefTarihUTC.toISOString().split('T')[0]
            };
            promises.push(addDoc(collection(db, 'nobetler'), yeniNobet));
            kopyalananKayitSayisi++;
        });
    }

    if (kopyalananKayitSayisi === 0) {
        return showToast('Kaynak aydaki nöbetlerle eşleşen, hedef ayda uygun bir gün bulunamadı.', 'info');
    }

    try {
        await Promise.all(promises);
        showToast(`${kopyalananKayitSayisi} nöbet kaydı başarıyla kopyalandı!`, 'success');
        // Raporu kopyalanan aya ayarla ve yenile
        document.getElementById('rapor-ay-sec').value = destMonth;
        document.getElementById('rapor-yil-gir').value = destYear;
        renderNobetRaporu(destYear, destMonth);
    } catch (error) {
        console.error("Kopyalama sırasında hata:", error);
        showToast('Nöbetler kopyalanırken bir hata oluştu.', 'error');
    }
}
async function openIzinEditModal(izinId) {
    const modal = document.getElementById('edit-izin-modal');
    const form = document.getElementById('edit-izin-form');
    
    try {
        const izinDoc = await getDoc(doc(db, 'izinler', izinId));
        if (!izinDoc.exists()) {
            showToast('Düzenlenecek izin kaydı bulunamadı.', 'error');
            return;
        }
        const izinData = izinDoc.data();

        // Formu doldur
        form.querySelector('#edit-izin-id').value = izinId;
        form.querySelector('#edit-izin-baslangic').value = izinData.baslangicTarihi;
        form.querySelector('#edit-izin-bitis').value = izinData.bitisTarihi;
        form.querySelector('#edit-izin-aciklama').value = izinData.aciklama || '';

        const personelSelect = form.querySelector('#edit-izin-personel');
        const izinTipiSelect = form.querySelector('#edit-izin-tipi');

        // Personel adını getir ve seçili yap (değiştirilemez)
        const personelDoc = await getDoc(doc(db, 'personel', izinData.personelId));
        personelSelect.innerHTML = `<option>${personelDoc.exists() ? personelDoc.data().ad_soyad : 'Bilinmeyen Personel'}</option>`;
        
        // İzin tiplerini doldur ve mevcut olanı seçili yap
        const izinTipiSnap = await getSettings('ayarlar_izin_tipleri');
        izinTipiSelect.innerHTML = '<option value="">İzin Tipi Seçiniz...</option>';
        izinTipiSnap.forEach(doc => izinTipiSelect.add(new Option(doc.data().name, doc.id)));
        izinTipiSelect.value = izinData.izinTipiId;

        modal.classList.add('open');
    } catch (error) {
        console.error("İzin düzenleme penceresi açılırken hata:", error);
        showToast('Veriler yüklenirken bir hata oluştu.', 'error');
    }
}
let izinTakipInitialized = false;
// MEVCUT initializeIzinTakip FONKSİYONUNU BU BLOK İLE KOMPLE DEĞİŞTİRİN
async function initializeIzinTakip() {
    if (izinTakipInitialized) return;
    izinTakipInitialized = true;

    const personelSelect = document.getElementById('izin-personel');
    const izinTipiSelect = document.getElementById('izin-tipi');
    const baslangicInput = document.getElementById('izin-baslangic');
    const bitisInput = document.getElementById('izin-bitis');
    const kaydetBtn = document.getElementById('izin-kaydet-btn');
    const tbody = document.getElementById('izin-kayitlari-tbody');
    const izinHakkiDiv = document.getElementById('personel-izin-hakki');
    const hesaplamaSonucuDiv = document.getElementById('izin-hesaplama-sonucu');

    const [personelSnap, izinTipiSnap] = await Promise.all([
        getDocs(query(collection(db, 'personel'), orderBy('ad_soyad'))),
        getSettings('ayarlar_izin_tipleri')
    ]);
    const staffListForLeave = personelSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    personelSelect.innerHTML = '<option value="">Personel Seçiniz...</option>';
    staffListForLeave.forEach(p => personelSelect.add(new Option(p.ad_soyad, p.id)));
    izinTipiSelect.innerHTML = '<option value="">İzin Tipi Seçiniz...</option>';
    izinTipiSnap.forEach(doc => izinTipiSelect.add(new Option(doc.data().name, doc.id)));

    function updateIzinHesaplamalari() {
        const personelId = personelSelect.value;
        const baslangicTarihi = baslangicInput.value;
        const bitisTarihi = bitisInput.value;
        const seciliPersonel = staffListForLeave.find(p => p.id === personelId);

        if (seciliPersonel) {
            const hakEdilenGun = calculateYillikIzinHakki(seciliPersonel.ise_giris);
            izinHakkiDiv.innerHTML = `Personelin yasal izin hakkı: <strong>${hakEdilenGun} iş günü</strong>`;
        } else {
            izinHakkiDiv.innerHTML = 'Yasal izin hakkı için personel seçiniz.';
        }

        if (baslangicTarihi && bitisTarihi && seciliPersonel) {
            if (new Date(bitisTarihi) < new Date(baslangicTarihi)) {
                hesaplamaSonucuDiv.style.color = 'var(--danger-color)';
                hesaplamaSonucuDiv.innerHTML = 'Bitiş tarihi başlangıçtan önce olamaz!';
                return;
            }
            // DEĞİŞİKLİK BURADA: Fonksiyona artık 'seciliPersonel' nesnesini de gönderiyoruz.
            const netGun = calculateNetIzinSuresi(baslangicTarihi, bitisTarihi, seciliPersonel);
            hesaplamaSonucuDiv.style.color = '#0056b3';
            hesaplamaSonucuDiv.innerHTML = `Kullanılacak net izin süresi: <strong>${netGun} iş günü</strong>`;
        } else {
            hesaplamaSonucuDiv.innerHTML = 'Net süre için personel ve tarih aralığı seçiniz.';
        }
    }

    personelSelect.addEventListener('change', updateIzinHesaplamalari);
    baslangicInput.addEventListener('change', updateIzinHesaplamalari);
    bitisInput.addEventListener('change', updateIzinHesaplamalari);
    
    await renderIzinKayitlari();

    kaydetBtn.addEventListener('click', async () => {
        const personelId = personelSelect.value;
        const izinTipiId = izinTipiSelect.value;
        const baslangicTarihi = baslangicInput.value;
        const bitisTarihi = bitisInput.value;
        const aciklama = document.getElementById('izin-aciklama').value.trim();

        if (!personelId || !izinTipiId || !baslangicTarihi || !bitisTarihi) {
            return showToast('Lütfen tüm zorunlu alanları doldurun.', 'error');
        }
        if (new Date(bitisTarihi) < new Date(baslangicTarihi)) {
            return showToast('Bitiş tarihi başlangıç tarihinden önce olamaz.', 'error');
        }
        
        await addDoc(collection(db, 'izinler'), { personelId, izinTipiId, baslangicTarihi, bitisTarihi, aciklama, olusturmaTuru: 'manuel' });
        showToast('İzin başarıyla kaydedildi.');
        await renderIzinKayitlari();
        
        personelSelect.value = '';
        izinTipiSelect.value = '';
        baslangicInput.value = '';
        bitisInput.value = '';
        document.getElementById('izin-aciklama').value = '';
        updateIzinHesaplamalari();
    });

    tbody.addEventListener('click', async (e) => {
        const target = e.target;
        if (!target.dataset.id) return;
        const id = target.dataset.id;
        
        // =======================================================
        // YENİ DÜZENLEME KODU BURADA OLMALI
        // =======================================================
        if (target.classList.contains('btn-edit-izin')) {
            openIzinEditModal(id);
        }
        // =======================================================

        // SİZİN PAYLAŞTIĞINIZ VE SİLİNMEYECEK OLAN "SİL" KODU
        if (target.classList.contains('btn-delete-izin')) {
            if (confirm('Bu izin kaydını kalıcı olarak silmek istediğinizden emin misiniz?')) {
                try {
                    await deleteDoc(doc(db, 'izinler', id));
                    showToast('İzin kaydı başarıyla silindi.');
                    await renderIzinKayitlari();
                } catch (err) {
                    showToast('Silme işlemi sırasında bir hata oluştu.', 'error');
                    console.error("İzin silme hatası:", err);
                }
            }
        }

        if (target.classList.contains('btn-print-dilekce')) {
            const modal = document.getElementById('dilekce-date-modal');
            const dateInput = document.getElementById('dilekce-tarih-input');
            const generateBtn = document.getElementById('generate-dilekce-with-date-btn');
            const closeModalBtn = modal.querySelector('.close-modal');

            dateInput.valueAsDate = new Date();
            generateBtn.dataset.izinId = id;

            modal.classList.add('open');

            const handleGenerateClick = async () => {
                const dilekceTarihi = dateInput.value;
                const izinIdForDilekce = generateBtn.dataset.izinId;
                if (!dilekceTarihi) {
                    showToast('Lütfen bir dilekçe tarihi seçin.', 'error');
                    return;
                }
                await generateDilekce(izinIdForDilekce, dilekceTarihi);
                modal.classList.remove('open');
            };

            generateBtn.addEventListener('click', handleGenerateClick, { once: true });

            closeModalBtn.onclick = () => {
                modal.classList.remove('open');
                generateBtn.removeEventListener('click', handleGenerateClick);
            };
        }
    });
}


const editForm = document.getElementById('edit-izin-form');
    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = editForm.querySelector('#edit-izin-id').value;
        const updatedData = {
            izinTipiId: editForm.querySelector('#edit-izin-tipi').value,
            baslangicTarihi: editForm.querySelector('#edit-izin-baslangic').value,
            bitisTarihi: editForm.querySelector('#edit-izin-bitis').value,
            aciklama: editForm.querySelector('#edit-izin-aciklama').value.trim()
        };

        if (!updatedData.izinTipiId || !updatedData.baslangicTarihi || !updatedData.bitisTarihi) {
            return showToast('Lütfen tüm zorunlu alanları doldurun.', 'error');
        }
        
        try {
            const izinRef = doc(db, 'izinler', id);
            await setDoc(izinRef, updatedData, { merge: true }); // merge:true ile personelId korunur
            showToast('İzin kaydı başarıyla güncellendi.');
            document.getElementById('edit-izin-modal').classList.remove('open');
            await renderIzinKayitlari();
        } catch (error) {
            console.error("İzin güncelleme hatası:", error);
            showToast('Güncelleme sırasında bir hata oluştu.', 'error');
        }
    });
    
    // Düzenleme penceresi kapatma butonları
    const editModal = document.getElementById('edit-izin-modal');
    editModal.querySelector('.close-modal').addEventListener('click', () => editModal.classList.remove('open'));
    editModal.addEventListener('click', (e) => {
        if (e.target === editModal) editModal.classList.remove('open');
    });

    

async function openTopluIzinModal() {
    const modal = document.getElementById('toplu-izin-modal');
    const personelListContainer = document.getElementById('toplu-personel-listesi');
    const izinTipiSelect = document.getElementById('toplu-izin-tipi');

    personelListContainer.innerHTML = '<p>Personel listesi yükleniyor...</p>';
    izinTipiSelect.innerHTML = '<option value="">Yükleniyor...</option>';

    try {
        const [personelSnap, izinTipiSnap] = await Promise.all([
            getDocs(query(collection(db, 'personel'), orderBy('ad_soyad'))),
            getSettings('ayarlar_izin_tipleri')
        ]);

        personelListContainer.innerHTML = '';
        if(personelSnap.empty) {
            personelListContainer.innerHTML = '<p>Sistemde kayıtlı personel bulunamadı.</p>';
        } else {
            personelSnap.forEach(doc => {
                const p = doc.data();
                const personelDiv = document.createElement('div');
                personelDiv.style.cssText = 'display: flex; align-items: center;';
                personelDiv.innerHTML = `
                    <input type="checkbox" id="p-check-${doc.id}" value="${doc.id}" style="width:auto; margin-right: 10px; flex-shrink: 0;">
                    <label for="p-check-${doc.id}" style="margin-bottom:0; font-weight: normal; cursor:pointer;">${p.ad_soyad}</label>
                `;
                personelListContainer.appendChild(personelDiv);
            });
        }

        izinTipiSelect.innerHTML = '<option value="">İzin Tipi Seçiniz...</option>';
        if(!izinTipiSnap.empty) {
                izinTipiSnap.forEach(doc => {
                izinTipiSelect.add(new Option(doc.data().name, doc.id));
            });
        }

        modal.classList.add('open');

    } catch (error) {
        console.error("Toplu izin modalı hazırlanırken hata:", error);
        showToast('Gerekli veriler yüklenemedi.', 'error');
    }
}

async function saveTopluIzin() {
    const baslangicTarihi = document.getElementById('toplu-izin-baslangic').value;
    const bitisTarihi = document.getElementById('toplu-izin-bitis').value;
    const izinTipiId = document.getElementById('toplu-izin-tipi').value;
    const personelCheckboxes = document.querySelectorAll('#toplu-personel-listesi input[type="checkbox"]:checked');

    if (!baslangicTarihi || !bitisTarihi || !izinTipiId) {
        return showToast('Lütfen başlangıç/bitiş tarihi ve izin tipi seçin.', 'error');
    }
    if (new Date(bitisTarihi) < new Date(baslangicTarihi)) {
        return showToast('Bitiş tarihi başlangıç tarihinden önce olamaz.', 'error');
    }
    if (personelCheckboxes.length === 0) {
        return showToast('Lütfen en az bir personel seçin.', 'error');
    }

    const seciliPersonelIDs = Array.from(personelCheckboxes).map(cb => cb.value);
    showToast(`${seciliPersonelIDs.length} personel için izinler kaydediliyor...`, 'info');

    const promises = seciliPersonelIDs.map(personelId => {
        const yeniIzin = {
            personelId: personelId,
            izinTipiId: izinTipiId,
            baslangicTarihi: baslangicTarihi,
            bitisTarihi: bitisTarihi,
            aciklama: 'Toplu olarak eklendi.',
            olusturmaTuru: 'toplu'
        };
        return addDoc(collection(db, 'izinler'), yeniIzin);
    });

    try {
        await Promise.all(promises);
        showToast(`${seciliPersonelIDs.length} personelin izin kaydı başarıyla oluşturuldu.`, 'success');
        document.getElementById('toplu-izin-modal').classList.remove('open');
        await renderIzinKayitlari();
    } catch (error) {
        console.error("Toplu izinler kaydedilirken hata:", error);
        showToast('Kayıt sırasında bir hata oluştu.', 'error');
    }
}

// BU İKİ YENİ FONKSİYONU EKLEYİN

/**
 * Personelin işe giriş tarihine göre yıllık ücretli izin hakkını hesaplar.
 * @param {string} iseGirisTarihi - Personelin 'YYYY-MM-DD' formatındaki işe giriş tarihi.
 * @returns {number} Hak edilen yıllık izin günü sayısı.
 */
function calculateYillikIzinHakki(iseGirisTarihi) {
    if (!iseGirisTarihi) return 0;
    const iseGiris = new Date(iseGirisTarihi);
    const bugun = new Date();
    const kidemMs = bugun.getTime() - iseGiris.getTime();
    const kidemYil = kidemMs / (1000 * 60 * 60 * 24 * 365.25);

    if (kidemYil >= 1 && kidemYil < 5) return 14;
    if (kidemYil >= 5 && kidemYil < 15) return 20;
    if (kidemYil >= 15) return 26;
    return 0; // 1 yıldan az kıdemi olanlar için
}

/**
/**
 * İki tarih arasındaki net iş günü sayısını personelin sözleşme türüne göre hesaplar.
 * Belirsiz Süreli için sadece Pazar, Belirli Süreli için Cmt/Paz tatil kabul edilir.
 * @param {string} startDateStr - Başlangıç tarihi 'YYYY-MM-DD'.
 * @param {string} endDateStr - Bitiş tarihi 'YYYY-MM-DD'.
 * @param {object} personel - Hakkında hesaplama yapılan personelin nesnesi. sozlesme_turu içermelidir.
 * @returns {number} Net izin günü sayısı.
 */
// BU YENİ FONKSİYONU EKLEYİN
function calculateNetIzinSuresi(startDateStr, endDateStr, personel, izinTipiKodu) {
    if (!startDateStr || !endDateStr || !personel) return 0;

    const startDate = new Date(startDateStr + 'T00:00:00');
    const endDate = new Date(endDateStr + 'T00:00:00');

    if (endDate < startDate) return 0;
    
    // YENİ KURAL: Eğer izin tipi Raporlu (R) veya Ücretsiz İzin (UI) ise,
    // hafta sonu/resmi tatil dinlemeden tüm takvim günlerini say.
    // Düzeltme: 'UI' kontrolü, 'Üİ' olarak güncellendi.
    if (izinTipiKodu === 'R' || izinTipiKodu === 'Üİ') {
        const diffTime = Math.abs(endDate - startDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        return diffDays;
    } 
    // Diğer tüm izin türleri için (Yıllık İzin vb.) eski iş günü hesaplama mantığı devam eder.
    else {
        let netGunSayisi = 0;
        let mevcutTarih = new Date(startDate);

        while (mevcutTarih <= endDate) {
            const dayOfWeek = mevcutTarih.getDay();
            let isWeekend = false;

            if (personel.sozlesme_turu === 'Belirli Süreli') {
                if (dayOfWeek === 0 || dayOfWeek === 6) isWeekend = true;
            } else {
                if (dayOfWeek === 0) isWeekend = true;
            }

            if (!isWeekend && !isResmiTatil(mevcutTarih)) {
                netGunSayisi++;
            }
            mevcutTarih.setDate(mevcutTarih.getDate() + 1);
        }
        return netGunSayisi;
    }
}
// BU FONKSİYONUN TAMAMINI YENİSİYLE DEĞİŞTİRİN
async function renderIzinKayitlari() {
    const tbody = document.getElementById('izin-kayitlari-tbody');
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">İzin kayıtları yükleniyor...</td></tr>`;

    const [izinSnap, personelSnap, izinTipiSnap] = await Promise.all([
        getDocs(query(collection(db, 'izinler'), orderBy('baslangicTarihi', 'desc'))),
        getDocs(collection(db, 'personel')),
        getSettings('ayarlar_izin_tipleri')
    ]);
    
    // GÜNCELLEME 1: Artık sadece izin adını değil, kodunu da içeren tüm veriyi saklıyoruz.
    const izinTipiDataMap = new Map(izinTipiSnap.docs.map(doc => [doc.id, doc.data()]));
    const personelDataMap = new Map(personelSnap.docs.map(doc => [doc.id, { id: doc.id, ...doc.data() }]));

    if (izinSnap.empty) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Kayıtlı izin bulunamadı.</td></tr>`;
        return;
    }

    tbody.innerHTML = '';
    izinSnap.forEach(doc => {
        const izin = doc.data();
        const personel = personelDataMap.get(izin.personelId);
        
        if (!personel) {
            console.warn(`ID'si ${doc.id} olan izin kaydına bağlı personel (${izin.personelId}) bulunamadı. Listede gösterilmeyecek.`);
            return;
        }

        const baslangic = new Date(izin.baslangicTarihi + 'T00:00:00');
        const bitis = new Date(izin.bitisTarihi + 'T00:00:00');
        
        // GÜNCELLEME 2: İzin tipinin kodunu haritadan alıyoruz.
        const izinTipi = izinTipiDataMap.get(izin.izinTipiId);
        const izinTipiKodu = izinTipi ? izinTipi.kod : '';
        // Süre hesaplanırken izin kodunu da gönderiyoruz.
        const sure = calculateNetIzinSuresi(izin.baslangicTarihi, izin.bitisTarihi, personel, izinTipiKodu);
        
        // GÜNCELLEME 3: İzin koduna göre doğru etiketi ("gün" veya "iş günü") seçiyoruz.
        const sureEtiketi = (izinTipiKodu === 'R' || izinTipiKodu === 'Üİ') ? 'gün' : 'iş günü';
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${personel.ad_soyad || 'Bilinmiyor'}</td>
            <td>${izinTipi ? izinTipi.name : 'Bilinmiyor'}</td>
            <td>${baslangic.toLocaleDateString('tr-TR')}</td>
            <td>${bitis.toLocaleDateString('tr-TR')}</td>
            <td>${sure} ${sureEtiketi}</td> <td>${izin.aciklama || '-'}</td>
            <td class="actions-cell">
    <td class="actions-cell">
    <button class="btn btn-print-dilekce" data-id="${doc.id}" style="background-color:#0dcaf0;">Dilekçe</button>
    <button class="btn btn-edit btn-edit-izin" data-id="${doc.id}">Düzenle</button>
    <button class="btn btn-delete-izin btn-delete" data-id="${doc.id}">Sil</button>
</td>
        `;
    });
}


async function generateDilekce(izinId, dilekceTarihiStr) {
    const izinDoc = await getDoc(doc(db, 'izinler', izinId));
    if (!izinDoc.exists()) {
        showToast('İzin kaydı bulunamadı.', 'error');
        return;
    }
    const izin = izinDoc.data();

    const [personelDoc, izinTipiDoc, gorevSnap] = await Promise.all([
        getDoc(doc(db, 'personel', izin.personelId)),
        getDoc(doc(db, 'ayarlar_izin_tipleri', izin.izinTipiId)),
        getSettings('ayarlar_gorevler')
    ]);

    if (!personelDoc.exists() || !izinTipiDoc.exists()) {
        showToast('Personel veya İzin Tipi tanımı bulunamadı.', 'error');
        return;
    }

    const personel = personelDoc.data();
    const izinTipi = izinTipiDoc.data();
    const gorevMap = new Map(gorevSnap.docs.map(doc => [doc.id, doc.data().name]));
    const iseBaslama = new Date(izin.bitisTarihi + 'T00:00:00');
    iseBaslama.setDate(iseBaslama.getDate() + 1);

    const baslangicTR = formatDateDDMMYYYY(izin.baslangicTarihi);
    const bitisTR = formatDateDDMMYYYY(izin.bitisTarihi);
    const iseBaslamaTR = iseBaslama.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const iseGirisTR = formatDateDDMMYYYY(personel.ise_giris);
    const dilekceTarihiTR = formatDateDDMMYYYY(dilekceTarihiStr);
    const gorevi = gorevMap.get(personel.gorevi_bransi) || 'Belirtilmemiş';
    const baslangicYili = new Date(izin.baslangicTarihi + 'T00:00:00').getFullYear();

    let izinIstekMetni = `Okulunuzdaki ${baslangicYili} yılına ait yıllık ücretli iznimi, ${baslangicTR} tarihinden itibaren kullanmak istiyorum.`;
    if (!izinTipi.name.toLowerCase().includes('yıllık')) {
        izinIstekMetni = `${izin.aciklama || 'Mazeretimden'} dolayı ${baslangicTR} - ${bitisTR} tarihleri arasında izinli sayılmamı talep ediyorum.`;
    }

    const dilekceHTML = `
        <!DOCTYPE html><html lang="tr"><head><meta charset="UTF-8"><title>İzin Formu - ${personel.ad_soyad}</title>
        <style>
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 11pt; margin: 1.0cm; line-height: 1.3; }
            h2, .header-section { text-align: center; }
            .info-table, .footer-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
            .info-table td { padding: 8px; border: 1px solid #ccc; }
            .info-table td:first-child { width: 180px; font-weight: bold; background-color: #f2f2f2; }
            .footer-table td { text-align: left; padding: 8px 4px; }
            .footer-table td:nth-child(2) { font-weight: bold; }
            .content { text-indent: 1.5em; margin-bottom: 25px; }
            .date-signature-block { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40px; }


.date-signature-block { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40px; }
.approval-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; text-align: center; }
        </style></head><body>
            <div>
                <h2>${izinTipi.name.toLocaleUpperCase('tr-TR')} İSTEK FORMU</h2>
                <div class="header-section"><h3>ÖZEL İSABET ORTAOKULU MÜDÜRLÜĞÜNE</h3></div>
                <p style="text-align:right;">TAVŞANLI</p>
                
                <table class="info-table">
                    <tr><td>ADI SOYADI</td><td>: ${personel.ad_soyad || ''}</td></tr>
                    <tr><td>T.C. KİMLİK NO</td><td>: ${personel.tc_kimlik_no || ''}</td></tr>
                    <tr><td>SGK NO</td><td>: ${personel.sgk_no || ''}</td></tr>
                    <tr><td>İŞE GİRİŞ TARİHİ</td><td>: ${iseGirisTR}</td></tr>
                    <tr><td>GÖREVİ</td><td>: ${gorevi}</td></tr>
                    <tr><td>GÖREV YERİ ADRESİ</td><td>: Hanımçeşme Mah. Gündüz Sokak No:13 TAVŞANLI/KÜTAHYA</td></tr>
                </table>

                <p class="content">${izinIstekMetni}</p>
                <p>Gereğini arz ederim.</p>

                <div class="date-signature-block">
                    <div><b>Tarih: ${dilekceTarihiTR}</b></div>
                    <div>
                        İzin Talep Eden<br><br>
                        ${personel.ad_soyad}<br>
                        (İmza)
                    </div>
                </div>

                <div class="approval-section">
                    <p>Yukarıda belirtilen tarihlerde ${izinTipi.name.toLowerCase()} kullanması uygundur.</p>
                    <div style="margin-top: 50px;">Okul Müdürü<br>(İmza)</div>
                </div>

                <h4 style="margin-top: 50px; margin-bottom: 15px; border-bottom: 1px solid #000; padding-bottom: 5px;">İzin Bölümünce Doldurulacak</h4>
                <table class="footer-table">
                    <tr>
                        <td>İzine Çıkış Tarihi</td><td>: ${baslangicTR}</td><td>İmza:</td>
                    </tr>
                    <tr>
                        <td>İzin Bitiş Tarihi</td><td>: ${bitisTR}</td><td>İmza:</td>
                    </tr>
                    <tr>
                        <td>İşe Başlama Tarihi</td><td>: ${iseBaslamaTR}</td><td>İmza:</td>
                    </tr>
                </table>
            </div>
        </body></html>`;

    const win = window.open('', '_blank');
    win.document.write(dilekceHTML);
    win.document.close();
    setTimeout(() => win.print(), 500);
}

// --- PUANTAJ CETVELİ YÖNETİMİ ---


/**
 * Verilen metni (isim, unvan vb.) boşluk karakterlerinden bölerek
 * HTML'de alt satıra geçmeyi sağlayan <br> etiketi ile birleştirir.
 * @param {string} text - Biçimlendirilecek metin.
 * @returns {string} HTML formatında alt alta yazılmış metin.
 */
function formatTextForWrapping(text) {
    if (!text) return '';
    return text.replace(/ /g, '<br>');
}

/**
 * Puantaj verilerini kullanarak HTML tablosunu oluşturur ve ekranda gösterir.
 * Her personel için iki ayrı satır (durum ve saat) oluşturur.
 * @param {object} nobetVerisi - Personellerin aylık nöbet saatlerini içeren nesne.
 */

// LÜTFEN MEVCUT ÜÇ FONKSİYONU SİLİP, YERİNE BU BLOĞUN TAMAMINI YAPIŞTIRIN

// --- 1. FONKSİYON: PUANTAJ DÜZENLEME PENCERESİ ---
// Bu fonksiyon, manuel düzenleme yaptığınızda açılan pencerenin doğru çalışmasını sağlar.
function initializePuantaj() {
    if (puantajInitialized) {
        loadPuantajDataForCurrentMonth();
        return;
    }

    try {
        const personelSnap = getDocs(collection(db, "personel"));
        const gorevSnap = getSettings('ayarlar_gorevler');
        const neviSnap = getSettings('ayarlar_personel_nevileri');

        Promise.all([personelSnap, gorevSnap, neviSnap]).then(async ([personelDocs, gorevDocs, neviDocs]) => {
            const gorevMap = new Map(gorevDocs.docs.map(doc => [doc.id, doc.data().name]));
            const neviMap = new Map(neviDocs.docs.map(doc => [doc.id, doc.data().name]));
            puantajPersonelList = personelDocs.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id, ad: data.ad_soyad || 'İsimsiz', unvan: gorevMap.get(data.gorevi_bransi) || 'Belirtilmemiş',
                    neviAdi: neviMap.get(data.personel_nevisi) || 'Bilinmiyor', maasKarsiligi: parseInt(data.maas_karsiligi) || 20,
                    rehberlik_gorevi: data.rehberlik_gorevi || 'hayir', esDurumu: data.es_durumu, cocuk0_6: data.cocuk_0_6,
                    cocuk6_18: data.cocuk_6_ustu, sozlesme_turu: data.sozlesme_turu || 'Belirsiz Süreli', ise_giris: data.ise_giris || '---',
                    isten_ayrilis: data.isten_ayrilis || '---', kismi_zamanli_calisma: data.kismi_zamanli_calisma || {}
                };
            });



                puantajPersonelList.sort((a, b) => a.ad.localeCompare(b.ad, 'tr'));
                const selectMonth = document.getElementById('select-month'),
                inputYear = document.getElementById('input-year'),
                showBtn = document.getElementById('btn-show-puantaj'),
                generateBtn = document.getElementById('btn-generate'),
                printBtn = document.getElementById('btn-print'),
                deleteBtn = document.getElementById('btn-delete-puantaj'),
                pdfBtn = document.getElementById('btn-pdf'),
                excelBtn = document.getElementById('btn-excel'),
                modalOverlay = document.getElementById('edit-modal-overlay'),
                modalSaveBtn = document.getElementById('modal-save'),
                modalCancelBtn = document.getElementById('modal-cancel'),
                savePuantajBtn = document.getElementById('btn-save-puantaj'),
                lockPuantajBtn = document.getElementById('btn-lock-puantaj');

            modalSaveBtn.addEventListener('click', saveModalChanges);
            modalCancelBtn.addEventListener('click', () => { modalOverlay.style.display = 'none'; });

            const now = new Date(), months = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            selectMonth.innerHTML = '';
            months.forEach((m, i) => selectMonth.add(new Option(m, i)));
            selectMonth.value = now.getMonth();
            inputYear.value = now.getFullYear();

            // NİHAİ DÜZELTME: "İzinli (Ücretli)" için kod artık noktalı büyük 'İ'.
            const statusCodes = { 'N': 'Normal', 'HT': 'Hafta Sonu', 'RT': 'Resmi Tatil', 'İ': 'İzinli (Ücretli)', 'R': 'Raporlu', 'UI': 'Ücretsiz İzin', 'S': 'Yıllık İzin', 'K': 'Yarım Gün Çalışma', 'Y': 'Yarım Gün Çalışma (Kısmi)', 'RTÇ': 'Resmi Tatil Çalışması', 'E': 'Eksik Gün' };
            const modalStatusSelect = document.getElementById('modal-status');
            modalStatusSelect.innerHTML = '';
            for(const code in statusCodes) modalStatusSelect.add(new Option(statusCodes[code], code));

            if(!puantajInitialized) {
                showBtn.addEventListener('click', loadPuantajDataForCurrentMonth); generateBtn.addEventListener('click', generateInitialPuantaj);
                document.getElementById('btn-generate-individual').addEventListener('click', generateIndividualPuantaj);
                deleteBtn.addEventListener('click', deleteCurrentPuantaj);
                deleteBtn.addEventListener('click', deleteCurrentPuantaj); savePuantajBtn.addEventListener('click', savePuantajData);
                lockPuantajBtn.addEventListener('click', togglePuantajLock); document.getElementById('btn-bulk-update').addEventListener('click', applyBulkUpdate);
                printBtn.addEventListener('click', printPuantaj); pdfBtn.addEventListener('click', downloadPdf); excelBtn.addEventListener('click', downloadExcel);
                selectMonth.addEventListener('change', loadPuantajDataForCurrentMonth); inputYear.addEventListener('change', loadPuantajDataForCurrentMonth);
                const bulkUpdateDaySelect = document.getElementById('bulk-update-day');
                const bulkUpdateStatusSelect = document.getElementById('bulk-update-status');
                const daysInMonth = new Date(inputYear.value, parseInt(selectMonth.value) + 1, 0).getDate();
                bulkUpdateDaySelect.innerHTML = '';
                for (let i = 1; i <= daysInMonth; i++) { bulkUpdateDaySelect.add(new Option(i, i)); }
                bulkUpdateStatusSelect.innerHTML = '';
                for(const code in statusCodes) { bulkUpdateStatusSelect.add(new Option(`${statusCodes[code]} (${code})`, code)); }
            }
            puantajInitialized = true;
const personelFilterSelect = document.getElementById('personel-filter-select');
        personelFilterSelect.innerHTML = '<option value="all">Tüm Personeli Göster</option>';
        puantajPersonelList.forEach(personel => {
            personelFilterSelect.add(new Option(personel.ad, personel.id));
        });

        // Filtrele ve Temizle butonlarına tıklama olaylarını ekler
        document.getElementById('btn-filter-personel').addEventListener('click', loadPuantajDataForCurrentMonth);
        document.getElementById('btn-clear-filter').addEventListener('click', () => {
            document.getElementById('personel-filter-select').value = 'all';
            loadPuantajDataForCurrentMonth();
        });
            await loadPuantajDataForCurrentMonth();
        });
    } catch (error) {
        console.error("Puantaj başlatılırken kritik hata:", error);
        showToast('Puantaj modülü başlatılamadı. Lütfen Ayarlarınızı kontrol edin.', 'error');
    }
}


// MEVCUT FONKSİYONU SİLİP, YERİNE BU YENİ VERSİYONU YAPIŞTIRIN
function calculateStatusCounts(personelId) {
    const personelData = puantajData[personelId];
    if (!personelData) return {};

    // DÜZELTME: Toplamlar artık 'Üİ' harflerine göre başlatılıyor.
    const counts = { N: 0, HT: 0, RT: 0, İ: 0, R: 0, Üİ: 0, S: 0, K: 0, RTÇ: 0 };
    
    for (const date in personelData) {
        let dayCode = personelData[date].code;

        // Tutarlılık için eski 'UI' kodunu 'Üİ' olarak kabul et
        if (dayCode === 'UI') {
            dayCode = 'Üİ';
        }
        // Tutarlılık için küçük 'üi' kodunu da 'Üİ' olarak kabul et
        if (dayCode === 'üi') {
            dayCode = 'Üİ';
        }

        // Noktalı büyük 'İ' için tutarlılık kontrolü
        if (dayCode === 'i' || dayCode === 'I') {
            dayCode = 'İ';
        }

        if (counts.hasOwnProperty(dayCode)) {
            counts[dayCode]++;
        }
    }
    return counts;
}

// =================================================================
// EKSİK GÜN KODU SEÇİM KUTUSU İÇİN ÖZEL GÖRÜNÜM FONKSİYONLARI
// =================================================================

// Seçim kutusunun görünümünü güncelleyen ana fonksiyon
function handleCustomSelectDisplay(selectElement) {
    if (!selectElement) return;

    // Önce tüm seçeneklerin metnini orijinal haline (Kod - Açıklama) döndür
    Array.from(selectElement.options).forEach(option => {
        if (option.value) { // Boş seçenek hariç
            const kodBilgisi = eksikGunKodlari.find(k => k.kod === option.value);
            if (kodBilgisi) {
                option.textContent = `${kodBilgisi.kod} - ${kodBilgisi.aciklama}`;
            }
        }
    });

    // Ardından, sadece seçili olan seçeneğin metnini sadece kod olarak ayarla
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    if (selectedOption && selectedOption.value) {
        selectedOption.textContent = selectedOption.value;
    }
}

// Tüm özel seçim kutularına olay dinleyicileri ekleyen ve ilk görünümü ayarlayan fonksiyon
function initializeCustomSelects() {
    const customSelects = document.querySelectorAll('.missing-day-code-select');
    customSelects.forEach(select => {
        // Sayfa yüklendiğinde mevcut seçili değeri doğru formatla göster
        handleCustomSelectDisplay(select);

        // Kutuyu açmadan hemen önce (focus) tüm açıklamaları tekrar göster
        select.addEventListener('focus', () => {
            Array.from(select.options).forEach(option => {
                if (option.value) {
                    const kodBilgisi = eksikGunKodlari.find(k => k.kod === option.value);
                    if (kodBilgisi) {
                        option.textContent = `${kodBilgisi.kod} - ${kodBilgisi.aciklama}`;
                    }
                }
            });
        });

        // Bir seçim yapıldığında veya kutudan çıkıldığında (change, blur) görünümü güncelle
        select.addEventListener('change', () => handleCustomSelectDisplay(select));
        select.addEventListener('blur', () => handleCustomSelectDisplay(select));
    });
}
function renderPuantajTable(nobetVerisi, aktifPersonelListesi, baslikMetni) {
    const container = document.getElementById('puantaj-table-container');
    const year = parseInt(document.getElementById('input-year').value);
    const month = parseInt(document.getElementById('select-month').value);

    let finalHTML = `<h2 id="puantaj-baslik" style="text-align: center; color: var(--theme-primary); margin-bottom: 25px;">${baslikMetni}</h2>`;

    if (!aktifPersonelListesi || aktifPersonelListesi.length === 0 || !puantajData) {
        container.innerHTML = `<div style="padding: 40px; text-align: center; background-color: #f8f9fa; border-radius: 8px;"><h4 style="color: var(--theme-primary);">Bu ay için görüntülenecek puantaj verisi veya aktif personel bulunmuyor.</h4></div>`;
        return;
    }

    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const gunler = ['Paz', 'Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt'];
    const grupluPersonel = {
        'Belirsiz Süreli': aktifPersonelListesi.filter(p => p.sozlesme_turu === 'Belirsiz Süreli'),
        'Belirli Süreli': aktifPersonelListesi.filter(p => p.sozlesme_turu === 'Belirli Süreli'),
        'Kısmi Süreli': aktifPersonelListesi.filter(p => p.sozlesme_turu === 'Kısmi Süreli')
    };
    
    for (const grupAdi in grupluPersonel) {
        const personelGrubu = grupluPersonel[grupAdi];
        if (personelGrubu.length === 0) continue;
        const ayAdi = document.getElementById('select-month').options[month].text;
        const yeniGrupBasligi = `${ayAdi} ${year} Ayı Personel Puantaj Kayıtları ( ${grupAdi.toLocaleUpperCase('tr-TR')} )`;
        finalHTML += `<h3 style="margin-top: 30px; padding: 10px; background-color: #343a40; color: white; border-radius: 5px;">${yeniGrupBasligi}</h3>`;
        
        // DEĞİŞİKLİK: Belirsiz Süreli grup için colspan 4'e çıkarıldı.
        let tableHTML = `<table class="puantaj-table"><thead><tr><th rowspan="2">Personel</th><th rowspan="2">Unvan</th><th rowspan="2" class="vertical-divider">İşe Giriş<br>İşten Çıkış</th><th colspan="${daysInMonth}">Aylık Puantaj Durumu</th><th colspan="${(grupAdi === 'Belirsiz Süreli') ? 4 : 4}" class="vertical-divider">Aylık Saat Toplamları</th><th colspan="9" class="vertical-divider">Aylık Gün Toplamları</th><th rowspan="2" class="vertical-divider">Sgk Prim Günü</th><th colspan="3">Sosyal Yardımlar</th><th rowspan="2">İmza</th></tr><tr>`;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dividerClass = (new Date(year, month, day).getDay() === 0 || day === daysInMonth) ? 'vertical-divider' : '';
            tableHTML += `<th class="col-day ${dividerClass}">${day}<br>${gunler[date.getDay()]}</th>`;
        }
        
        tableHTML += `<th>Aylık Toplam</th>${(grupAdi === 'Belirsiz Süreli') ? '<th>Fazla Mesai</th><th>Mesai Nedeni</th><th>E. G.<br>Kodu</th>' : `<th>Ek Ders</th><th>Nöbet</th><th class="vertical-divider">Rehberlik</th>`}<th>N</th><th>HT</th><th>RT</th><th>İ</th><th>R</th><th>Üİ</th><th>S</th><th>K</th><th class="vertical-divider">RTÇ</th><th>Eş Durumu</th><th>Çocuk 0-6</th><th>Çocuk 6-18</th></tr></thead><tbody>`;

        personelGrubu.forEach(personel => {
            const personelPuantajData = puantajData[personel.id];
            if (!personelPuantajData) { return; }
            let ayrilisTarihiGoster = '---';
            if (personel.isten_ayrilis) {
                const ayrilisDate = new Date(personel.isten_ayrilis + 'T00:00:00Z');
                if (ayrilisDate.getUTCFullYear() === year && ayrilisDate.getUTCMonth() === month) {
                    ayrilisTarihiGoster = formatDateDDMMYYYY(personel.isten_ayrilis);
                }
            }
            const monthlyHours = calculateMonthlyHours(personel.id);
            const nobetSaat = nobetVerisi[personel.id] || 0;
            const rehberlikSaat = calculateEffectiveRehberlikHours(personel.id, year, month, puantajData);
            const statusCounts = calculateStatusCounts(personel.id);
            let sgkPrimGunu = new Date(year, month + 1, 0).getDate() - ((statusCounts.R || 0) + (statusCounts.Üİ || 0));

            tableHTML += `<tr class="personel-row-status"><td class="col-personel" rowspan="2">${personel.ad}</td><td class="col-unvan" rowspan="2">${personel.unvan}</td><td class="col-date vertical-divider" rowspan="2">${formatDateDDMMYYYY(personel.ise_giris)}<br>${ayrilisTarihiGoster}</td>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = personelPuantajData[dateString] || { code: '', hours: 0 };
                const dividerClass = (new Date(year, month, day).getDay() === 0 || day === daysInMonth) ? 'vertical-divider' : '';
                tableHTML += `<td class="status-cell status-${dayData.code} ${dividerClass}" data-personel-id="${personel.id}" data-date="${dateString}">${dayData.code || ''}</td>`;
            }
            
           let eksikGunKoduSelect = '';
            if (grupAdi === 'Belirsiz Süreli') {
                let options = '<option value=""></option>'; // Varsayılan boş seçenek
                eksikGunKodlari.forEach(item => {
                    const selected = (missingDayCodes[personel.id] === item.kod) ? 'selected' : '';
                    // Listede hem kod hem de açıklama her zaman tam olarak oluşturulur
                    options += `<option value="${item.kod}" ${selected}>${item.kod} - ${item.aciklama}</option>`;
                });
                eksikGunKoduSelect = `<td rowspan="2" class="summary-missing-day"><select class="missing-day-code-select" data-personel-id="${personel.id}">${options}</select></td>`;
            }
            const fazlaMesaiSaat = (grupAdi === 'Belirsiz Süreli') ? calculateFazlaMesai(personel.id) : 0;
            const mesaiNedeniInput = `<td rowspan="2" class="summary-reason"><input type="text" class="overtime-reason-input" data-personel-id="${personel.id}" value="${overtimeReasons[personel.id] || ''}"></td>`;
            
            tableHTML += `<td class="summary-yellow" rowspan="2">${monthlyHours.genelToplam}</td>${(grupAdi === 'Belirsiz Süreli') ? `<td class="summary-overtime" rowspan="2">${fazlaMesaiSaat}</td>${mesaiNedeniInput}${eksikGunKoduSelect}` : `<td class="summary-green" rowspan="2">${monthlyHours.ekDers}</td><td class="summary-nobet" rowspan="2">${nobetSaat}</td><td class="summary-rehberlik vertical-divider" rowspan="2">${rehberlikSaat}</td>`}<td class="col-summary-count" rowspan="2">${statusCounts.N || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.HT || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.RT || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.İ || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.R || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.Üİ || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.S || 0}</td><td class="col-summary-count" rowspan="2">${statusCounts.K || 0}</td><td class="col-summary-count vertical-divider" rowspan="2">${statusCounts.RTÇ || 0}</td><td class="total-worked-day vertical-divider" rowspan="2">${sgkPrimGunu}</td><td class="social-section" rowspan="2">${personel.esDurumu === 'calismiyor' ? 'Çalışmıyor' : 'Bekar'}</td><td class="social-section" rowspan="2">${personel.cocuk0_6 || ''}</td><td class="social-section" rowspan="2">${personel.cocuk6_18 || ''}</td><td class="col-imza" rowspan="2"></td></tr>`;
            
            tableHTML += `<tr class="personel-row-hours horizontal-divider">`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = personelPuantajData[dateString] || { code: '', hours: 0 };
                const dividerClass = (new Date(year, month, day).getDay() === 0 || day === daysInMonth) ? 'vertical-divider' : '';
                // EKLENECEK YENİ SATIR
                const hourContent = (dayData?.code === 'N' || dayData?.code === 'RTÇ' || dayData?.code === 'Y' || dayData?.code === 'K') && dayData?.hours > 0 ? dayData.hours : '';
                tableHTML += `<td class="hour-cell ${dividerClass}">${hourContent}</td>`;
            }
            tableHTML += `</tr>`;
        });
        tableHTML += `</tbody></table>`;
        finalHTML += tableHTML;
    }
    
    container.innerHTML = finalHTML;
    attachCellListeners();
    initializeCustomSelects();
}

// =================================================================
// EKLEME İŞLEMİ BURADA BİTİYOR
// =================================================================
let puantajInitialized = false;
let puantajPersonelList = [];
let puantajData = {};
let overtimeReasons = {}; // Fazla mesai nedenlerini tutacak nesne
let missingDayCodes = {}; // Eksik gün kodlarını tutacak nesne

// YENİ EKLENEN DEĞİŞKENLER
let isPuantajLocked = false; 
let currentPuantajDocRef = null;
// =================== 1. ADIM: EKSİK FONKSİYONLARI BURAYA EKLEYİN ===================

// MEVCUT HATALI FONKSİYONU SİLİP, YERİNE BU DOĞRU VERSİYONU YAPIŞTIRIN

async function loadPuantajDataForCurrentMonth() {
    const year = document.getElementById('input-year').value;
    const month = document.getElementById('select-month').value;
    const docId = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}`;
    currentPuantajDocRef = doc(db, "kayitli_puantajlar", docId);
    try {
        const ayAdi = document.getElementById('select-month').options[month].text;
        const baslikMetni = `ÖZEL İSABET ORTAOKULU ${year} YILI ${ayAdi.toLocaleUpperCase('tr-TR')} AYI PERSONEL PUANTAJ CETVELİ`;

        const docSnap = await getDoc(currentPuantajDocRef);
       if (docSnap.exists()) {
            const data = docSnap.data();
            puantajData = data.puantajData || {};
            overtimeReasons = data.overtimeReasons || {}; 
            missingDayCodes = data.missingDayCodes || {}; // Eksik gün kodlarını yükle
            isPuantajLocked = data.isLocked || false;
            showToast('Kaydedilmiş puantaj verisi yüklendi.', 'success');
        } else {
            puantajData = {};
            overtimeReasons = {}; 
            missingDayCodes = {}; // Puantaj yoksa kodları da sıfırla
            isPuantajLocked = false;
            showToast('Bu ay için kaydedilmiş bir puantaj yok.', 'info');
        }
        updateLockStatusUI();

        // === BAŞLANGIÇ: DOĞRU FİLTRELEME MANTIĞI ===
    const ayinIlkGunu = new Date(Date.UTC(year, month, 1));
    const ayinSonGunu = new Date(Date.UTC(year, month + 1, 0));

    const aktifPersonelList = puantajPersonelList.filter(personel => {
        const girisStr = personel.ise_giris;
        const ayrilisStr = personel.isten_ayrilis;

        // İşe giriş tarihi yoksa veya geçersizse personeli gösterme.
        if (!girisStr) return false;
        const girisDate = new Date(girisStr + 'T00:00:00Z');
        if (isNaN(girisDate.getTime())) return false;

        // Kural 1: İşe giriş tarihi, baktığımız ayın son gününden sonra olamaz.
        const iseBaslamisMi = girisDate <= ayinSonGunu;

        // Kural 2: İşten ayrılış tarihi, baktığımız ayın ilk gününden önce olamaz.
        let istenAyrilmamisMi = true; // Varsayılan olarak true
        if (ayrilisStr && ayrilisStr.trim() !== '' && ayrilisStr.trim() !== '---') {
            const ayrilisDate = new Date(ayrilisStr + 'T00:00:00Z');
            if (!isNaN(ayrilisDate.getTime())) {
                istenAyrilmamisMi = ayrilisDate >= ayinIlkGunu;
            }
        }

        // Personel, ancak her iki kuralı da sağlıyorsa o ayın listesinde yer alabilir.
        return iseBaslamisMi && istenAyrilmamisMi;
    });
    // === BİTİŞ: DOĞRU FİLTRELEME MANTIĞI ===

        // =======================================================
        // FİLTRELEME MANTIĞI BURADA UYGULANIYOR
        // =======================================================
        const selectedPersonelId = document.getElementById('personel-filter-select').value;
        let displayList = aktifPersonelList; // Varsayılan olarak tüm aktif personel listesi atanıyor

        if (selectedPersonelId && selectedPersonelId !== 'all') {
            // Eğer belirli bir personel seçilmişse, 'displayList' filtrelenmiş sonuçla güncelleniyor
            displayList = aktifPersonelList.filter(p => p.id === selectedPersonelId);
        }
        // =======================================================

        const nobetVerisi = await fetchAndCalculateNobetData(year, parseInt(month));
        
        // DEĞİŞİKLİK BURADA: Tablo, filtrelenmiş olan 'displayList' ile çiziliyor.
        renderPuantajTable(nobetVerisi, displayList, baslikMetni);
        
        renderGrandTotals(nobetVerisi, displayList);
        renderLegend();
        attachCellListeners();
    } catch (error) {
        console.error("Puantaj verisi yüklenirken hata: ", error);
        showToast("Puantaj verisi yüklenemedi.", "error");
    }
}

async function savePuantajData() {
    if (isPuantajLocked) {
        showToast('Puantaj kilitli olduğu için kaydedilemez.', 'error');
        return;
    }
    if (Object.keys(puantajData).length === 0) {
        showToast('Kaydedilecek puantaj verisi bulunmuyor.', 'error');
        return;
    }

    // YENİ EKLENEN KONTROL BLOĞU BAŞLANGICI
    // Eğer döküman referansı henüz oluşturulmadıysa (örneğin yeni puantaj sonrası),
    // o anki ay ve yıla göre referansı burada oluştur.
    if (!currentPuantajDocRef) {
        const year = document.getElementById('input-year').value;
        const month = document.getElementById('select-month').value;
        const docId = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}`;
        currentPuantajDocRef = doc(db, "kayitli_puantajlar", docId);
    }
    // YENİ EKLENEN KONTROL BLOĞU BİTİŞİ

    // Mesai nedenlerini topla
    const newOvertimeReasons = {};
    document.querySelectorAll('.overtime-reason-input').forEach(input => {
        if (input.value.trim() !== '') {
            newOvertimeReasons[input.dataset.personelId] = input.value.trim();
        }
    });
    overtimeReasons = newOvertimeReasons;

    // Eksik gün kodlarını topla
    const newMissingDayCodes = {};
    document.querySelectorAll('.missing-day-code-select').forEach(select => {
        if (select.value) {
            newMissingDayCodes[select.dataset.personelId] = select.value;
        }
    });
    missingDayCodes = newMissingDayCodes;

    try {
        // Artık currentPuantajDocRef'in null olmama garantisi var.
        await setDoc(currentPuantajDocRef, {
            puantajData: puantajData,
            isLocked: isPuantajLocked,
            overtimeReasons: overtimeReasons,
            missingDayCodes: missingDayCodes
        }, { merge: true });
        showToast('Puantaj başarıyla kaydedildi!', 'success');
    } catch (error) {
        console.error("Puantaj kaydedilirken hata: ", error);
        showToast('Puantaj kaydedilemedi.', 'error');
    }
}
async function togglePuantajLock() {
    isPuantajLocked = !isPuantajLocked; // Kilit durumunu tersine çevir

    try {
        if (!currentPuantajDocRef) {
             const year = document.getElementById('input-year').value;
             const month = document.getElementById('select-month').value;
             const docId = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}`;
             currentPuantajDocRef = doc(db, "kayitli_puantajlar", docId);
        }
        await setDoc(currentPuantajDocRef, { isLocked: isPuantajLocked }, { merge: true });
        showToast(isPuantajLocked ? 'Puantaj kilitlendi.' : 'Puantaj kilidi açıldı.', 'success');
        updateLockStatusUI();
    } catch (error) {
        console.error("Kilit durumu güncellenirken hata:", error);
        showToast("Kilit durumu güncellenemedi.", "error");
        isPuantajLocked = !isPuantajLocked; // Hata olursa durumu geri al
    }
}

// YENİ EKLENEN SİLME FONKSİYONU
async function deleteCurrentPuantaj() {
    if (isPuantajLocked) {
        showToast('Puantaj kilitli. Silmek için önce kilidi açmalısınız.', 'error');
        return;
    }

    if (!currentPuantajDocRef) {
        showToast('Bu ay için silinecek kayıtlı bir puantaj bulunmuyor.', 'error');
        return;
    }

    const year = document.getElementById('input-year').value;
    const monthName = document.getElementById('select-month').options[document.getElementById('select-month').selectedIndex].text;

    if (!confirm(`${monthName} ${year} ayına ait puantaj cetvelini kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`)) {
        return;
    }

    try {
        await deleteDoc(currentPuantajDocRef);

        // Lokal verileri ve arayüzü temizle
        puantajData = {};
        isPuantajLocked = false;
        currentPuantajDocRef = null;

        updateLockStatusUI();
        renderPuantajTable({}); // Tabloyu boşaltarak "veri yok" mesajını göster
        renderGrandTotals({}, []); // Genel toplamları sıfırla

        showToast('Puantaj başarıyla silindi.', 'success');

    } catch (error) {
        console.error("Puantaj silinirken hata:", error);
        showToast('Puantaj silinirken bir hata oluştu.', 'error');
    }
}

// YENİ FONKSİYON: Kilit butonunun metnini ve rengini günceller.
function updateLockStatusUI() {
    const lockBtn = document.getElementById('btn-lock-puantaj');
    const generateBtn = document.getElementById('btn-generate');

    if (isPuantajLocked) {
        lockBtn.textContent = 'Kilidi Aç';
        lockBtn.style.backgroundColor = '#17a2b8';
        generateBtn.disabled = true;
    } else {
        lockBtn.textContent = 'Puantajı Kilitle';
        lockBtn.style.backgroundColor = '#fd7e14';
        generateBtn.disabled = false;
    }
}


// MEVCUT fetchIzinDataForPuantaj FONKSİYONUNU SİLİP, BU NİHAİ VERSİYONU YAPIŞTIRIN
// === BAŞLANGIÇ: MEVCUT FONKSİYONU BU BLOK İLE DEĞİŞTİRİN ===
async function fetchIzinDataForPuantaj(year, month) {
    const ayinIlkGunu = new Date(year, month, 1);
    const ayinSonGunu = new Date(year, month + 1, 0);
    const ayinSonGunuStr = ayinSonGunu.toISOString().split('T')[0];

    const q = query(collection(db, 'izinler'), where('baslangicTarihi', '<=', ayinSonGunuStr));

    const [izinSnap, izinTipiSnap] = await Promise.all([getDocs(q), getSettings('ayarlar_izin_tipleri')]);
    const izinTipiKodMap = new Map(izinTipiSnap.docs.map(doc => [doc.id, doc.data().kod]));
    const izinVerisi = {};

    izinSnap.forEach(doc => {
        const izin = doc.data();
        const personelId = izin.personelId;

        if (!izin.baslangicTarihi || !izin.bitisTarihi) {
            console.error(`HATA: ID'si ${doc.id} olan izin kaydında tarih eksik.`, izin);
            return;
        }

        // --- SAAT DİLİMİ SORUNUNU ÇÖZEN DEĞİŞİKLİK ---
        // Tarihleri yerel saat yerine UTC (Evrensel Saat) olarak oluşturuyoruz.
        // 'T00:00:00Z' ifadesi, saati UTC'ye göre gece yarısı olarak ayarlar.
        const baslangicTarihiUTC = new Date(izin.baslangicTarihi + 'T00:00:00Z');
        const bitisTarihiUTC = new Date(izin.bitisTarihi + 'T00:00:00Z');

        if (isNaN(baslangicTarihiUTC.getTime()) || isNaN(bitisTarihiUTC.getTime())) {
            console.error(`HATA: ID'si ${doc.id} olan izin kaydındaki tarih formatı geçersiz.`, izin);
            return;
        }

        // bitisTarihiUTC, ayın ilk gününden sonraysa veya eşitse işleme devam et
        if (bitisTarihiUTC >= ayinIlkGunu) {
            if (!izinVerisi[personelId]) {
                izinVerisi[personelId] = {};
            }
            const izinKodu = izinTipiKodMap.get(izin.izinTipiId) || 'I';

            // Döngüyü UTC tarihleri üzerinden kuruyoruz.
            let d = new Date(baslangicTarihiUTC);
            while (d <= bitisTarihiUTC) {
                // Sadece ilgili aydaki günleri işle (yıl ve ay kontrolü UTC'ye göre yapılır)
                if (d.getUTCFullYear() === year && d.getUTCMonth() === month) {
                    // Tarih dizesini de UTC'ye göre oluşturup 'Z'yi kaldırıyoruz.
                    const dateString = d.toISOString().split('T')[0];
                    izinVerisi[personelId][dateString] = izinKodu;
                }
                // Bir sonraki güne geçerken de UTC metodunu kullanıyoruz.
                d.setUTCDate(d.getUTCDate() + 1);
            }
        }
    });
    return izinVerisi;
}
// === BİTİŞ: DEĞİŞTİRME İŞLEMİ BURADA BİTER ===
async function fetchAndCalculateNobetData(year, month) {
    const startDate = new Date(year, month, 1).toISOString().split('T')[0];
    const endDate = new Date(year, month + 1, 1).toISOString().split('T')[0];
    const q = query(collection(db, 'nobetler'), where('tarih', '>=', startDate), where('tarih', '<', endDate));
    const nobetSnap = await getDocs(q);
    const nobetHaftalari = {};
    const getWeekNumber = (d) => { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); };
    nobetSnap.forEach(doc => {
        const nobet = doc.data(); const tarih = new Date(nobet.tarih + 'T00:00:00'); const haftaNo = getWeekNumber(tarih);
        if (!nobetHaftalari[nobet.personelId]) nobetHaftalari[nobet.personelId] = new Set();
        nobetHaftalari[nobet.personelId].add(haftaNo);
    });
    const nobetEkDers = {};
    for (const personelId in nobetHaftalari) { nobetEkDers[personelId] = nobetHaftalari[personelId].size * 3; }
    return nobetEkDers;
}

async function fetchAndProcessSchedules() {
    const scheduleData = {}; // Sonuç: { personelId: { 'Pazartesi': 5, 'Sali': 4 ... } }

    try {
        const [scheduleSnap, personelSnap] = await Promise.all([
            getDocs(collection(db, "ders_programlari")),
            getDocs(collection(db, "personel"))
        ]);

        // EĞER HİÇ DERS PROGRAMI YOKSA UYARI VER VE BOŞ DÖN
        if (scheduleSnap.empty) {
            console.warn("UYARI: Firestore 'ders_programlari' koleksiyonunda hiç veri bulunamadı. Saatler 0 olarak hesaplanacak.");
            return {};
        }

        // Personel adından ID'ye bir harita oluşturuyoruz.
        const personelAdindanIdMap = new Map();
        personelSnap.forEach(doc => {
            personelAdindanIdMap.set(doc.data().ad_soyad, doc.id);
        });

        // Tüm ders programlarını gez
        scheduleSnap.forEach(doc => {
            const program = doc.data();
            for (const gun in program) {
                const gununDersleri = program[gun];
                for (const saat in gununDersleri) {
                    const dersDetayi = gununDersleri[saat];
                    if (!dersDetayi || !dersDetayi.ogretmen) continue; // Ders detayı veya öğretmen yoksa atla

                    const personelAdi = dersDetayi.ogretmen;
                    const personelId = personelAdindanIdMap.get(personelAdi);

                    // --- EN ÖNEMLİ GÜNCELLEME BURADA ---
                    // Eğer öğretmen adı personel listesinde bulunduysa işlem yap. Bulunmadıysa hata vermeden atla.
                    if (personelId) {
                        if (!scheduleData[personelId]) {
                            scheduleData[personelId] = {};
                        }
                        if (!scheduleData[personelId][gun]) {
                            scheduleData[personelId][gun] = 0;
                        }
                        scheduleData[personelId][gun]++;
                    } else {
                        // Eşleşmeyen öğretmeni konsola yazdır, bu sayede hatayı kolayca bulabilirsiniz.
                        console.warn(`DİKKAT: Ders programındaki "${personelAdi}" isimli öğretmen, personel listesinde bulunamadı. Bu ders saati puantaja eklenmeyecek.`);
                    }
                }
            }
        });
        
        return scheduleData;

    } catch (error) {
        console.error("Ders programları işlenirken kritik bir hata oluştu:", error);
        showToast("Ders programı verisi okunamadı! Konsolu kontrol edin.", "error");
        return {};
    }
}
    async function generateInitialPuantaj() {
    if (isPuantajLocked) {
        showToast('Puantaj kilitli...', 'error');
        return;
    }
    if (!confirm('Yeni bir puantaj oluşturulacak. Emin misiniz?')) {
        return;
    }
    try {
        const year = parseInt(document.getElementById('input-year').value);
        const month = parseInt(document.getElementById('select-month').value);
        showToast('Puantaj oluşturuluyor...');

        const ayAdi = document.getElementById('select-month').options[month].text;
        const baslikMetni = `ÖZEL İSABET ORTAOKULU ${year} YILI ${ayAdi.toLocaleUpperCase('tr-TR')} AYI PERSONEL PUANTAJ CETVELİ`;
        
        // === BAŞLANGIÇ: DOĞRU FİLTRELEME MANTIĞI ===
    const ayinIlkGunu = new Date(Date.UTC(year, month, 1));
    const ayinSonGunu = new Date(Date.UTC(year, month + 1, 0));

    let aktifPersonelList = puantajPersonelList.filter(personel => {
        const girisStr = personel.ise_giris;
        const ayrilisStr = personel.isten_ayrilis;

        // İşe giriş tarihi yoksa veya geçersizse personeli gösterme.
        if (!girisStr) return false;
        const girisDate = new Date(girisStr + 'T00:00:00Z');
        if (isNaN(girisDate.getTime())) return false;

        // Kural 1: İşe giriş tarihi, baktığımız ayın son gününden sonra olamaz.
        const iseBaslamisMi = girisDate <= ayinSonGunu;

        // Kural 2: İşten ayrılış tarihi, baktığımız ayın ilk gününden önce olamaz.
        let istenAyrilmamisMi = true; // Varsayılan olarak true
        if (ayrilisStr && ayrilisStr.trim() !== '' && ayrilisStr.trim() !== '---') {
            const ayrilisDate = new Date(ayrilisStr + 'T00:00:00Z');
            if (!isNaN(ayrilisDate.getTime())) {
                istenAyrilmamisMi = ayrilisDate >= ayinIlkGunu;
            }
        }

        // Personel, ancak her iki kuralı da sağlıyorsa o ayın listesinde yer alabilir.
        return iseBaslamisMi && istenAyrilmamisMi;
    });
    // === BİTİŞ: DOĞRU FİLTRELEME MANTIĞI ===

        const selectedPersonelId = document.getElementById('personel-filter-select').value;
        if (selectedPersonelId !== 'all') {
            aktifPersonelList = aktifPersonelList.filter(p => p.id === selectedPersonelId);
        }
        
        const [scheduleData, nobetVerisi, izinVerisi] = await Promise.all([
            fetchAndProcessSchedules(),
            fetchAndCalculateNobetData(year, month),
            fetchIzinDataForPuantaj(year, month)
        ]);
        const gunlerTR = ["Pazar", "Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi"];
        puantajData = {};

        aktifPersonelList.forEach(personel => {
            puantajData[personel.id] = {};
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateUTC = new Date(Date.UTC(year, month, day));
                const dateString = dateUTC.toISOString().split('T')[0];
                let code = '', hours = 0;
                if (personel.isten_ayrilis) {
                    const ayrilisTarihiUTC = new Date(personel.isten_ayrilis + 'T00:00:00Z');
                    if (dateUTC > ayrilisTarihiUTC) {
                        puantajData[personel.id][dateString] = { code: '', hours: 0, notes: '' };
                        continue;
                    }
                }
                const leaveCodeForDay = izinVerisi[personel.id]?.[dateString];
                const dayOfWeek = dateUTC.getDay();
                const dayOfWeekTR = gunlerTR[dayOfWeek];
                if (leaveCodeForDay && (leaveCodeForDay === 'R' || leaveCodeForDay === 'Üİ')) {
                    code = leaveCodeForDay;
                }
                if (code === '') {
                    if (personel.sozlesme_turu === 'Kısmi Süreli') {
                        if (isResmiTatil(dateUTC)) { code = 'E'; } 
                        else {
                            const scheduledHours = parseInt(personel.kismi_zamanli_calisma?.[dayOfWeekTR] || scheduleData[personel.id]?.[dayOfWeekTR] || 0);
                            code = (scheduledHours > 0) ? 'Y' : 'E';
                            hours = scheduledHours;
                        }
                    } else {
                        if (isResmiTatil(dateUTC)) { code = 'RT'; } 
                        else {
                            let isWeekend = (personel.sozlesme_turu === 'Belirli Süreli') ? (dayOfWeek === 6 || dayOfWeek === 0) : (dayOfWeek === 0);
                            if (isWeekend) { code = 'HT'; } 
                            else {
                                code = 'N';
                                // *** YENİ KONTROL: "Rehberlik" kelimesi de eklendi ***
                                if (personel.unvan && (personel.unvan.includes('Okul Müdürü') || personel.unvan.includes('Rehber Öğretmen') || personel.unvan.includes('Rehberlik'))) {
                                    hours = 4;
                                } else {
                                    hours = (personel.sozlesme_turu === 'Belirsiz Süreli') ? 7.5 : (scheduleData[personel.id]?.[dayOfWeekTR] || 0);
                                }
                            }
                        }
                    }
                    if (leaveCodeForDay && (code === 'N' || code === 'Y')) {
                         code = leaveCodeForDay;
                         hours = 0;
                    }
                }
                puantajData[personel.id][dateString] = { code, hours, notes: '' };
            }
        });

        renderPuantajTable(nobetVerisi, aktifPersonelList, baslikMetni);
        renderGrandTotals(nobetVerisi);
        renderLegend();
        attachCellListeners();
        showToast('Puantaj başarıyla oluşturuldu!', 'success');
    } catch (error) {
        console.error("Puantaj oluşturulurken hata:", error);
        showToast('Puantaj oluşturulamadı.', 'error');
    }
}
// =================================================================
// YENİ EKLENEN BİREYSEL PUANTAJ HAZIRLAMA FONKSİYONU
// =================================================================
async function generateIndividualPuantaj() {
    const selectedPersonelId = document.getElementById('personel-filter-select').value;

    // 1. Adım: Listeden bir personel seçilip seçilmediğini kontrol et
    if (!selectedPersonelId || selectedPersonelId === 'all') {
        showToast('Lütfen önce listeden bir personel seçin.', 'error');
        return;
    }

    const personel = puantajPersonelList.find(p => p.id === selectedPersonelId);
    if (!personel) {
        showToast('Seçilen personel verisi bulunamadı.', 'error');
        return;
    }

    if (!confirm(`'${personel.ad}' için puantaj yeniden hazırlanacak. Bu personelin mevcut puantaj verileri sıfırlanacaktır. Devam etmek istiyor musunuz?`)) {
        return;
    }

    try {
        const year = parseInt(document.getElementById('input-year').value);
        const month = parseInt(document.getElementById('select-month').value);
        showToast(`'${personel.ad}' için puantaj hazırlanıyor...`);

        // 2. Adım: Puantajı oluşturmak için gerekli verileri (izinler, ders programı vb.) çek
        const [scheduleData, izinVerisi] = await Promise.all([
            fetchAndProcessSchedules(),
            fetchIzinDataForPuantaj(year, month)
        ]);
        const gunlerTR = ["Pazar", "Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi"];
        
        const individualPuantajData = {}; // Sadece bu personel için geçici veri nesnesi
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // 3. Adım: Seçili personel için ayın her gününü gezerek puantaj verisi oluştur
        for (let day = 1; day <= daysInMonth; day++) {
            const dateUTC = new Date(Date.UTC(year, month, day));
            const dateString = dateUTC.toISOString().split('T')[0];
            let code = '', hours = 0;

            // Personel işten ayrıldıysa, ayrılış tarihinden sonraki günleri boş bırak
            if (personel.isten_ayrilis && personel.isten_ayrilis !== '---') {
                const ayrilisTarihiUTC = new Date(personel.isten_ayrilis + 'T00:00:00Z');
                if (dateUTC > ayrilisTarihiUTC) {
                    individualPuantajData[dateString] = { code: '', hours: 0, notes: '' };
                    continue;
                }
            }

            // Standart puantaj oluşturma mantığını uygula (izin, tatil, normal gün vb.)
            const leaveCodeForDay = izinVerisi[personel.id]?.[dateString];
            const dayOfWeek = dateUTC.getDay();
            const dayOfWeekTR = gunlerTR[dayOfWeek];

            if (leaveCodeForDay && (leaveCodeForDay === 'R' || leaveCodeForDay === 'Üİ')) {
                code = leaveCodeForDay;
            }

            if (code === '') {
                if (personel.sozlesme_turu === 'Kısmi Süreli') {
                    if (isResmiTatil(dateUTC)) { code = 'E'; } 
                    else {
                        const scheduledHours = parseInt(personel.kismi_zamanli_calisma?.[dayOfWeekTR] || scheduleData[personel.id]?.[dayOfWeekTR] || 0);
                        code = (scheduledHours > 0) ? 'Y' : 'E';
                        hours = scheduledHours;
                    }
                } else { // Belirli ve Belirsiz Süreli
                    if (isResmiTatil(dateUTC)) { code = 'RT'; } 
                    else {
                        let isWeekend = (personel.sozlesme_turu === 'Belirli Süreli') ? (dayOfWeek === 6 || dayOfWeek === 0) : (dayOfWeek === 0);
                        if (isWeekend) { code = 'HT'; } 
                        else {
                            code = 'N';
                            if (personel.unvan && (personel.unvan.includes('Okul Müdürü') || personel.unvan.includes('Rehber Öğretmen') || personel.unvan.includes('Rehberlik'))) {
                                hours = 4;
                            } else {
                                hours = (personel.sozlesme_turu === 'Belirsiz Süreli') ? 7.5 : (scheduleData[personel.id]?.[dayOfWeekTR] || 0);
                            }
                        }
                    }
                }

                if (leaveCodeForDay && (code === 'N' || code === 'Y')) {
                     code = leaveCodeForDay;
                     hours = 0;
                }
            }
            individualPuantajData[dateString] = { code, hours, notes: '' };
        }

        // 4. Adım: En Önemli Kısım -> Diğerlerini silmeden SADECE bu personelin verisini güncelle
        puantajData[selectedPersonelId] = individualPuantajData;

        // 5. Adım: Değişikliği kalıcı hale getir ve ekranı yenile
        showToast('Bireysel puantaj hazırlandı. Veritabanına kaydediliyor...', 'info');
        await savePuantajData();
        await loadPuantajDataForCurrentMonth(); // Ekranı en güncel haliyle yeniden yükle

    } catch (error) {
        console.error("Bireysel puantaj oluşturulurken hata:", error);
        showToast('Bireysel puantaj oluşturulamadı.', 'error');
    }
}
function calculateMonthlyHours(personelId) {
    const personel = puantajPersonelList.find(p => p.id == personelId);
    const personelData = puantajData[personelId];
    if (!personel || !personelData) return { genelToplam: 0, ekDers: 0 };

    let genelToplam = 0;
    let ekDers = 0;
    const unvan = personel.unvan || '';

    // Yönetici personel ve Rehber Öğretmen için özel durumlar
    // *** YENİ KONTROL: "Rehberlik" kelimesi de eklendi ***
    if (unvan.includes('Okul Müdürü') || unvan.includes('Rehber Öğretmen') || unvan.includes('Rehberlik')) {
        // Adım 1: Gerçek çalıştığı saatleri toplayarak 'genelToplam'ı hesapla.
        if (personel.sozlesme_turu === 'Belirsiz Süreli') {
            Object.values(personelData).forEach(dayData => {
                if (dayData.code === 'N') {
                    genelToplam += (dayData.hours || 0);
                }
            });
        } else { // Diğer sözleşme türleri için
            Object.values(personelData).forEach(dayData => {
                if (dayData.code === 'N' || dayData.code === 'RTÇ' || dayData.code === 'Y' || dayData.code === 'K') {
                    genelToplam += (dayData.hours || 0);
                }
            });
        }

        // Adım 2: Özel ek ders kuralını uygula (günde 4 saat).
        Object.keys(personelData).forEach(dateString => {
            const dayData = personelData[dateString];
            if (dayData.code === 'N' || dayData.code === 'RTÇ') {
                ekDers += 4;
            }
        });
        
        // Adım 3: Doğru hesaplanmış değerleri döndür.
        return { genelToplam, ekDers };
    }

    if (unvan.includes('Müdür Yardımcısı')) { 
        const yardimciSchedule = [0, 4, 4, 4, 3, 3, 0]; 
        Object.keys(personelData).forEach(dateString => { 
            const dayData = personelData[dateString]; 
            if (dayData.code === 'N' || dayData.code === 'RTÇ') { 
                const date = new Date(dateString + 'T00:00:00'); 
                const dayOfWeek = date.getDay(); 
                ekDers += yardimciSchedule[dayOfWeek]; 
            } 
        }); 
        genelToplam = ekDers; 
        return { genelToplam, ekDers }; 
    }

    // Diğer tüm personeller için 'genelToplam' hesaplaması
    if (personel.sozlesme_turu === 'Belirsiz Süreli') {
        Object.values(personelData).forEach(dayData => {
            if (dayData.code === 'N') {
                genelToplam += (dayData.hours || 0);
            }
        });
    } else {
        Object.values(personelData).forEach(dayData => {
            if (dayData.code === 'N' || dayData.code === 'RTÇ' || dayData.code === 'Y' || dayData.code === 'K') {
                genelToplam += (dayData.hours || 0);
            }
        });
    }

    // Diğer tüm personeller için 'ekDers' hesaplaması
    if (personel.sozlesme_turu === 'Kısmi Süreli') {
        ekDers = 0;
    }
    else if (!personel.neviAdi.includes('Eğitim Personeli')) {
        ekDers = genelToplam;
    }
    else {
        const maasKarsiligiHaftalik = parseInt(personel.maasKarsiligi) || 0;
        if (maasKarsiligiHaftalik === 0) {
            ekDers = genelToplam;
        } else {
            const workWeeks = new Set();
            const getWeek = (d) => { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - yearStart) / 86400000) + 1) / 7); };

            Object.keys(personelData).forEach(dateString => {
                if (personelData[dateString].code === 'N' || personelData[dateString].code === 'RTÇ' || personelData[dateString].code === 'Y' || personelData[dateString].code === 'K') {
                    workWeeks.add(getWeek(new Date(dateString + 'T00:00:00')));
                }
            });
            const toplamMaasKarsiligi = workWeeks.size * maasKarsiligiHaftalik;
            ekDers = Math.max(0, genelToplam - toplamMaasKarsiligi);
        }
    }

    return { genelToplam, ekDers: Math.round(ekDers) };
}
function calculateFazlaMesai(personelId) {
    const personelData = puantajData[personelId];
    if (!personelData) return 0;

    const weeklyHours = {};
    // Bir tarihin hangi haftaya ait olduğunu bulan yardımcı fonksiyon
    const getWeekNumber = (d) => {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    };

    // Her günün saatini ilgili haftanın toplamına ekle
    for (const dateString in personelData) {
        const dayData = personelData[dateString];
        // Sadece çalışılan günlerin saatlerini hesaba kat
        if (dayData.code === 'N' || dayData.code === 'RTÇ' || dayData.code === 'Y' || dayData.code === 'K') {
            const date = new Date(dateString + 'T00:00:00');
            const weekNumber = getWeekNumber(date);
            
            if (!weeklyHours[weekNumber]) {
                weeklyHours[weekNumber] = 0;
            }
            weeklyHours[weekNumber] += (dayData.hours || 0);
        }
    }

    let totalOvertime = 0;
    // Her haftanın toplam saatini kontrol et ve 45'i aşan kısmı fazla mesaiye ekle
    for (const week in weeklyHours) {
        if (weeklyHours[week] > 45) {
            totalOvertime += (weeklyHours[week] - 45);
        }
    }

    return totalOvertime;
}
// YENİ EKLENECEK FONKSİYON
function calculateEffectiveRehberlikHours(personelId, year, month, allPuantajData) {
    const personel = puantajPersonelList.find(p => p.id === personelId);
    // Personelin rehberlik görevi yoksa veya veri bulunamazsa 0 dön
    if (!personel || personel.rehberlik_gorevi !== 'evet' || !allPuantajData[personelId]) {
        return 0;
    }

    let effectiveHours = 0;
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const personelMonthData = allPuantajData[personelId];

    // Ayın her gününü döngüye al
    for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(year, month, day);

        // Eğer gün Perşembe ise (Pazar=0, Pzt=1... Perşembe=4)
        if (currentDate.getDay() === 4) {
            const dateString = currentDate.toISOString().split('T')[0];
            const dayStatus = personelMonthData[dateString]?.code;

            // Sadece normal çalışma günüyse ('N') rehberlik saati ekle.
            // Diğer tüm durumlar (I, R, S, RT vb.) için ekleme yapma.
            if (dayStatus === 'N') {
                effectiveHours += 2;
            }
        }
    }
    return effectiveHours;
}


function renderLegend() {
    const legendContainer = document.getElementById('puantaj-legend');
    if(!legendContainer) return;
    legendContainer.innerHTML = '';
    
     const statusCodes = { 'N': 'Normal', 'HT': 'Hafta Sonu', 'RT': 'Resmi Tatil', 'İ': 'İzinli (Ücretli)', 'R': 'Raporlu', 'Üİ': 'Ücretsiz İzin', 'S': 'Yıllık İzin', 'K': 'Yarım Gün Çalışma', 'Y': 'Yarım Gün Çalışma (Kısmi)', 'RTÇ': 'Resmi Tatil Çalışması', 'E': 'Eksik Gün' };
    for (const code in statusCodes) {
        const item = document.createElement('div'); item.className = 'legend-item';
        item.innerHTML = `<span class="legend-color-box status-${code}"></span><b>(${code})</b>: ${statusCodes[code]}`;
        legendContainer.appendChild(item);
    }
}


// ======================= YERİNE BU YENİ FONKSİYONU EKLEYİN =======================
function renderGrandTotals(nobetVerisi = {}, personelListesi) {
    const year = parseInt(document.getElementById('input-year').value);
    const month = parseInt(document.getElementById('select-month').value);

    let totalEkders = 0, totalNobet = 0, totalRehberlik = 0;

    // DEĞİŞİKLİK: Artık tüm listeyi değil, fonksiyona gönderilen
    // filtrelenmiş listeyi (personelListesi) kullanıyoruz.
    personelListesi.forEach(personel => {
        if (personel.neviAdi.includes('Eğitim Personeli') || personel.unvan.includes('Müdür')) {
            totalEkders += calculateMonthlyHours(personel.id).ekDers;
        }

        totalNobet += nobetVerisi[personel.id] || 0;
        totalRehberlik += calculateEffectiveRehberlikHours(personel.id, year, month, puantajData);
    });

    document.getElementById('total-ekders').textContent = totalEkders + " Saat";
    document.getElementById('total-nobet').textContent = totalNobet + " Saat";
    document.getElementById('total-rehberlik').textContent = totalRehberlik + " Saat";
}
// ==============================================================================
    
        

        function openEditModal(personelId, date) {
            const personel = puantajPersonelList.find(p => p.id == personelId);
            const dayData = puantajData[personelId]?.[date];
            if(!personel || !dayData) return;
            document.getElementById('p-modal-title').textContent = `${personel.ad} - ${formatDateDDMMYYYY(date)}`;
            document.getElementById('modal-status').value = dayData.code;
            document.getElementById('modal-hours').value = dayData.hours;
            document.getElementById('modal-notes').value = dayData.notes;
            const modalSaveBtn = document.getElementById('modal-save');
            modalSaveBtn.dataset.personelId = personelId;
            modalSaveBtn.dataset.date = date;
            document.getElementById('edit-modal-overlay').style.display = 'flex';
        }




        // MEVCUT downloadPdf FONKSİYONUNU SİLİP BUNU EKLEYİN
function downloadPdf() {
    const year = document.getElementById('input-year').value;
    const monthName = document.getElementById('select-month').options[document.getElementById('select-month').selectedIndex].text;
    const puantajTabloAlani = document.getElementById('puantaj-table-container');

    if (!puantajData || Object.keys(puantajData).length === 0) {
        showToast('PDF\'e aktarılacak puantaj verisi bulunmuyor.', 'error');
        return;
    }

    showToast('PDF oluşturuluyor, lütfen bekleyin...', 'info');

    // html2canvas kütüphanesi ile puantaj alanının resmini çekiyoruz
    html2canvas(puantajTabloAlani, {
        scale: 2, // Görüntü kalitesini artırmak için ölçeği 2 katına çıkar
        useCORS: true,
        logging: false,
        // YENİ EKLENEN ÖNEMLİ AYAR: Arka plan renklerinin çizilmesini sağlar.
        backgroundColor: '#ffffff' // Beyaz bir arka plan belirleyerek şeffaflığı önler
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        
        // PDF'i A3 boyutunda ve yatay olarak oluşturuyoruz ki tablo sığsın
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'pt',
            format: 'a3'
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const ratio = canvasWidth / canvasHeight;

        // Resmin oranını koruyarak PDF'e sığdır
        let imgWidth = pdfWidth - 40; // Kenarlardan 20'şer puan boşluk
        let imgHeight = imgWidth / ratio;

        // Eğer yükseklik sayfaya sığmazsa, yüksekliğe göre yeniden ölçekle
        if (imgHeight > pdfHeight - 40) {
            imgHeight = pdfHeight - 40;
            imgWidth = imgHeight * ratio;
        }

        const x = (pdfWidth - imgWidth) / 2;
        const y = (pdfHeight - imgHeight) / 2;

        pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
        pdf.save(`Puantaj_${monthName}_${year}.pdf`);
        showToast('PDF başarıyla indirildi.', 'success');
    });
}

async function downloadExcel() {
    const year = document.getElementById('input-year').value;
    const month = parseInt(document.getElementById('select-month').value);
    const monthName = document.getElementById('select-month').options[month].text;

    // === BAŞLANGIÇ: DOĞRU FİLTRELEME MANTIĞI ===
    const ayinIlkGunu = new Date(Date.UTC(year, month, 1));
    const ayinSonGunu = new Date(Date.UTC(year, month + 1, 0));

    const aktifPersonelList = puantajPersonelList.filter(personel => {
        const girisStr = personel.ise_giris;
        const ayrilisStr = personel.isten_ayrilis;

        if (!girisStr) return false;
        const girisDate = new Date(girisStr + 'T00:00:00Z');
        if (isNaN(girisDate.getTime())) return false;

        const iseBaslamisMi = girisDate <= ayinSonGunu;
        
        let istenAyrilmamisMi = true;
        if (ayrilisStr && ayrilisStr.trim() !== '' && ayrilisStr.trim() !== '---') {
            const ayrilisDate = new Date(ayrilisStr + 'T00:00:00Z');
            if (!isNaN(ayrilisDate.getTime())) {
                istenAyrilmamisMi = ayrilisDate >= ayinIlkGunu;
            }
        }
        return iseBaslamisMi && istenAyrilmamisMi;
    });
    // === BİTİŞ: DOĞRU FİLTRELEME MANTIĞI ===

    // Ekrandaki personel filtresini (dropdown) uygula
    const selectedPersonelId = document.getElementById('personel-filter-select').value;
    let personelToExport = aktifPersonelList;

    if (selectedPersonelId && selectedPersonelId !== 'all') {
        personelToExport = aktifPersonelList.filter(p => p.id === selectedPersonelId);
    }
    
    if (personelToExport.length === 0) {
        showToast('Dışa aktarılacak personel bulunmuyor.', 'error');
        return;
    }

    showToast('Filtrelenmiş Excel dosyası hazırlanıyor...', 'info');

    // Bu noktadan sonra fonksiyonun geri kalanı (HTML tablo oluşturma kısmı) aynı kalabilir.
    // Fonksiyonunuzun geri kalanını buraya olduğu gibi yapıştırın...
    const anaBaslik = `ÖZEL İSABET ORTAOKULU ${year} YILI ${monthName.toLocaleUpperCase('tr-TR')} AYI PERSONEL PUANTAJ CETVELİ`;
    const nobetVerisi = await fetchAndCalculateNobetData(year, month);

    const styleMap = {
        'status-N': 'background-color:#E8F5E9; color:#1B5E20; font-weight:bold;', 'status-S': 'background-color:#FFF9C4; color:#AF6000; font-weight:bold;',
        'status-HT': 'background-color:#FFEBCC; color:#B85B00; font-weight:bold;', 'status-RT': 'background-color:#D1EAFE; color:#0D47A1; font-weight:bold;',
        'status-R': 'background-color:#FFEBEE; color:#B71C1C; font-weight:bold;', 'status-UI': 'background-color:#EAECEE; color:#566573; font-weight:bold;',
        'status-Üİ': 'background-color:#EAECEE; color:#566573; font-weight:bold;', 'status-İ': 'background-color: #E6E6FA; color: #483D8B; font-weight:bold;',
        'status-Y': 'background-color:#D7F9E9; color:#1B5E20; font-weight:bold;', 'status-K': 'background-color:#D7F9E9; color:#1B5E20; font-weight:bold;',
        'status-E': 'background-color:#EEEEEE; color:#424242;', 'status-RTÇ': 'background-color: #E1BEE7; color: #4A148C; font-weight:bold;',
        'summary-yellow': 'background-color:#FFECB3; font-weight:bold;', 'summary-green': 'background-color:#C8E6C9; font-weight:bold;',
        'summary-nobet': 'background-color:#FFE0B2; font-weight:bold;', 'summary-rehberlik': 'background-color:#C5CAE9; font-weight:bold;',
        'summary-overtime': 'background-color:#FFCDD2; font-weight:bold;', 'summary-count': 'background-color:#E3F2FD; font-weight:bold; width:35px;',
        'summary-reason': 'background-color:#D2B4DE; font-weight:bold;', 'summary-missing-day': 'background-color:#AED6F1; font-weight:bold;',
        'total-worked-day': 'background-color:#E3F2FD; font-weight:bold;', 'social-section': 'background-color:#E3F2FD;',
        'header': 'background-color:#343a40; color:white; font-weight:600; text-align:center; vertical-align:middle; border:0.5pt solid #888888; font-size:9pt; white-space:nowrap;',
        'group-header': 'background-color:#495057; color:white; font-weight:bold; text-align:left; padding-left:10px; font-size:13pt;',
        'main-title': 'text-align:center; font-size:16pt; font-weight:bold; vertical-align:middle;',
        'hour-cell': 'font-size:9pt; color:#192a56; font-weight:500; text-align:center; vertical-align:middle;',
        'default-cell': 'text-align:center; vertical-align:middle; font-size:9pt;',
        'personel-cell': 'text-align:left; vertical-align:middle; font-weight:bold; font-size:9pt;',
        'unvan-cell': 'text-align:left; vertical-align:middle; font-size:9pt;',
        'v-divider': 'border-right:1.5pt solid #333333;', 'h-divider': 'border-bottom:1.5pt solid #333333;',
    };
    let excelHtml = `<table width="100%"><tr><td colspan="50" style="${styleMap['main-title']}">${anaBaslik}</td></tr></table><br/>`;
    const gunler = ['Paz', 'Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt'];
    const gunBasliklari = ["N", "HT", "RT", "İ", "R", "Üİ", "S", "K", "RTÇ"];
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const grupluPersonel = {
        'Belirsiz Süreli': personelToExport.filter(p => p.sozlesme_turu === 'Belirsiz Süreli'),
        'Belirli Süreli': personelToExport.filter(p => p.sozlesme_turu === 'Belirli Süreli'),
        'Kısmi Süreli': personelToExport.filter(p => p.sozlesme_turu === 'Kısmi Süreli')
    };
    const saatBasliklariConfig = {
        'Belirsiz Süreli': { headers: ["Aylık\nToplam", "Fazla\nMesai", "Mesai\nNedeni", "E. G.\nKodu"], keys: ["genelToplam", "fazlaMesai", "mesaiNedeni", "eksikGunKodu"], styleKeys: ["summary-yellow", "summary-overtime", "social-section", "summary-count"] },
        'Belirli Süreli': { headers: ["Aylık\nToplam", "Ek\nDers", "Nöbet", "Rehberlik"], keys: ["genelToplam", "ekDers", "nobet", "rehberlik"], styleKeys: ["summary-yellow", "summary-green", "summary-nobet", "summary-rehberlik"] },
        'Kısmi Süreli':    { headers: ["Aylık\nToplam", "Ek\nDers", "Nöbet", "Rehberlik"], keys: ["genelToplam", "ekDers", "nobet", "rehberlik"], styleKeys: ["summary-yellow", "summary-green", "summary-nobet", "summary-rehberlik"] }
    };
    excelHtml += '<table style="border-collapse:collapse;">';
    for (const grupAdi in grupluPersonel) {
        const personelGrubu = grupluPersonel[grupAdi];
        if (personelGrubu.length === 0) continue;
        const saatConfig = saatBasliklariConfig[grupAdi];
        const colspan = 3 + daysInMonth + saatConfig.headers.length + gunBasliklari.length + 4;
        excelHtml += `<tr><td colspan="${colspan}" style="${styleMap['group-header']} border:0.5pt solid #888888;">${grupAdi} Puantaj Kayıtları</td></tr>`;
        excelHtml += `<tr><th rowspan="2" style="${styleMap['header']}">Personel</th><th rowspan="2" style="${styleMap['header']}">Unvan</th><th rowspan="2" style="${styleMap['header']} ${styleMap['v-divider']}">İşe Giriş<br>İşten Çıkış</th><th colspan="${daysInMonth}" style="${styleMap['header']}">Aylık Puantaj Durumu</th><th colspan="${saatConfig.headers.length}" style="${styleMap['header']} ${styleMap['v-divider']}">Aylık Saat Toplamları</th><th colspan="${gunBasliklari.length}" style="${styleMap['header']} ${styleMap['v-divider']}">Aylık Gün Toplamları</th><th rowspan="2" style="${styleMap['header']} ${styleMap['v-divider']}">Sgk&nbsp;Prim&nbsp;Günü</th><th colspan="3" style="${styleMap['header']}">Sosyal Yardımlar</th><th rowspan="2" style="${styleMap['header']}">İmza</th></tr><tr>`;
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dividerStyle = (date.getDay() === 0 || day === daysInMonth) ? styleMap['v-divider'] : '';
            excelHtml += `<th style="${styleMap['header']} ${dividerStyle}">${day}<br>${gunler[date.getDay()]}</th>`;
        }
        saatConfig.headers.forEach(h => excelHtml += `<th style="${styleMap['header']} ${styleMap['v-divider']}">${h.replace('\n', '<br>')}</th>`);
        gunBasliklari.forEach(h => excelHtml += `<th style="${styleMap['header']} ${styleMap['v-divider']}">${h}</th>`);
        excelHtml += `<th style="${styleMap['header']}">Eş Durumu</th><th style="${styleMap['header']}">Çocuk 0-6</th><th style="${styleMap['header']}">Çocuk 6-18</th></tr>`;
        personelGrubu.forEach(personel => {
            const pData = puantajData[personel.id] || {};
            const monthlyHours = calculateMonthlyHours(personel.id);
            const nobetSaat = nobetVerisi[personel.id] || 0;
            const rehberlikSaat = calculateEffectiveRehberlikHours(personel.id, year, month, puantajData);
            const fazlaMesaiSaat = calculateFazlaMesai(personel.id);
            const statusCounts = calculateStatusCounts(personel.id);
            let sgkPrimGunu = new Date(year, month + 1, 0).getDate() - ((statusCounts.R || 0) + (statusCounts.Üİ || 0));
            if(personel.sozlesme_turu === 'Kısmi Süreli') { sgkPrimGunu = Math.round(monthlyHours.genelToplam / 7.5); }
            let ayrilisTarihiGoster = '---';
            if (personel.isten_ayrilis && personel.isten_ayrilis !== '---') {
                const ayrilisDate = new Date(personel.isten_ayrilis + 'T00:00:00Z');
                if (ayrilisDate.getUTCFullYear() === year && ayrilisDate.getUTCMonth() === month) {
                    ayrilisTarihiGoster = formatDateDDMMYYYY(personel.isten_ayrilis);
                }
            }
           let statusRowHtml = `<td rowspan="2" style="${styleMap['personel-cell']} border:0.5pt solid #888888;">${(personel.ad || '').replace('\n', '<br>')}</td><td rowspan="2" style="${styleMap['unvan-cell']} border:0.5pt solid #888888;">${(personel.unvan || '').replace('\n', '<br>')}</td><td rowspan="2" style="${styleMap['default-cell']} ${styleMap['v-divider']} border:0.5pt solid #888888;">${formatDateDDMMYYYY(personel.ise_giris)}<br>${ayrilisTarihiGoster}</td>`;
            let hoursRowHtml = '';
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = pData[dateString] || {};
                const dayStyle = styleMap[`status-${dayData.code}`] || '';
                const dividerStyle = (new Date(year, month, day).getDay() === 0 || day === daysInMonth) ? styleMap['v-divider'] : '';
                statusRowHtml += `<td style="${styleMap['default-cell']} ${dayStyle} ${dividerStyle} border:0.5pt solid #888888;">${dayData.code || ''}</td>`;
                const hourContent = (dayData.code === 'N' || dayData.code === 'RTÇ' || dayData.code === 'Y' || dayData.code === 'K') && dayData.hours > 0 ? dayData.hours : '';
                hoursRowHtml += `<td style="mso-number-format:'\\@'; ${styleMap['hour-cell']} ${dividerStyle} ${styleMap['h-divider']} border:0.5pt solid #888888;">${hourContent}</td>`;
            }
            const saatDegerleri = { 
                genelToplam: monthlyHours.genelToplam, 
                fazlaMesai: fazlaMesaiSaat, 
                mesaiNedeni: overtimeReasons[personel.id] || '', 
                eksikGunKodu: missingDayCodes[personel.id] || '',
                ekDers: monthlyHours.ekDers, 
                nobet: nobetSaat, 
                rehberlik: rehberlikSaat, 
                ht_saat: 0 
            };
            saatConfig.keys.forEach((key, index) => {
                 statusRowHtml += `<td rowspan="2" style="mso-number-format:'\\@'; ${styleMap['default-cell']} ${styleMap[saatConfig.styleKeys[index]]} ${styleMap['v-divider']} border:0.5pt solid #888888;">${saatDegerleri[key]}</td>`;
            });
            gunBasliklari.forEach(h => {
                statusRowHtml += `<td rowspan="2" style="${styleMap['summary-count']} ${styleMap['v-divider']} border:0.5pt solid #888888;">${statusCounts[h] || 0}</td>`;
            });
            statusRowHtml += `<td rowspan="2" style="${styleMap['total-worked-day']} ${styleMap['v-divider']} border:0.5pt solid #888888;">${sgkPrimGunu}</td><td rowspan="2" style="${styleMap['social-section']} border:0.5pt solid #888888;">${personel.esDurumu || ''}</td><td rowspan="2" style="${styleMap['social-section']} border:0.5pt solid #888888;">${personel.cocuk0_6 || ''}</td><td rowspan="2" style="${styleMap['social-section']} border:0.5pt solid #888888;">${personel.cocuk6_18 || ''}</td><td rowspan="2" style="border:0.5pt solid #888888;"></td>`;
            excelHtml += `<tr>${statusRowHtml}</tr><tr>${hoursRowHtml}</tr>`;
        });
    }
    excelHtml += '</table>';
    const fullHtml = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
        <head><meta charset="UTF-8">
            </head>
        <body>${excelHtml}</body>
        </html>`;
    const blob = new Blob([fullHtml], { type: 'application/vnd.ms-excel' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Puantaj_${monthName}_${year}.xls`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Excel dosyası başarıyla indirildi.', 'success');
}


async function saveModalChanges() {
    const modalSaveBtn = document.getElementById('modal-save');
    const personelId = modalSaveBtn.dataset.personelId;
    const date = modalSaveBtn.dataset.date;

    if (!personelId || !date) {
        showToast('Veri kaydedilirken bir hata oluştu.', 'error');
        return;
    }

    const newCode = document.getElementById('modal-status').value;
    const newHours = parseFloat(document.getElementById('modal-hours').value) || 0;
    const newNotes = document.getElementById('modal-notes').value;

    if (puantajData[personelId] && puantajData[personelId][date]) {
        puantajData[personelId][date] = {
            code: newCode,
            hours: newHours,
            notes: newNotes
        };
    }

    document.getElementById('edit-modal-overlay').style.display = 'none';
    
    // Değişiklikleri veritabanına kalıcı olarak kaydetmek için ana kaydetme fonksiyonunu çağırıyoruz.
    await savePuantajData(); // <-- YENİ EKLENEN SATIR

    // Tabloyu ve toplamları yeniden çizmek için ilgili fonksiyonları tekrar çağır.
    // Not: savePuantajData zaten başarılı bir toast mesajı gösterdiği için aşağıdaki satırı kaldırabilir veya değiştirebilirsiniz.
    const year = parseInt(document.getElementById('input-year').value);
    const month = parseInt(document.getElementById('select-month').value);
    const nobetVerisi = await fetchAndCalculateNobetData(year, month);
    
    // Bu kısım aslında savePuantajData'dan sonra tekrar tabloyu en güncel haliyle çizmek için
    // loadPuantajDataForCurrentMonth fonksiyonunu çağırmak daha doğru olabilir ama mevcut yapı da iş görür.
    await loadPuantajDataForCurrentMonth(); // Tabloyu veritabanından gelen son haliyle yeniden yüklemesi daha garanti.
    
    // showToast('Güncelleme başarıyla veritabanına kaydedildi.', 'success'); // İsteğe bağlı olarak bu mesajı kullanabilirsiniz.
}
// =================== 3. ADIM BİTİŞİ ===================
function printPuantaj() {
    window.print();
}

// BU YENİ VE GÜNCELLENMİŞ FONKSİYONU EKLEYİN
async function applyBulkUpdate() {
    const day = document.getElementById('bulk-update-day').value;
    const group = document.getElementById('bulk-update-group').value;
    const newStatusCode = document.getElementById('bulk-update-status').value;
    const year = parseInt(document.getElementById('input-year').value);
    const month = parseInt(document.getElementById('select-month').value);

    if (!day || !group || !newStatusCode) {
        return showToast('Lütfen Gün, Grup ve Durum Kodu seçin.', 'error');
    }
    if (!puantajData || Object.keys(puantajData).length === 0) {
        return showToast('Önce bir puantaj oluşturmalı veya yüklemelisiniz.', 'error');
    }

    const confirmationMessage = `'${group}' grubundaki tüm personel için ayın ${day}. gününün durumunu '${newStatusCode}' olarak değiştirmek istediğinizden emin misiniz?`;
    if (!confirm(confirmationMessage)) {
        return;
    }

    // DÜZELTME 1: Önce o ay için aktif olan tüm personeli buluyoruz.
    const aktifPersonelList = puantajPersonelList.filter(personel => {
        const ayrilisStr = personel.isten_ayrilis;
        if (!ayrilisStr || ayrilisStr.trim() === '' || ayrilisStr.trim() === '---') return true;
        const ayrilisDate = new Date(ayrilisStr + 'T00:00:00Z');
        if (isNaN(ayrilisDate.getTime())) return true;
        const ayrilisYear = ayrilisDate.getUTCFullYear();
        const ayrilisMonth = ayrilisDate.getUTCMonth();
        if (ayrilisYear > year) return true;
        if (ayrilisYear === year && ayrilisMonth >= month) return true;
        return false;
    });

    // Şimdi, aktif personel listesinden kullanıcının seçtiği grubu filtreliyoruz.
    const targetPersonnel = aktifPersonelList.filter(p => {
        if (group === 'Tümü') return true;
        return p.sozlesme_turu === group;
    });

    if (targetPersonnel.length === 0) {
        return showToast('Seçilen grupta güncellenecek personel bulunamadı.', 'info');
    }

    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

    targetPersonnel.forEach(personel => {
        if (puantajData[personel.id] && puantajData[personel.id][dateString]) {
            puantajData[personel.id][dateString].code = newStatusCode;
        }
    });

    showToast('Güncelleme uygulanıyor...', 'info');
    const nobetVerisi = await fetchAndCalculateNobetData(year, month);

    // DÜZELTME 2: Tabloyu çizen fonksiyona artık aktif personel listesini de gönderiyoruz.
    renderPuantajTable(nobetVerisi, aktifPersonelList);
    renderGrandTotals(nobetVerisi, aktifPersonelList);    attachCellListeners();

    showToast('Toplu güncelleme başarıyla uygulandı!', 'success');
}


// Olası bir sonraki hatayı önlemek için: Eksik attachCellListeners fonksiyonu
function attachCellListeners() {
    const cells = document.querySelectorAll('.status-cell');
    cells.forEach(cell => {
        cell.addEventListener('click', () => {
            const personelId = cell.dataset.personelId;
            const date = cell.dataset.date;
            openEditModal(personelId, date);
        });
    });
}


        document.addEventListener('DOMContentLoaded', () => {
// === MOBİL HAMBURGER MENÜ MANTIĞI ===
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const sidebar = document.querySelector('.sidebar');
        
        if (hamburgerBtn) {
            hamburgerBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Diğer tıklama olaylarını engelle
                sidebar.classList.toggle('open');
            });
        }
        
        // Menüdeki bir linke tıklandığında menünün otomatik kapanmasını sağla
        sidebar.addEventListener('click', (e) => {
            if (e.target.closest('a')) {
                sidebar.classList.remove('open');
            }
        });

        // Menü dışına tıklandığında menüyü kapat
        document.body.addEventListener('click', (e) => {
            if (sidebar.classList.contains('open') && !sidebar.contains(e.target)) {
                 sidebar.classList.remove('open');
            }
        });
    // KULLANICI DURUMUNU KONTROL EDEN ANA YAPI
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // KULLANICI GİRİŞ YAPMIŞSA:
            loginPanel.style.display = 'none';
            appContainer.style.display = 'flex';

renderDashboardData(); // <--- YENİ EKLENEN SATIR BU

            

            // --- UYGULAMA BAŞLATMA KODLARI (SADECE GİRİŞ YAPILDIĞINDA ÇALIŞIR) ---
            const modal = document.getElementById('add-staff-modal');
            const personelForm = document.getElementById('personelForm');
            const openModal = (staffId=null, staffData={}) => { loadPersonelForm(staffId, staffData); modal.classList.add('open'); };
            const closeModal = () => modal.classList.remove('open');

            document.getElementById('open-add-staff-modal').addEventListener('click', () => openModal());
            document.getElementById('add-staff-from-list-btn').addEventListener('click', () => openModal());
            modal.querySelector('.close-modal').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });


            // ======================= YERİNE BU DOĞRU KOD BLOĞUNU EKLEYİN =======================
document.querySelectorAll('.nav-link, .sub-menu a').forEach(link => {
    // Menüdeki "Yeni Personel Ekle" butonu ayrı yönetildiği için onu hariç tutuyoruz
    if (link.id === 'open-add-staff-modal') return;

    link.addEventListener('click', function(e) {
        // Eğer linkin bir hedefi varsa, varsayılan tıklama eylemini engelle
        if (this.dataset.target) e.preventDefault();
        
        const targetId = this.dataset.target;
        if (!targetId) return; // Eğer linkin bir hedefi yoksa fonksiyondan çık

        // Tüm menü linklerinden ve içerik modüllerinden 'active' sınıfını kaldır
        document.querySelectorAll('.nav-link, .accordion-trigger, .module').forEach(el => el.classList.remove('active'));
        
        // Tıklanan linke ve eğer varsa ana menü grubuna 'active' sınıfını ekle
        this.classList.add('active');
        if (this.closest('.menu-item-group')) {
            this.closest('.menu-item-group').querySelector('a').classList.add('active');
        }
        
        // Hedef içerik modülünü görünür yap
        document.getElementById(targetId).classList.add('active');

        // Hangi modülün aktif olduğuna bağlı olarak ilgili fonksiyonu çağır
        if (targetId === 'dashboard') renderDashboardData(); // Dashboard yenileme eklendi
        if (targetId === 'staff-list') fetchStaff();
        if (targetId === 'settings') initializeSettings();
        if (targetId === 'gorevlendirme') initializeGorevlendirme(); 
        if (targetId === 'nobet-takip') initializeNobetTakip();
        if (targetId === 'puantaj') initializePuantaj();
        if (targetId === 'izin-takip') initializeIzinTakip();
        if (targetId === 'ders-programi') initializeSchedule();
    });
});
// ==============================================================================

            document.querySelectorAll('.accordion-trigger').forEach(acc => acc.addEventListener('click', e => { e.preventDefault(); acc.parentElement.classList.toggle('open'); }));

            personelForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const editingId = e.target.dataset.editingId;
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    // Kısmi süreli çalışma verilerini güvenli bir şekilde işle
    if (data.sozlesme_turu === 'Kısmi Süreli') {
        data.kismi_zamanli_calisma = {};
        const gunler = formData.getAll('kismi_gunler'); // Seçili tüm günler
        const gunMap = {
            'Pazartesi': 'pzts_saat',
            'Salı': 'sali_saat',
            'Çarşamba': 'crs_saat',
            'Perşembe': 'prs_saat',
            'Cuma': 'cuma_saat',
            'Cumartesi': 'cmrts_saat',
            'Pazar': 'pazar_saat'
        };

        gunler.forEach(gunAdi => {
            const saatInputAdi = gunMap[gunAdi];
            // Eğer gün haritada varsa ve ilgili saat input'u doluysa veriyi işle
            if (saatInputAdi && data[saatInputAdi]) {
                const saatDegeri = parseInt(data[saatInputAdi], 10);
                if (!isNaN(saatDegeri)) { // Sayısal bir değer olduğundan emin ol
                    data.kismi_zamanli_calisma[gunAdi] = saatDegeri;
                }
            }
        });

        // Ana 'data' objesinden artık gereksiz olan geçici anahtarları temizle
        delete data.kismi_gunler;
        Object.values(gunMap).forEach(inputAdi => delete data[inputAdi]);
    }

    try {
        if (editingId) {
            await setDoc(doc(db, "personel", editingId), data, { merge: true });
            showToast('Personel başarıyla güncellendi.');
        } else {
            await addDoc(collection(db, "personel"), data);
            showToast('Personel başarıyla eklendi.');
        }
        closeModal();
        // Eğer personel listesi ekranı aktifse, listeyi yenile
        if (document.getElementById('staff-list').classList.contains('active')) {
            fetchStaff();
        }
    } catch (err) {
        showToast('İşlem sırasında bir hata oluştu. Lütfen tekrar deneyin.', 'error');
        console.error("Personel kaydetme/güncelleme hatası:", err);
    }
});
            document.getElementById('staff-list').addEventListener('click', async (e) => {
                if(e.target.classList.contains('btn-delete')) { if (confirm('Bu personeli silmek istediğinizden emin misiniz?')) { await deleteDoc(doc(db, 'personel', e.target.dataset.id)); showToast('Personel silindi.'); fetchStaff(); } }
                if(e.target.classList.contains('btn-edit')) { const docSnap = await getDoc(doc(db, 'personel', e.target.dataset.id)); if(docSnap.exists()) openModal(docSnap.id, docSnap.data()); }
            });

            document.getElementById('ekleBtn').addEventListener('click', addLesson);

        } else {
            // KULLANICI GİRİŞ YAPMAMIŞSA VEYA ÇIKIŞ YAPTIYSA:
            loginPanel.style.display = 'flex';
            appContainer.style.display = 'none';
        }
    });

    // GİRİŞ VE ÇIKIŞ BUTONLARINA OLAYLARI EKLEME
    loginBtn.addEventListener('click', async () => {
        const email = loginEmailInput.value;
        const password = loginPasswordInput.value;
        loginError.style.display = 'none';

        try {
            await signInWithEmailAndPassword(auth, email, password);
            // Başarılı giriş sonrası onAuthStateChanged tetiklenecek ve paneli gösterecek.
        } catch (error) {
            loginError.textContent = "Hatalı e-posta veya şifre.";
            loginError.style.display = 'block';
            console.error("Giriş Hatası:", error);
        }
    });

    logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    ;
                }
            });
});

    </script>

<div id="edit-nobet-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Nöbet Kaydını Düzenle</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-nobet-form">
                    <input type="hidden" id="edit-nobet-id">
                    <div class="form-grid" style="grid-template-columns: 1fr 2fr 2fr; align-items: flex-end;">
                        <div class="form-group">
                            <label for="edit-nobet-tarih">Tarih</label>
                            <input type="date" id="edit-nobet-tarih">
                        </div>
                        <div class="form-group">
                            <label for="edit-nobet-personel">Nöbetçi Personel</label>
                            <select id="edit-nobet-personel"></select>
                        </div>
                        <div class="form-group">
                            <label for="edit-nobet-yeri">Nöbet Yeri</label>
                            <select id="edit-nobet-yeri"></select>
                        </div>
                    </div>
                    <div class="button-group" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-save">Değişiklikleri Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
<div id="toplu-izin-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3>Toplu İzin Girişi</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-top: 0; margin-bottom: 20px; background-color: #eef1f3; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6;">
                Bu ekranı kullanarak seçili personellere aynı anda, belirtilen tarihler arasında izin atayabilirsiniz. Bu işlem, her bir personel için ayrı bir izin kaydı oluşturacaktır.
            </p>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 2fr; margin-bottom: 20px; align-items: flex-end;">
                <div class="form-group">
                    <label for="toplu-izin-baslangic">Başlangıç Tarihi</label>
                    <input type="date" id="toplu-izin-baslangic">
                </div>
                <div class="form-group">
                    <label for="toplu-izin-bitis">Bitiş Tarihi</label>
                    <input type="date" id="toplu-izin-bitis">
                </div>
                <div class="form-group">
                    <label for="toplu-izin-tipi">İzin Tipi</label>
                    <select id="toplu-izin-tipi">
                        <option value="">İzin Tipi Seçiniz...</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label style="margin-bottom: 10px;">İzin Atanacak Personeller</label>
                <div id="toplu-personel-listesi" style="height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 15px; border-radius: 6px; background: #fdfdfd; display: flex; flex-direction: column; gap: 8px;">
                    <p>Personel listesi yükleniyor...</p>
                </div>
            </div>
            <div class="button-group" style="margin-top: 25px;">
                <button id="toplu-izin-kaydet-btn" class="btn btn-save">Seçili Personellere İzin Ata</button>
            </div>
        </div>
    </div>
</div>
<div id="dilekce-date-modal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
            <h3>Dilekçe Tarihini Belirtin</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p>Lütfen dilekçenin üzerinde görünecek resmi tarihi seçiniz.</p>
            <div class="form-group">
                <label for="dilekce-tarih-input">Dilekçe Tarihi</label>
                <input type="date" id="dilekce-tarih-input">
            </div>
            <div class="button-group">
                <button id="generate-dilekce-with-date-btn" class="btn btn-save">Dilekçeyi Oluştur</button>
            </div>
        </div>
    </div>
</div>
<div id="edit-izin-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3>İzin Kaydını Düzenle</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="edit-izin-form">
                <input type="hidden" id="edit-izin-id">
                <div class="form-grid" style="grid-template-columns: 2fr 1.5fr 1fr 1fr; align-items: flex-end;">
                    <div class="form-group">
                        <label for="edit-izin-personel">Personel</label>
                        <select id="edit-izin-personel" disabled></select>
                    </div>
                    <div class="form-group">
                        <label for="edit-izin-tipi">İzin Tipi</label>
                        <select id="edit-izin-tipi"></select>
                    </div>
                    <div class="form-group">
                        <label for="edit-izin-baslangic">Başlangıç Tarihi</label>
                        <input type="date" id="edit-izin-baslangic">
                    </div>
                    <div class="form-group">
                        <label for="edit-izin-bitis">Bitiş Tarihi</label>
                        <input type="date" id="edit-izin-bitis">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="edit-izin-aciklama">Açıklama / Not</label>
                        <input type="text" id="edit-izin-aciklama" placeholder="İzinle ilgili kısa bir not...">
                    </div>
                </div>
                <div class="button-group" style="margin-top: 25px;">
                    <button type="submit" class="btn btn-save">Değişiklikleri Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js').then(registration => {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
      }, err => {
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }
</script>
</body>
</html>