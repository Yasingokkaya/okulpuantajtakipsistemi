<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ãœretici Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/jpeg" href="app-logo.jpg">
    <link rel="apple-touch-icon" href="app-logo.jpg">
    <meta name="theme-color" content="#0f766e">
    <link rel="manifest" href="../manifest.json">
    <style>
        /* GENEL AYARLAR */
        body {
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
            padding-bottom: 90px;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* CÃœZDAN KARTI */
        .wallet-card {
            background: linear-gradient(135deg, #0f766e 0%, #115e59 100%);
            color: white; border-radius: 24px; padding: 25px;
            margin: 20px 20px 10px 20px;
            box-shadow: 0 15px 30px rgba(15, 118, 110, 0.25);
            position: relative; overflow: hidden;
        }
        .wallet-card::after {
            content: '\f555'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; right: -20px; bottom: -40px;
            font-size: 9rem; opacity: 0.08; transform: rotate(-20deg);
        }
        .balance-title { font-size: 0.75rem; opacity: 0.9; letter-spacing: 1.5px; text-transform: uppercase; font-weight: 600; }
        .balance-amount { font-size: 2.6rem; font-weight: 800; line-height: 1; margin: 8px 0; letter-spacing: -1px;}

      /* KOMPAKT VE ÅžIK KARTLAR */
        .quick-card {
            border: none;
            border-radius: 18px; /* KÃ¶ÅŸeler ideal yuvarlaklÄ±kta */
            color: white;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            height: 100px; /* YÃœKSEKLÄ°K AZALTILDI (125px -> 100px) */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 6px 15px rgba(0,0,0,0.12); /* GÃ¶lge yumuÅŸatÄ±ldÄ± */
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        /* TÄ±klama Efekti */
        .quick-card:active { 
            transform: scale(0.96); 
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        /* Arka Plan Ä°konu (SÃ¼sleme) */
        .quick-card i.bg-icon {
            position: absolute;
            right: -10px;
            bottom: -10px;
            font-size: 3.5rem; /* SÃ¼sleme ikonu kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */
            opacity: 0.15;
            transform: rotate(-15deg);
            z-index: 0;
        }

        /* Ana Ä°kon */
        .quick-card i.fa-2x {
            font-size: 1.8rem; /* Ana ikon boyutu dengelendi */
            margin-bottom: 6px; /* YazÄ± ile arasÄ± yakÄ±nlaÅŸtÄ±rÄ±ldÄ± */
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        /* Kart YazÄ±sÄ± */
        .quick-card h6 {
            font-weight: 700;
            font-size: 0.85rem; /* YazÄ± boyutu kibarlaÅŸtÄ±rÄ±ldÄ± */
            margin: 0;
            z-index: 1;
            letter-spacing: 0.3px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        /* ALT MENÃœ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 75px;
            background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.06); display: flex; justify-content: space-around;
            align-items: center; z-index: 1050; padding-bottom: 10px;
        }
        .nav-item {
            background: none; border: none; text-align: center; color: #94a3b8;
            font-size: 0.75rem; font-weight: 600; width: 33%;
            display: flex; flex-direction: column; align-items: center; gap: 6px;
        }
        .nav-item i { font-size: 1.5rem; transition: transform 0.2s; }
        .nav-item.active { color: #0f766e; }
        .nav-item.active i { transform: translateY(-4px); }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex;
            align-items: center; justify-content: center; flex-direction: column;
        }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <div class="fw-bold text-muted">Verileriniz YÃ¼kleniyor...</div>
    </div>
<div id="page-home">
        
        <div class="px-3 pt-3">
            <div class="bg-white p-2 rounded-4 shadow-sm d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                        <i class="fa-regular fa-calendar-days"></i>
                    </div>
                    <div>
                        <small class="text-muted d-block" style="font-size: 0.7rem; line-height: 1;">GÃ¶rÃ¼ntÃ¼lenen DÃ¶nem</small>
                        <span class="fw-bold text-dark small" id="lblSelectedMonth">Bu Ay</span>
                    </div>
                </div>
                <input type="month" id="monthFilter" class="form-control form-control-sm border-0 bg-light fw-bold text-end text-primary" style="width: 140px; cursor: pointer;">
            </div>
        </div>

        <div class="wallet-card" style="padding: 15px 20px;"> <div class="d-flex justify-content-between align-items-center position-relative" style="z-index: 2;">
                
                <div>
                    <div class="balance-title" style="opacity: 0.8; margin-bottom: 2px; font-size: 0.65rem;">ÃœRETÄ°CÄ° BÄ°LGÄ° SÄ°STEMÄ°</div>
                    <div class="fw-bold text-white" id="lblMemberName" style="font-size: 1.4rem; line-height: 1.1;">HoÅŸgeldiniz</div>
                </div>
                
                <div class="bg-white bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center shadow-sm" 
                     onclick="cikisYap()" 
                     style="width: 38px; height: 38px; cursor: pointer; flex-shrink: 0;">
                    <i class="fa-solid fa-right-from-bracket text-white" style="font-size: 0.9rem;"></i>
                </div>

            </div>
        </div>

        <div class="px-3 mt-3">
            <div class="row g-2"> 
                
                <div class="col-4">
                    <div class="quick-card" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);"
                         onclick="sayfaDegistir('page-milk', document.getElementById('nav-milk'))">
                        <i class="bg-icon fa-solid fa-cow"></i>
                        <i class="fa-solid fa-cow fa-2x mb-1"></i>
                        <h6>SÃ¼tlerim</h6>
                    </div>
                </div>

              <div class="col-4">
    <div class="quick-card" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);"
         onclick="hesapEkstresiAc()">
        <i class="bg-icon fa-solid fa-wallet"></i>
        <i class="fa-solid fa-wallet fa-2x mb-1"></i>
        <h6>Hesap</h6>
    </div>
</div>
<div class="col-4">
    <div class="quick-card" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);"
         onclick="sayfaDegistir('page-animals', null); hayvanlariGetir();">
        <i class="bg-icon fa-solid fa-paw"></i>
        <i class="fa-solid fa-paw fa-2x mb-1"></i>
        <h6>HayvanlarÄ±m</h6>
    </div>
</div>
<div class="col-4">
    <div class="quick-card" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);"
         onclick="malzemeSiparisiVer()">
        <i class="bg-icon fa-solid fa-truck-ramp-box"></i>
        <i class="fa-solid fa-cart-shopping fa-2x mb-1"></i>
        <h6>Yem Ä°ste</h6>
    </div>
</div>
                <div class="col-4">
                    <div class="quick-card" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);"
     onclick="whatsappDestekAc()">
    <i class="bg-icon fa-brands fa-whatsapp"></i>
    <i class="fa-brands fa-whatsapp fa-2x mb-1"></i>
    <h6>Destek</h6>
</div>
                </div>

            </div>
        </div>

       <div class="px-3 mt-4 mb-4">
            
            <h6 class="fw-bold text-secondary small ps-1 mb-2">AYLIK PERFORMANS</h6>
            <div class="card border-0 shadow-sm mb-4" style="border-radius: 18px;">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-end mb-2">
                        <div>
                            <small class="text-muted d-block" style="font-size: 0.75rem;">GeÃ§en Aya GÃ¶re</small>
                            <span class="fw-bold text-dark" id="lblPerfText">HesaplanÄ±yor...</span>
                        </div>
                        <div class="fw-bold text-primary" id="lblPerfPercent">%0</div>
                    </div>
                    <div class="progress" style="height: 10px; border-radius: 10px; background-color: #e2e8f0;">
                        <div id="progressBar" class="progress-bar bg-primary" role="progressbar" style="width: 0%; border-radius: 10px;"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2" style="font-size: 0.7rem;">
                        <span class="text-muted">GeÃ§en Ay: <span id="lblPrevMonthTotal" class="fw-bold text-dark">0</span> Lt</span>
                        <span class="text-muted">Bu Ay: <span id="lblCurrMonthTotal" class="fw-bold text-dark">0</span> Lt</span>
                    </div>
                </div>
            </div>

            <h6 class="fw-bold text-secondary small ps-1 mb-2">GÃœNLÃœK AKIÅž (Son KayÄ±tlar)</h6>
            <div class="d-flex gap-2 overflow-auto pb-2" id="dailySlider" style="white-space: nowrap; -webkit-overflow-scrolling: touch;">
                </div>
<h6 class="fw-bold text-secondary small ps-1 mb-2 mt-4">DUYURULAR</h6>
<div class="card border-0 shadow-sm mb-5" style="border-radius: 18px; overflow: hidden;">
    <div class="list-group list-group-flush" id="announcement-list">
        <div class="text-center py-4 text-muted small">
            <div class="spinner-border spinner-border-sm text-secondary mb-2"></div>
            <div>YÃ¼kleniyor...</div>
        </div>
    </div>
</div>
        </div>
    </div>
    <div id="page-milk" style="display: none;">
        <div class="bg-white px-3 pt-3 pb-4 shadow-sm mb-3 position-sticky top-0" style="z-index: 900; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;">
            <div class="d-flex align-items-center mb-3">
    <button class="btn btn-light rounded-circle shadow-sm me-3" 
            onclick="sayfaDegistir('page-home', document.getElementById('nav-home'))"
            style="width: 40px; height: 40px;">
        <i class="fa-solid fa-arrow-left text-primary"></i>
    </button>
    <h5 class="fw-bold text-dark m-0">SÃ¼t GeÃ§miÅŸim</h5>
</div>
            
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border-radius: 20px;">
                <div class="card-body d-flex justify-content-between align-items-center px-4 py-3">
                    <div>
                        <div class="small opacity-75 fw-bold text-uppercase mb-1" style="font-size: 0.7rem; letter-spacing: 1px;">BU AY TOPLANAN</div>
                        <div class="display-5 fw-bold"><span id="lblMonthlyMilk">0</span> <span class="fs-4">Lt</span></div>
                    </div>
                    <i class="fa-solid fa-cow fa-2x text-white opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="px-3 pb-3" id="milkList"></div>
    </div>
<div id="page-history" style="display: none;">
        <div class="bg-white px-3 pt-3 pb-4 shadow-sm mb-3 position-sticky top-0" style="z-index: 900; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold text-dark m-0 ps-1">YÄ±llÄ±k Ã–zet</h5>
                <select id="yearFilter" class="form-select form-select-sm border-0 bg-light fw-bold text-primary shadow-sm" style="width: 100px;">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                </select>
            </div>
            
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #0f766e 0%, #115e59 100%); color: white; border-radius: 20px;">
                <div class="card-body d-flex justify-content-between align-items-center px-4 py-3">
                    <div>
                        <div class="small opacity-75 fw-bold text-uppercase mb-1" style="font-size: 0.7rem; letter-spacing: 1px;">YILLIK GENEL TOPLAM</div>
                        <div class="display-5 fw-bold"><span id="lblYearlyTotal">0</span> <span class="fs-4">Lt</span></div>
                    </div>
                    <i class="fa-solid fa-calendar-check fa-2x text-white opacity-25"></i>
                </div>
            </div>
        </div>

        <div class="px-3 pb-5">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" style="font-size: 0.85rem;">
                        <thead class="bg-light border-bottom">
                            <tr class="text-secondary text-uppercase small text-center">
                                <th class="py-3 text-start ps-3">Ay</th>
                                <th class="text-primary fw-bold">AkÅŸam</th>
                                <th class="text-warning fw-bold">Sabah</th>
                                <th class="text-dark fw-bold pe-3 text-end">Toplam</th>
                            </tr>
                        </thead>
                        <tbody id="yearListBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="page-profile" style="display: none;" class="p-3">
        <h4 class="fw-bold text-dark mb-4">Profil & Ayarlar</h4>
        <div class="card border-0 shadow-sm mb-4 text-center p-4" style="border-radius: 20px;">
            <div class="bg-primary bg-opacity-10 text-primary rounded-circle mx-auto d-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px; font-size: 2rem;">
                <i class="fa-solid fa-user"></i>
            </div>
            <h5 class="fw-bold m-0" id="profName">-</h5>
            <small class="text-muted" id="profVillage">-</small>
        </div>

        <h6 class="text-muted small fw-bold ps-2 mb-2">KÄ°ÅžÄ°SEL BÄ°LGÄ°LER</h6>
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 20px; overflow: hidden;">
            <div class="list-group list-group-flush">
                <div class="list-group-item p-3 d-flex align-items-center">
                    <div class="icon-box bg-light text-secondary me-3"><i class="fa-solid fa-phone"></i></div>
                    <div>
                        <small class="text-muted d-block" style="font-size:0.7rem">Telefon</small>
                        <span class="fw-bold text-dark" id="profPhone">-</span>
                    </div>
                </div>
                <div class="list-group-item p-3 d-flex align-items-center">
                    <div class="icon-box bg-light text-secondary me-3"><i class="fa-solid fa-id-card"></i></div>
                    <div>
                        <small class="text-muted d-block" style="font-size:0.7rem">TC Kimlik</small>
                        <span class="fw-bold text-dark" id="profTc">-</span>
                    </div>
                </div>
            </div>
        </div>

        <h6 class="text-muted small fw-bold ps-2 mb-2">HESAP AYARLARI</h6>
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 20px; overflow: hidden;">
            <div class="list-group list-group-flush">
                <button onclick="sifreDegistir()" class="list-group-item list-group-item-action p-3 d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-warning bg-opacity-10 text-warning me-3"><i class="fa-solid fa-key"></i></div>
                        <span class="fw-bold text-dark">Åžifremi DeÄŸiÅŸtir</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-muted small"></i>
                </button>
            </div>
        </div>

        
        
        <div class="text-center text-muted small mb-5 opacity-50">
            KoopSistem v1.0
        </div>
    </div>
    <div id="page-account" style="display: none; padding-bottom: 80px;">
        
        <div class="bg-white px-3 pt-3 pb-3 shadow-sm mb-3 position-sticky top-0" style="z-index: 900; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;">
           <div class="d-flex justify-content-between align-items-center">
    
    <div class="d-flex align-items-center">
        <button class="btn btn-light rounded-circle shadow-sm me-3" 
                onclick="sayfaDegistir('page-home', document.getElementById('nav-home'))"
                style="width: 40px; height: 40px;">
            <i class="fa-solid fa-arrow-left text-primary"></i>
        </button>
        <div>
            <h5 class="fw-bold text-dark m-0">Hesap Ekstresi</h5>
            <small class="text-muted" id="accCoopName">Kooperatif</small>
        </div>
    </div>

    <input type="month" id="accMonthFilter" class="form-control form-control-sm border-primary text-primary fw-bold" style="width: 130px;">
</div>
        </div>

        <div id="account-content" class="px-3">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <div class="mt-2 text-muted">Hesap verileri alÄ±nÄ±yor...</div>
            </div>
        </div>

    </div>
<div id="page-animals" style="display: none; padding-bottom: 80px;">
    
    <div class="bg-white px-3 pt-3 pb-3 shadow-sm mb-3 position-sticky top-0" style="z-index: 900; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <button class="btn btn-light rounded-circle shadow-sm me-3" 
                        onclick="sayfaDegistir('page-home', document.getElementById('nav-home'))"
                        style="width: 40px; height: 40px;">
                    <i class="fa-solid fa-arrow-left text-primary"></i>
                </button>
                <div>
                    <h5 class="fw-bold text-dark m-0">Hayvan VarlÄ±ÄŸÄ±m</h5>
                    <small class="text-muted">Ã‡iftlik YÃ¶netimi</small>
                </div>
            </div>
            <button class="btn btn-sm btn-primary fw-bold rounded-pill px-3" onclick="yeniHayvanEkle()">
                <i class="fa-solid fa-plus me-1"></i> Ekle
            </button>
        </div>

        <div class="row g-2 text-center mb-3">
            <div class="col-3">
                <div class="bg-light p-2 rounded-3 border">
                    <small class="d-block text-muted" style="font-size:0.6rem">TOPLAM</small>
                    <span class="fw-bold text-dark" id="stat-total">0</span>
                </div>
            </div>
            <div class="col-3">
                <div class="bg-warning bg-opacity-10 p-2 rounded-3 border border-warning border-opacity-25">
                    <small class="d-block text-warning fw-bold" style="font-size:0.6rem">Ä°NEK</small>
                    <span class="fw-bold text-dark" id="stat-inek">0</span>
                </div>
            </div>
            <div class="col-3">
                <div class="bg-info bg-opacity-10 p-2 rounded-3 border border-info border-opacity-25">
                    <small class="d-block text-info fw-bold" style="font-size:0.6rem">GENÃ‡</small>
                    <span class="fw-bold text-dark" id="stat-genc">0</span>
                </div>
            </div>
            <div class="col-3">
                <div class="bg-danger bg-opacity-10 p-2 rounded-3 border border-danger border-opacity-25">
                    <small class="d-block text-danger fw-bold" style="font-size:0.6rem">ERKEK</small>
                    <span class="fw-bold text-dark" id="stat-erkek">0</span>
                </div>
            </div>
        </div>

        <div class="position-relative">
            <input type="text" id="animalSearch" class="form-control rounded-pill ps-5 bg-light border-0" placeholder="KÃ¼pe no ile ara..." onkeyup="hayvanAra()">
            <i class="fa-solid fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
        </div>
    </div>

    <div id="animal-list-container" class="px-3">
        </div>

</div>
    </div>

    
   <div class="bottom-nav">
        <button class="nav-item active" id="nav-home" onclick="sayfaDegistir('page-home', this)">
            <i class="fa-solid fa-house"></i> <span>Ana Sayfa</span>
        </button>
        
        <button class="nav-item" id="nav-milk" onclick="sayfaDegistir('page-history', this)">
            <i class="fa-solid fa-clock-rotate-left"></i> <span>GeÃ§miÅŸ</span>
        </button>
        
        <button class="nav-item" id="nav-profile" onclick="sayfaDegistir('page-profile', this)">
            <i class="fa-solid fa-user"></i> <span>Profil</span>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script type="module">
        // 'getDocs' eklendi
// SONA 'getDocs' EKLENDÄ° ðŸ‘‡
import { updatePassword, auth, db, signOut, onAuthStateChanged, doc, getDoc, updateDoc, collection, query, where, orderBy, limit, onSnapshot, getDocs, addDoc, deleteDoc } from "../js/firebase-config.js";
        let currentMemberId = null;
        let currentCoopId = null;
        let globalMilkSnapshot = null; // Verileri hafÄ±zada tutmak iÃ§in

        // 1. Sayfa AÃ§Ä±lÄ±nca Tarihi "Bu Ay" Yap
        const dateInput = document.getElementById('monthFilter');
        const now = new Date();
        const currentMonthStr = now.toISOString().slice(0, 7); // Ã–rn: "2023-12"
        if(dateInput) {
            dateInput.value = currentMonthStr;
            
            // Tarih deÄŸiÅŸince verileri tekrar sÃ¼z
            dateInput.addEventListener('change', () => {
                if(globalMilkSnapshot) {
                    verileriSuzVeYazdir(globalMilkSnapshot);
                }
            });
        }
// --- 4. GÃœÃ‡LENDÄ°RÄ°LMÄ°Åž GÄ°RÄ°Åž VE VERÄ° Ã‡EKME KODU ---
onAuthStateChanged(auth, async (user) => {
    if (user) {
        console.log("KullanÄ±cÄ± GiriÅŸ YaptÄ±:", user.uid);

        try {
            // 1. Users tablosundaki kullanÄ±cÄ± kaydÄ±nÄ± Ã§ek
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                
                // Rol KontrolÃ¼
                if(userData.role !== 'member' && userData.role !== 'uye') {
                    Swal.fire("Hata", "Bu panele sadece Ã¼reticiler girebilir.", "error");
                    await signOut(auth);
                    return;
                }

                let matchedMemberId = userData.relatedMemberId;
                
                // --- KESÄ°N Ã‡Ã–ZÃœM BURASI ---
                // EÄŸer bir ID varsa, bu ID gerÃ§ekten 'members' tablosunda yaÅŸÄ±yor mu kontrol et
                let isMemberAlive = false;
                if (matchedMemberId) {
                    const checkMember = await getDoc(doc(db, "members", matchedMemberId));
                    isMemberAlive = checkMember.exists();
                }

                // EÄžER:
                // 1. HiÃ§ ID yoksa (matchedMemberId yok)
                // 2. Ä°sim "Ä°simsiz" ise
                // 3. VEYA ID VAR AMA ÃœYE SÄ°LÄ°NMÄ°ÅžSE (!isMemberAlive) -> "Ã–lÃ¼ BaÄŸlantÄ±"
                if (!matchedMemberId || !userData.adSoyad || userData.adSoyad === 'Ä°simsiz' || !isMemberAlive) {
                    
                    console.log("BaÄŸlantÄ± kopuk veya Ã¼ye silinmiÅŸ! Telefon ile yeniden aranÄ±yor...");
                    
                    // Email'den saf numarayÄ± Ã§Ä±kar
                    let rawPhone = user.email.split('@')[0];
                    const phoneNoZero = rawPhone.startsWith('0') ? rawPhone.substring(1) : rawPhone;
                    const phoneWithZero = "0" + phoneNoZero;

                    // Telefonla Ãœyeyi Bul
                    const q1 = query(collection(db, "members"), where("telefon", "==", phoneNoZero));
                    const q2 = query(collection(db, "members"), where("telefon", "==", phoneWithZero));
                    
                    const snap1 = await getDocs(q1);
                    const snap2 = await getDocs(q2);
                    
                    let foundMember = null;
                    if (!snap1.empty) foundMember = snap1.docs[0];
                    else if (!snap2.empty) foundMember = snap2.docs[0];

                    if (foundMember) {
                        const mData = foundMember.data();
                        
                        console.log("Ãœye Tekrar Bulundu! BaÄŸlantÄ± tamir ediliyor: ", mData.ad);
                        
                        // Users Tablosunu YENÄ° ID ile GÃ¼ncelle
                        await updateDoc(userDocRef, { 
                            relatedMemberId: foundMember.id, // Yeni ID'yi yaz
                            coopId: mData.coopId,
                            adSoyad: `${mData.ad} ${mData.soyad}`,
                            role: 'member'
                        });
                        
                        // Hemen ekrana yansÄ±t
                        uyeBilgileriniGetir(foundMember.id);

                    } else {
                        // Telefonla da bulunamadÄ±ysa gerÃ§ekten silinmiÅŸtir.
                        Swal.fire("Hata", "KaydÄ±nÄ±z silinmiÅŸ veya telefon numaranÄ±z uyuÅŸmuyor. YÃ¶neticiyle gÃ¶rÃ¼ÅŸÃ¼n.", "warning");
                    }
                } else {
                    // BaÄŸlantÄ± saÄŸlamsa normal devam et
                    console.log("BaÄŸlantÄ± saÄŸlam, veriler Ã§ekiliyor...");
                    currentMemberId = matchedMemberId;
                    currentCoopId = userData.coopId;
                    uyeBilgileriniGetir(matchedMemberId);
                }

            } else {
                Swal.fire("Hata", "KullanÄ±cÄ± profili bulunamadÄ±.", "error");
            }
        } catch (error) {
            console.error("GiriÅŸ HatasÄ± DetayÄ±:", error);
        }
    } else {
        window.location.href = "../index.html";
    }
});

        async function uyeBilgileriniGetir(uid) {
            let memberDoc = await getDoc(doc(db, "members", uid));
            if(memberDoc.exists()) {
                const mData = memberDoc.data();
                // Karttaki Ä°sim
                const lblMem = document.getElementById("lblMemberName");
                if(lblMem) lblMem.innerText = `Sn. ${mData.ad} ${mData.soyad}`;
                
                // Profil SayfasÄ± Bilgileri
                document.getElementById("profName").innerText = `${mData.ad} ${mData.soyad}`;
                document.getElementById("profVillage").innerText = mData.koy || "-";
                document.getElementById("profPhone").innerText = mData.telefon || "-";
                document.getElementById("profTc").innerText = mData.tc || "-";
            }
            bakiyeyiDinle(uid); // Bakiye her zaman "Genel Toplam"dÄ±r
            sutleriDinle(uid);  // SÃ¼tler tarihe gÃ¶re deÄŸiÅŸir
            document.getElementById("loader").style.display = "none";
            dogumBildirimiYap(uid);
            duyurulariGetir();
        }

        // BAKÄ°YE HESAPLAMA (Ekranda Gizli, Arka Planda Ã‡alÄ±ÅŸÄ±r)
        function bakiyeyiDinle(uid) {
            const q = query(collection(db, "transactions"), where("memberId", "==", uid));
            onSnapshot(q, (snapshot) => {
                let totalAlacak = 0; let totalBorc = 0;
                snapshot.forEach(doc => {
                    const t = doc.data();
                    const amount = Number(t.amount);
                    if(t.type === 'alacak') totalAlacak += amount;
                    else totalBorc += amount;
                });
                // Bakiye hesaplandÄ± ama ekrana yazdÄ±rmÄ±yoruz (istek Ã¼zerine)
                console.log("GÃ¼ncel Bakiye:", totalAlacak - totalBorc);
            });
        }

   // SÃœT VERÄ°LERÄ°NÄ° Ã‡EKME (DEDEKTÄ°F MODU)
        function sutleriDinle(uid) {
            console.log("SÃ¼tler aranÄ±yor... Aranan Ãœye ID:", uid);

            const q = query(
                collection(db, "milk_records"),
                where("memberId", "==", uid),
                orderBy("date", "desc")
            );

            onSnapshot(q, (snapshot) => {
                globalMilkSnapshot = snapshot; 
                
                console.log("------- SÃœT SORGUSU SONUCU -------");
                console.log("Bulunan Toplam KayÄ±t SayÄ±sÄ±:", snapshot.size);
                
                if (snapshot.size > 0) {
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        console.log("Bulunan KayÄ±t:", d.dateString, d.liters, "Lt");
                    });
                } else {
                    console.warn("BU ÃœYE Ä°Ã‡Ä°N HÄ°Ã‡ SÃœT KAYDI YOK! (VeritabanÄ±nda bu ID ile eÅŸleÅŸen kayÄ±t yok)");
                }
                console.log("----------------------------------");

                // 1. Ana Sayfa (GÃ¼nlÃ¼k/AylÄ±k) gÃ¼ncelle
                verileriSuzVeYazdir(snapshot); 
                
                // 2. GeÃ§miÅŸ SayfasÄ± (YÄ±llÄ±k Ã–zet) gÃ¼ncelle
                if(typeof gecmisSayfayiGuncelle === 'function') {
                    gecmisSayfayiGuncelle(snapshot);
                }
            });
        }
        // --- YENÄ°: GEÃ‡MÄ°Åž SAYFASI Ä°Ã‡Ä°N YILLIK Ã–ZET ---
        function gecmisSayfayiGuncelle(snapshot) {
            const selectedYear = document.getElementById('yearFilter').value; // Ã–rn: "2025"
            let monthsData = {};
            let yearlyTotal = 0;

            // 12 Ay Ä°Ã§in BoÅŸ Veri OluÅŸtur
            for(let i=0; i<12; i++) {
                monthsData[i] = { sabah: 0, aksam: 0, total: 0 };
            }

            snapshot.forEach(doc => {
                const d = doc.data();
                const recordDate = d.date.toDate();
                const recordYear = recordDate.getFullYear().toString();
                
                // Sadece seÃ§ili yÄ±lÄ±n verilerini al
                if(recordYear === selectedYear) {
                    const monthIndex = recordDate.getMonth(); // 0 = Ocak, 11 = AralÄ±k
                    const miktar = Number(d.liters);

                    if(d.period === 'sabah') monthsData[monthIndex].sabah += miktar;
                    else monthsData[monthIndex].aksam += miktar;
                    
                    monthsData[monthIndex].total += miktar;
                    yearlyTotal += miktar;
                }
            });

            // YÄ±llÄ±k ToplamÄ± Yaz
            document.getElementById("lblYearlyTotal").innerText = yearlyTotal.toLocaleString('tr-TR');

            // Tabloyu Doldur
            const tbody = document.getElementById("yearListBody");
            let html = "";
            const monthNames = ["Ocak", "Åžubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];

            // Aylar ters sÄ±rada deÄŸil, Ocak'tan AralÄ±k'a (veya tam tersi) sÄ±ralanabilir. Genelde tabloda Ocak en Ã¼stte durur.
            for(let i=0; i<12; i++) {
                // EÄŸer o ay hiÃ§ veri yoksa "-" koyalÄ±m, varsa sayÄ±yÄ± yazalÄ±m
                const row = monthsData[i];
                // Sadece verisi olan aylarÄ± mÄ± gÃ¶sterelim yoksa hepsini mi? Hepsini gÃ¶stermek tablo bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ iÃ§in iyidir.
                // Ä°steÄŸe baÄŸlÄ±: if(row.total === 0) continue; // BoÅŸ aylarÄ± gizlemek isterseniz bu satÄ±rÄ± aÃ§Ä±n.

                const aksamVal = row.aksam > 0 ? row.aksam : '-';
                const sabahVal = row.sabah > 0 ? row.sabah : '-';
                const totalVal = row.total > 0 ? `<span class="badge bg-dark rounded-pill">${row.total}</span>` : '-';

                html += `
                <tr>
                    <td class="ps-3 fw-bold text-secondary">${monthNames[i]}</td>
                    <td class="text-center text-primary bg-primary bg-opacity-10 fw-bold">${aksamVal}</td>
                    <td class="text-center text-warning bg-warning bg-opacity-10 fw-bold">${sabahVal}</td>
                    <td class="text-end pe-3 fw-bold">${totalVal}</td>
                </tr>
                `;
            }
            tbody.innerHTML = html;
        }

        // YÄ±l Filtresi DeÄŸiÅŸince Ã‡alÄ±ÅŸacak Kod
        const yearSelect = document.getElementById('yearFilter');
        if(yearSelect) {
            // Åžimdiki yÄ±lÄ± varsayÄ±lan seÃ§
            yearSelect.value = new Date().getFullYear();
            
            yearSelect.addEventListener('change', () => {
                if(globalMilkSnapshot) {
                    gecmisSayfayiGuncelle(globalMilkSnapshot);
                }
            });
        }

        // --- YENÄ° FÄ°LTRELEME VE YAZDIRMA FONKSÄ°YONU ---
        function verileriSuzVeYazdir(snapshot) {
            const selectedMonth = document.getElementById('monthFilter').value; // "2023-12"
            
            // Etiketi GÃ¼ncelle (Ã–rn: AralÄ±k 2023)
            const dateObj = new Date(selectedMonth);
            const monthName = dateObj.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
            document.getElementById("lblSelectedMonth").innerText = monthName;

            let groupedData = {};
            let totalsByDate = {}; 
            let aylikToplam = 0;

            snapshot.forEach(doc => {
                const d = doc.data();
                
                // --- TARÄ°H FÄ°LTRESÄ° ---
                const recordDate = d.date.toDate(); 
                const recordMonthStr = recordDate.toISOString().slice(0, 7); // "2023-12"

                // EÄŸer kayÄ±t tarihi, seÃ§ilen aya EÅžÄ°T DEÄžÄ°LSE bu kaydÄ± geÃ§
                if (recordMonthStr !== selectedMonth) return;
                // ----------------------

                const dateKey = recordDate.toLocaleDateString('en-CA');

                if(!groupedData[dateKey]) {
                    groupedData[dateKey] = {
                        dateObj: recordDate,
                        sabah: 0,
                        aksam: 0,
                        total: 0
                    };
                }

                const miktar = Number(d.liters);
                if(d.period === 'sabah') groupedData[dateKey].sabah += miktar;
                else groupedData[dateKey].aksam += miktar;
                groupedData[dateKey].total += miktar;
                
                aylikToplam += miktar;

                if(!totalsByDate[dateKey]) totalsByDate[dateKey] = 0;
                totalsByDate[dateKey] += miktar;
            });

            // 1. GrafiÄŸi GÃ¼ncelle
            paneliGuncelle(snapshot, selectedMonth, aylikToplam);

            // 2. Listeyi GÃ¼ncelle
            const listDiv = document.getElementById("milkList");
            if(listDiv) {
                const rows = Object.values(groupedData).sort((a,b) => b.dateObj - a.dateObj);
                
                // Tablo BaÅŸlangÄ±cÄ±
                let html = `
                <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" style="font-size: 0.9rem;">
                            <thead class="bg-light border-bottom">
                                <tr class="text-secondary text-uppercase small">
                                    <th class="ps-4 py-3">Tarih</th>
                                    <th class="text-center text-primary fw-bold">AkÅŸam</th>
                                    <th class="text-center text-warning fw-bold">Sabah</th>
                                    <th class="text-end pe-4 text-dark fw-bold">Toplam</th>
                                </tr>
                            </thead>
                            <tbody>`;

                if(rows.length === 0) {
                    html += `<tr><td colspan="4" class="text-center py-5 text-muted">Bu ayda kayÄ±t bulunamadÄ±.</td></tr>`;
                } else {
                    rows.forEach(row => {
                        const dateStr = row.dateObj.toLocaleDateString('tr-TR', {day:'numeric', month:'short'});
                        const dayName = row.dateObj.toLocaleDateString('tr-TR', {weekday:'short'});
                        
                        html += `
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold text-dark">${dateStr}</div>
                                <small class="text-muted" style="font-size:0.75rem">${dayName}</small>
                            </td>
                            <td class="text-center fw-bold text-primary bg-primary bg-opacity-10">${row.aksam || '-'}</td>
                            <td class="text-center fw-bold text-warning bg-warning bg-opacity-10">${row.sabah || '-'}</td>
                            <td class="text-end pe-4">
                                <span class="badge bg-dark text-white rounded-pill">${row.total} Lt</span>
                            </td>
                        </tr>`;
                    });
                }
                html += `</tbody></table></div></div>`;
                listDiv.innerHTML = html;
            }

            // 3. AylÄ±k Toplam KartÄ±nÄ± GÃ¼ncelle
            const lblMonthly = document.getElementById("lblMonthlyMilk");
            if(lblMonthly) lblMonthly.innerText = aylikToplam.toLocaleString('tr-TR');
        }
// ESKÄ° grafigiGuncelle fonksiyonunu tamamen silebilirsiniz.
        // YERÄ°NE BU FONKSÄ°YONU EKLEYÄ°N:

        function paneliGuncelle(snapshot, selectedMonth, currentMonthTotal) {
            // 1. Ã–NCEKÄ° AYI BUL VE HESAPLA
            const [year, month] = selectedMonth.split('-').map(Number);
            // Bir Ã¶nceki ayÄ± hesapla (Ocak ise bir Ã¶nceki yÄ±lÄ±n AralÄ±ÄŸÄ±na git)
            const prevDate = new Date(year, month - 2, 1); 
            const prevMonthStr = prevDate.toISOString().slice(0, 7); // Ã–rn: "2025-11"
            
            let prevMonthTotal = 0;
            let dailyRecords = []; // Slider iÃ§in kayÄ±tlar

            snapshot.forEach(doc => {
                const d = doc.data();
                const rDate = d.date.toDate();
                const rMonthStr = rDate.toISOString().slice(0, 7);
                const dayKey = rDate.toLocaleDateString('tr-TR', {day:'numeric', month:'short'});
                
                // Ã–nceki ay toplamÄ±
                if(rMonthStr === prevMonthStr) {
                    prevMonthTotal += Number(d.liters);
                }

                // Slider iÃ§in SADECE SEÃ‡Ä°LÄ° AYIN verilerini topla
                if(rMonthStr === selectedMonth) {
                   // AynÄ± gÃ¼n varsa Ã¼stÃ¼ne ekle (Sabah+AkÅŸam birleÅŸsin diye)
                   let existing = dailyRecords.find(x => x.dayKey === dayKey);
                   if(existing) {
                       existing.total += Number(d.liters);
                       if(d.period === 'sabah') existing.sabah += Number(d.liters);
                       else existing.aksam += Number(d.liters);
                   } else {
                       dailyRecords.push({
                           dateObj: rDate,
                           dayKey: dayKey,
                           fullDate: rDate.toLocaleDateString('tr-TR', {weekday:'short'}),
                           total: Number(d.liters),
                           sabah: d.period === 'sabah' ? Number(d.liters) : 0,
                           aksam: d.period === 'aksam' ? Number(d.liters) : 0
                       });
                   }
                }
            });

            // --- PERFORMANS KARTINI GÃœNCELLE ---
            document.getElementById("lblPrevMonthTotal").innerText = prevMonthTotal;
            document.getElementById("lblCurrMonthTotal").innerText = currentMonthTotal;

            let percent = 0;
            let barWidth = 0;
            let textDurum = "Veri Yok";

            if (prevMonthTotal > 0) {
                // YÃ¼zde hesapla
                const diff = currentMonthTotal - prevMonthTotal;
                percent = Math.round((diff / prevMonthTotal) * 100);
                
                // Bar doluluk oranÄ± (Max %100 olsun diye sÄ±nÄ±rladÄ±k)
                barWidth = Math.min(Math.round((currentMonthTotal / prevMonthTotal) * 100), 100);
                
                if(currentMonthTotal >= prevMonthTotal) {
                    textDurum = "GeÃ§en ayÄ± geÃ§tiniz!";
                    document.getElementById("lblPerfPercent").className = "fw-bold text-success";
                    document.getElementById("lblPerfPercent").innerText = `+${percent}%`;
                    document.getElementById("progressBar").className = "progress-bar bg-success";
                } else {
                    textDurum = "GeÃ§en ayÄ±n gerisinde";
                    document.getElementById("lblPerfPercent").className = "fw-bold text-danger";
                    document.getElementById("lblPerfPercent").innerText = `${percent}%`;
                    document.getElementById("progressBar").className = "progress-bar bg-warning";
                }
            } else {
                // Ã–nceki ay veri yoksa
                textDurum = "GeÃ§miÅŸ veri yok";
                barWidth = 100; 
                document.getElementById("lblPerfPercent").innerText = "-";
            }
            
            document.getElementById("lblPerfText").innerText = textDurum;
            document.getElementById("progressBar").style.width = `${barWidth}%`;


            // --- SLIDER (YATAY KARTLAR) GÃœNCELLE ---
            // Tarihe gÃ¶re yeniden eskiye sÄ±rala
            dailyRecords.sort((a,b) => b.dateObj - a.dateObj);
            
            const sliderDiv = document.getElementById("dailySlider");
            let sliderHtml = "";

            if(dailyRecords.length === 0) {
                sliderHtml = `<div class="text-muted small w-100 text-center py-3">Bu ay iÃ§in henÃ¼z kayÄ±t yok.</div>`;
            } else {
                dailyRecords.forEach(rec => {
                    sliderHtml += `
                    <div class="card border-0 shadow-sm" style="min-width: 130px; border-radius: 16px; background-color: #fff;">
                        <div class="card-body p-2 text-center">
                            <span class="badge bg-light text-secondary mb-1" style="font-weight: normal;">${rec.fullDate}</span>
                            <h6 class="fw-bold text-dark m-0 mb-1" style="font-size: 0.9rem;">${rec.dayKey}</h6>
                            <div class="fw-bold text-primary fs-5 mb-1">${rec.total} Lt</div>
                            <div style="font-size: 0.65rem;" class="text-muted opacity-75">
                                <span>S: ${rec.sabah}</span> | <span>A: ${rec.aksam}</span>
                            </div>
                        </div>
                    </div>
                    `;
                });
            }
            sliderDiv.innerHTML = sliderHtml;
        }
        // GRAFÄ°K GÃœNCELLEME (SeÃ§ilen ayÄ±n gÃ¼nlerine gÃ¶re)
        function grafigiGuncelle(totalsByDate, selectedMonth) {
            const labels = [];
            const dataValues = [];
            
            // SeÃ§ilen ayÄ±n kaÃ§ gÃ¼n Ã§ektiÄŸini bul
            const [year, month] = selectedMonth.split('-');
            const daysInMonth = new Date(year, month, 0).getDate();

            for(let i=1; i<=daysInMonth; i++) {
                const dayStr = String(i).padStart(2, '0');
                const key = `${selectedMonth}-${dayStr}`;
                
                labels.push(i); 
                dataValues.push(totalsByDate[key] || 0);
            }

            if(window.myMilkChart) window.myMilkChart.destroy();
            const ctx = document.getElementById('milkChart');
            if(ctx) {
                window.myMilkChart = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{ 
                            label: 'Litre', 
                            data: dataValues, 
                            backgroundColor: '#ea580c', 
                            borderRadius: 3,
                            barThickness: 'flex', 
                            maxBarThickness: 15
                        }]
                    },
                    options: {
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { 
                            x: { grid: { display: false }, ticks: { font: {size: 10} } }, 
                            y: { beginAtZero: true, grid: { borderDash: [5, 5] } } 
                        }
                    }
                });
            }
        }

       window.sayfaDegistir = function(sayfaId, element) {
    // 1. TÃ¼m sayfalarÄ± gizle (Account sayfasÄ± dahil)
    document.getElementById("page-home").style.display = "none";
    document.getElementById("page-milk").style.display = "none";
    document.getElementById("page-history").style.display = "none";
    document.getElementById("page-profile").style.display = "none";
    
    // EKSÄ°K OLAN SATIR BU ðŸ‘‡
    document.getElementById("page-account").style.display = "none"; 
    
    // 2. Ä°stenen sayfayÄ± aÃ§
    const target = document.getElementById(sayfaId);
    if(target) target.style.display = "block";
    
    // 3. MenÃ¼ aktifliÄŸini ayarla
    if(element) {
        document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));
        element.classList.add("active");
    }
    window.scrollTo(0, 0);
}
        // Ã‡IKIÅž YAP
        window.cikisYap = async function() {
            Swal.fire({
                title: 'Ã‡Ä±kÄ±ÅŸ?', text: "Oturumu kapatmak istiyor musunuz?", icon: 'question',
                showCancelButton: true, confirmButtonText: 'Evet, Ã‡Ä±k', confirmButtonColor: '#d33'
            }).then(async (result) => {
                if (result.isConfirmed) { await signOut(auth); window.location.href = "../index.html"; }
            });
        }

        // ÅžÄ°FRE DEÄžÄ°ÅžTÄ°R
        window.sifreDegistir = async function() {
             const { value: formValues } = await Swal.fire({
                title: 'Åžifre DeÄŸiÅŸtir',
                html: '<input id="swal-pass1" class="form-control mb-2" placeholder="Yeni Åžifre" type="password">' +
                      '<input id="swal-pass2" class="form-control" placeholder="Yeni Åžifre (Tekrar)" type="password">',
                focusConfirm: false, showCancelButton: true, confirmButtonText: 'GÃ¼ncelle',
                preConfirm: () => { return [document.getElementById('swal-pass1').value, document.getElementById('swal-pass2').value] }
            });

            if (formValues) {
                const [p1, p2] = formValues;
                if(p1.length < 6) return Swal.fire('Hata', 'En az 6 karakter olmalÄ±.', 'warning');
                if(p1 !== p2) return Swal.fire('Hata', 'Åžifreler uyuÅŸmuyor.', 'error');
                try {
                    await updatePassword(auth.currentUser, p1);
                    Swal.fire('BaÅŸarÄ±lÄ±', 'Åžifre gÃ¼ncellendi.', 'success');
                } catch (e) {
                    Swal.fire('Hata', e.message, 'error');
                }
            }
        }

// --- 1. HAYVANLARI GETÄ°R (KURU DÃ–NEM UYARILI) ---
window.hayvanlariGetir = function() {
    const container = document.getElementById("animal-list-container");
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

    const q = query(collection(db, "animals"), where("memberId", "==", currentMemberId));

    onSnapshot(q, (snapshot) => {
        container.innerHTML = "";
        
        if (snapshot.empty) {
            container.innerHTML = '<div class="text-center py-5 text-muted opacity-75"><i class="fa-solid fa-paw fa-3x mb-3"></i><h5>KayÄ±t Yok</h5><p>Hayvan eklemek iÃ§in yukarÄ±daki + butonuna basÄ±n.</p></div>';
            ['total', 'inek', 'genc', 'erkek'].forEach(k => document.getElementById(`stat-${k}`).innerText = '0');
            return;
        }

        let countTotal = 0, countInek = 0, countGenc = 0, countErkek = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            countTotal++;

            if(data.cinsiyet === 'Erkek') countErkek++;
            else if(data.tur === 'Ä°nek') countInek++;
            else countGenc++;

            // YAÅž HESABI
            let yasText = "YaÅŸ Bilinmiyor";
            if(data.dogumTarihi) {
                const diff = new Date() - new Date(data.dogumTarihi);
                const ageMonth = Math.floor(diff / (1000 * 60 * 60 * 24 * 30.44));
                if(ageMonth < 12) yasText = `${ageMonth} AylÄ±k`;
                else yasText = `${Math.floor(ageMonth/12)} YaÅŸÄ±nda`;
            }

            // GEBELÄ°K VE KURUYA AYIRMA HESABI
            let gebelikBadge = '';
            let altBilgiKutusu = '';
            
            if (data.gebelik === 'Gebe' && data.tohumlamaTarihi) {
                const tohumlama = new Date(data.tohumlamaTarihi);
                const bugun = new Date();
                
                // DoÄŸum Tarihi (285 GÃ¼n)
                const tahminiDogum = new Date(tohumlama);
                tahminiDogum.setDate(tohumlama.getDate() + 285);
                
                // Kalan GÃ¼n
                const farkZaman = tahminiDogum - bugun;
                const kalanGun = Math.ceil(farkZaman / (1000 * 60 * 60 * 24));

                // --- YENÄ° EKLENEN: KURU DÃ–NEM HESABI ---
                // DoÄŸuma 60 gÃ¼nden az kaldÄ±ysa ve henÃ¼z doÄŸmadÄ±ysa
                let kuruUyari = '';
                if (kalanGun <= 60 && kalanGun > 0) {
                    kuruUyari = `<div class="alert alert-warning d-flex align-items-center p-2 mb-2 mt-2" role="alert" style="font-size: 0.8rem;">
                                    <i class="fa-solid fa-triangle-exclamation me-2 fs-5"></i>
                                    <div>
                                        <strong>DÄ°KKAT!</strong> HayvanÄ± kuruya ayÄ±rma zamanÄ± geldi.<br>
                                        <small>DoÄŸuma ${kalanGun} gÃ¼n kaldÄ±.</small>
                                    </div>
                                 </div>`;
                }
                // ---------------------------------------

                if (kalanGun > 0) {
                    gebelikBadge = `<span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 ms-1"><i class="fa-solid fa-baby me-1"></i>Gebe</span>`;
                    
                    // Alt bilgi kutusu (Normal SayaÃ§ + Kuru UyarÄ±sÄ±)
                    altBilgiKutusu = `
                        ${kuruUyari}
                        <div class="mt-2 p-2 bg-light rounded border border-danger border-opacity-25 text-center">
                            <small class="text-danger fw-bold d-block">DOÄžUMA KALAN</small>
                            <span class="fw-bold text-dark fs-5">${kalanGun} GÃ¼n</span>
                            <small class="text-muted d-block" style="font-size:0.65rem">Tahmini: ${tahminiDogum.toLocaleDateString('tr-TR')}</small>
                        </div>`;
                } else {
                    gebelikBadge = `<span class="badge bg-success ms-1">DOÄžUM ZAMANI!</span>`;
                    altBilgiKutusu = `<div class="mt-2 p-2 bg-success text-white rounded text-center fw-bold">DOÄžUM BEKLENÄ°YOR</div>`;
                }
            }

            // Kart Ä°kon ve Renk
            let icon = 'fa-cow';
            let color = 'text-warning';
            if(data.cinsiyet === 'Erkek') { color = 'text-danger'; }
            
            const html = `
            <div class="card border-0 shadow-sm mb-3 animal-card" data-kupe="${data.kupeNo.toLowerCase()}" style="border-radius: 16px; overflow:hidden;">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        
                        <div class="d-flex align-items-center">
                            <div class="bg-light ${color} rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="fa-solid ${icon}"></i>
                            </div>
                            <div>
                                <h6 class="fw-bold text-dark m-0 fs-5">
                                    ${data.kupeNo}
                                    ${data.rumuz ? `<span class="text-muted fw-normal small ms-1">(${data.rumuz})</span>` : ''}
                                    ${gebelikBadge}
                                </h6>
                                <div class="small text-muted mt-1">
                                    <span class="badge bg-light text-dark border me-1">${data.irk || 'Irk Yok'}</span>
                                    <span class="badge bg-light text-secondary border me-1">${data.tur || '-'}</span>
                                    <span class="text-secondary" style="font-size:0.75rem"><i class="fa-regular fa-clock me-1"></i>${yasText}</span>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            ${data.gebelik === 'Gebe' ? 
                            `<button class="btn btn-success btn-sm text-white shadow-sm" onclick="dogumKaydet('${doc.id}', '${data.kupeNo}', '${data.irk || ''}')" title="DoÄŸum GerÃ§ekleÅŸti">
                                <i class="fa-solid fa-baby-carriage"></i>
                            </button>` : ''}

                            <button class="btn btn-light text-primary btn-sm border" onclick="hayvanDuzenle('${doc.id}', '${data.kupeNo}', '${data.gebelik || 'Bos'}', '${data.tohumlamaTarihi || ''}', '${data.tohumlamaTipi || 'Suni'}')">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            
                            <button class="btn btn-light text-danger btn-sm border" onclick="hayvanSil('${doc.id}')">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    ${altBilgiKutusu}
                    
                </div>
            </div>`;
            
            container.innerHTML += html;
        });

        document.getElementById("stat-total").innerText = countTotal;
        document.getElementById("stat-inek").innerText = countInek;
        document.getElementById("stat-genc").innerText = countGenc;
        document.getElementById("stat-erkek").innerText = countErkek;
    });
}
// --- 7. YEM VE MALZEME SÄ°PARÄ°ÅžÄ° ---
window.malzemeSiparisiVer = async function() {
    // Ã–rnek ÃœrÃ¼n Listesi (Ä°leride veritabanÄ±ndan Ã§ekilebilir)
    const urunListesi = `
        <option value="SÃ¼t Yemi (50kg)">SÃ¼t Yemi (50kg Ã‡uval)</option>
        <option value="Besi Yemi (50kg)">Besi Yemi (50kg Ã‡uval)</option>
        <option value="BuzaÄŸÄ± BaÅŸlangÄ±Ã§">BuzaÄŸÄ± BaÅŸlangÄ±Ã§ Yemi</option>
        <option value="Kuru DÃ¶nem Yemi">Kuru DÃ¶nem Yemi</option>
        <option value="Yalama TaÅŸÄ±">Yalama TaÅŸÄ± (Blok)</option>
        <option value="MÄ±sÄ±r SilajÄ±">MÄ±sÄ±r SilajÄ± (Paket)</option>
    `;

    const { value: formValues } = await Swal.fire({
        title: 'Yem / Malzeme SipariÅŸi',
        html: `
            <div class="text-start">
                <div class="alert alert-info small p-2 mb-3">
                    <i class="fa-solid fa-truck me-1"></i> SipariÅŸiniz kooperatife iletilecek ve cari hesabÄ±nÄ±za iÅŸlenecektir.
                </div>

                <label class="small fw-bold text-muted mb-1">ÃœrÃ¼n SeÃ§iniz</label>
                <select id="ord-urun" class="form-select mb-3">
                    ${urunListesi}
                </select>

                <div class="row g-2">
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">Miktar</label>
                        <input type="number" id="ord-adet" class="form-control fw-bold" value="1" min="1">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">Teslimat</label>
                        <select id="ord-teslimat" class="form-select">
                            <option value="Adrese Teslim">Adrese Gelsin</option>
                            <option value="Gelip AlacaÄŸÄ±m">Ben AlacaÄŸÄ±m</option>
                        </select>
                    </div>
                </div>
                
                <label class="small fw-bold text-muted mt-2 mb-1">Notunuz (Opsiyonel)</label>
                <textarea id="ord-not" class="form-control" rows="2" placeholder="Ã–rn: SÃ¼t arabasÄ±yla gÃ¶nderin..."></textarea>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'SipariÅŸi Onayla',
        confirmButtonColor: '#0891b2',
        cancelButtonText: 'VazgeÃ§',
        preConfirm: () => {
            return {
                urun: document.getElementById('ord-urun').value,
                adet: document.getElementById('ord-adet').value,
                teslimat: document.getElementById('ord-teslimat').value,
                not: document.getElementById('ord-not').value
            }
        }
    });

    if (formValues) {
        if(formValues.adet < 1) return Swal.fire("Hata", "En az 1 adet seÃ§melisiniz.", "warning");

        Swal.fire({title: 'SipariÅŸ Ä°letiliyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

        try {
            // SÄ°PARÄ°ÅžÄ° KAYDET (Orders Koleksiyonuna)
            await addDoc(collection(db, "orders"), {
                memberId: currentMemberId,
                coopId: currentCoopId,
                memberName: document.getElementById("lblMemberName").innerText.replace('Sn. ', ''), // Ä°smi al
                urunAdi: formValues.urun,
                miktar: Number(formValues.adet),
                teslimatTipi: formValues.teslimat,
                not: formValues.not,
                durum: 'Bekliyor', // Bekliyor, OnaylandÄ±, Teslim Edildi
                siparisTarihi: new Date()
            });

            Swal.fire({
                icon: 'success',
                title: 'SipariÅŸ AlÄ±ndÄ±!',
                text: 'Talebiniz kooperatif yetkilisine iletildi.',
                timer: 2000,
                showConfirmButton: false
            });

        } catch (error) {
            console.error(error);
            Swal.fire("Hata", "SipariÅŸ oluÅŸturulamadÄ±: " + error.message, "error");
        }
    }
}
// --- 4. HAYVAN DÃœZENLE (DÃœZELTÄ°LMÄ°Åž VERSÄ°YON) ---
window.hayvanDuzenle = async function(docId, kupeNo, mevcutGebelik, mevcutTarih, mevcutTip) {
    const { value: formValues } = await Swal.fire({
        title: `DÃ¼zenle: ${kupeNo}`,
        html: `
            <div class="text-start">
                <div class="alert alert-info small p-2 mb-3">
                    <i class="fa-solid fa-info-circle me-1"></i> Sadece gebelik durumunu buradan gÃ¼ncelleyebilirsiniz.
                </div>

                <label class="small fw-bold text-primary mb-1">Gebelik Durumu</label>
                <select id="edit-gebelik" class="form-select mb-3">
                    <option value="Bos" ${mevcutGebelik === 'Bos' ? 'selected' : ''}>BoÅŸ (Gebe DeÄŸil)</option>
                    <option value="Gebe" ${mevcutGebelik === 'Gebe' ? 'selected' : ''}>Gebe / TohumlandÄ±</option>
                </select>
                
                <div id="edit-detay-div" style="display: ${mevcutGebelik === 'Gebe' ? 'block' : 'none'};">
                    <label class="small fw-bold text-muted mb-1">Tohumlama Tarihi</label>
                    <input type="date" id="edit-tohumlama" class="form-control mb-2" value="${mevcutTarih}">
                    
                    <label class="small fw-bold text-muted mb-1">Tohumlama Tipi</label>
                    <select id="edit-tip" class="form-select">
                        <option value="Suni" ${mevcutTip === 'Suni' ? 'selected' : ''}>Suni Tohumlama (Veteriner)</option>
                        <option value="Tabii" ${mevcutTip === 'Tabii' ? 'selected' : ''}>Tabii Tohumlama (BoÄŸa)</option>
                    </select>
                </div>
            </div>
        `,
        // --- DEÄžÄ°ÅžÄ°KLÄ°K BURADA: Pencere aÃ§Ä±lÄ±nca bu kod Ã§alÄ±ÅŸÄ±r ---
        didOpen: () => {
            const selectBox = document.getElementById('edit-gebelik');
            const detayDiv = document.getElementById('edit-detay-div');
            
            // SeÃ§im deÄŸiÅŸince Ã§alÄ±ÅŸacak kod
            selectBox.addEventListener('change', function() {
                if (this.value === 'Gebe') {
                    detayDiv.style.display = 'block';
                } else {
                    detayDiv.style.display = 'none';
                }
            });
        },
        // ----------------------------------------------------------
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'GÃ¼ncelle',
        confirmButtonColor: '#0284c7',
        preConfirm: () => {
            return {
                gebelik: document.getElementById('edit-gebelik').value,
                tarih: document.getElementById('edit-tohumlama').value,
                tip: document.getElementById('edit-tip').value
            }
        }
    });

    if (formValues) {
        // DoÄŸrulama
        if(formValues.gebelik === 'Gebe' && !formValues.tarih) {
            return Swal.fire("Eksik Bilgi", "Gebe seÃ§tiyseniz tarih girmelisiniz!", "warning");
        }

        try {
            // VeritabanÄ±nÄ± GÃ¼ncelle
            await updateDoc(doc(db, "animals", docId), {
                gebelik: formValues.gebelik,
                tohumlamaTarihi: formValues.tarih,
                tohumlamaTipi: formValues.tip
            });

            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
            Toast.fire({icon: 'success', title: 'Bilgiler GÃ¼ncellendi'});

        } catch (error) {
            Swal.fire("Hata", error.message, "error");
        }
    }
}

// --- 6. DOÄžUM KAYDI (Ã‡OKLU / Ä°KÄ°Z DOÄžUM DESTEKLÄ°) ---
window.dogumKaydet = async function(anneId, anneKupe, anneIrk) {
    const bugun = new Date().toISOString().split('T')[0];

    // BuzaÄŸÄ± SatÄ±rÄ± HTML Åžablonu
    const buzagiSatiriHTML = `
        <div class="buzagi-satir border rounded p-2 mb-2 bg-light position-relative">
            <div class="row g-2">
                <div class="col-5">
                    <label class="small text-muted fw-bold">KÃ¼pe No</label>
                    <input type="text" class="form-control form-control-sm fw-bold text-uppercase inp-kupe" placeholder="TR...">
                </div>
                <div class="col-4">
                    <label class="small text-muted fw-bold">Cinsiyet</label>
                    <select class="form-select form-select-sm inp-cinsiyet">
                        <option value="DiÅŸi">DiÅŸi</option>
                        <option value="Erkek">Erkek</option>
                    </select>
                </div>
                <div class="col-3">
                    <label class="small text-muted fw-bold">Irk</label>
                    <select class="form-select form-select-sm inp-irk">
                        <option value="${anneIrk}" selected>${anneIrk}</option>
                        <option value="Holstein">Holstein</option>
                        <option value="Simental">Simental</option>
                        <option value="Montofon">Montofon</option>
                        <option value="Angus">Angus</option>
                        <option value="Yerli">Yerli</option>
                    </select>
                </div>
            </div>
            <button type="button" class="btn-close position-absolute top-0 end-0 m-1 small" aria-label="Close" onclick="this.parentElement.remove()"></button>
        </div>
    `;

    const { value: result } = await Swal.fire({
        title: 'ðŸŽ‰ DoÄŸum KaydÄ±',
        html: `
            <div class="text-start">
                <p class="small text-muted mb-2"><b>${anneKupe}</b> doÄŸum yapÄ±yor. Ä°kiz/ÃœÃ§Ã¼z durumunda aÅŸaÄŸÄ±daki butona basarak ekleme yapÄ±n.</p>
                
                <div class="mb-2">
                    <label class="small fw-bold text-dark">DoÄŸum Tarihi (Hepsi Ä°Ã§in)</label>
                    <input type="date" id="ortak-tarih" class="form-control" value="${bugun}">
                </div>

                <div id="buzagi-container" class="mb-2" style="max-height: 300px; overflow-y: auto;">
                    </div>

                <button type="button" class="btn btn-outline-primary btn-sm w-100 dashed-border fw-bold" id="btn-satir-ekle">
                    <i class="fa-solid fa-plus me-1"></i> BaÅŸka Yavru Ekle (Ä°kiz/ÃœÃ§Ã¼z)
                </button>
            </div>
        `,
        width: '600px',
        icon: 'success',
        showCancelButton: true,
        confirmButtonText: 'Kaydet ve Bitir',
        confirmButtonColor: '#198754',
        cancelButtonText: 'Ä°ptal',
        didOpen: () => {
            const container = document.getElementById('buzagi-container');
            const btnEkle = document.getElementById('btn-satir-ekle');

            // 1. Ä°lk satÄ±rÄ± ekle
            container.insertAdjacentHTML('beforeend', buzagiSatiriHTML);

            // 2. Butona basÄ±nca yeni satÄ±r ekle
            btnEkle.addEventListener('click', () => {
                container.insertAdjacentHTML('beforeend', buzagiSatiriHTML);
            });
        },
        preConfirm: () => {
            const tarih = document.getElementById('ortak-tarih').value;
            const satirlar = document.querySelectorAll('.buzagi-satir');
            let buzagilar = [];

            // TÃ¼m satÄ±rlarÄ± dolaÅŸ ve verileri topla
            satirlar.forEach(satir => {
                const kupe = satir.querySelector('.inp-kupe').value.toUpperCase();
                const cinsiyet = satir.querySelector('.inp-cinsiyet').value;
                const irk = satir.querySelector('.inp-irk').value;

                if (kupe) {
                    buzagilar.push({ kupe, cinsiyet, irk });
                }
            });

            if (buzagilar.length === 0) {
                Swal.showValidationMessage('En az bir buzaÄŸÄ± kÃ¼pe numarasÄ± girmelisiniz.');
                return false;
            }

            return { tarih, buzagilar };
        }
    });

    if (result) {
        Swal.fire({title: 'Kaydediliyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

        try {
            // 1. TÃœM YAVRULARI EKLE (DÃ¶ngÃ¼ ile)
            const promises = result.buzagilar.map(yavru => {
                return addDoc(collection(db, "animals"), {
                    memberId: currentMemberId,
                    coopId: currentCoopId,
                    kupeNo: yavru.kupe,
                    tur: 'BuzaÄŸÄ±',
                    cinsiyet: yavru.cinsiyet,
                    irk: yavru.irk,
                    dogumTarihi: result.tarih,
                    anneKupe: anneKupe,
                    kayitTarihi: new Date()
                });
            });

            // YavrularÄ±n eklenmesini bekle
            await Promise.all(promises);

            // 2. ANNEYÄ° GÃœNCELLE (Sadece 1 kere)
            await updateDoc(doc(db, "animals", anneId), {
                gebelik: 'Bos',
                tohumlamaTarihi: null,
                sonDogumTarihi: result.tarih
            });

            Swal.fire({
                icon: 'success', 
                title: 'Tebrikler!', 
                text: `${result.buzagilar.length} adet buzaÄŸÄ± baÅŸarÄ±yla kaydedildi. Anne durumu gÃ¼ncellendi.`
            });

        } catch (error) {
            console.error(error);
            Swal.fire("Hata", error.message, "error");
        }
    }
}
// --- 8. WHATSAPP DESTEK ---
window.whatsappDestekAc = async function() {
    Swal.fire({title: 'BaÄŸlanÄ±yor...', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});

    try {
        if (!currentCoopId) throw new Error("Kooperatif baÄŸlantÄ±sÄ± bulunamadÄ±.");

        // Kooperatif bilgilerini Ã§ek
        const docRef = doc(db, "cooperatives", currentCoopId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            // VeritabanÄ±nda 'telefon' alanÄ± varsa al, yoksa varsayÄ±lanÄ± kullan
            // Ã–rn: veritabanÄ±nda 0532 123 45 67 kayÄ±tlÄ± olsa bile temizleyip 905321234567 yapar.
            let rawPhone = data.telefon || "905000000000"; 
            
            // Sadece rakamlarÄ± bÄ±rak (BoÅŸluk, parantez vs temizle)
            let phone = rawPhone.replace(/\D/g, '');
            
            // BaÅŸÄ±na 90 ekle (EÄŸer yoksa)
            if (!phone.startsWith("90")) {
                if (phone.startsWith("0")) phone = "9" + phone;
                else phone = "90" + phone;
            }

            Swal.close();
            // WhatsApp'Ä± aÃ§
            window.open(`https://wa.me/${phone}`, '_blank');
        } else {
            throw new Error("Kurum bilgisine ulaÅŸÄ±lamadÄ±.");
        }
    } catch (error) {
        Swal.fire("Hata", "Destek hattÄ±na baÄŸlanÄ±lamadÄ±. LÃ¼tfen yÃ¶neticinizi arayÄ±n.", "error");
    }
}
// --- 5. DOÄžUM BÄ°LDÄ°RÄ°M KONTROLÃœ ---
window.dogumBildirimiYap = async function(uid) {
    // Sadece 'Gebe' olanlarÄ± bir kere Ã§ekelim
    const q = query(
        collection(db, "animals"), 
        where("memberId", "==", uid),
        where("gebelik", "==", "Gebe")
    );

    const snapshot = await getDocs(q);
    let bildirimListesi = "";
    let sayac = 0;

    snapshot.forEach(doc => {
        const data = doc.data();
        if (data.tohumlamaTarihi) {
            const tohumlama = new Date(data.tohumlamaTarihi);
            const bugun = new Date();
            
            // Tahmini DoÄŸum (285 GÃ¼n)
            const tahminiDogum = new Date(tohumlama);
            tahminiDogum.setDate(tohumlama.getDate() + 285);
            
            // Kalan GÃ¼n HesabÄ±
            const farkZaman = tahminiDogum - bugun;
            const kalanGun = Math.ceil(farkZaman / (1000 * 60 * 60 * 24));

            // Sadece Son 10 GÃ¼ne Girenler (veya gÃ¼nÃ¼ geÃ§miÅŸ ama 30 gÃ¼nÃ¼ geÃ§memiÅŸler)
            if (kalanGun <= 10 && kalanGun > -30) {
                sayac++;
                let durumMetni = "";
                let renk = "";

                if (kalanGun > 0) {
                    durumMetni = `${kalanGun} GÃ¼n KaldÄ±`;
                    renk = "text-danger"; // KÄ±rmÄ±zÄ±
                } else if (kalanGun === 0) {
                    durumMetni = "BUGÃœN!";
                    renk = "text-success fw-bold"; // YeÅŸil
                } else {
                    durumMetni = `${Math.abs(kalanGun)} GÃ¼n GeÃ§ti!`;
                    renk = "text-muted text-decoration-line-through"; // Gri
                }

                bildirimListesi += `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <i class="fa-solid fa-cow me-2 text-primary"></i>
                            <span class="fw-bold text-dark">${data.kupeNo}</span>
                        </div>
                        <span class="${renk} small fw-bold">${durumMetni}</span>
                    </div>
                `;
            }
        }
    });

    // EÄŸer yaklaÅŸan doÄŸum varsa uyarÄ± ver
    if (sayac > 0) {
        Swal.fire({
            title: 'ðŸ”” DoÄŸum YaklaÅŸÄ±yor!',
            html: `
                <p class="text-muted small mb-3">AÅŸaÄŸÄ±daki hayvanlarÄ±nÄ±zÄ±n doÄŸumu Ã§ok yakÄ±n:</p>
                <div class="bg-light p-3 rounded border text-start" style="max-height: 300px; overflow-y: auto;">
                    ${bildirimListesi}
                </div>
            `,
            icon: 'info',
            confirmButtonText: 'Tamam, AnlaÅŸÄ±ldÄ±',
            confirmButtonColor: '#0f766e'
        });
    }
}
// --- 9. DUYURULARI GETÄ°R ---
window.duyurulariGetir = function() {
    const container = document.getElementById("announcement-list");
    
    // VeritabanÄ± sorgusu: En yeni 3 duyuru
    const q = query(collection(db, "announcements"), orderBy("tarih", "desc"), limit(3));

    onSnapshot(q, (snapshot) => {
        container.innerHTML = "";

        if (snapshot.empty) {
            container.innerHTML = `
                <div class="p-4 text-center text-muted">
                    <i class="fa-regular fa-bell-slash fa-2x mb-2 opacity-25"></i>
                    <p class="m-0 small">Åžu an yeni duyuru yok.</p>
                </div>`;
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            // Tarih formatÄ±
            let tarihStr = "";
            if(data.tarih) {
                const d = data.tarih.toDate();
                tarihStr = d.toLocaleDateString('tr-TR', {day:'numeric', month:'long'});
            }

            // Ã–nem derecesine gÃ¶re ikon/renk
            let ikon = "fa-bullhorn"; 
            let renk = "text-primary";
            let bg = "bg-primary";
            
            if(data.onem === 'yuksek') { 
                ikon = "fa-triangle-exclamation"; 
                renk = "text-danger"; 
                bg = "bg-danger";
            } else if (data.onem === 'odeme') {
                ikon = "fa-wallet";
                renk = "text-success";
                bg = "bg-success";
            }

            const item = `
            <div class="list-group-item p-3 border-bottom">
                <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                    <div class="d-flex align-items-center">
                        <div class="${bg} bg-opacity-10 ${renk} rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                            <i class="fa-solid ${ikon} small"></i>
                        </div>
                        <strong class="text-dark small">${data.baslik}</strong>
                    </div>
                    <small class="text-muted" style="font-size:0.65rem">${tarihStr}</small>
                </div>
                <p class="mb-0 text-secondary ps-5 small" style="font-size: 0.8rem; line-height: 1.4;">${data.icerik}</p>
            </div>
            `;
            container.innerHTML += item;
        });
    });
}
// --- 2. YENÄ° HAYVAN EKLE (CÄ°NSÄ°YET KONTROLLÃœ) ---
window.yeniHayvanEkle = async function() {
    const { value: formValues } = await Swal.fire({
        title: 'Yeni Hayvan KartÄ±',
        html: `
            <div class="text-start">
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">KÃ¼pe NumarasÄ±</label>
                        <input id="swal-kupe" class="form-control fw-bold text-uppercase" placeholder="TR...">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">Rumuz / Ä°sim</label>
                        <input id="swal-rumuz" class="form-control" placeholder="Ã–rn: SarÄ±kÄ±z">
                    </div>
                </div>
                
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">TÃ¼rÃ¼</label>
                        <select id="swal-tur" class="form-select">
                            <option value="Ä°nek">Ä°nek</option>
                            <option value="DÃ¼ve">DÃ¼ve</option>
                            <option value="Dana">Dana</option>
                            <option value="BuzaÄŸÄ±">BuzaÄŸÄ±</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">Cinsiyeti</label>
                        <select id="swal-cinsiyet" class="form-select">
                            <option value="DiÅŸi">DiÅŸi</option>
                            <option value="Erkek">Erkek</option>
                        </select>
                    </div>
                </div>

                <div id="gebelik-wrapper">
                    <div id="gebelik-container" class="bg-light p-2 rounded border mb-2">
                        <label class="small fw-bold text-primary mb-1">Gebelik Durumu</label>
                        <select id="swal-gebelik" class="form-select mb-2">
                            <option value="Bos">BoÅŸ (Gebe DeÄŸil)</option>
                            <option value="Gebe">Gebe / TohumlandÄ±</option>
                        </select>
                        
                        <div id="tarih-div" style="display:none;">
                            <label class="small fw-bold text-muted mb-1">Tohumlama Tarihi</label>
                            <input type="date" id="swal-tohumlama" class="form-control">
                        </div>
                    </div>
                </div>

                <label class="small fw-bold text-muted mb-1">IrkÄ±</label>
                <select id="swal-irk" class="form-select mb-2">
                    <option value="Holstein">Holstein (Siyah Alaca)</option>
                    <option value="Simental">Simental</option>
                    <option value="Montofon">Montofon</option>
                    <option value="Jersey">Jersey</option>
                    <option value="Yerli">Yerli / Melez</option>
                    <option value="Angus">Angus</option>
                    <option value="DiÄŸer">DiÄŸer</option>
                </select>

                <label class="small fw-bold text-muted mb-1">DoÄŸum Tarihi (YaÅŸ Ä°Ã§in)</label>
                <input type="date" id="swal-dogum" class="form-control">
            </div>
        `,
        // --- KRÄ°TÄ°K BÃ–LÃœM: DÄ°NAMÄ°K KONTROLLER ---
        didOpen: () => {
            const cinsiyetSelect = document.getElementById('swal-cinsiyet');
            const gebelikWrapper = document.getElementById('gebelik-wrapper');
            const gebelikSelect = document.getElementById('swal-gebelik');
            const tarihDiv = document.getElementById('tarih-div');

            // 1. Cinsiyet DeÄŸiÅŸince Ã‡alÄ±ÅŸacak Kod
            cinsiyetSelect.addEventListener('change', function() {
                if (this.value === 'Erkek') {
                    gebelikWrapper.style.display = 'none'; // Gizle
                    gebelikSelect.value = 'Bos'; // Erkekse boÅŸ yap
                } else {
                    gebelikWrapper.style.display = 'block'; // GÃ¶ster
                }
            });

            // 2. Gebelik Durumu DeÄŸiÅŸince Ã‡alÄ±ÅŸacak Kod
            gebelikSelect.addEventListener('change', function() {
                if (this.value === 'Gebe') {
                    tarihDiv.style.display = 'block';
                } else {
                    tarihDiv.style.display = 'none';
                }
            });
        },
        // ----------------------------------------
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Kaydet',
        confirmButtonColor: '#0f766e',
        preConfirm: () => {
            return {
                kupe: document.getElementById('swal-kupe').value.toUpperCase(),
                rumuz: document.getElementById('swal-rumuz').value,
                tur: document.getElementById('swal-tur').value,
                cinsiyet: document.getElementById('swal-cinsiyet').value,
                // Erkekse gebelik verisi 'Bos' gider
                gebelikDurumu: document.getElementById('swal-cinsiyet').value === 'Erkek' ? 'Bos' : document.getElementById('swal-gebelik').value,
                tohumlamaTarihi: document.getElementById('swal-tohumlama').value,
                irk: document.getElementById('swal-irk').value,
                dogum: document.getElementById('swal-dogum').value
            }
        }
    });

    if (formValues) {
        if(!formValues.kupe) return Swal.fire("Hata", "KÃ¼pe numarasÄ± zorunludur!", "warning");

        try {
            await addDoc(collection(db, "animals"), {
                memberId: currentMemberId,
                coopId: currentCoopId,
                kupeNo: formValues.kupe,
                rumuz: formValues.rumuz,
                tur: formValues.tur,
                cinsiyet: formValues.cinsiyet,
                gebelik: formValues.gebelikDurumu,
                tohumlamaTarihi: formValues.tohumlamaTarihi,
                irk: formValues.irk,
                dogumTarihi: formValues.dogum,
                kayitTarihi: new Date()
            });
            
            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
            Toast.fire({icon: 'success', title: 'Kaydedildi'});

        } catch (error) {
            Swal.fire("Hata", error.message, "error");
        }
    }
}
// --- 3. HIZLI ARAMA ---
window.hayvanAra = function() {
    const input = document.getElementById("animalSearch");
    const filter = input.value.toLowerCase();
    const cards = document.getElementsByClassName("animal-card");

    for (let i = 0; i < cards.length; i++) {
        const kupeNo = cards[i].getAttribute("data-kupe");
        if (kupeNo.indexOf(filter) > -1) {
            cards[i].style.display = "";
        } else {
            cards[i].style.display = "none";
        }
    }
}

    // --- 3. HAYVAN SÄ°L ---
    window.hayvanSil = async function(docId) {
        const res = await Swal.fire({
            title: 'Silinsin mi?',
            text: "Bu hayvan listenizden kaldÄ±rÄ±lacak.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Evet, Sil',
            confirmButtonColor: '#d33',
            cancelButtonText: 'VazgeÃ§'
        });

        if(res.isConfirmed) {
            await deleteDoc(doc(db, "animals", docId));
            const Toast = Swal.mixin({toast: true, position: 'top', showConfirmButton: false, timer: 1000});
            Toast.fire({icon: 'success', title: 'Silindi'});
        }
    }
    window.sayfaDegistir = function(sayfaId, element) {
        // TÃ¼m sayfalarÄ± gizle
        document.getElementById("page-home").style.display = "none";
        document.getElementById("page-milk").style.display = "none";
        document.getElementById("page-history").style.display = "none";
        document.getElementById("page-profile").style.display = "none";
        document.getElementById("page-account").style.display = "none";
        
        // YENÄ° EKLENEN SATIR ðŸ‘‡
        document.getElementById("page-animals").style.display = "none"; 
        
        // Ä°stenen sayfayÄ± aÃ§
        const target = document.getElementById(sayfaId);
        if(target) target.style.display = "block";
        
        // MenÃ¼ aktifliÄŸini ayarla
        if(element) {
            document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));
            element.classList.add("active");
        }
        window.scrollTo(0, 0);
    }
        // 1. SayfayÄ± AÃ§ (GÃœNCELLENDÄ°: ARTIK GÃœNCEL AY GELÄ°YOR)
    window.hesapEkstresiAc = function() {
        const d = new Date();
        // d.setMonth(d.getMonth() - 1); // BU SATIRI Ä°PTAL ETTÄ°K (ArtÄ±k gÃ¼ncel ay geliyor)
        
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        
        const filter = document.getElementById("accMonthFilter");
        // Her aÃ§Ä±lÄ±ÅŸta gÃ¼ncel ayÄ± seÃ§mesi iÃ§in kontrolÃ¼ kaldÄ±rdÄ±k, direkt atÄ±yoruz:
        filter.value = `${yyyy}-${mm}`; 
        
        sayfaDegistir('page-account', null); 
        
        ekstreGetir(); // Veriyi Ã§ek
    }

    // Tarih deÄŸiÅŸince tekrar Ã§ek
    document.getElementById("accMonthFilter").addEventListener("change", ekstreGetir);

async function ekstreGetir() {
        const selectedPeriod = document.getElementById("accMonthFilter").value; 
        const container = document.getElementById("account-content");
        
        container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2 small text-muted">GeÃ§miÅŸ dÃ¶nem hesaplanÄ±yor...</div></div>';

        try {
            // 1. MEVCUT DÃ–NEMÄ° Ã‡EK (Ã–rn: AralÄ±k)
            const docId = `${currentMemberId}_${selectedPeriod}`;
            const docRef = doc(db, "monthly_statements", docId);
            const docSnap = await getDoc(docRef);

            // 2. Ã–NCEKÄ° DÃ–NEMÄ° BUL VE DETAYLI HESAPLA (Ã–rn: KasÄ±m)
            let [yil, ay] = selectedPeriod.split('-').map(Number);
            let prevDate = new Date(yil, ay - 2, 1); 
            let prevKey = `${prevDate.getFullYear()}-${String(prevDate.getMonth()+1).padStart(2,'0')}`;
            let prevDocId = `${currentMemberId}_${prevKey}`;
            
            const prevDocSnap = await getDoc(doc(db, "monthly_statements", prevDocId));

            // --- OTOMATÄ°K DEVÄ°R HESAPLAMA (VeritabanÄ±ndaki toplama gÃ¼venme, yeniden hesapla) ---
            let activeDevirBakiye = 0;

            if(prevDocSnap.exists()) {
                const pData = prevDocSnap.data();
                
                // A. Ã–nceki AyÄ±n Devrini Al
                let pDevir = pData.devirBakiye || 0;
                
                // B. Ã–nceki AyÄ±n SÃ¼tlerini Topla
                let pSutToplami = 0;
                if(pData.sutListesi) {
                    pData.sutListesi.forEach(item => pSutToplami += Number(item.tutar || item.amount || 0));
                }

                // C. Ã–nceki AyÄ±n SatÄ±ÅŸlarÄ±nÄ± Topla
                let pSatisToplami = 0;
                if(pData.satisListesi) {
                    pData.satisListesi.forEach(item => pSatisToplami += Number(item.amount || 0));
                }

                // D. Ã–nceki AyÄ±n Nakit Hareketlerini Topla
                let pGiren = 0, pCikan = 0;
                if(pData.nakitListesi) {
                    pData.nakitListesi.forEach(item => {
                        if(item.type === 'alacak') pGiren += Number(item.amount || 0);
                        else pCikan += Number(item.amount || 0);
                    });
                }

                // E. Devir YÃ¶nÃ¼nÃ¼ Ayarla (Negatif: Alacak, Pozitif: BorÃ§)
                // Sistemimizde:
                // Alacaklar (GiriÅŸ) = SÃ¼t + NakitGiriÅŸ
                // BorÃ§lar (Ã‡Ä±kÄ±ÅŸ) = SatÄ±ÅŸ + NakitÃ‡Ä±kÄ±ÅŸ
                // Devir MantÄ±ÄŸÄ±: pDevir < 0 ise Alacak, > 0 ise BorÃ§.

                let pGenelAlacak = pSutToplami + pGiren;
                let pGenelBorc = pSatisToplami + pCikan;

                if(pDevir < 0) pGenelAlacak += Math.abs(pDevir); // Devir alacaksa alacaklara ekle
                else pGenelBorc += pDevir; // Devir borÃ§sa borÃ§lara ekle

                // F. Sonucu Bul (Alacak - BorÃ§)
                // Pozitif Ã§Ä±karsa AlacaklÄ±yÄ±z demektir.
                // ANCAK: Bizim devirBakiye mantÄ±ÄŸÄ±mÄ±zda Alacak genellikle NEGATÄ°F saklanÄ±yor olabilir.
                // KODUN Geri kalanÄ±na uyumlu olmasÄ± iÃ§in:
                // EÄŸer SonuÃ§ (Alacak - BorÃ§) > 0 ise -> KullanÄ±cÄ± AlacaklÄ± -> Bunu Devir olarak nasÄ±l gÃ¶sterelim?
                // AÅŸaÄŸÄ±daki koda gÃ¶re:
                // activeDevirBakiye < 0 ise ALACAKLI
                // activeDevirBakiye > 0 ise BORÃ‡LU
                
                let netSonuc = pGenelAlacak - pGenelBorc;
                
                // EÄŸer Net SonuÃ§ Pozitifse (ParamÄ±z var), bunu sisteme ALACAK (Negatif) olarak tanÄ±tacaÄŸÄ±z
                // EÄŸer Net SonuÃ§ Negatifse (Borcumuz var), bunu sisteme BORÃ‡ (Pozitif) olarak tanÄ±tacaÄŸÄ±z
                // Ã‡ÃœNKÃœ: AÅŸaÄŸÄ±daki kodda "devirBakiye < 0 -> Alacak" mantÄ±ÄŸÄ± kurulu.
                
                if(netSonuc > 0) activeDevirBakiye = -Math.abs(netSonuc); // Alacak
                else activeDevirBakiye = Math.abs(netSonuc); // BorÃ§

            } else {
                // Ã–nceki ay yoksa mevcut belgedeki manuel devri kullan
                if(docSnap.exists()) {
                    activeDevirBakiye = docSnap.data().devirBakiye || 0;
                }
            }

            // --- VERÄ° KONTROLÃœ ---
            if(!docSnap.exists()) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="fa-solid fa-file-invoice fa-3x mb-3 opacity-25"></i>
                        <h5>Hesap YayÄ±nlanmadÄ±</h5>
                        <p class="small">SeÃ§ilen dÃ¶nem (${selectedPeriod}) iÃ§in henÃ¼z hesap Ã¶zeti yayÄ±nlanmamÄ±ÅŸ.</p>
                    </div>`;
                return;
            }

            const data = docSnap.data();

            // YARDIMCI FORMAT FONKSÄ°YONLARI
            const fmt = (num) => Number(num).toLocaleString('tr-TR', {minimumFractionDigits: 2}) + ' â‚º';
            const dateFmt = (ts) => {
                if(!ts) return '-';
                if(ts.seconds) return new Date(ts.seconds * 1000).toLocaleDateString('tr-TR');
                return ts; 
            };

            // --- 1. SÃœT BEDELLERÄ° (BU AY) ---
            let sutRows = '';
            let hesaplananSutToplami = 0; 

            if(data.sutListesi && data.sutListesi.length > 0) {
                data.sutListesi.forEach(item => {
                    let ayAdi = 'DÃ¶nem';
                    try {
                        if(item.tarih) {
                            const parts = item.tarih.split('.');
                            if(parts.length === 3) {
                                const d = new Date(parts[2], parts[1]-1, parts[0]);
                                ayAdi = d.toLocaleDateString('tr-TR', { month: 'long' });
                            }
                        } else if(item.date && item.date.seconds) {
                            ayAdi = new Date(item.date.seconds * 1000).toLocaleDateString('tr-TR', { month: 'long' });
                        }
                        ayAdi = ayAdi.charAt(0).toUpperCase() + ayAdi.slice(1);
                    } catch (e) { ayAdi = item.tarih || '-'; }

                    const aciklama = item.aciklama || item.desc || 'SÃ¼t Bedeli';
                    const aksam = Number(item.aksam) || 0;
                    const sabah = Number(item.sabah) || 0;
                    const toplamLt = aksam + sabah;
                    const fiyat = item.fiyat || 0;
                    const tutar = Number(item.tutar || item.amount || 0);
                    
                    hesaplananSutToplami += tutar; 

                    sutRows += `
    <tr>
        <td class="text-center text-primary bg-primary bg-opacity-10 fw-bold ps-3">${aksam > 0 ? aksam : '-'}</td>
        <td class="text-center text-warning bg-warning bg-opacity-10 fw-bold">${sabah > 0 ? sabah : '-'}</td>
        <td class="text-center fw-bold text-dark bg-secondary bg-opacity-10">${toplamLt}</td>
        <td class="text-center text-muted small">${fmt(fiyat)}</td>
        <td class="text-end fw-bold text-success pe-3">${fmt(tutar)}</td>
    </tr>
`;
                });
            } else {
                sutRows = '<tr><td colspan="7" class="text-center text-muted small py-3">Bu dÃ¶nem sÃ¼t kaydÄ± yok.</td></tr>';
            }

            // --- 2. MAL/HÄ°ZMET ALIMLARI (BU AY) ---
            let satisRows = '';
            let hesaplananSatisToplami = 0; 

            if(data.satisListesi && data.satisListesi.length > 0) {
                data.satisListesi.forEach(item => {
                    const urunAdi = item.name;
                    const birimFiyat = item.price;
                    const miktar = item.qty ? `${item.qty} <small class="text-muted">${item.unit || ''}</small>` : '-';
                    const tutar = Number(item.amount || 0);

                    hesaplananSatisToplami += tutar;

                  satisRows += `
    <tr>
        <td class="align-middle ps-3">
            <span class="text-secondary fw-semibold" style="font-size:0.85rem">${urunAdi}</span>
        </td>
        <td class="text-center align-middle fw-bold text-dark small">${miktar}</td>
        <td class="text-end align-middle small text-muted">${fmt(birimFiyat)}</td>
        <td class="text-end align-middle fw-bold text-danger pe-3">-${fmt(tutar)}</td>
    </tr>
`;
                });
            } else {
                satisRows = '<tr><td colspan="5" class="text-center text-muted small py-3">Bu dÃ¶nem alÄ±ÅŸveriÅŸ yok.</td></tr>';
            }

            // --- 3. NAKÄ°T HAREKETLER (BU AY) ---
            let nakitRows = '';
            let totalGiren = 0; 
            let totalCikan = 0; 

            if(data.nakitListesi && data.nakitListesi.length > 0) {
                data.nakitListesi.forEach(item => {
                    let girenSutunu = '-';
                    let cikanSutunu = '-';
                    const miktar = Number(item.amount);

                    if (item.type === 'alacak') {
                        girenSutunu = `<span class="fw-bold text-dark">${fmt(miktar)}</span>`;
                        totalGiren += miktar;
                    } else {
                        cikanSutunu = `<span class="fw-bold text-dark">${fmt(miktar)}</span>`;
                        totalCikan += miktar;
                    }
                    
                    nakitRows += `
                        <tr>
                            <td class="small text-muted align-middle">${dateFmt(item.date)}</td>
                            <td class="align-middle text-secondary">${item.desc}</td>
                            <td class="text-end align-middle bg-success bg-opacity-10">${girenSutunu}</td>
                            <td class="text-end align-middle bg-danger bg-opacity-10">${cikanSutunu}</td>
                        </tr>
                    `;
                });
            } else {
                nakitRows = '<tr><td colspan="4" class="text-center text-muted small py-3">Bu dÃ¶nem nakit hareket yok.</td></tr>';
            }

            // --- 4. DETAYLI HESAPLAMA (GÃœNCELLENMÄ°Åž DEVÄ°R MANTIÄžI Ä°LE) ---
            let devirAlacak = 0;
            let devirBorc = 0;
            let devirSatiriAlacak = ''; 
            let devirSatiriBorc = '';

            // activeDevirBakiye: Ã–nceki aydan hesaplayarak bulduÄŸumuz gerÃ§ek bakiye
            if (activeDevirBakiye < 0) {
                // Negatif ise Ãœye AlacaklÄ± demektir
                devirAlacak = Math.abs(activeDevirBakiye);
                devirSatiriAlacak = `
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom border-light">
                        <span class="text-secondary small">Ã–nceki Aydan Devir (Alacak)</span>
                        <span class="fw-bold text-dark">+ ${fmt(devirAlacak)}</span>
                    </div>`;
            } else if (activeDevirBakiye > 0) {
                // Pozitif ise Ãœye BorÃ§lu demektir
                devirBorc = activeDevirBakiye;
                devirSatiriBorc = `
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom border-light">
                        <span class="text-secondary small">Ã–nceki Aydan Devir (BorÃ§)</span>
                        <span class="fw-bold text-dark">- ${fmt(devirBorc)}</span>
                    </div>`;
            }

            // GENEL TOPLAMLAR (Devir Dahil)
            const genelToplamAlacak = devirAlacak + hesaplananSutToplami + totalGiren;
            const genelToplamBorc = devirBorc + hesaplananSatisToplami + totalCikan;

            // NET DURUM (Alacak - BorÃ§)
            const netDurum = genelToplamAlacak - genelToplamBorc;

            const detayTabloHtml = `
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 pt-4 pb-2">
                        <h6 class="fw-bold text-dark m-0">DÃ–NEM SONU HESAPLAMA DETAYI</h6>
                    </div>
                    <div class="card-body p-3 pt-0">
                        <div class="mb-4">
                            <h6 class="fw-bold text-success mb-3" style="font-size: 0.8rem;">+ ALACAKLAR (GiriÅŸ)</h6>
                            ${devirSatiriAlacak}
                            <div class="d-flex justify-content-between mb-2 pb-2 border-bottom border-light">
                                <span class="text-secondary small">Cari Ay SÃ¼t Bedelleri</span>
                                <span class="fw-bold text-dark">+ ${fmt(hesaplananSutToplami)}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span class="text-secondary small">Cari Ay YapÄ±lan Nakit Tahsilatlar</span>
                                <span class="fw-bold text-dark">+ ${fmt(totalGiren)}</span>
                            </div>
                            <div class="d-flex justify-content-between p-2 rounded align-items-center" style="background-color: #d1e7dd;">
                                <span class="fw-bold text-success small">TOPLAM ALACAK</span>
                                <span class="fw-bold text-dark">${fmt(genelToplamAlacak)}</span>
                            </div>
                        </div>
                        <div>
                            <h6 class="fw-bold text-danger mb-3" style="font-size: 0.8rem;">- BORÃ‡LAR (Ã‡Ä±kÄ±ÅŸ)</h6>
                            ${devirSatiriBorc}
                            <div class="d-flex justify-content-between mb-2 pb-2 border-bottom border-light">
                                <span class="text-secondary small">Cari Ay Mal/Hizmet SatÄ±ÅŸlarÄ±</span>
                                <span class="fw-bold text-dark">- ${fmt(hesaplananSatisToplami)}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span class="text-secondary small">Cari Ay YapÄ±lan Ã–demeler (Avans)</span>
                                <span class="fw-bold text-dark">- ${fmt(totalCikan)}</span>
                            </div>
                            <div class="d-flex justify-content-between p-2 rounded align-items-center" style="background-color: #f8d7da;">
                                <span class="fw-bold text-danger small">TOPLAM BORÃ‡</span>
                                <span class="fw-bold text-dark">${fmt(genelToplamBorc)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // --- 5. SONUÃ‡ KARTI ---
            let sonucText = '';
            let sonucRenk = '';
            
            if(netDurum > 0) {
                sonucText = `${fmt(netDurum)} ALACAKLISINIZ`;
                sonucRenk = '#198754'; 
            } else if(netDurum < 0) {
                sonucText = `${fmt(Math.abs(netDurum))} BORÃ‡LUSUNUZ`;
                sonucRenk = '#dc3545'; 
            } else {
                sonucText = "HESAP KAPALI (0,00 â‚º)";
                sonucRenk = "#6c757d"; 
            }

            // --- ÃœST DEVÄ°R KARTI (HESAPLANMIÅž DEVÄ°R Ä°LE) ---
            let ustDevirHtml = '';
            if (activeDevirBakiye !== 0) {
                const isBorc = activeDevirBakiye > 0;
                const devirTutar = Math.abs(activeDevirBakiye);
                const bgStyle = isBorc ? 'background-color: #fff3cd;' : 'background-color: #d1e7dd;';
                const textClass = isBorc ? 'text-danger' : 'text-success';
                const durumYazisi = isBorc ? 'BORÃ‡LU' : 'ALACAKLI';

                ustDevirHtml = `
                <div class="card border-0 mb-3 shadow-sm" style="border-radius: 12px;">
                    <div class="card-body d-flex justify-content-between align-items-center p-3" style="${bgStyle}">
                        <span class="fw-bold text-dark" style="font-size: 0.95rem;">DÃ–NEM BAÅžI DEVÄ°R</span>
                        <span class="fw-bold ${textClass}" style="font-size: 1.1rem;">
                            ${fmt(devirTutar)} ${durumYazisi}
                        </span>
                    </div>
                </div>`;
            } else {
                ustDevirHtml = `
                <div class="card border-0 mb-3 shadow-sm" style="border-radius: 12px;">
                    <div class="card-body d-flex justify-content-between align-items-center p-3 bg-light">
                        <span class="fw-bold text-muted" style="font-size: 0.95rem;">DÃ–NEM BAÅžI DEVÄ°R</span>
                        <span class="fw-bold text-muted">BAKÄ°YE YOK (0,00 â‚º)</span>
                    </div>
                </div>`;
            }

            // --- 6. HTML BÄ°RLEÅžTÄ°RME ---
            container.innerHTML = `
                ${ustDevirHtml}

                <h6 class="fw-bold text-success mb-2 border-bottom pb-1 mt-2">1. SÃœT BEDELLERÄ°</h6>
                <div class="card border-0 shadow-sm mb-4 overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0 align-middle" style="font-size:0.8rem">
                           <thead class="table-light">
    <tr class="text-center">
        <th class="ps-3">AkÅŸam<br><small>(Lt)</small></th>
        <th>Sabah<br><small>(Lt)</small></th>
        <th>Toplam<br><small>(Lt)</small></th>
        <th>Fiyat</th>
        <th class="text-end pe-3">Tutar</th>
    </tr>
</thead>
                            <tbody>${sutRows}</tbody>
                            <tfoot class="bg-success bg-opacity-10 fw-bold">
    <tr>
        <td colspan="4" class="text-end pe-2">SÃœT TUTAR TOPLAMI:</td>
        <td class="text-end text-success pe-3">${fmt(hesaplananSutToplami)}</td>
    </tr>
</tfoot>
                        </table>
                    </div>
                </div>
<h6 class="fw-bold text-danger mb-2 border-bottom pb-1">2. MAL/HÄ°ZMET ALIMLARI</h6>
<div class="card border-0 shadow-sm mb-4 overflow-hidden">
    <div class="table-responsive">
        <table class="table table-sm table-striped mb-0 align-middle" style="font-size:0.85rem">
            <thead class="table-light">
                <tr>
                    <th style="width:55%" class="ps-3">ÃœrÃ¼n AdÄ±</th>
                    <th class="text-center" style="width:15%">Miktar</th> 
                    <th class="text-end" style="width:15%">Birim Fiyat</th>
                    <th class="text-end pe-3" style="width:15%">Tutar</th>
                </tr>
            </thead>
            <tbody>${satisRows}</tbody>
            <tfoot class="bg-danger bg-opacity-10 fw-bold">
                <tr>
                    <td colspan="3" class="text-end pe-2">BORÃ‡ TOPLAMI:</td> 
                    <td class="text-end text-danger pe-3">${fmt(hesaplananSatisToplami)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

                ${detayTabloHtml}

                <div class="card border-0 shadow-lg mb-4" style="background-color: ${sonucRenk}; color: white; border-radius: 16px;">
                    <div class="card-body text-center p-4">
                        <small class="opacity-75 fw-bold d-block mb-1 text-uppercase">DÃ–NEM SONU NET DURUM</small>
                        <h3 class="fw-bold m-0">${sonucText}</h3>
                    </div>
                </div>
            `;

        } catch (error) {
            console.error(error);
            container.innerHTML = '<div class="alert alert-danger">Veri alÄ±nÄ±rken hata oluÅŸtu.</div>';
        }
    }
    </script>
</body>
</html>