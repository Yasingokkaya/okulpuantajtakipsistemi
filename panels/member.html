<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Üretici Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="../manifest.json">
    <link rel="icon" type="image/jpeg" href="app-logo.jpg">
    <link rel="apple-touch-icon" href="app-logo.jpg">
    <meta name="theme-color" content="#0f766e">
    <link rel="manifest" href="../manifest.json">
    <style>

        /* --- MOBİL HAYVAN KARTI TASARIMI --- */
.animal-card {
    background: #fff;
    border-radius: 20px;
    border: 1px solid #f1f5f9;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    transition: transform 0.2s;
    position: relative;
    overflow: hidden;
}
.animal-card:active {
    transform: scale(0.98);
}
/* Sol taraftaki renkli şerit (Cinsiyete göre değişecek) */
.status-stripe {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 6px;
}
.gender-female { background-color: #fbbf24; } /* Sarı (Dişi) */
.gender-male { background-color: #ef4444; }   /* Kırmızı (Erkek) */

.animal-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}
/* --- KÜPE NUMARASI YAZI TİPİ DÜZELTME --- */
.tag-badge {
    background: #f1f5f9;        /* Açık gri arka plan */
    border: 1px solid #cbd5e1;  /* İnce kenarlık */
    color: #1e293b;             /* Koyu yazı rengi */
    
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important; /* Modern Font */
    
    font-weight: 800;           /* Kalın yazı */
    padding: 6px 12px;          /* İç boşluk */
    border-radius: 10px;        /* Köşeleri yuvarla */
    font-size: 1.1rem;          /* Yazı boyutu ideal */
    letter-spacing: 0.5px;      /* Harf aralığı */
    box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Hafif gölge */
}
.action-btn-group {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    border-top: 1px solid #f1f5f9;
    padding-top: 10px;
}
.btn-action {
    flex: 1;
    border-radius: 12px;
    font-size: 0.8rem;
    padding: 8px;
    font-weight: 600;
    display: flex; align-items: center; justify-content: center; gap: 5px;
}

        /* GENEL AYARLAR */
        body {
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
            padding-bottom: 90px;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* CÜZDAN KARTI */
        .wallet-card {
            background: linear-gradient(135deg, #0f766e 0%, #115e59 100%);
            color: white; border-radius: 24px; padding: 25px;
            margin: 20px 20px 10px 20px;
            box-shadow: 0 15px 30px rgba(15, 118, 110, 0.25);
            position: relative; overflow: hidden;
        }
        .wallet-card::after {
            content: '\f555'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; right: -20px; bottom: -40px;
            font-size: 9rem; opacity: 0.08; transform: rotate(-20deg);
        }
        .balance-title { font-size: 0.75rem; opacity: 0.9; letter-spacing: 1.5px; text-transform: uppercase; font-weight: 600; }
        .balance-amount { font-size: 2.6rem; font-weight: 800; line-height: 1; margin: 8px 0; letter-spacing: -1px;}

      /* KOMPAKT VE ŞIK KARTLAR */
        .quick-card {
            border: none;
            border-radius: 18px; /* Köşeler ideal yuvarlaklıkta */
            color: white;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            height: 100px; /* YÜKSEKLİK AZALTILDI (125px -> 100px) */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 6px 15px rgba(0,0,0,0.12); /* Gölge yumuşatıldı */
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        /* Tıklama Efekti */
        .quick-card:active { 
            transform: scale(0.96); 
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        /* Arka Plan İkonu (Süsleme) */
        .quick-card i.bg-icon {
            position: absolute;
            right: -10px;
            bottom: -10px;
            font-size: 3.5rem; /* Süsleme ikonu küçültüldü */
            opacity: 0.15;
            transform: rotate(-15deg);
            z-index: 0;
        }

        /* Ana İkon */
        .quick-card i.fa-2x {
            font-size: 1.8rem; /* Ana ikon boyutu dengelendi */
            margin-bottom: 6px; /* Yazı ile arası yakınlaştırıldı */
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        /* Kart Yazısı */
        .quick-card h6 {
            font-weight: 700;
            font-size: 0.85rem; /* Yazı boyutu kibarlaştırıldı */
            margin: 0;
            z-index: 1;
            letter-spacing: 0.3px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        /* ALT MENÜ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 75px;
            background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.06); display: flex; justify-content: space-around;
            align-items: center; z-index: 1050; padding-bottom: 10px;
        }
        .nav-item {
            background: none; border: none; text-align: center; color: #94a3b8;
            font-size: 0.75rem; font-weight: 600; width: 33%;
            display: flex; flex-direction: column; align-items: center; gap: 6px;
        }
        .nav-item i { font-size: 1.5rem; transition: transform 0.2s; }
        .nav-item.active { color: #0f766e; }
        .nav-item.active i { transform: translateY(-4px); }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex;
            align-items: center; justify-content: center; flex-direction: column;
        }
/* SweetAlert Buton Güzelleştirme */
.swal2-actions {
    justify-content: space-between !important;
    width: 100%;
    padding: 0 10px !important;
}
.swal2-confirm, .swal2-cancel {
    border-radius: 12px !important;
    padding: 12px 25px !important;
    font-weight: 600 !important;
    flex: 1;
    margin: 5px !important;
}
.swal2-popup {
    border-radius: 24px !important;
    padding: 20px !important;
}
.siparis-satir {
    transition: all 0.3s ease;
    border: 1px solid #e2e8f0 !important;
}
.siparis-satir:hover {
    border-color: #0f766e !important;
    background-color: #f0fdfa !important;
}

/* Mobil Tablo Hizalama ve Genişlik Ayarları */
.table-fixed { table-layout: fixed; width: 100%; }
.col-ay { width: 25%; }
.col-aksam { width: 22%; text-align: center; }
.col-sabah { width: 22%; text-align: center; }
.col-toplam { width: 31%; text-align: right; }

.table thead th {
    font-size: 0.7rem !important;
    letter-spacing: 0.5px;
    padding: 12px 5px !important;
    vertical-align: middle;
}

.table tbody td {
    padding: 10px 5px !important;
    vertical-align: middle;
}

/* Telefonlarda yazı boyutlarını optimize et */
@media (max-width: 400px) {
    .badge span.fs-6 { font-size: 0.85rem !important; }
    .fw-bold.text-primary, .fw-bold.text-warning { font-size: 0.9rem !important; }
}


/* Geçmiş Tablosu Kesin Hizalama Ayarları */
#page-history .table {
    table-layout: fixed !important;
    width: 100% !important;
}

#page-history .col-ay { width: 30% !important; text-align: left !important; }
#page-history .col-aksam { width: 22% !important; text-align: center !important; }
#page-history .col-sabah { width: 22% !important; text-align: center !important; }
#page-history .col-toplam { width: 26% !important; text-align: right !important; }

/* YERİNE YAPIŞTIR (Düzeltilmiş Kod) */
#page-history thead th {
    font-size: 0.75rem !important;
    /* color: #64748b !important;  <-- BU SATIRI KALDIRDIK */
    padding: 15px 5px !important;
    background-color: #f8fafc;
    vertical-align: middle !important;
}

#page-history tbody td {
    padding: 12px 5px !important;
    font-size: 0.9rem;
}

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <div class="fw-bold text-muted">Verileriniz Yükleniyor...</div>
    </div>
<div id="page-home">
        <div class="px-3 pt-3">
    <div class="bg-white p-3 rounded-4 shadow-sm border-0">
        <div class="row align-items-center">
            <div class="col-12 d-flex justify-content-between align-items-center">
    <div>
        <small class="text-muted d-block fw-bold" style="font-size: 0.75rem;">
            <i class="fa-solid fa-calendar-check me-1 text-primary"></i> AKTİF DÖNEM
        </small>
        </div>
    <div style="min-width: 150px;"> 
        <select id="activePeriod" class="form-select form-select-sm border-0 bg-light fw-bold text-primary rounded-3 shadow-sm" 
                style="padding-right: 30px;" onchange="periodDegisti(this.value)">
            </select>
    </div>
</div>
        </div>
    </div>
</div>

        <div class="wallet-card" style="padding: 15px 20px;"> <div class="d-flex justify-content-between align-items-center position-relative" style="z-index: 2;">
                
                <div>
                    <div class="balance-title" style="opacity: 0.8; margin-bottom: 2px; font-size: 0.65rem;">ÜRETİCİ BİLGİ SİSTEMİ</div>
                    <div class="fw-bold text-white" id="lblMemberName" style="font-size: 1.4rem; line-height: 1.1;">Hoşgeldiniz</div>
                </div>
                
                

            </div>
        </div>

        <div class="px-3 mt-3">
            <div class="row g-2"> 
                
                <div class="col-4">
                    <div class="quick-card" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);"
                         onclick="sayfaDegistir('page-milk', document.getElementById('nav-milk'))">
                        <i class="bg-icon fa-solid fa-cow"></i>
                        <i class="fa-solid fa-cow fa-2x mb-1"></i>
                        <h6>Sütlerim</h6>
                    </div>
                </div>

              <div class="col-4">
    <div class="quick-card" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);"
         onclick="hesapEkstresiAc()">
        <i class="bg-icon fa-solid fa-wallet"></i>
        <i class="fa-solid fa-wallet fa-2x mb-1"></i>
        <h6>Hesap</h6>
    </div>
</div>
<div class="col-4">
    <div class="quick-card" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);"
         onclick="sayfaDegistir('page-animals', null); hayvanlariGetir();">
        <i class="bg-icon fa-solid fa-paw"></i>
        <i class="fa-solid fa-paw fa-2x mb-1"></i>
        <h6>Hayvanlarım</h6>
    </div>
</div>
<div class="col-4">
    <div class="quick-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);"
         onclick="sayfaDegistir('page-yem-defteri', null); yemDefteriYukle();">
        <i class="bg-icon fa-solid fa-warehouse"></i>
        <i class="fa-solid fa-warehouse fa-2x mb-1"></i>
        <h6>Yem Defteri</h6>
    </div>
</div>
<div class="col-4">
    <div class="quick-card" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);"
         onclick="malzemeSiparisiVer()">
        <i class="bg-icon fa-solid fa-truck-ramp-box"></i>
        <i class="fa-solid fa-cart-shopping fa-2x mb-1"></i>
        <h6>Yem İste</h6>
    </div>
</div>
                <div class="col-4">
                    <div class="quick-card" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);"
     onclick="whatsappDestekAc()">
    <i class="bg-icon fa-brands fa-whatsapp"></i>
    <i class="fa-brands fa-whatsapp fa-2x mb-1"></i>
    <h6>Destek</h6>
</div>
                </div>

            </div>
        </div>

       <div class="px-3 mt-4 mb-4">
            
            <h6 class="fw-bold text-secondary small ps-1 mb-2">AYLIK PERFORMANS</h6>
            <div class="card border-0 shadow-sm mb-4" style="border-radius: 18px;">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-end mb-2">
                        <div>
                            <small class="text-muted d-block" style="font-size: 0.75rem;">Geçen Aya Göre</small>
                            <span class="fw-bold text-dark" id="lblPerfText">Hesaplanıyor...</span>
                        </div>
                        <div class="fw-bold text-primary" id="lblPerfPercent">%0</div>
                    </div>
                    <div class="progress" style="height: 10px; border-radius: 10px; background-color: #e2e8f0;">
                        <div id="progressBar" class="progress-bar bg-primary" role="progressbar" style="width: 0%; border-radius: 10px;"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2" style="font-size: 0.7rem;">
                        <span class="text-muted">Geçen Ay: <span id="lblPrevMonthTotal" class="fw-bold text-dark">0</span> Lt</span>
                        <span class="text-muted">Bu Ay: <span id="lblCurrMonthTotal" class="fw-bold text-dark">0</span> Lt</span>
                    </div>
                </div>
            </div>

            <h6 class="fw-bold text-secondary small ps-1 mb-2">GÜNLÜK AKIŞ (Son Kayıtlar)</h6>
            <div class="d-flex gap-2 overflow-auto pb-2" id="dailySlider" style="white-space: nowrap; -webkit-overflow-scrolling: touch;">
                </div>
<h6 class="fw-bold text-secondary small ps-1 mb-2 mt-4">DUYURULAR</h6>
<div class="card border-0 shadow-sm mb-5" style="border-radius: 18px; overflow: hidden;">
    <div class="list-group list-group-flush" id="announcement-list">
        <div class="text-center py-4 text-muted small">
            <div class="spinner-border spinner-border-sm text-secondary mb-2"></div>
            <div>Yükleniyor...</div>
        </div>
    </div>
</div>
        </div>
    </div>
    <div id="page-yem-defteri" style="display: none; padding-bottom: 80px;">
    <div class="bg-white px-3 pt-4 pb-3 shadow-sm mb-3 position-sticky top-0" style="z-index: 900; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;">
        <div class="d-flex align-items-center">
            <button class="btn btn-light rounded-circle shadow-sm me-3" 
                    onclick="sayfaDegistir('page-home', document.getElementById('nav-home'))"
                    style="width: 40px; height: 40px;">
                <i class="fa-solid fa-arrow-left text-primary"></i>
            </button>
            <div>
                <h5 class="fw-bold text-dark m-0">Yem Defterim</h5>
                <small class="text-muted">Dönemlik Malzeme Dökümü</small>
            </div>
        </div>
    </div>

    <div class="px-3">
    <div class="card border-0 shadow-sm rounded-4 mb-3 overflow-hidden" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);">
        <div class="card-body p-4 text-center text-white">
            <div class="bg-white bg-opacity-20 rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                <i class="fa-solid fa-warehouse fs-4"></i>
            </div>
            <small class="opacity-75 fw-bold text-uppercase" style="letter-spacing: 1px; font-size: 0.7rem;">Dönemlik Toplam Tüketim</small>
            <h2 class="fw-800 mb-0 mt-1" id="yem-toplam-adet" style="font-size: 2.2rem;">0 Adet</h2>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3 px-1">
        <h6 class="fw-bold text-secondary m-0 small">MALZEME DETAYLARI</h6>
        <span class="badge bg-light text-dark border rounded-pill fw-bold" id="yem-kalem-sayisi">0 Kalem</span>
    </div>

    <div id="yem-listesi-container" class="pb-4">
        </div>
</div>
</div>
    <div id="page-milk" style="display: none;">
        <div class="bg-white px-3 pt-3 pb-4 shadow-sm mb-3 position-sticky top-0" style="z-index: 900; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;">
            <div class="d-flex align-items-center mb-3">
    <button class="btn btn-light rounded-circle shadow-sm me-3" 
            onclick="sayfaDegistir('page-home', document.getElementById('nav-home'))"
            style="width: 40px; height: 40px;">
        <i class="fa-solid fa-arrow-left text-primary"></i>
    </button>
    <h5 class="fw-bold text-dark m-0">Süt Geçmişim</h5>
</div>
            
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border-radius: 20px;">
                <div class="card-body d-flex justify-content-between align-items-center px-4 py-3">
                    <div>
                        <div class="small opacity-75 fw-bold text-uppercase mb-1" style="font-size: 0.7rem; letter-spacing: 1px;">BU AY TOPLANAN</div>
                        <div class="display-5 fw-bold"><span id="lblMonthlyMilk">0</span> <span class="fs-4">Lt</span></div>
                    </div>
                    <i class="fa-solid fa-cow fa-2x text-white opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="px-3 pb-3" id="milkList"></div>
    </div>
<div id="page-history" style="display: none;">
        <div class="bg-white px-3 pt-3 pb-4 shadow-sm mb-3 position-sticky top-0" style="z-index: 900; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center">
            <button class="btn btn-light rounded-circle shadow-sm me-3" 
                    onclick="sayfaDegistir('page-home', document.getElementById('nav-home'))"
                    style="width: 40px; height: 40px;">
                <i class="fa-solid fa-arrow-left text-primary"></i>
            </button>
            <h5 class="fw-bold text-dark m-0">Yıllık Özet</h5>
        </div>
        <select id="yearFilter" class="form-select form-select-sm border-0 bg-light fw-bold text-primary shadow-sm" style="width: 110px; height: 40px; border-radius: 12px;">
            </select>
    </div>
            
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #0f766e 0%, #115e59 100%); color: white; border-radius: 20px;">
                <div class="card-body d-flex justify-content-between align-items-center px-4 py-3">
                    <div>
                        <div class="small opacity-75 fw-bold text-uppercase mb-1" style="font-size: 0.7rem; letter-spacing: 1px;">YILLIK GENEL TOPLAM</div>
                        <div class="display-5 fw-bold"><span id="lblYearlyTotal">0</span> <span class="fs-4">Lt</span></div>
                    </div>
                    <i class="fa-solid fa-calendar-check fa-2x text-white opacity-25"></i>
                </div>
            </div>
        </div>

        <div class="px-3 pb-5">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" style="font-size: 0.85rem;">
                        <thead class="bg-light border-bottom">
    <tr class="text-secondary text-uppercase small py-3 align-middle">
        <th class="ps-3 col-ay text-start border-0" style="height: 50px;">AY</th>
        <th class="text-center col-aksam text-primary border-0">AKŞAM</th>
        <th class="text-center col-sabah text-warning border-0">SABAH</th>
        <th class="text-end col-toplam pe-3 text-success border-0">TOPLAM</th>
    </tr>
</thead>
                        <tbody id="yearListBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="page-profile" style="display: none;" class="p-3">
        <h4 class="fw-bold text-dark mb-4">Profil & Ayarlar</h4>
        <div class="card border-0 shadow-sm mb-4 text-center p-4" style="border-radius: 20px;">
            <div class="bg-primary bg-opacity-10 text-primary rounded-circle mx-auto d-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px; font-size: 2rem;">
                <i class="fa-solid fa-user"></i>
            </div>
            <h5 class="fw-bold m-0" id="profName">-</h5>
            <small class="text-muted" id="profVillage">-</small>
        </div>

        <h6 class="text-muted small fw-bold ps-2 mb-2">KİŞİSEL BİLGİLER</h6>
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 20px; overflow: hidden;">
            <div class="list-group list-group-flush">
                <div class="list-group-item p-3 d-flex align-items-center">
                    <div class="icon-box bg-light text-secondary me-3"><i class="fa-solid fa-phone"></i></div>
                    <div>
                        <small class="text-muted d-block" style="font-size:0.7rem">Telefon</small>
                        <span class="fw-bold text-dark" id="profPhone">-</span>
                    </div>
                </div>
                <div class="list-group-item p-3 d-flex align-items-center">
                    <div class="icon-box bg-light text-secondary me-3"><i class="fa-solid fa-id-card"></i></div>
                    <div>
                        <small class="text-muted d-block" style="font-size:0.7rem">TC Kimlik</small>
                        <span class="fw-bold text-dark" id="profTc">-</span>
                    </div>
                </div>
            </div>
        </div>

        <h6 class="text-muted small fw-bold ps-2 mb-2">HESAP AYARLARI</h6>
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 20px; overflow: hidden;">
            <div class="list-group list-group-flush">
                <button onclick="sifreDegistir()" class="list-group-item list-group-item-action p-3 d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-warning bg-opacity-10 text-warning me-3"><i class="fa-solid fa-key"></i></div>
                        <span class="fw-bold text-dark">Şifremi Değiştir</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-muted small"></i>
                </button>
                <button onclick="cikisYap()" class="list-group-item list-group-item-action p-3 d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-danger bg-opacity-10 text-danger me-3"><i class="fa-solid fa-right-from-bracket"></i></div>
                        <span class="fw-bold text-dark">Güvenli Çıkış</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-muted small"></i>
                </button>
            </div>
        </div>

        
        
        <div class="text-center text-muted small mb-5 opacity-50">
            KoopSistem v1.0
        </div>
    </div>
    <div id="page-account" style="display: none; padding-bottom: 80px;">
        
        <div class="bg-white px-3 pt-3 pb-3 shadow-sm mb-3 position-sticky top-0" style="z-index: 900; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;">
           <div class="d-flex justify-content-between align-items-center">
    
    <div class="d-flex align-items-center">
        <button class="btn btn-light rounded-circle shadow-sm me-3" 
                onclick="sayfaDegistir('page-home', document.getElementById('nav-home'))"
                style="width: 40px; height: 40px;">
            <i class="fa-solid fa-arrow-left text-primary"></i>
        </button>
        <div>
            <h5 class="fw-bold text-dark m-0">Hesap Ekstresi</h5>
        </div>
    </div>

    <input type="month" id="accMonthFilter" class="form-control form-control-sm border-primary text-primary fw-bold" style="width: 130px;">
</div>
        </div>

        <div id="account-content" class="px-3">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <div class="mt-2 text-muted">Hesap verileri alınıyor...</div>
            </div>
        </div>

    </div>
<div id="page-animals" style="display: none; padding-bottom: 80px;">
    
    <div class="bg-white px-3 pt-3 pb-3 shadow-sm mb-3 position-sticky top-0" style="z-index: 900; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <button class="btn btn-light rounded-circle shadow-sm me-3" 
                        onclick="sayfaDegistir('page-home', document.getElementById('nav-home'))"
                        style="width: 40px; height: 40px;">
                    <i class="fa-solid fa-arrow-left text-primary"></i>
                </button>
                <div>
                    <h5 class="fw-bold text-dark m-0">Hayvan Varlığım</h5>
                </div>
            </div>
            <button class="btn btn-sm btn-primary fw-bold rounded-pill px-3" onclick="yeniHayvanEkle()">
                <i class="fa-solid fa-plus me-1"></i> Ekle
            </button>
        </div>

        <div class="row g-2 text-center mb-3">
    <div class="col-3">
        <div class="bg-secondary bg-opacity-10 p-2 rounded-4 border border-secondary border-opacity-25 shadow-sm">
            <small class="d-block text-secondary fw-bold" style="font-size:0.55rem">TOPLAM</small>
            <span class="fw-bold text-dark fs-5" id="stat-total">0</span>
        </div>
    </div>
    <div class="col-3">
        <div class="bg-warning bg-opacity-10 p-2 rounded-4 border border-warning border-opacity-25 shadow-sm">
            <small class="d-block text-warning fw-bold" style="font-size:0.55rem">İNEK</small>
            <span class="fw-bold text-dark fs-5" id="stat-inek">0</span>
        </div>
    </div>
    <div class="col-3">
        <div class="bg-info bg-opacity-10 p-2 rounded-4 border border-info border-opacity-25 shadow-sm">
            <small class="d-block text-info fw-bold" style="font-size:0.55rem">GENÇ</small>
            <span class="fw-bold text-dark fs-5" id="stat-genc">0</span>
        </div>
    </div>
    <div class="col-3">
        <div class="bg-danger bg-opacity-10 p-2 rounded-4 border border-danger border-opacity-25 shadow-sm">
            <small class="d-block text-danger fw-bold" style="font-size:0.55rem">ERKEK</small>
            <span class="fw-bold text-dark fs-5" id="stat-erkek">0</span>
        </div>
    </div>
</div>

        <div class="position-relative">
            <input type="text" id="animalSearch" class="form-control rounded-pill ps-5 bg-light border-0" placeholder="Küpe no ile ara..." onkeyup="hayvanAra()">
            <i class="fa-solid fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
        </div>
    </div>
<div id="animal-list-container" class="px-3"></div>
</div> <div id="page-orders" style="display: none; padding-bottom: 80px;">
    <div class="bg-white px-3 pt-4 pb-3 shadow-sm mb-3 position-sticky top-0" style="z-index: 900; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;">
        <div class="d-flex align-items-center">
            <button class="btn btn-light rounded-circle shadow-sm me-3" 
                    onclick="sayfaDegistir('page-home', document.getElementById('nav-home'))"
                    style="width: 40px; height: 40px;">
                <i class="fa-solid fa-arrow-left text-primary"></i>
            </button>
            <div>
                <h5 class="fw-bold text-dark m-0">Siparişlerim</h5>
                <small class="text-muted">Güncel Durum Takibi</small>
            </div>
        </div>
    </div>

    <div id="order-list-container" class="px-3">
        </div>
</div>
    
   <div class="bottom-nav">
        <button class="nav-item active" id="nav-home" onclick="sayfaDegistir('page-home', this)">
            <i class="fa-solid fa-house"></i> <span>Ana Sayfa</span>
        </button>
        
        <button class="nav-item" id="nav-orders" onclick="sayfaDegistir('page-orders', this); siparislerimiGetir();">
            <i class="fa-solid fa-box-open"></i> <span>Siparişler</span>
        </button>
        
        <button class="nav-item" id="nav-milk" onclick="sayfaDegistir('page-history', this)">
            <i class="fa-solid fa-clock-rotate-left"></i> <span>Geçmiş</span>
        </button>
        
        <button class="nav-item" id="nav-profile" onclick="sayfaDegistir('page-profile', this)">
            <i class="fa-solid fa-user"></i> <span>Profil</span>
        </button>
    </div>

<div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning text-dark border-0">
                <h5 class="modal-title fw-bold">Şifre Değiştir</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label small fw-bold">MEVCUT ŞİFRE</label>
                    <input type="password" id="oldPass" class="form-control" placeholder="Şu anki şifreniz">
                </div>
                <hr>
                <div class="mb-3">
                    <label class="form-label small fw-bold">YENİ ŞİFRE</label>
                    <input type="password" id="newPass" class="form-control" placeholder="En az 6 karakter">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">YENİ ŞİFRE (TEKRAR)</label>
                    <input type="password" id="newPassConfirm" class="form-control">
                </div>
                <button class="btn btn-dark w-100 mt-3" onclick="guvenliSifreDegistir()">
                    Güncelle
                </button>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
  <script type="module">
import { 
    auth, db, onAuthStateChanged, signOut, updatePassword,
    doc, getDoc, updateDoc, collection, query, where, getDocs, 
    onSnapshot, addDoc, deleteDoc, orderBy, limit 
} from "../js/firebase-config.js";

import { 
    reauthenticateWithCredential, 
    EmailAuthProvider 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";


let currentMemberId = null;
let currentCoopId = null;
let globalMilkSnapshot = null;

window.periodDegisti = function(val) {
    // 1. Üstteki yazı etiketini güncelle
    const select = document.getElementById("activePeriod");
    const ayIsmi = select.options[select.selectedIndex].text;
    
    
    // 2. Süt verilerini yeni seçilen döneme göre tekrar süz
    if(globalMilkSnapshot) {
        verileriSuzVeYazdir(globalMilkSnapshot);
    }
    
    // 3. Eğer yem defteri sayfası açıksa orayı da tazele
    if(document.getElementById("page-yem-defteri").style.display === "block") {
        yemDefteriYukle();
    }
};


onAuthStateChanged(auth, async (user) => {
    if (user) {
        console.log("Kullanıcı Giriş Yaptı:", user.uid);

        try {
            // 1. Users tablosundaki kullanıcı kaydını çek
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                
                // --- ROL KONTROLÜ VE OTOMATİK DÜZELTME ---
                // Eğer rolü 'member' veya 'uye' değilse hemen atma, önce kontrol et:
                if (userData.role !== 'member' && userData.role !== 'uye') {
                    
                    // Eğer bu kişinin içeride tanımlı bir Üretici ID'si varsa, rolü eksik kalmıştır. Düzelt ve devam et.
                    if (userData.relatedMemberId) {
                        console.log("Rol eksik, otomatik 'member' olarak atanıyor...");
                        await updateDoc(userDocRef, { role: 'member' });
                    } 
                    // Eğer Üretici ID'si de yoksa, gerçekten yetkisizdir. Şimdi at.
                    else {
                        Swal.fire("Hata", "Bu panele sadece üreticiler girebilir. (Rol Tanımsız)", "error");
                        await signOut(auth);
                        return;
                    }
                }
                // -------------------------------------------

                let matchedMemberId = userData.relatedMemberId;
                
                // --- KESİN ÇÖZÜM BURASI ---
                // Eğer bir ID varsa, bu ID gerçekten 'members' tablosunda yaşıyor mu kontrol et
                let isMemberAlive = false;
                if (matchedMemberId) {
                    const checkMember = await getDoc(doc(db, "members", matchedMemberId));
                    isMemberAlive = checkMember.exists();
                }

                // EĞER:
                // 1. Hiç ID yoksa (matchedMemberId yok)
                // 2. İsim "İsimsiz" ise
                // 3. VEYA ID VAR AMA ÜYE SİLİNMİŞSE (!isMemberAlive) -> "Ölü Bağlantı"
                if (!matchedMemberId || !userData.adSoyad || userData.adSoyad === 'İsimsiz' || !isMemberAlive) {
                    
                    console.log("Bağlantı kopuk veya üye silinmiş! Telefon ile yeniden aranıyor...");
                    
                    // Email'den saf numarayı çıkar
                    let rawPhone = user.email.split('@')[0];
                    const phoneNoZero = rawPhone.startsWith('0') ? rawPhone.substring(1) : rawPhone;
                    const phoneWithZero = "0" + phoneNoZero;

                    // Telefonla Üyeyi Bul
                    const q1 = query(collection(db, "members"), where("telefon", "==", phoneNoZero));
                    const q2 = query(collection(db, "members"), where("telefon", "==", phoneWithZero));
                    
                    const snap1 = await getDocs(q1);
                    const snap2 = await getDocs(q2);
                    
                    let foundMember = null;
                    if (!snap1.empty) foundMember = snap1.docs[0];
                    else if (!snap2.empty) foundMember = snap2.docs[0];

                    if (foundMember) {
                        const mData = foundMember.data();
                        currentCoopId = mData.coopId; // <--- BU SATIRI EKLEYİN
                        currentMemberId = foundMember.id; // <--- BU SATIRI EKLEYİN
                        
                        console.log("Üye Tekrar Bulundu! Bağlantı tamir ediliyor: ", mData.ad);
                        
                        // Users Tablosunu YENİ ID ile Güncelle
                        await updateDoc(userDocRef, { 
                            relatedMemberId: foundMember.id, // Yeni ID'yi yaz
                            coopId: mData.coopId,
                            adSoyad: `${mData.ad} ${mData.soyad}`,
                            role: 'member'
                        });
                        
                        // Hemen ekrana yansıt
                        uyeBilgileriniGetir(foundMember.id);

                    } else {
                        // Telefonla da bulunamadıysa gerçekten silinmiştir.
                        Swal.fire("Hata", "Kaydınız silinmiş veya telefon numaranız uyuşmuyor. Yöneticiyle görüşün.", "warning");
                    }
                } else {
                    // Bağlantı sağlamsa normal devam et
                    console.log("Bağlantı sağlam, veriler çekiliyor...");
                    currentMemberId = matchedMemberId;
                    currentCoopId = userData.coopId;
                    uyeBilgileriniGetir(matchedMemberId);
                }
// --- HOŞGELDİN MESAJI (SAĞ ÜST KÖŞE) ---
const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer)
        toast.addEventListener('mouseleave', Swal.resumeTimer)
    }
});

Toast.fire({
    icon: 'success',
    title: 'Hoşgeldiniz!',
    text: `Sn. ${userData.adSoyad || 'Üreticimiz'}, keyifli çalışmalar.`
});
            } else {
                Swal.fire("Hata", "Kullanıcı profili bulunamadı.", "error");
            }
        } catch (error) {
            console.error("Giriş Hatası Detayı:", error);
        }
    } else {
        window.location.href = "../giris.html";
    }
});

        async function uyeBilgileriniGetir(uid) {
            let memberDoc = await getDoc(doc(db, "members", uid));
            if(memberDoc.exists()) {
                const mData = memberDoc.data();
                // Karttaki İsim
                const lblMem = document.getElementById("lblMemberName");
                if(lblMem) lblMem.innerText = `Sn. ${mData.ad} ${mData.soyad}`;
                
                // Profil Sayfası Bilgileri
                document.getElementById("profName").innerText = `${mData.ad} ${mData.soyad}`;
                document.getElementById("profVillage").innerText = mData.koy || "-";
                document.getElementById("profPhone").innerText = mData.telefon || "-";
                document.getElementById("profTc").innerText = mData.tc || "-";
            }
            bakiyeyiDinle(uid); // Bakiye her zaman "Genel Toplam"dır
            sutleriDinle(uid);  // Sütler tarihe göre değişir
            document.getElementById("loader").style.display = "none";
            dogumBildirimiYap(uid);
            duyurulariGetir();
            donemSeciciyiHazirla();
        }

        // BAKİYE HESAPLAMA (Ekranda Gizli, Arka Planda Çalışır)
        function bakiyeyiDinle(uid) {
            const q = query(collection(db, "transactions"), where("memberId", "==", uid));
            onSnapshot(q, (snapshot) => {
                let totalAlacak = 0; let totalBorc = 0;
                snapshot.forEach(doc => {
                    const t = doc.data();
                    const amount = Number(t.amount);
                    if(t.type === 'alacak') totalAlacak += amount;
                    else totalBorc += amount;
                });
                // Bakiye hesaplandı ama ekrana yazdırmıyoruz (istek üzerine)
                console.log("Güncel Bakiye:", totalAlacak - totalBorc);
            });
        }

   // SÜT VERİLERİNİ ÇEKME (DEDEKTİF MODU)
        function sutleriDinle(uid) {
            console.log("Sütler aranıyor... Aranan Üye ID:", uid);

            const q = query(
                collection(db, "milk_records"),
                where("memberId", "==", uid),
                orderBy("date", "desc")
            );

            onSnapshot(q, (snapshot) => {
                globalMilkSnapshot = snapshot; 
                
                console.log("------- SÜT SORGUSU SONUCU -------");
                console.log("Bulunan Toplam Kayıt Sayısı:", snapshot.size);
                
                if (snapshot.size > 0) {
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        console.log("Bulunan Kayıt:", d.dateString, d.liters, "Lt");
                    });
                } else {
                    console.warn("BU ÜYE İÇİN HİÇ SÜT KAYDI YOK! (Veritabanında bu ID ile eşleşen kayıt yok)");
                }
                console.log("----------------------------------");

                // 1. Ana Sayfa (Günlük/Aylık) güncelle
                verileriSuzVeYazdir(snapshot); 
                
                // 2. Geçmiş Sayfası (Yıllık Özet) güncelle
                if(typeof gecmisSayfayiGuncelle === 'function') {
                    gecmisSayfayiGuncelle(snapshot);
                }
            });
        }
        // --- YENİ: GEÇMİŞ SAYFASI İÇİN YILLIK ÖZET ---
        function gecmisSayfayiGuncelle(snapshot) {
            const selectedYear = document.getElementById('yearFilter').value; // Örn: "2025"
            let monthsData = {};
            let yearlyTotal = 0;

            // 12 Ay İçin Boş Veri Oluştur
            for(let i=0; i<12; i++) {
                monthsData[i] = { sabah: 0, aksam: 0, total: 0 };
            }

            snapshot.forEach(doc => {
                const d = doc.data();
                const recordDate = d.date.toDate();
                const recordYear = recordDate.getFullYear().toString();
                
                // Sadece seçili yılın verilerini al
                if(recordYear === selectedYear) {
                    const monthIndex = recordDate.getMonth(); // 0 = Ocak, 11 = Aralık
                    const miktar = Number(d.liters);

                    if(d.period === 'sabah') monthsData[monthIndex].sabah += miktar;
                    else monthsData[monthIndex].aksam += miktar;
                    
                    monthsData[monthIndex].total += miktar;
                    yearlyTotal += miktar;
                }
            });

            // Yıllık Toplamı Yaz
            document.getElementById("lblYearlyTotal").innerText = yearlyTotal.toLocaleString('tr-TR');

            // Tabloyu Doldur
            const tbody = document.getElementById("yearListBody");
            let html = "";
            const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];

            // TABLO OLUŞTURMA DÖNGÜSÜ (YENİ TASARIM)
            for(let i=0; i<12; i++) {
                const row = monthsData[i];
                
                // Sabah - Akşam Değerleri (Varsa kalın ve renkli, yoksa silik tire)
                const aksamVal = row.aksam > 0 
                    ? `<span class="fw-bold text-primary" style="font-size:1rem;">${row.aksam}</span>` 
                    : '<span class="text-muted opacity-25">-</span>';
                    
                const sabahVal = row.sabah > 0 
                    ? `<span class="fw-bold text-warning" style="font-size:1rem;">${row.sabah}</span>` 
                    : '<span class="text-muted opacity-25">-</span>';

                // Toplam Değeri (Varsa Yeşil Badge, yoksa silik tire)
                const totalVal = row.total > 0 
                    ? `<div class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-3 py-2">
                         <span class="fw-bold fs-6">${row.total}</span>
                       </div>` 
                    : '<span class="text-muted opacity-25">-</span>';

                html += `
                <tr>
                    <td class="ps-3 py-3 fw-bold text-secondary" style="font-size: 0.9rem;">${monthNames[i]}</td>
                    <td class="text-center align-middle">${aksamVal}</td>
                    <td class="text-center align-middle">${sabahVal}</td>
                    <td class="text-end pe-3 align-middle">${totalVal}</td>
                </tr>
                `;
            }
            tbody.innerHTML = html;
        }

        // Dinamik Yıl Listesi Oluşturma (2026 ve sonrası için otomatik)
const yearSelect = document.getElementById('yearFilter');
if(yearSelect) {
    const currentYear = new Date().getFullYear();
    yearSelect.innerHTML = "";
    // Mevcut yılın bir fazlasından başlayıp 2023'e kadar listele
    for(let y = currentYear + 1; y >= 2023; y--) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.innerText = y;
        if(y === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
    }
    
    yearSelect.addEventListener('change', () => {
        if(globalMilkSnapshot) gecmisSayfayiGuncelle(globalMilkSnapshot);
    });
}

        // --- YENİ FİLTRELEME VE YAZDIRMA FONKSİYONU ---
        function verileriSuzVeYazdir(snapshot) {
            const selectedMonth = document.getElementById('activePeriod').value; // Doğru satır
            
            // Etiketi Güncelle (Örn: Aralık 2023)
            const dateObj = new Date(selectedMonth);
            const monthName = dateObj.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
            

            let groupedData = {};
            let totalsByDate = {}; 
            let aylikToplam = 0;

            snapshot.forEach(doc => {
                const d = doc.data();
                
                // --- TARİH FİLTRESİ ---
                const recordDate = d.date.toDate(); 
                const recordMonthStr = recordDate.toISOString().slice(0, 7); // "2023-12"

                // Eğer kayıt tarihi, seçilen aya EŞİT DEĞİLSE bu kaydı geç
                if (recordMonthStr !== selectedMonth) return;
                // ----------------------

                const dateKey = recordDate.toLocaleDateString('en-CA');

                if(!groupedData[dateKey]) {
                    groupedData[dateKey] = {
                        dateObj: recordDate,
                        sabah: 0,
                        aksam: 0,
                        total: 0
                    };
                }

                const miktar = Number(d.liters);
                if(d.period === 'sabah') groupedData[dateKey].sabah += miktar;
                else groupedData[dateKey].aksam += miktar;
                groupedData[dateKey].total += miktar;
                
                aylikToplam += miktar;

                if(!totalsByDate[dateKey]) totalsByDate[dateKey] = 0;
                totalsByDate[dateKey] += miktar;
            });

            // 1. Grafiği Güncelle
            paneliGuncelle(snapshot, selectedMonth, aylikToplam);
// 2. Listeyi Güncelle
            const listDiv = document.getElementById("milkList");
            if(listDiv) {
                const rows = Object.values(groupedData).sort((a,b) => b.dateObj - a.dateObj);
                
                // --- TABLO BAŞLANGICI ---
                // Başlık satırına 'py-3' vererek yükselttik
                let html = `
                <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" style="font-size: 0.85rem;">
                            <thead class="bg-light border-bottom">
                                <tr class="text-secondary text-uppercase small py-3 align-middle">
                                    <th class="ps-3 border-0 text-start" style="height: 50px;">TARİH</th>
                                    <th class="text-center text-primary border-0">AKŞAM</th>
                                    <th class="text-center text-warning border-0">SABAH</th>
                                    <th class="text-end pe-3 text-success border-0">TOPLAM</th>
                                </tr>
                            </thead>
                            <tbody>`;

                if(rows.length === 0) {
                    html += `<tr><td colspan="4" class="text-center py-5 text-muted opacity-75">
                        <i class="fa-regular fa-calendar-xmark fa-2x mb-2"></i><br>Bu ayda kayıt bulunamadı.
                    </td></tr>`;
                } else {
                    // --- SATIR DÖNGÜSÜ ---
                    rows.forEach(row => {
                        // Tarih Formatı: 15.12.2025
                        const tamTarih = row.dateObj.toLocaleDateString('tr-TR'); 
                        
                        html += `
                        <tr>
                            <td class="ps-3 py-2 align-middle">
                                <div class="d-flex align-items-center">
                                    <div class="bg-light text-secondary rounded d-flex align-items-center justify-content-center me-2 border" 
                                         style="width: 35px; height: 35px; flex-shrink:0;">
                                        <i class="fa-regular fa-calendar text-muted small"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold text-dark" style="font-size: 0.85rem;">${tamTarih}</div>
                                    </div>
                                </div>
                            </td>
                            
                            <td class="text-center align-middle">
                                ${row.aksam ? `<span class="fw-bold text-primary" style="font-size: 1rem;">${row.aksam}</span>` : '<span class="text-muted opacity-25">-</span>'}
                            </td>
                            
                            <td class="text-center align-middle">
                                ${row.sabah ? `<span class="fw-bold text-warning" style="font-size: 1rem;">${row.sabah}</span>` : '<span class="text-muted opacity-25">-</span>'}
                            </td>
                            
                            <td class="text-end pe-3 align-middle">
                                <div class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-3 py-1">
                                    <span class="fw-bold fs-6">${row.total}</span> <small>Lt</small>
                                </div>
                            </td>
                        </tr>`;
                    });
                }
                html += `</tbody></table></div></div>`;
                listDiv.innerHTML = html;
            }

            // 3. Aylık Toplam Kartını Güncelle
            const lblMonthly = document.getElementById("lblMonthlyMilk");
            if(lblMonthly) lblMonthly.innerText = aylikToplam.toLocaleString('tr-TR');
        }
// ESKİ grafigiGuncelle fonksiyonunu tamamen silebilirsiniz.
        // YERİNE BU FONKSİYONU EKLEYİN:

        function paneliGuncelle(snapshot, selectedMonth, currentMonthTotal) {
            // 1. ÖNCEKİ AYI BUL VE HESAPLA
            const [year, month] = selectedMonth.split('-').map(Number);
            // Bir önceki ayı hesapla (Ocak ise bir önceki yılın Aralığına git)
            const prevDate = new Date(year, month - 2, 1); 
            const prevMonthStr = prevDate.toISOString().slice(0, 7); // Örn: "2025-11"
            
            let prevMonthTotal = 0;
            let dailyRecords = []; // Slider için kayıtlar

            snapshot.forEach(doc => {
                const d = doc.data();
                const rDate = d.date.toDate();
                const rMonthStr = rDate.toISOString().slice(0, 7);
                const dayKey = rDate.toLocaleDateString('tr-TR', {day:'numeric', month:'short'});
                
                // Önceki ay toplamı
                if(rMonthStr === prevMonthStr) {
                    prevMonthTotal += Number(d.liters);
                }

                // Slider için SADECE SEÇİLİ AYIN verilerini topla
                if(rMonthStr === selectedMonth) {
                   // Aynı gün varsa üstüne ekle (Sabah+Akşam birleşsin diye)
                   let existing = dailyRecords.find(x => x.dayKey === dayKey);
                   if(existing) {
                       existing.total += Number(d.liters);
                       if(d.period === 'sabah') existing.sabah += Number(d.liters);
                       else existing.aksam += Number(d.liters);
                   } else {
                       dailyRecords.push({
                           dateObj: rDate,
                           dayKey: dayKey,
                           fullDate: rDate.toLocaleDateString('tr-TR', {weekday:'short'}),
                           total: Number(d.liters),
                           sabah: d.period === 'sabah' ? Number(d.liters) : 0,
                           aksam: d.period === 'aksam' ? Number(d.liters) : 0
                       });
                   }
                }
            });

            // --- PERFORMANS KARTINI GÜNCELLE ---
            document.getElementById("lblPrevMonthTotal").innerText = prevMonthTotal;
            document.getElementById("lblCurrMonthTotal").innerText = currentMonthTotal;

            let percent = 0;
            let barWidth = 0;
            let textDurum = "Veri Yok";

            if (prevMonthTotal > 0) {
                // Yüzde hesapla
                const diff = currentMonthTotal - prevMonthTotal;
                percent = Math.round((diff / prevMonthTotal) * 100);
                
                // Bar doluluk oranı (Max %100 olsun diye sınırladık)
                barWidth = Math.min(Math.round((currentMonthTotal / prevMonthTotal) * 100), 100);
                
                if(currentMonthTotal >= prevMonthTotal) {
                    textDurum = "Geçen ayı geçtiniz!";
                    document.getElementById("lblPerfPercent").className = "fw-bold text-success";
                    document.getElementById("lblPerfPercent").innerText = `+${percent}%`;
                    document.getElementById("progressBar").className = "progress-bar bg-success";
                } else {
                    textDurum = "Geçen ayın gerisinde";
                    document.getElementById("lblPerfPercent").className = "fw-bold text-danger";
                    document.getElementById("lblPerfPercent").innerText = `${percent}%`;
                    document.getElementById("progressBar").className = "progress-bar bg-warning";
                }
            } else {
                // Önceki ay veri yoksa
                textDurum = "Geçmiş veri yok";
                barWidth = 100; 
                document.getElementById("lblPerfPercent").innerText = "-";
            }
            
            document.getElementById("lblPerfText").innerText = textDurum;
            document.getElementById("progressBar").style.width = `${barWidth}%`;


            // --- SLIDER (YATAY KARTLAR) GÜNCELLE ---
            // Tarihe göre yeniden eskiye sırala
            dailyRecords.sort((a,b) => b.dateObj - a.dateObj);
            
            const sliderDiv = document.getElementById("dailySlider");
            let sliderHtml = "";

            if(dailyRecords.length === 0) {
                sliderHtml = `<div class="text-muted small w-100 text-center py-3">Bu ay için henüz kayıt yok.</div>`;
            } else {
                dailyRecords.forEach(rec => {
                    sliderHtml += `
                    <div class="card border-0 shadow-sm" style="min-width: 130px; border-radius: 16px; background-color: #fff;">
                        <div class="card-body p-2 text-center">
                            <span class="badge bg-light text-secondary mb-1" style="font-weight: normal;">${rec.fullDate}</span>
                            <h6 class="fw-bold text-dark m-0 mb-1" style="font-size: 0.9rem;">${rec.dayKey}</h6>
                            <div class="fw-bold text-primary fs-5 mb-1">${rec.total} Lt</div>
                            <div style="font-size: 0.65rem;" class="text-muted opacity-75">
                                <span>S: ${rec.sabah}</span> | <span>A: ${rec.aksam}</span>
                            </div>
                        </div>
                    </div>
                    `;
                });
            }
            sliderDiv.innerHTML = sliderHtml;
        }
        // GRAFİK GÜNCELLEME (Seçilen ayın günlerine göre)
        function grafigiGuncelle(totalsByDate, selectedMonth) {
            const labels = [];
            const dataValues = [];
            
            // Seçilen ayın kaç gün çektiğini bul
            const [year, month] = selectedMonth.split('-');
            const daysInMonth = new Date(year, month, 0).getDate();

            for(let i=1; i<=daysInMonth; i++) {
                const dayStr = String(i).padStart(2, '0');
                const key = `${selectedMonth}-${dayStr}`;
                
                labels.push(i); 
                dataValues.push(totalsByDate[key] || 0);
            }

            if(window.myMilkChart) window.myMilkChart.destroy();
            const ctx = document.getElementById('milkChart');
            if(ctx) {
                window.myMilkChart = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{ 
                            label: 'Litre', 
                            data: dataValues, 
                            backgroundColor: '#ea580c', 
                            borderRadius: 3,
                            barThickness: 'flex', 
                            maxBarThickness: 15
                        }]
                    },
                    options: {
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { 
                            x: { grid: { display: false }, ticks: { font: {size: 10} } }, 
                            y: { beginAtZero: true, grid: { borderDash: [5, 5] } } 
                        }
                    }
                });
            }
        }
// YENİ VE GÜVENLİ ŞİFRE DEĞİŞTİRME FONKSİYONU
window.sifreDegistir = async function() {
    const user = auth.currentUser;
    if (!user) {
        Swal.fire("Hata", "Oturum bulunamadı.", "error");
        return;
    }

    const { value: formValues } = await Swal.fire({
        title: 'Güvenli Şifre Değiştirme',
        html: `
            <div class="text-start">
                <label class="small fw-bold mb-1">Mevcut Şifreniz</label>
                <input id="swal-old-pass" class="form-control mb-3" type="password" placeholder="Doğrulama için mevcut şifreniz">
                <hr>
                <label class="small fw-bold mb-1">Yeni Şifre</label>
                <input id="swal-pass1" class="form-control mb-2" placeholder="En az 6 karakter" type="password">
                <label class="small fw-bold mb-1">Yeni Şifre (Tekrar)</label>
                <input id="swal-pass2" class="form-control" placeholder="Yeni şifreyi tekrar yazın" type="password">
            </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Şifreyi Güncelle',
        cancelButtonText: 'Vazgeç',
        preConfirm: () => {
            return [
                document.getElementById('swal-old-pass').value,
                document.getElementById('swal-pass1').value,
                document.getElementById('swal-pass2').value
            ]
        }
    });

    if (formValues) {
        const [oldPass, p1, p2] = formValues;
        
        // Temel kontroller
        if(!oldPass) return Swal.fire('Hata', 'İşlem için mevcut şifreniz gereklidir.', 'warning');
        if(p1.length < 6) return Swal.fire('Hata', 'Yeni şifre en az 6 karakter olmalıdır.', 'warning');
        if(p1 !== p2) return Swal.fire('Hata', 'Yeni şifreler birbiriyle eşleşmiyor.', 'error');

        try {
            Swal.fire({ title: 'Güncelleniyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            // 1. ADIM: Yeniden Doğrulama (400 Hatasını çözen kısım)
            const credential = EmailAuthProvider.credential(user.email, oldPass);
            await reauthenticateWithCredential(user, credential);

            // 2. ADIM: Şifre Güncelleme
            await updatePassword(user, p1);

            Swal.fire({
                icon: 'success',
                title: 'Başarılı',
                text: 'Şifreniz güvenli bir şekilde güncellendi.',
                timer: 2000
            });
        } catch (error) {
            console.error("Şifre Değiştirme Hatası:", error);
            let mesaj = "Şifre güncellenemedi.";
            
            if (error.code === 'auth/wrong-password') {
                mesaj = "Mevcut şifreniz hatalı. Lütfen kontrol edin.";
            } else if (error.code === 'auth/too-many-requests') {
                mesaj = "Çok fazla hatalı deneme yaptınız. Lütfen daha sonra tekrar deneyin.";
            }
            
            Swal.fire("Hata", mesaj, "error");
        }
    }
}

        // --- ÇIKIŞ YAP (GÜLE GÜLE MESAJLI) ---
window.cikisYap = async function() {
    const result = await Swal.fire({
        title: 'Çıkış Yapılıyor',
        text: "Günü bitiriyor musunuz?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Çıkış Yap',
        cancelButtonText: 'Vazgeç',
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6'
    });

    if (result.isConfirmed) {
        // Hoşça kal Mesajı
        await Swal.fire({
            title: 'Güle Güle!',
            text: 'Emeklerinize sağlık. Bereketli günler dileriz.',
            icon: 'success',
            timer: 2000, // 2 saniye bekle
            showConfirmButton: false,
            timerProgressBar: true
        });

        // Mesaj bittikten sonra çıkış işlemi
        await signOut(auth);
        window.location.href = "../giris.html";
    }
}

   
window.hayvanlariGetir = function() {
    const container = document.getElementById("animal-list-container");
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

    const q = query(collection(db, "animals"), where("memberId", "==", currentMemberId));

    onSnapshot(q, (snapshot) => {
        container.innerHTML = "";
        
        if (snapshot.empty) {
            container.innerHTML = `
                <div class="text-center py-5 opacity-75">
                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 70px; height: 70px;">
                        <i class="fa-solid fa-cow text-secondary fa-2x"></i>
                    </div>
                    <h5>Ahırınız Boş</h5>
                    <p class="small text-muted">Yukarıdaki "Ekle" butonundan hayvan ekleyebilirsiniz.</p>
                </div>`;
            return;
        }

        let stats = { total: 0, inek: 0, genc: 0, erkek: 0 };

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const docId = docSnap.id;
            stats.total++;

            // İstatistik
            if(data.cinsiyet === 'Erkek') stats.erkek++;
            else if(data.tur === 'İnek') stats.inek++;
            else stats.genc++;

            // YAŞ HESABI (Daha okunaklı)
            let yasText = "-";
            if(data.dogumTarihi) {
                const diff = new Date() - new Date(data.dogumTarihi);
                const ageMonth = Math.floor(diff / (1000 * 60 * 60 * 24 * 30.44));
                if(ageMonth < 12) yasText = `${ageMonth} Ay`;
                else yasText = `${Math.floor(ageMonth/12)} Yaş`;
            }

            // GÖRSEL AYARLAR
            const isErkek = data.cinsiyet === 'Erkek';
            const stripeClass = isErkek ? 'gender-male' : 'gender-female';
            // --- DİNAMİK GEBELİK VE KURU DÖNEMİ HESABI ---
            let gebelikBilgi = '';
            let dogumButonu = '';
            
            if (!isErkek && data.gebelik === 'Gebe' && data.tohumlamaTarihi) {
                const tohumlama = new Date(data.tohumlamaTarihi);
                const bugun = new Date();
                
                // 285 gün sonra doğum, 225 gün sonra (doğuma 60 gün kala) kuruya ayırma
                const tahminiDogum = new Date(tohumlama);
                tahminiDogum.setDate(tohumlama.getDate() + 285);
                
                const kuruyaAyirmaTarihi = new Date(tohumlama);
                kuruyaAyirmaTarihi.setDate(tohumlama.getDate() + 225);

                const dogumaKalan = Math.ceil((tahminiDogum - bugun) / (1000 * 60 * 60 * 24));
                const kuruyaKalan = Math.ceil((kuruyaAyirmaTarihi - bugun) / (1000 * 60 * 60 * 24));

                let kuruDurum = '';
                if (kuruyaKalan > 0) {
                    kuruDurum = `<div class="text-primary small fw-bold"><i class="fa-solid fa-droplet-slash me-1"></i>Kuruya: ${kuruyaKalan} Gün</div>`;
                } else {
                    kuruDurum = `<div class="text-success small fw-bold"><i class="fa-solid fa-check-circle me-1"></i>KURUDA</div>`;
                }

                gebelikBilgi = `
                <div class="mt-2 p-2 rounded-3 bg-light border">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="badge bg-danger px-2">GEBE</span>
                        ${kuruDurum}
                    </div>
                    <div class="progress" style="height: 6px; border-radius: 10px;">
                        <div class="progress-bar bg-danger" style="width: ${Math.min(100, ( (285 - dogumaKalan) / 285) * 100)}%"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small class="text-muted" style="font-size:0.65rem">Doğuma: <b>${dogumaKalan} Gün</b></small>
                        <small class="text-muted" style="font-size:0.65rem">Tarih: ${tahminiDogum.toLocaleDateString('tr-TR')}</small>
                    </div>
                </div>`;

                dogumButonu = `
                <button class="btn btn-action btn-success text-white" onclick="dogumKaydet('${docId}', '${data.kupeNo}', '${data.irk || ''}')">
                    <i class="fa-solid fa-cake-candles"></i> Doğum
                </button>`;
            }

            // KART HTML
            const html = `
            <div class="animal-card mb-3 animal-card-item" data-kupe="${data.kupeNo.toLowerCase()}">
                <div class="status-stripe ${stripeClass}"></div>
                <div class="p-3 ps-4">
                    
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="tag-badge mb-1">${data.kupeNo}</div>
                            <div class="small text-muted fw-bold ps-1">${data.rumuz || 'İsimsiz'}</div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-dark border">${data.irk || '-'}</span>
                            <div class="small text-secondary mt-1 text-end fw-bold">${yasText}</div>
                        </div>
                    </div>

                    ${gebelikBilgi}

                    <div class="action-btn-group">
                        <button class="btn btn-action btn-light text-primary border" 
                                onclick="hayvanDuzenleTam('${docId}')">
                            <i class="fa-solid fa-pen-to-square"></i> Düzenle
                        </button>
                        
                        ${dogumButonu}
                        
                        <button class="btn btn-action btn-light text-danger border" onclick="hayvanSil('${docId}')">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>

                </div>
            </div>`;
            
            container.innerHTML += html;
        });

        // İstatistikleri Güncelle
        if(document.getElementById("stat-total")) {
            document.getElementById("stat-total").innerText = stats.total;
            document.getElementById("stat-inek").innerText = stats.inek;
            document.getElementById("stat-genc").innerText = stats.genc;
            document.getElementById("stat-erkek").innerText = stats.erkek;
        }
    });
}

// --- GELİŞMİŞ HAYVAN DÜZENLEME (HER ŞEY DAHİL) ---
window.hayvanDuzenleTam = async function(docId) {
    // 1. Önce mevcut veriyi çekelim ki form dolu gelsin
    const docRef = doc(db, "animals", docId);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
        return Swal.fire("Hata", "Hayvan bilgisi bulunamadı.", "error");
    }

    const data = docSnap.data();
    
    // Tarih formatını ayarla (HTML input için YYYY-MM-DD lazım)
    const dogumTarihiVal = data.dogumTarihi ? data.dogumTarihi : '';
    const tohumlamaTarihiVal = data.tohumlamaTarihi ? data.tohumlamaTarihi : '';

    // 2. Detaylı Formu Aç
    const { value: formValues } = await Swal.fire({
        title: 'Hayvan Düzenle',
        html: `
            <div class="text-start">
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="small fw-bold text-muted">Küpe No</label>
                        <input id="edit-kupe" class="form-control fw-bold" value="${data.kupeNo}">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-muted">Rumuz / İsim</label>
                        <input id="edit-rumuz" class="form-control" value="${data.rumuz || ''}">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="small fw-bold text-muted">Irkı</label>
                    <select id="edit-irk" class="form-select">
                        <option value="Holstein" ${data.irk === 'Holstein' ? 'selected' : ''}>Holstein</option>
                        <option value="Simental" ${data.irk === 'Simental' ? 'selected' : ''}>Simental</option>
                        <option value="Montofon" ${data.irk === 'Montofon' ? 'selected' : ''}>Montofon</option>
                        <option value="Jersey" ${data.irk === 'Jersey' ? 'selected' : ''}>Jersey</option>
                        <option value="Angus" ${data.irk === 'Angus' ? 'selected' : ''}>Angus</option>
                        <option value="Yerli" ${data.irk === 'Yerli' ? 'selected' : ''}>Yerli</option>
                        <option value="Diğer" ${data.irk === 'Diğer' ? 'selected' : ''}>Diğer</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="small fw-bold text-muted">Doğum Tarihi</label>
                    <input type="date" id="edit-dogum" class="form-control" value="${dogumTarihiVal}">
                </div>

                <hr class="my-3 text-secondary">

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="small fw-bold text-muted">Cinsiyet</label>
                        <select id="edit-cinsiyet" class="form-select" onchange="toggleGebelik(this.value)">
                            <option value="Dişi" ${data.cinsiyet === 'Dişi' ? 'selected' : ''}>Dişi</option>
                            <option value="Erkek" ${data.cinsiyet === 'Erkek' ? 'selected' : ''}>Erkek</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-muted">Türü</label>
                        <select id="edit-tur" class="form-select">
                            <option value="İnek" ${data.tur === 'İnek' ? 'selected' : ''}>İnek</option>
                            <option value="Düve" ${data.tur === 'Düve' ? 'selected' : ''}>Düve</option>
                            <option value="Dana" ${data.tur === 'Dana' ? 'selected' : ''}>Dana</option>
                            <option value="Buzağı" ${data.tur === 'Buzağı' ? 'selected' : ''}>Buzağı</option>
                        </select>
                    </div>
                </div>

                <div id="edit-gebelik-wrapper" style="display: ${data.cinsiyet === 'Erkek' ? 'none' : 'block'};">
                    <div class="bg-light p-2 rounded border">
                        <label class="small fw-bold text-primary mb-1">Gebelik Durumu</label>
                        <select id="edit-gebelik" class="form-select mb-2" onchange="toggleTohumlama(this.value)">
                            <option value="Bos" ${data.gebelik === 'Bos' ? 'selected' : ''}>Boş</option>
                            <option value="Gebe" ${data.gebelik === 'Gebe' ? 'selected' : ''}>Gebe</option>
                        </select>
                        
                        <div id="edit-tohumlama-div" style="display: ${data.gebelik === 'Gebe' ? 'block' : 'none'};">
                            <label class="small fw-bold text-muted mb-1">Tohumlama Tarihi</label>
                            <input type="date" id="edit-tohumlama" class="form-control" value="${tohumlamaTarihiVal}">
                        </div>
                    </div>
                </div>

            </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Kaydet',
        confirmButtonColor: '#0f766e',
        cancelButtonText: 'Vazgeç',
        didOpen: () => {
            // SweetAlert içindeki scriptler
            window.toggleGebelik = (val) => {
                document.getElementById('edit-gebelik-wrapper').style.display = val === 'Erkek' ? 'none' : 'block';
            };
            window.toggleTohumlama = (val) => {
                document.getElementById('edit-tohumlama-div').style.display = val === 'Gebe' ? 'block' : 'none';
            };
        },
        preConfirm: () => {
            return {
                kupeNo: document.getElementById('edit-kupe').value.toUpperCase(),
                rumuz: document.getElementById('edit-rumuz').value,
                irk: document.getElementById('edit-irk').value,
                dogumTarihi: document.getElementById('edit-dogum').value,
                cinsiyet: document.getElementById('edit-cinsiyet').value,
                tur: document.getElementById('edit-tur').value,
                gebelik: document.getElementById('edit-cinsiyet').value === 'Erkek' ? 'Bos' : document.getElementById('edit-gebelik').value,
                tohumlamaTarihi: document.getElementById('edit-tohumlama').value
            }
        }
    });

    if (formValues) {
        if(!formValues.kupeNo) return Swal.fire("Hata", "Küpe numarası boş olamaz.", "warning");

        try {
            await updateDoc(docRef, {
                kupeNo: formValues.kupeNo,
                rumuz: formValues.rumuz,
                irk: formValues.irk,
                dogumTarihi: formValues.dogumTarihi,
                cinsiyet: formValues.cinsiyet,
                tur: formValues.tur,
                gebelik: formValues.gebelik,
                tohumlamaTarihi: formValues.tohumlamaTarihi
            });

            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
            Toast.fire({icon: 'success', title: 'Bilgiler Güncellendi'});

        } catch (error) {
            Swal.fire("Hata", "Güncelleme başarısız: " + error.message, "error");
        }
    }
}

// --- 6. DOĞUM KAYDI (ÇOKLU / İKİZ DOĞUM DESTEKLİ) ---
window.dogumKaydet = async function(anneId, anneKupe, anneIrk) {
    const bugun = new Date().toISOString().split('T')[0];

    // Buzağı Satırı HTML Şablonu
    const buzagiSatiriHTML = `
        <div class="buzagi-satir border rounded p-2 mb-2 bg-light position-relative">
            <div class="row g-2">
                <div class="col-5">
                    <label class="small text-muted fw-bold">Küpe No</label>
                    <input type="text" class="form-control form-control-sm fw-bold text-uppercase inp-kupe" placeholder="TR...">
                </div>
                <div class="col-4">
                    <label class="small text-muted fw-bold">Cinsiyet</label>
                    <select class="form-select form-select-sm inp-cinsiyet">
                        <option value="Dişi">Dişi</option>
                        <option value="Erkek">Erkek</option>
                    </select>
                </div>
                <div class="col-3">
                    <label class="small text-muted fw-bold">Irk</label>
                    <select class="form-select form-select-sm inp-irk">
                        <option value="${anneIrk}" selected>${anneIrk}</option>
                        <option value="Holstein">Holstein</option>
                        <option value="Simental">Simental</option>
                        <option value="Montofon">Montofon</option>
                        <option value="Angus">Angus</option>
                        <option value="Yerli">Yerli</option>
                    </select>
                </div>
            </div>
            <button type="button" class="btn-close position-absolute top-0 end-0 m-1 small" aria-label="Close" onclick="this.parentElement.remove()"></button>
        </div>
    `;

    const { value: result } = await Swal.fire({
        title: '🎉 Doğum Bilgisi Girişi',
html: `
    <div class="text-start">
        <div class="alert alert-warning py-2 mb-3">
            <p class="small mb-0">Lütfen hayvanın doğum tarihini ve yavru durumunu giriniz.</p>
        </div>
        
        <div class="mb-3">
            <label class="form-label fw-bold small">Doğum Tarihi</label>
            <input type="date" id="ortak-tarih" class="form-control" value="${bugun}">
        </div>

                <div id="buzagi-container" class="mb-2" style="max-height: 300px; overflow-y: auto;">
                    </div>

                <button type="button" class="btn btn-outline-primary btn-sm w-100 dashed-border fw-bold" id="btn-satir-ekle">
                    <i class="fa-solid fa-plus me-1"></i> Başka Yavru Ekle (İkiz/Üçüz)
                </button>
            </div>
        `,
        width: '600px',
        icon: 'success',
        showCancelButton: true,
        confirmButtonText: 'Kaydet ve Bitir',
        confirmButtonColor: '#198754',
        cancelButtonText: 'İptal',
        didOpen: () => {
            const container = document.getElementById('buzagi-container');
            const btnEkle = document.getElementById('btn-satir-ekle');

            // 1. İlk satırı ekle
            container.insertAdjacentHTML('beforeend', buzagiSatiriHTML);

            // 2. Butona basınca yeni satır ekle
            btnEkle.addEventListener('click', () => {
                container.insertAdjacentHTML('beforeend', buzagiSatiriHTML);
            });
        },
        preConfirm: () => {
            const tarih = document.getElementById('ortak-tarih').value;
            const satirlar = document.querySelectorAll('.buzagi-satir');
            let buzagilar = [];

            // Tüm satırları dolaş ve verileri topla
            satirlar.forEach(satir => {
                const kupe = satir.querySelector('.inp-kupe').value.toUpperCase();
                const cinsiyet = satir.querySelector('.inp-cinsiyet').value;
                const irk = satir.querySelector('.inp-irk').value;

                if (kupe) {
                    buzagilar.push({ kupe, cinsiyet, irk });
                }
            });

            if (buzagilar.length === 0) {
                Swal.showValidationMessage('En az bir buzağı küpe numarası girmelisiniz.');
                return false;
            }

            return { tarih, buzagilar };
        }
    });

    if (result) {
        Swal.fire({title: 'Kaydediliyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

        try {
            // 1. TÜM YAVRULARI EKLE (Döngü ile)
            const promises = result.buzagilar.map(yavru => {
                return addDoc(collection(db, "animals"), {
                    memberId: currentMemberId,
                    coopId: currentCoopId,
                    kupeNo: yavru.kupe,
                    tur: 'Buzağı',
                    cinsiyet: yavru.cinsiyet,
                    irk: yavru.irk,
                    dogumTarihi: result.tarih,
                    anneKupe: anneKupe,
                    kayitTarihi: new Date()
                });
            });

            // Yavruların eklenmesini bekle
            await Promise.all(promises);

            // 2. ANNEYİ GÜNCELLE (Sadece 1 kere)
            await updateDoc(doc(db, "animals", anneId), {
                gebelik: 'Bos',
                tohumlamaTarihi: null,
                sonDogumTarihi: result.tarih
            });

            Swal.fire({
                icon: 'success', 
                title: 'Tebrikler!', 
                text: `${result.buzagilar.length} adet buzağı başarıyla kaydedildi. Anne durumu güncellendi.`
            });

        } catch (error) {
            console.error(error);
            Swal.fire("Hata", error.message, "error");
        }
    }
}

window.malzemeSiparisiVer = async function() {
    let urunOptions = "";
    let urunDetaylari = {};

    try {
        
        const user = auth.currentUser;
        if (!user) return Swal.fire("Hata", "Oturum açmanız gerekiyor.", "error");

        if (!currentCoopId) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if(userDoc.exists()) currentCoopId = userDoc.data().coopId;
        }

        // Eğer hala currentMemberId tanımlı değilse user.uid kullan
        const memberUid = typeof currentMemberId !== 'undefined' ? currentMemberId : user.uid;

        if (!currentCoopId) return Swal.fire("Hata", "İşletme bilgisi alınamadı.", "error");

        // 2. Ürünleri Firebase'den Çek
        Swal.fire({ title: 'Ürünler Hazırlanıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        
        const q = query(collection(db, "products"), where("coopId", "==", currentCoopId));
        const querySnapshot = await getDocs(q);
        Swal.close();

        if (querySnapshot.empty) return Swal.fire("Bilgi", "Sipariş verilebilecek ürün bulunamadı.", "info");

        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const isim = data.name || "İsimsiz Ürün"; 
            const fiyat = Number(data.sellPrice || 0);
            urunOptions += `<option value="${isim}">${isim}</option>`;
            urunDetaylari[isim] = fiyat;
        });

    } catch (error) {
        console.error("Başlangıç hatası:", error);
        return Swal.fire("Hata", "Bir sorun oluştu: " + error.message, "error");
    }

    // Ürün Satırı Şablonu (Mobil Uyumlu Dikey Tasarım)
    const urunSatiriHTML = `
        <div class="siparis-satir rounded-4 p-3 mb-3 bg-white shadow-sm position-relative border" style="padding-top: 2.5rem !important;">
            <button type="button" class="btn btn-sm btn-danger rounded-circle position-absolute top-0 end-0 m-2 shadow-sm d-flex align-items-center justify-content-center" 
                    style="width:28px; height:28px;" onclick="this.parentElement.remove()">
                <i class="fa-solid fa-xmark" style="font-size: 0.8rem;"></i>
            </button>
            <div class="row g-2">
                <div class="col-12 mb-2">
                    <label class="small text-muted fw-bold mb-1 d-flex align-items-center" style="font-size: 0.7rem; letter-spacing: 0.5px;">
                        <i class="fa-solid fa-tag me-1 text-primary"></i> ÜRÜN SEÇİMİ
                    </label>
                    <select class="form-select border-0 bg-light fw-bold inp-urun py-2" style="border-radius: 12px; height: 45px;">${urunOptions}</select>
                </div>
                <div class="col-12">
                    <label class="small text-muted fw-bold mb-1 d-flex align-items-center" style="font-size: 0.7rem; letter-spacing: 0.5px;">
                        <i class="fa-solid fa-weight-hanging me-1 text-primary"></i> SİPARİŞ MİKTARI
                    </label>
                    <input type="number" class="form-control border-0 bg-light fw-bold text-center inp-miktar" 
                           value="1" min="1" style="border-radius: 12px; height: 45px;">
                </div>
            </div>
        </div>`;

    // 3. Sipariş Formunu Göster
    const { value: result } = await Swal.fire({
        title: '<span style="color:#0f766e">📦 Malzeme Siparişi</span>',
        html: `
            <div class="text-start mt-3">
                <div id="sepet-container" class="mb-3"></div>
                
                <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-4 fw-bold rounded-3 py-2" id="btn-urun-ekle">
                    <i class="fa-solid fa-plus-circle me-1"></i> Başka Ürün Ekle
                </button>

                <div class="mb-3">
                    <label class="small fw-bold text-secondary mb-1">Teslimat Tercihi</label>
                    <select id="swal-teslimat" class="form-select border-0 bg-light">
                        <option value="Süt Arabası">Süt Arabası ile Gelsin</option>
                        <option value="Elden Teslim">Kendim gelip Alacağım</option>
                    </select>
                </div>

                <div class="mb-2">
                    <label class="small fw-bold text-secondary mb-1">Sipariş Notu</label>
                    <textarea id="swal-not" class="form-control border-0 bg-light" rows="2" placeholder="Notunuzu buraya yazın..."></textarea>
                </div>
            </div>`,
        showCancelButton: true,
        confirmButtonText: '<i class="fa-solid fa-paper-plane me-2"></i> Siparişi Tamamla',
        cancelButtonText: '<i class="fa-solid fa-xmark me-2"></i> Vazgeç',
        confirmButtonColor: '#0f766e',
        cancelButtonColor: '#64748b',
        didOpen: () => {
            const container = document.getElementById('sepet-container');
            container.insertAdjacentHTML('beforeend', urunSatiriHTML);
            document.getElementById('btn-urun-ekle').addEventListener('click', () => {
                container.insertAdjacentHTML('beforeend', urunSatiriHTML);
            });
        },
        preConfirm: () => {
            const satirlar = document.querySelectorAll('.siparis-satir');
            let sepet = [];
            satirlar.forEach(satir => {
                const urun = satir.querySelector('.inp-urun').value;
                const miktar = Number(satir.querySelector('.inp-miktar').value);
                if (urun && miktar > 0) {
                    sepet.push({ 
                        urun, 
                        miktar, 
                        birimFiyat: urunDetaylari[urun],
                        tutar: miktar * urunDetaylari[urun] 
                    });
                }
            });
            if (sepet.length === 0) return Swal.showValidationMessage('Lütfen en az bir ürün seçiniz.');
            return { 
                sepet, 
                teslimat: document.getElementById('swal-teslimat').value, 
                not: document.getElementById('swal-not').value 
            };
        }
    });

    // 4. Firebase'e Kaydet
    if (result) {
        try {
            Swal.fire({title: 'Siparişiniz İletiliyor...', didOpen: () => Swal.showLoading()});
            
            const toplamTutar = result.sepet.reduce((sum, item) => sum + item.tutar, 0);
            const uyeAdi = document.getElementById("profName")?.innerText || "İsimsiz Üye";
            const memberUid = typeof currentMemberId !== 'undefined' ? currentMemberId : auth.currentUser.uid;

            // Admin panelindeki listeleme döngüsü ile tam uyumlu yapı
            await addDoc(collection(db, "orders"), {
                coopId: currentCoopId,
                memberId: memberUid,
                memberName: uyeAdi,
                items: result.sepet,         // Admin panelinin okuduğu alan
                totalAmount: toplamTutar,    // Admin panelinin okuduğu alan
                teslimatYontemi: result.teslimat,
                not: result.not,
                tarih: new Date(),
                status: "Bekliyor"
            });

            Swal.fire({
                icon: 'success',
                title: 'Başarılı!',
                text: 'Siparişiniz Yöneticiye iletildi.',
                confirmButtonColor: '#0f766e'
            });

        } catch (e) {
            console.error("Sipariş Kayıt Hatası:", e);
            Swal.fire("Hata", "Sipariş iletilemedi: " + e.message, "error");
        }
    }
};

// --- WHATSAPP DESTEK AKTİF ETME (DİNAMİK) ---
window.whatsappDestekAc = async function() {
    Swal.fire({
        title: 'Destek Hattına Bağlanılıyor...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });

    try {
        if (!currentCoopId) throw new Error("Kurum (Kooperatif) bilgisi bulunamadı.");

        // 1. Firebase'den kooperatif bilgilerini çek
        const docRef = doc(db, "cooperatives", currentCoopId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            // 2. Adminin panele girdiği 'telefon' alanını al
            let rawPhone = data.telefon; 

            if (!rawPhone) {
                throw new Error("Yönetici henüz bir destek numarası tanımlamamış.");
            }

            // 3. Numarayı temizle (Boşluk, parantez, tire varsa siler)
            let phone = rawPhone.replace(/\D/g, '');

            // 4. Türkiye formatına uygun hale getir (Başında 90 yoksa ekle)
            if (phone.startsWith("0")) {
                phone = "9" + phone; // 05xx -> 905xx yapar
            } else if (!phone.startsWith("90")) {
                phone = "90" + phone; // 5xx -> 905xx yapar
            }

            Swal.close();
            
            // 5. WhatsApp'ı hazır mesajla aç
            const mesaj = encodeURIComponent("Merhaba, KoopSistem üzerinden bir konu hakkında destek almak istiyorum.");
            window.open(`https://wa.me/${phone}?text=${mesaj}`, '_blank');
            
        } else {
            throw new Error("Kooperatif kaydı veritabanında bulunamadı.");
        }
    } catch (error) {
        console.error("Destek Hatası:", error);
        Swal.fire({
            icon: 'error',
            title: 'Bağlantı Hatası',
            text: error.message || "Destek hattına şu an ulaşılamıyor.",
            confirmButtonColor: '#0f766e'
        });
    }
}
// --- 5. DOĞUM BİLDİRİM KONTROLÜ ---
window.dogumBildirimiYap = async function(uid) {
    // Sadece 'Gebe' olanları bir kere çekelim
    const q = query(
        collection(db, "animals"), 
        where("memberId", "==", uid),
        where("gebelik", "==", "Gebe")
    );

    const snapshot = await getDocs(q);
    let bildirimListesi = "";
    let sayac = 0;

    snapshot.forEach(doc => {
        const data = doc.data();
        if (data.tohumlamaTarihi) {
            const tohumlama = new Date(data.tohumlamaTarihi);
            const bugun = new Date();
            
            // Tahmini Doğum (285 Gün)
            const tahminiDogum = new Date(tohumlama);
            tahminiDogum.setDate(tohumlama.getDate() + 285);
            
            // Kalan Gün Hesabı
            const farkZaman = tahminiDogum - bugun;
            const kalanGun = Math.ceil(farkZaman / (1000 * 60 * 60 * 24));

            // Sadece Son 10 Güne Girenler (veya günü geçmiş ama 30 günü geçmemişler)
            if (kalanGun <= 10 && kalanGun > -30) {
                sayac++;
                let durumMetni = "";
                let renk = "";

                if (kalanGun > 0) {
                    durumMetni = `${kalanGun} Gün Kaldı`;
                    renk = "text-danger"; // Kırmızı
                } else if (kalanGun === 0) {
                    durumMetni = "BUGÜN!";
                    renk = "text-success fw-bold"; // Yeşil
                } else {
                    durumMetni = `${Math.abs(kalanGun)} Gün Geçti!`;
                    renk = "text-muted text-decoration-line-through"; // Gri
                }

                bildirimListesi += `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <i class="fa-solid fa-cow me-2 text-primary"></i>
                            <span class="fw-bold text-dark">${data.kupeNo}</span>
                        </div>
                        <span class="${renk} small fw-bold">${durumMetni}</span>
                    </div>
                `;
            }
        }
    });

    // Eğer yaklaşan doğum varsa uyarı ver
    if (sayac > 0) {
        Swal.fire({
            title: '🔔 Doğum Bilgilendirmesi',
html: `
    <div class="alert alert-warning text-start">
        <p class="mb-0" style="font-size:0.85rem;">Lütfen hayvanın doğum tarihini ve yavru durumunu kontrol ederek sisteme işleyiniz.</p>
    </div>
    <div class="bg-light p-3 rounded border text-start">
        ${bildirimListesi}
    </div>
`,
            icon: 'info',
            confirmButtonText: 'Tamam, Anlaşıldı',
            confirmButtonColor: '#0f766e'
        });
    }
}
// --- 9. DUYURULARI GETİR (DÜZELTİLMİŞ HALİ) ---
window.duyurulariGetir = function() {
    const container = document.getElementById("announcement-list");
    
    // Veritabanı sorgusu: En yeni 3 duyuru
    // 'limit' fonksiyonunun import edildiğinden emin olunmalıdır, dosyanın başında vardır.
    const q = query(collection(db, "announcements"), orderBy("tarih", "desc"), limit(3));

    onSnapshot(q, (snapshot) => {
        container.innerHTML = "";

        if (snapshot.empty) {
            container.innerHTML = `
                <div class="p-4 text-center text-muted">
                    <i class="fa-regular fa-bell-slash fa-2x mb-2 opacity-25"></i>
                    <p class="m-0 small">Şu an yeni duyuru yok.</p>
                </div>`;
            return;
        }

        let doluDuyuruSayisi = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            
            // --- KONTROL: Başlık veya İçerik boşsa bu kaydı atla ---
            if (!data.baslik || !data.icerik) return;
            // -------------------------------------------------------

            doluDuyuruSayisi++;

            // Tarih formatı
            let tarihStr = "";
            if(data.tarih) {
                const d = data.tarih.toDate();
                tarihStr = d.toLocaleDateString('tr-TR', {day:'numeric', month:'long'});
            }

            // Önem derecesine göre ikon/renk
            let ikon = "fa-bullhorn"; 
            let renk = "text-primary";
            let bg = "bg-primary";
            
            if(data.onem === 'yuksek') { 
                ikon = "fa-triangle-exclamation"; 
                renk = "text-danger"; 
                bg = "bg-danger";
            } else if (data.onem === 'odeme') {
                ikon = "fa-wallet";
                renk = "text-success";
                bg = "bg-success";
            }

            const item = `
            <div class="list-group-item p-3 border-bottom">
                <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                    <div class="d-flex align-items-center">
                        <div class="${bg} bg-opacity-10 ${renk} rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                            <i class="fa-solid ${ikon} small"></i>
                        </div>
                        <strong class="text-dark small">${data.baslik}</strong>
                    </div>
                    <small class="text-muted" style="font-size:0.65rem">${tarihStr}</small>
                </div>
                <p class="mb-0 text-secondary ps-5 small" style="font-size: 0.8rem; line-height: 1.4;">${data.icerik}</p>
            </div>
            `;
            container.innerHTML += item;
        });

        // Eğer tüm kayıtlar boşsa (filtrelendiyse) yine "Duyuru Yok" yazsın
        if (doluDuyuruSayisi === 0) {
            container.innerHTML = `
                <div class="p-4 text-center text-muted">
                    <i class="fa-regular fa-bell-slash fa-2x mb-2 opacity-25"></i>
                    <p class="m-0 small">Aktif duyuru bulunmuyor.</p>
                </div>`;
        }
    });
}
// --- 2. YENİ HAYVAN EKLE (CİNSİYET KONTROLLÜ) ---
window.yeniHayvanEkle = async function() {
    const { value: formValues } = await Swal.fire({
        title: 'Yeni Hayvan Kartı',
        html: `
            <div class="text-start">
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">Küpe Numarası</label>
                        <input id="swal-kupe" class="form-control fw-bold text-uppercase" placeholder="TR...">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">Rumuz / İsim</label>
                        <input id="swal-rumuz" class="form-control" placeholder="Örn: Sarıkız">
                    </div>
                </div>
                
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">Türü</label>
                        <select id="swal-tur" class="form-select">
                            <option value="İnek">İnek</option>
                            <option value="Düve">Düve</option>
                            <option value="Dana">Dana</option>
                            <option value="Buzağı">Buzağı</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-muted mb-1">Cinsiyeti</label>
                        <select id="swal-cinsiyet" class="form-select">
                            <option value="Dişi">Dişi</option>
                            <option value="Erkek">Erkek</option>
                        </select>
                    </div>
                </div>

                <div id="gebelik-wrapper">
                    <div id="gebelik-container" class="bg-light p-2 rounded border mb-2">
                        <label class="small fw-bold text-primary mb-1">Gebelik Durumu</label>
                        <select id="swal-gebelik" class="form-select mb-2">
                            <option value="Bos">Boş (Gebe Değil)</option>
                            <option value="Gebe">Gebe / Tohumlandı</option>
                        </select>
                        
                        <div id="tarih-div" style="display:none;">
                            <label class="small fw-bold text-muted mb-1">Tohumlama Tarihi</label>
                            <input type="date" id="swal-tohumlama" class="form-control">
                        </div>
                    </div>
                </div>

                <label class="small fw-bold text-muted mb-1">Irkı</label>
                <select id="swal-irk" class="form-select mb-2">
                    <option value="Holstein">Holstein (Siyah Alaca)</option>
                    <option value="Simental">Simental</option>
                    <option value="Montofon">Montofon</option>
                    <option value="Jersey">Jersey</option>
                    <option value="Yerli">Yerli / Melez</option>
                    <option value="Angus">Angus</option>
                    <option value="Diğer">Diğer</option>
                </select>

                <label class="small fw-bold text-muted mb-1">Doğum Tarihi (Yaş İçin)</label>
                <input type="date" id="swal-dogum" class="form-control">
            </div>
        `,
        // --- KRİTİK BÖLÜM: DİNAMİK KONTROLLER ---
        didOpen: () => {
            const cinsiyetSelect = document.getElementById('swal-cinsiyet');
            const gebelikWrapper = document.getElementById('gebelik-wrapper');
            const gebelikSelect = document.getElementById('swal-gebelik');
            const tarihDiv = document.getElementById('tarih-div');

            // 1. Cinsiyet Değişince Çalışacak Kod
            cinsiyetSelect.addEventListener('change', function() {
                if (this.value === 'Erkek') {
                    gebelikWrapper.style.display = 'none'; // Gizle
                    gebelikSelect.value = 'Bos'; // Erkekse boş yap
                } else {
                    gebelikWrapper.style.display = 'block'; // Göster
                }
            });

            // 2. Gebelik Durumu Değişince Çalışacak Kod
            gebelikSelect.addEventListener('change', function() {
                if (this.value === 'Gebe') {
                    tarihDiv.style.display = 'block';
                } else {
                    tarihDiv.style.display = 'none';
                }
            });
        },
        // ----------------------------------------
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Kaydet',
        confirmButtonColor: '#0f766e',
        preConfirm: () => {
            return {
                kupe: document.getElementById('swal-kupe').value.toUpperCase(),
                rumuz: document.getElementById('swal-rumuz').value,
                tur: document.getElementById('swal-tur').value,
                cinsiyet: document.getElementById('swal-cinsiyet').value,
                // Erkekse gebelik verisi 'Bos' gider
                gebelikDurumu: document.getElementById('swal-cinsiyet').value === 'Erkek' ? 'Bos' : document.getElementById('swal-gebelik').value,
                tohumlamaTarihi: document.getElementById('swal-tohumlama').value,
                irk: document.getElementById('swal-irk').value,
                dogum: document.getElementById('swal-dogum').value
            }
        }
    });

    if (formValues) {
        if(!formValues.kupe) return Swal.fire("Hata", "Küpe numarası zorunludur!", "warning");

        try {
            await addDoc(collection(db, "animals"), {
                memberId: currentMemberId,
                coopId: currentCoopId,
                kupeNo: formValues.kupe,
                rumuz: formValues.rumuz,
                tur: formValues.tur,
                cinsiyet: formValues.cinsiyet,
                gebelik: formValues.gebelikDurumu,
                tohumlamaTarihi: formValues.tohumlamaTarihi,
                irk: formValues.irk,
                dogumTarihi: formValues.dogum,
                kayitTarihi: new Date()
            });
            
            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
            Toast.fire({icon: 'success', title: 'Kaydedildi'});

        } catch (error) {
            Swal.fire("Hata", error.message, "error");
        }
    }
}
// --- 3. HIZLI ARAMA ---
window.hayvanAra = function() {
    const input = document.getElementById("animalSearch");
    const filter = input.value.toLowerCase();
    const cards = document.getElementsByClassName("animal-card");

    for (let i = 0; i < cards.length; i++) {
        const kupeNo = cards[i].getAttribute("data-kupe");
        if (kupeNo.indexOf(filter) > -1) {
            cards[i].style.display = "";
        } else {
            cards[i].style.display = "none";
        }
    }
}

    // --- 3. HAYVAN SİL ---
    window.hayvanSil = async function(docId) {
        const res = await Swal.fire({
            title: 'Silinsin mi?',
            text: "Bu hayvan listenizden kaldırılacak.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Evet, Sil',
            confirmButtonColor: '#d33',
            cancelButtonText: 'Vazgeç'
        });

        if(res.isConfirmed) {
            await deleteDoc(doc(db, "animals", docId));
            const Toast = Swal.mixin({toast: true, position: 'top', showConfirmButton: false, timer: 1000});
            Toast.fire({icon: 'success', title: 'Silindi'});
        }
    }
   window.sayfaDegistir = function(sayfaId, element) {
       // Bu satırı bul ve sonuna 'page-yem-defteri' ekle
const pages = ["page-home", "page-milk", "page-history", "page-profile", "page-account", "page-animals", "page-orders", "page-yem-defteri"];
        pages.forEach(id => {
            const p = document.getElementById(id);
            if(p) p.style.display = "none";
        });
        
        const target = document.getElementById(sayfaId);
        if(target) target.style.display = "block";
        
        if(element) {
            document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));
            element.classList.add("active");
        }
        window.scrollTo(0, 0);
    }
        // 1. Sayfayı Aç (GÜNCELLENDİ: ARTIK GÜNCEL AY GELİYOR)
    window.hesapEkstresiAc = function() {
        const d = new Date();
        // d.setMonth(d.getMonth() - 1); // BU SATIRI İPTAL ETTİK (Artık güncel ay geliyor)
        
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        
        const filter = document.getElementById("accMonthFilter");
        // Her açılışta güncel ayı seçmesi için kontrolü kaldırdık, direkt atıyoruz:
        filter.value = `${yyyy}-${mm}`; 
        
        sayfaDegistir('page-account', null); 
        
        ekstreGetir(); // Veriyi çek
    }

    // Tarih değişince tekrar çek
    document.getElementById("accMonthFilter").addEventListener("change", ekstreGetir);

async function ekstreGetir() {
        const selectedPeriod = document.getElementById("accMonthFilter").value; 
        const container = document.getElementById("account-content");
        
        container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2 small text-muted">Geçmiş dönem hesaplanıyor...</div></div>';

        try {
            // 1. MEVCUT DÖNEMİ ÇEK (Örn: Aralık)
            const docId = `${currentMemberId}_${selectedPeriod}`;
            const docRef = doc(db, "monthly_statements", docId);
            const docSnap = await getDoc(docRef);

            // 2. ÖNCEKİ DÖNEMİ BUL VE DETAYLI HESAPLA (Örn: Kasım)
            let [yil, ay] = selectedPeriod.split('-').map(Number);
            let prevDate = new Date(yil, ay - 2, 1); 
            let prevKey = `${prevDate.getFullYear()}-${String(prevDate.getMonth()+1).padStart(2,'0')}`;
            let prevDocId = `${currentMemberId}_${prevKey}`;
            
            const prevDocSnap = await getDoc(doc(db, "monthly_statements", prevDocId));

            // --- OTOMATİK DEVİR HESAPLAMA (Veritabanındaki toplama güvenme, yeniden hesapla) ---
            let activeDevirBakiye = 0;

            if(prevDocSnap.exists()) {
                const pData = prevDocSnap.data();
                
                // A. Önceki Ayın Devrini Al
                let pDevir = pData.devirBakiye || 0;
                
                // B. Önceki Ayın Sütlerini Topla
                let pSutToplami = 0;
                if(pData.sutListesi) {
                    pData.sutListesi.forEach(item => pSutToplami += Number(item.tutar || item.amount || 0));
                }

                // C. Önceki Ayın Satışlarını Topla
                let pSatisToplami = 0;
                if(pData.satisListesi) {
                    pData.satisListesi.forEach(item => pSatisToplami += Number(item.amount || 0));
                }

                // D. Önceki Ayın Nakit Hareketlerini Topla
                let pGiren = 0, pCikan = 0;
                if(pData.nakitListesi) {
                    pData.nakitListesi.forEach(item => {
                        if(item.type === 'alacak') pGiren += Number(item.amount || 0);
                        else pCikan += Number(item.amount || 0);
                    });
                }

                // E. Devir Yönünü Ayarla (Negatif: Alacak, Pozitif: Borç)
                // Sistemimizde:
                // Alacaklar (Giriş) = Süt + NakitGiriş
                // Borçlar (Çıkış) = Satış + NakitÇıkış
                // Devir Mantığı: pDevir < 0 ise Alacak, > 0 ise Borç.

                let pGenelAlacak = pSutToplami + pGiren;
                let pGenelBorc = pSatisToplami + pCikan;

                if(pDevir < 0) pGenelAlacak += Math.abs(pDevir); // Devir alacaksa alacaklara ekle
                else pGenelBorc += pDevir; // Devir borçsa borçlara ekle

                // F. Sonucu Bul (Alacak - Borç)
                // Pozitif çıkarsa Alacaklıyız demektir.
                // ANCAK: Bizim devirBakiye mantığımızda Alacak genellikle NEGATİF saklanıyor olabilir.
                // KODUN Geri kalanına uyumlu olması için:
                // Eğer Sonuç (Alacak - Borç) > 0 ise -> Kullanıcı Alacaklı -> Bunu Devir olarak nasıl gösterelim?
                // Aşağıdaki koda göre:
                // activeDevirBakiye < 0 ise ALACAKLI
                // activeDevirBakiye > 0 ise BORÇLU
                
                let netSonuc = pGenelAlacak - pGenelBorc;
                
                // Eğer Net Sonuç Pozitifse (Paramız var), bunu sisteme ALACAK (Negatif) olarak tanıtacağız
                // Eğer Net Sonuç Negatifse (Borcumuz var), bunu sisteme BORÇ (Pozitif) olarak tanıtacağız
                // ÇÜNKÜ: Aşağıdaki kodda "devirBakiye < 0 -> Alacak" mantığı kurulu.
                
                if(netSonuc > 0) activeDevirBakiye = -Math.abs(netSonuc); // Alacak
                else activeDevirBakiye = Math.abs(netSonuc); // Borç

            } else {
                // Önceki ay yoksa mevcut belgedeki manuel devri kullan
                if(docSnap.exists()) {
                    activeDevirBakiye = docSnap.data().devirBakiye || 0;
                }
            }

            // --- VERİ KONTROLÜ ---
            if(!docSnap.exists()) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="fa-solid fa-file-invoice fa-3x mb-3 opacity-25"></i>
                        <h5>Hesap Yayınlanmadı</h5>
                        <p class="small">Seçilen dönem (${selectedPeriod}) için henüz hesap özeti yayınlanmamış.</p>
                    </div>`;
                return;
            }

            const data = docSnap.data();

            // YARDIMCI FORMAT FONKSİYONLARI
            const fmt = (num) => Number(num).toLocaleString('tr-TR', {minimumFractionDigits: 2}) + ' ₺';
            const dateFmt = (ts) => {
                if(!ts) return '-';
                if(ts.seconds) return new Date(ts.seconds * 1000).toLocaleDateString('tr-TR');
                return ts; 
            };

            // --- 1. SÜT BEDELLERİ (BU AY) ---
            let sutRows = '';
            let hesaplananSutToplami = 0; 

            if(data.sutListesi && data.sutListesi.length > 0) {
                data.sutListesi.forEach(item => {
                    let ayAdi = 'Dönem';
                    try {
                        if(item.tarih) {
                            const parts = item.tarih.split('.');
                            if(parts.length === 3) {
                                const d = new Date(parts[2], parts[1]-1, parts[0]);
                                ayAdi = d.toLocaleDateString('tr-TR', { month: 'long' });
                            }
                        } else if(item.date && item.date.seconds) {
                            ayAdi = new Date(item.date.seconds * 1000).toLocaleDateString('tr-TR', { month: 'long' });
                        }
                        ayAdi = ayAdi.charAt(0).toUpperCase() + ayAdi.slice(1);
                    } catch (e) { ayAdi = item.tarih || '-'; }

                    const aciklama = item.aciklama || item.desc || 'Süt Bedeli';
                    const aksam = Number(item.aksam) || 0;
                    const sabah = Number(item.sabah) || 0;
                    const toplamLt = aksam + sabah;
                    const fiyat = item.fiyat || 0;
                    const tutar = Number(item.tutar || item.amount || 0);
                    
                    hesaplananSutToplami += tutar; 

                    sutRows += `
    <tr>
        <td class="text-center text-primary bg-primary bg-opacity-10 fw-bold ps-3">${aksam > 0 ? aksam : '-'}</td>
        <td class="text-center text-warning bg-warning bg-opacity-10 fw-bold">${sabah > 0 ? sabah : '-'}</td>
        <td class="text-center fw-bold text-dark bg-secondary bg-opacity-10">${toplamLt}</td>
        <td class="text-center text-muted small">${fmt(fiyat)}</td>
        <td class="text-end fw-bold text-success pe-3">${fmt(tutar)}</td>
    </tr>
`;
                });
            } else {
                sutRows = '<tr><td colspan="7" class="text-center text-muted small py-3">Bu dönem süt kaydı yok.</td></tr>';
            }

            // --- 2. MAL/HİZMET ALIMLARI (BU AY) ---
            let satisRows = '';
            let hesaplananSatisToplami = 0; 

            if(data.satisListesi && data.satisListesi.length > 0) {
                data.satisListesi.forEach(item => {
                    const urunAdi = item.name;
                    const birimFiyat = item.price;
                    const miktar = item.qty ? `${item.qty} <small class="text-muted">${item.unit || ''}</small>` : '-';
                    const tutar = Number(item.amount || 0);

                    hesaplananSatisToplami += tutar;

                  satisRows += `
    <tr>
        <td class="align-middle ps-3">
            <span class="text-secondary fw-semibold" style="font-size:0.85rem">${urunAdi}</span>
        </td>
        <td class="text-center align-middle fw-bold text-dark small">${miktar}</td>
        <td class="text-end align-middle small text-muted">${fmt(birimFiyat)}</td>
        <td class="text-end align-middle fw-bold text-danger pe-3">-${fmt(tutar)}</td>
    </tr>
`;
                });
            } else {
                satisRows = '<tr><td colspan="5" class="text-center text-muted small py-3">Bu dönem alışveriş yok.</td></tr>';
            }

            // --- 3. NAKİT HAREKETLER (BU AY) ---
            let nakitRows = '';
            let totalGiren = 0; 
            let totalCikan = 0; 

            if(data.nakitListesi && data.nakitListesi.length > 0) {
                data.nakitListesi.forEach(item => {
                    let girenSutunu = '-';
                    let cikanSutunu = '-';
                    const miktar = Number(item.amount);

                    if (item.type === 'alacak') {
                        girenSutunu = `<span class="fw-bold text-dark">${fmt(miktar)}</span>`;
                        totalGiren += miktar;
                    } else {
                        cikanSutunu = `<span class="fw-bold text-dark">${fmt(miktar)}</span>`;
                        totalCikan += miktar;
                    }
                    
                    nakitRows += `
                        <tr>
                            <td class="small text-muted align-middle">${dateFmt(item.date)}</td>
                            <td class="align-middle text-secondary">${item.desc}</td>
                            <td class="text-end align-middle bg-success bg-opacity-10">${girenSutunu}</td>
                            <td class="text-end align-middle bg-danger bg-opacity-10">${cikanSutunu}</td>
                        </tr>
                    `;
                });
            } else {
                nakitRows = '<tr><td colspan="4" class="text-center text-muted small py-3">Bu dönem nakit hareket yok.</td></tr>';
            }

            // --- 4. DETAYLI HESAPLAMA (GÜNCELLENMİŞ DEVİR MANTIĞI İLE) ---
            let devirAlacak = 0;
            let devirBorc = 0;
            let devirSatiriAlacak = ''; 
            let devirSatiriBorc = '';

            // activeDevirBakiye: Önceki aydan hesaplayarak bulduğumuz gerçek bakiye
            if (activeDevirBakiye < 0) {
                // Negatif ise Üye Alacaklı demektir
                devirAlacak = Math.abs(activeDevirBakiye);
                devirSatiriAlacak = `
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom border-light">
                        <span class="text-secondary small">Önceki Aydan Devir (Alacak)</span>
                        <span class="fw-bold text-dark">+ ${fmt(devirAlacak)}</span>
                    </div>`;
            } else if (activeDevirBakiye > 0) {
                // Pozitif ise Üye Borçlu demektir
                devirBorc = activeDevirBakiye;
                devirSatiriBorc = `
                    <div class="d-flex justify-content-between mb-2 pb-2 border-bottom border-light">
                        <span class="text-secondary small">Önceki Aydan Devir (Borç)</span>
                        <span class="fw-bold text-dark">- ${fmt(devirBorc)}</span>
                    </div>`;
            }

            // GENEL TOPLAMLAR (Devir Dahil)
            const genelToplamAlacak = devirAlacak + hesaplananSutToplami + totalGiren;
            const genelToplamBorc = devirBorc + hesaplananSatisToplami + totalCikan;

            // NET DURUM (Alacak - Borç)
            const netDurum = genelToplamAlacak - genelToplamBorc;

            const detayTabloHtml = `
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 pt-4 pb-2">
                        <h6 class="fw-bold text-dark m-0">DÖNEM SONU HESAPLAMA DETAYI</h6>
                    </div>
                    <div class="card-body p-3 pt-0">
                        <div class="mb-4">
                            <h6 class="fw-bold text-success mb-3" style="font-size: 0.8rem;">+ ALACAKLAR (Giriş)</h6>
                            ${devirSatiriAlacak}
                            <div class="d-flex justify-content-between mb-2 pb-2 border-bottom border-light">
                                <span class="text-secondary small">Cari Ay Süt Bedelleri</span>
                                <span class="fw-bold text-dark">+ ${fmt(hesaplananSutToplami)}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span class="text-secondary small">Cari Ay Yapılan Nakit Tahsilatlar</span>
                                <span class="fw-bold text-dark">+ ${fmt(totalGiren)}</span>
                            </div>
                            <div class="d-flex justify-content-between p-2 rounded align-items-center" style="background-color: #d1e7dd;">
                                <span class="fw-bold text-success small">TOPLAM ALACAK</span>
                                <span class="fw-bold text-dark">${fmt(genelToplamAlacak)}</span>
                            </div>
                        </div>
                        <div>
                            <h6 class="fw-bold text-danger mb-3" style="font-size: 0.8rem;">- BORÇLAR (Çıkış)</h6>
                            ${devirSatiriBorc}
                            <div class="d-flex justify-content-between mb-2 pb-2 border-bottom border-light">
                                <span class="text-secondary small">Cari Ay Mal/Hizmet Satışları</span>
                                <span class="fw-bold text-dark">- ${fmt(hesaplananSatisToplami)}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span class="text-secondary small">Cari Ay Yapılan Ödemeler (Avans)</span>
                                <span class="fw-bold text-dark">- ${fmt(totalCikan)}</span>
                            </div>
                            <div class="d-flex justify-content-between p-2 rounded align-items-center" style="background-color: #f8d7da;">
                                <span class="fw-bold text-danger small">TOPLAM BORÇ</span>
                                <span class="fw-bold text-dark">${fmt(genelToplamBorc)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // --- 5. SONUÇ KARTI ---
            let sonucText = '';
            let sonucRenk = '';
            
            if(netDurum > 0) {
                sonucText = `${fmt(netDurum)} ALACAKLISINIZ`;
                sonucRenk = '#198754'; 
            } else if(netDurum < 0) {
                sonucText = `${fmt(Math.abs(netDurum))} BORÇLUSUNUZ`;
                sonucRenk = '#dc3545'; 
            } else {
                sonucText = "HESAP KAPALI (0,00 ₺)";
                sonucRenk = "#6c757d"; 
            }

            // --- ÜST DEVİR KARTI (HESAPLANMIŞ DEVİR İLE) ---
            let ustDevirHtml = '';
            if (activeDevirBakiye !== 0) {
                const isBorc = activeDevirBakiye > 0;
                const devirTutar = Math.abs(activeDevirBakiye);
                const bgStyle = isBorc ? 'background-color: #fff3cd;' : 'background-color: #d1e7dd;';
                const textClass = isBorc ? 'text-danger' : 'text-success';
                const durumYazisi = isBorc ? 'BORÇLU' : 'ALACAKLI';

                ustDevirHtml = `
                <div class="card border-0 mb-3 shadow-sm" style="border-radius: 12px;">
                    <div class="card-body d-flex justify-content-between align-items-center p-3" style="${bgStyle}">
                        <span class="fw-bold text-dark" style="font-size: 0.95rem;">DÖNEM BAŞI DEVİR</span>
                        <span class="fw-bold ${textClass}" style="font-size: 1.1rem;">
                            ${fmt(devirTutar)} ${durumYazisi}
                        </span>
                    </div>
                </div>`;
            } else {
                ustDevirHtml = `
                <div class="card border-0 mb-3 shadow-sm" style="border-radius: 12px;">
                    <div class="card-body d-flex justify-content-between align-items-center p-3 bg-light">
                        <span class="fw-bold text-muted" style="font-size: 0.95rem;">DÖNEM BAŞI DEVİR</span>
                        <span class="fw-bold text-muted">BAKİYE YOK (0,00 ₺)</span>
                    </div>
                </div>`;
            }

            // --- 6. HTML BİRLEŞTİRME ---
            container.innerHTML = `
                ${ustDevirHtml}

                <h6 class="fw-bold text-success mb-2 border-bottom pb-1 mt-2">1. SÜT BEDELLERİ</h6>
                <div class="card border-0 shadow-sm mb-4 overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0 align-middle" style="font-size:0.8rem">
                           <thead class="table-light">
    <tr class="text-center">
        <th class="ps-3">Akşam<br><small>(Lt)</small></th>
        <th>Sabah<br><small>(Lt)</small></th>
        <th>Toplam<br><small>(Lt)</small></th>
        <th>Fiyat</th>
        <th class="text-end pe-3">Tutar</th>
    </tr>
</thead>
                            <tbody>${sutRows}</tbody>
                            <tfoot class="bg-success bg-opacity-10 fw-bold">
    <tr>
        <td colspan="4" class="text-end pe-2">SÜT TUTAR TOPLAMI:</td>
        <td class="text-end text-success pe-3">${fmt(hesaplananSutToplami)}</td>
    </tr>
</tfoot>
                        </table>
                    </div>
                </div>
<h6 class="fw-bold text-danger mb-2 border-bottom pb-1">2. MAL/HİZMET ALIMLARI</h6>
<div class="card border-0 shadow-sm mb-4 overflow-hidden">
    <div class="table-responsive">
        <table class="table table-sm table-striped mb-0 align-middle" style="font-size:0.85rem">
            <thead class="table-light">
                <tr>
                    <th style="width:55%" class="ps-3">Ürün Adı</th>
                    <th class="text-center" style="width:15%">Miktar</th> 
                    <th class="text-end" style="width:15%">Birim Fiyat</th>
                    <th class="text-end pe-3" style="width:15%">Tutar</th>
                </tr>
            </thead>
            <tbody>${satisRows}</tbody>
            <tfoot class="bg-danger bg-opacity-10 fw-bold">
                <tr>
                    <td colspan="3" class="text-end pe-2">BORÇ TOPLAMI:</td> 
                    <td class="text-end text-danger pe-3">${fmt(hesaplananSatisToplami)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<h6 class="fw-bold text-dark mb-2 border-bottom pb-1">3. NAKİT VE DİĞER İŞLEMLER</h6>
<div class="card border-0 shadow-sm mb-4 overflow-hidden">
    <div class="table-responsive">
        <table class="table table-sm table-striped mb-0 align-middle" style="font-size:0.85rem">
            <thead class="table-light">
                <tr>
                    <th class="ps-3">Tarih</th>
                    <th>Açıklama</th>
                    <th class="text-end text-success">Giriş <small>(Tahsilat)</small></th>
                    <th class="text-end pe-3 text-danger">Çıkış <small>(Ödeme)</small></th>
                </tr>
            </thead>
            <tbody>${nakitRows}</tbody>
            <tfoot class="fw-bold bg-secondary bg-opacity-10">
                <tr>
                    <td colspan="2" class="text-end pe-2 text-dark">NAKİT İŞLEM TOPLAMI:</td>
                    <td class="text-end text-success">${fmt(totalGiren)}</td>
                    <td class="text-end text-danger pe-3">${fmt(totalCikan)}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

                ${detayTabloHtml}

                <div class="card border-0 shadow-lg mb-4" style="background-color: ${sonucRenk}; color: white; border-radius: 16px;">
                    <div class="card-body text-center p-4">
                        <small class="opacity-75 fw-bold d-block mb-1 text-uppercase">DÖNEM SONU NET DURUM</small>
                        <h3 class="fw-bold m-0">${sonucText}</h3>
                    </div>
                </div>
            `;

        } catch (error) {
            console.error(error);
            container.innerHTML = '<div class="alert alert-danger">Veri alınırken hata oluştu.</div>';
        }
    }
// Sayfa yüklendiğinde aktif dönemi ve seçiciyi ayarla
window.donemSeciciyiHazirla = function() {
    const select = document.getElementById("activePeriod");
    if(!select) return;

    const simdi = new Date();
    const suAnkiYil = simdi.getFullYear();
    const suAnkiAy = simdi.getMonth() + 1; // 1-12 arası

    select.innerHTML = ""; // Mevcut statik seçenekleri temizle

    // Son 12 ayı listeye otomatik ekle
    for (let i = 0; i < 12; i++) {
        let d = new Date(suAnkiYil, suAnkiAy - 1 - i, 1);
        let yil = d.getFullYear();
        let ay = String(d.getMonth() + 1).padStart(2, '0');
        let ayIsmi = d.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
        
        let opt = document.createElement("option");
        opt.value = `${yil}-${ay}`;
        opt.innerText = ayIsmi;
        if (i === 0) opt.selected = true; // En güncel ayı seçili yap
        select.appendChild(opt);
    }
    
    // İlk açılışta etiketi güncelle
    periodDegisti(select.value);
};
// Tarih seçici değiştiğinde çalışacak ana fonksiyon
window.verileriGetir = function() {
    // Süt verilerini getir (varsa)
    if(typeof sutVerileriniGetir === 'function') sutVerileriniGetir();
    
    // Yem verilerini getir
    if(typeof yemDefteriniGetir === 'function') yemDefteriniGetir();
    
    // Siparişleri getir (varsa)
    if(typeof siparisleriGetir === 'function') siparisleriGetir();
}

// Dönem seçiciye "change" olayını bağla
document.getElementById('activePeriod').addEventListener('change', window.verileriGetir);

window.yemDefteriYukle = async function() {
    const donem = document.getElementById("activePeriod").value;
    const container = document.getElementById("yem-listesi-container");
    const totalDisplay = document.getElementById("yem-toplam-adet");
    const countDisplay = document.getElementById("yem-kalem-sayisi");
    
    if(!currentMemberId) return; 

    container.innerHTML = '<div class="text-center py-5 text-muted"><div class="spinner-border text-primary mb-2"></div><br>Veriler inceleniyor...</div>';

    const docId = `${currentMemberId}_${donem}`;
    const docRef = doc(db, "monthly_statements", docId);

    try {
        const docSnap = await getDoc(docRef);
        let html = "";
        let toplamAdet = 0;
        let kalemSayisi = 0;

        if (docSnap.exists() && docSnap.data().satisListesi && docSnap.data().satisListesi.length > 0) {
            const satislar = docSnap.data().satisListesi;
            kalemSayisi = satislar.length;

            satislar.forEach(item => {
                const urunAdi = item.name || "İsimsiz Ürün";
                const miktar = Number(item.qty || item.adet || 0);
                const birim = item.unit || 'Adet';
                toplamAdet += miktar;

                // Ürün ikonunu isme göre belirle
                let icon = "fa-box";
                if(urunAdi.toLowerCase().includes("yem")) icon = "fa-wheat-awn";
                if(urunAdi.toLowerCase().includes("küspe")) icon = "fa-seedling";
                if(urunAdi.toLowerCase().includes("saman")) icon = "fa-layer-group";

                html += `
                <div class="card border-0 shadow-sm rounded-4 mb-2 overflow-hidden">
                    <div class="card-body p-3 d-flex align-items-center">
                        <div class="bg-light text-primary rounded-3 d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px; flex-shrink:0;">
                            <i class="fa-solid ${icon} fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold text-dark" style="font-size: 0.95rem;">${urunAdi}</div>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-primary bg-opacity-10 text-primary fs-5 px-3 py-1 rounded-pill border border-primary border-opacity-10">
                                ${miktar} <small style="font-size: 0.7rem;">${birim}</small>
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
            totalDisplay.innerText = toplamAdet + " Adet";
            countDisplay.innerText = kalemSayisi + " Kalem";

        } else {
            container.innerHTML = `
                <div class="text-center py-5 bg-white rounded-4 border shadow-sm">
                    <i class="fa-solid fa-folder-open fa-3x text-muted mb-3 opacity-25"></i>
                    <h6 class="fw-bold text-secondary">Kayıt Bulunamadı</h6>
                    <p class="small text-muted mb-0">Seçilen dönemde malzeme kaydınız yok.</p>
                </div>`;
            totalDisplay.innerText = "0 Adet";
            countDisplay.innerText = "0 Kalem";
        }
    } catch (e) {
        console.error("Yem Defteri Hatası:", e);
        container.innerHTML = '<div class="alert alert-danger rounded-4">Veriler yüklenirken bir hata oluştu.</div>';
    }
};
window.siparislerimiGetir = function() {
    const container = document.getElementById("order-list-container");
    container.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            <div class="mt-3 text-muted fw-bold">Siparişleriniz Yükleniyor...</div>
        </div>`;

    const q = query(
        collection(db, "orders"), 
        where("memberId", "==", currentMemberId),
        orderBy("tarih", "desc")
    );

    onSnapshot(q, (snapshot) => {
        container.innerHTML = "";
        
        if (snapshot.empty) {
            container.innerHTML = `
                <div class="text-center py-5 opacity-75">
                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="fa-solid fa-basket-shopping text-secondary fa-2x"></i>
                    </div>
                    <h5 class="fw-bold text-secondary">Henüz Sipariş Yok</h5>
                    <p class="small text-muted">Malzeme ihtiyaçlarınızı buradan talep edebilirsiniz.</p>
                </div>`;
            return;
        }

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const docId = docSnap.id; // Belge ID'si lazım olacak
            
            let tarihStr = "-";
            if(data.tarih && data.tarih.toDate) {
                tarihStr = data.tarih.toDate().toLocaleDateString('tr-TR', {
                    day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit'
                });
            }

            // Durum Ayarları
            let tema = { renk: "warning", ikon: "fa-clock", baslikBg: "bg-warning bg-opacity-25", text: "text-dark" };
            const stat = data.status || "Bekliyor";

            // Sadece "Bekliyor" ise düzenlenebilir olsun
            const isEditable = (stat === "Bekliyor");

            if(stat === "Hazırlanıyor") {
                tema = { renk: "info", ikon: "fa-box-open", baslikBg: "bg-info bg-opacity-25", text: "text-dark" };
            } else if(stat === "Yola Çıktı" || stat === "Dağıtımda") {
                tema = { renk: "primary", ikon: "fa-truck-fast", baslikBg: "bg-primary bg-opacity-25", text: "text-dark" };
            } else if(stat === "Onaylandı" || stat === "Teslim Edildi" || stat === "Tamamlandı") {
                tema = { renk: "success", ikon: "fa-circle-check", baslikBg: "bg-success bg-opacity-25", text: "text-dark" };
            } else if(stat === "Reddedildi" || stat === "İptal") {
                tema = { renk: "danger", ikon: "fa-circle-xmark", baslikBg: "bg-danger bg-opacity-25", text: "text-dark" };
            }

            const urunListesi = data.items || data.urunler || [];
            let urunlerHtml = "";
            let toplamParca = 0;

            if (Array.isArray(urunListesi) && urunListesi.length > 0) {
                urunlerHtml = urunListesi.map(u => {
                    const miktar = Number(u.miktar || u.adet || 0);
                    const urunAdi = u.urun || u.name || "İsimsiz Ürün";
                    toplamParca += miktar;
                    return `
                    <div class="d-flex justify-content-between align-items-center p-2 mb-2 bg-white rounded border border-light shadow-sm">
                        <div class="d-flex align-items-center">
                            <i class="fa-solid fa-caret-right text-${tema.renk} me-2"></i>
                            <span class="fw-bold text-dark" style="font-size: 0.9rem;">${urunAdi}</span>
                        </div>
                        <div class="badge bg-light text-dark border px-3 py-1 rounded-pill">
                            <span class="fw-bold">${miktar}</span> <small>Adet</small>
                        </div>
                    </div>`;
                }).join('');
            }

            // --- İŞLEM BUTONLARI (Sadece Bekliyor ise görünür) ---
            let actionButtons = "";
            if(isEditable) {
                actionButtons = `
                <div class="d-flex gap-2 mt-3 pt-3 border-top border-light">
                    <button class="btn btn-sm btn-light text-primary fw-bold flex-grow-1 border" onclick="siparisDuzenle('${docId}')">
                        <i class="fa-solid fa-pen-to-square me-1"></i> Düzenle
                    </button>
                    <button class="btn btn-sm btn-light text-danger fw-bold flex-grow-1 border" onclick="siparisSil('${docId}')">
                        <i class="fa-solid fa-trash-can me-1"></i> İptal Et
                    </button>
                </div>`;
            }

            const cardHtml = `
                <div class="card border-0 shadow-sm mb-4 overflow-hidden" style="border-radius: 18px;">
                    <div class="card-header border-0 py-3 px-3 d-flex justify-content-between align-items-center ${tema.baslikBg}">
                        <div class="d-flex align-items-center">
                            <div class="bg-white rounded-circle d-flex align-items-center justify-content-center me-2" 
                                 style="width: 35px; height: 35px; color: var(--bs-${tema.renk})">
                                <i class="fa-solid ${tema.ikon}"></i>
                            </div>
                            <div>
                                <small class="d-block text-muted" style="font-size: 0.65rem; line-height:1;">SİPARİŞ TARİHİ</small>
                                <span class="fw-bold text-dark" style="font-size: 0.85rem;">${tarihStr}</span>
                            </div>
                        </div>
                        <span class="badge bg-white text-${tema.renk} border border-${tema.renk} shadow-sm px-3 py-2 rounded-pill">
                            ${stat}
                        </span>
                    </div>

                    <div class="card-body bg-light bg-opacity-10 pt-3">
                        <div class="mb-3">
                            <small class="text-muted ms-1 mb-1 d-block fw-bold" style="font-size: 0.7rem;">SİPARİŞ İÇERİĞİ</small>
                            ${urunlerHtml}
                        </div>

                        <div class="d-flex justify-content-between align-items-center pt-2">
                            <div class="text-muted small">
                                <i class="fa-solid fa-truck-ramp-box me-1"></i>
                                <span>${data.teslimatYontemi || 'Teslimat: -'}</span>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-dark text-white rounded-pill px-3 py-2">
                                    TOPLAM: ${toplamParca} ADET
                                </span>
                            </div>
                        </div>

                        ${data.not ? `<div class="mt-3 p-2 bg-warning bg-opacity-10 rounded border border-warning border-opacity-25 small text-dark"><i class="fa-solid fa-message me-1 text-warning"></i> ${data.not}</div>` : ''}
                        
                        ${actionButtons}
                    </div>
                </div>`;
            
            container.innerHTML += cardHtml;
        });
    });
}

// --- SİPARİŞ SİLME FONKSİYONU ---
window.siparisSil = async function(docId) {
    // Güvenlik: Veritabanı bağlantısı var mı?
    if (!db) { Swal.fire("Hata", "Veritabanı bağlantısı koptu. Sayfayı yenileyin.", "error"); return; }

    const result = await Swal.fire({
        title: 'Sipariş İptali',
        text: "Bu sipariş kalıcı olarak silinecek. Emin misiniz?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Evet, Sil',
        cancelButtonText: 'Vazgeç',
        confirmButtonColor: '#d33',
        cancelButtonColor: '#64748b'
    });

    if (result.isConfirmed) {
        try {
            // Belgeyi sil
            await deleteDoc(doc(db, "orders", docId));
            
            // Başarılı Mesajı
            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 2000});
            Toast.fire({icon: 'success', title: 'Sipariş iptal edildi.'});
            
        } catch (error) {
            console.error("Silme Hatası:", error);
            Swal.fire("Hata", "Silinemedi: " + error.message, "error");
        }
    }
}

// --- SİPARİŞ DÜZENLEME FONKSİYONU ---
window.siparisDuzenle = async function(docId) {
    if (!db) return;

    try {
        // 1. Mevcut veriyi çek
        const siparisRef = doc(db, "orders", docId);
        const docSnap = await getDoc(siparisRef);
        
        if (!docSnap.exists()) {
            Swal.fire("Hata", "Sipariş bulunamadı.", "error");
            return;
        }

        const data = docSnap.data();
        // Hem yeni (items) hem eski (urunler) yapıya bak
        const urunler = data.items || data.urunler || [];

        // 2. HTML Oluştur
        let inputsHtml = "";
        urunler.forEach((u, index) => {
            const ad = u.urun || u.name || "İsimsiz Ürün";
            const miktar = u.miktar || u.adet || 1;
            
            inputsHtml += `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded bg-white">
                    <span class="small fw-bold text-dark text-start w-75 pe-2">${ad}</span>
                    <input type="number" id="edit-qty-${index}" class="form-control form-control-sm text-center fw-bold border-secondary" 
                           value="${miktar}" min="1" style="width: 70px;">
                </div>
            `;
        });

        // 3. Pencereyi Aç
        const { value: formValues } = await Swal.fire({
            title: 'Siparişi Düzenle',
            html: `
                <div class="mb-3 bg-light p-3 rounded border">
                    <label class="small text-muted mb-2 d-block text-start fw-bold">ÜRÜN ADETLERİ</label>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${inputsHtml}
                    </div>
                </div>
                <div class="mb-2 text-start">
                    <label class="small fw-bold text-muted">Sipariş Notu</label>
                    <textarea id="edit-siparis-not" class="form-control" rows="2" placeholder="Notunuzu düzenleyin...">${data.not || ''}</textarea>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Güncelle',
            confirmButtonColor: '#0f766e',
            cancelButtonText: 'Vazgeç',
            preConfirm: () => {
                // Yeni değerleri topla
                const yeniUrunler = urunler.map((u, index) => {
                    const yeniMiktarEl = document.getElementById(`edit-qty-${index}`);
                    const val = Number(yeniMiktarEl.value);
                    
                    return { 
                        ...u, 
                        miktar: val, 
                        adet: val 
                    };
                });
                const yeniNot = document.getElementById('edit-siparis-not').value;

                return { yeniUrunler, yeniNot };
            }
        });

        // 4. Veritabanını Güncelle
        if (formValues) {
            await updateDoc(siparisRef, {
                items: formValues.yeniUrunler,   // Yeni alan
                urunler: formValues.yeniUrunler, // Eski alan (yedek)
                not: formValues.yeniNot,
                // Fiyat hesaplamasını kaldırdık, çünkü fiyatları sildik.
                // Yönetici panelinden fiyatlar tekrar girilebilir.
            });

            Swal.fire({
                icon: 'success',
                title: 'Güncellendi',
                text: 'Siparişiniz başarıyla düzenlendi.',
                timer: 1500,
                showConfirmButton: false
            });
        }

    } catch (error) {
        console.error("Güncelleme Hatası:", error);
        Swal.fire("Hata", "İşlem başarısız: " + error.message, "error");
    }
}

// --- SİPARİŞ DÜZENLEME FONKSİYONU ---
window.siparisDuzenle = async function(docId) {
    // 1. Mevcut veriyi çek
    const docRef = doc(db, "orders", docId);
    const docSnap = await getDoc(docRef);
    
    if (!docSnap.exists()) return;
    const data = docSnap.data();
    const urunler = data.items || data.urunler || [];

    // 2. Düzenleme Formu HTML'i Oluştur
    let inputsHtml = "";
    urunler.forEach((u, index) => {
        const ad = u.urun || u.name;
        const miktar = u.miktar || u.adet;
        // Her ürün için bir satır: İsim ve Adet Kutusu
        inputsHtml += `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded bg-light">
                <span class="small fw-bold text-dark text-start w-50">${ad}</span>
                <input type="number" id="edit-qty-${index}" class="form-control form-control-sm text-center fw-bold border-secondary" 
                       value="${miktar}" min="1" style="width: 80px;">
            </div>
        `;
    });

    // 3. SweetAlert ile Göster
    const { value: formValues } = await Swal.fire({
        title: 'Siparişi Düzenle',
        html: `
            <div class="mb-3">
                <label class="small text-muted mb-2 d-block text-start">Ürün Adetlerini Güncelleyin:</label>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${inputsHtml}
                </div>
            </div>
            <div class="mb-2 text-start">
                <label class="small fw-bold text-muted">Sipariş Notu</label>
                <textarea id="edit-siparis-not" class="form-control" rows="2">${data.not || ''}</textarea>
            </div>
            <div class="alert alert-info small p-2 mt-2 text-start">
                <i class="fa-solid fa-circle-info me-1"></i> Adedi 0 yaparsanız ürün listeden silinmez, en az 1 olmalıdır. Ürünü tamamen çıkarmak için siparişi iptal edip yeniden veriniz.
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Güncelle',
        confirmButtonColor: '#0f766e',
        preConfirm: () => {
            // Yeni değerleri topla
            const yeniUrunler = urunler.map((u, index) => {
                const yeniMiktar = document.getElementById(`edit-qty-${index}`).value;
                return { 
                    ...u, // Eski verileri (fiyat vs) koru
                    miktar: Number(yeniMiktar), 
                    adet: Number(yeniMiktar) // İki alanı da güncelle garanti olsun
                };
            });
            const yeniNot = document.getElementById('edit-siparis-not').value;

            return { yeniUrunler, yeniNot };
        }
    });

    // 4. Veritabanını Güncelle
    if (formValues) {
        try {
            // Toplam tutar değişeceği için basitçe fiyatı varsa hesaplayalım (yoksa eskiyi korur)
            let yeniToplamTutar = 0;
            formValues.yeniUrunler.forEach(u => {
                if(u.birimFiyat) yeniToplamTutar += (u.miktar * u.birimFiyat);
            });

            // Eğer ürünlerin fiyat bilgisi yoksa (0 çıkarsa), eski tutarı ellemeden bırakabiliriz 
            // ama adet değiştiği için tutar hatalı kalabilir. 
            // En temizi: Eğer fiyat varsa güncelle, yoksa 0 yaz (Panelden yönetici düzeltir).
            
            await updateDoc(docRef, {
                items: formValues.yeniUrunler, // Hem items
                urunler: formValues.yeniUrunler, // Hem urunler (garanti olsun)
                not: formValues.yeniNot,
                totalAmount: yeniToplamTutar > 0 ? yeniToplamTutar : data.totalAmount // Varsa güncelle
            });

            Swal.fire({
                icon: 'success',
                title: 'Güncellendi',
                text: 'Siparişiniz başarıyla düzenlendi.',
                timer: 1500,
                showConfirmButton: false
            });

        } catch (error) {
            console.error(error);
            Swal.fire("Hata", "Güncelleme yapılamadı.", "error");
        }
    }
}

    window.donemSeciciyiHazirla = function() {
    const select = document.getElementById("activePeriod");
    if(!select) return;

    const simdi = new Date();
    const suAnkiYil = simdi.getFullYear();
    const suAnkiAy = simdi.getMonth() + 1;

    select.innerHTML = ""; // Eskileri temizle

    // Son 6 ayı listele
    for (let i = 0; i < 6; i++) {
        let d = new Date(suAnkiYil, suAnkiAy - 1 - i, 1);
        let yil = d.getFullYear();
        let ay = String(d.getMonth() + 1).padStart(2, '0');
        let ayIsmi = d.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
        
        let opt = document.createElement("option");
        opt.value = `${yil}-${ay}`;
        opt.innerText = ayIsmi;
        if (i === 0) opt.selected = true; 
        select.appendChild(opt);
    }
    periodDegisti(select.value);
};
    </script>
</body>
</html>