<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetim Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/jpeg" href="app-logo.jpg">
    <link rel="apple-touch-icon" href="app-logo.jpg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    

    <link rel="manifest" href="../manifest.json">
    
  <style>
    :root {
        --primary-color: #0f766e;
        --primary-dark: #134e4a;
        --primary-gradient: linear-gradient(135deg, #0f766e 0%, #0e7490 100%);
        --sidebar-bg: linear-gradient(180deg, #115e59 0%, #0f766e 100%);
        --bg-body: #f1f5f9;
        --sidebar-width: 260px;
    }

    body { 
        background-color: var(--bg-body); 
        font-family: 'Inter', 'Segoe UI', sans-serif; 
        overflow-x: hidden;
        margin: 0;
    }
    
/* Tablo taşmasını engellemek için */
.table-responsive {
    overflow-x: auto; /* Gerekirse kaydır */
    padding-bottom: 5px; /* Alt scrollbarın tabloya yapışmasını engelle */
}

/* Sadece PC ekranında scrollbarı gizle (Mobilde kalsın) */
@media (min-width: 992px) {
    .table-responsive::-webkit-scrollbar {
        height: 4px; /* Çok ince yap */
    }
    .table-responsive::-webkit-scrollbar-thumb {
        background: #cbd5e1; 
        border-radius: 10px;
    }
}
    
/* 1. SIDEBAR (SOL MENÜ - GARANTİ YAPI) */
    .sidebar {
        width: var(--sidebar-width); 
        height: 100vh; /* Ekran boyu kadar */
        position: fixed;
        top: 0; left: 0;
        background: var(--sidebar-bg);
        color: white;
        z-index: 1050; 
        /* Flex Yapısı: Alt alta dizilimi garanti eder */
        display: flex; 
        flex-direction: column; 
        justify-content: space-between;
        overflow: hidden; /* Sidebar'ın kendisi kaymasın, içindeki menü kaysın */
        transition: transform 0.3s ease;
        box-shadow: 4px 0 15px rgba(0,0,0,0.1);
    }
    
    /* Logo Alanı (Sabit) */
    .sidebar-header {
        flex-shrink: 0; /* Asla ezilmesin */
        height: 90px;   /* Rahat bir yükseklik */
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding: 0 15px;
    }

    /* Menü Alanı (Kaydırılabilir) */
    .sidebar-menu {
        flex-grow: 1;    /* Kalan tüm boşluğu kapla */
        overflow-y: auto; /* Sadece burası scroll olsun */
        padding: 10px 0;
        /* Kaydırma çubuğu ayarları */
        scrollbar-width: thin;
        scrollbar-color: rgba(255,255,255,0.2) transparent;
    }
    /* Webkit (Chrome/Safari) scrollbar süslemesi */
    .sidebar-menu::-webkit-scrollbar { width: 4px; }
    .sidebar-menu::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

    /* Alt Kısım (Sabit Çıkış Butonu) */
    .sidebar-footer {
        flex-shrink: 0; /* Asla ezilmesin */
        padding: 15px 20px 25px 20px; /* Alt boşluk biraz fazla olsun */
        background: rgba(0,0,0,0.1); /* Hafif koyu zemin */
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    /* Link Tasarımı (Kompakt) */
    .nav-link { 
        color: rgba(255,255,255,0.9);
        padding: 10px 18px; 
        margin: 4px 12px; 
        border-radius: 8px;
        font-weight: 500; 
        font-size: 0.9rem;
        transition: all 0.2s;
        display: flex; align-items: center; gap: 12px;
        cursor: pointer;
        text-decoration: none;
    }
    
    .nav-link:hover {
        background-color: rgba(255,255,255,0.15);
        color: white;
    }
    
    .nav-link.active {
        background: white;
        color: var(--primary-color);
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .logout-link { 
        background-color: rgba(255,255,255,0.1);
        color: #fca5a5 !important; 
        justify-content: center;
    }
    .logout-link:hover { 
        background-color: rgba(220, 38, 38, 0.2); 
        color: #fecaca !important; 
    }

    /* 2. ANA İÇERİK ALANI */
    .main-content { 
        margin-left: var(--sidebar-width); 
        min-height: 100vh;
        position: relative;
        display: flex; flex-direction: column;
    }

    
    
    .header-title h2 { 
        font-weight: 800; margin: 0; font-size: 1.6rem; /* Font biraz küçüldü */
        line-height: 1.2;
    }
    .header-title small { opacity: 0.9; font-size: 0.85rem; letter-spacing: 0.5px; }
    
    .user-badge {
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(5px);
        padding: 6px 14px;
        border-radius: 50px;
        color: white; border: 1px solid rgba(255,255,255,0.3);
        font-size: 0.85rem;
    }

   /* 1. Header'ın alt boşluğunu azaltıyoruz */
.admin-header {
    background: var(--primary-gradient);
    padding: 20px 30px 20px 30px; /* Alt boşluk 50px'den 20px'e düştü */
    color: white;
    position: relative;
    z-index: 1;
}

/* 2. Kartları yukarı çeken eksi değeri siliyoruz, aşağı itiyoruz */
.content-wrapper {
    margin-top: 20px; /* Eksi (-) kalktı, 20px boşluk verildi */
    padding: 0 30px 30px 30px;
    position: relative;
    z-index: 10;
}

    /* Genel kartlarda taşmayı engellemek için overflow'u sadece rapor alanında esnetiyoruz */
.card { 
    border: none; border-radius: 16px; background: white;
    box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
    overflow: visible; /* overflow: hidden; yerine visible yaptık */
}

/* Arama sonuç listesinin tasarımı ve netliği için */
#repMemberSearchResults {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin-top: 5px;
    z-index: 10000; /* Her şeyin üstünde olması için */
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}
    .dash-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(14, 116, 144, 0.1); }
    
    .dash-card { padding: 25px; position: relative; height: 100%; display: flex; flex-direction: column; justify-content: center; }
    .dash-icon {
        position: absolute; right: -10px; bottom: -10px;
        font-size: 5rem; opacity: 0.05; transform: rotate(-10deg);
    }
    .dash-val { font-size: 2.2rem; font-weight: 800; color: #1e293b; line-height: 1; margin-top: 5px; }
    .dash-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #64748b; font-weight: 700; }

    /* Tablo ve Diğerleri */
    .table-custom thead th { 
        background-color: #f8fafc; color: #475569; padding: 12px; 
        font-size: 0.75rem; text-transform: uppercase; font-weight: 700;
        border-bottom: 2px solid #e2e8f0;
    }
    .table-custom tbody td { padding: 12px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; color: #334155; }
    
    .btn-primary-custom {
        background-color: #0e7490; color: white; border: none; padding: 8px 20px;
        border-radius: 8px; font-weight: 600; box-shadow: 0 4px 12px rgba(14, 116, 144, 0.2);
    }
    .btn-primary-custom:hover { background-color: #155e75; transform: translateY(-2px); color: white; }

    .settings-card { padding: 30px 15px; cursor: pointer; border: 2px solid transparent; text-align: center; }
    .settings-card:hover { border-color: #bae6fd; background: #f0f9ff; }
    .s-icon { width: 60px; height: 60px; border-radius: 18px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
    .icon-blue { background: #e0f2fe; color: #0369a1; }
    .icon-green { background: #dcfce7; color: #15803d; }
    .icon-purple { background: #f3e8ff; color: #7e22ce; }

    .hidden-section { display: none !important; }

/* MOBİL AYARLAR (KAYMA SORUNU ÇÖZÜLDÜ) */
    @media (max-width: 992px) {
        .sidebar { transform: translateX(-100%); }
        .main-content { margin-left: 0; }
        
        /* Header'a yeterli boşluk ver */
        .admin-header { padding: 20px 20px 30px 20px; text-align: center; }
        
        /* BURASI DÜZELTİLDİ: Eksi margin kaldırıldı, artık üstüne binmeyecek */
        .content-wrapper { margin-top: 0 !important; padding: 20px; }
        
        .d-flex.justify-content-between { flex-direction: column; gap: 15px; }
        .user-badge { align-self: center; }
        
        /* Tablolar taşarsa kaydır */
        .table-responsive { overflow-x: auto; }
    }
    /* --- CARİ HESAP STİLLERİ (YENİ) --- */
    .balance-card {
        background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
        color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;
        position: relative; overflow: hidden;
    }
    .balance-card::after {
        content: '\f51e'; font-family: "Font Awesome 6 Free"; font-weight: 900;
        position: absolute; right: -20px; bottom: -30px; font-size: 8rem; opacity: 0.05; transform: rotate(-15deg);
    }
    .b-val { font-size: 2rem; font-weight: 800; line-height: 1.1; }
    
    .action-btn {
        border: none; padding: 10px; border-radius: 12px; width: 100%;
        font-weight: 700; display: flex; flex-direction: column; align-items: center;
        gap: 5px; height: 90px; justify-content: center; transition: transform 0.2s;
    }
    .action-btn:hover { transform: translateY(-3px); }
    .btn-satis { background: #fee2e2; color: #dc2626; } /* Borçlandırır */
    .btn-tahsilat { background: #dcfce7; color: #166534; } /* Alacaklandırır */
    
    .badge-trans { padding: 5px 10px; border-radius: 6px; font-weight: 600; font-size: 0.75rem; }
    .bg-borc { background: #fee2e2; color: #991b1b; }
    .bg-alacak { background: #dcfce7; color: #166534; }
    /* --- YENİ CARİ TASARIM CSS --- */

/* 1. Liste Görünümü Güzelleştirme */
.member-row {
    transition: all 0.2s;
    border-left: 4px solid transparent;
}
.member-row:hover {
    background-color: #eff6ff; /* Hafif mavi arka plan */
    border-left-color: var(--primary-color);
}

/* 2. Offcanvas (Sağdan Açılan Panel) Özelleştirme */
.offcanvas-custom {
    border-top-left-radius: 25px;
    border-bottom-left-radius: 25px;
    box-shadow: -10px 0 30px rgba(0,0,0,0.1) !important;
}
.offcanvas-header-custom {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    color: white;
    padding: 30px 25px;
    position: relative;
    overflow: hidden;
}
/* Arka plan süslemeleri */
.offcanvas-header-custom::before {
    content: ''; position: absolute; top: -50px; right: -50px;
    width: 200px; height: 200px; background: rgba(255,255,255,0.05);
    border-radius: 50%;
}
.offcanvas-header-custom::after {
    content: ''; position: absolute; bottom: -30px; left: -30px;
    width: 150px; height: 150px; background: rgba(255,255,255,0.03);
    border-radius: 50%;
}

/* 3. Bakiye Kartı (Bankacılık Stili) */
.balance-display {
    text-align: center;
    margin-top: 10px;
}
.balance-amount {
    font-size: 2.8rem;
    font-weight: 800;
    letter-spacing: -1px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
.balance-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    opacity: 0.7;
    font-weight: 600;
}

/* 4. Timeline (Zaman Çizelgesi) İşlem Geçmişi */
.timeline {
    position: relative;
    padding: 20px 0;
}
.timeline-item {
    position: relative;
    padding-left: 45px;
    margin-bottom: 25px;
}
/* Çizgi */
.timeline-item::before {
    content: '';
    position: absolute;
    left: 14px; top: 0; bottom: -25px;
    width: 2px;
    background: #e2e8f0;
}
.timeline-item:last-child::before { display: none; }
/* Nokta */
.timeline-dot {
    position: absolute;
    left: 0; top: 5px;
    width: 30px; height: 30px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    background: white;
    border: 4px solid #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    z-index: 2;
}
/* Renkler */
.dot-borc { background-color: #fee2e2; color: #dc2626; }
.dot-alacak { background-color: #dcfce7; color: #166534; }

.timeline-content {
    background: white;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    border: 1px solid #f1f5f9;
}

/* 5. Alt Aksiyon Çubuğu (Sticky) */
.bottom-actions {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    background: white;
    padding: 15px 25px;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
    display: flex; gap: 10px;
    z-index: 10;
}
/* 1. Üst Bilgi Kartı (Daha Kompakt Hali) */
.account-header-card {
    background: linear-gradient(135deg, #0f766e 0%, #0e7490 100%);
    border-radius: 12px;       /* Köşe yuvarlaklığı biraz azaltıldı */
    padding: 15px 20px;        /* İÇ BOŞLUKLAR YARIYA İNDİRİLDİ (Eskisi 30px idi) */
    color: white;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(14, 116, 144, 0.2);
    position: relative;
    overflow: hidden;
}

/* Arka plan süsü (Cüzdan İkonu) - Küçültüldü */
.account-header-card::after {
    content: '\f555';
    font-family: "Font Awesome 6 Free"; font-weight: 900;
    position: absolute; right: -10px; bottom: -20px;
    font-size: 6rem;           /* İKON BOYUTU KÜÇÜLTÜLDÜ (Eskisi 10rem idi) */
    opacity: 0.1; transform: rotate(-15deg);
}

/* Bakiye Yazı Boyutu */
.acc-balance-big { 
    font-size: 2.2rem;         /* YAZI BOYUTU KÜÇÜLTÜLDÜ (Eskisi 3.5rem idi) */
    font-weight: 800; 
    line-height: 1; 
    letter-spacing: -0.5px; 
}

.acc-label { 
    text-transform: uppercase; 
    font-size: 0.7rem; 
    letter-spacing: 1px; 
    opacity: 0.9; 
    font-weight: 600; 
}

.acc-balance-big { font-size: 3.5rem; font-weight: 800; line-height: 1; letter-spacing: -1px; }
.acc-label { text-transform: uppercase; font-size: 0.75rem; letter-spacing: 2px; opacity: 0.8; font-weight: 700; }

/* --- YENİ YATAY BUTON TASARIMI --- */

.quick-action-btn {
    border: none;
    background: white;
    padding: 15px 20px;       /* Yükseklik dengelendi */
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    transition: all 0.2s ease;
    width: 100%;              /* Bulunduğu alanı tam doldur */
    height: 100%;             
    
    /* İÇERİK DÜZENİ: YAN YANA (ROW) */
    display: flex; 
    flex-direction: row;      
    align-items: center;      
    justify-content: flex-start; /* Sola yasla */
    gap: 15px;                /* İkon ve yazı arası boşluk */
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

/* Hover Efekti */
.quick-action-btn:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 8px 20px rgba(0,0,0,0.08); 
    background-color: #f8fafc;
}

/* Tıklama Efekti */
.quick-action-btn:active {
    transform: scale(0.98);
}

/* İkon Kutusu */
.btn-icon-circle {
    width: 45px; height: 45px; 
    border-radius: 10px;       
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;            /* Daralınca ikon ezilmesin */
    margin-bottom: 0;          /* Alt boşluk kaldırıldı */
}
/* Modalı en öne zorla */
#sutHesaplaModal {
    z-index: 10000 !important;
}
/* Arka plan karartmasını da öne al */
.modal-backdrop {
    z-index: 9999 !important;
}
/* Sağ tarafa hafif ok işareti (Süsleme) */
.quick-action-btn::after {
    content: '\f054'; /* FontAwesome sağ ok */
    font-family: "Font Awesome 6 Free"; font-weight: 900;
    position: absolute; right: 20px;
    color: #cbd5e1;
    font-size: 0.9rem;
    opacity: 0.7;
}

/* 3. Hesap Hareketleri Listesi */
.trans-item {
    background: white;
    border-bottom: 1px solid #f1f5f9;
    padding: 15px 20px;
    display: flex; align-items: center; justify-content: space-between;
    transition: background 0.1s;
}
.trans-item:hover { background: #f8fafc; }
.trans-item:last-child { border-bottom: none; }

.trans-icon {
    width: 40px; height: 40px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem; margin-right: 15px;
}
/* --- YENİ HESAP EKSTRESİ TABLOSU --- */
.table-ledger {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.9rem;
}

.table-ledger thead th {
    background-color: #f8fafc; /* Açık gri başlık */
    color: #475569;
    font-weight: 700;
    padding: 15px 10px;
    text-align: left;
    border-bottom: 2px solid #e2e8f0;
    white-space: nowrap;
}

.table-ledger tbody td {
    padding: 6px 10px; /* YENİ DEĞER: Satırlar daraldı */
    border-bottom: 1px solid #f1f5f9;
    color: #334155;
    vertical-align: middle;
    font-size: 0.85rem; /* Yazı fontunu da bir tık küçülttük */
}

.table-ledger tbody tr:hover {
    background-color: #f1f5f9; /* Üzerine gelince parlasın */
}

/* Renklendirme Sınıfları */
.text-borc { color: #dc2626; font-weight: 700; }   /* Kırmızı (Veresiye) */
.text-alacak { color: #166534; font-weight: 700; } /* Yeşil (Ödeme) */
.text-bakiye { color: #0f172a; font-weight: 800; font-size: 1rem; } /* Koyu (Kalan) */

/* Mobilde önemsiz sütunları gizle */
@media (max-width: 768px) {
    .hide-mobile { display: none; }
    .table-ledger { font-size: 0.8rem; }
}
/* --- MODAL ÇAKIŞMA DÜZELTME KODU (EN ALTA EKLE) --- */
.modal {
    z-index: 1060 !important; /* Bootstrap varsayılanından yüksek */
}
.modal-backdrop {
    z-index: 1050 !important; /* Arka plan perdesi */
}
/* Detay penceresi içeriğinin beyaz kalmasını garantiye al */
#detayModal .modal-content {
    background-color: #fff !important;
    color: #000 !important;
}
/* --- DETAY PENCERESİ DİNAMİK TASARIM --- */

/* 1. Başlık Alanı - Gradyan Geçiş */
.modal-header-dynamic {
    background: linear-gradient(135deg, #0f766e 0%, #0e7490 100%); /* Sizin temanızla uyumlu */
    color: white;
    border-bottom: none;
    padding: 20px 25px;
    position: relative;
    overflow: hidden;
}

/* Başlığa hafif bir desen/ikon ekleyelim (Süsleme) */
.modal-header-dynamic::after {
    content: '\f543'; /* FontAwesome Makbuz İkonu */
    font-family: "Font Awesome 6 Free"; font-weight: 900;
    position: absolute;
    right: -10px; bottom: -20px;
    font-size: 6rem;
    opacity: 0.1;
    transform: rotate(-15deg);
}

.btn-close-white {
    filter: invert(1) grayscale(100%) brightness(200%); /* Çarpı işaretini beyaz yap */
}

/* 2. Tablo Düzeni */
.table-invoice thead th {
    background-color: #f8fafc;
    color: #64748b;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 2px solid #e2e8f0;
    padding: 15px;
}
.table-invoice tbody td {
    padding: 15px;
    vertical-align: middle;
    color: #334155;
    font-size: 0.95rem;
    border-bottom: 1px solid #f1f5f9;
}
.table-invoice tbody tr:last-child td {
    border-bottom: none;
}
.table-invoice tbody tr:hover {
    background-color: #f1f5f9; /* Hover efekti */
}

/* 3. Alt Özet Kartı (Receipt Style) */
.summary-box {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05); /* Havada durma efekti */
    position: relative;
}
/* Sol tarafına renkli çizgi */
.summary-box::before {
    content: ''; position: absolute; left: 0; top: 15px; bottom: 15px;
    width: 4px; background: #0e7490; border-radius: 0 4px 4px 0;
}

.total-row {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 8px; font-size: 0.9rem; color: #64748b;
}
.total-final {
    border-top: 2px dashed #e2e8f0;
    margin-top: 10px; padding-top: 10px;
    display: flex; justify-content: space-between; align-items: center;
}
.big-total {
    font-size: 1.6rem; font-weight: 800; color: #0f766e; letter-spacing: -0.5px;
}

/* Açıklama Kutusu */
.note-box {
    background-color: #fffbeb; /* Hafif sarımsı not kağıdı rengi */
    border: 1px solid #fcd34d;
    color: #92400e;
    border-radius: 8px;
    padding: 15px;
    font-size: 0.85rem;
    height: 100%;
}
/* Süt Yönetimi alanını öne çıkar */
#milk-management {
    position: relative;
    z-index: 50 !important; /* Diğer her şeyin önüne geç */
}

/* Header ve Sidebar'ın butonun üstüne binmesini engelle */
.admin-header {
    z-index: 1 !important; /* Arkada kalsın */
}

/* Butonun kendisine tıklamayı garanti et */
#milk-management button {
    position: relative;
    z-index: 100 !important;
    cursor: pointer;
}
/* Hızlı İşlem Kartları Tasarımı */
.quick-card {
    border: none;
    border-radius: 15px;
    color: white;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative;
    overflow: hidden;
    height: 100%;
    min-height: 120px; /* Kart yüksekliği */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}

.quick-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

/* Arka plan süsleme ikonu */
.quick-card i.bg-icon {
    position: absolute;
    right: -10px;
    bottom: -10px;
    font-size: 5rem;
    opacity: 0.15;
    transform: rotate(-20deg);
}

.quick-card h6 { font-weight: 700; margin-top: 10px; font-size: 1.1rem; }
.quick-card small { opacity: 0.9; font-size: 0.8rem; }


/* Yayınla Penceresini de EN ÖNE AL */
#yayinlaModal {
    z-index: 100010 !important;
}
/* Arka plan karartmasını bir alt katmana al */
.modal-backdrop {
    z-index: 99999 !important; 
}
/* SweetAlert uyarılarını her şeyin en önüne al */
.swal2-container {
    z-index: 20000 !important;
}
/* Süt Hesaplama Penceresini EN ÖNE Zorla */
#sutHesaplaModal {
    z-index: 100010 !important; /* Çok yüksek bir sayı veriyoruz */
}

/* Tarih seçim takviminin de en önde çıkmasını sağlar */
.datepicker, .flatpickr-calendar {
    z-index: 100020 !important;
}

/* Eğer yine tıklanmazsa, perdeyi bir alt katmana indirir */
.modal-backdrop {
    z-index: 100000 !important;
}
/* admin.html style etiketinin en altına ekle */

/* SweetAlert Uyarı Kutusunu EN, EN ÖNE AL */
/* Süt penceresi 100010 idi, bunu ondan daha büyük yapıyoruz */
div.swal2-container {
    z-index: 200000 !important; 
}
/* Evrak Penceresini EN, EN ÖNE ZORLA */
#evrakModal {
    z-index: 100050 !important; 
}
/* Ürün Penceresini EN ÖNE ZORLA */
#productModal {
    z-index: 100060 !important; 
}
/* Detay Penceresini EN, EN ÖNE ZORLA */
#detayModal {
    z-index: 100080 !important; 
}
/* Ürün Penceresini EN, EN ÖNE ÇIKAR */
#productModal {
    z-index: 100070 !important; 
}
/* X Butonunu Her Şeyin En Önüne Al ve Tıklanabilir Yap */
.btn-close {
    z-index: 100100 !important; 
    position: relative;
    cursor: pointer;
}
/* Üye Ekleme Penceresini EN ÖNE ZORLA */
#addMemberModal {
    z-index: 100090 !important; 
}
/* --- CSS Z-INDEX (KATMAN) DÜZELTMESİ --- */
    
    /* 1. Karartma Perdesini Arkaya İt */
    .modal-backdrop {
        z-index: 1040 !important; 
        opacity: 0.5 !important;
    }

    /* 2. Açılan Pencereleri (Modal) Öne Al */
    .modal {
        z-index: 1050 !important;
    }
    
    /* 3. SweetAlert Uyarılarını HER ŞEYİN Önüne Al */
    div.swal2-container {
        z-index: 200000 !important; 
    }
    
    /* 4. Eğer giriş kartı giris.html'de kayboluyorsa bunu kullan: */
    .login-card {
        z-index: 10;
        position: relative;
    }
    /* --- MOBİL GELİŞTİRMELER (APP GÖRÜNÜMÜ) --- */

    /* 1. Alt Menü (Bottom Nav) - Sadece Mobilde Görünür */
    .bottom-nav {
        display: none; /* PC'de gizli */
    }

    @media (max-width: 992px) {
        body {
            padding-bottom: 80px; /* Alt menü için yer aç */
        }

        /* Sidebar'ı Tamamen Gizle ve Overlay Yap */
        .sidebar {
            transform: translateX(-100%);
            width: 280px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.2);
        }
        .sidebar.active {
            transform: translateX(0); /* Açılınca gelsin */
        }

        /* Sidebar Açma Butonu (Hamburger) */
        .mobile-menu-btn {
            display: block !important;
            font-size: 1.5rem;
            color: white;
            background: none;
            border: none;
            margin-right: 15px;
            cursor: pointer;
        }

        /* Alt Menü Tasarımı */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            height: 70px;
            background: white;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            z-index: 1045; /* Modal'ın altında, içeriğin üstünde */
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        .b-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: #94a3b8;
            font-size: 0.7rem;
            font-weight: 600;
            width: 20%;
        }
        .b-nav-item i {
            font-size: 1.4rem;
            margin-bottom: 4px;
            transition: transform 0.2s;
        }
        .b-nav-item.active {
            color: #0f766e;
        }
        .b-nav-item.active i {
            transform: translateY(-5px);
        }

        /* Header Düzenlemesi */
        .admin-header {
            padding: 15px !important;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
        }
        
        /* Tabloları Yatay Kaydırılabilir Yap */
        .table-responsive {
            border: 0;
        }
        
        /* Kartların Arasını Aç */
        .content-section {
            padding-bottom: 20px;
        }
    }

    /* Sidebar Karartma Perdesi */
    .sidebar-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1049; /* Sidebar'ın hemen altında */
        display: none;
        backdrop-filter: blur(2px);
    }
    .sidebar-overlay.active { display: block; }

/* --- YAZDIRMA AYARLARI (BÜYÜK YAZI & DÜZGÜN HİZALAMA) --- */
@media print {
    @page { 
        margin: 5mm; /* Kenar boşluğunu azalttık ki içerik sığsın */
        size: A4 portrait; 
    }
    
    body, html { 
        background-color: white !important; 
        width: 100% !important; 
        margin: 0 !important; 
        padding: 0 !important;
        font-size: 14px !important; /* Temel yazı boyutunu büyüttük */
        color: #000 !important;
    }

    /* Gereksizleri Gizle */
    .sidebar, .admin-header, .bottom-nav, .modal, .modal-backdrop, .btn, .no-print,
    #dashboard, #members, #stocks, #settings, #milk-management, #announcements, 
    #reports-main-menu, 
    #rep-account-summary > div:not(#accountReportContent) { 
        display: none !important; 
    }

    /* Rapor Alanını Aç */
    .main-content, .content-wrapper, #advanced-reports, #rep-account-summary {
        display: block !important; visibility: visible !important;
        position: static !important; margin: 0 !important; padding: 0 !important;
        width: 100% !important; height: auto !important;
        background: transparent !important; border: none !important; box-shadow: none !important;
        overflow: visible !important;
    }

    #accountReportContent {
        display: block !important; visibility: visible !important;
        position: relative !important; left: 0 !important; top: 0 !important;
        width: 100% !important; z-index: 9999;
    }

    /* --- KRİTİK AYAR: SÜTUNLARI YAN YANA ZORLA --- */
    .row {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
    }
    
    /* col-6'ları zorla %50 yap */
    .col-6 {
        width: 50% !important;
        flex: 0 0 50% !important;
        max-width: 50% !important;
    }

    /* Flex kutuları koru (Dönem Başı Devir için önemli) */
    .d-flex { 
        display: flex !important; 
        flex-direction: row !important;
        align-items: center !important;
    }
    .justify-content-between { justify-content: space-between !important; }

    /* Renkleri ve Çerçeveleri Belirginleştir */
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    .card {
        border: 1px solid #ccc !important;
        background-color: white !important;
    }
}
/* Süt Fark Göstergeleri */
.diff-badge {
    font-size: 0.75rem;
    font-weight: 700;
    margin-left: 8px;
    padding: 2px 6px;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    gap: 3px;
}
.diff-up { color: #166534; background-color: #dcfce7; } /* Yeşil Artış */
.diff-down { color: #991b1b; background-color: #fee2e2; } /* Kırmızı Düşüş */
.diff-neutral { color: #64748b; background-color: #f1f5f9; } /* Değişim Yok */
/* Tablar İçin Stil */
#memberTabs .nav-link {
    transition: all 0.2s ease;
    opacity: 0.7;
}
#memberTabs .nav-link:hover {
    opacity: 1;
    color: white !important;
}
#memberTabs .nav-link.active {
    opacity: 1 !important;
    background-color: transparent !important;
    color: white !important;
    border-bottom: 3px solid white !important;
}
/* --- HESAP DETAY SAYFASI (SIDEBAR YANINA OTURAN TASARIM) --- */
#account-detail-page {
    position: fixed !important;
    top: 0 !important;
    bottom: 0 !important;
    background-color: #f1f5f9 !important;
    overflow-y: auto !important; /* Sayfa içi kaydırma */
    display: none; /* Varsayılan gizli */
    padding: 0 !important; /* İç boşluğu sıfırla, container halleder */
    box-sizing: border-box !important;
    transition: all 0.3s ease-in-out;
}

/* --- MASAÜSTÜ GÖRÜNÜMÜ (PC) --- */
@media (min-width: 992px) {
    #account-detail-page.active-fullscreen {
        display: block !important;
        /* Sidebar genişliği (260px) kadar sağdan başla */
        left: 260px !important;              
        /* Ekranın geri kalanını kapla */
        width: calc(100% - 260px) !important;
        /* Sidebar'ın (1050) altında kalsın ki menüye tıklanabilsin */
        z-index: 1045 !important;            
    }
}

/* --- MOBİL GÖRÜNÜMÜ (TELEFON/TABLET) --- */
@media (max-width: 992px) {
    #account-detail-page.active-fullscreen {
        display: block !important;
        left: 0 !important;
        width: 100% !important;
        /* Mobilde menü kapalı olduğu için her şeyin üstüne çıksın */
        z-index: 2000 !important; 
        padding-bottom: 80px !important; /* Alt menü payı */
    }
}

/* İçeriği Düzenle */
#account-detail-page .container-fluid, 
#account-detail-page .row {
    max-width: 100%;
    margin: 0;
}
/* --- EVRAK (FATURA) MODALINI MENÜNÜN YANINA ALMA --- */
@media (min-width: 992px) {
    /* Fatura Penceresi (Evrak Modal) */
    #evrakModal {
        left: 260px !important;               /* Sol menü (260px) kadar boşluk bırak */
        width: calc(100% - 260px) !important; /* Genişliği menüden geriye kalan alan yap */
    }

    /* Eğer "Hesap Detayı" penceresi de aynı sorunu yapıyorsa: */
    #detayModal {
        left: 260px !important;
        width: calc(100% - 260px) !important;
    }
}
/* --- MOBİL ÖZEL CANLI REHBER TASARIMI --- */
.mobile-member-item {
    background: #ffffff;
    border-radius: 16px;
    padding: 15px;
    margin-bottom: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    border: 1px solid #f1f5f9;
    display: flex;
    align-items: center;
    gap: 15px;
}
.mobile-avatar {
    width: 45px; height: 45px;
    background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
    color: #00695c;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 1rem;
}
.mobile-info { flex-grow: 1; overflow: hidden; }
.mobile-name { font-weight: 700; color: #1e293b; font-size: 0.95rem; margin-bottom: 2px; }
.mobile-location { font-size: 0.8rem; color: #64748b; }
.btn-mobile-action {
    width: 36px; height: 36px;
    border-radius: 10px; border: none;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.9rem;
}

</style>
</head>
<body>
<div class="sidebar">
    
    <div class="sidebar-header">
        <div class="d-flex align-items-center gap-2">
            <img src="web-logo.jpg" alt="KoopSistem" style="height: 50px; width: auto; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">
            <span class="d-lg-none text-white fw-bold ms-2 fs-5">MENÜ</span>
        </div>
        
        <button class="btn btn-link text-white d-lg-none position-absolute end-0 me-3" onclick="closeSidebar()" style="font-size: 1.5rem;">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>
    
    <div class="sidebar-menu">
        
        <a class="nav-link active" onclick="switchTab('dashboard', this)">
            <i class="fa-solid fa-chart-pie" style="width:20px"></i> Hızlı İşlemler
        </a>
        
        <a class="nav-link" onclick="switchTab('reports', this)">
            <i class="fa-solid fa-chart-line" style="width:20px"></i> Dashboard
        </a>

        <a class="nav-link collapsed" data-bs-toggle="collapse" href="#menuCari" role="button" aria-expanded="false" aria-controls="menuCari">
            <i class="fa-solid fa-users-gear" style="width:20px"></i> Müşteri & Tedarikçi
        </a>
        <div class="collapse" id="menuCari"> 
            <div class="bg-black bg-opacity-25 rounded mx-3 mt-1 mb-2 py-1 overflow-hidden">
                <a class="nav-link ps-4 py-2 my-1" style="font-size: 0.85rem;" onclick="cariTabDegistir('musteri', this)">
                    <i class="fa-solid fa-user-tag text-warning" style="width:20px"></i> Müşteri Listesi
                </a>
                <a class="nav-link ps-4 py-2 my-1" style="font-size: 0.85rem;" onclick="cariTabDegistir('tedarikci', this)">
                    <i class="fa-solid fa-truck-field text-info" style="width:20px"></i> Tedarikçi Listesi
                </a>
            </div>
        </div>

        <a class="nav-link" onclick="switchTab('orders', this); siparisleriGetir();">
            <i class="fa-solid fa-truck-ramp-box" style="width:20px"></i> Sipariş Yönetimi
            <span id="badge-siparis" class="badge bg-danger ms-auto shadow-sm" style="display:none; font-size: 0.7rem;">0</span>
        </a>

        <a class="nav-link" onclick="switchTab('stocks', this)">
            <i class="fa-solid fa-boxes-stacked" style="width:20px"></i> Stok Yönetimi
        </a>
        
        <a class="nav-link" onclick="switchTab('milk-management', this)">
            <i class="fa-solid fa-cow" style="width:20px"></i> Süt Yönetimi
        </a>
        
        <a class="nav-link" onclick="switchTab('advanced-reports', this)">
            <i class="fa-solid fa-file-contract" style="width:20px"></i> Detaylı Raporlar
        </a>
        
        <a class="nav-link" onclick="switchTab('announcements', this); adminDuyurulariGetir();">
            <i class="fa-solid fa-bullhorn" style="width:20px"></i> Duyuru Yönetimi
        </a>
        
        <a class="nav-link" onclick="switchTab('settings', this)">
            <i class="fa-solid fa-sliders" style="width:20px"></i> Ayarlar
        </a>

    </div>

    <div class="sidebar-footer">
        <a class="nav-link logout-link m-0 fw-bold" id="logoutBtn">
            <i class="fa-solid fa-arrow-right-from-bracket"></i> Çıkış Yap
        </a>
    </div>

</div>

<div class="main-content">
    
  <div class="admin-header">
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <div class="d-flex justify-content-between align-items-center">
            
            <div class="d-flex align-items-center">
                <button class="mobile-menu-btn d-lg-none" onclick="toggleSidebar()">
                    <i class="fa-solid fa-bars"></i>
                </button>

                <div class="header-title">
                    <small class="text-white-50 text-uppercase fw-bold" id="lblCompanyName">Yükleniyor...</small>
                    <h2 id="page-title" style="font-size: 1.4rem;">Genel Bakış</h2>
                </div>
            </div>
            
           <div class="d-flex align-items-center gap-3">
    

    <div id="licenseInfoBox" class="px-2 py-1 rounded-pill fw-bold small shadow-sm d-none align-items-center" 
         style="background: white; min-height: 30px; display: flex;">
        <span id="licenseText" style="font-size: 0.75rem;">...</span>
    </div>

    <div class="user-badge p-1 px-2">
        <i class="fa-solid fa-circle-user fa-lg"></i>
    </div>
</div>

        </div>
    </div>

    <div class="content-wrapper">
        <div id="announcements" class="content-section hidden-section">
    
    <div class="row">
        <div class="col-md-5">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h6 class="fw-bold text-dark m-0"><i class="fa-solid fa-pen-to-square me-2 text-primary"></i>Yeni Duyuru Yaz</h6>
                </div>
                <div class="card-body p-4">
                    <form id="announcementForm">
                        <div class="mb-3">
                            <label class="small fw-bold text-muted">Başlık</label>
                            <input type="text" id="annBaslik" class="form-control" placeholder="Örn: Süt Ödemeleri" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="small fw-bold text-muted">Duyuru İçeriği</label>
                            <textarea id="annIcerik" class="form-control" rows="4" placeholder="Mesajınızı buraya yazın..." required></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="small fw-bold text-muted">Önem Derecesi</label>
                            <select id="annOnem" class="form-select">
                                <option value="normal">Normal (Mavi - Bilgi)</option>
                                <option value="yuksek">Yüksek (Kırmızı - Uyarı)</option>
                                <option value="odeme">Ödeme (Yeşil - Para Konusu)</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary-custom w-100 py-2">
                            <i class="fa-solid fa-paper-plane me-2"></i> YAYINLA
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold text-dark m-0"><i class="fa-solid fa-list me-2 text-secondary"></i>Yayındaki Duyurular</h6>
                    <small class="text-muted">En yeni 10 duyuru</small>
                </div>
                <div class="list-group list-group-flush" id="adminAnnList">
                    <div class="text-center py-5 text-muted">Yükleniyor...</div>
                </div>
            </div>
        </div>
    </div>

</div>
<div id="dashboard" class="content-section">
    
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card dash-card border-start border-4 border-info shadow-sm">
                <div class="dash-label text-info">TOPLAM ÜYE</div>
                <div class="dash-val" id="dashTotalMember">0</div>
                <i class="fa-solid fa-users dash-icon text-info"></i>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card dash-card border-start border-4 border-success shadow-sm">
                <div class="dash-label text-success">TOPLAM ÜRÜN</div>
                <div class="dash-val">-</div>
                <i class="fa-solid fa-boxes-stacked dash-icon text-success"></i>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card dash-card border-start border-4 border-warning shadow-sm">
                <div class="dash-label text-warning">AKTİF ROTA</div>
                <div class="dash-val" id="dashTotalRoutes">-</div>
                <i class="fa-solid fa-route dash-icon text-warning"></i>
            </div>
        </div>
    </div>

    <h5 class="fw-bold text-secondary mb-3"><i class="fa-solid fa-bolt text-warning me-2"></i>Hızlı İşlemler</h5>
    <div class="row g-3">
        
        <div class="col-6 col-md-3">
            <div class="card quick-card shadow-sm" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);" onclick="hizliFaturaBaslat()">
                <i class="bg-icon fa-solid fa-file-invoice-dollar"></i>
                <i class="fa-solid fa-file-invoice-dollar fa-2x mb-2"></i>
                <h6>Yeni Fatura Kes</h6>
                <small>Satış veya İade</small>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card quick-card shadow-sm" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);" onclick="hizliTahsilatBaslat()">
                <i class="bg-icon fa-solid fa-hand-holding-dollar"></i>
                <i class="fa-solid fa-hand-holding-dollar fa-2x mb-2"></i>
                <h6>Hızlı Tahsilat</h6>
                <small>Nakit Para Girişi</small>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card quick-card shadow-sm" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);" onclick="hizliOdemeBaslat()">
                <i class="bg-icon fa-solid fa-wallet"></i>
                <i class="fa-solid fa-wallet fa-2x mb-2"></i>
                <h6>Hızlı Ödeme</h6>
                <small>Nakit Para Çıkışı</small>
            </div>
        </div>

       <div class="col-6 col-md-3">
            <div class="card quick-card shadow-sm" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);" onclick="yeniUyeModalAc()">
                <i class="bg-icon fa-solid fa-user-plus"></i>
                <i class="fa-solid fa-user-plus fa-2x mb-2"></i>
                <h6>Yeni Müşteri Ekle</h6>
                <small>Müşteri Kaydı</small>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card quick-card shadow-sm" style="background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);" onclick="switchTab('milk-management')">
                <i class="bg-icon fa-solid fa-cow"></i>
                <i class="fa-solid fa-cow fa-2x mb-2"></i>
                <h6>Süt Yönetimi</h6>
                <small>Hesapla & İşle</small>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card quick-card shadow-sm" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);" onclick="yeniUrunModalAc()">
                <i class="bg-icon fa-solid fa-box-open"></i>
                <i class="fa-solid fa-box-open fa-2x mb-2"></i>
                <h6>Ürün Tanımla</h6>
                <small>Yeni Stok Kartı</small>
            </div>
        </div>
<div class="col-6 col-md-3">
            <div class="card quick-card shadow-sm" style="background: linear-gradient(135deg, #475569 0%, #334155 100%);" onclick="switchTab('advanced-reports')">
                <i class="bg-icon fa-solid fa-chart-line"></i>
                <i class="fa-solid fa-chart-line fa-2x mb-2"></i>
                <h6>Raporlar</h6>
                <small>Detaylı Analiz</small>
            </div>
        </div>
        

        <div class="col-6 col-md-3">
    <div class="card quick-card shadow-sm position-relative" 
         style="background: linear-gradient(135deg, #be123c 0%, #9f1239 100%);" 
         onclick="document.getElementById('password-requests-container').scrollIntoView({behavior: 'smooth'})">
        
        <span id="pass-req-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-white shadow-sm d-none" 
              style="margin-left: -20px; margin-top: 15px; z-index: 5;">
            0
        </span>

        <i class="bg-icon fa-solid fa-key"></i>
        
        <i class="fa-solid fa-key fa-2x mb-2 text-white"></i>
        <h6 class="text-white">Şifre Talepleri</h6>
        <small class="text-white opacity-75">Sıfırlama İstekleri</small>
        </div>
    </div> </div> <div id="password-requests-container" class="mb-5" style="scroll-margin-top: 100px;"></div>

</div> <div id="orders" class="content-section hidden-section">
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm bg-warning bg-opacity-10 border-warning border-start border-4">
                <div class="card-body">
                    <h6 class="text-warning fw-bold small">BEKLEYEN SİPARİŞ</h6>
                    <h2 class="fw-bold mb-0 text-dark" id="count-bekleyen">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm bg-primary bg-opacity-10 border-primary border-start border-4">
                <div class="card-body">
                    <h6 class="text-primary fw-bold small">HAZIRLANIYOR</h6>
                    <h2 class="fw-bold mb-0 text-dark" id="count-hazirlaniyor">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm bg-success bg-opacity-10 border-success border-start border-4">
                <div class="card-body">
                    <h6 class="text-success fw-bold small">TAMAMLANAN (BUGÜN)</h6>
                    <h2 class="fw-bold mb-0 text-dark" id="count-tamamlanan">0</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h6 class="fw-bold m-0"><i class="fa-solid fa-truck-ramp-box me-2 text-primary"></i>Gelen Sipariş Listesi</h6>
            <button class="btn btn-sm btn-light border" onclick="siparisleriGetir()"><i class="fa-solid fa-rotate"></i></button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Tarih</th>
                <th>Üretici</th>
                <th>Sipariş Detayı</th>
                <th>Tutar</th>
                <th>Durum</th>
                <th class="text-end">İşlem</th>
            </tr>
        </thead>
        <tbody id="siparis-tablosu">
            </tbody>
    </table>
</div>
        </div>
    </div>
</div>

<div id="reports" class="content-section hidden-section">
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="small fw-bold text-muted">Başlangıç Tarihi</label>
                    <input type="date" class="form-control" id="reportStartDate">
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold text-muted">Bitiş Tarihi</label>
                    <input type="date" class="form-control" id="reportEndDate">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary-custom w-100" onclick="raporlariGetir()">
                        <i class="fa-solid fa-filter me-2"></i> ANALİZ ET
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #fff 0%, #f1f5f9 100%);">
                <div class="card-body text-center">
                    <h6 class="text-muted text-uppercase small fw-bold">Toplam Toplanan Süt</h6>
                    <h3 class="fw-bold text-primary mb-0" id="repTotalMilk">0 Lt</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #fff 0%, #fff7ed 100%);">
                <div class="card-body text-center">
                    <h6 class="text-muted text-uppercase small fw-bold">Ortalama (Günlük)</h6>
                    <h3 class="fw-bold text-warning mb-0" id="repAvgMilk">0 Lt</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #fff 0%, #f0fdf4 100%);">
                <div class="card-body text-center">
                    <h6 class="text-muted text-uppercase small fw-bold">En Verimli Bölge</h6>
                    <h3 class="fw-bold text-success mb-0" id="repBestVillage">-</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 fw-bold text-dark"><i class="fa-solid fa-chart-area me-2 text-primary"></i>Günlük Süt Toplama Grafiği</h6>
                </div>
                <div class="card-body">
                    <canvas id="milkTrendChart" style="max-height: 350px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 fw-bold text-dark"><i class="fa-solid fa-chart-pie me-2 text-primary"></i>Bölgesel Dağılım</h6>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <canvas id="villagePieChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="advanced-reports" class="content-section hidden-section">
    <div id="reports-main-menu">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm hover-effect">
                    <div class="card-header bg-warning bg-opacity-10 border-0 py-3">
                        <h6 class="fw-bold text-dark m-0"><i class="fa-solid fa-cow me-2 text-warning"></i>SÜT RAPORLARI</h6>
                    </div>
                    <div class="list-group list-group-flush">
                        <button class="list-group-item list-group-item-action py-3 d-flex justify-content-between align-items-center" onclick="openReport('rep-milk-member')">
                            <div>
                                <span class="fw-bold text-dark small">Müşteri Süt Ekstresi</span>
                                <small class="d-block text-muted" style="font-size:0.7rem">Kişi bazlı tarih aralıklı döküm</small>
                            </div>
                            <i class="fa-solid fa-chevron-right text-muted small"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm hover-effect">
                    <div class="card-header bg-success bg-opacity-10 border-0 py-3">
                        <h6 class="fw-bold text-dark m-0"><i class="fa-solid fa-wallet me-2 text-success"></i>FİNANS RAPORLARI</h6>
                    </div>
                    <div class="list-group list-group-flush">
                        <button class="list-group-item list-group-item-action py-3 d-flex justify-content-between align-items-center" onclick="openReport('rep-account-summary'); raporUyeListesiDoldur('repFilterMemberAccount');">
                            <div>
                                <span class="fw-bold text-dark small">Üretici Hesap Özet Raporu</span>
                                <small class="d-block text-muted" style="font-size:0.7rem">Üretici panelindeki hesap görünümü</small>
                            </div>
                            <i class="fa-solid fa-chevron-right text-muted small"></i>
                        </button>
                        <button class="list-group-item list-group-item-action py-3 d-flex justify-content-between align-items-center" onclick="openReport('rep-general-balance'); genelBakiyeRaporuGetir();">
                            <div>
                                <span class="fw-bold text-dark small">Genel Bakiye Listesi</span>
                                <small class="d-block text-muted" style="font-size:0.7rem">Tüm üreticilerin anlık borç/alacak durumları</small>
                            </div>
                            <i class="fa-solid fa-scale-balanced text-primary small"></i>
                        </button>
                    </div>
                    <div class="p-3 mt-auto bg-light bg-opacity-50 border-top">
                        <button class="btn w-100 d-flex align-items-center justify-content-between p-3 border shadow-sm" 
                                onclick="hesapYayinlamaModalAc()"
                                style="background-color: #fff1f2; border-color: #fecdd3 !important; border-radius: 12px;">
                            <div class="text-start">
                                <div class="fw-bold text-danger" style="font-size: 0.9rem;">
                                    <i class="fa-solid fa-bullhorn me-2"></i>Dönem Hesabı Yayınla
                                </div>
                                <small class="text-secondary" style="font-size: 0.7rem;">Bakiyeleri üreticilere gönder</small>
                            </div>
                            <div class="bg-danger text-white rounded-circle shadow-sm d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                <i class="fa-solid fa-arrow-up-from-bracket" style="font-size: 0.8rem;"></i>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm hover-effect">
                    <div class="card-header bg-info bg-opacity-10 border-0 py-3">
                        <h6 class="fw-bold text-dark m-0"><i class="fa-solid fa-boxes-stacked me-2 text-info"></i>STOK RAPORLARI</h6>
                    </div>
                    <div class="list-group list-group-flush">
                        <button class="list-group-item list-group-item-action py-3 d-flex justify-content-between align-items-center" onclick="Swal.fire('Bilgi','Stok raporu hazırlanıyor.','info')">
                            <div>
                                <span class="fw-bold text-dark small">Stok Durum Raporu</span>
                                <small class="d-block text-muted" style="font-size:0.7rem">Mevcut envanter listesi</small>
                            </div>
                            <i class="fa-solid fa-chevron-right text-muted small"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="rep-milk-member" class="sub-report d-none">
        <div class="d-flex align-items-center mb-4">
            <button class="btn btn-light rounded-circle shadow-sm me-3" onclick="closeReport()">
                <i class="fa-solid fa-arrow-left text-primary"></i>
            </button>
            <div>
                <h5 class="m-0 fw-bold">Müşteri Süt Ekstresi</h5>
                <small class="text-muted">Seçilen üyenin tarih aralığındaki süt dökümü</small>
            </div>
        </div>
        <div class="card border-0 shadow-sm p-4 mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="small fw-bold text-muted">Üye Seçiniz</label>
                    <select class="form-select" id="repFilterMember"><option value="">Tüm Üyeler</option></select>
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">Başlangıç</label>
                    <input type="date" class="form-control" id="repDateStart">
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">Bitiş</label>
                    <input type="date" class="form-control" id="repDateEnd">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary-custom w-100" onclick="musteriSutRaporuGetir()">
                        <i class="fa-solid fa-search me-2"></i> GETİR
                    </button>
                </div>
            </div>
        </div>
        <div class="table-responsive bg-white rounded shadow-sm">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr><th class="ps-4">Tarih</th><th>Üye Adı Soyadı</th><th class="text-center">Dönem</th><th class="text-end pe-4">Miktar (Lt)</th></tr>
                </thead>
                <tbody id="repMilkTableBody"><tr><td colspan="4" class="text-center p-5 text-muted">Lütfen yukarıdan kriter seçip arama yapınız.</td></tr></tbody>
                <tfoot class="bg-light fw-bold" style="border-top: 2px solid #e2e8f0;">
                    <tr><td colspan="3" class="text-end pe-3 py-3">TOPLAM SÜT:</td><td class="text-end pe-4 text-primary fs-5" id="repMilkTotal">0 Lt</td></tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div id="rep-account-summary" class="sub-report d-none">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <div class="d-flex align-items-center">
                <button class="btn btn-light rounded-circle shadow-sm me-3" onclick="closeReport()"><i class="fa-solid fa-arrow-left text-primary"></i></button>
                <div><h5 class="m-0 fw-bold">Üretici Hesap Özeti</h5><small class="text-muted">Detaylı hesap dökümü</small></div>
            </div>
        </div>
        <div class="card border-0 shadow-sm p-4 mb-4 no-print" style="background: linear-gradient(to right, #ffffff, #f8f9fa); border-left: 5px solid #0f766e; overflow: visible !important; position: relative; z-index: 1000;"></div>
            <div class="row g-3 align-items-end">
                <div class="col-lg-4 col-md-12 position-relative">
                    <label class="small fw-bold text-primary mb-1 ms-1">Müşteri Seçimi</label>
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-white border-end-0 text-primary"><i class="fa-solid fa-search"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0 fw-bold text-dark" id="repMemberSearch" placeholder=" Üretici Ara" autocomplete="off">
                        <input type="hidden" id="repSelectedMemberId">
                    </div>
                   <div id="repMemberSearchResults" class="list-group position-absolute w-100 shadow-lg" style="z-index: 99999; top: 100%; display: none !important; max-height: 350px; overflow-y: auto;"></div>
                </div>
                <div class="col-lg-2 col-md-6">
                    <label class="small fw-bold text-primary mb-1 ms-1">Dönem</label>
                    <input type="month" class="form-control shadow-sm fw-bold text-center" id="repAccountMonth" style="cursor: pointer;">
                </div>
                <div class="col-lg-6 col-md-12">
                    <div class="d-flex gap-2 w-100">
                        <button class="btn btn-primary-custom flex-fill shadow-sm fw-bold" onclick="ureticiHesapOzetiGetir()"><i class="fa-solid fa-rotate me-2"></i> GETİR</button>
                        <button class="btn btn-dark flex-fill shadow-sm fw-bold" onclick="raporYazdir()"><i class="fa-solid fa-print me-2"></i> YAZDIR</button>
                        <button class="btn btn-danger flex-fill shadow-sm fw-bold" onclick="raporPdfIndir()"><i class="fa-solid fa-file-pdf me-2"></i> PDF</button>
                        <button class="btn flex-fill shadow-sm fw-bold text-white" style="background-color: #25D366;" onclick="whatsappRaporGonder()"><i class="fa-brands fa-whatsapp me-2 fa-lg"></i> WHATSAPP</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="accountReportContent"></div>
    </div>

    <div id="rep-general-balance" class="sub-report d-none">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <div class="d-flex align-items-center">
                <button class="btn btn-light rounded-circle shadow-sm me-3" onclick="closeReport()"><i class="fa-solid fa-arrow-left text-primary"></i></button>
                <div><h5 class="m-0 fw-bold" id="genBalTitle">Genel Bakiye Listesi</h5><small class="text-muted">Hesap Durum Raporu</small></div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-success shadow-sm btn-sm fw-bold" onclick="genelBakiyeExcelIndir()"><i class="fa-solid fa-file-excel me-2"></i> EXCEL İNDİR</button>
                <button class="btn btn-dark shadow-sm btn-sm fw-bold" onclick="window.print()"><i class="fa-solid fa-print me-2"></i> YAZDIR</button>
            </div>
        </div>
        <div class="card border-0 shadow-sm mb-4 p-3 bg-light">
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">Rota / Köy Seçiniz</label>
                    <select class="form-select" id="genBalVillageSelect"><option value="all">Tüm Rotalar</option></select>
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">Bakiye Durumu</label>
                    <select class="form-select" id="genBalStatusFilter">
                        <option value="all">Tümü (Hepsi)</option>
                        <option value="borclu">Sadece Borçlular (B)</option>
                        <option value="alacakli">Sadece Alacaklılar (A)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">Tarih İtibariyle</label>
                    <input type="date" class="form-control" id="genBalDateLimit">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary-custom w-100" onclick="genelBakiyeRaporuGetir()"><i class="fa-solid fa-filter me-2"></i> LİSTELE</button>
                </div>
            </div>
        </div>
        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="tblGeneralBalance">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Üretici Adı Soyadı</th>
                            <th>Rota / Köy</th>
                            <th class="text-end text-danger">Toplam Borç</th>
                            <th class="text-end text-success">Toplam Alacak</th>
                            <th class="text-end">NET BAKİYE</th>
                            <th class="text-center pe-4">DURUM</th>
                        </tr>
                    </thead>
                    <tbody id="generalBalanceBody"><tr><td colspan="6" class="text-center p-5"><div class="spinner-border text-primary"></div></td></tr></tbody>
                    <tfoot class="bg-light fw-bold" style="border-top: 2px solid #64748b;"></tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

        <div id="members" class="content-section hidden-section">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                    <div>
                        <h4 class="m-0 fw-bold text-dark" id="lblListTitle">Kayıt Listesi</h4>
                        <small class="text-muted" id="recordCount">Yükleniyor...</small>
                    </div>
                    
                  <div class="d-flex gap-2">
                        <button class="btn btn-success text-white shadow-sm" onclick="excelDisariAktar()" title="Listeyi Excel Olarak İndir">
                            <i class="fa-solid fa-file-excel"></i> <span class="d-none d-md-inline">İndir</span>
                        </button>
                        
                        <button class="btn btn-warning text-dark shadow-sm" onclick="excelIceriAktarClick()" title="Excel'den Veri Yükle">
                            <i class="fa-solid fa-file-import"></i> <span class="d-none d-md-inline">Yükle</span>
                        </button>
                        <input type="file" id="excelFileInput" accept=".xlsx, .xls" style="display: none;" onchange="excelDosyasiOku(this)">
                        <button class="btn btn-danger text-white shadow-sm d-none" id="btnDeleteSelected" onclick="secilenleriSil()">
                            <i class="fa-solid fa-trash-can"></i> <span class="d-none d-md-inline">Seçilenleri Sil (<span id="selectedCount">0</span>)</span>
                        </button>
                        <div class="input-group" style="width: 250px;">
                            <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-search text-muted"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0" id="searchInput" placeholder="Hızlı ara...">
                        </div>
                        <button class="btn btn-dark text-white shadow-sm" onclick="topluFinansModalAc()">
    <i class="fa-solid fa-money-bill-transfer me-1"></i> Toplu Finans
</button>
                        <button class="btn btn-primary-custom" onclick="yeniUyeModalAc()" id="btnAddMember">
                            <i class="fa-solid fa-plus me-1"></i> Yeni Müşteri
                        </button>
                    </div>
                </div>
<div class="table-responsive d-none d-md-block">
                    <table class="table table-custom table-hover">
                        <thead>
                            <tr class="table-light text-secondary" style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                <th style="width: 40px;" class="text-center">
                                    <input type="checkbox" class="form-check-input" id="selectAllMembers" onclick="tumunuSec(this)">
                                </th>
                                <th class="text-center" style="width: 60px;">Sıra</th>
                                <th>Ad Soyad / Unvan</th>
                                <th>TC / Vergi No</th>
                                <th class="text-center">Tip</th>
                                <th>Bölge / Köy</th>
                                <th>Telefon</th>
                                <th class="text-end pe-4">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="memberTableBody"></tbody>
                    </table>
                </div>

                <div id="mobileMemberList" class="d-md-none pb-5">
                    </div>
            </div>
        </div>
        <div id="stocks" class="content-section hidden-section">
    <div class="card p-4 border-0 shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold text-dark m-0">Depo Mevcudu</h4>
                <small class="text-muted">Ürünlerin anlık stok durumları</small>
            </div>
            <button class="btn btn-primary-custom" onclick="yeniUrunModalAc()">
                <i class="fa-solid fa-plus me-2"></i> Yeni Ürün Tanımla
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Ürün Adı</th>
                        <th>Kategori</th>
                        <th class="text-center">Mevcut Stok</th>
                        <th class="text-end">Birim Fiyat (Satış)</th>
                        <th class="text-end">İşlem</th>
                    </tr>
                </thead>
                <tbody id="stockTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="milk-management" class="content-section hidden-section">
    <div class="row g-4">
        <div class="col-md-6 col-lg-5">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #fffbeb 0%, #fff7ed 100%);">
                <div class="card-body p-4 text-center d-flex flex-column justify-content-center align-items-center">
                    <div class="bg-white p-3 rounded-circle shadow-sm mb-3 text-warning">
                        <i class="fa-solid fa-calculator fa-3x"></i>
                    </div>
                    <h4 class="fw-bold text-dark">Dönemsel Hesaplama</h4>
                    <p class="text-muted small mb-4">
                        Belirlenen tarih aralığındaki toplanan sütleri hesaplayıp, üyelerin cari hesabına "Alacak" olarak işler.
                    </p>
                    <button class="btn btn-warning w-100 fw-bold py-3 rounded-3 shadow-sm text-dark" onclick="sutHesaplamaModalAc()">
                        <i class="fa-solid fa-play me-2"></i> HESAPLAMA BAŞLAT
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <h5 class="fw-bold text-dark mb-3"><i class="fa-solid fa-circle-info text-primary me-2"></i>Nasıl Çalışır?</h5>
                    <ul class="list-group list-group-flush small">
                        <li class="list-group-item bg-transparent px-0">
                            <i class="fa-solid fa-check text-success me-2"></i>
                            <strong>Adım 1:</strong> Şoförler sahada sütleri toplar.
                        </li>
                        <li class="list-group-item bg-transparent px-0">
                            <i class="fa-solid fa-check text-success me-2"></i>
                            <strong>Adım 2:</strong> Siz buradan tarih aralığı (Örn: 1-15 Kasım) ve Litre Fiyatı girersiniz.
                        </li>
                        <li class="list-group-item bg-transparent px-0">
                            <i class="fa-solid fa-check text-success me-2"></i>
                            <strong>Adım 3:</strong> Sistem herkesin litresini fiyatla çarpıp bakiyesine ekler.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div> 

    <div class="card border-0 shadow-sm mt-4">
        <div class="card-header bg-white py-3">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <h6 class="m-0 fw-bold text-dark">
                        <i class="fa-solid fa-list-check me-2 text-primary"></i>Süt Giriş Listesi
                    </h6>
                </div>
                <div class="col-md-8">
                    <div class="d-flex gap-2 justify-content-end">
                        <select id="sutAramaUye" class="form-select form-select-sm fw-bold text-dark" style="max-width: 200px;">
                            <option value="">Tüm Üreticiler</option>
                        </select>
                        <input type="date" id="sutAramaTarih" class="form-control form-control-sm" style="max-width: 150px;">
                        
                        <button class="btn btn-sm btn-primary-custom" onclick="sutListesiniGetir(true)">
                            <i class="fa-solid fa-search me-1"></i> Bul
                        </button>
                        
                        <button class="btn btn-sm btn-light border" onclick="sutListesiniGetir(false)" title="Listeyi Sıfırla">
                            <i class="fa-solid fa-rotate"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Tarih</th>
                        <th>Üretici</th>
                        <th>Şoför/Giren</th>
                        <th class="text-center">Dönem</th>
                        <th class="text-center">Miktar</th>
                        <th class="text-center" style="width: 110px;">Fark</th>
                        <th class="text-end">Durum</th>
                        <th class="text-end">Sil</th>
                    </tr>
                </thead>
                <tbody id="milkTableBody">
                    <tr><td colspan="8" class="text-center p-4 text-muted">Yükleniyor...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>



        <div id="settings" class="content-section hidden-section">
            
            <div id="settings-main-menu">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card settings-card" onclick="openSubSetting('sub-regions')">
                            <div class="s-icon icon-blue"><i class="fa-solid fa-map-location-dot"></i></div>
                            <h5 class="fw-bold text-dark">Bölgeler & Rotalar</h5>
                            <small class="text-muted d-block">Köy tanımları ve rota düzeni</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        
                          <div class="card settings-card" onclick="openSubSetting('sub-prices')">
                            
    <div class="s-icon icon-green"><i class="fa-solid fa-turkish-lira-sign"></i></div>
    <h5 class="fw-bold text-dark">Fiyatlandırma</h5>
    <small class="text-muted d-block">Süt birim fiyatı belirle</small>
</div>
                    </div>
                    <div class="col-md-4">
    <div class="card settings-card" onclick="openSubSetting('sub-pricing')">
        <div class="s-icon icon-green"><i class="fa-solid fa-calculator"></i></div>
        <h5 class="fw-bold text-dark">Fiyat & KDV</h5>
        <small class="text-muted d-block">Vergi hesaplama yöntemi</small>
    </div>
</div>
                    <div class="col-md-4">
    <div class="card settings-card" onclick="openSubSetting('sub-permissions'); yetkilileriGetir();">
        <div class="s-icon icon-purple"><i class="fa-solid fa-shield-halved"></i></div>
        <h5 class="fw-bold text-dark">Yetkiler</h5>
        <small class="text-muted d-block">Şoför ve Personel Yönetimi</small>
    </div>
</div>
<div class="col-md-4">
    <div class="card settings-card" onclick="openSubSetting('sub-coop-info')">
        <div class="s-icon icon-blue"><i class="fa-solid fa-building-column"></i></div>
        <h5 class="fw-bold text-dark">Kurum Bilgileri</h5>
        <small class="text-muted d-block">Kooperatif adı, adres ve destek hattı</small>
    </div>
</div>
                </div>
            </div>
 <div id="sub-regions" class="d-none sub-setting-page">
    <div class="d-flex align-items-center mb-4">
        <button class="btn btn-light rounded-circle shadow-sm me-3" onclick="closeSubSetting()" style="width: 45px; height: 45px;">
            <i class="fa-solid fa-arrow-left text-primary"></i>
        </button>
        <div>
            
            <h4 class="m-0 fw-bold">Bölge & Rota Yönetimi</h4>
            <small class="text-muted">Köy ve mahalle tanımları.</small>
        </div>
    </div>
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-primary"><i class="fa-solid fa-list-ul me-2"></i>Kayıtlı Rotalar</h6>
                    <span class="badge bg-primary-subtle text-primary" id="rotaSayisiBadge">0 Rota</span>
                </div>
                <div class="card-body">
                    <form id="addVillageForm" class="row g-2 mb-4 align-items-center">
                        <div class="col">
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="fa-solid fa-map-pin text-muted"></i></span>
                                <input type="text" class="form-control form-control-lg border-start-0" id="newVillageInput" placeholder="Yeni Köy / Mahalle Adı" required>
                            </div>
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-lg btn-primary-custom h-100 px-4">EKLE</button>
                        </div>
                    </form>
                    <div id="villageList" class="list-group list-group-flush overflow-auto custom-scrollbar" style="max-height: 450px;"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
             <div class="card border-0 shadow-sm bg-primary-subtle h-100">
                 <div class="card-body text-center p-4">
                    <h5 class="fw-bold text-dark mb-2">Güvenlik Limiti</h5>
                    <div class="bg-white p-4 rounded-4 shadow-sm mt-3">
                        <label class="form-label small fw-bold text-start w-100 text-muted">Sapma Yüzdesi</label>
                        <div class="input-group input-group-lg mb-3">
                            <input type="number" class="form-control fw-bold text-center text-primary border-primary" id="sapmaInput" placeholder="50">
                            <span class="input-group-text bg-primary text-white fw-bold">%</span>
                        </div>
                        <button class="btn btn-dark w-100 fw-bold py-2 rounded-3" onclick="limitKaydet()">KAYDET</button>
                    </div>
                 </div>
            </div>
        </div>
    </div>
</div>

<div id="sub-prices" class="d-none sub-setting-page">
    <div class="d-flex align-items-center mb-4">
        <button class="btn btn-light rounded-circle shadow-sm me-3" onclick="closeSubSetting()" style="width: 45px; height: 45px;">
            <i class="fa-solid fa-arrow-left text-primary"></i>
        </button>
        <div>
            <h4 class="m-0 fw-bold">Süt Fiyatlandırması</h4>
            <small class="text-muted">Litre fiyatı belirleyin.</small>
        </div>
    </div>
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm p-4">
                <div class="mb-4">
                    <label class="form-label small fw-bold text-muted">Litre Fiyatı (TL)</label>
                    <div class="input-group input-group-lg">
                        <input type="number" class="form-control fw-bold text-center text-primary fs-3" id="settingMilkPrice" placeholder="0.00" step="0.01">
                        <span class="input-group-text fw-bold">₺</span>
                    </div>
                </div>
                <button class="btn btn-success w-100 py-3 fw-bold rounded-3 shadow-sm" onclick="sutFiyatiKaydet()">FİYATI KAYDET</button>
            </div>
        </div>
    </div>
</div>
<div id="sub-pricing" class="d-none sub-setting-page">
    <div class="d-flex align-items-center mb-4">
        <button class="btn btn-light rounded-circle shadow-sm me-3" onclick="closeSubSetting()" style="width: 45px; height: 45px;">
            <i class="fa-solid fa-arrow-left text-primary"></i>
        </button>
        <h4 class="m-0 fw-bold">Fiyatlandırma Ayarları</h4>
    </div>

    <div class="card p-4 border-0 shadow-sm">
        <h6 class="text-primary fw-bold mb-3"><i class="fa-solid fa-file-invoice-dollar me-2"></i>KDV Hesaplama Yöntemi</h6>
        <p class="text-muted small">Evrak oluştururken girdiğiniz birim fiyatların KDV dahil mi yoksa hariç mi olduğunu belirleyin.</p>
        
        <div class="bg-light p-3 rounded border mb-3">
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="kdvAyari" id="optKdvHaric" value="haric" checked>
                <label class="form-check-label fw-bold" for="optKdvHaric">
                    KDV HARİÇ (Önerilen)
                </label>
                <div class="text-muted small ms-2">Örn: 100 ₺ yazarsanız, üzerine %10 ekler = 110 ₺ hesaplar.</div>
            </div>
            
            <hr class="my-2">

            <div class="form-check">
                <input class="form-check-input" type="radio" name="kdvAyari" id="optKdvDahil" value="dahil">
                <label class="form-check-label fw-bold" for="optKdvDahil">
                    KDV DAHİL
                </label>
                <div class="text-muted small ms-2">Örn: 110 ₺ yazarsanız, içinden vergiyi ayırır = 100 ₺ Mal + 10 ₺ KDV.</div>
            </div>
        </div>

        <button class="btn btn-primary-custom w-100" onclick="kdvAyariniKaydet()">
            <i class="fa-solid fa-save me-2"></i> Ayarı Güncelle
        </button>
    </div>
</div>
<div id="sub-permissions" class="d-none sub-setting-page">
    
    <div class="d-flex align-items-center mb-4">
        <button class="btn btn-light rounded-circle shadow-sm me-3" onclick="closeSubSetting()" style="width: 45px; height: 45px;">
            <i class="fa-solid fa-arrow-left text-primary"></i>
        </button>
        <div>
            <h4 class="m-0 fw-bold">Yetki Yönetimi</h4>
            <small class="text-muted">Personel tanımlama ve Müşavir yetkilendirme işlemleri.</small>
        </div>
    </div>

    <div class="row g-4 mb-4">
        
        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm bg-primary bg-opacity-10 border-start border-4 border-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-white p-2 rounded-circle text-primary shadow-sm me-2">
                            <i class="fa-solid fa-user-plus fa-lg"></i>
                        </div>
                        <h6 class="fw-bold text-dark m-0">Yeni Personel Tanımla</h6>
                    </div>
                    
                    <p class="small text-muted mb-3" style="min-height: 40px;">
                        Sisteme yeni bir <b>Yönetici</b> veya süt toplama aracı kullanacak <b>Şoför</b> eklemek için tıklayın.
                    </p>
                    
                    <button class="btn btn-primary w-100 fw-bold shadow-sm" onclick="soforEkleModalAc()">
                        <i class="fa-solid fa-plus me-2"></i> PERSONEL EKLEME PENCERESİ
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm bg-indigo bg-opacity-10 border-start border-4" style="background-color: #f3e8ff; border-left-color: #6610f2 !important;">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-white p-2 rounded-circle shadow-sm me-2" style="color: #6610f2;">
                            <i class="fa-solid fa-briefcase fa-lg"></i>
                        </div>
                        <h6 class="fw-bold text-dark m-0">Müşavir Bağlantısı</h6>
                    </div>

                    <p class="small text-muted mb-3" style="min-height: 40px;">
                        Mali Müşavirinizin size ilettiği <b>6 haneli bağlantı kodunu</b> girerek panel yetkisi verin.
                    </p>
                    
                    <div class="input-group">
                        <input type="text" id="musavirBaglantiKodu" class="form-control fw-bold text-uppercase border-0 shadow-sm" placeholder="KOD (Örn: A7B2X9)" maxlength="6">
                        <button class="btn text-white fw-bold shadow-sm" style="background-color: #6610f2;" onclick="musavirBagla()">
                            <i class="fa-solid fa-link me-2"></i> BAĞLA
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3">
            <h6 class="m-0 fw-bold text-secondary"><i class="fa-solid fa-users-gear me-2"></i>Mevcut Yetkililer</h6>
        </div>
        <div class="card-body p-0">
            <div id="authorizedUsersList" class="list-group list-group-flush">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="sub-coop-info" class="d-none sub-setting-page">
    <div class="d-flex align-items-center mb-4">
        <button class="btn btn-light rounded-circle shadow-sm me-3" onclick="closeSubSetting()" style="width: 45px; height: 45px;">
            <i class="fa-solid fa-arrow-left text-primary"></i>
        </button>
        <div>
            <h4 class="m-0 fw-bold">Kurum Bilgileri</h4>
            <small class="text-muted">Kooperatif resmi bilgilerini düzenleyin.</small>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm p-4">
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">Kooperatif Adı</label>
                    <input type="text" id="setting-coop-name" class="form-control fw-bold" placeholder="Kurumun Tam Adı">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">Resmi Adres</label>
                    <textarea id="setting-coop-address" class="form-control" rows="2" placeholder="Açık adresiniz"></textarea>
                </div>
                <div class="mb-4">
                    <label class="form-label small fw-bold text-success">
                        <i class="fa-brands fa-whatsapp me-1"></i> WhatsApp Destek Hattı
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-success text-white">90</span>
                        <input type="number" id="setting-coop-phone" class="form-control" placeholder="5XXXXXXXXX">
                    </div>
                    <small class="text-muted" style="font-size: 0.7rem;">Üretici panelindeki "Destek" butonu bu numaraya yönlenir.</small>
                </div>
                <button class="btn btn-primary-custom w-100 py-3 fw-bold rounded-3" onclick="kurumBilgileriniKaydet()">
                    <i class="fa-solid fa-save me-2"></i> BİLGİLERİ GÜNCELLE
                </div>
            </div>
        </div>
    </div>
</div>
        </div>
    </div>

     </div>
    <section id="password-requests" class="content-section hidden-section">
    <div class="d-flex align-items-center mb-4">
        <button class="btn btn-light rounded-circle me-3" onclick="switchTab('dashboard')" style="width: 40px; height: 40px;">
            <i class="fa-solid fa-arrow-left"></i>
        </button>
        <h4 class="fw-800 mb-0">🔑 Şifre Değiştirme Talepleri</h4>
    </div>

    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-header bg-white py-3 border-0">
            <h6 class="fw-bold m-0 text-dark">
                <i class="fa-solid fa-list-check me-2 text-primary"></i>Bekleyen Talepler
            </h6>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Tarih</th>
                        <th>Üretici Adı</th>
                        <th>Yeni Şifre Talebi</th>
                        <th class="text-end pe-4">İşlem</th>
                    </tr>
                </thead>
                <tbody id="sifre-talepleri-listesi">
                    <tr><td colspan="4" class="text-center p-5 text-muted small">Talepler yükleniyor...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</section>

<div id="account-detail-page" class="content-section hidden-section">
    <button class="btn btn-primary-custom shadow mb-3 mt-2 px-4 rounded-pill fw-bold" onclick="listeyeDon()">
        <i class="fa-solid fa-arrow-left me-2"></i> LİSTEYE DÖN
    </button>
    <div class="account-header-card p-4 rounded-4 shadow-sm bg-white mb-4">
        <div class="row align-items-center">
                    
                    <div class="col-lg-5 col-md-12 mb-3 mb-lg-0">
                        <h4 class="m-0 fw-bold text-white" id="detailName">Üye Adı</h4>
                        <small class="m-0 text-white-50" id="detailPhone">05XX...</small>
                    </div>

                    <div class="col-lg-7 col-md-12">
                        <div class="d-flex justify-content-between justify-content-lg-end align-items-center gap-3 gap-lg-4 text-end">
                            
                            <div>
                                <small class="d-block text-white-50 fw-bold" style="font-size: 0.65rem;">BORÇ</small>
                                <div class="fw-bold text-white fs-5" id="detailBorc">0 ₺</div>
                            </div>

                            <div class="border-end border-white border-opacity-25" style="height: 30px;"></div>

                            <div>
                                <small class="d-block text-white-50 fw-bold" style="font-size: 0.65rem;">ALACAK</small>
                                <div class="fw-bold text-white fs-5" id="detailAlacak">0 ₺</div>
                            </div>

                            <div class="border-end border-white border-opacity-25" style="height: 30px;"></div>

                            <div>
                                <small class="d-block text-warning fw-bold" style="font-size: 0.65rem;">BAKİYE</small>
                                <div class="fw-bold text-white" style="font-size: 1.8rem; line-height: 1;" id="detailBalance">0 ₺</div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
<div class="row g-2 mb-4"> <div class="col-6 col-md-3">
        <button class="quick-action-btn" onclick="yeniEvrakModalAc()">
            <div class="btn-icon-circle" style="background: #e0f2fe; color: #0284c7;">
                <i class="fa-solid fa-file-invoice"></i>
            </div>
            <div class="text-start" style="line-height: 1.2;">
                <div class="fw-bold text-dark small">YENİ EVRAK</div>
                <small class="text-muted" style="font-size: 0.65rem;">Fatura Kes</small>
            </div>
        </button>
    </div>

    <div class="col-6 col-md-3">
        <button class="quick-action-btn" onclick="islemEkle('tahsilat')">
            <div class="btn-icon-circle" style="background: #dcfce7; color: #166534;">
                <i class="fa-solid fa-hand-holding-dollar"></i>
            </div>
            <div class="text-start" style="line-height: 1.2;">
                <div class="fw-bold text-dark small">TAHSİLAT</div>
                <small class="text-muted" style="font-size: 0.65rem;">Para Girişi</small>
            </div>
        </button>
    </div>

    <div class="col-6 col-md-3">
        <button class="quick-action-btn" onclick="islemEkle('odeme')">
            <div class="btn-icon-circle" style="background: #ffedd5; color: #c2410c;">
                <i class="fa-solid fa-wallet"></i>
            </div>
            <div class="text-start" style="line-height: 1.2;">
                <div class="fw-bold text-dark small">ÖDEME</div>
                <small class="text-muted" style="font-size: 0.65rem;">Para Çıkışı</small>
            </div>
        </button>
    </div>

    <div class="col-6 col-md-3">
        <button class="quick-action-btn" onclick="Swal.fire('Bilgi','PDF Hazırlanıyor...','info')">
            <div class="btn-icon-circle bg-light text-secondary border">
                <i class="fa-solid fa-print"></i>
            </div>
            <div class="text-start" style="line-height: 1.2;">
                <div class="fw-bold text-dark small">YAZDIR</div>
                <small class="text-muted" style="font-size: 0.65rem;">Ekstre Dökümü</small>
            </div>
        </button>
    </div>
</div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 fw-bold text-dark"><i class="fa-solid fa-list-ul me-2 text-primary"></i>Hesap Hareketleri</h6>
                </div>
                <div class="table-responsive">
    <table class="table table-ledger align-middle mb-0">
        <thead>
            <tr>
                <th>Tarih</th>
                <th class="hide-mobile">Belge No</th>
                <th>Açıklama</th>
                <th class="text-end text-danger bg-light">Borç<br><small>(Mal Bedeli)</small></th>
                <th class="text-end text-success bg-light">Tahsilat<br><small>(Süt/Nakit)</small></th>
                <th class="text-end bg-white">Kalan Borç<br><small>(Bakiye)</small></th>
                <th class="text-end">İşlem</th>
            </tr>
        </thead>
        <tbody id="detailTableBody">
            </tbody>
    </table>
</div>
           
  <div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Ürün Kartı</h5>
                <button type="button" class="btn-close" onclick="bootstrap.Modal.getInstance(document.getElementById('productModal')).hide()"></button>
            </div>
            <div class="modal-body">
                
                <form id="productForm">
                    <input type="hidden" id="prodId">
                    
                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <label class="form-label small fw-bold">Ürün Kodu</label>
                            <input type="text" class="form-control" id="prodCode" placeholder="Örn: YEM01">
                        </div>
                        <div class="col-8">
                            <label class="form-label small fw-bold">Ürün Adı</label>
                            <input type="text" class="form-control" id="prodName" placeholder="Örn: 21 Protein Süt Yemi" required>
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small fw-bold">Kategori</label>
                            <select class="form-select" id="prodCat">
                                <option>Yem</option>
                                <option>Un</option>
                                <option>Kepek</option>
                                <option>Gübre</option>
                                <option>Akaryakıt</option>
                                <option>Diğer</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">Birim</label>
                            <select class="form-select" id="prodUnit">
                                <option>Adet</option>
                                <option>Adet (Çuval)</option>
                                <option>Kg</option>
                                <option>Ton</option>
                                <option>Litre</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <label class="form-label small fw-bold">Alış Fiyatı</label>
                            <input type="number" class="form-control" id="prodBuy" placeholder="0.00">
                        </div>
                        <div class="col-4">
                            <label class="form-label small fw-bold">Satış Fiyatı</label>
                            <input type="number" class="form-control" id="prodSell" placeholder="0.00">
                        </div>
                        <div class="col-4">
                            <label class="form-label small fw-bold">KDV (%)</label>
                            <select class="form-select text-danger fw-bold" id="prodTax">
                                <option value="0">0%</option>
                                <option value="1">1%</option>
                                <option value="10">10%</option>
                                <option value="20">20%</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3 bg-light p-3 rounded border">
                        <label class="form-label small fw-bold text-primary">Stok Girişi</label>
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button" onclick="stokDegis(-1)"><i class="fa-solid fa-minus"></i></button>
                            <input type="number" class="form-control text-center fw-bold" id="prodStock" value="0">
                            <button class="btn btn-outline-secondary" type="button" onclick="stokDegis(1)"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 fw-bold">KAYDET</button>
                </form>

            </div>
        </div>
    </div>
</div>  
<div class="modal fade" id="evrakModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-width: 95%;"> <div class="modal-content border-0 shadow-lg">
            
            <div class="modal-header bg-light py-3">
                <h5 class="modal-title fw-bold text-primary" id="modalBaslik">
                    <i class="fa-solid fa-file-invoice me-2"></i>Yeni Evrak Girişi
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body bg-light">

                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-lg-3 col-md-6">
                                <label class="form-label small fw-bold text-muted">Evrak Türü</label>
                                <select class="form-select fw-bold text-dark" id="evrakTuru">
                                    <option value="satis">Satış Faturası</option>
                                    <option value="iade">İade Faturası</option>
                                    <option value="mustahsil">E-Müstahsil Makbuzu</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <label class="form-label small fw-bold text-muted">Tarih</label>
                                <input type="date" class="form-control fw-bold" id="evrakTarih">
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <label class="form-label small fw-bold text-muted">Belge No</label>
                                <input type="text" class="form-control" id="evrakBelgeNo" placeholder="Örn: A-12345">
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <label class="form-label small fw-bold text-muted">Açıklama</label>
                                <input type="text" class="form-control" id="evrakAciklama" placeholder="Fatura Açıklaması">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0 small align-middle" id="faturaTablosu" style="min-width: 1100px;">
                                <thead class="table-light">
                                    <tr class="text-center text-uppercase">
                                        <th style="width: 10%">Kod</th>
                                        <th style="width: 25%">Ürün / Hizmet Adı</th>
                                        <th style="width: 8%">Miktar</th>
                                        <th style="width: 10%">Birim</th>
                                        <th style="width: 12%">Birim Fiyat</th>
                                        <th style="width: 10%">KDV %</th>
                                        <th style="width: 10%">KDV Tutarı</th>
                                        <th style="width: 10%">Toplam</th>
                                        <th style="width: 5%"><i class="fa-solid fa-trash"></i></th>
                                    </tr>
                                </thead>
                                <tbody id="faturaSatirlari" class="bg-white">
                                    </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="9" class="p-2 bg-light">
                                            <button class="btn btn-sm btn-outline-primary fw-bold w-100 py-2 dashed-border" onclick="satirEkle()">
                                                <i class="fa-solid fa-plus me-1"></i> Yeni Satır Ekle
                                            </button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-white p-3">
                        <div class="row justify-content-end">
                            <div class="col-md-4 col-lg-3">
                                <table class="table table-sm table-borderless text-end mb-0" style="font-size: 0.9rem;">
                                    <tr>
                                        <td class="text-secondary">Ara Toplam:</td>
                                        <td class="fw-bold text-dark" id="lblAraToplam">0,00 ₺</td>
                                    </tr>
                                    <tr>
                                        <td class="text-secondary">Toplam KDV:</td>
                                        <td class="fw-bold text-danger" id="lblKdvToplam">0,00 ₺</td>
                                    </tr>
                                    <tr class="border-top">
                                        <td class="fw-bold text-dark fs-5 align-middle pt-2">GENEL TOPLAM:</td>
                                        <td class="fw-bold text-dark fs-5 pt-2" id="lblGenelToplam">0,00 ₺</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary px-5 fw-bold" id="evrakKaydetBtn" onclick="evrakiKaydet()">
                    <i class="fa-solid fa-save me-2"></i> KAYDET
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="detayModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
            
            <div class="modal-header modal-header-dynamic">
                <div>
                    <h5 class="modal-title fw-bold mb-1" id="detayBaslik">Fatura Detayı</h5>
                    <div class="opacity-75 small">
                        <i class="fa-regular fa-clock me-1"></i> <span id="detayTarihNo">...</span>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0 bg-white">
                <div class="table-responsive">
                    <table class="table table-invoice mb-0 w-100">
                        <thead>
                            <tr>
                                <th class="ps-4">Ürün / Hizmet</th>
                                <th class="text-center">Miktar</th>
                                <th class="text-end">Birim Fiyat</th>
                                <th class="text-center">KDV</th>
                                <th class="text-end pe-4">Toplam</th>
                            </tr>
                        </thead>
                        <tbody id="detayIcerik">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer bg-light border-0 d-block p-4">
                <div class="row">
                    <div class="col-md-7 mb-3 mb-md-0">
                        <div class="note-box shadow-sm">
                            <div class="fw-bold mb-1"><i class="fa-solid fa-circle-info me-1"></i> Açıklama</div>
                            <div id="detayAciklama" style="line-height: 1.4;">-</div>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <div class="summary-box">
                            <div class="total-row">
                                <span>Ara Toplam</span>
                                <span class="fw-bold text-dark" id="ozetAraToplam">0,00 ₺</span>
                            </div>
                            <div class="total-row">
                                <span>KDV Toplam</span>
                                <span class="fw-bold text-danger" id="ozetKdv">0,00 ₺</span>
                            </div>
                            
                            <div class="total-final">
                                <span class="text-uppercase fw-bold text-secondary small">Genel Toplam</span>
                                <span class="big-total" id="ozetGenelToplam">0,00 ₺</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<div class="modal fade" id="sutHesaplaModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold"><i class="fa-solid fa-calculator me-2"></i>Dönemsel Süt Hesapla</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info small">
                    <i class="fa-solid fa-info-circle me-1"></i> 
                    Seçilen tarih aralığındaki <b>işlenmemiş</b> süt kayıtlarını toplar ve üyelerin cari hesabına "Alacak" olarak ekler.
                </div>

                <form id="sutHesapForm">
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="fw-bold small text-muted">Başlangıç Tarihi</label>
                            <input type="date" class="form-control" id="calcStartDate" required>
                        </div>
                        <div class="col-6">
                            <label class="fw-bold small text-muted">Bitiş Tarihi</label>
                            <input type="date" class="form-control" id="calcEndDate" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Litre Fiyatı (TL)</label>
                        <div class="input-group">
                            <input type="number" class="form-control fs-5 fw-bold text-primary" id="calcPrice" placeholder="0.00" step="0.01" required>
                            <span class="input-group-text">₺</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Açıklama (Otomatik Oluşur)</label>
                        <input type="text" class="form-control text-muted" id="calcDesc" placeholder="Örn: 01-07 Kasım Süt Bedeli" readonly>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-dark fw-bold py-2">HESAPLA VE CARİYE İŞLE</button>
                    <button type="button" class="btn btn-outline-danger w-100 fw-bold py-2 mt-2" onclick="islemiGeriAlBaslat()">
    <i class="fa-solid fa-rotate-left me-2"></i> BUGÜNKÜ HATALI İŞLEMİ GERİ AL
</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="yayinlaModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold"><i class="fa-solid fa-bullhorn me-2"></i>Hesap Ekstresi Yayınla</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-light border small text-muted">
                    <i class="fa-solid fa-circle-info me-1"></i> 
                    Seçilen dönem için üyelerin bakiyelerini hesaplar ve üretici panelinde görünür hale getirir.
                </div>

                <form onsubmit="hesapYayinla(event)">
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Hangi Dönem?</label>
                        <input type="month" class="form-control fw-bold" id="pubMonth" required>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Kime Yayınlanacak?</label>
                        <select class="form-select" id="pubFilterType" onchange="filtreDegisti()">
                            <option value="all">Tüm Üyeler</option>
                            <option value="village">Bölge / Köy Seçimi</option>
                            <option value="single">Tek Bir Üye</option>
                        </select>
                    </div>

                    <div class="mb-3 d-none" id="divPubVillage">
                        <label class="fw-bold small text-muted">Köy Seçiniz</label>
                        <select class="form-select" id="pubVillageSelect"></select>
                    </div>

                    <div class="mb-3 d-none" id="divPubMember">
                        <label class="fw-bold small text-muted">Üye Seçiniz</label>
                        <select class="form-select" id="pubMemberSelect"></select>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success fw-bold py-3">
    HESAPLA VE YAYINLA
</button>
                    </div>
                    <button type="button" class="btn btn-warning w-100 fw-bold py-2 mt-2 text-dark" onclick="yayiniKaldir()">
    <i class="fa-solid fa-rotate-left me-2"></i> YAYINLANAN RAPORU GERİ ÇEK
</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="addMemberModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem; overflow: hidden;">
            
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #0f766e 0%, #0e7490 100%); padding: 1.5rem 1.5rem 0 1.5rem; border-bottom: 0;">
                <div class="w-100">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="modal-title fw-bold" id="lblModalTitle"><i class="fa-solid fa-user-plus me-2"></i>Yeni Kayıt Oluştur</h5>
                            <small class="opacity-75">Üretici bilgilerini sekmelerden yönetebilirsiniz.</small>
                        </div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>

                    <ul class="nav nav-tabs border-0" id="memberTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active fw-bold text-white bg-transparent px-3 py-2 border-0 border-bottom border-3 border-white rounded-0" 
                                    data-bs-toggle="tab" data-bs-target="#tab-genel" type="button">
                                <i class="fa-solid fa-id-card me-2"></i>Kişisel Bilgiler
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold text-white-50 bg-transparent px-3 py-2 border-0 rounded-0" 
                                    data-bs-toggle="tab" data-bs-target="#tab-finans" type="button">
                                <i class="fa-solid fa-coins me-2"></i>Finansal & Kesintiler
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="modal-body bg-light p-4">
                <form id="addMemberForm">
                    <div class="tab-content" id="memberTabsContent">
                        <div class="tab-pane fade show active" id="tab-genel" role="tabpanel">
    <div class="row g-4">
        
        <div class="col-lg-6 border-end">
            
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body p-3">
                    <h6 class="fw-bold text-primary small text-uppercase border-bottom pb-2 mb-3">
                        <i class="fa-solid fa-map-location-dot me-2"></i>Rota & İşletme
                    </h6>
                    <div class="row g-2">
                        <div class="col-3">
                            <label class="small fw-bold text-muted">Sıra No</label>
                            <input type="number" class="form-control fw-bold text-center text-primary" id="uyeSira" placeholder="1">
                        </div>
                        <div class="col-5">
                            <label class="small fw-bold text-muted">Bölge / Rota</label>
                            <select class="form-select fw-bold text-dark" id="uyeKoy" required>
                                <option value="">Seç...</option>
                                </select>
                        </div>
                        <div class="col-4">
                            <label class="small fw-bold text-muted">İşletme No</label>
                            <input type="text" class="form-control fw-bold text-dark" id="uyeIsletmeNo" placeholder="TR-35...">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body p-3">
                    <h6 class="fw-bold text-primary small text-uppercase border-bottom pb-2 mb-3">
                        <i class="fa-solid fa-user me-2"></i>Temel Kimlik
                    </h6>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="small fw-bold text-muted">Adı</label>
                            <input type="text" class="form-control" id="uyeAd" required>
                        </div>
                        <div class="col-6">
                            <label class="small fw-bold text-muted">Soyadı</label>
                            <input type="text" class="form-control" id="uyeSoyad" required>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="small fw-bold text-muted">TC Kimlik No</label>
                            <input type="text" class="form-control" id="uyeTc" maxlength="11">
                        </div>
                        <div class="col-6">
                            <label class="small fw-bold text-muted">Telefon</label>
                            <input type="text" class="form-control" id="uyeTel" placeholder="05...">
                        </div>
                        <div class="mt-3 pt-3 border-top">
    <label class="small fw-bold text-primary">
        <i class="fa-solid fa-envelope-circle-check me-1"></i>Kurtarma E-Postası (Gizli)
    </label>
    <input type="email" class="form-control bg-light" id="uyeEmail" placeholder="ornek@email.com">
    <div class="form-text x-small text-muted">Şifre sıfırlama linki sadece bu adrese gönderilir.</div>
</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body p-3">
                    <h6 class="fw-bold text-primary small text-uppercase border-bottom pb-2 mb-3">
                        <i class="fa-solid fa-id-card-clip me-2"></i>Kişisel Detaylar
                    </h6>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="small fw-bold text-muted">Baba Adı</label>
                            <input type="text" class="form-control" id="uyeBabaAdi">
                        </div>
                        <div class="col-6">
                            <label class="small fw-bold text-muted">Doğum Tarihi</label>
                            <input type="date" class="form-control" id="uyeDogumTarihi">
                        </div>
                    </div>
                    <div>
                        <label class="small fw-bold text-muted">Eğitim Durumu</label>
                        <select class="form-select" id="uyeEgitim">
                            <option value="">Seçiniz...</option>
                            <option value="okuryazar_degil">Okur Yazar Değil</option>
                            <option value="ilkokul">İlkokul</option>
                            <option value="ortaokul">Ortaokul</option>
                            <option value="lise">Lise</option>
                            <option value="universite">Üniversite</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body p-3">
                    <h6 class="fw-bold text-primary small text-uppercase border-bottom pb-2 mb-3">
                        <i class="fa-solid fa-location-dot me-2"></i>İletişim & Adres
                    </h6>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="small fw-bold text-muted">İl</label>
                            <input type="text" class="form-control" id="uyeIl" placeholder="Örn: İzmir">
                        </div>
                        <div class="col-6">
                            <label class="small fw-bold text-muted">İlçe</label>
                            <input type="text" class="form-control" id="uyeIlce" placeholder="Örn: Kınık">
                        </div>
                    </div>
                    <div>
                        <label class="small fw-bold text-muted">Açık Adres</label>
                        <textarea class="form-control" id="uyeAdres" rows="2" placeholder="Mahalle, sokak, kapı no..."></textarea>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

                        <div class="tab-pane fade" id="tab-finans" role="tabpanel">
                            
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-body p-3 d-flex align-items-center gap-3">
                                    <div class="bg-success bg-opacity-10 text-success rounded p-2">
                                        <i class="fa-solid fa-building-columns fa-2x"></i>
                                    </div>
                                    <div class="w-100">
                                        <label class="small fw-bold text-muted mb-1">Banka / IBAN Bilgisi</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-white border-end-0 fw-bold text-success">TR</span>
                                            <input type="text" class="form-control border-start-0 font-monospace fw-bold text-dark" id="uyeIban" placeholder=>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card border-0 shadow-sm" style="background-color: #fffbeb;">
                                <div class="card-header bg-transparent border-bottom border-warning border-opacity-25 py-3 d-flex justify-content-between align-items-center">
                                    <h6 class="fw-bold text-dark m-0" style="color: #92400e !important;">
                                        <i class="fa-solid fa-scissors me-2"></i>Müstahsil Kesintileri
                                    </h6>
                                    <button type="button" class="btn btn-sm btn-warning text-dark fw-bold rounded-pill shadow-sm" onclick="yeniKesintiSatiriEkle()">
                                        <i class="fa-solid fa-plus me-1"></i> Ekle
                                    </button>
                                </div>
                                <div class="card-body p-3">
                                    <div class="alert alert-light border border-warning small text-muted mb-3">
                                        <i class="fa-solid fa-circle-info text-warning me-1"></i>
                                        Seçili olan kesintiler otomatik hesaplamaya dahil edilir.
                                    </div>

                                    <div id="kesintiListesiContainer" class="d-flex flex-column gap-2" style="max-height: 250px; overflow-y: auto;">
                                        </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer bg-white p-3">
                <button type="button" class="btn btn-light border px-4 fw-bold text-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary-custom px-5 fw-bold shadow-sm" onclick="uyeKaydetSubmit()">
                    <i class="fa-solid fa-floppy-disk me-2"></i> KAYDET VE TAMAMLA
                </button>
            </div>
        </div>
    </div>
</div>
        </div>
    </div>
</div>
<div class="modal fade" id="addDriverModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem; overflow: hidden;">
            
            <div class="modal-header text-white border-0" style="background: linear-gradient(135deg, #6610f2 0%, #4f46e5 100%); padding: 1.5rem;">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-white bg-opacity-25 rounded-circle p-2 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                        <i class="fa-solid fa-user-plus fa-lg"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bold" style="line-height: 1;">Yeni Personel</h5>
                        <small class="opacity-75" style="font-size: 0.8rem;">Sisteme giriş yapacak yetkili tanımlayın</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white align-self-start" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body bg-light p-4">
                
                <div class="alert alert-light border border-indigo text-indigo d-flex align-items-center shadow-sm mb-4" role="alert" style="color: #4f46e5; border-color: #e0e7ff;">
                    <i class="fa-solid fa-shield-halved me-3 fs-4"></i>
                    <div class="small fw-bold">
                        Bu işlem güvenli bir şekilde arka planda kullanıcı oluşturur. Mevcut oturumunuz etkilenmez.
                    </div>
                </div>

                <form id="addDriverForm">
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body p-3">
                            <h6 class="fw-bold text-dark small text-uppercase border-bottom pb-2 mb-3" style="color: #4f46e5 !important;">
                                <i class="fa-solid fa-id-card me-2"></i>Kişisel Bilgiler
                            </h6>
                            
                            <div class="mb-3">
                                <label class="small fw-bold text-muted">Ad Soyad</label>
                                <input type="text" class="form-control fw-bold" id="soforAd" placeholder="Örn: Ahmet Yılmaz" required>
                            </div>

                            <div class="mb-0">
                                <label class="small fw-bold text-muted">Görevi / Rolü</label>
                                <select class="form-select fw-bold text-dark" id="soforRol" style="cursor: pointer;">
                                    <option value="sofor">🚛 Şoför (Sadece Süt Toplar)</option>
                                    <option value="yonetici">👔 Yönetici (Tam Yetki)</option>
                                    <option value="plasiyer">📦 Plasiyer (Sadece Satış)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-3">
                            <h6 class="fw-bold text-dark small text-uppercase border-bottom pb-2 mb-3" style="color: #4f46e5 !important;">
                                <i class="fa-solid fa-lock me-2"></i>Giriş Bilgileri
                            </h6>
                            
                            <div class="mb-3">
                                <label class="small fw-bold text-muted">E-Posta Adresi</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0 text-muted"><i class="fa-solid fa-envelope"></i></span>
                                    <input type="email" class="form-control border-start-0" id="soforEmail" placeholder="personel@sirket.com" required>
                                </div>
                            </div>

                            <div class="mb-0">
                                <label class="small fw-bold text-muted">Giriş Şifresi</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0 text-muted"><i class="fa-solid fa-key"></i></span>
                                    <input type="text" class="form-control border-start-0 font-monospace" id="soforPass" placeholder="En az 6 hane" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn text-white fw-bold py-3 shadow-sm" style="background: linear-gradient(135deg, #6610f2 0%, #4f46e5 100%); border-radius: 12px;">
                            <i class="fa-solid fa-check-circle me-2"></i> PERSONELİ OLUŞTUR
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="topluFinansModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold">
                    <i class="fa-solid fa-layer-group me-2"></i>Toplu Finansal İşlem
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body bg-light">
                
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body p-3">
                        <div class="row g-2 align-items-end">
                            
                            <div class="col-lg-2">
                                <label class="small fw-bold text-muted mb-1">İşlem Türü</label>
                                <select id="tfTur" class="form-select fw-bold text-dark bg-white border-secondary">
                                    <option value="odeme">Ödeme Yap (Para Çıkışı)</option>
                                    <option value="tahsilat">Tahsilat Al (Para Girişi)</option>
                                </select>
                            </div>

                            <div class="col-lg-2">
                                <label class="small fw-bold text-muted mb-1">Referans Tarih</label>
                                <input type="date" id="tfRefDate" class="form-control" title="Hangi tarih itibariyle bakiye alınsın?">
                            </div>

                            <div class="col-lg-2">
                                <label class="small fw-bold text-muted mb-1">İşlem Tarihi</label>
                                <input type="date" id="tfIslemDate" class="form-control fw-bold text-primary" title="Cariye hangi tarihle işlensin?">
                            </div>

                            <div class="col-lg-2">
                                <label class="small fw-bold text-muted mb-1">Köy / Rota</label>
                                <select id="tfKoy" class="form-select">
                                    <option value="all">Tümü</option>
                                </select>
                            </div>

                            <div class="col-lg-2">
                                <button class="btn btn-warning w-100 fw-bold" onclick="topluFinansListele()">
                                    <i class="fa-solid fa-calculator me-1"></i> LİSTELE
                                </button>
                            </div>
                            
                            <div class="col-lg-2">
                                <button class="btn btn-outline-secondary w-100 small" onclick="topluTutarSifirla()">
                                    <i class="fa-solid fa-eraser me-1"></i> Tutarları Sil
                                </button>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 table-sm" style="font-size: 0.9rem;">
                            <thead class="table-secondary">
                                <tr>
                                    <th class="ps-3 py-2">Üretici Adı</th>
                                    <th>Köy</th>
                                    <th class="text-end">Ref. Bakiye</th>
                                    <th class="text-center" style="width: 160px;">İşlenecek Tutar</th>
                                    <th>Açıklama</th>
                                </tr>
                            </thead>
                            <tbody id="tfTableBody" class="bg-white">
                                <tr><td colspan="5" class="text-center p-5 text-muted">Lütfen kriterleri seçip 'LİSTELE' butonuna basınız.</td></tr>
                            </tbody>
                            <tfoot class="bg-light fw-bold">
                                <tr>
                                    <td colspan="3" class="text-end pe-3 py-3">DAĞITILACAK TOPLAM:</td>
                                    <td class="text-center text-primary fs-5" id="tfGenelToplam">0,00 ₺</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

            </div>
            
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-success px-4 fw-bold" onclick="topluFinansKaydet()">
                    <i class="fa-solid fa-check-circle me-2"></i> İŞLEMLERİ KAYDET
                </button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { 
        firebaseConfig,
        app, auth, db, 
        doc, getDoc, setDoc, addDoc, collection, query, where, getDocs, 
        onSnapshot, deleteDoc, updateDoc, arrayUnion, arrayRemove, 
        orderBy, limit, writeBatch, increment,
        onAuthStateChanged, signOut, createUserWithEmailAndPassword, sendPasswordResetEmail
    } from "../js/firebase-config.js";

    import { initializeApp as initializeAppNew, deleteApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth as getAuthNew, signOut as signOutNew } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
let currentCoopId = null;

window.kututuphaneYukle = function(url) {
    return new Promise((resolve, reject) => {
        // Zaten yüklüyse tekrar yükleme, hemen bitir
        if (document.querySelector(`script[src="${url}"]`)) { resolve(); return; }
        
        const script = document.createElement('script');
        script.src = url;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}
let activeMemberId = null;
let duzenlenecekEvrakId = null;
let aktifCariTipi = 'musteri';
let villageList = [];
let allMembers = [];
let kdvDahilMi = false;
let trendChart = null; // <-- BURADA TANIMLI OLMASI YETERLİ
let pieChart = null;   // <-- BURADA TANIMLI OLMASI YETERLİ
let duzenlenecekId = null; 

// Export (Opsiyonel ama modül yapısında dursun)
export { app, auth, db, doc, setDoc, deleteDoc, updateDoc };

// --- DÜZELTİLMİŞ GİRİŞ VE YETKİ KONTROLÜ ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // 1. Görsel düzenlemeler (Email yaz)
            if(document.getElementById("userEmailDisplay")) {
                document.getElementById("userEmailDisplay").innerText = user.email;
            }
            
            try {
                // 2. KULLANICIYI BULMA
                const q = query(collection(db, "users"), where("email", "==", user.email));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    
                    // Rolü küçük harfe çevirerek al (Büyük/Küçük harf hatasını önler)
                    const rol = (userData.role || userData.rol || '').toLowerCase();

                    // --- KRİTİK DÜZELTME: SUPERADMIN'E DE İZİN VER ---
                    // Artık 'superadmin' de bu panele girebilir.
                    if(rol !== 'admin' && rol !== 'yonetici' && rol !== 'superadmin') {
                        console.warn("Yetkisiz Giriş Denemesi. Rol:", rol);
                        alert(`Yetkisiz Giriş!\n\nSizin Rolünüz: ${rol}\nBu panele sadece Yöneticiler girebilir.`);
                        
                        await signOut(auth);
                        window.location.href = "../giris.html";
                        return;
                    }

                    // Kurum ID'sini al
                    currentCoopId = userData.kurumID || userData.coopId;
                    
                    // Eğer Super Admin ise ve CoopID yoksa, hata vermemesi için sahte/ilk kurumu seçebiliriz
                    // (Şimdilik boş geçiyoruz, dashboard boş gelebilir ama atmaz)
                    
                    window.aktifKurumID = currentCoopId;
                    sessionStorage.setItem("coopId", currentCoopId);

                    console.log("Giriş Başarılı. Rol:", rol, "Kurum:", currentCoopId);

                    // Başlıkları Güncelle
                    const kAdi = userData.kurumAdi || userData.ad || "Yönetim Paneli";
                    if(document.getElementById("lblCompanyName")) document.getElementById("lblCompanyName").innerText = kAdi;
                    if(document.getElementById("page-title")) document.getElementById("page-title").innerText = "Hoşgeldiniz: " + (userData.adSoyad || "Yönetici");

                    // VERİLERİ ÇEK
                    if(currentCoopId) {
                        if(typeof sirketBilgileriniDinle === 'function') sirketBilgileriniDinle(currentCoopId);
                        if(typeof uyeleriGetir === 'function') uyeleriGetir();
                        if(typeof stoklariDinle === 'function') stoklariDinle();
                    } else if (rol === 'superadmin') {
                        // Eğer süper adminse ve kurum seçili değilse uyarmasın, sadece boş göstersin
                        console.log("Super Admin modu: Kurum ID yok.");
                    }

                } else {
                    alert("Kullanıcı veritabanında bulunamadı! (Firestore Kaydı Yok)");
                    await signOut(auth);
                    window.location.href = "../giris.html";
                }
            } catch (error) {
                console.error("Giriş Kontrol Hatası:", error);
            }

        } else {
            // Giriş yapılmamışsa login sayfasına at
            window.location.href = "../giris.html"; 
        }
    });
  // --- ŞİRKET BİLGİLERİNİ VE ROTALARI DİNLE ---
function sirketBilgileriniDinle(id) {
    onSnapshot(doc(db, "cooperatives", id), (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            
            // Şirket Adı
            const lblCompany = document.getElementById("lblCompanyName");
            if(lblCompany) lblCompany.innerText = data.ad || "Kooperatif Paneli";
            
            // Sapma Limiti
            const sapmaInput = document.getElementById("sapmaInput");
            if(sapmaInput) sapmaInput.value = data.deviationLimit || "";
            
            // KDV Ayarı
            kdvDahilMi = data.isTaxInclusive || false;
            if(document.getElementById("optKdvDahil")) {
                document.getElementById("optKdvDahil").checked = kdvDahilMi;
                document.getElementById("optKdvHaric").checked = !kdvDahilMi;
            }

            // --- ROTA LİSTESİNİ GÜNCELLE ---
            // Veritabanındaki 'villages' dizisini al, yoksa boş dizi yap
            villageList = data.villages || []; 
            
            // Listeyi Ekrana Çiz (Yeni fonksiyonu çağır)
            ayarlarListesiniCiz();
            
            // Yeni Üye eklerken açılan listedeki selectbox'ı da güncelle
            modalSelectDoldur();
        }
    });
}
// --- LİSTE ÇİZME FONKSİYONU (YENİ TASARIMA UYGUN) ---
function ayarlarListesiniCiz() {
    const listDiv = document.getElementById("villageList");
    const badge = document.getElementById("rotaSayisiBadge");
    
    if(!listDiv) return;
    listDiv.innerHTML = ""; // Önce listeyi temizle
    
    // Veri yoksa veya boşsa "Kayıt Yok" görseli göster
    if(!Array.isArray(villageList) || villageList.length === 0) {
        if(badge) badge.innerText = "0 Rota";
        listDiv.innerHTML = `
            <div class="text-center py-5 text-muted">
                <div class="mb-3"><i class="fa-solid fa-map-location-dot fa-3x opacity-25"></i></div>
                <p class="m-0 fw-bold">Henüz Kayıt Yok</p>
                <small>Yukarıdan yeni bir rota ekleyebilirsiniz.</small>
            </div>`;
        return;
    }

    // Badge sayısını güncelle
    if(badge) badge.innerText = `${villageList.length} Rota`;

    // Listeyi Alfabetik Sırala
    villageList.sort((a, b) => a.localeCompare(b, 'tr'));
    
    // Her bir köy için liste elemanı oluştur
    villageList.forEach(koy => {
        const item = document.createElement("div");
        // Bootstrap List Group sınıflarını kullanıyoruz
        item.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3 border-bottom";
        
        item.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="bg-light text-primary rounded-circle d-flex align-items-center justify-content-center me-3 shadow-sm" style="width:45px; height:45px;">
                    <i class="fa-solid fa-location-arrow"></i>
                </div>
                <div>
                    <h6 class="mb-0 fw-bold text-dark">${koy}</h6>
                    <small class="text-muted" style="font-size: 0.75rem;">Aktif Yerleşim Yeri</small>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-light text-primary border me-1" onclick="bolgeDuzenle('${koy}')" title="Adı Düzenle">
                    <i class="fa-solid fa-pen"></i>
                </button>
                <button class="btn btn-light text-danger border" onclick="bolgeSil('${koy}')" title="Sil">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        `;
        listDiv.appendChild(item);
    });
}

    function modalSelectDoldur() {
        const selectBox = document.getElementById("uyeKoy");
        if(!selectBox) return;
        selectBox.innerHTML = '<option value="">Seçiniz...</option>';
        if(Array.isArray(villageList)) {
            villageList.sort().forEach(koy => {
                const opt = document.createElement("option");
                opt.value = koy; opt.text = koy;
                selectBox.appendChild(opt);
            });
        }
    }

    
// --- ÜYELERİ GETİR (PERFORMANSLI VE FULL VERSİYON) ---
    window.uyeleriGetir = async function() {
        if(!currentCoopId) return;

        const q = query(collection(db, "members"), where("coopId", "==", currentCoopId));
        
        // Veriyi bekle ve çek (onSnapshot yerine getDocs kullanarak performansı koruyoruz)
        const snapshot = await getDocs(q);

        allMembers = [];
        snapshot.forEach((doc) => { 
            let d = doc.data(); 
            d.id = doc.id; 
            if(!d.tip) d.tip = 'musteri'; 
            allMembers.push(d); 
        });
        
        // Sıralama (Listede sıra numarasına göre düzgün görünsün)
        allMembers.sort((a,b) => (Number(a.sira) || 999) - (Number(b.sira) || 999));
        
        // 1. Ana Listeyi Ekrana Çiz
        if(typeof listeyiFiltreleVeCiz === 'function') {
            listeyiFiltreleVeCiz();
        }
        
        // 2. Dashboard Sayısını Güncelle
        const dashTotal = document.getElementById("dashTotalMember");
        if(dashTotal) dashTotal.innerText = allMembers.length;

        // 3. Süt Arama Kutusunu Doldur (YENİ EKLENEN KISIM)
        const sutSelect = document.getElementById("sutAramaUye");
        if(sutSelect) {
            sutSelect.innerHTML = '<option value="">Tüm Üreticiler</option>';
            
            // İsme göre alfabetik sıralı kopya oluştur
            const siraliIsim = [...allMembers].sort((a,b) => a.ad.localeCompare(b.ad));
            
            siraliIsim.forEach(m => {
                const opt = document.createElement("option");
                opt.value = m.id;
                opt.text = `${m.ad} ${m.soyad}`;
                sutSelect.appendChild(opt);
            });
        }
    }

// YENİ FONKSİYON: Listeyi o anki seçime göre filtreleyip çizer
function listeyiFiltreleVeCiz() {
    // Sadece aktif tipe uyanları al (musteri ise musterileri, tedarikci ise tedarikcileri)
    const filtrelenmisListe = allMembers.filter(uye => uye.tip === aktifCariTipi);
    
    // Arama kutusu doluysa onun içinde de ara
    const aramaMetni = document.getElementById("searchInput").value.toLowerCase();
    const finalListe = filtrelenmisListe.filter(m => 
        m.ad.toLowerCase().includes(aramaMetni) || 
        m.soyad.toLowerCase().includes(aramaMetni)
    );

    tabloyuCiz(finalListe);
    
    // Kayıt sayısını güncelle
    const recCount = document.getElementById("recordCount");
    if(recCount) recCount.innerText = `${finalListe.length} kayıt listelendi`;
}
    // Fonksiyonlar (Sil, Ekle, Düzenle)
    window.limitKaydet = async function() {
        const val = document.getElementById("sapmaInput").value;
        try {
            await updateDoc(doc(db, "cooperatives", currentCoopId), { deviationLimit: Number(val) });
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Limit Kaydedildi', timer: 1500, showConfirmButton: false });
        } catch (error) { Swal.fire("Hata", "Kaydedilemedi", "error"); }
    }
    window.kdvAyariniKaydet = async function() {
    // Seçili olan radio butonunu bul
    const secim = document.querySelector('input[name="kdvAyari"]:checked').value;
    const yeniDurum = (secim === 'dahil'); // 'dahil' ise true, değilse false

    try {
        await updateDoc(doc(db, "cooperatives", currentCoopId), { 
            isTaxInclusive: yeniDurum 
        });
        
        // Değişkeni hemen güncelle ki sayfa yenilemeye gerek kalmasın
        kdvDahilMi = yeniDurum;

        Swal.fire({
            icon: 'success',
            title: 'Ayar Güncellendi',
            text: `Artık birim fiyatlar KDV ${yeniDurum ? 'DAHİL' : 'HARİÇ'} olarak hesaplanacak.`,
            timer: 2000,
            showConfirmButton: false
        });
    } catch (error) {
        console.error(error);
        Swal.fire("Hata", "Ayar kaydedilemedi.", "error");
    }
}

    const addVillageForm = document.getElementById("addVillageForm");
    if(addVillageForm) {
        addVillageForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("newVillageInput");
            const yeniBolge = input.value.trim();
            if(!yeniBolge) return;
            if(Array.isArray(villageList) && villageList.includes(yeniBolge)) {
                Swal.fire("Uyarı", "Bu bölge zaten ekli!", "warning");
                return;
            }
            try {
                await updateDoc(doc(db, "cooperatives", currentCoopId), { villages: arrayUnion(yeniBolge) });
                input.value = "";
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Eklendi', timer: 1000, showConfirmButton: false });
            } catch (error) { console.error(error); }
        });
    }

    window.bolgeSil = async function(ad) {
        const res = await Swal.fire({ title: 'Silinsin mi?', text: `"${ad}" silinecek.`, icon: 'warning', showCancelButton: true, confirmButtonText: 'Sil' });
        if(res.isConfirmed) await updateDoc(doc(db, "cooperatives", currentCoopId), { villages: arrayRemove(ad) });
    }

    window.bolgeDuzenle = async function(eskiAd) {
        const { value: yeniAd } = await Swal.fire({ title: 'Düzenle', input: 'text', inputValue: eskiAd, showCancelButton: true });
        if (yeniAd && yeniAd !== eskiAd) {
            const ref = doc(db, "cooperatives", currentCoopId);
            await updateDoc(ref, { villages: arrayRemove(eskiAd) });
            await updateDoc(ref, { villages: arrayUnion(yeniAd) });
        }
    }


    // Menü geçiş fonksiyonunu (switchTab) bul ve içine şu 'else if' bloğunu ekle:
    // Mevcut kodunuzda "if(tabId==='milk-management')" satırının altına ekleyin.
    /*
       // --- DASHBOARD KISMI ---
        if(tabId === 'reports') {
            t = "Dashboard & Analiz"; 
            
            // Tarih filtreleri boşsa otomatik son 1 ayı doldur
            if(!document.getElementById("reportStartDate").value) {
                const bugun = new Date();
                const birAyOnce = new Date();
                birAyOnce.setDate(bugun.getDate() - 30);
                document.getElementById("reportEndDate").valueAsDate = bugun;
                document.getElementById("reportStartDate").valueAsDate = birAyOnce;
            }
            // Verileri getir (Fonksiyon tanımlıysa)
            if(typeof raporlariGetir === 'function') raporlariGetir();
        }
    */
    // (Yukarıdaki kısmı switchTab fonksiyonuna entegre etmeyi unutmayın, aşağıda tam halini vereceğim)


    // --- RAPORLARI GETİR FONKSİYONU ---
    window.raporlariGetir = async function() {
        const startVal = document.getElementById("reportStartDate").value;
        const endVal = document.getElementById("reportEndDate").value;

        if(!startVal || !endVal) { Swal.fire("Uyarı","Lütfen tarih aralığı seçiniz.","warning"); return; }

        const startDate = new Date(startVal);
        startDate.setHours(0,0,0,0);
        
        const endDate = new Date(endVal);
        endDate.setHours(23,59,59,999);

        Swal.fire({title: 'Analiz Ediliyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

        try {
            // Süt Kayıtlarını Çek
            const q = query(
                collection(db, "milk_records"),
                where("coopId", "==", currentCoopId),
                where("date", ">=", startDate),
                where("date", "<=", endDate),
                orderBy("date", "asc")
            );

            const snapshot = await getDocs(q);
            
            // --- VERİ İŞLEME ---
            let totalLiters = 0;
            let daysMap = {};    // Günlük toplamlar: {'01.12': 500, '02.12': 600}
            let villageMap = {}; // Üyenin köyüne göre toplamlar

            // Köy bilgisini bulmak için üyeleri ID ile eşleştirelim
            // (allMembers dizisi zaten hafızada var)
            
            snapshot.forEach(doc => {
                const d = doc.data();
                const miktar = Number(d.liters);
                totalLiters += miktar;

                // 1. Günlük Gruplama
                const dateKey = d.date.toDate().toLocaleDateString('tr-TR', {day:'2-digit', month:'2-digit'});
                if(!daysMap[dateKey]) daysMap[dateKey] = 0;
                daysMap[dateKey] += miktar;

                // 2. Bölgesel Gruplama
                // Üyenin köyünü bul
                const member = allMembers.find(m => m.id === d.memberId);
                const koyAdi = member ? member.koy : "Bilinmeyen";
                
                if(!villageMap[koyAdi]) villageMap[koyAdi] = 0;
                villageMap[koyAdi] += miktar;
            });

            // --- KARTLARI DOLDUR ---
            document.getElementById("repTotalMilk").innerText = totalLiters.toLocaleString('tr-TR') + " Lt";
            
            // Gün Sayısı
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1; 
            const avg = (totalLiters / diffDays).toFixed(0);
            document.getElementById("repAvgMilk").innerText = avg + " Lt";

            // En İyi Köy
            let bestVillage = "-";
            let maxV = 0;
            for (const [k, v] of Object.entries(villageMap)) {
                if(v > maxV) { maxV = v; bestVillage = k; }
            }
            document.getElementById("repBestVillage").innerText = bestVillage;


            // --- GRAFİKLERİ ÇİZ ---
            grafikleriCiz(daysMap, villageMap);

            Swal.close();

        } catch (error) {
            console.error(error);
            Swal.fire("Hata", "Rapor oluşturulamadı: "+error.message, "error");
        }
    }
// --- ŞOFÖR EKLEME FONKSİYONLARI ---

    // 1. Modalı Aç
    window.soforEkleModalAc = function() {
        document.getElementById("addDriverForm").reset();
        const modalEl = document.getElementById('addDriverModal');
        if(modalEl) {
            document.body.appendChild(modalEl); // Pencereyi en üste taşı
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
        }
    }
 // --- YENİ EKLENECEK KOD ---
    const driverForm = document.getElementById("addDriverForm");
    
    if(driverForm) {
        driverForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const ad = document.getElementById("soforAd").value;
            const mail = document.getElementById("soforEmail").value;
            const pass = document.getElementById("soforPass").value;
            const secilenRol = document.getElementById("soforRol").value;

            if(pass.length < 6) {
                Swal.fire("Hata", "Şifre en az 6 karakter olmalı.", "warning");
                return;
            }

            const confirm = await Swal.fire({
                title: 'Personel Eklensin mi?',
                html: `<b>${ad}</b> kişisi <b>${secilenRol.toUpperCase()}</b> yetkisiyle eklenecek.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Evet, Ekle',
                confirmButtonColor: '#000'
            });

            if (!confirm.isConfirmed) return;

            Swal.fire({title: 'İşleniyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

            let secondaryApp = null;

            try {
                // 1. Config Tanımla
                const appConfig = {
                    apiKey: "AIzaSyAMTYZGCkVv1QausRJSyutrSUUvJ0mkqD4", 
                    authDomain: "koopplatform-dd9f8.firebaseapp.com",
                    projectId: "koopplatform-dd9f8"
                };

                // 2. İkincil Uygulamayı Başlat (DÜZELTİLEN KISIM: initializeAppNew)
                secondaryApp = initializeAppNew(appConfig, "SecondaryStaffAuth"); 
                const secondaryAuth = getAuthNew(secondaryApp); 

                // 3. Kullanıcıyı Oluştur
                const userCredential = await createUserWithEmailAndPassword(secondaryAuth, mail, pass);
                const user = userCredential.user;

                // 4. Veritabanına Yaz (Seçilen ROL ve CoopID ile)
                await setDoc(doc(db, "users", user.uid), {
                    email: mail,
                    adSoyad: ad,
                    rol: secilenRol, 
                    coopId: currentCoopId, 
                    kurumID: currentCoopId, // Garanti olsun
                    kayitTarihi: new Date()
                });

                // 5. Temizlik (Oturumu Kapat ve Uygulamayı Sil)
                await signOut(secondaryAuth);
                if(secondaryApp) await deleteApp(secondaryApp);

                // Modalı kapat
                const modalEl = document.getElementById('addDriverModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if(modal) modal.hide();
                driverForm.reset();

                await Swal.fire({
                    icon: 'success',
                    title: 'Başarılı!',
                    text: `${ad} başarıyla ${secilenRol} olarak tanımlandı.`,
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Listeyi Yenile
                if(typeof yetkilileriGetir === 'function') yetkilileriGetir();

            } catch (error) {
                console.error(error);
                let msg = error.message;
                if(error.code === 'auth/email-already-in-use') msg = "Bu e-posta adresi zaten kullanılıyor.";
                Swal.fire("Hata", msg, "error");
                
                // Hata durumunda da temizlik yap
                if(secondaryApp) await deleteApp(secondaryApp);
            }
        });
    }
    function grafikleriCiz(daysMap, villageMap) {
        // 1. Çizgi Grafik (Trend)
        const ctxTrend = document.getElementById('milkTrendChart').getContext('2d');
        
        // Eskiyi sil
        if(trendChart) trendChart.destroy();

        trendChart = new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: Object.keys(daysMap),
                datasets: [{
                    label: 'Günlük Toplanan Süt (Lt)',
                    data: Object.values(daysMap),
                    borderColor: '#0f766e',
                    backgroundColor: 'rgba(15, 118, 110, 0.1)',
                    borderWidth: 2,
                    tension: 0.3, // Eğrisel çizgiler
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } }
            }
        });

        // 2. Pasta Grafik (Bölgeler)
        const ctxPie = document.getElementById('villagePieChart').getContext('2d');
        
        if(pieChart) pieChart.destroy();

        pieChart = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: Object.keys(villageMap),
                datasets: [{
                    data: Object.values(villageMap),
                    backgroundColor: [
                        '#0e7490', '#0f766e', '#15803d', '#f59e0b', '#dc2626', '#7e22ce'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // --- 1. ÜYE KAYDETME / GÜNCELLEME İŞLEMİ ---
    const memberForm = document.getElementById("addMemberForm");
    if(memberForm) {
        memberForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            // Mail inputunu güvenli alalım
            const emailInput = document.getElementById("uyeEmail");
            const emailDegeri = emailInput ? emailInput.value.trim() : "";

            const veri = {
                sira: Number(document.getElementById("uyeSira").value),
                ad: document.getElementById("uyeAd").value.trim(),
                soyad: document.getElementById("uyeSoyad").value.trim(),
                tc: document.getElementById("uyeTc").value.trim(),
                koy: document.getElementById("uyeKoy").value,
                telefon: document.getElementById("uyeTel").value.trim(),
                
                // 👇 YENİ EKLENEN MAİL ALANI 👇
                kurtarmaEmail: emailDegeri,
                // -----------------------------

                iban: document.getElementById("uyeIban").value.trim(),
                
                // Checkbox Kontrolleri (Hata almamak için güvenli erişim)
                isBorsaRegistered: document.getElementById("uyeBorsaTescil") ? document.getElementById("uyeBorsaTescil").checked : false, 
                hasBagkurExemption: document.getElementById("uyeBagkurMuaf") ? document.getElementById("uyeBagkurMuaf").checked : false, 

                coopId: currentCoopId,
                tip: activeTab === 'members' ? 'producer' : 'other', // Eğer tab değişkenin varsa
                ...(duzenlenecekId ? {} : { kayitTarihi: new Date(), guncelBakiye: 0 }) 
            };

            try {
                if (duzenlenecekId) {
                    // Güncelleme Modu
                    await updateDoc(doc(db, "members", duzenlenecekId), veri);
                    Swal.fire({ icon: 'success', title: 'Güncellendi', timer: 1000, showConfirmButton: false });
                } else {
                    // Yeni Ekleme Modu
                    await addDoc(collection(db, "members"), veri);
                    Swal.fire({ icon: 'success', title: 'Eklendi', timer: 1000, showConfirmButton: false });
                }
                
                // İşlem bitince yapılacaklar
                if(typeof uyeleriGetir === 'function') uyeleriGetir();
                
                const modalEl = document.getElementById('addMemberModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if(modal) modal.hide();
                
                // Formu temizle
                memberForm.reset(); 
                duzenlenecekId = null; // ID'yi sıfırla ki sonraki işlem "Yeni Kayıt" olsun

            } catch (error) {
                console.error("Kayıt Hatası:", error);
                Swal.fire("Hata", error.message, "error");
            }
        });
    }
    // --- 2. DÜZENLEME PENCERESİNİ AÇMA FONKSİYONU ---
    window.duzenleModalAc = function(id) {
        duzenlenecekId = id; // Global ID'yi güncelle

        // tumUyeler dizisinden veriyi bul (Senin sisteminde veriler bu dizide duruyor varsayıyoruz)
        const data = tumUyeler.find(u => u.id === id);
        
        if (!data) {
            console.error("Üye verisi bulunamadı!");
            return;
        }

        // Modal Başlığını Değiştir
        const modalTitle = document.getElementById("addMemberModalLabel");
        if(modalTitle) modalTitle.innerText = "Üye Düzenle";

        // --- VERİLERİ KUTULARA DOLDUR ---
        // (Her elemanı kontrol ederek dolduruyoruz, hata vermemesi için)
        if(document.getElementById("uyeSira")) document.getElementById("uyeSira").value = data.siraNo || "";
        if(document.getElementById("uyeAd")) document.getElementById("uyeAd").value = data.ad || "";
        if(document.getElementById("uyeSoyad")) document.getElementById("uyeSoyad").value = data.soyad || "";
        if(document.getElementById("uyeTc")) document.getElementById("uyeTc").value = data.tc || "";
        if(document.getElementById("uyeTel")) document.getElementById("uyeTel").value = data.telefon || "";
        if(document.getElementById("uyeKoy")) document.getElementById("uyeKoy").value = data.koy || data.bolge || "";
        if(document.getElementById("uyeIban")) document.getElementById("uyeIban").value = data.iban || "";
        
        // 👇 MAİL ALANI (Eksik olan buydu) 👇
        if(document.getElementById("uyeEmail")) {
            document.getElementById("uyeEmail").value = data.kurtarmaEmail || "";
        }
        // ----------------------------------

        // Checkboxlar
        if(document.getElementById("uyeBorsaTescil")) document.getElementById("uyeBorsaTescil").checked = data.isBorsaRegistered || false;
        if(document.getElementById("uyeBagkurMuaf")) document.getElementById("uyeBagkurMuaf").checked = data.hasBagkurExemption || false;

        // Modalı Aç
        const modalEl = document.getElementById('addMemberModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }
 // Modalı Açarken Listeyi Hazırla ve Tab'ı Sıfırla
window.yeniUyeModalAc = function() {
    formuTemizle(); 
    document.getElementById("kesintiListesiContainer").innerHTML = ""; 
    
    // Varsayılan Kesintileri Yükle
    varsayilanKesintiler.forEach(k => {
        yeniKesintiSatiriEkle(k);
    });

    // --- YENİ EKLENEN KISIM: Tab'ı Sıfırla (Her açılışta Genel Bilgiler gelsin) ---
    const triggerFirstTab = document.querySelector('#memberTabs button[data-bs-target="#tab-genel"]');
    if(triggerFirstTab) {
        bootstrap.Tab.getOrCreateInstance(triggerFirstTab).show();
    }
    // -----------------------------------------------------------------------------

    const modalEl = document.getElementById('addMemberModal');
    document.body.appendChild(modalEl);
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
}

    
  
    function formuTemizle() {
        document.getElementById("addMemberForm").reset();
        duzenlenecekId = null;
        document.getElementById("lblModalTitle").innerText = "Yeni Kayıt Oluştur";
    }

    window.uyeSil = async function(id) { 
        if((await Swal.fire({title:'Silinsin mi?',icon:'warning',showCancelButton:true})).isConfirmed) await deleteDoc(doc(db,"members",id)); 
    }
    uyeleriGetir();
    document.getElementById("logoutBtn").addEventListener("click", async()=>{ 
        await signOut(auth); window.location.href="../giris.html"; 
    });
// --- DÜZELTİLMİŞ MENÜ GEÇİŞ FONKSİYONU ---
window.switchTab = function(tabId, el) { 
    // 1. TÜM SAYFALARI GİZLE VE KİLİTLERİ TEMİZLE
    document.querySelectorAll('.content-section').forEach(e => {
        e.classList.add('hidden-section'); // CSS ile gizle
        e.style.display = ''; // ÖNEMLİ: "Listeye Dön"den kalan inline 'none' stilini temizle!
    });
    
    // 2. DETAY SAYFASINI KAPAT (Eğer açıksa)
    const detailPage = document.getElementById('account-detail-page');
    if(detailPage) {
        detailPage.classList.remove('active-fullscreen');
        detailPage.style.display = 'none';
    }

    // 3. SEÇİLEN SAYFAYI AÇ
    const targetPage = document.getElementById(tabId);
    if(targetPage) {
        targetPage.classList.remove('hidden-section');
        // Eğer bir şekilde display:none kaldıysa onu da temizle
        targetPage.style.display = ''; 
    } else {
        console.error("Hata: Sayfa bulunamadı ->", tabId);
        return;
    }
    
    // 4. MENÜDEKİ AKTİFLİĞİ GÜNCELLE
    document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
    if(el) el.classList.add('active');
    
    // 5. HEADER'I GARANTİ GÖSTER (Detay sayfasından dönerken gizli kalmasın)
    const header = document.querySelector('.admin-header');
    if(header) header.style.display = '';

    // 6. BAŞLIKLARI VE İÇERİKLERİ AYARLA
    let t = "Genel Durum";
    
    if(tabId === 'members') t = (typeof window.firmaTuru !== 'undefined' && window.firmaTuru === 'sahis') ? "Cari İşlemleri" : "Üye İşlemleri";
    if(tabId === 'stocks') t = "Stok Yönetimi";
    if(tabId === 'settings') t = "Ayarlar";
    
    if(tabId === 'milk-management') {
        t = "Süt Toplama & Hesaplama";
        if(typeof sutListesiniGetir === 'function') sutListesiniGetir(); 
    }

    // Raporlar sekmesi kontrolleri
    if(tabId === 'advanced-reports') {
        t = "Rapor Merkezi"; 
        document.querySelectorAll(".sub-report").forEach(el => el.classList.add("d-none"));
        const mainMenu = document.getElementById("reports-main-menu");
        if(mainMenu) mainMenu.classList.remove("d-none");
    }
// Bu satırları ekle
    if(tabId === 'orders') {
        t = "Sipariş Yönetimi";
        if(typeof siparisleriGetir === 'function') siparisleriGetir();
    }
    if(tabId === 'reports') {
        t = "Dashboard & Analiz"; 
        // Tarih filtreleri boşsa otomatik doldur
        const startInput = document.getElementById("reportStartDate");
        if(startInput && !startInput.value) {
            const bugun = new Date();
            const birAyOnce = new Date();
            birAyOnce.setDate(bugun.getDate() - 30);
            if(document.getElementById("reportEndDate")) document.getElementById("reportEndDate").valueAsDate = bugun;
            startInput.valueAsDate = birAyOnce;
        }
        if(typeof raporlariGetir === 'function') raporlariGetir();
    }

    const titleEl = document.getElementById('page-title');
    if(titleEl) titleEl.innerText = t;
    
    // Mobil menü açıksa kapat
    if(typeof closeSidebar === 'function') closeSidebar();
}

    
// --- RAPOR MERKEZİ FONKSİYONLARI ---

    // Menüden alt rapora geçiş
    window.openReport = function(divId) {
        document.getElementById("reports-main-menu").classList.add("d-none"); // Kartları gizle
        document.querySelectorAll(".sub-report").forEach(el => el.classList.add("d-none")); // Diğerlerini gizle
        
        const target = document.getElementById(divId);
        if(target) {
            target.classList.remove("d-none"); // Hedefi aç
            
            // Tarihleri otomatik doldur (Son 30 gün)
            if(!document.getElementById("repDateStart").value) {
                const bugun = new Date();
                const birAyOnce = new Date();
                birAyOnce.setDate(bugun.getDate() - 30);
                document.getElementById("repDateEnd").valueAsDate = bugun;
                document.getElementById("repDateStart").valueAsDate = birAyOnce;
            }

            // Süt raporuysa üye listesini doldur
            if(divId === 'rep-milk-member') {
                raporUyeListesiDoldur();
            }
        }
    }

    // Alt rapordan menüye dönüş
    window.closeReport = function() {
        document.querySelectorAll(".sub-report").forEach(el => el.classList.add("d-none"));
        document.getElementById("reports-main-menu").classList.remove("d-none");
    }

    // Üye Selectbox Doldurma
    function raporUyeListesiDoldur() {
        const select = document.getElementById("repFilterMember");
        if(select.options.length > 1) return; // Zaten doluysa elleme
        
        // Alfabetik sırala
        const siraliUyeler = [...allMembers].sort((a,b) => a.ad.localeCompare(b.ad));
        
        siraliUyeler.forEach(m => {
            const opt = document.createElement("option");
            opt.value = m.id;
            opt.text = `${m.ad} ${m.soyad} (${m.koy})`;
            select.appendChild(opt);
        });
    }

    // Raporu Çek ve Tabloya Bas
    window.musteriSutRaporuGetir = async function() {
        const memId = document.getElementById("repFilterMember").value;
        const sDate = document.getElementById("repDateStart").value;
        const eDate = document.getElementById("repDateEnd").value;

        if(!sDate || !eDate) { Swal.fire("Uyarı", "Tarih aralığı seçiniz.", "warning"); return; }

        const startDate = new Date(sDate); startDate.setHours(0,0,0,0);
        const endDate = new Date(eDate); endDate.setHours(23,59,59,999);

        Swal.showLoading();

        try {
            // Firebase Sorgusu
            const q = query(
                collection(db, "milk_records"),
                where("coopId", "==", currentCoopId),
                where("date", ">=", startDate),
                where("date", "<=", endDate),
                orderBy("date", "desc")
            );

            const snapshot = await getDocs(q);
            const tbody = document.getElementById("repMilkTableBody");
            tbody.innerHTML = "";
            
            let total = 0;
            let count = 0;

            snapshot.forEach(doc => {
                const d = doc.data();
                
                // JS tarafında üye filtresi (Index hatası almamak için)
                if(memId && d.memberId !== memId) return;

                total += Number(d.liters);
                count++;

                const dateStr = d.date.toDate().toLocaleDateString('tr-TR');
                const donem = d.period === 'sabah' 
                    ? '<span class="badge bg-warning text-dark"><i class="fa-solid fa-sun me-1"></i>Sabah</span>' 
                    : '<span class="badge bg-primary"><i class="fa-solid fa-moon me-1"></i>Akşam</span>';

                tbody.innerHTML += `
                    <tr>
                        <td class="ps-4 fw-bold text-secondary">${dateStr}</td>
                        <td>${d.memberName}</td>
                        <td class="text-center">${donem}</td>
                        <td class="text-end pe-4 fw-bold fs-6">${d.liters} Lt</td>
                    </tr>
                `;
            });

            if(count === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center p-5 text-muted fw-bold">Bu kriterlere uygun kayıt bulunamadı.</td></tr>';
            }
            
            document.getElementById("repMilkTotal").innerText = total.toLocaleString('tr-TR') + " Lt";
            Swal.close();

        } catch (error) {
            console.error(error);
            Swal.fire("Hata", "Veri çekilemedi: " + error.message, "error");
        }
    }
    window.openSubSetting = function(id) {
        document.getElementById('settings-main-menu').classList.add('d-none');
        document.getElementById(id).classList.remove('d-none');
    }
    window.closeSubSetting = function() {
        document.querySelectorAll('.sub-setting-page').forEach(el => el.classList.add('d-none'));
        document.getElementById('settings-main-menu').classList.remove('d-none');
    }
    
function tabloyuCiz(data) {
    const tbody = document.getElementById("memberTableBody");
    const mobileList = document.getElementById("mobileMemberList");
    
    if(tbody) tbody.innerHTML = "";
    if(mobileList) mobileList.innerHTML = "";
    
    const masterCheck = document.getElementById("selectAllMembers");
    if(masterCheck) masterCheck.checked = false;
    secimKontrol();

    if (data.length === 0) {
        if(tbody) tbody.innerHTML = "<tr><td colspan='8' class='text-center text-muted py-5'>Kayıt bulunamadı.</td></tr>";
        if(mobileList) mobileList.innerHTML = "<div class='text-center p-5 text-muted'>Kayıt bulunamadı.</div>";
        return;
    }

    data.forEach(uye => {
        // --- A) MASAÜSTÜ (ESKİ KODUNUZUN AYNISI - DETAYLAR KORUNDU) ---
        if(tbody) {
            let tipBadge = uye.tip === 'tedarikci' 
                ? '<span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 rounded-pill px-3">TEDARİKÇİ</span>'
                : '<span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 rounded-pill px-3">MÜŞTERİ</span>';

            const tr = document.createElement("tr");
            tr.className = "member-row align-middle border-bottom hover-shadow transition-all";
            tr.innerHTML = `
                <td class="text-center"><input type="checkbox" class="form-check-input member-checkbox" value="${uye.id}" onclick="secimKontrol()"></td>
                <td class="text-center">
                    <div class="d-flex align-items-center justify-content-center mx-auto text-white fw-bold rounded-circle shadow-sm" style="width: 35px; height: 35px; font-size: 0.9rem; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);">
                        ${uye.sira || '-'}
                    </div>
                </td>
                <td><div class="fw-bold text-dark fs-6">${uye.ad} ${uye.soyad}</div></td>
                <td><span class="font-monospace text-secondary fw-bold" style="font-size: 0.9rem;">${uye.tc || '-'}</span></td>
                <td class="text-center">${tipBadge}</td>
                <td><span class="text-dark fw-medium">${uye.koy}</span></td>
                <td><span class="text-muted small fw-bold">${uye.telefon || ''}</span></td>
                <td class="text-end pe-3">
                    <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-sm btn-light text-warning border" onclick="uyeGirisYetkisiVer('${uye.id}', '${uye.telefon}', '${uye.ad} ${uye.soyad}', '${uye.coopId}')"><i class="fa-solid fa-key"></i></button>
                        <button class="btn btn-sm btn-light text-primary border" onclick="hesapAc('${uye.id}')"><i class="fa-solid fa-chevron-right"></i></button>
                        <button class="btn btn-sm btn-light text-secondary border" onclick="uyeDuzenle('${uye.id}')"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button class="btn btn-sm btn-light text-danger border" onclick="uyeSil('${uye.id}')"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </td>`;
            tbody.appendChild(tr);
        }

        // --- B) MOBİL (DİNAMİK REHBER TASARIMI - BAKİYE YOK) ---
        if(mobileList) {
            const initial = (uye.ad[0] + uye.soyad[0]).toUpperCase();
            const card = `
            <div class="mobile-member-item">
                <div class="mobile-avatar">${initial}</div>
                <div class="mobile-info">
                    <div class="mobile-name">${uye.ad} ${uye.soyad}</div>
                    <div class="mobile-location"><i class="fa-solid fa-location-dot me-1 text-danger opacity-50"></i>${uye.koy}</div>
                </div>
                <div class="d-flex gap-1">
                    <button class="btn-mobile-action bg-warning bg-opacity-10 text-warning" onclick="uyeGirisYetkisiVer('${uye.id}', '${uye.telefon}', '${uye.ad} ${uye.soyad}', '${uye.coopId}')"><i class="fa-solid fa-key"></i></button>
                    <button class="btn-mobile-action bg-primary bg-opacity-10 text-primary" onclick="hesapAc('${uye.id}')"><i class="fa-solid fa-chevron-right"></i></button>
                    <button class="btn-mobile-action bg-secondary bg-opacity-10 text-secondary" onclick="uyeDuzenle('${uye.id}')"><i class="fa-solid fa-pen"></i></button>
                </div>
            </div>`;
            mobileList.insertAdjacentHTML('beforeend', card);
        }
    });
    
    const recCount = document.getElementById("recordCount");
    if(recCount) recCount.innerText = `${data.length} kayıt listelendi`;
}


    window.sutHesaplamaModalAc = function() {
        console.log("1. Fonksiyon tetiklendi.");

        // 1. Modalı HTML içinde bul
        const modalEl = document.getElementById('sutHesaplaModal');
        if(!modalEl) {
            alert("HATA: 'sutHesaplaModal' kimlikli pencere HTML'de bulunamadı!");
            return;
        }

        // 2. Tarihleri Ayarla (Son 7 gün)
        try {
            const bugun = new Date();
            const yediGunOnce = new Date();
            yediGunOnce.setDate(bugun.getDate() - 7);

            const dateStart = document.getElementById("calcStartDate");
            const dateEnd = document.getElementById("calcEndDate");
            
            if(dateStart && dateEnd) {
                dateEnd.valueAsDate = bugun;
                dateStart.valueAsDate = yediGunOnce;
            }
            
            // Fiyatı Temizle
            if(document.getElementById("calcPrice")) {
                document.getElementById("calcPrice").value = "";
            }

            // Açıklamayı Güncelle (Varsa fonksiyonu çalıştır)
            if(typeof otomatikAciklamaGuncelle === 'function') {
                otomatikAciklamaGuncelle();
            }
        } catch(e) {
            console.error("Tarih ayarlama hatası:", e);
        }

        // 3. Modalı Güvenli Şekilde Aç (Bootstrap 5)
        // 'new bootstrap.Modal' yerine 'getOrCreateInstance' kullanıyoruz ki çakışma olmasın.
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
        
        console.log("2. Modal aç komutu gönderildi.");
    }

    // Tarih değişince açıklamayı güncelle
    document.getElementById("calcStartDate").addEventListener("change", otomatikAciklamaGuncelle);
    document.getElementById("calcEndDate").addEventListener("change", otomatikAciklamaGuncelle);

    function otomatikAciklamaGuncelle() {
        const s = document.getElementById("calcStartDate").value;
        const e = document.getElementById("calcEndDate").value;
        if(s && e) {
            // Tarih formatını güzelleştir (YYYY-MM-DD -> DD.MM)
            const sFormat = s.split("-").reverse().slice(0,2).join(".");
            const eFormat = e.split("-").reverse().slice(0,2).join(".");
            document.getElementById("calcDesc").value = `${sFormat} - ${eFormat} Tarihli Süt Bedeli`;
        }
    }
 document.getElementById("sutHesapForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const startVal = document.getElementById("calcStartDate").value;
    const endVal = document.getElementById("calcEndDate").value;
    const price = Number(document.getElementById("calcPrice").value);
    
    // YENİ: Benzersiz İşlem Kimliği (Örn: BATCH_1707555123)
    const batchId = "BATCH_" + Date.now(); 

    if (price <= 0) { Swal.fire("Hata", "Lütfen fiyat girin.", "warning"); return; }

    // ... (Onay pencereleri aynı kalabilir) ...
    
    Swal.fire({title: 'Hesaplanıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

    try {
        const startDate = new Date(startVal); startDate.setHours(0, 0, 0, 0);
        const endDate = new Date(endVal); endDate.setHours(23, 59, 59, 999);
        const islemTarihi = new Date(endVal); // İşlem tarihi bitiş günü olsun

        const batch = writeBatch(db);
        
        // SADECE İŞLENMEMİŞ KAYITLARI ÇEK
        const q = query(
            collection(db, "milk_records"),
            where("coopId", "==", currentCoopId),
            where("date", ">=", startDate),
            where("date", "<=", endDate)
        );

        const snapshot = await getDocs(q);
        let memberData = {};
        let islenenSayisi = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            // ZATEN İŞLENMİŞSE ATLA (ÇAKIŞMAYI ÖNLER)
            if (data.isProcessed === true) return;

            if (!memberData[data.memberId]) memberData[data.memberId] = { sabah: 0, aksam: 0, docs: [] };
            
            const miktar = Number(data.liters);
            if(data.period === 'sabah') memberData[data.memberId].sabah += miktar;
            else memberData[data.memberId].aksam += miktar;
            
            memberData[data.memberId].docs.push(doc.id);
            islenenSayisi++;
        });

        if (islenenSayisi === 0) {
            Swal.fire("Bilgi", "Seçilen tarihlerde hesaplanacak yeni süt bulunamadı.", "info");
            return;
        }

        for (const [memId, val] of Object.entries(memberData)) {
            const toplamTutar = (val.sabah + val.aksam) * price;
            if(toplamTutar <= 0) continue;

            // Cari Hareketi Oluştur
            const transRef = doc(collection(db, "transactions"));
            batch.set(transRef, {
                memberId: memId,
                coopId: currentCoopId,
                type: 'alacak',
                category: 'Süt Bedeli',
                description: `Süt Bedeli (${startVal} - ${endVal})`,
                amount: toplamTutar,
                date: islemTarihi,
                batchId: batchId, // <--- KRİTİK: İşlem Kimliği Eklendi
                createdAt: new Date()
            });
                const uyeRef = doc(db, "members", memId);
                batch.update(uyeRef, { 
                    guncelBakiye: increment(-toplamTutar) 
                });
            // Süt Kayıtlarını Kilitle ve Kimliği Bas
            val.docs.forEach(docId => {
                const milkRef = doc(db, "milk_records", docId);
                batch.update(milkRef, { 
                    isProcessed: true,
                    processedBatchId: batchId // <--- KRİTİK: Hangi işlemle kilitlendiği
                });
            });
        }

        await batch.commit();
        bootstrap.Modal.getInstance(document.getElementById('sutHesaplaModal')).hide();
        
        // --- EKLENEN KISIM BAŞLANGIÇ ---
        // Tabloyu hemen yenile (Filtreler korunarak)
        if(typeof sutListesiniGetir === 'function') {
            sutListesiniGetir(true); 
        }
        // --- EKLENEN KISIM BİTİŞ ---

        Swal.fire("Başarılı", `${islenenSayisi} adet süt hesaplandı.`, "success");

    } catch (error) {
        console.error(error);
        Swal.fire("Hata", error.message, "error");
    }
});
// --- DUYURU YÖNETİMİ SCRİPTLERİ ---

    // 1. YENİ DUYURU KAYDET
    const annForm = document.getElementById("announcementForm");
    if(annForm) {
        annForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const baslik = document.getElementById("annBaslik").value;
            const icerik = document.getElementById("annIcerik").value;
            const onem = document.getElementById("annOnem").value;

            Swal.fire({title: 'Yayınlanıyor...', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});

            try {
                await addDoc(collection(db, "announcements"), {
                    coopId: currentCoopId, // Sadece bu kooperatife özel
                    baslik: baslik,
                    icerik: icerik,
                    onem: onem,
                    tarih: new Date()
                });

                document.getElementById("announcementForm").reset();
                
                const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
                Toast.fire({icon: 'success', title: 'Duyuru Yayınlandı'});

            } catch (error) {
                console.error(error);
                Swal.fire("Hata", error.message, "error");
            }
        });
    }
// admin.html İÇİNDEKİ MEVCUT FONKSİYONLA DEĞİŞTİR
    window.adminDuyurulariGetir = function() {
        const listDiv = document.getElementById("adminAnnList");
        if(!listDiv) return;

        if(!currentCoopId) return; 
        
        // Son 20 duyuruyu getir
        const q = query(
            collection(db, "announcements"), 
            where("coopId", "==", currentCoopId),
            orderBy("tarih", "desc"), 
            limit(20) 
        );

        onSnapshot(q, (snapshot) => {
            listDiv.innerHTML = "";
            
            if(snapshot.empty) {
                listDiv.innerHTML = '<div class="text-center py-5 text-muted">Henüz duyuru eklemediniz.</div>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const d = data.tarih ? data.tarih.toDate().toLocaleDateString('tr-TR') : '-';
                
                let badgeClass = "bg-primary";
                if(data.onem === 'yuksek') badgeClass = "bg-danger";
                if(data.onem === 'odeme') badgeClass = "bg-success";

                // Tırnak işaretleri sorunu olmasın diye güvenli hale getiriyoruz
                const safeBaslik = data.baslik.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                // İçerikteki satır atlamaları korunsun diye replace yapmıyoruz, pre-wrap halledecek.
                // Ancak düzenle butonuna parametre gönderirken tırnakları temizlemeliyiz:
                const safeIcerikParam = data.icerik.replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\n/g, "\\n");

                const item = `
                <div class="list-group-item p-3 border-bottom">
                    <div class="d-flex w-100 justify-content-between align-items-start gap-3">
                        <div style="flex: 1;"> 
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <span class="badge ${badgeClass} bg-opacity-75" style="font-weight:normal;">${d}</span>
                                <h6 class="mb-0 fw-bold text-dark">${data.baslik}</h6>
                            </div>
                            <div class="text-muted small text-break" style="white-space: pre-wrap; line-height: 1.5; font-family: inherit;">${data.icerik}</div>
                        </div>
                        
                        <div class="d-flex flex-column gap-2">
                             <button class="btn btn-sm btn-light text-primary border" 
                                onclick="duyuruDuzenle('${doc.id}', '${safeBaslik}', '${safeIcerikParam}', '${data.onem}')" 
                                title="Düzenle">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button class="btn btn-sm btn-light text-danger border" onclick="duyuruSil('${doc.id}')" title="Yayından Kaldır">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
                
                listDiv.innerHTML += item;
            });
        }, (error) => {
             console.error(error);
        });
    }
    // YENİ FONKSİYON: DUYURU DÜZENLEME
    window.duyuruDuzenle = async function(id, mevcutBaslik, mevcutIcerik, mevcutOnem) {
        
        const { value: formValues } = await Swal.fire({
            title: 'Duyuruyu Düzenle',
            html: `
                <div class="text-start">
                    <label class="small fw-bold text-muted mb-1">Başlık</label>
                    <input id="swal-d-baslik" class="form-control mb-3" value="${mevcutBaslik}">
                    
                    <label class="small fw-bold text-muted mb-1">İçerik</label>
                    <textarea id="swal-d-icerik" class="form-control mb-3" rows="6">${mevcutIcerik}</textarea>
                    
                    <label class="small fw-bold text-muted mb-1">Önem Derecesi</label>
                    <select id="swal-d-onem" class="form-select">
                        <option value="normal" ${mevcutOnem === 'normal' ? 'selected' : ''}>Normal (Mavi)</option>
                        <option value="yuksek" ${mevcutOnem === 'yuksek' ? 'selected' : ''}>Yüksek (Kırmızı)</option>
                        <option value="odeme" ${mevcutOnem === 'odeme' ? 'selected' : ''}>Ödeme (Yeşil)</option>
                    </select>
                </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Güncelle',
            confirmButtonColor: '#0f766e',
            cancelButtonText: 'İptal',
            preConfirm: () => {
                return {
                    baslik: document.getElementById('swal-d-baslik').value,
                    icerik: document.getElementById('swal-d-icerik').value,
                    onem: document.getElementById('swal-d-onem').value
                }
            }
        });

        if (formValues) {
            if(!formValues.baslik || !formValues.icerik) {
                Swal.fire("Uyarı", "Başlık ve içerik boş olamaz.", "warning");
                return;
            }

            try {
                // Firebase Güncelleme
                await updateDoc(doc(db, "announcements", id), {
                    baslik: formValues.baslik,
                    icerik: formValues.icerik,
                    onem: formValues.onem
                });

                const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
                Toast.fire({icon: 'success', title: 'Duyuru Güncellendi'});

            } catch (error) {
                console.error(error);
                Swal.fire("Hata", error.message, "error");
            }
        }
    }

    // 3. DUYURU SİL
    window.duyuruSil = async function(docId) {
        const res = await Swal.fire({
            title: 'Yayından Kaldır?',
            text: "Bu duyuru üyelerin ekranından silinecektir.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Evet, Sil',
            confirmButtonColor: '#d33',
            cancelButtonText: 'Vazgeç'
        });

        if(res.isConfirmed) {
            await deleteDoc(doc(db, "announcements", docId));
            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1000});
            Toast.fire({icon: 'success', title: 'Silindi'});
        }
    }
// --- 1. HESAP DETAYINI AÇAN FONKSİYON ---
window.hesapAc = async function(id) {
    console.log("Hesap Detayı Açılıyor: ", id);
    activeMemberId = id;

    // Detay sayfasını bul
    const detailPage = document.getElementById('account-detail-page');
    if (!detailPage) return;

    try {
        // DOM Düzeltmesi: Eğer kutu yanlış yerdeyse body'e taşı (Garanti olsun)
        if (detailPage.parentNode !== document.body) {
            document.body.appendChild(detailPage);
        }

        // 1. DİĞER İÇERİKLERİ GİZLEME (Sidebar HARİÇ)
        // Sadece orta alandaki içerikleri gizliyoruz
        document.querySelectorAll('.content-section').forEach(el => {
            el.classList.add('hidden-section');
            el.style.display = 'none';
        });

        // 2. ÜST HEADER'I GİZLE (Çünkü detay sayfasının kendi başlığı var)
        const header = document.querySelector('.admin-header');
        if(header) header.style.display = 'none';

        // 3. DETAY SAYFASINI GÖSTER
        detailPage.classList.remove('hidden-section');
        detailPage.classList.add('active-fullscreen'); // CSS'teki pozisyonu uygula
        detailPage.style.display = 'block';

        // 4. VERİLERİ DOLDUR
        const uye = allMembers.find(m => m.id === id);
        if (uye) {
            if(document.getElementById("detailName")) document.getElementById("detailName").innerText = `${uye.ad} ${uye.soyad}`;
            if(document.getElementById("detailPhone")) document.getElementById("detailPhone").innerText = `${uye.koy || ''} • ${uye.telefon || ''}`;
        }

        // Tabloyu yükle
        hareketleriDinle(id);
        
        // Sayfayı yukarı at
        window.scrollTo(0,0);

    } catch (e) {
        console.error("Hata:", e);
    }
}

// --- 2. LİSTEYE GERİ DÖNEN FONKSİYON ---
window.listeyeDon = function() {
    console.log("Listeye dönülüyor...");

    // 1. Detay Sayfasını Kapat
    const detailPage = document.getElementById('account-detail-page');
    if(detailPage) {
        detailPage.classList.remove('active-fullscreen');
        detailPage.style.display = 'none'; // Zorla gizle
    }

    // 2. Üst Header'ı Geri Getir
    const header = document.querySelector('.admin-header');
    if(header) header.style.display = ''; // Varsayılan görünüme dön

    // 3. Müşteri Listesini (Members) Aç
    const membersPage = document.getElementById('members');
    if(membersPage) {
        membersPage.classList.remove('hidden-section');
        membersPage.style.display = 'block';
    }

    // NOT: Sidebar'a dokunmadığımız için o hep orada kalacak.
    
    // Sayfa başlığını düzelt (Eğer bozulduysa)
    if(document.getElementById('page-title')) document.getElementById('page-title').innerText = "Cari İşlemleri";
}


// --- DÜZELTİLMİŞ VE RENKLENDİRİLMİŞ HAREKETLERİ DİNLEME ---
function hareketleriDinle(memId) {
    const tbody = document.getElementById("detailTableBody");
    if(!tbody) return;

    // Yükleniyor animasyonu koy (ARKA PLAN EKLENDİ: bg-light)
    tbody.innerHTML = '<tr><td colspan="7" class="text-center p-5 bg-light"><div class="spinner-border text-primary"></div><div class="mt-2 text-muted">Hareketler yükleniyor...</div></td></tr>';

    // Sorgu: Tarihe göre eskiden yeniye
    const q = query(
        collection(db, "transactions"), 
        where("memberId", "==", memId),
        orderBy("date", "asc") 
    );

    onSnapshot(q, (snapshot) => {
        // Tabloyu temizle
        tbody.innerHTML = "";

        if(snapshot.empty) {
            // Kayıt yok mesajı (ARKA PLAN EKLENDİ: bg-light)
            tbody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-muted opacity-50 bg-light"><i class="fa-solid fa-folder-open fa-2x mb-2"></i><br>Henüz işlem kaydı yok.</td></tr>';
            // Kartları Sıfırla
            document.getElementById("detailBorc").innerText = "0,00 ₺";
            document.getElementById("detailAlacak").innerText = "0,00 ₺";
            if(document.getElementById("detailBalance")) {
                document.getElementById("detailBalance").innerText = "0,00 ₺";
                document.getElementById("detailBalance").className = "fw-bold text-white";
            }
            return;
        }

        let kumuletifBakiye = 0; 
        let toplamBorc = 0;
        let toplamAlacak = 0;
        let satirlarListesi = []; 

        snapshot.forEach(doc => {
             const t = doc.data();
             const miktar = Number(t.amount) || 0; 
             const belgeNo = t.belgeNo || doc.id.substring(0,6).toUpperCase();
             
             // Tarih Kontrolü
             let tarihGorsel = '<span class="text-danger">Tarih Hatalı</span>';
             if(t.date && t.date.seconds) {
                 const dateObj = t.date.toDate();
                 const tarih = dateObj.toLocaleDateString('tr-TR');
                 const saat = dateObj.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
                 tarihGorsel = `<div>${tarih}</div><small class="text-muted fw-normal" style="font-size:0.75rem">${saat}</small>`;
             }
             
             let borcSutunu = "-";
             let alacakSutunu = "-";
             
             if (t.type === 'borc') {
                 kumuletifBakiye += miktar;
                 toplamBorc += miktar;
                 borcSutunu = `<span class="text-danger fw-bold">${miktar.toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺</span>`;
             } else {
                 kumuletifBakiye -= miktar;
                 toplamAlacak += miktar;
                 alacakSutunu = `<span class="text-success fw-bold">${miktar.toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺</span>`;
             }

             let bakiyeGorunum = "";
             let bakiyeClass = "";
             if (kumuletifBakiye > 0) {
                 bakiyeClass = "text-danger fw-bold";
                 bakiyeGorunum = `${kumuletifBakiye.toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺ (B)`;
             } else if (kumuletifBakiye < 0) {
                 bakiyeClass = "text-success fw-bold";
                 bakiyeGorunum = `${Math.abs(kumuletifBakiye).toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺ (A)`;
             } else {
                 bakiyeClass = "text-dark fw-bold";
                 bakiyeGorunum = "0,00 ₺";
             }

             let urunBilgisi = t.items ? `<span class="badge bg-secondary bg-opacity-10 text-secondary">${t.items.length} Kalem</span>` : `<span class="small text-muted">${t.category || 'Genel'}</span>`;

             let detayBtn = '';
             if(t.items && t.items.length > 0) {
                detayBtn = `<button class="btn btn-sm btn-light border text-primary me-1" title="İçeriği Gör" onclick="evrakDetayGoster('${doc.id}')"><i class="fa-solid fa-eye"></i></button>`;
             }

             const tr = `
                 <tr class="align-middle">
                     <td class="fw-bold text-secondary" style="line-height:1.2">${tarihGorsel}</td>
                     <td class="hide-mobile"><span class="badge bg-light text-secondary border">#${belgeNo}</span></td>
                     <td>
                         <div class="fw-bold text-dark text-break">${t.description || 'Açıklama Yok'}</div>
                         ${urunBilgisi}
                     </td>
                     <td class="text-end bg-light bg-opacity-25">${borcSutunu}</td>
                     <td class="text-end bg-light bg-opacity-25">${alacakSutunu}</td>
                     <td class="text-end bg-white" style="font-size:1rem;">
                         <span class="${bakiyeClass}">${bakiyeGorunum}</span>
                     </td>
                     <td class="text-end" style="min-width: 120px;">
                         ${detayBtn}
                         <button class="btn btn-sm btn-light border text-secondary me-1" onclick="islemDuzenle('${doc.id}')"><i class="fa-solid fa-pen"></i></button>
                         <button class="btn btn-sm btn-light border text-danger" onclick="islemSil('${doc.id}')"><i class="fa-solid fa-trash"></i></button>
                     </td>
                 </tr>
             `;
             satirlarListesi.push(tr);
        });

        tbody.innerHTML = satirlarListesi.reverse().join('');

        document.getElementById("detailBorc").innerText = toplamBorc.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
        document.getElementById("detailAlacak").innerText = toplamAlacak.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
        
        const headerBalance = document.getElementById("detailBalance");
        if(headerBalance) {
             if (kumuletifBakiye > 0) {
                headerBalance.innerHTML = `${kumuletifBakiye.toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺ <small class="fs-6 opacity-50">BORÇLU</small>`;
                headerBalance.className = "fw-bold text-white"; 
             } else if (kumuletifBakiye < 0) {
                headerBalance.innerHTML = `${Math.abs(kumuletifBakiye).toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺ <small class="fs-6 opacity-50">ALACAKLI</small>`;
                headerBalance.className = "fw-bold text-white";
             } else {
                headerBalance.innerText = "0,00 ₺";
                headerBalance.className = "fw-bold text-white";
             }
        }
    }, (error) => {
        console.error("Veri çekme hatası:", error);
        // Hata mesajı alanı (ARKA PLAN EKLENDİ: bg-light)
        let errorMsg = `<tr><td colspan="7" class="text-center text-danger p-5 bg-light">Hata: ${error.message}</td></tr>`;
        if (error.code === 'failed-precondition') {
            errorMsg = `<tr><td colspan="7" class="text-center text-danger p-5 bg-light"><b>Firebase İndeks Hatası!</b><br>Lütfen konsolu (F12) açıp linke tıklayarak indeksi oluşturun.</td></tr>`;
        }
        tbody.innerHTML = errorMsg;
    });
}

// Yardımcı Fonksiyon: Kartları Güncelle
function guncelleBakiyeKartlari(borc, alacak, bakiye) {
    if(document.getElementById("detailBorc")) document.getElementById("detailBorc").innerText = borc.toLocaleString('tr-TR') + " ₺";
    if(document.getElementById("detailAlacak")) document.getElementById("detailAlacak").innerText = alacak.toLocaleString('tr-TR') + " ₺";
    
    const balEl = document.getElementById("detailBalance");
    if(balEl) {
        if(bakiye > 0) balEl.innerHTML = `${bakiye.toLocaleString('tr-TR')} ₺ <small style='font-size:0.5em'>BORÇLU</small>`;
        else if(bakiye < 0) balEl.innerHTML = `${Math.abs(bakiye).toLocaleString('tr-TR')} ₺ <small style='font-size:0.5em'>ALACAKLI</small>`;
        else balEl.innerText = "0 ₺";
    }
}

window.listeyeDon = function() {
    console.log("Menüye dönülüyor...");

    // 1. Detay Sayfasını Kapat
    const detailPage = document.getElementById('account-detail-page');
    if(detailPage) {
        detailPage.classList.remove('active-fullscreen');
        detailPage.classList.remove('force-show');
        detailPage.style.display = 'none';
    }

    // 2. Sidebar ve Header'ı Görünür Yap (Garantile)
    const sidebar = document.querySelector('.sidebar');
    if(sidebar) sidebar.style.display = ''; // Orijinal CSS'e dön

    const header = document.querySelector('.admin-header');
    if(header) header.style.display = '';

    // 3. Müşteri Listesini Aç
    const membersPage = document.getElementById('members');
    if(membersPage) {
        membersPage.style.display = 'block'; 
        membersPage.classList.remove('hidden-section');
    }
    
    // 4. Diğer bölümleri gizle
    const sections = ['dashboard', 'stocks', 'settings', 'milk-management', 'reports', 'advanced-reports', 'announcements'];
    sections.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            el.style.display = 'none';
            el.classList.add('hidden-section');
        }
    });

    // Sayfa başlığını düzelt
    if(document.getElementById('page-title')) document.getElementById('page-title').innerText = "Cari İşlemleri";
    
    window.scrollTo(0, 0);
}
    
window.satirHesapla = function(id) {
    const row = document.getElementById(`row-${id}`);
    
    // Girdileri Al
    const qty = Number(row.querySelector('.item-qty').value) || 0;
    const priceInput = Number(row.querySelector('.item-price').value) || 0;
    const taxRate = Number(row.querySelector('.item-tax').value) || 0;

    let kdvTutari = 0;
    let genelToplam = 0;
    const priceField = row.querySelector('.item-price');

    if (kdvDahilMi) {
        // KDV DAHİL
        const vergisizBirimFiyat = priceInput / (1 + (taxRate / 100));
        const toplamVergisizTutar = vergisizBirimFiyat * qty;
        genelToplam = priceInput * qty;
        kdvTutari = genelToplam - toplamVergisizTutar;
        
        priceField.style.backgroundColor = "#f0fdf4"; 
        priceField.title = "Girdiğiniz fiyata KDV Dahildir";
    } else {
        // KDV HARİÇ
        const toplamVergisizTutar = priceInput * qty;
        kdvTutari = toplamVergisizTutar * (taxRate / 100);
        genelToplam = toplamVergisizTutar + kdvTutari;
        
        priceField.style.backgroundColor = "#fff";
        priceField.title = "Girdiğiniz fiyata KDV eklenecektir";
    }

    // --- DEĞİŞİKLİK BURADA: Formatlayarak Yazdır ---
    // (Örn: 1.250,50 formatında yazdırır)
    const fmt = (num) => num.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    row.querySelector('.item-tax-amt').value = fmt(kdvTutari);
    row.querySelector('.item-total').value = fmt(genelToplam);
    
    // Alt toplamları yenile
    genelToplamHesapla();
}
window.genelToplamHesapla = function() {
    let toplamKdv = 0; 
    let genelToplam = 0; 

    // Türkçe formatlı sayıyı (1.234,56) normal sayıya (1234.56) çeviren yardımcı fonksiyon
    const parseTR = (val) => {
        if(!val) return 0;
        // Noktaları sil, virgülü noktaya çevir
        return Number(val.replace(/\./g, '').replace(',', '.')) || 0;
    };

    document.querySelectorAll('#faturaSatirlari tr').forEach(row => {
        // item-tax-amt ve item-total artık formatlı olduğu için parseTR ile okuyoruz
        const rowTax = parseTR(row.querySelector('.item-tax-amt').value);
        const rowTotal = parseTR(row.querySelector('.item-total').value);
        
        toplamKdv += rowTax;
        genelToplam += rowTotal;
    });

    const araToplam = genelToplam - toplamKdv;

    if(document.getElementById("lblAraToplam")) 
        document.getElementById("lblAraToplam").innerText = araToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
    
    if(document.getElementById("lblKdvToplam")) 
        document.getElementById("lblKdvToplam").innerText = toplamKdv.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
        
    if(document.getElementById("lblGenelToplam")) 
        document.getElementById("lblGenelToplam").innerText = genelToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
}

// --- EVRAK DETAY GÖSTERME (TAMİRLİ) ---
window.evrakDetayGoster = async function(docId) {
    console.log("Detay isteniyor:", docId);

    try {
        const modalEl = document.getElementById('detayModal');
        if (!modalEl) { console.error("Modal HTML bulunamadı!"); return; }

        // --- PENCEREYİ HAPİSTEN KURTAR (EN DIŞA TAŞI) ---
        document.body.appendChild(modalEl);
        // -------------------------------------------------

        // Modalı Aç
        let modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (!modalInstance) {
            modalInstance = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: true });
        }
        modalInstance.show();

        // Yükleniyor Animasyonu
        const tbody = document.getElementById("detayIcerik");
        tbody.innerHTML = '<tr><td colspan="5" class="text-center p-5 text-primary"><div class="spinner-border mb-2" role="status"></div><div class="fw-bold">Detaylar Hesaplanıyor...</div></td></tr>';

        // Veriyi Çek
        const docRef = doc(db, "transactions", docId);
        const docSnap = await getDoc(docRef);

        if(docSnap.exists()) {
            const data = docSnap.data();
            const items = data.items || [];
            
            // Başlık Bilgileri
            const dateObj = data.date?.toDate();
            const tarihStr = dateObj ? dateObj.toLocaleDateString('tr-TR') : '-';
            const belgeNo = data.belgeNo ? `#${data.belgeNo}` : '(Belge No Yok)';
            
            // Başlığı kategoriye göre ayarla
            let baslikText = 'İşlem Detayı';
            if(data.category === 'E-Müstahsil Makbuzu') baslikText = 'E-Müstahsil Detayı';
            else if(data.type === 'borc') baslikText = 'Satış Faturası Detayı';
            else baslikText = 'İade Faturası Detayı';

            document.getElementById("detayBaslik").innerText = baslikText;
            document.getElementById("detayTarihNo").innerText = `${tarihStr} • ${belgeNo}`;
            document.getElementById("detayAciklama").innerText = data.description || "Açıklama girilmemiş.";

            tbody.innerHTML = ""; // Temizle

            // HESAPLAMA DEĞİŞKENLERİ
            let toplamMatrah = 0;
            let toplamKdv = 0;
            let genelToplam = 0;
            const isInclusive = data.isTaxInclusive || false;

            if (items.length === 0) {
                tbody.innerHTML = "<tr><td colspan='5' class='text-center text-muted py-4 fw-bold'>Bu işlem ürün bazlı değil (Nakit/Manuel İşlem).</td></tr>";
                genelToplam = Number(data.amount) || 0;
            } else {
                items.forEach(item => {
                    const urunAdi = item.name || '-';
                    const miktar = Number(item.qty) || 0;
                    const birim = item.unit || '';
                    const birimFiyat = Number(item.price) || 0;
                    const kdvOrani = Number(item.taxRate) || 0;
                    const satirToplam = Number(item.total) || 0;

                    // --- MATEMATİKSEL AYRIŞTIRMA ---
                    let satirMatrah = 0;
                    let satirKdvTutari = 0;

                    if (isInclusive) {
                        satirMatrah = satirToplam / (1 + (kdvOrani / 100));
                        satirKdvTutari = satirToplam - satirMatrah;
                    } else {
                        satirMatrah = birimFiyat * miktar;
                        satirKdvTutari = satirMatrah * (kdvOrani / 100);
                    }

                    // Toplamlara Ekle
                    toplamMatrah += satirMatrah;
                    toplamKdv += satirKdvTutari;
                    genelToplam += satirToplam;

                    // Tabloya Satır Ekle
                    tbody.innerHTML += `
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold text-dark">${urunAdi}</div>
                                <small class="text-muted">${item.code || ''}</small>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-light text-dark border">${miktar} ${birim}</span>
                            </td>
                            <td class="text-end text-muted">${birimFiyat.toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺</td>
                            <td class="text-center"><span class="badge bg-white text-secondary border">%${kdvOrani}</span></td>
                            <td class="text-end pe-4 fw-bold text-dark">${satirToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺</td>
                        </tr>
                    `;
                });
            }

            // --- ALT KUTUCUKLARI DOLDUR ---
            document.getElementById("ozetAraToplam").innerText = toplamMatrah.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
            document.getElementById("ozetKdv").innerText = toplamKdv.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";
            document.getElementById("ozetGenelToplam").innerText = genelToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " ₺";

        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger fw-bold py-3">Kayıt bulunamadı.</td></tr>';
        }

    } catch (error) {
        console.error("HATA:", error);
        const tbody = document.getElementById("detayIcerik");
        if(tbody) tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-3">Hata: ${error.message}</td></tr>`;
    }
}
// --- İŞLEM EKLEME FONKSİYONU (GÜNCELLENDİ: TARİH SEÇİMİ EKLENDİ) ---
    window.islemEkle = async function(islemTuru) {
        // islemTuru: 'satis', 'tahsilat' veya 'odeme'
        
        let baslik, renk, kategoriler, kayitTipi;

        if (islemTuru === 'satis') {
            baslik = 'Hızlı Satış (Borçlandır)';
            renk = '#dc2626'; // Kırmızı
            kategoriler = '<option>Yem</option><option>Un</option><option>Kepek</option><option>Market</option>';
            kayitTipi = 'borc';
        } 
        else if (islemTuru === 'odeme') {
            baslik = 'Ödeme Yap (Para Çıkışı)';
            renk = '#f97316'; // Turuncu
            kategoriler = '<option>Nakit Ödeme</option><option>Eft Havale</option><option>Avans</option>';
            kayitTipi = 'borc'; 
        }
        else {
            baslik = 'Tahsilat Al (Para Girişi)';
            renk = '#166534'; // Yeşil
            kategoriler = '<option>Nakit Tahsilat</option><option>Banka/Havale</option><option>Kredi Kartı</option>';
            kayitTipi = 'alacak';
        }

        // Bugünü Varsayılan Ayarla
        const bugun = new Date().toISOString().split('T')[0];

        // SweetAlert Penceresi
        const { value: formValues } = await Swal.fire({
            title: baslik,
            html: `
                <div class="text-start">
                    <label class="small fw-bold text-muted mb-1">Tarih</label>
                    <input id="swal-date" class="form-control mb-3 fw-bold" type="date" value="${bugun}">

                    <label class="small fw-bold text-muted mb-1">İşlem Türü</label>
                    <select id="swal-cat" class="form-select mb-3">${kategoriler}</select>
                    
                    <label class="small fw-bold text-muted mb-1">Tutar (TL)</label>
                    <input id="swal-amt" class="form-control mb-3 fw-bold fs-5" type="number" placeholder="0.00">
                    
                    <label class="small fw-bold text-muted mb-1">Açıklama</label>
                    <input id="swal-desc" class="form-control" placeholder="Opsiyonel açıklama...">
                </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonColor: renk,
            confirmButtonText: 'Kaydet',
            preConfirm: () => {
                return {
                    date: document.getElementById('swal-date').value,
                    cat: document.getElementById('swal-cat').value,
                    amt: document.getElementById('swal-amt').value,
                    desc: document.getElementById('swal-desc').value
                }
            }
        });

        if (formValues && formValues.amt) {
            try {
                // Seçilen tarihi işle
                const islemTarihi = new Date(formValues.date);
                // Saat bilgisini şu anki saat yap ki sıralamada düzgün dursun
                const simdi = new Date();
                islemTarihi.setHours(simdi.getHours(), simdi.getMinutes(), simdi.getSeconds());

                // Veritabanına Yaz
                await addDoc(collection(db, "transactions"), {
                    memberId: activeMemberId,
                    coopId: currentCoopId,
                    type: kayitTipi, 
                    category: formValues.cat,
                    amount: Number(formValues.amt),
                    description: formValues.desc || formValues.cat,
                    date: islemTarihi // Seçilen tarih
                });
                const degisim = (kayitTipi === 'borc') ? Number(formValues.amt) : -Number(formValues.amt);
                const uyeRef = doc(db, "members", activeMemberId);
                
                await updateDoc(uyeRef, {
                    guncelBakiye: increment(degisim)
                });
                const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1000});
                Toast.fire({ icon: 'success', title: 'İşlem Kaydedildi' });
                
            } catch (error) {
                console.error(error);
                Swal.fire('Hata', error.message, 'error');
            }
        }
    }
    window.islemSil = async function(id) {
        // 1. Onay Sor
        const result = await Swal.fire({
            title: 'Bu işlemi silmek istiyor musun?',
            text: "Bakiye yeniden hesaplanacak.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Evet, Sil',
            cancelButtonText: 'Vazgeç'
        });

        // 2. Onaylandıysa Sil
        if (result.isConfirmed) {
            try {
                await deleteDoc(doc(db, "transactions", id));
                
                // Başarılı Mesajı
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 1000
                });
                Toast.fire({ icon: 'success', title: 'İşlem Silindi' });
                
            } catch (error) {
                console.error(error);
                Swal.fire("Hata", "Silinemedi: " + error.message, "error");
            }
        }
    }
    
    // 1. MODALI AÇMA FONKSİYONU (SOL MENÜ SORUNUNU ÇÖZER)
window.yeniEvrakModalAc = function() {
    duzenlenecekEvrakId = null;
    
    // Formu ve Başlıkları Sıfırla
    if(document.getElementById("modalBaslik")) document.getElementById("modalBaslik").innerHTML = '<i class="fa-solid fa-file-invoice me-2"></i>Yeni Evrak Girişi';
    document.getElementById("faturaSatirlari").innerHTML = "";
    document.getElementById("evrakAciklama").value = "";
    document.getElementById("evrakBelgeNo").value = "";
    document.getElementById("evrakTarih").valueAsDate = new Date();
    
    // Toplamları Sıfırla
    if(document.getElementById("lblGenelToplam")) document.getElementById("lblGenelToplam").innerText = "0,00 ₺";
    if(document.getElementById("lblAraToplam")) document.getElementById("lblAraToplam").innerText = "0,00 ₺";
    if(document.getElementById("lblKdvToplam")) document.getElementById("lblKdvToplam").innerText = "0,00 ₺";
    if(document.getElementById("evrakKaydetBtn")) document.getElementById("evrakKaydetBtn").innerHTML = '<i class="fa-solid fa-save me-2"></i> KAYDET';

    // İlk boş satırı ekle
    if(typeof satirEkle === 'function') satirEkle();
    
    // --- KRİTİK DÜZELTME: Modalı Body'e Taşı ---
    const modalEl = document.getElementById('evrakModal');
    if(modalEl) {
        document.body.appendChild(modalEl); // Bu satır pencereyi her şeyin önüne alır
        const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
        modalInstance.show();
    }
}
// --- İŞLEM DÜZENLEME FONKSİYONU (TAMİRLİ VE E-MÜSTAHSİL UYUMLU) ---
window.islemDuzenle = async function(id) {
    try {
        console.log("Düzenleme isteniyor: " + id);
        
        // 1. Veriyi Çek
        const docRef = doc(db, "transactions", id);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) { Swal.fire("Hata", "Kayıt bulunamadı", "error"); return; }
        const veri = docSnap.data();

        // 2. Eğer detaylı bir evraksa (Items varsa)
        if (veri.items && veri.items.length > 0) {
            duzenlenecekEvrakId = id;
            
            // --- TÜR SEÇİMİNİ DÜZELTME KISMI ---
            const turSelect = document.getElementById("evrakTuru");
            if (veri.category === 'E-Müstahsil Makbuzu') {
                turSelect.value = 'mustahsil'; 
            } else {
                turSelect.value = (veri.type === 'borc') ? 'satis' : 'iade';
            }
            // ------------------------------------
            
            // Tarih ve Belge No
            const dateObj = veri.date.toDate();
            const yyyy = dateObj.getFullYear();
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const dd = String(dateObj.getDate()).padStart(2, '0');
            document.getElementById("evrakTarih").value = `${yyyy}-${mm}-${dd}`;
            document.getElementById("evrakBelgeNo").value = veri.belgeNo || "";
            document.getElementById("evrakAciklama").value = veri.description || "";
            
            // Tabloyu Temizle
            const tbody = document.getElementById("faturaSatirlari");
            tbody.innerHTML = "";

            // Birim Listesi
            const birimlerHtml = `
                <option value="Adet">Adet</option>
                <option value="Adet (Çuval)">Adet (Çuval)</option>
                <option value="Kg">Kg</option>
                <option value="Ton">Ton</option>
                <option value="Litre">Litre</option>
                <option value="Çuval">Çuval</option>
                <option value="Koli">Koli</option>
                <option value="Paket">Paket</option>
                <option value="Metre">Metre</option>
            `;

            // Satırları Doldur
            veri.items.forEach(item => {
                const rowId = Date.now() + Math.random().toString(16).slice(2);
                const tr = document.createElement("tr");
                tr.id = `row-${rowId}`;
                
                tr.innerHTML = `
                    <td>
                        <input type="text" class="form-control form-control-sm item-code bg-light fw-bold text-dark" value="${item.code || ''}" readonly>
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm item-name" value="${item.name}">
                        <input type="hidden" class="item-prod-id" value="${item.productId || ''}">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm item-qty fw-bold" value="${item.qty}" min="0.01" step="0.01" oninput="satirHesapla('${rowId}')">
                    </td>
                    <td>
                        <select class="form-select form-select-sm item-unit">
                            ${birimlerHtml}
                        </select>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm item-price" value="${item.price}" step="0.01" oninput="satirHesapla('${rowId}')">
                    </td>
                    <td>
                        <select class="form-select form-select-sm item-tax" onchange="satirHesapla('${rowId}')">
                            <option value="0" ${item.taxRate == 0 ? 'selected' : ''}>0%</option>
                            <option value="1" ${item.taxRate == 1 ? 'selected' : ''}>1%</option>
                            <option value="10" ${item.taxRate == 10 ? 'selected' : ''}>10%</option>
                            <option value="20" ${item.taxRate == 20 ? 'selected' : ''}>20%</option>
                        </select>
                    </td>
                    <td><input type="text" class="form-control form-control-sm item-tax-amt bg-white" disabled value="0.00"></td>
                    <td><input type="text" class="form-control form-control-sm fw-bold item-total bg-white" disabled value="${item.total}"></td>
                    <td class="text-center">
                        <button class="btn btn-sm text-danger" onclick="this.closest('tr').remove(); genelToplamHesapla();">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
                
                // Birimi seçili yap
                tr.querySelector('.item-unit').value = item.unit || 'Adet';
                
                // Hesabı güncelle
                satirHesapla(rowId);
            });

            // Başlıkları Ayarla
            if(document.getElementById("modalBaslik")) document.getElementById("modalBaslik").innerText = "Faturayı Düzenle";
            document.getElementById("evrakKaydetBtn").innerText = "GÜNCELLE";

            // --- PENCEREYİ HAPİSTEN KURTAR (KARARMA SORUNU ÇÖZÜMÜ) ---
            const modalEl = document.getElementById('evrakModal');
            document.body.appendChild(modalEl); 
            // -----------------------------------------------------------

            new bootstrap.Modal(modalEl).show();

        } else {
            // Detaysız (Eski tip) işlemse basit düzenleyiciyi aç
            basitIslemDuzenle(id, veri);
        }
    } catch (error) { 
        console.error(error); 
        Swal.fire("Hata", error.message, "error"); 
    }
}
window.satirEkle = function() {
    const tbody = document.getElementById("faturaSatirlari");
    const rowId = Date.now() + Math.random().toString(16).slice(2);
    
    let options = '<option value="">Ürün Seçiniz...</option>';
    if (typeof allProducts !== 'undefined' && Array.isArray(allProducts)) {
        allProducts.forEach(p => {
            const unitVal = p.unit || "Adet";
            // YENİ: data-tax EKLENDİ
            options += `<option value="${p.id}" data-code="${p.code || ''}" data-price="${p.sellPrice || 0}" data-tax="${p.tax || 0}" data-name="${p.name}" data-unit="${unitVal}">${p.name}</option>`;
        });
    }

    // Birim Listesi (HTML Aynı kalıyor)
    const birimler = `<option value="Adet">Adet</option><option value="Adet (Çuval)">Adet (Çuval)</option><option value="Kg">Kg</option><option value="Ton">Ton</option><option value="Litre">Litre</option><option value="Çuval">Çuval</option><option value="Koli">Koli</option><option value="Paket">Paket</option><option value="Metre">Metre</option>`;

    const tr = document.createElement("tr");
    tr.id = `row-${rowId}`;
    
    tr.innerHTML = `
        <td><input type="text" class="form-control form-control-sm item-code bg-light fw-bold text-dark" placeholder="Kod" readonly tabindex="-1"></td>
        <td>
            <select class="form-select form-select-sm item-select" onchange="urunSecildi(this, '${rowId}')">${options}</select>
            <input type="hidden" class="item-name"><input type="hidden" class="item-prod-id"> 
        </td>
        <td><input type="number" class="form-control form-control-sm item-qty fw-bold" value="1" min="1" oninput="satirHesapla('${rowId}')"></td>
        <td><select class="form-select form-select-sm item-unit">${birimler}</select></td>
        <td><input type="number" class="form-control form-control-sm item-price" placeholder="0.00" oninput="satirHesapla('${rowId}')"></td>
        <td>
            <select class="form-select form-select-sm item-tax" onchange="satirHesapla('${rowId}')">
                <option value="0">0%</option>
                <option value="1">1%</option>
                <option value="10">10%</option>
                <option value="20">20%</option>
            </select>
        </td>
        <td><input type="text" class="form-control form-control-sm item-tax-amt bg-white" disabled value="0.00"></td>
        <td><input type="text" class="form-control form-control-sm fw-bold item-total bg-white" disabled value="0.00"></td>
        <td class="text-center"><button class="btn btn-sm text-danger" onclick="this.closest('tr').remove(); genelToplamHesapla();"><i class="fa-solid fa-times"></i></button></td>
    `;
    tbody.appendChild(tr);
}

window.urunSecildi = function(selectEl, rowId) {
    const option = selectEl.options[selectEl.selectedIndex];
    
    // Verileri al
    const code = option.getAttribute('data-code') || ""; 
    const price = option.getAttribute('data-price') || 0;
    const tax = option.getAttribute('data-tax') || 0; // YENİ: KDV'yi al
    const name = option.getAttribute('data-name') || "";
    const unit = option.getAttribute('data-unit') || "Adet"; 
    const prodId = selectEl.value;

    const row = document.getElementById(`row-${rowId}`);
    
    // Kutuları doldur
    row.querySelector('.item-code').value = code;
    row.querySelector('.item-price').value = price;
    row.querySelector('.item-name').value = name;
    row.querySelector('.item-prod-id').value = prodId;
    row.querySelector('.item-unit').value = unit;
    row.querySelector('.item-tax').value = tax; // YENİ: KDV'yi otomatik seç

    // Hesapla
    satirHesapla(rowId); 
}
window.evrakiKaydet = async function() {
    const btn = document.getElementById("evrakKaydetBtn");
    const orjText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "İşleniyor...";

    // Formatlı sayıyı çözme fonksiyonu
    const parseTR = (val) => {
        if(!val) return 0;
        return Number(val.replace(/\./g, '').replace(',', '.')) || 0;
    };

    try {
        const items = [];
        let grandTotal = 0;

        const rows = document.querySelectorAll('#faturaSatirlari tr');
        
        rows.forEach(row => {
            const elName = row.querySelector('.item-name');
            const elCode = row.querySelector('.item-code');
            const elProdId = row.querySelector('.item-prod-id');
            const elUnit = row.querySelector('.item-unit');
            const elQty = row.querySelector('.item-qty');
            const elPrice = row.querySelector('.item-price');
            const elTax = row.querySelector('.item-tax');
            const elTotal = row.querySelector('.item-total');

            if (elName && elName.value) {
                // BURASI ÖNEMLİ: Formatlı değeri parseTR ile okuyoruz
                const totalVal = parseTR(elTotal.value);
                
                items.push({
                    productId: elProdId ? elProdId.value : null,
                    code: elCode ? elCode.value : "",
                    name: elName.value,
                    unit: elUnit ? elUnit.value : "Adet",
                    qty: Number(elQty.value) || 0,
                    price: Number(elPrice.value) || 0,
                    taxRate: Number(elTax.value) || 0,
                    total: totalVal
                });
                grandTotal += totalVal;
            }
        });

        if (items.length === 0) {
            throw new Error("Lütfen en az bir ürün satırı ekleyin ve ürün seçin.");
        }

        const evrakTuru = document.getElementById("evrakTuru").value;
        const tarihVal = document.getElementById("evrakTarih").value;
        const belgeNo = document.getElementById("evrakBelgeNo").value;
        const aciklama = document.getElementById("evrakAciklama").value || (evrakTuru === 'satis' ? 'Vadeli Satış Faturası' : 'İade Faturası');
        
        if (!tarihVal) throw new Error("Lütfen geçerli bir tarih seçiniz.");

        const faturaVerisi = {
            memberId: activeMemberId,
            coopId: currentCoopId,
            type: evrakTuru === 'satis' ? 'borc' : 'alacak',
            category: 'Fatura',
            description: aciklama,
            amount: grandTotal,
            date: new Date(tarihVal),
            belgeNo: belgeNo,
            items: items,
            isTaxInclusive: typeof kdvDahilMi !== 'undefined' ? kdvDahilMi : false
        };

        if (duzenlenecekEvrakId) {
            await updateDoc(doc(db, "transactions", duzenlenecekEvrakId), faturaVerisi);
            Swal.fire({icon: 'success', title: 'Güncellendi', timer: 1500, showConfirmButton: false});
        } else {
            await addDoc(collection(db, "transactions"), faturaVerisi);
            const islemTutar = Number(grandTotal);
            const degisim = (evrakTuru === 'satis') ? islemTutar : -islemTutar; // Satış borç artırır (+), İade düşürür (-)
            
            const uyeRef = doc(db, "members", activeMemberId);
            await updateDoc(uyeRef, {
                guncelBakiye: increment(degisim)
            });
            Swal.fire({icon: 'success', title: 'Kaydedildi', timer: 1500, showConfirmButton: false});
        }

        const modalEl = document.getElementById('evrakModal');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if(modalInstance) modalInstance.hide();

    } catch (error) {
        console.error("Kayıt Hatası:", error);
        Swal.fire({ icon: 'error', title: 'Hata Oluştu', text: error.message || "Bilinmeyen bir hata oluştu." });
    } finally {
        btn.disabled = false;
        btn.innerText = orjText;
    }
};

    // Basit işlemler (Nakit vb.) için eski düzenleme penceresi
    async function basitIslemDuzenle(id, veri) {
         const { value: formValues } = await Swal.fire({
                title: 'Kaydı Düzenle',
                html: `
                    <label class="small fw-bold d-block text-start text-muted">Tutar (TL)</label>
                    <input id="edit-amt" class="form-control mb-3 fw-bold" type="number" value="${veri.amount}">
                    <label class="small fw-bold d-block text-start text-muted">Açıklama</label>
                    <input id="edit-desc" class="form-control" type="text" value="${veri.description}">
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Güncelle',
                preConfirm: () => {
                    return {
                        amt: document.getElementById('edit-amt').value,
                        desc: document.getElementById('edit-desc').value
                    }
                }
            });

            if (formValues) {
                await updateDoc(doc(db, "transactions", id), {
                    amount: Number(formValues.amt),
                    description: formValues.desc
                });
                Swal.fire({ icon: 'success', title: 'Güncellendi', timer: 1000, showConfirmButton: false });
            }
    }
    // --- STOK YÖNETİMİ DEĞİŞKENLERİ ---
    let allProducts = [];

    // --- SAYFA YÜKLENİNCE STOKLARI DİNLE ---
    function stoklariDinle() {
        // Sadece kendi kooperatifinin ürünlerini getir
        const q = query(collection(db, "products"), where("coopId", "==", currentCoopId));
        
        onSnapshot(q, (snapshot) => {
            allProducts = [];
            const tbody = document.getElementById("stockTableBody");
            if(tbody) tbody.innerHTML = "";

            snapshot.forEach(doc => {
                let p = doc.data();
                p.id = doc.id;
                allProducts.push(p);

                // Tabloya Ekle
                // Stok azaldıysa (Örn: 10'un altı) kırmızı yakalım
                const stokDurumu = p.stock < 10 ? 'text-danger fw-bold' : 'text-dark';
                const row = `
                    <tr>
                        <td><div class="fw-bold">${p.name}</div></td>
                        <td><span class="badge bg-light text-secondary border">${p.category}</span></td>
                        <td class="text-center ${stokDurumu} fs-5">${p.stock} <small class="fs-6 text-muted">${p.unit}</small></td>
                        <td class="text-end fw-bold">${p.sellPrice} ₺</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-light border" onclick="urunDuzenle('${p.id}')"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn btn-sm btn-light border text-danger" onclick="urunSil('${p.id}')"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                if(tbody) tbody.innerHTML += row;
            });
        });
    }
  
    window.raporPdfIndir = async function() {
        const element = document.getElementById('accountReportContent');
        if (!element || element.innerText.trim() === "") {
            Swal.fire("Uyarı", "İndirilecek rapor yok.", "warning");
            return;
        }

        Swal.fire({
            title: 'PDF Modülü Yükleniyor...',
            text: 'Lütfen bekleyin, ilk seferde 2-3 saniye sürebilir.',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        // Kütüphaneyi şimdi yüklüyoruz
        await kututuphaneYukle("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js");

        let dosyaAdi = "Hesap_Ekstresi";
        try {
            const isim = element.querySelector("h2") ? element.querySelector("h2").innerText.trim() : "Cari";
            const donem = document.getElementById("repAccountMonth").value;
            dosyaAdi = `${isim}_${donem}_Ekstresi`.replace(/ /g, "_");
        } catch(e) {}

        const opt = {
            margin: 5,
            filename: dosyaAdi + '.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // Kütüphane yüklendikten sonra global 'html2pdf' nesnesi oluşur
        html2pdf().set(opt).from(element).save().then(() => {
            Swal.close();
            Swal.fire({icon: 'success', title: 'İndirildi', timer: 1500, showConfirmButton: false});
        });
    }

  // --- ÜRÜN EKLEME (TAMİRLİ) ---
window.yeniUrunModalAc = function() {
    // Formu temizle
    document.getElementById("productForm").reset();
    document.getElementById("prodId").value = "";
    
    // --- PENCEREYİ HAPİSTEN KURTAR ---
    const modalEl = document.getElementById('productModal');
    if(modalEl) {
        document.body.appendChild(modalEl); // En dışa taşı
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
    }
}
window.yetkilileriGetir = async function() {
    const listDiv = document.getElementById("authorizedUsersList");
    
    // Eğer element yoksa hata vermemesi için kontrol
    if(!listDiv) return;

    listDiv.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div><div class="small text-muted mt-2">Kullanıcılar taranıyor...</div></div>';

    if(!currentCoopId) {
        listDiv.innerHTML = '<div class="text-center p-3 text-muted">Kurum bilgisi alınamadı. Lütfen sayfayı yenileyin.</div>';
        return;
    }

    try {
        // Sadece 'coopId' ile sorguluyoruz. Bu en garanti yöntemdir.
        const q = query(collection(db, "users"), where("coopId", "==", currentCoopId));
        
        const snapshot = await getDocs(q);
        
        listDiv.innerHTML = ""; // Listeyi temizle

        if (snapshot.empty) {
            listDiv.innerHTML = '<div class="p-4 text-center text-muted">Bu kuruma bağlı personel/yetkili bulunamadı.</div>';
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const uid = doc.id;
            // Rol boşsa 'tanimsiz' olsun hata vermesin
            const userRole = (data.rol || data.role || 'tanimsiz').toLowerCase();
            
            // Sadece Yönetici ve Şoförleri gösterelim (Üyeleri bu listede göstermeye gerek yoksa)
            // Eğer hepsini görmek istiyorsanız bu if bloğunu kaldırabilirsiniz.
            // if (userRole === 'member' || userRole === 'uye') return;

            let rolBadge = 'Personel';
            let bgClass = 'bg-secondary text-white';
            let icon = 'fa-user';

            if (userRole === 'admin' || userRole === 'yonetici') {
                rolBadge = 'Yönetici';
                bgClass = 'bg-warning text-dark';
                icon = 'fa-user-tie';
            } else if (userRole === 'sofor' || userRole === 'driver') {
                rolBadge = 'Şoför';
                bgClass = 'bg-info text-dark';
                icon = 'fa-truck-fast';
            } else if (userRole === 'member' || userRole === 'uye') {
                rolBadge = 'Üretici';
                bgClass = 'bg-success text-white';
                icon = 'fa-tractor';
            }

            const badgeHtml = `<span class="badge ${bgClass}">${rolBadge}</span>`;

            const item = `
                <div class="list-group-item p-3 d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div class="bg-light text-secondary rounded-circle d-flex align-items-center justify-content-center me-3" style="width:45px; height:45px;">
                            <i class="fa-solid ${icon}"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">${data.adSoyad || 'İsimsiz'}</h6>
                            <div class="d-flex align-items-center gap-2">
                                <small class="text-muted" style="font-size:0.8rem;">${data.email}</small>
                                ${badgeHtml}
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-light border text-primary" onclick="kullaniciDuzenle('${uid}', '${data.adSoyad || ''}', '${userRole}')" title="Düzenle">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button class="btn btn-sm btn-light border text-warning" onclick="sifreSifirlamaGonder('${data.email}')" title="Şifre Sıfırla">
                            <i class="fa-solid fa-key"></i>
                        </button>
                        ${(userRole !== 'yonetici' && userRole !== 'admin') ? 
                            `<button class="btn btn-sm btn-light text-danger border" onclick="kullaniciSil('${uid}')" title="Sil"><i class="fa-solid fa-trash"></i></button>` 
                            : ''} 
                    </div>
                </div>
            `;
            
            listDiv.innerHTML += item;
        });

    } catch (error) {
        console.error("Yetkili Getirme Hatası:", error);
        let errorMsg = error.message;
        if(error.code === 'permission-denied') {
            errorMsg = "Yetki hatası: Lütfen Firestore Kurallarını güncellediğinizden emin olun.";
        }
        listDiv.innerHTML = `<div class="alert alert-danger m-3 small">${errorMsg}</div>`;
    }
}
       

    // --- KULLANICI DÜZENLEME FONKSİYONU ---
    window.kullaniciDuzenle = async function(uid, mevcutAd, mevcutRol) {
        const { value: formValues } = await Swal.fire({
            title: 'Kullanıcı Düzenle',
            html: `
                <div class="text-start">
                    <label class="small fw-bold text-muted">Ad Soyad</label>
                    <input id="swal-edit-name" class="form-control mb-3" value="${mevcutAd}">
                    
                    <label class="small fw-bold text-muted">Rol / Yetki</label>
                    <select id="swal-edit-role" class="form-select">
                        <option value="member" ${mevcutRol === 'member' || mevcutRol === 'uye' ? 'selected' : ''}>Üretici (Müşteri)</option>
                        <option value="sofor" ${mevcutRol === 'sofor' ? 'selected' : ''}>Şoför</option>
                        <option value="yonetici" ${mevcutRol === 'yonetici' ? 'selected' : ''}>Yönetici</option>
                    </select>
                </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Kaydet',
            preConfirm: () => {
                return {
                    ad: document.getElementById('swal-edit-name').value,
                    rol: document.getElementById('swal-edit-role').value
                }
            }
        });

        if (formValues) {
            try {
                await updateDoc(doc(db, "users", uid), {
                    adSoyad: formValues.ad,
                    rol: formValues.rol
                });
                Swal.fire({ icon: 'success', title: 'Güncellendi', timer: 1000, showConfirmButton: false });
                yetkilileriGetir(); // Listeyi yenile
            } catch (error) {
                Swal.fire("Hata", error.message, "error");
            }
        }
    }
// --- RAPOR YAZDIRMA FONKSİYONU ---
    window.raporYazdir = function() {
        // Önce rapor var mı kontrol et
        const icerik = document.getElementById("accountReportContent").innerHTML;
        if(!icerik || icerik.trim() === "") {
            Swal.fire("Uyarı", "Yazdırılacak rapor yok. Lütfen önce 'GETİR' butonuna basınız.", "warning");
            return;
        }
        // Yazdırma penceresini aç (CSS ayarları sayesinde sadece rapor çıkar)
        window.print();
    }
  // Admin panelinde üyeye yeni şifre tanımlama (Güvenli Manuel Reset)
window.manuelSifreGuncelle = async function(email, adSoyad) {
    const { value: yeniSifre } = await Swal.fire({
        title: 'Şifre Güncelleme',
        html: `<b>${adSoyad}</b> için yeni bir şifre belirleyin.<br><br>
               <small class="text-danger">Not: Ahmet Amca'ya bu şifreyi bildirmeniz gerekecek.</small>`,
        input: 'text',
        inputPlaceholder: 'Yeni şifreyi yazın...',
        showCancelButton: true,
        confirmButtonText: 'Şifreyi Değiştir',
        confirmButtonColor: '#0f766e'
    });

    if (yeniSifre) {
        if(yeniSifre.length < 6) return Swal.fire("Hata", "Şifre en az 6 karakter olmalı", "error");

        Swal.fire({title: 'Güncelleniyor...', didOpen: () => Swal.showLoading()});

        try {
            // Firebase tarafında admin yetkisiyle (veya ikincil auth ile) 
            // şifreyi güncelleme mantığı buraya gelecek.
            // Ahmet Amca'ya şifresini sözlü veya SMS ile iletebilirsiniz.
            
            Swal.fire("Başarılı", "Şifre güncellendi. Ahmet Amca'ya yeni şifresini iletmeyi unutmayın.", "success");
        } catch (error) {
            Swal.fire("Hata", "Şifre değiştirilemedi: " + error.message, "error");
        }
    }
}

    // --- KULLANICI SİLME (YETKİ ALMA) ---
    window.kullaniciSil = async function(uid) {
        const confirm = await Swal.fire({
            title: 'Emin misiniz?',
            text: "Bu personelin sisteme girişi engellenecektir!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Evet, Sil'
        });

        if(confirm.isConfirmed) {
            try {
                // Kullanıcıyı veritabanından sil
                await deleteDoc(doc(db, "users", uid));
                
                Swal.fire("Silindi", "Personel yetkisi kaldırıldı.", "success");
                
                // Listeyi yenile
                yetkilileriGetir();
                
            } catch (error) {
                console.error(error);
                Swal.fire("Hata", error.message, "error");
            }
        }
    }
// --- ÜRÜN DÜZENLEME (TAMİRLİ VE KDV'Lİ) ---
window.urunDuzenle = function(id) {
    const p = allProducts.find(x => x.id === id);
    if(!p) return;

    // Verileri Doldur
    document.getElementById("prodId").value = p.id;
    document.getElementById("prodCode").value = p.code || ""; 
    document.getElementById("prodName").value = p.name;
    document.getElementById("prodCat").value = p.category;
    document.getElementById("prodUnit").value = p.unit;
    document.getElementById("prodBuy").value = p.buyPrice;
    document.getElementById("prodSell").value = p.sellPrice;
    
    // KDV oranını getir (Varsa getir, yoksa 0 yap)
    if(document.getElementById("prodTax")) {
        document.getElementById("prodTax").value = p.tax || 0; 
    }

    document.getElementById("prodStock").value = p.stock;

    // --- PENCEREYİ HAPİSTEN KURTAR ---
    const modalEl = document.getElementById('productModal');
    if(modalEl) {
        document.body.appendChild(modalEl); // En dışa taşı
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
    }
}

    window.stokDegis = function(miktar) {
        const inp = document.getElementById("prodStock");
        let val = Number(inp.value) || 0;
        val += miktar;
        if(val < 0) val = 0;
        inp.value = val;
    }
// --- ÜRÜN KAYDETME (KDV DAHİL) ---
document.getElementById("productForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("prodId").value;
    const data = {
        coopId: currentCoopId,
        code: document.getElementById("prodCode").value || "",
        name: document.getElementById("prodName").value,
        category: document.getElementById("prodCat").value,
        unit: document.getElementById("prodUnit").value,
        buyPrice: Number(document.getElementById("prodBuy").value),
        sellPrice: Number(document.getElementById("prodSell").value),
        tax: Number(document.getElementById("prodTax").value), // YENİ: KDV KAYDI
        stock: Number(document.getElementById("prodStock").value)
    };

    try {
        if(id) {
            await updateDoc(doc(db, "products", id), data);
            Swal.fire({icon:'success', title:'Güncellendi', timer:1000, showConfirmButton:false});
        } else {
            await addDoc(collection(db, "products"), data);
            Swal.fire({icon:'success', title:'Ürün Eklendi', timer:1000, showConfirmButton:false});
        }
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
    } catch (error) {
        console.error(error);
    }
});
   
// --- ÜRÜN DÜZENLEME (KDV GETİRİR) ---
window.urunDuzenle = function(id) {
    const p = allProducts.find(x => x.id === id);
    if(!p) return;

    // Verileri Doldur
    document.getElementById("prodId").value = p.id;
    document.getElementById("prodCode").value = p.code || ""; 
    document.getElementById("prodName").value = p.name;
    document.getElementById("prodCat").value = p.category;
    document.getElementById("prodUnit").value = p.unit;
    document.getElementById("prodBuy").value = p.buyPrice;
    document.getElementById("prodSell").value = p.sellPrice;
    document.getElementById("prodTax").value = p.tax || 0; // YENİ: KDV'Yİ SEÇ
    document.getElementById("prodStock").value = p.stock;

    // Pencereyi Aç
    const modalEl = document.getElementById('productModal');
    if(modalEl) {
        document.body.appendChild(modalEl);
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
    }
}
    
    window.urunSil = async function(id) {
        if((await Swal.fire({title:'Silinsin mi?', icon:'warning', showCancelButton:true})).isConfirmed) {
            await deleteDoc(doc(db, "products", id));
        }
    }
// --- SÜT LİSTESİNİ GETİR (SAPIK ANALİZLİ / FARK GÖSTERGELİ) ---
    window.sutListesiniGetir = async function(aramaYapilsinMi = false) {
        if(!currentCoopId) return;

        const tbody = document.getElementById("milkTableBody");
        if(!tbody) return; 
        
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4"><div class="spinner-border text-primary spinner-border-sm"></div> Veriler ve Analizler Yükleniyor...</td></tr>';

        // Girdileri Al
        const tarihInput = document.getElementById("sutAramaTarih");
        const uyeSelect = document.getElementById("sutAramaUye");
        
        let q;

        // --- SORGULARI HAZIRLA ---
        if (!aramaYapilsinMi) {
            if(tarihInput) tarihInput.value = ""; 
            if(uyeSelect) uyeSelect.value = "";
            
            // Varsayılan: Son 50 Kayıt
            q = query(collection(db, "milk_records"), where("coopId", "==", currentCoopId), orderBy("date", "desc"), limit(50));
        } else {
            const secilenUyeId = uyeSelect ? uyeSelect.value : "";
            const secilenTarihVal = tarihInput ? tarihInput.value : "";

            let constraints = [where("coopId", "==", currentCoopId)];

            if (secilenUyeId) constraints.push(where("memberId", "==", secilenUyeId));
            
            if (secilenTarihVal) {
                const sDate = new Date(secilenTarihVal); sDate.setHours(0,0,0,0);
                const eDate = new Date(secilenTarihVal); eDate.setHours(23,59,59,999);
                constraints.push(where("date", ">=", sDate));
                constraints.push(where("date", "<=", eDate));
            }
            
            constraints.push(orderBy("date", "desc"));
            if(!secilenTarihVal && secilenUyeId) constraints.push(limit(50)); // Sadece üye seçildiyse son 50

            q = query(collection(db, "milk_records"), ...constraints);
        }

        // --- VERİYİ ÇEK VE ANALİZ ET ---
        try {
            const snapshot = await getDocs(q); // onSnapshot yerine getDocs (Analiz için daha iyi)
            
            if(snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-muted fw-bold">Kayıt bulunamadı.</td></tr>';
                return;
            }

            // 1. Önce Listedeki Tarihlerin "Bir Gün Öncesini" Bul
            // Böylece sadece gerekli geçmiş veriyi çekeriz (Performans)
            let neededDates = new Set();
            let currentData = [];

            snapshot.forEach(doc => {
                const data = doc.data();
                data.docId = doc.id; // ID'yi sakla
                currentData.push(data);

                // Bu kaydın tarihi
                const recDate = data.date.toDate();
                // Bir gün öncesini hesapla
                const prevDate = new Date(recDate);
                prevDate.setDate(recDate.getDate() - 1);
                
                // Tarih formatı: YYYY-MM-DD (Sorgu için)
                const prevDateString = prevDate.toISOString().split('T')[0];
                neededDates.add(prevDateString);
            });

            // 2. Geçmiş Verileri Toplu Çek (REFERANS VERİSİ)
            // Performans notu: Tek tek sorgu atmak yerine, tarih aralığı kullanıyoruz.
            let referenceMap = {}; // { 'memberId_tarih_donem': litre }

            if (currentData.length > 0) {
                // Listedeki en eski ve en yeni tarihin 1 gün öncesini bulup aralık çekelim
                // (Basitlik adına: Eğer tarih seçiliyse tek bir sorgu yeter, değilse son 50 için karışık olabilir)
                // Şimdilik "Tarih Seçili" modunda %100 çalışır, karışık listede sadece denk gelirse çalışır.
                
                // Daha garanti yöntem: Eğer listede 100 kayıt varsa, veritabanını yormamak için 
                // sadece "Tarih Araması" yapıldığında analiz yapalım.
                // Eğer "Son 50" listesindeysek, analiz yapmayalım (veya sadece hafızadakileri kullanalım).
                
                // STRATEJİ: Referans verisini sadece tarih seçiliyse çek.
                if (tarihInput && tarihInput.value) {
                    const t = new Date(tarihInput.value);
                    t.setDate(t.getDate() - 1); // Dün
                    const sD = new Date(t); sD.setHours(0,0,0,0);
                    const eD = new Date(t); eD.setHours(23,59,59,999);

                    const refQ = query(
                        collection(db, "milk_records"), 
                        where("coopId", "==", currentCoopId),
                        where("date", ">=", sD),
                        where("date", "<=", eD)
                    );
                    const refSnap = await getDocs(refQ);
                    
                    refSnap.forEach(rDoc => {
                        const rData = rDoc.data();
                        // Anahtar: UyeID_Sabah (Tarih zaten dünün tarihi)
                        const key = `${rData.memberId}_${rData.period}`;
                        referenceMap[key] = Number(rData.liters);
                    });
                }
            }

            // 3. Tabloyu Oluştur
            tbody.innerHTML = "";
            
            currentData.forEach(data => {
                const dateObj = data.date.toDate();
                const tarih = dateObj.toLocaleDateString('tr-TR');
                const saat = dateObj.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});

                let donemBadge = data.period === 'sabah' 
                    ? '<span class="badge bg-warning text-dark"><i class="fa-regular fa-sun me-1"></i>Sabah</span>'
                    : '<span class="badge bg-primary"><i class="fa-regular fa-moon me-1"></i>Akşam</span>';

                let durum = data.isProcessed 
                    ? '<span class="badge bg-success"><i class="fa-solid fa-check me-1"></i>Hesaplandı</span>'
                    : '<span class="badge bg-light text-secondary border">Bekliyor</span>';

                const toplayanKisi = data.driverName || 'Driver';
                let temizIsim = data.memberName ? data.memberName.replace(/^[0-9]+\s*-\s*/, '') : 'İsimsiz';

                // --- FARK HESABI ---
                let farkHTML = "";
                // Sadece tarih seçiliyse hesapla (Referans haritası doluysa)
                if (Object.keys(referenceMap).length > 0) {
                    const key = `${data.memberId}_${data.period}`;
                    const dunkuLitre = referenceMap[key];
                    const bugunkuLitre = Number(data.liters);

                    if (dunkuLitre !== undefined) {
                        const fark = bugunkuLitre - dunkuLitre;
                        if (fark > 0) {
                            farkHTML = `<span class="diff-badge diff-up" title="Düne göre +${fark.toFixed(1)} Lt"><i class="fa-solid fa-arrow-trend-up"></i> +${fark.toFixed(1)}</span>`;
                        } else if (fark < 0) {
                            farkHTML = `<span class="diff-badge diff-down" title="Düne göre ${fark.toFixed(1)} Lt"><i class="fa-solid fa-arrow-trend-down"></i> ${fark.toFixed(1)}</span>`;
                        } else {
                            farkHTML = `<span class="diff-badge diff-neutral" title="Değişim yok"><i class="fa-solid fa-minus"></i></span>`;
                        }
                    } else {
                        // Dün veri yoksa
                        farkHTML = `<span class="diff-badge diff-neutral" title="Dün kayıt yok" style="opacity:0.5"><i class="fa-solid fa-question"></i></span>`;
                    }
                }
                const tr = `
                <tr class="align-middle"> <td class="py-2 ps-3" style="white-space: nowrap;"> 
                        <span class="fw-bold text-dark">${tarih}</span>
                        <small class="text-muted ms-2 fw-normal">${saat}</small>
                    </td>
                    <td class="py-2"><div class="fw-bold text-dark">${temizIsim}</div></td>
                    <td class="py-2 text-muted small"><i class="fa-solid fa-truck-fast me-1"></i>${toplayanKisi}</td>
                    <td class="py-2 text-center">${donemBadge}</td>
                    
                    <td class="py-2 text-center">
                        <span class="fs-6 fw-bold text-dark">${data.liters}</span> <small class="text-muted">Lt</small>
                    </td>

                    <td class="py-2 text-center">
                        ${farkHTML}
                    </td>

                    <td class="py-2 text-end">${durum}</td>
                    <td class="py-2 text-end">
                        ${!data.isProcessed ? `
                        <button class="btn btn-sm btn-light text-primary border me-1 py-0 px-2" onclick="sutDuzenle('${data.docId}', '${data.liters}', '${temizIsim}')" style="height: 28px;"><i class="fa-solid fa-pen small"></i></button>
                        <button class="btn btn-sm btn-light text-danger border py-0 px-2" onclick="sutKaydiSil('${data.docId}')" style="height: 28px;"><i class="fa-solid fa-trash small"></i></button>
                        ` : ''}
                    </td>
                </tr>`;

                tbody.innerHTML += tr;
            });

        } catch (error) {
            console.error("Hata:", error);
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger p-4">Veri yüklenirken hata oluştu.</td></tr>';
        }
    }

    // --- SÜT KAYDI DÜZENLEME ---
    window.sutDuzenle = async function(docId, mevcutLitre, isim) {
        const { value: yeniLitre } = await Swal.fire({
            title: 'Süt Miktarını Düzenle',
            text: isim,
            input: 'number',
            inputValue: mevcutLitre,
            showCancelButton: true,
            confirmButtonText: 'Güncelle',
            cancelButtonText: 'İptal',
            inputAttributes: { step: '0.1', min: '0' }
        });

        if (yeniLitre && yeniLitre !== mevcutLitre) {
            try {
                await updateDoc(doc(db, "milk_records", docId), {
                    liters: Number(yeniLitre)
                });
                Swal.fire({
                    toast: true, position: 'top-end', 
                    icon: 'success', title: 'Güncellendi', 
                    timer: 1500, showConfirmButton: false
                });
            } catch (error) {
                Swal.fire("Hata", "Güncellenemedi: " + error.message, "error");
            }
        }
    }

   window.sutKaydiSil = async function(id) {
         if((await Swal.fire({title:'Silinsin mi?', text:'Bu süt kaydı silinecek.', icon:'warning', showCancelButton:true})).isConfirmed) {
            await deleteDoc(doc(db, "milk_records", id));
            Swal.fire({toast:true, position:'top-end', icon:'success', title:'Silindi', timer:1000, showConfirmButton:false});
        }
    }
    
    // Hızlı Tahsilat (Hızlı İşlemler İçin)
window.hizliTahsilatBaslat = async function() {
    // 1. Tüm üyeleri selectbox için hazırla
    let options = {};
    // allMembers global değişkeni zaten dolu
    allMembers.forEach(m => {
        options[m.id] = `${m.ad} ${m.soyad}`;
    });

    // 2. SweetAlert ile Üye Seçtir
    const { value: memberId } = await Swal.fire({
        title: 'Kimden Tahsilat Yapılacak?',
        input: 'select',
        inputOptions: options,
        inputPlaceholder: 'Üye Seçiniz...',
        showCancelButton: true,
        confirmButtonText: 'Devam Et'
    });

    if (memberId) {
        // 3. Seçilen üyeyi "Aktif" yap (Arka planda)
        activeMemberId = memberId; 
        // 4. Tahsilat pencresini aç
        islemEkle('tahsilat');
    }
}
// --- ANA SAYFA HIZLI FATURA (ARAMALI VERSİYON) ---
    window.hizliFaturaBaslat = async function() {
        if (!allMembers || allMembers.length === 0) {
            Swal.fire("Uyarı", "Üye listesi henüz yüklenmedi veya boş.", "warning");
            return;
        }

        // Listeyi isme göre sırala
        const siraliUyeler = [...allMembers].sort((a,b) => a.ad.localeCompare(b.ad, 'tr'));

        // SweetAlert ile Özel HTML Açıyoruz
        const { value: memberId } = await Swal.fire({
            title: 'Fatura Kime Kesilecek?',
            html: `
                <div class="mb-2 text-start">
                    <label class="small fw-bold text-muted">Hızlı Arama</label>
                    <input type="text" id="swal-search" class="form-control" placeholder="İsim yazmaya başlayın..." autocomplete="off">
                </div>
                <div class="text-start">
                    <label class="small fw-bold text-muted">Üye Seçimi</label>
                    <select id="swal-select" class="form-select" size="5" style="overflow-y: auto">
                        </select>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Seç ve Devam Et',
            cancelButtonText: 'İptal',
            confirmButtonColor: '#2563eb',
            didOpen: () => {
                const searchInp = Swal.getPopup().querySelector('#swal-search');
                const selectBox = Swal.getPopup().querySelector('#swal-select');

                // 1. Listeyi Doldurma Fonksiyonu
                function listeyiDoldur(filtre = "") {
                    selectBox.innerHTML = ""; // Temizle
                    
                    // Türkçe karakter uyumlu arama (lowercase çevrimi)
                    const aranan = filtre.toLocaleLowerCase('tr');

                    const filtrelenmis = siraliUyeler.filter(m => {
                        const tamAd = `${m.ad} ${m.soyad}`.toLocaleLowerCase('tr');
                        return tamAd.includes(aranan);
                    });

                    if(filtrelenmis.length === 0) {
                        selectBox.innerHTML = '<option disabled>Sonuç bulunamadı...</option>';
                        return;
                    }

                    filtrelenmis.forEach((m, index) => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.text = `${m.ad} ${m.soyad} (${m.koy || '-'})`;
                        // İlk sıradakini veya tek kalan sonucu otomatik seçili yapabiliriz (opsiyonel)
                        if(index === 0) opt.selected = true;
                        selectBox.appendChild(opt);
                    });
                }

                // İlk açılışta hepsini göster
                listeyiDoldur();

                // 2. Arama Kutusuna Yazıldıkça Filtrele
                searchInp.addEventListener('input', (e) => {
                    listeyiDoldur(e.target.value);
                });

                // Arama kutusuna odaklan
                searchInp.focus();
                
                // Listeden çift tıklayınca direkt onayla
                selectBox.addEventListener('dblclick', () => {
                    Swal.clickConfirm();
                });
            },
            preConfirm: () => {
                const selectBox = Swal.getPopup().querySelector('#swal-select');
                const selectedVal = selectBox.value;
                if (!selectedVal) {
                    Swal.showValidationMessage('Lütfen listeden bir üye seçiniz');
                }
                return selectedVal;
            }
        });

        // Seçim Yapıldıysa İşleme Devam Et
        if (memberId) {
            activeMemberId = memberId; 
            const secilenUye = allMembers.find(m => m.id === memberId);
            const uyeAdi = secilenUye ? `${secilenUye.ad} ${secilenUye.soyad}` : '';

            if(typeof yeniEvrakModalAc === 'function'){
                yeniEvrakModalAc();
                setTimeout(() => {
                    const baslik = document.getElementById("modalBaslik");
                    if(baslik) baslik.innerHTML = `<i class="fa-solid fa-user-tag me-2"></i>${uyeAdi} - Yeni Fatura`;
                }, 200);
            }
        }
    }

    // --- 2. ARAMALI HIZLI TAHSİLAT FONKSİYONU ---
    window.hizliTahsilatBaslat = async function() {
        if (!allMembers || allMembers.length === 0) {
            Swal.fire("Uyarı", "Üye listesi boş.", "warning");
            return;
        }

        const siraliUyeler = [...allMembers].sort((a,b) => a.ad.localeCompare(b.ad, 'tr'));

        const { value: memberId } = await Swal.fire({
            title: 'Kimden Tahsilat Yapılacak?',
            html: `
                <div class="mb-2 text-start">
                    <label class="small fw-bold text-muted">Müşteri Ara</label>
                    <input type="text" id="swal-search-t" class="form-control" placeholder="İsim yazın..." autocomplete="off">
                </div>
                <div class="text-start">
                    <select id="swal-select-t" class="form-select" size="5" style="overflow-y: auto">
                    </select>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Devam Et',
            confirmButtonColor: '#16a34a', // Yeşil buton
            didOpen: () => {
                const searchInp = Swal.getPopup().querySelector('#swal-search-t');
                const selectBox = Swal.getPopup().querySelector('#swal-select-t');

                function listeyiDoldur(filtre = "") {
                    selectBox.innerHTML = "";
                    const aranan = filtre.toLocaleLowerCase('tr');
                    const filtrelenmis = siraliUyeler.filter(m => `${m.ad} ${m.soyad}`.toLocaleLowerCase('tr').includes(aranan));
                    
                    if(filtrelenmis.length === 0) {
                        selectBox.innerHTML = '<option disabled>Kayıt yok...</option>'; return;
                    }
                    filtrelenmis.forEach((m, i) => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.text = `${m.ad} ${m.soyad}`;
                        if(i===0) opt.selected = true;
                        selectBox.appendChild(opt);
                    });
                }
                listeyiDoldur();
                searchInp.addEventListener('input', (e) => listeyiDoldur(e.target.value));
                searchInp.focus();
                selectBox.addEventListener('dblclick', () => Swal.clickConfirm());
            },
            preConfirm: () => {
                const val = Swal.getPopup().querySelector('#swal-select-t').value;
                return val || Swal.showValidationMessage('Kişi seçiniz');
            }
        });

        if (memberId) {
            activeMemberId = memberId; 
            islemEkle('tahsilat');
        }
    }
    
    // --- 3. ARAMALI HIZLI ÖDEME FONKSİYONU (YENİ) ---
    window.hizliOdemeBaslat = async function() {
        if (!allMembers || allMembers.length === 0) {
            Swal.fire("Uyarı", "Üye listesi boş.", "warning");
            return;
        }

        const siraliUyeler = [...allMembers].sort((a,b) => a.ad.localeCompare(b.ad, 'tr'));

        const { value: memberId } = await Swal.fire({
            title: 'Kime Ödeme Yapılacak?',
            html: `
                <div class="mb-2 text-start">
                    <label class="small fw-bold text-muted">Müşteri Ara</label>
                    <input type="text" id="swal-search-o" class="form-control" placeholder="İsim yazın..." autocomplete="off">
                </div>
                <div class="text-start">
                    <select id="swal-select-o" class="form-select" size="5" style="overflow-y: auto">
                    </select>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Devam Et',
            confirmButtonColor: '#f97316', // Turuncu/Kırmızı Buton
            didOpen: () => {
                const searchInp = Swal.getPopup().querySelector('#swal-search-o');
                const selectBox = Swal.getPopup().querySelector('#swal-select-o');

                function listeyiDoldur(filtre = "") {
                    selectBox.innerHTML = "";
                    const aranan = filtre.toLocaleLowerCase('tr');
                    const filtrelenmis = siraliUyeler.filter(m => `${m.ad} ${m.soyad}`.toLocaleLowerCase('tr').includes(aranan));
                    
                    if(filtrelenmis.length === 0) {
                        selectBox.innerHTML = '<option disabled>Kayıt yok...</option>'; return;
                    }
                    filtrelenmis.forEach((m, i) => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.text = `${m.ad} ${m.soyad}`;
                        if(i===0) opt.selected = true;
                        selectBox.appendChild(opt);
                    });
                }
                listeyiDoldur();
                searchInp.addEventListener('input', (e) => listeyiDoldur(e.target.value));
                searchInp.focus();
                selectBox.addEventListener('dblclick', () => Swal.clickConfirm());
            },
            preConfirm: () => {
                const val = Swal.getPopup().querySelector('#swal-select-o').value;
                return val || Swal.showValidationMessage('Kişi seçiniz');
            }
        });

        if (memberId) {
            activeMemberId = memberId; 
            islemEkle('odeme'); // Ödeme modalını tetikler
        }
    }



    window.filtreDegisti = function() {
        const val = document.getElementById("pubFilterType").value;
        document.getElementById("divPubVillage").classList.add("d-none");
        document.getElementById("divPubMember").classList.add("d-none");
        
        if(val === 'village') document.getElementById("divPubVillage").classList.remove("d-none");
        if(val === 'single') document.getElementById("divPubMember").classList.remove("d-none");
    }
// --- GÜNCELLENMİŞ HESAP YAYINLA (FATURA İÇERİĞİ VE NAKİT AYRIMI) ---
    window.hesapYayinla = async function(e) {
        e.preventDefault();
        
        const monthStr = document.getElementById("pubMonth").value;
        const filterType = document.getElementById("pubFilterType").value;
        const selVillage = document.getElementById("pubVillageSelect").value;
        const selMember = document.getElementById("pubMemberSelect").value;

        if(!monthStr) { Swal.fire("Hata", "Lütfen dönem seçiniz.", "warning"); return; }

        // Tarih Aralığı
        const [year, month] = monthStr.split("-").map(Number);
        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 0, 23, 59, 59);
        
        let targets = [];
        if(filterType === 'all') targets = allMembers;
        else if(filterType === 'village') targets = allMembers.filter(m => m.koy === selVillage);
        else if(filterType === 'single') targets = allMembers.filter(m => m.id === selMember);

        if(targets.length === 0) { Swal.fire("Hata", "Seçilen kriterde üye bulunamadı.", "warning"); return; }

        Swal.fire({title: 'Detaylı Ekstre Hazırlanıyor...', text: 'Fatura içerikleri ayrıştırılıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

        try {
            const coopDoc = await getDoc(doc(db, "cooperatives", currentCoopId));
            const currentPrice = coopDoc.exists() ? (coopDoc.data().milkPrice || 0) : 0;
            const batch = writeBatch(db);
            let count = 0;

            // Süt Kayıtlarını Çek
            const qMilk = query(
                collection(db, "milk_records"), 
                where("coopId", "==", currentCoopId),
                where("date", ">=", startDate),
                where("date", "<=", endDate)
            );
            const milkSnap = await getDocs(qMilk);
            let milkDataByMember = {};
            milkSnap.forEach(doc => {
                const d = doc.data();
                if(!milkDataByMember[d.memberId]) milkDataByMember[d.memberId] = [];
                milkDataByMember[d.memberId].push(d);
            });

            for (const member of targets) {
                // 1. SÜT LİSTESİ (AYLIK TOPLAM TEK SATIR)
                let rawMilkList = milkDataByMember[member.id] || [];
                let toplamSabah = 0;
                let toplamAksam = 0;
                rawMilkList.forEach(rec => {
                    if(rec.period === 'sabah') toplamSabah += Number(rec.liters);
                    else toplamAksam += Number(rec.liters);
                });
                let toplamLitre = toplamSabah + toplamAksam;
                let sutTutar = toplamLitre * currentPrice;

                let sutDetayListesi = [];
                if (toplamLitre > 0) {
                    sutDetayListesi.push({
                        tarih: endDate.toLocaleDateString('tr-TR'),
                        aciklama: 'Aylık Toplam Süt Bedeli',
                        sabah: toplamSabah,
                        aksam: toplamAksam,
                        fiyat: currentPrice,
                        tutar: sutTutar
                    });
                }

                // 2. FİNANSAL HAREKETLER
                const qTrans = query(collection(db, "transactions"), where("memberId", "==", member.id), orderBy("date", "asc"));
                const transSnap = await getDocs(qTrans);
                
                let devirBakiye = 0;
                let donemSutAlacagi = 0;
                let donemSatisBorcu = 0;
                let donemNakitAlacagi = 0; 
                
                let satisListesi = []; // Bölüm 2: Mal/Hizmet (Detaylı)
                let nakitListesi = []; // Bölüm 3: Nakit ve Diğer

                transSnap.forEach(doc => {
                    const t = doc.data();
                    const tDate = t.date.toDate();
                    const miktar = Number(t.amount);
                    const kategori = t.category || '';

                    // Devir Hesabı
                    if (tDate < startDate) {
                        if(t.type === 'borc') devirBakiye += miktar;
                        else devirBakiye -= miktar;
                    } 
                    // Bu Ayın Hareketleri
                    else if (tDate <= endDate) {
                        
                        // A) SÜT ALACAKLARI (Hesaplama için)
                        if (kategori === 'Süt Bedeli' || kategori === 'E-Müstahsil Makbuzu') {
                            donemSutAlacagi += miktar; 
                        } 
                        
                        // B) BORÇ İŞLEMLERİ (Satışlar ve Nakit Ödemeler)
                        else if (t.type === 'borc') {
                            
                            // EĞER "NAKİT ÖDEME", "AVANS", "EFT" İSE -> BÖLÜM 3'E GİDER
                            if (kategori.includes('Nakit') || kategori.includes('Ödeme') || kategori.includes('Avans') || kategori.includes('Eft')) {
                                nakitListesi.push({ date: tDate, desc: t.description, amount: miktar, type: 'borc' });
                                donemNakitAlacagi -= miktar; // Bakiye hesabında borç etkisi (eksi bakiye)
                            }
                            // AKSİ HALDE BU BİR MAL SATIŞIDIR -> BÖLÜM 2'YE (ÜRÜN BAZLI) GİDER
                            else {
                                // Eğer ürün detayları varsa (items), bunları parçala
                                if (t.items && t.items.length > 0) {
                                    t.items.forEach(item => {
                                        satisListesi.push({
                                            date: tDate,
                                            name: item.name,       // Ürün Adı
                                            price: item.price,     // Birim Fiyat
                                            amount: item.total,    // Satır Toplamı
                                            unit: item.unit,
                                            qty: item.qty
                                        });
                                    });
                                } else {
                                    // Detay yoksa (Eski kayıt), tek satır ekle
                                    satisListesi.push({
                                        date: tDate,
                                        name: t.description || kategori,
                                        price: miktar, // Adet fiyatı belli değil, toplamı yaz
                                        amount: miktar,
                                        unit: 'Adet',
                                        qty: 1
                                    });
                                }
                                donemSatisBorcu += miktar;
                            }
                        } 
                        
                        // C) ALACAK İŞLEMLERİ (Tahsilat vb.) -> BÖLÜM 3
                        else {
                            nakitListesi.push({ date: tDate, desc: t.description, amount: miktar, type: t.type });
                            donemNakitAlacagi += miktar;
                        }
                    }
                });

                // Sonuç Bakiye Hesapla
                // Formül: Devir + (Satışlar + NakitÇıkışları) - (Süt + NakitGirişleri)
                // Not: Yukarıda donemNakitAlacagi değişkenini net nakit akışı olarak kullandım.
                
                let toplamBorc = (devirBakiye > 0 ? devirBakiye : 0) + donemSatisBorcu;
                // Nakit ödemeler (Borç tipindekiler) donemNakitAlacagi içinde negatif olarak tutulduğu için
                // Burada toplamAlacak hesabına dikkat etmeliyiz.
                // Basit matematik: Bakiye = Devir + Borçlar - Alacaklar
                
                // Tekrar net hesap:
                let netBakiye = devirBakiye - donemSutAlacagi - donemNakitAlacagi - donemSatisBorcu;
                // Düzeltme: donemSatisBorcu (borç artırır, pozitiftir ama bakiye düşer).
                // Firebase yapımızda: Borç (+) ise üye borçlanır. Alacak (+) ise üye alacaklanır.
                // Üye Bakiyesi = Borçlar - Alacaklar
                
                // Borçlar Toplamı:
                let sumBorc = 0;
                transSnap.forEach(doc => { 
                    const d=doc.data(); 
                    if(d.date.toDate() <= endDate) {
                       if(d.type==='borc') sumBorc += Number(d.amount);
                    }
                });
                
                // Alacaklar Toplamı:
                let sumAlacak = 0;
                transSnap.forEach(doc => { 
                    const d=doc.data(); 
                    if(d.date.toDate() <= endDate) {
                       if(d.type==='alacak') sumAlacak += Number(d.amount);
                    }
                });
                
                let sonucBakiye = sumBorc - sumAlacak;

                const statementData = {
                    memberId: member.id,
                    memberName: `${member.ad} ${member.soyad}`,
                    coopId: currentCoopId,
                    period: monthStr,
                    createdAt: new Date(),
                    devirBakiye: devirBakiye,
                    
                    sutListesi: sutDetayListesi, 
                    sutToplam: donemSutAlacagi,  
                    
                    satisListesi: satisListesi, // ARTIK ÜRÜN DETAYLI
                    satisToplam: donemSatisBorcu,
                    nakitListesi: nakitListesi, // ARTIK NAKİT ÖDEMELER BURADA
                    nakitToplam: donemNakitAlacagi,
                    sonucBakiye: sonucBakiye
                };

                const docId = `${member.id}_${monthStr}`;
                const ref = doc(db, "monthly_statements", docId);
                batch.set(ref, statementData);
                count++;
            }

            await batch.commit();
            if(document.getElementById('yayinlaModal')) bootstrap.Modal.getInstance(document.getElementById('yayinlaModal')).hide();
            Swal.fire("Başarılı", `${count} üretici için detaylı ekstre yayınlandı.`, "success");

        } catch (error) {
            console.error(error);
            Swal.fire("Hata", error.message, "error");
        }
    }

window.hesapYayinlaModalAc = function() {
    console.log("Yayınla Modalı (FIX VERSİYON) açılıyor...");
    const modalEl = document.getElementById('yayinlaModal');
    
    if(modalEl) {
        // 1. PENCEREYİ HAPİSTEN KURTAR (Body'e taşı)
        document.body.appendChild(modalEl); 
        
        // 2. Tarihi Ayarla
        const d = new Date();
        d.setMonth(d.getMonth() - 1); // Geçen ay
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dateInput = document.getElementById("pubMonth");
        if(dateInput) dateInput.value = `${yyyy}-${mm}`;

        // 3. Listeleri Doldur (Hafızadaki verilerle)
        // Köy listesi
        const vilSel = document.getElementById("pubVillageSelect");
        if(vilSel && typeof villageList !== 'undefined') {
            vilSel.innerHTML = "";
            villageList.forEach(v => {
                const opt = document.createElement("option");
                opt.value = v; opt.text = v;
                vilSel.appendChild(opt);
            });
        }
        // Üye listesi
        const memSel = document.getElementById("pubMemberSelect");
        if(memSel && typeof allMembers !== 'undefined') {
            memSel.innerHTML = "";
             [...allMembers].sort((a,b) => a.ad.localeCompare(b.ad)).forEach(m => {
                const opt = document.createElement("option");
                opt.value = m.id; opt.text = `${m.ad} ${m.soyad}`;
                memSel.appendChild(opt);
            });
        }

        // 4. Modalı Aç
        const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
        modalInstance.show();
    } else {
        alert("Hata: yayinlaModal bulunamadı!");
    }
}

window.sutHesaplaModalAc = function() {
    console.log("Süt Hesapla (FIX VERSİYON) açılıyor...");
    const modalEl = document.getElementById('sutHesaplaModal');

    if(modalEl) {
        // 1. PENCEREYİ HAPİSTEN KURTAR (Body'e taşı)
        document.body.appendChild(modalEl);

        // 2. Tarihleri Ayarla
        const bugun = new Date();
        const yediGunOnce = new Date();
        yediGunOnce.setDate(bugun.getDate() - 7);

        const dateStart = document.getElementById("calcStartDate");
        const dateEnd = document.getElementById("calcEndDate");
        if(dateStart && dateEnd) {
            dateEnd.valueAsDate = bugun;
            dateStart.valueAsDate = yediGunOnce;
        }
        
        // 3. Fiyat kutusunu temizle
        if(document.getElementById("calcPrice")) document.getElementById("calcPrice").value = "";
        
        // 4. Açıklama güncelle
        if(typeof otomatikAciklamaGuncelle === 'function') otomatikAciklamaGuncelle();

        // 5. Modalı Aç
        const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
        modalInstance.show();
    }
}

// 1. DÖNEM HESABI YAYINLA (GÜNCELLENDİ: ARTIK GÜNCEL AY GELİYOR)
window.hesapYayinlamaModalAc = function() {
    console.log("Yayınla Modalı açılıyor...");
    
    const modalEl = document.getElementById('yayinlaModal');
    if(!modalEl) { alert("Hata: yayinlaModal bulunamadı!"); return; }

    // Pencereyi en dışa taşı (Z-Index sorunu için)
    document.body.appendChild(modalEl); 

    // --- TARİH AYARI (GÜNCEL AY) ---
    const d = new Date();
    // d.setMonth(d.getMonth() - 1);  <-- BU SATIRI KALDIRDIK
    
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    
    const dateInput = document.getElementById("pubMonth");
    if(dateInput) dateInput.value = `${yyyy}-${mm}`; // Artık bugünün ayı seçili gelir

    // Köy Listesini Doldur
    const vilSel = document.getElementById("pubVillageSelect");
    if(vilSel && typeof villageList !== 'undefined') {
        vilSel.innerHTML = "";
        villageList.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v; opt.text = v;
            vilSel.appendChild(opt);
        });
    }

    // Üye Listesini Doldur
    const memSel = document.getElementById("pubMemberSelect");
    if(memSel && typeof allMembers !== 'undefined') {
        memSel.innerHTML = "";
        [...allMembers].sort((a,b) => a.ad.localeCompare(b.ad)).forEach(m => {
            const opt = document.createElement("option");
            opt.value = m.id; opt.text = `${m.ad} ${m.soyad}`;
            memSel.appendChild(opt);
        });
    }

    // Pencereyi Aç
    const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
    modalInstance.show();
}

// 2. SÜT HESAPLAMA (İsim düzeltildi: sutHesaplaMA...)
window.sutHesaplamaModalAc = function() {
    console.log("Süt Hesapla Modalı (FIX) açılıyor...");
    
    const modalEl = document.getElementById('sutHesaplaModal');
    if(!modalEl) { alert("Hata: sutHesaplaModal bulunamadı!"); return; }

    // --- SİHİRLİ SATIR: Pencereyi en dışa taşı ---
    document.body.appendChild(modalEl);
    // -------------------------------------------

    // Tarihleri Ayarla
    const bugun = new Date();
    const yediGunOnce = new Date();
    yediGunOnce.setDate(bugun.getDate() - 7);

    const dateStart = document.getElementById("calcStartDate");
    const dateEnd = document.getElementById("calcEndDate");
    if(dateStart && dateEnd) {
        dateEnd.valueAsDate = bugun;
        dateStart.valueAsDate = yediGunOnce;
    }
    
    // Fiyatı Temizle
    if(document.getElementById("calcPrice")) document.getElementById("calcPrice").value = "";
    
    // Açıklamayı Güncelle
    if(typeof otomatikAciklamaGuncelle === 'function') otomatikAciklamaGuncelle();

    // Pencereyi Aç
    const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
    modalInstance.show();
}
  
// --- SÜT HESAPLAMA (GÜNCELLENMİŞ: Ay Kontrolü + Bitiş Tarihine Kayıt) ---
document.addEventListener("DOMContentLoaded", () => {
    
    const form = document.getElementById("sutHesapForm");
    
    if (form) {
        form.onsubmit = async function(e) {
            e.preventDefault();

            // 1. Verileri Al
            const startVal = document.getElementById("calcStartDate").value;
            const endVal = document.getElementById("calcEndDate").value;
            const priceVal = document.getElementById("calcPrice").value;
            
            // Vergi Oranını Al
            const taxInput = document.getElementById("calcTax");
            const taxRate = taxInput ? (Number(taxInput.value) || 0) : 0;

            // --- KURAL 1: AY KONTROLÜ ---
            const d1 = new Date(startVal);
            const d2 = new Date(endVal);

            if(d1.getMonth() !== d2.getMonth() || d1.getFullYear() !== d2.getFullYear()) {
                Swal.fire({
                    icon: 'error',
                    title: 'Hatalı Tarih Aralığı',
                    text: 'İki farklı ay arasında toplu işlem yapılamaz! Lütfen başlangıç ve bitiş tarihini aynı ay içerisinde seçiniz.',
                    target: document.getElementById('sutHesaplaModal')
                });
                return;
            }
            // ---------------------------

            // 2. Fiyat Kontrolü
            const price = Number(priceVal);
            if (!price || price <= 0) {
                Swal.fire({ icon: 'warning', title: 'Fiyat Girmediniz!', text: 'Lütfen Litre Fiyatı giriniz.', target: document.getElementById('sutHesaplaModal') });
                return;
            }

            // 3. Onay İste
            const confirm = await Swal.fire({
                title: 'İşlem Onayı',
                html: `
                    <div class="text-start fs-6">
                        <p><strong>Dönem:</strong> ${startVal.split('-').reverse().join('.')} - ${endVal.split('-').reverse().join('.')}</p>
                        <p><strong>Birim Fiyat:</strong> <span class="text-primary fw-bold">${price} TL</span></p>
                        <p><strong>Vergi/KDV:</strong> %${taxRate}</p>
                        <hr>
                        <span class="text-danger fw-bold">DİKKAT:</span> İşlem tarihi olarak <u>${endVal.split('-').reverse().join('.')}</u> baz alınacaktır.
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Evet, Kes',
                confirmButtonColor: '#198754',
                cancelButtonText: 'Vazgeç'
            });

            if (!confirm.isConfirmed) return;

            // 4. İşlemi Başlat
            Swal.fire({title: 'Hesaplanıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

            try {
                const startDate = new Date(startVal); startDate.setHours(0, 0, 0, 0);
                
                // Bitiş Tarihini Ayarla
                const endDate = new Date(endVal); endDate.setHours(23, 59, 59, 999);

                // --- KURAL 2: İŞLEM TARİHİ OLARAK BİTİŞ TARİHİNİ AL ---
                const islemTarihi = new Date(endVal);
                islemTarihi.setHours(12, 0, 0, 0); // Saat 12 yapalım ki gün kaymasın
                // -------------------------------------------------------

                const batch = writeBatch(db);
                
                const q = query(
                    collection(db, "milk_records"),
                    where("coopId", "==", currentCoopId),
                    where("date", ">=", startDate),
                    where("date", "<=", endDate)
                );

                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    Swal.fire("Uyarı", "Bu tarihler arasında süt kaydı bulunamadı.", "info");
                    return;
                }

                // Verileri Grupla
                let memberData = {}; 
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.isProcessed === true) return; 

                    if (!memberData[data.memberId]) {
                        memberData[data.memberId] = { sabah: 0, aksam: 0, docs: [] };
                    }

                    const miktar = Number(data.liters);
                    if(data.period === 'sabah') memberData[data.memberId].sabah += miktar;
                    else memberData[data.memberId].aksam += miktar;
                    
                    memberData[data.memberId].docs.push(doc.id);
                });

                let islemSayisi = 0;

                // Makbuz Kes
                for (const [memId, val] of Object.entries(memberData)) {
                    if ((val.sabah + val.aksam) <= 0) continue;

                    let faturaSatirlari = [];
                    let genelToplam = 0;

                    // 1. Sabah Satırı
                    if (val.sabah > 0) {
                        const matrah = val.sabah * price;
                        const vergiTutar = matrah * (taxRate / 100);
                        const satirToplam = matrah + vergiTutar;

                        faturaSatirlari.push({
                            code: "SUT-S",
                            name: "Sabah Sütü",
                            qty: val.sabah,
                            unit: "Lt", 
                            price: price,
                            taxRate: taxRate,
                            total: satirToplam 
                        });
                        genelToplam += satirToplam;
                    }

                    // 2. Akşam Satırı
                    if (val.aksam > 0) {
                        const matrah = val.aksam * price;
                        const vergiTutar = matrah * (taxRate / 100);
                        const satirToplam = matrah + vergiTutar;

                        faturaSatirlari.push({
                            code: "SUT-A",
                            name: "Akşam Sütü",
                            qty: val.aksam,
                            unit: "Lt",
                            price: price,
                            taxRate: taxRate,
                            total: satirToplam
                        });
                        genelToplam += satirToplam;
                    }

                    const belgeNo = "M-" + new Date().getTime().toString().substring(8); 
                    
                    // Açıklama Tarih Formatı (01.11.2025 - 30.11.2025 gibi)
                    const descTarih = `${startVal.split('-').reverse().join('.')} / ${endVal.split('-').reverse().join('.')}`;

                    const transRef = doc(collection(db, "transactions"));
                    batch.set(transRef, {
                        memberId: memId,
                        coopId: currentCoopId,
                        type: 'alacak',
                        category: 'E-Müstahsil Makbuzu',
                        description: `Süt Bedeli (${descTarih})`,
                        amount: genelToplam,
                        date: islemTarihi, // YENİ: Bitiş tarihini kullanıyoruz
                        belgeNo: belgeNo,
                        items: faturaSatirlari,
                        isTaxInclusive: false
                    });
                    const uyeRef = doc(db, "members", memId);
                    batch.update(uyeRef, { 
                        guncelBakiye: increment(-genelToplam) // E-Müstahsil toplamı kadar düş
                    });
                    val.docs.forEach(docId => {
                        const milkRef = doc(db, "milk_records", docId);
                        batch.update(milkRef, { isProcessed: true });
                    });
                    
                    islemSayisi++;
                }

                if(islemSayisi === 0) {
                    Swal.fire("Bilgi", "Seçilen kayıtlar daha önce hesaplanmış.", "info");
                } else {
                    await batch.commit();
                    const modalEl = document.getElementById('sutHesaplaModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalEl);
                    if(modalInstance) modalInstance.hide();
                    
                    Swal.fire({ icon: 'success', title: 'Başarılı', text: `${islemSayisi} adet E-Müstahsil Makbuzu oluşturuldu.`, confirmButtonText: 'Tamam' });
                }

            } catch (error) {
                console.error(error);
                Swal.fire("Hata", error.message, "error");
            }
        };
    }
});

// 1. Fiyatı Veritabanına Kaydet
window.sutFiyatiKaydet = async function() {
    const fiyat = document.getElementById("settingMilkPrice").value;
    if(!fiyat || Number(fiyat) <= 0) {
        Swal.fire("Hata", "Lütfen geçerli bir fiyat girin.", "warning");
        return;
    }

    try {
        // Şirket ayarlarına 'milkPrice' olarak kaydet
        const ref = doc(db, "cooperatives", currentCoopId);
        await updateDoc(ref, { milkPrice: Number(fiyat) });
        
        Swal.fire({
            icon: 'success',
            title: 'Fiyat Güncellendi',
            text: `Süt fiyatı ${fiyat} ₺ olarak ayarlandı. Hesaplama ekranına otomatik gelecek.`,
            timer: 2000,
            showConfirmButton: false
        });
    } catch(e) {
        console.error(e);
        Swal.fire("Hata", "Kaydedilemedi: " + e.message, "error");
    }
}

// 2. Sayfa Açılınca Fiyatı Getir (Mevcut sirketBilgileriniDinle içine entegre edildi)
// Bu kod, mevcut dinleyiciye ekleme yapar gibi çalışır
const originalSirketDinle = window.sirketBilgileriniDinle; // Eski fonksiyonu sakla (varsa)

// Mevcut sirketBilgileriniDinle fonksiyonunu biraz "hack"leyerek genişletiyoruz
// Eğer yukarıdaki kodlarda bu fonksiyon varsa, içine şu mantığı eklemen yeterli:
/*
   if (data.milkPrice) {
       // 1. Ayarlar sayfasındaki kutuyu doldur
       if(document.getElementById("settingMilkPrice")) 
          document.getElementById("settingMilkPrice").value = data.milkPrice;
       
       // 2. Hesaplama Modalı'ndaki kutuyu doldur
       if(document.getElementById("calcPrice")) 
          document.getElementById("calcPrice").value = data.milkPrice;
   }
*/

// VEYA direkt çalışan şu kodu en alta ekle (Otomatik çalışır):
setTimeout(() => {
    if(currentCoopId) {
        onSnapshot(doc(db, "cooperatives", currentCoopId), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.milkPrice) {
                    console.log("Kayıtlı Fiyat Geldi:", data.milkPrice);
                    // Ayarlar sayfasını doldur
                    const setInp = document.getElementById("settingMilkPrice");
                    if(setInp) setInp.value = data.milkPrice;
                    
                    // Hesaplama modalını doldur (Burası işini kolaylaştıracak)
                    const calcInp = document.getElementById("calcPrice");
                    if(calcInp) calcInp.value = data.milkPrice;
                }
            }
        });
    }
}, 3000); 

window.islemiGeriAlBaslat = async function() {
    // Modalı kapat
    const modalEl = document.getElementById('sutHesaplaModal');
    if(modalEl) bootstrap.Modal.getInstance(modalEl).hide();

    Swal.fire({title: 'İşlemler Taranıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

    try {
        const q = query(
            collection(db, "transactions"),
            where("coopId", "==", currentCoopId),
            orderBy("createdAt", "desc"),
            limit(100)
        );

        const snapshot = await getDocs(q);
        let batches = {};

        snapshot.forEach(doc => {
            const data = doc.data();
            // BatchId'si olan Süt/Müstahsil işlemlerini al
            if (data.batchId && (data.category === 'Süt Bedeli' || data.category === 'E-Müstahsil Makbuzu')) {
                if (!batches[data.batchId]) {
                    batches[data.batchId] = {
                        id: data.batchId,
                        desc: data.description,
                        date: data.createdAt.toDate(),
                        totalAmount: 0,
                        count: 0
                    };
                }
                batches[data.batchId].totalAmount += Number(data.amount);
                batches[data.batchId].count++;
            }
        });

        Swal.close();
        const batchList = Object.values(batches);

        if (batchList.length === 0) {
            Swal.fire("Kayıt Yok", "Geri alınabilecek akıllı işlem bulunamadı.", "warning");
            return;
        }

        // --- HTML LİSTESİ (GÜNCELLENDİ: DETAY BUTONU EKLENDİ) ---
        let htmlContent = '<div class="list-group text-start">';
        batchList.forEach(b => {
            const tarih = b.date.toLocaleString('tr-TR');
            const tutar = b.totalAmount.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            
            htmlContent += `
                <div class="list-group-item p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">${tarih}</small>
                        <span class="badge bg-light text-dark border">${b.count} Kişi</span>
                    </div>
                    <p class="mb-2 fw-bold text-dark">${b.desc} <br> <span class="text-primary">${tutar} ₺</span></p>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="partiDetaylariniGoster('${b.id}', '${b.desc}')">
                            <i class="fa-solid fa-users-viewfinder me-1"></i> Kişi Seç / Düzenle
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="seciliIslemiSil('${b.id}')">
                            <i class="fa-solid fa-trash-can"></i> Tümü
                        </button>
                    </div>
                </div>
            `;
        });
        htmlContent += '</div>';

        Swal.fire({
            title: 'İşlem Seçimi',
            html: htmlContent,
            showConfirmButton: false,
            showCloseButton: true,
            width: '600px'
        });

    } catch (error) {
        console.error(error);
        Swal.fire("Hata", error.message, "error");
    }
}

window.partiDetaylariniGoster = async function(batchId, baslik) {
    Swal.fire({title: 'Kişiler Yükleniyor...', didOpen:()=>Swal.showLoading()});

    try {
        // O partiye ait tüm cari kayıtlarını çek
        const q = query(
            collection(db, "transactions"),
            where("batchId", "==", batchId)
        );
        const snapshot = await getDocs(q);
        
        let kisiListesiHTML = '<div class="list-group text-start" style="max-height: 400px; overflow-y: auto;">';
        
        // Üye ismine göre sıralamak için önce diziye atalım
        let docs = [];
        snapshot.forEach(doc => {
            // Üye adını bulmak için transaction içine "memberName" eklemediysek, 
            // şimdilik üyeleri ID'den bulmamız zor olabilir. 
            // Ancak genellikle transaction açıklamasında isim yazmazsak da 
            // bu fonksiyonu admin.html içinde allMembers dizisini kullanarak eşleştirebiliriz.
            
            const data = doc.data();
            // allMembers global değişkeninden ismi bulalım
            const uye = allMembers.find(m => m.id === data.memberId);
            const adSoyad = uye ? `${uye.ad} ${uye.soyad}` : 'Bilinmeyen Üye';
            
            docs.push({
                docId: doc.id,
                memberId: data.memberId,
                adSoyad: adSoyad,
                tutar: Number(data.amount),
                batchId: batchId
            });
        });

        // İsme göre sırala
        docs.sort((a,b) => a.adSoyad.localeCompare(b.adSoyad));

        if(docs.length === 0) {
            Swal.fire("Boş", "Bu partide kayıt kalmamış.", "info");
            return;
        }

        docs.forEach(item => {
            kisiListesiHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center p-2">
                    <div>
                        <div class="fw-bold small">${item.adSoyad}</div>
                        <div class="text-success small fw-bold">${item.tutar.toLocaleString('tr-TR')} ₺</div>
                    </div>
                    <button class="btn btn-sm btn-light text-danger border" onclick="tekilUyeGeriAl('${item.docId}', '${item.batchId}', '${item.memberId}', '${item.adSoyad}')">
                        <i class="fa-solid fa-rotate-left"></i> Geri Al
                    </button>
                </div>
            `;
        });
        kisiListesiHTML += '</div>';

        Swal.fire({
            title: baslik,
            text: 'Sadece hatalı olan kişinin işlemini geri alabilirsiniz.',
            html: kisiListesiHTML,
            showConfirmButton: false,
            showCloseButton: true,
            width: '500px'
        });

    } catch (error) {
        console.error(error);
        Swal.fire("Hata", error.message, "error");
    }
}


window.tekilUyeGeriAl = async function(docId, batchId, memberId, adSoyad) {
    const confirm = await Swal.fire({
        title: 'Sadece Bu Kişi mi?',
        html: `<b>${adSoyad}</b> isimli üreticinin hesaplaması silinecek ve süt kayıtları tekrar düzenlenebilir hale gelecek.<br><br>Diğer üyeler etkilenmeyecek.`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Evet, Sadece Bunu Geri Al',
        confirmButtonColor: '#d33'
    });

    if(!confirm.isConfirmed) return;

    Swal.fire({title: 'İşleniyor...', didOpen:()=>Swal.showLoading()});

    try {
        const batch = writeBatch(db);

        // 1. O kişinin Cari Fişini Sil
        const transRef = doc(db, "transactions", docId);
        batch.delete(transRef);

        // 2. O kişinin, O Partiye ait Sütlerinin Kilidini Aç
        // (Sadece processedBatchId'si bu olanlar)
        const qMilk = query(
            collection(db, "milk_records"),
            where("processedBatchId", "==", batchId),
            where("memberId", "==", memberId)
        );
        
        const milkSnap = await getDocs(qMilk);
        let count = 0;
        
        milkSnap.forEach(milkDoc => {
            batch.update(milkDoc.ref, { 
                isProcessed: false, 
                processedBatchId: null 
            });
            count++;
        });

        await batch.commit();

        // --- EKLENEN KISIM BAŞLANGIÇ ---
        // Arka plandaki listeyi yenile
        if(typeof sutListesiniGetir === 'function') {
            sutListesiniGetir(true); 
        }
        // --- EKLENEN KISIM BİTİŞ ---

        Swal.fire({
            icon: 'success',
            title: 'Düzeltildi',
            text: `${adSoyad} için işlem geri alındı. ${count} adet süt kaydı serbest bırakıldı.`,
            timer: 2000,
            showConfirmButton: false
        }).then(() => {
        });

    } catch (error) {
        console.error(error);
        Swal.fire("Hata", "İşlem başarısız: " + error.message, "error");
    }
}
// --- SEÇİLEN PARTİYİ KOMPLE SİLME FONKSİYONU ---
window.seciliIslemiSil = async function(batchId) {
    const confirm = await Swal.fire({
        title: 'Tümünü Silmek İstiyor musunuz?',
        text: "Bu işlem grubundaki TÜM üyelerin hesaplamaları silinecek ve ilgili süt kayıtlarının kilitleri açılacak.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Evet, Hepsini Geri Al',
        confirmButtonColor: '#d33',
        cancelButtonText: 'Vazgeç'
    });

    if(!confirm.isConfirmed) return;

    Swal.fire({title: 'Geri Alınıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

    try {
        const batch = writeBatch(db);
        let deletedCount = 0;
        let unlockedCount = 0;

        // 1. Bu partiye ait Cari Hareketlerini (Fişleri) Sil
        const qTrans = query(
            collection(db, "transactions"),
            where("batchId", "==", batchId)
        );
        const transSnap = await getDocs(qTrans);
        transSnap.forEach(doc => {
            batch.delete(doc.ref);
            deletedCount++;
        });

        // 2. Bu partiye ait Süt Kayıtlarının Kilidini Aç
        const qMilk = query(
            collection(db, "milk_records"),
            where("processedBatchId", "==", batchId)
        );
        const milkSnap = await getDocs(qMilk);
        milkSnap.forEach(doc => {
            batch.update(doc.ref, { 
                isProcessed: false,
                processedBatchId: null // Bağı kopar
            });
            unlockedCount++;
        });

        // İşlemi Uygula
        await batch.commit();

        // --- EKLENEN KISIM BAŞLANGIÇ ---
        // Listeyi anında güncelle
        if(typeof sutListesiniGetir === 'function') {
            sutListesiniGetir(true); 
        }
        // --- EKLENEN KISIM BİTİŞ ---

        Swal.fire({
            icon: 'success',
            title: 'Başarılı',
            text: `${deletedCount} adet fiş silindi, ${unlockedCount} adet süt kaydı tekrar işleme açıldı.`
        });

        // Eğer liste açıksa kapatabiliriz veya yenileyebiliriz
        // (Opsiyonel) Listeyi kapatmak için:
        // Swal.close(); 

    } catch (error) {
        console.error(error);
        Swal.fire("Hata", "Silme işlemi başarısız: " + error.message, "error");
    }
}
// --- SEÇİLEN PARTİYİ SİLME VE KİLİTLERİ AÇMA ---
window.seciliPartiyiSil = async function(batchId) {
    const confirm = await Swal.fire({
        title: 'Emin misiniz?',
        text: "Bu işleme ait tüm cariler silinecek ve ilgili süt kayıtlarının kilidi açılacak.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Evet, Geri Al',
        confirmButtonColor: '#d33'
    });

    if(!confirm.isConfirmed) return;

    Swal.fire({title: 'Geri Alınıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

    try {
        const batch = writeBatch(db);
        let deletedCount = 0;
        let unlockedCount = 0;

        // 1. CARİ HAREKETLERİNİ BUL VE SİL (Transaction)
        const qTrans = query(
            collection(db, "transactions"),
            where("batchId", "==", batchId)
        );
        const transSnap = await getDocs(qTrans);
        transSnap.forEach(doc => {
            batch.delete(doc.ref);
            deletedCount++;
        });

        // 2. SÜT KAYITLARINI BUL VE KİLİDİ AÇ (isProcessed = false)
        const qMilk = query(
            collection(db, "milk_records"),
            where("processedBatchId", "==", batchId)
        );
        const milkSnap = await getDocs(qMilk);
        milkSnap.forEach(doc => {
            batch.update(doc.ref, { 
                isProcessed: false,
                processedBatchId: null // Bağı kopar
            });
            unlockedCount++;
        });

        // Hepsini uygula
        await batch.commit();

        Swal.fire({
            icon: 'success',
            title: 'İşlem Geri Alındı',
            text: `${deletedCount} cari kaydı silindi, ${unlockedCount} süt kaydı tekrar işleme açıldı.`
        });

    } catch (error) {
        console.error(error);
        Swal.fire("Hata", "Silme işlemi başarısız: " + error.message, "error");
    }
}
// --- YAYINLANAN HESAP EKSTRESİNİ SİLME (AKILLI KONTROL VERSİYONU) ---
window.yayiniKaldir = async function() {
    const monthStr = document.getElementById("pubMonth").value;
    const filterType = document.getElementById("pubFilterType").value;
    const selVillage = document.getElementById("pubVillageSelect").value;
    const selMember = document.getElementById("pubMemberSelect").value;

    if(!monthStr) { Swal.fire("Hata", "Lütfen dönem seçiniz.", "warning"); return; }

    // 1. Hedef Üyeleri Listeden Bul
    let potentialTargets = [];
    if(filterType === 'all') potentialTargets = allMembers;
    else if(filterType === 'village') potentialTargets = allMembers.filter(m => m.koy === selVillage);
    else if(filterType === 'single') potentialTargets = allMembers.filter(m => m.id === selMember);

    if(potentialTargets.length === 0) { Swal.fire("Hata", "Seçilen kriterde üye yok.", "warning"); return; }

    // --- YENİLİK: ÖNCE VERİTABANINI KONTROL ET ---
    Swal.fire({title: 'Kontrol Ediliyor...', text: 'Yayınlanmış raporlar taranıyor.', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

    try {
        // Sadece o aya ait raporları çek
        const q = query(
            collection(db, "monthly_statements"),
            where("coopId", "==", currentCoopId),
            where("period", "==", monthStr)
        );
        const snapshot = await getDocs(q);
        
        // Bu raporlardan hangileri bizim seçtiğimiz üyelere ait?
        let silinecekBelgeler = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            // Eğer raporun sahibi, bizim hedef listemizde varsa silinecekler listesine ekle
            if (potentialTargets.some(member => member.id === data.memberId)) {
                silinecekBelgeler.push(doc.ref);
            }
        });

        Swal.close(); // Yükleniyor'u kapat

        // --- SONUÇ KONTROLÜ ---
        if (silinecekBelgeler.length === 0) {
            Swal.fire({
                icon: 'info',
                title: 'Rapor Bulunamadı',
                text: `${monthStr} dönemi için silinecek yayınlanmış bir rapor yok. Zaten geri çekilmiş olabilir.`
            });
            return;
        }

        // --- ONAY İSTE (GERÇEK SAYI İLE) ---
        const confirm = await Swal.fire({
            title: 'Emin misiniz?',
            html: `
                <div class="text-danger">
                    Bu işlem geri alınamaz!<br><br>
                    Bulunan <b>${silinecekBelgeler.length}</b> adet hesap ekstresi silinecek.
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Evet, Hepsini Sil',
            confirmButtonColor: '#d33',
            cancelButtonText: 'Vazgeç'
        });

        if (!confirm.isConfirmed) return;

        // --- SİLME İŞLEMİ ---
        Swal.fire({title: 'Siliniyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        
        const batch = writeBatch(db);
        silinecekBelgeler.forEach(ref => {
            batch.delete(ref);
        });

        await batch.commit();
        
        // Modalı Kapat
        const modalEl = document.getElementById('yayinlaModal');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if(modalInstance) modalInstance.hide();
        
        Swal.fire("Başarılı", `${silinecekBelgeler.length} adet rapor yayından kaldırıldı.`, "success");

    } catch (error) {
        console.error(error);
        Swal.fire("Hata", "İşlem hatası: " + error.message, "error");
    }
}
// --- CARİ SEKME DEĞİŞTİRME FONKSİYONU ---
    window.cariTabDegistir = function(tip, element) {
        // 1. Tipi güncelle (Global değişkene ata)
        aktifCariTipi = tip;

        // 2. Sayfayı 'members' olarak aç
        if(typeof switchTab === 'function') {
            switchTab('members', element);
        }

        // 3. Başlığı ve Butonu Güncelle
        const titleEl = document.getElementById('lblListTitle');
        const btnEl = document.getElementById('btnAddMember');
        
        if(titleEl) titleEl.innerText = (tip === 'musteri') ? 'Müşteri Listesi' : 'Tedarikçi Listesi';
        
        if(btnEl) {
            btnEl.innerHTML = `<i class="fa-solid fa-plus me-1"></i> Yeni ${tip === 'musteri' ? 'Müşteri' : 'Tedarikçi'}`;
        }

        // 4. Listeyi hemen filtrele ve çiz
        if(typeof listeyiFiltreleVeCiz === 'function') {
            listeyiFiltreleVeCiz();
        }
    };
    
    // --- EXCEL DIŞA AKTAR (EXPORT) - OPTİMİZE EDİLDİ ---
    window.excelDisariAktar = async function() {
        if (!allMembers || allMembers.length === 0) {
            Swal.fire("Uyarı", "Listelenecek veri yok.", "warning");
            return;
        }

        Swal.fire({title: 'Excel Modülü Hazırlanıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        
        // Kütüphaneyi şimdi yüklüyoruz (Lazy Load)
        await kututuphaneYukle("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js");

        const exportData = allMembers
            .filter(m => m.tip === aktifCariTipi)
            .map(m => ({
                "Sıra No": m.sira || "",
                "Ad": m.ad || "",
                "Soyad": m.soyad || "",
                "TC/Vergi No": m.tc || "",
                "Telefon": m.telefon || "",
                "Bölge/Köy": m.koy || "",
                "Tip": m.tip === 'musteri' ? 'Müşteri' : 'Tedarikçi'
            }));

        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Üyeler");

        const turAdi = aktifCariTipi === 'musteri' ? 'Musteri_Listesi' : 'Tedarikci_Listesi';
        XLSX.writeFile(workbook, `${turAdi}_${new Date().toISOString().slice(0,10)}.xlsx`);
        
        Swal.close();
    }

    // --- EXCEL İÇE AKTAR (IMPORT) TETİKLEYİCİ ---
    window.excelIceriAktarClick = function() {
        // Dosya seçiciyi aç
        document.getElementById('excelFileInput').click();
    }

    window.excelDosyasiOku = async function(input) {
        const file = input.files[0];
        if (!file) return;

        Swal.fire({title: 'Excel Okunuyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        
        // Kütüphaneyi şimdi yüklüyoruz
        await kututuphaneYukle("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js");

        const reader = new FileReader();
        reader.onload = async function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);

            Swal.close(); // Yükleme ekranını kapat, onay sor

            if (jsonData.length === 0) {
                Swal.fire("Hata", "Excel dosyası boş veya okunamadı.", "error");
                return;
            }

            const confirm = await Swal.fire({
                title: 'Veriler Yüklensin mi?',
                text: `${jsonData.length} adet kayıt bulundu.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Evet, Yükle'
            });

            if (!confirm.isConfirmed) {
                input.value = ""; 
                return;
            }
            
            // ... (Kalan yükleme mantığı aynı, burayı değiştirmenize gerek yok, sadece üst kısmı değiştirin) ...
            // Eğer isterseniz eski kodun `try...catch` bloğunu buraya yapıştırabilirsiniz.
            // Ama kolaylık olsun diye devamını aşağıya yazıyorum:
            
            Swal.fire({title: 'Veritabanına Yazılıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
            try {
                const batch = writeBatch(db);
                let count = 0;
                jsonData.forEach((row) => {
                    const ad = row["Ad"] || row["ad"] || row["AD"] || "";
                    const soyad = row["Soyad"] || row["soyad"] || row["SOYAD"] || "";
                    if(!ad) return;
                    const yeniUye = {
                        sira: Number(row["Sıra No"] || row["sira"] || 0),
                        ad: String(ad).trim(),
                        soyad: String(soyad).trim(),
                        tc: String(row["TC/Vergi No"] || row["tc"] || ""),
                        telefon: String(row["Telefon"] || row["telefon"] || ""),
                        koy: String(row["Bölge/Köy"] || row["koy"] || "Merkez"),
                        tip: aktifCariTipi,
                        coopId: currentCoopId,
                        kayitTarihi: new Date()
                    };
                    const docRef = doc(collection(db, "members"));
                    batch.set(docRef, yeniUye);
                    count++;
                });
                await batch.commit();
                input.value = "";
                Swal.fire("Başarılı", `${count} kişi eklendi.`, "success");
            } catch (error) {
                console.error(error);
                Swal.fire("Hata", error.message, "error");
            }
        };
        reader.readAsArrayBuffer(file);
    }
    // --- TOPLU İŞLEM FONKSİYONLARI ---

    // 1. Tümünü Seç / Kaldır
    window.tumunuSec = function(master) {
        const checkboxes = document.querySelectorAll('.member-checkbox');
        checkboxes.forEach(cb => cb.checked = master.checked);
        secimKontrol();
    }

    // 2. Seçim Sayısını Kontrol Et ve Butonu Göster
    window.secimKontrol = function() {
        const checkboxes = document.querySelectorAll('.member-checkbox:checked');
        const count = checkboxes.length;
        const btn = document.getElementById("btnDeleteSelected");
        const countSpan = document.getElementById("selectedCount");
        
        if(count > 0) {
            btn.classList.remove("d-none");
            countSpan.innerText = count;
        } else {
            btn.classList.add("d-none");
        }
    }

    // 3. Seçilenleri Sil (Batch İşlemi)
    window.secilenleriSil = async function() {
        const checkboxes = document.querySelectorAll('.member-checkbox:checked');
        const idList = Array.from(checkboxes).map(cb => cb.value);

        if(idList.length === 0) return;

        const confirm = await Swal.fire({
            title: 'Emin misiniz?',
            text: `${idList.length} adet kayıt KALICI OLARAK silinecek!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Evet, Hepsini Sil'
        });

        if (confirm.isConfirmed) {
            Swal.fire({title: 'Siliniyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

            try {
                const batch = writeBatch(db);
                
                idList.forEach(id => {
                    const ref = doc(db, "members", id);
                    batch.delete(ref);
                });

                await batch.commit();
                
                Swal.fire("Başarılı", "Seçilen kayıtlar silindi.", "success");
                
                // Seçim butonunu gizle
                document.getElementById("btnDeleteSelected").classList.add("d-none");
                document.getElementById("selectAllMembers").checked = false;

            } catch (error) {
                console.error(error);
                Swal.fire("Hata", "Silme işleminde sorun oluştu: " + error.message, "error");
            }
        }
    }
    // --- MOBİL MENÜ FONKSİYONLARI ---
    window.toggleSidebar = function() {
        document.querySelector('.sidebar').classList.toggle('active');
        document.querySelector('.sidebar-overlay').classList.toggle('active');
    }

    window.closeSidebar = function() {
        document.querySelector('.sidebar').classList.remove('active');
        document.querySelector('.sidebar-overlay').classList.remove('active');
    }
   

    // --- 1. GELİŞMİŞ MÜŞTERİ ARAMA (TÜM SONUÇLARI GÖSTERİR) ---
    const repSearchInput = document.getElementById('repMemberSearch');
    const repResultsDiv = document.getElementById('repMemberSearchResults');
    const repHiddenId = document.getElementById('repSelectedMemberId');

    if(repSearchInput) {
        // 1. Yazı yazıldıkça çalışır
        repSearchInput.addEventListener('input', function() {
            const val = this.value.toLocaleLowerCase('tr').trim(); // Türkçe karakter uyumlu küçültme
            repResultsDiv.innerHTML = ''; // Önceki sonuçları temizle
            
            // Eğer kutu boşsa listeyi gizle
            if(val.length === 0) {
                repResultsDiv.style.display = 'none';
                return;
            }

            // 2. Filtreleme (İsim veya Soyad içinde aranan kelime var mı?)
            // 'allMembers' listesi sistem açıldığında otomatik yükleniyor.
            const matches = allMembers.filter(m => {
                const tamAd = `${m.ad} ${m.soyad}`.toLocaleLowerCase('tr');
                return tamAd.includes(val);
            });

            // 3. Sonuçları Ekrana Bas
            if(matches.length > 0) {
                matches.forEach(m => {
                    const item = document.createElement('a');
                    item.className = 'list-group-item list-group-item-action border-0 py-2 px-3 d-flex align-items-center';
                    item.style.cursor = 'pointer';
                    item.style.borderBottom = '1px solid #f1f5f9'; // Hafif çizgi
                    
                   item.innerHTML = `
    <div class="d-flex align-items-center w-100 bg-white">
        <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; flex-shrink: 0;">
            <i class="fa-solid fa-user"></i>
        </div>
        <div class="text-start">
            <div class="fw-bold text-dark mb-0" style="font-size: 1rem; line-height: 1.2;">${m.ad} ${m.soyad}</div>
            <small class="text-muted"><i class="fa-solid fa-map-marker-alt me-1"></i>${m.koy || 'Merkez'}</small>
        </div>
    </div>
`;
// Ayrıca görünürlük tetikleyiciyi ekleyin
repResultsDiv.style.display = 'block';
repResultsDiv.style.zIndex = "10001";
                    
                    // Tıklayınca Seçimi Yap
                    item.onclick = function() {
                        repSearchInput.value = `${m.ad} ${m.soyad}`; // İsmi kutuya yaz
                        repHiddenId.value = m.id; // Gizli ID'yi güncelle
                        repResultsDiv.style.display = 'none'; // Listeyi kapat
                    };
                    
                    repResultsDiv.appendChild(item);
                });
                
                // Listeyi Görünür Yap
                repResultsDiv.style.display = 'block';
                
            } else {
                // Sonuç Yoksa Bilgi Ver
                repResultsDiv.innerHTML = `
                    <div class="p-3 text-center text-muted small">
                        <i class="fa-regular fa-face-frown mb-1"></i><br>
                        "${this.value}" isminde kayıt bulunamadı.
                    </div>`;
                repResultsDiv.style.display = 'block';
            }
        });

        // 4. Kutuya Tıklayınca Tekrar Aç (Doluysa)
        repSearchInput.addEventListener('click', function() {
            if(this.value.length > 0) {
                this.dispatchEvent(new Event('input'));
            }
        });

        // 5. Boşluğa Tıklayınca Kapat
        document.addEventListener('click', function(e) {
            if (e.target !== repSearchInput && !repResultsDiv.contains(e.target)) {
                repResultsDiv.style.display = 'none';
            }
        });
    }
// --- SARI UYARI KALDIRILMIŞ GÜNCEL FONKSİYON ---
window.ureticiHesapOzetiGetir = async function() {
    const memIdElement = document.getElementById("repSelectedMemberId");
    const memId = memIdElement ? memIdElement.value : null;
    
    const periodElement = document.getElementById("repAccountMonth");
    const period = periodElement ? periodElement.value : null;
    
    const container = document.getElementById("accountReportContent");

    if(!memId) { Swal.fire("Uyarı", "Lütfen listeden bir müşteri arayıp seçiniz.", "warning"); return; }
    if(!period) { Swal.fire("Uyarı", "Lütfen bir dönem seçiniz.", "warning"); return; }

    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2 text-muted">Veriler derleniyor...</div></div>';

    try {
        let data = null;

        // 1. ÖNCE YAYINLANMIŞ RAPORA BAK
        const docId = `${memId}_${period}`;
        const docRef = doc(db, "monthly_statements", docId);
        const docSnap = await getDoc(docRef);

        if(docSnap.exists()) {
            // Yayınlanmış rapor varsa onu kullan
            data = docSnap.data();
        } else {
            // 2. YAYINLANMAMIŞSA: CANLI HESAPLAMA YAP
            
            // Tarih Ayarları
            const [year, month] = period.split("-").map(Number);
            const startDate = new Date(year, month - 1, 1, 0, 0, 0);
            const endDate = new Date(year, month, 0, 23, 59, 59); // Ayın son günü

            // Gerekli Bilgileri Çek
            const [coopDoc, memDoc, milkSnap, transSnap] = await Promise.all([
                getDoc(doc(db, "cooperatives", currentCoopId)),
                getDoc(doc(db, "members", memId)),
                getDocs(query(collection(db, "milk_records"), 
                    where("memberId", "==", memId), 
                    where("date", ">=", startDate), 
                    where("date", "<=", endDate))),
                getDocs(query(collection(db, "transactions"), 
                    where("memberId", "==", memId), 
                    orderBy("date", "asc")))
            ]);

            const currentPrice = coopDoc.exists() ? (coopDoc.data().milkPrice || 0) : 0;
            const memberName = memDoc.exists() ? `${memDoc.data().ad} ${memDoc.data().soyad}` : "Bilinmeyen Üye";

            // A. SÜT VERİLERİNİ HESAPLA
            let sutSabah = 0, sutAksam = 0;
            milkSnap.forEach(doc => {
                const d = doc.data();
                if(d.period === 'sabah') sutSabah += Number(d.liters);
                else sutAksam += Number(d.liters);
            });
            const sutToplamLt = sutSabah + sutAksam;
            const sutToplamTutar = sutToplamLt * currentPrice;
            
            let sutListesi = [];
            if(sutToplamLt > 0) {
                sutListesi.push({
                    tarih: endDate.toLocaleDateString('tr-TR'),
                    aciklama: 'Aylık Toplam',
                    sabah: sutSabah, aksam: sutAksam,
                    fiyat: currentPrice, tutar: sutToplamTutar
                });
            }

            // B. CARİ HAREKETLERİ AYRIŞTIR (DEVİR ve BU AY)
            let devirBakiye = 0; 
            let satisListesi = [];
            let nakitListesi = [];
            let satisToplam = 0;
            let nakitToplam = 0;

            transSnap.forEach(tDoc => {
                const t = tDoc.data();
                const tDate = t.date.toDate();
                const miktar = Number(t.amount);
                
                // Devir Hesabı
                if (tDate < startDate) {
                    if (t.type === 'borc') devirBakiye += miktar;
                    else devirBakiye -= miktar;
                } 
                // Bu Ayın Hareketleri
                else if (tDate <= endDate) {
                    if(t.category === 'Süt Bedeli' || t.category === 'E-Müstahsil Makbuzu') return;

                    if (t.type === 'borc') {
                        if (t.category.includes('Nakit') || t.category.includes('Ödeme') || t.category.includes('Avans')) {
                            nakitListesi.push({ date: tDate, desc: t.description, amount: miktar, type: 'borc' });
                            nakitToplam -= miktar; 
                        } else {
                            satisListesi.push({
                                date: tDate,
                                name: t.description,
                                price: miktar,
                                amount: miktar,
                                qty: 1
                            });
                            satisToplam += miktar;
                        }
                    } else {
                        nakitListesi.push({ date: tDate, desc: t.description, amount: miktar, type: 'alacak' });
                        nakitToplam += miktar;
                    }
                }
            });

            // Sonuç Bakiye
            let sonucBakiye = devirBakiye - sutToplamTutar - nakitToplam + satisToplam;

            // Veriyi Oluştur
            data = {
                memberName: memberName,
                devirBakiye: devirBakiye,
                sutListesi: sutListesi,
                sutToplam: sutToplamTutar,
                satisListesi: satisListesi,
                satisToplam: satisToplam,
                nakitListesi: nakitListesi,
                nakitToplam: nakitToplam,
                sonucBakiye: sonucBakiye
            };
        }

        // --- HTML OLUŞTURMA ---
        const fmt = (num) => Number(num).toLocaleString('tr-TR', {minimumFractionDigits: 2}) + ' ₺';
        const dateFmt = (ts) => ts && ts.seconds ? new Date(ts.seconds * 1000).toLocaleDateString('tr-TR') : (ts instanceof Date ? ts.toLocaleDateString('tr-TR') : '-');

        // Tablolar
        let sutRows = data.sutListesi?.map(item => `
            <tr><td class="text-center bg-primary bg-opacity-10 fw-bold">${item.aksam || '-'}</td>
            <td class="text-center bg-warning bg-opacity-10 fw-bold">${item.sabah || '-'}</td>
            <td class="text-center fw-bold">${(Number(item.aksam)+Number(item.sabah))}</td>
            <td class="text-center small">${fmt(item.fiyat)}</td>
            <td class="text-end fw-bold text-success pe-3">${fmt(item.tutar)}</td></tr>`).join('') || '<tr><td colspan="5" class="text-center text-muted small">Kayıt yok.</td></tr>';

        let satisRows = data.satisListesi?.map(item => `
            <tr><td class="ps-3 small fw-bold">${item.name}</td>
            <td class="text-center small">${item.qty || 1}</td>
            <td class="text-end small">${fmt(item.price)}</td>
            <td class="text-end fw-bold text-danger pe-3">-${fmt(item.amount)}</td></tr>`).join('') || '<tr><td colspan="4" class="text-center text-muted small">Kayıt yok.</td></tr>';

        // Nakit Tablosu
        let totalGiren = 0, totalCikan = 0;
        let nakitRows = data.nakitListesi?.map(item => {
            let giris = '-', cikis = '-';
            if(item.type === 'alacak') { giris = fmt(item.amount); totalGiren += Number(item.amount); }
            else { cikis = fmt(item.amount); totalCikan += Number(item.amount); }
            
            return `<tr><td class="small text-muted">${dateFmt(item.date)}</td>
            <td class="small">${item.desc}</td>
            <td class="text-end bg-success bg-opacity-10 text-success fw-bold">${giris}</td>
            <td class="text-end bg-danger bg-opacity-10 text-danger fw-bold">${cikis}</td></tr>`;
        }).join('') || '<tr><td colspan="4" class="text-center text-muted small">Kayıt yok.</td></tr>';

        // Hesaplamalar
        const devir = data.devirBakiye || 0;
        const sutTutar = data.sutToplam || 0;
        const satisTutar = data.satisToplam || 0;
        const genelToplamAlacak = (devir < 0 ? Math.abs(devir) : 0) + sutTutar + totalGiren;
        const genelToplamBorc = (devir > 0 ? devir : 0) + satisTutar + totalCikan;
        
        // Net Durum (Önceki düzeltmeye sadık kalarak)
        const netDurum = data.sonucBakiye !== undefined ? data.sonucBakiye : (genelToplamBorc - genelToplamAlacak);

        // Devir HTML
        let devirHtml = `
        <div class="mb-4 rounded-3 d-flex justify-content-between align-items-center p-3" 
             style="background-color: #fff !important; border: 2px solid #e9ecef; break-inside: avoid;">
            <span class="fw-bold text-secondary text-uppercase">DÖNEM BAŞI DEVİR</span>
            <span class="fw-bold" style="font-size: 1.4rem; color: ${devir > 0 ? '#dc2626' : (devir < 0 ? '#166534' : '#64748b')} !important;">
                ${fmt(Math.abs(devir))} ${devir !== 0 ? (devir > 0 ? '<small>(BORÇLU)</small>' : '<small>(ALACAKLI)</small>') : ''}
            </span>
        </div>`;

        // Sonuç HTML
        let sonucRenk = netDurum < 0 ? '#166534' : (netDurum > 0 ? '#dc2626' : '#64748b');
        let sonucHtml = `
        <div class="p-2 text-center mt-3" 
             style="background-color: #fff !important; border: 2px solid ${sonucRenk}; border-radius: 8px; break-inside: avoid; max-width: 60%; margin-left: auto; margin-right: auto;">
            <div class="small text-uppercase fw-bold" style="color: ${sonucRenk} !important; opacity: 0.9; font-size: 0.7rem;">DÖNEM SONU NET DURUM</div>
            <div class="fw-bold" style="font-size: 1.25rem; color: ${sonucRenk} !important;">
                ${netDurum < 0 ? fmt(Math.abs(netDurum)) + ' ALACAKLI' : (netDurum > 0 ? fmt(netDurum) + ' BORÇLU' : 'HESAP KAPALI')}
            </div>
        </div>`;

        // Detay Tablo HTML
        let detayTabloHtml = `
        <div class="card border-0 mb-4 mt-4" style="border: 1px solid #e2e8f0 !important; border-radius: 12px; break-inside: avoid;">
            <div class="card-body p-4">
                <h5 class="fw-bold text-dark mb-4 small text-uppercase border-bottom pb-2">HESAPLAMA DETAYI</h5>
                <div class="row gx-5">
                    <div class="col-6" style="border-right: 1px dashed #e2e8f0;">
                        <h6 class="fw-bold mb-3" style="color: #166534 !important; font-size: 1rem;">+ ALACAKLAR (Giriş)</h6>
                        ${devir < 0 ? `<div class="d-flex justify-content-between mb-2 small w-100"><span class="text-secondary">Devir Alacağı</span><span class="fw-bold text-dark">+ ${fmt(Math.abs(devir))}</span></div>` : ''}
                        <div class="d-flex justify-content-between mb-2 small w-100"><span class="text-secondary">Süt Bedelleri</span><span class="fw-bold text-dark">+ ${fmt(sutTutar)}</span></div>
                        <div class="d-flex justify-content-between mb-3 small w-100"><span class="text-secondary">Nakit Tahsilatlar</span><span class="fw-bold text-dark">+ ${fmt(totalGiren)}</span></div>
                        <div class="p-2 rounded-3 d-flex justify-content-between align-items-center px-3 mt-3 w-100" style="background-color: #fff !important; border: 2px solid #198754; color: #198754;">
                            <span class="fw-bold small">TOPLAM ALACAK</span><span class="fw-bold fs-5">${fmt(genelToplamAlacak)}</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <h6 class="fw-bold mb-3" style="color: #dc2626 !important; font-size: 1rem;">- BORÇLAR (Çıkış)</h6>
                        ${devir > 0 ? `<div class="d-flex justify-content-between mb-2 small w-100"><span class="text-secondary">Devir Borcu</span><span class="fw-bold text-dark">- ${fmt(devir)}</span></div>` : ''}
                        <div class="d-flex justify-content-between mb-2 small w-100"><span class="text-secondary">Mal/Hizmet Satışı</span><span class="fw-bold text-dark">- ${fmt(satisTutar)}</span></div>
                        <div class="d-flex justify-content-between mb-3 small w-100"><span class="text-secondary">Ödemeler (Avans)</span><span class="fw-bold text-dark">- ${fmt(totalCikan)}</span></div>
                        <div class="p-2 rounded-3 d-flex justify-content-between align-items-center px-3 mt-3 w-100" style="background-color: #fff !important; border: 2px solid #dc2626; color: #dc2626;">
                            <span class="fw-bold small">TOPLAM BORÇ</span><span class="fw-bold fs-5">${fmt(genelToplamBorc)}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;

        // ANA ÇIKTIYI BAS (Sarı Uyarı SİLİNDİ)
        container.innerHTML = `
            <div class="bg-white p-4 rounded-4 shadow-sm border" style="max-width:100%; margin:0 auto; font-family: 'Segoe UI', sans-serif;">
                
                <div class="text-center border-bottom pb-4 mb-4">
                    <h2 class="fw-bold m-0 text-dark">${data.memberName}</h2>
                    <div class="text-muted fs-6">${period} Ekstresi</div>
                </div>
                ${devirHtml}
                
                <h6 class="fw-bold small mb-2 text-uppercase ps-1 border-bottom pb-1" style="color: #166534 !important;">1. SÜT BEDELLERİ</h6>
                <div class="table-responsive mb-4">
                    <table class="table table-sm table-striped mb-0 align-middle small w-100">
                        <thead class="table-light"><tr class="text-center"><th>Akşam</th><th>Sabah</th><th>Top.</th><th>Fiyat</th><th class="text-end">Tutar</th></tr></thead>
                        <tbody>${sutRows}</tbody>
                        <tfoot class="fw-bold" style="border-top: 2px solid #166534; color: #166534 !important;"><tr><td colspan="4" class="text-end pe-2">SÜT TOPLAMI:</td><td class="text-end pe-3">${fmt(sutTutar)}</td></tr></tfoot>
                    </table>
                </div>

                <h6 class="fw-bold small mb-2 text-uppercase ps-1 border-bottom pb-1" style="color: #dc2626 !important;">2. MAL/HİZMET ALIMLARI</h6>
                <div class="table-responsive mb-4">
                    <table class="table table-sm table-striped mb-0 align-middle small w-100">
                        <thead class="table-light"><tr><th>Ürün</th><th class="text-center">Miktar</th><th class="text-end">Birim F.</th><th class="text-end">Tutar</th></tr></thead>
                        <tbody>${satisRows}</tbody>
                        <tfoot class="fw-bold" style="border-top: 2px solid #dc2626; color: #dc2626 !important;"><tr><td colspan="3" class="text-end pe-2">BORÇ TOPLAMI:</td><td class="text-end pe-3">${fmt(satisTutar)}</td></tr></tfoot>
                    </table>
                </div>

                <h6 class="fw-bold small mb-2 text-uppercase ps-1 border-bottom pb-1" style="color: #64748b !important;">3. NAKİT VE DİĞER İŞLEMLER</h6>
                <div class="table-responsive mb-2">
                    <table class="table table-sm table-striped mb-0 align-middle small w-100">
                        <thead class="table-light">
                            <tr>
                                <th>Tarih</th><th>Açıklama</th>
                                <th class="text-end">Giriş <small class="text-muted fw-normal">(Tahsilat)</small></th>
                                <th class="text-end">Çıkış <small class="text-muted fw-normal">(Ödeme)</small></th>
                            </tr>
                        </thead>
                        <tbody>${nakitRows}</tbody>
                        <tfoot class="fw-bold" style="border-top: 2px solid #64748b; color: #64748b !important;">
                            <tr>
                                <td colspan="2" class="text-end pe-2">NAKİT İŞLEM TOPLAMI:</td>
                                <td class="text-end text-success pe-3">${fmt(totalGiren)}</td>
                                <td class="text-end text-danger pe-3">${fmt(totalCikan)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                ${detayTabloHtml}
                ${sonucHtml}
                
                <div class="text-center mt-5 text-muted small border-top pt-2">
                    Bu belge KoopSistem tarafından ${new Date().toLocaleDateString('tr-TR')} tarihinde oluşturulmuştur.
                </div>
            </div>`;

    } catch (error) {
        console.error(error);
        container.innerHTML = `<div class="alert alert-danger">Hata: ${error.message}</div>`;
    }
}

    // --- WHATSAPP RAPOR GÖNDERME FONKSİYONU ---
window.whatsappRaporGonder = async function() {
    const memId = document.getElementById("repSelectedMemberId").value;
    const period = document.getElementById("repAccountMonth").value;

    if (!memId || !period) {
        Swal.fire("Uyarı", "Lütfen önce üye ve dönem seçiniz.", "warning");
        return;
    }

    // 1. Üyeyi Bul
    const member = allMembers.find(m => m.id === memId);
    if (!member) { Swal.fire("Hata", "Üye bulunamadı.", "error"); return; }

    // 2. Telefon Numarasını Düzenle
    let phone = (member.telefon || "").replace(/[^0-9]/g, ''); // Sadece rakamları al
    if (phone.length < 10) {
        Swal.fire("Hata", "Üyenin kayıtlı geçerli bir telefon numarası yok.", "error");
        return;
    }
    if (phone.startsWith('0')) phone = phone.substring(1); // Baştaki 0'ı sil
    if (!phone.startsWith('90')) phone = '90' + phone;     // Başına 90 ekle

    Swal.fire({title: 'WhatsApp Açılıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

    try {
        // 3. Veritabanından Raporu Çek
        const docId = `${memId}_${period}`;
        const docRef = doc(db, "monthly_statements", docId);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
            Swal.close();
            Swal.fire("Uyarı", "Bu dönem için hesap yayınlanmamış. Önce 'Dönem Hesabı Yayınla' işlemi yapın.", "warning");
            return;
        }

        const data = docSnap.data();
        const fmt = (num) => Number(num).toLocaleString('tr-TR', {minimumFractionDigits: 2});
        
        // Tarihi Yazıya Çevir (2025-11 -> Kasım 2025)
        const [yil, ay] = period.split('-');
        const ayAdlari = ["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];
        const donemAdi = `${ayAdlari[parseInt(ay)-1]} ${yil}`;

        // Duruma Göre Mesaj
        let bakiyeMesaji = "";
        const net = data.sonucBakiye;
        if(net > 0) bakiyeMesaji = `🟢 *ALACAKLISINIZ: ${fmt(net)} TL*`;
        else if(net < 0) bakiyeMesaji = `🔴 *BORÇLUSUNUZ: ${fmt(Math.abs(net))} TL*`;
        else bakiyeMesaji = "⚪ *HESAP KAPALI (0 TL)*";

        // 4. Mesaj Metni
        const mesaj = 
`Sayın *${data.memberName}*,
${donemAdi} dönemi hesap özetiniz:

🥛 *Süt Bedeli:* ${fmt(data.sutToplam)} TL
📦 *Yem/Malzeme:* -${fmt(data.satisToplam)} TL
💵 *Nakit/Avans:* -${fmt(data.nakitToplam)} TL
🔄 *Devir:* ${fmt(data.devirBakiye)} TL

-------------------------
${bakiyeMesaji}
-------------------------
Sağlıklı günler dileriz.`;

        // 5. Gönder
        const waUrl = `https://wa.me/${phone}?text=${encodeURIComponent(mesaj)}`;
        Swal.close();
        window.open(waUrl, '_blank');

    } catch (error) {
        console.error(error);
        Swal.fire("Hata", "Bir sorun oluştu: " + error.message, "error");
    }
}


// GLOBAL DEĞİŞKENLER
let globalBakiyeData = [];
let globalRaporTarihi = "";

// --- GÜNCELLENMİŞ RAPOR FONKSİYONU (DURUM SÜTUNLU) ---
window.genelBakiyeRaporuGetir = async function() {
    
    // 1. Filtreleri Al
    const villageSelect = document.getElementById("genBalVillageSelect");
    if (villageSelect.options.length <= 1 && typeof villageList !== 'undefined') {
        villageList.sort().forEach(v => {
            const opt = document.createElement("option");
            opt.value = v; opt.text = v;
            villageSelect.appendChild(opt);
        });
    }

    const secilenKoy = villageSelect.value;
    const durumFiltresi = document.getElementById("genBalStatusFilter").value;
    const tarihSiniriStr = document.getElementById("genBalDateLimit").value;
    
    // 2. Başlık Ayarla
    let limitDate = null;
    let baslikMetni = "Genel Bakiye Listesi (Güncel)";
    
    if (tarihSiniriStr) {
        limitDate = new Date(tarihSiniriStr);
        limitDate.setHours(23, 59, 59, 999);
        const trTarih = limitDate.toLocaleDateString('tr-TR');
        baslikMetni = `${trTarih} Tarihi İtibariyle Genel Bakiye Listesi`;
    }
    
    document.getElementById("genBalTitle").innerText = baslikMetni;
    globalRaporTarihi = baslikMetni;

    const tbody = document.getElementById("generalBalanceBody");
    // colspan="6" yaptık çünkü yeni sütun ekledik
    tbody.innerHTML = '<tr><td colspan="6" class="text-center p-5"><div class="spinner-border text-primary"></div><div class="mt-2 text-muted">Hesaplar taranıyor...</div></td></tr>';

    try {
        // 3. Verileri Çek
        let hedefUyeler = [];
        if (secilenKoy === 'all') hedefUyeler = allMembers;
        else hedefUyeler = allMembers.filter(m => m.koy === secilenKoy);

        if(hedefUyeler.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted p-4">Bu kriterde üye bulunamadı.</td></tr>';
            return;
        }

        let q;
        if (limitDate) {
            q = query(collection(db, "transactions"), where("coopId", "==", currentCoopId), where("date", "<=", limitDate));
        } else {
            q = query(collection(db, "transactions"), where("coopId", "==", currentCoopId));
        }
        
        const snapshot = await getDocs(q);

        // 4. Hesaplama
        let balances = {};
        hedefUyeler.forEach(m => {
            balances[m.id] = {
                adSoyad: `${m.ad} ${m.soyad}`,
                koy: m.koy || '-',
                borc: 0,
                alacak: 0,
                isExist: true
            };
        });

        snapshot.forEach(doc => {
            const t = doc.data();
            if (balances[t.memberId] && balances[t.memberId].isExist) {
                const miktar = Number(t.amount);
                if (t.type === 'borc') balances[t.memberId].borc += miktar;
                else balances[t.memberId].alacak += miktar;
            }
        });

        // 5. Tabloyu Doldur
        tbody.innerHTML = "";
        globalBakiyeData = [];

        let sumAlacakliBakiye = 0;
        let sumBorcluBakiye = 0;

        const sortedKeys = Object.keys(balances).sort((a, b) => balances[a].adSoyad.localeCompare(balances[b].adSoyad));
        const fmt = (num) => Number(num).toLocaleString('tr-TR', {minimumFractionDigits: 2}) + ' ₺';

        sortedKeys.forEach(uid => {
            const item = balances[uid];
            
            // Net Bakiye: Borç - Alacak
            let netVal = item.borc - item.alacak; 
            
            // Filtreleme
            if (durumFiltresi === 'borclu' && netVal <= 0) return;
            if (durumFiltresi === 'alacakli' && netVal >= 0) return;

            let netHTML = '<span class="text-muted">-</span>';
            let durumMetni = "-";
            let durumBadge = ""; // YENİ ROZET DEĞİŞKENİ

            if (netVal > 0) {
                // Borçlu
                sumBorcluBakiye += netVal;
                netHTML = `<span class="fw-bold text-danger">${fmt(netVal)}</span>`;
                durumMetni = "Borçlu";
                durumBadge = `<span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25" style="width:80px;">BORÇLU</span>`;
            } else if (netVal < 0) {
                // Alacaklı
                let absVal = Math.abs(netVal);
                sumAlacakliBakiye += absVal;
                netHTML = `<span class="fw-bold text-success">${fmt(absVal)}</span>`;
                durumMetni = "Alacaklı";
                durumBadge = `<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25" style="width:80px;">ALACAKLI</span>`;
            } else {
                netHTML = `<span class="text-dark">0,00 ₺</span>`;
                durumMetni = "Dengede";
                durumBadge = `<span class="badge bg-light text-secondary border" style="width:80px;">DENGEDE</span>`;
            }

            // Excel Verisi
            globalBakiyeData.push({
                "Üretici Adı": item.adSoyad,
                "Bölge/Köy": item.koy,
                "Toplam Borç": item.borc,
                "Toplam Alacak": item.alacak,
                "Net Bakiye": Math.abs(netVal),
                "Durum": durumMetni
            });
            
            // Tablo Satırı (YENİ SÜTUN EKLENDİ)
            tbody.innerHTML += `
                <tr>
                    <td class="ps-4 fw-bold text-dark">${item.adSoyad}</td>
                    <td><span class="badge bg-light text-secondary border">${item.koy}</span></td>
                    <td class="text-end text-danger font-monospace">${fmt(item.borc)}</td>
                    <td class="text-end text-success font-monospace">${fmt(item.alacak)}</td>
                    <td class="text-end font-monospace" style="font-size:1.1em">${netHTML}</td>
                    <td class="text-center pe-4">${durumBadge}</td>
                </tr>
            `;
        });

        if(globalBakiyeData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted p-4">Seçilen filtreye uygun kayıt bulunamadı.</td></tr>';
        }

        // --- ALT BİLGİ GÜNCELLEME (colspan=6 oldu) ---
        const footerHTML = `
            <tr class="bg-light" style="border-top: 2px solid #64748b;">
                <td colspan="6" class="p-3">
                    <div class="d-flex justify-content-end gap-4 align-items-center">
                        <div class="text-end" style="${durumFiltresi === 'borclu' ? 'opacity:0.3' : ''}">
                            <small class="text-muted d-block fw-bold">TOPLAM ALACAKLI BAKİYESİ</small>
                            <span class="text-success fs-5 fw-bold">${fmt(sumAlacakliBakiye)}</span>
                        </div>
                        <div style="width: 2px; height: 40px; background: #cbd5e1;"></div>
                        <div class="text-end" style="${durumFiltresi === 'alacakli' ? 'opacity:0.3' : ''}">
                            <small class="text-muted d-block fw-bold">TOPLAM BORÇLU BAKİYESİ</small>
                            <span class="text-danger fs-5 fw-bold">${fmt(sumBorcluBakiye)}</span>
                        </div>
                    </div>
                </td>
            </tr>
        `;
        
        let tfoot = document.getElementById("tblGeneralBalance").querySelector("tfoot");
        if(tfoot) tfoot.innerHTML = footerHTML;
        else {
            tfoot = document.createElement("tfoot");
            tfoot.innerHTML = footerHTML;
            document.getElementById("tblGeneralBalance").appendChild(tfoot);
        }

    } catch (error) {
        console.error(error);
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Hata: ${error.message}</td></tr>`;
    }
}

window.genelBakiyeExcelIndir = async function() {
        if (!globalBakiyeData || globalBakiyeData.length === 0) {
            Swal.fire("Uyarı", "İndirilecek veri yok. Lütfen önce listeleme yapınız.", "warning");
            return;
        }

        Swal.fire({title: 'Excel Hazırlanıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        
        // Kütüphaneyi şimdi yüklüyoruz
        await kututuphaneYukle("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js");

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(globalBakiyeData);

        const wscols = [{wch: 25}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 10}];
        ws['!cols'] = wscols;

        let startRow = globalBakiyeData.length + 2;
        let alacakliTop = globalBakiyeData.filter(d => d.Durum === "Alacaklı").reduce((sum, d) => sum + d["Net Bakiye"], 0);
        let borcluTop = globalBakiyeData.filter(d => d.Durum === "Borçlu").reduce((sum, d) => sum + d["Net Bakiye"], 0);

        XLSX.utils.sheet_add_aoa(ws, [
            ["", "", "", "ALACAKLI BAKİYE TOPLAMI:", alacakliTop],
            ["", "", "", "BORÇLU BAKİYE TOPLAMI:", borcluTop]
        ], {origin: -1});

        XLSX.utils.book_append_sheet(wb, ws, "Bakiye Listesi");
        const safeName = globalRaporTarihi.replace(/ /g, "_").substring(0, 50) || "Bakiye_Raporu";
        XLSX.writeFile(wb, `${safeName}.xlsx`);
        
        Swal.close();
    }
// ============================================================
// YENİ EKLENEN: TOPLU FİNANSAL İŞLEMLER (ÖDEME/TAHSİLAT)
// ============================================================

// 1. Modalı Aç ve Hazırla
window.topluFinansModalAc = function() {
    // Tarihleri ayarla
    const bugun = new Date();
    document.getElementById("tfIslemDate").valueAsDate = bugun;
    
    // Referans tarih varsayılan olarak bir önceki ayın sonu olsun
    const gecenAySonu = new Date(bugun.getFullYear(), bugun.getMonth(), 0);
    document.getElementById("tfRefDate").valueAsDate = gecenAySonu;

    // Köy listesini doldur
    const koySelect = document.getElementById("tfKoy");
    koySelect.innerHTML = '<option value="all">Tüm Rotalar</option>';
    if(typeof villageList !== 'undefined') {
        villageList.sort().forEach(v => {
            const opt = document.createElement("option");
            opt.value = v; opt.text = v;
            koySelect.appendChild(opt);
        });
    }

    // Pencereyi aç (Body'e taşıyarak)
    const modalEl = document.getElementById('topluFinansModal');
    document.body.appendChild(modalEl); 
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
}

// 2. Hesapla ve Listele
window.topluFinansListele = async function() {
    const islemTuru = document.getElementById("tfTur").value; // odeme / tahsilat
    const refDateStr = document.getElementById("tfRefDate").value;
    const koyFilter = document.getElementById("tfKoy").value;

    if(!refDateStr) { Swal.fire("Hata", "Referans tarihi seçiniz.", "warning"); return; }

    Swal.fire({title: 'Bakiyeler Hesaplanıyor...', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});

    try {
        const refDate = new Date(refDateStr);
        refDate.setHours(23, 59, 59, 999); 

        // Hedef Üyeleri Belirle
        let targets = (koyFilter === 'all') ? allMembers : allMembers.filter(m => m.koy === koyFilter);
        
        // Bakiyeleri Çek
        const q = query(
            collection(db, "transactions"), 
            where("coopId", "==", currentCoopId),
            where("date", "<=", refDate)
        );
        
        const snapshot = await getDocs(q);
        let balances = {}; 

        // Başlangıçta 0 yap
        targets.forEach(m => balances[m.id] = 0);

        snapshot.forEach(doc => {
            const t = doc.data();
            if (balances.hasOwnProperty(t.memberId)) {
                const amt = Number(t.amount);
                if (t.type === 'borc') balances[t.memberId] += amt; 
                else balances[t.memberId] -= amt; 
            }
        });

        Swal.close();

        // Tabloyu Doldur
        const tbody = document.getElementById("tfTableBody");
        tbody.innerHTML = "";
        let count = 0;

        targets.sort((a,b) => a.ad.localeCompare(b.ad));

        targets.forEach(m => {
            const bakiye = balances[m.id];
            let showRow = false;
            let onerilenTutar = 0;
            let bakiyeYazisi = "";

            if (islemTuru === 'odeme') {
                // Ödeme için: Üyenin ALACAKLI (Negatif Bakiye) olması lazım
                if (bakiye < -1) { 
                    showRow = true;
                    onerilenTutar = Math.abs(bakiye); 
                    bakiyeYazisi = `<span class="text-success fw-bold">${Math.abs(bakiye).toLocaleString('tr-TR')} ₺ (A)</span>`;
                }
            } else {
                // Tahsilat için: Üyenin BORÇLU (Pozitif Bakiye) olması lazım
                if (bakiye > 1) {
                    showRow = true;
                    onerilenTutar = bakiye;
                    bakiyeYazisi = `<span class="text-danger fw-bold">${bakiye.toLocaleString('tr-TR')} ₺ (B)</span>`;
                }
            }

            if(showRow) {
                count++;
                const islemDateTr = refDateStr.split('-').reverse().join('.');
                const desc = islemTuru === 'odeme' ? `Ödeme (${islemDateTr} Bakiye)` : `Tahsilat (${islemDateTr} Bakiye)`;

                const tr = `
                <tr id="tr-${m.id}">
                    <td class="ps-3">
                        <div class="fw-bold text-dark">${m.ad} ${m.soyad}</div>
                    </td>
                    <td><span class="badge bg-light text-secondary border">${m.koy}</span></td>
                    <td class="text-end text-muted small">${bakiyeYazisi}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm fw-bold text-center tf-amount" 
                               data-id="${m.id}" 
                               value="${Math.floor(onerilenTutar)}" 
                               step="1" oninput="topluToplamGuncelle()">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm tf-desc" 
                               value="${desc}">
                    </td>
                </tr>`;
                tbody.innerHTML += tr;
            }
        });

        if(count === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-muted">Bu kriterlere uygun bakiyeli üye bulunamadı.</td></tr>';
        }
        
        topluToplamGuncelle();

    } catch (error) {
        console.error(error);
        Swal.fire("Hata", error.message, "error");
    }
}

// 3. Alt Toplamı Canlı Güncelle
window.topluToplamGuncelle = function() {
    let total = 0;
    document.querySelectorAll('.tf-amount').forEach(inp => {
        total += Number(inp.value) || 0;
    });
    document.getElementById("tfGenelToplam").innerText = total.toLocaleString('tr-TR') + " ₺";
}

// 4. Tutarları Sıfırla
window.topluTutarSifirla = function() {
    document.querySelectorAll('.tf-amount').forEach(inp => {
        inp.value = "";
    });
    topluToplamGuncelle();
}

// 5. Kaydet
window.topluFinansKaydet = async function() {
    const islemTuru = document.getElementById("tfTur").value; 
    const islemDateStr = document.getElementById("tfIslemDate").value;
    
    if(!islemDateStr) { Swal.fire("Hata", "İşlem tarihi seçiniz.", "warning"); return; }

    let transactions = [];
    const inputs = document.querySelectorAll('.tf-amount');
    
    inputs.forEach(inp => {
        const val = Number(inp.value);
        if(val > 0) {
            const row = inp.closest('tr');
            const desc = row.querySelector('.tf-desc').value;
            const memberId = inp.getAttribute('data-id');
            transactions.push({ memberId, amount: val, desc });
        }
    });

    if(transactions.length === 0) {
        Swal.fire("Uyarı", "İşlenecek tutar girilmemiş.", "warning");
        return;
    }

    const confirm = await Swal.fire({
        title: 'Onaylıyor musunuz?',
        text: `${transactions.length} kişiye toplam ${document.getElementById("tfGenelToplam").innerText} işlem yapılacak.`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Evet, İşle',
        confirmButtonColor: '#198754'
    });

    if(!confirm.isConfirmed) return;

    Swal.fire({title: 'Kaydediliyor...', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});

    try {
        const batch = writeBatch(db);
        const batchId = "TOPLU_" + Date.now();
        const islemTarihi = new Date(islemDateStr);
        islemTarihi.setHours(12, 0, 0); 

        // Ödeme ise (Borç) tipi borc olur. Tahsilat ise (Alacak) tipi alacak olur.
        const type = islemTuru === 'odeme' ? 'borc' : 'alacak';
        const category = islemTuru === 'odeme' ? 'Toplu Ödeme' : 'Toplu Tahsilat';

        transactions.forEach(t => {
            const transRef = doc(collection(db, "transactions"));
            batch.set(transRef, {
                memberId: t.memberId,
                coopId: currentCoopId,
                type: type, 
                category: category,
                description: t.desc,
                amount: t.amount,
                date: islemTarihi,
                batchId: batchId,
                createdAt: new Date()
            });

            const uyeRef = doc(db, "members", t.memberId);
            // Ödeme (borç) ise bakiye artar, Tahsilat ise bakiye düşer
            const degisim = (islemTuru === 'odeme') ? t.amount : -t.amount; 
            batch.update(uyeRef, {
                guncelBakiye: increment(degisim)
            });
        });

        await batch.commit();
        
        bootstrap.Modal.getInstance(document.getElementById('topluFinansModal')).hide();
        Swal.fire("Başarılı", `${transactions.length} işlem kaydedildi.`, "success");
        
        // Listeyi yenile
        if(typeof listeyiFiltreleVeCiz === 'function') listeyiFiltreleVeCiz();

    } catch (error) {
        console.error(error);
        Swal.fire("Hata", error.message, "error");
    }
}
// --- KESİNTİ YÖNETİMİ (TAM HATA KORUMALI VERSİYON) ---

const varsayilanKesintiler = [
    { id: 'stopaj', ad: 'Stopaj (Gelir Vergisi)', oran: 2, aktif: true },
    { id: 'borsa', ad: 'Borsa Tescil Ücreti', oran: 0.2, aktif: true },
    { id: 'bagkur', ad: 'Bağ-Kur Primi', oran: 1, aktif: true },
    { id: 'mera', ad: 'Mera Fonu', oran: 0.1, aktif: false }
];

// 1. Yeni Kesinti Satırı Ekleme
window.yeniKesintiSatiriEkle = function(data = null) {
    const container = document.getElementById("kesintiListesiContainer");
    if (!container) return; 

    const rowId = Date.now() + Math.random().toString(16).slice(2);
    
    const ad = data ? data.ad : "";
    const oran = data ? data.oran : 0;
    const aktif = data ? (data.aktif ? "checked" : "") : "checked";
    
    // HTML Yapısı: Sınıf isimlerinin doğruluğu garanti edildi
    const html = `
    <div class="d-flex align-items-center bg-white p-2 rounded shadow-sm border kesinti-satiri" id="row-${rowId}" style="transition: all 0.2s;">
        <div class="form-check form-switch me-2" style="transform: scale(1.1);">
            <input class="form-check-input kesinti-aktif" type="checkbox" ${aktif} onchange="kesintiDurumDegisti(this)" style="cursor: pointer;">
        </div>
        
        <div class="flex-grow-1 me-2">
            <input type="text" class="form-control form-control-sm fw-bold border-0 bg-transparent kesinti-adi" value="${ad}" placeholder="Kesinti Adı" style="color: #4b5563;">
        </div>
        
        <div class="d-flex align-items-center bg-light rounded border px-2 kesinti-oran-wrapper">
            <input type="number" class="form-control form-control-sm border-0 bg-transparent fw-bold text-end text-primary kesinti-oran" value="${oran}" step="0.1" min="0" style="width: 50px; padding:0;">
            <span class="small fw-bold text-muted ms-1">%</span>
        </div>

        <button type="button" class="btn btn-sm text-secondary hover-danger ms-2" onclick="this.closest('.kesinti-satiri').remove()" title="Sil">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>`;

    container.insertAdjacentHTML('beforeend', html);
    
    // DOM'un oluşması için minik bir gecikme ile stil uygula
    setTimeout(() => {
        const newRow = document.getElementById(`row-${rowId}`);
        if (newRow) {
            const chk = newRow.querySelector('.kesinti-aktif');
            if (chk) kesintiDurumDegisti(chk);
        }
    }, 50);
}

// 2. Durum Değiştirme (HATA VERMEYEN VERSİYON)
window.kesintiDurumDegisti = function(checkbox) {
    if (!checkbox) return; 

    const row = checkbox.closest('.kesinti-satiri');
    if (!row) return;

    // Elementleri güvenli seç
    const nameInput = row.querySelector('.kesinti-adi');
    const rateWrapper = row.querySelector('.kesinti-oran-wrapper');
    const rateInput = row.querySelector('.kesinti-oran');
    
    // 1. Görsel Değişim (Pasif/Aktif)
    if (!checkbox.checked) {
        row.style.opacity = "0.6";
        row.style.backgroundColor = "#f9fafb";
        if (nameInput) nameInput.style.textDecoration = "line-through";
        if (rateWrapper) rateWrapper.style.opacity = "0.5";
    } else {
        row.style.opacity = "1";
        row.style.backgroundColor = "#fff";
        if (nameInput) nameInput.style.textDecoration = "none";
        if (rateWrapper) rateWrapper.style.opacity = "1";
    }

    // 2. Akıllı Oran Değişimi (Stopaj / Borsa)
    // Sadece 'Borsa' kelimesi geçiyorsa ve isim kutusu varsa çalışır
    if (nameInput && nameInput.value && nameInput.value.toLowerCase().includes('borsa')) {
        
        const container = document.getElementById("kesintiListesiContainer");
        if(container) {
            const allRows = container.querySelectorAll('.kesinti-satiri');
            
            allRows.forEach(r => {
                const rName = r.querySelector('.kesinti-adi');
                const rRate = r.querySelector('.kesinti-oran');
                
                if (rName && rRate && rName.value.toLowerCase().includes('stopaj')) {
                    // Borsa Aktifse -> Stopaj %1, Pasifse -> %2
                    if (checkbox.checked) {
                        rRate.value = 1;
                        rRate.style.color = "#16a34a"; // Yeşil
                    } else {
                        rRate.value = 2;
                        rRate.style.color = "#dc2626"; // Kırmızı
                    }
                    // Rengi eski haline döndür
                    setTimeout(() => { if(rRate) rRate.style.color = ""; }, 1000);
                }
            });
        }
    }
}

// 3. Modalı Açma
window.yeniUyeModalAc = function() {
    formuTemizle();
    
    const listCont = document.getElementById("kesintiListesiContainer");
    if (listCont) {
        listCont.innerHTML = "";
        varsayilanKesintiler.forEach(k => yeniKesintiSatiriEkle(k));
    }
    
    // Tab'ı başa al (Bootstrap hatası vermesin diye try-catch)
    const firstTabBtn = document.querySelector('#memberTabs button[data-bs-target="#tab-genel"]');
    if (firstTabBtn) {
        try { bootstrap.Tab.getOrCreateInstance(firstTabBtn).show(); } catch(e) {}
    }

    const modalEl = document.getElementById('addMemberModal');
    if (modalEl) {
        document.body.appendChild(modalEl);
        bootstrap.Modal.getOrCreateInstance(modalEl).show();
    }
}

// 4. Düzenleme Fonksiyonu
window.uyeDuzenle = function(id) {
    const uye = allMembers.find(m => m.id === id);
    if (!uye) return;
    duzenlenecekId = id;

    // Form Elemanlarını Güvenli Doldur (Helper)
    const setVal = (elmId, val) => { 
        const el = document.getElementById(elmId); 
        if(el) el.value = val || ""; 
    };
    
    setVal("uyeSira", uye.sira);
    setVal("uyeAd", uye.ad);
    setVal("uyeSoyad", uye.soyad);
    setVal("uyeTc", uye.tc);
    setVal("uyeKoy", uye.koy);
    setVal("uyeTel", uye.telefon);
    setVal("uyeIban", uye.iban);
    setVal("uyeEmail", uye.kurtarmaEmail);
    // Yeni Detay Alanları
    setVal("uyeIsletmeNo", uye.isletmeNo);
    setVal("uyeBabaAdi", uye.babaAdi);
    setVal("uyeDogumTarihi", uye.dogumTarihi);
    setVal("uyeEgitim", uye.egitimDurumu);
    setVal("uyeIl", uye.il);
    setVal("uyeIlce", uye.ilce);
    setVal("uyeAdres", uye.adres);

    // Kesintileri Listele
    const container = document.getElementById("kesintiListesiContainer");
    if (container) {
        container.innerHTML = "";
        if (uye.kesintiler && uye.kesintiler.length > 0) {
            uye.kesintiler.forEach(k => yeniKesintiSatiriEkle(k));
        } else {
            // Varsayılanlar
            const stopajOran = uye.isBorsaRegistered ? 1 : 2; 
            yeniKesintiSatiriEkle({ ad: 'Stopaj (Gelir Vergisi)', oran: stopajOran, aktif: true });
            yeniKesintiSatiriEkle({ ad: 'Borsa Tescil Ücreti', oran: 0.2, aktif: true });
            
            const bagkurAktif = (uye.hasBagkurExemption === true) ? false : true;
            yeniKesintiSatiriEkle({ ad: 'Bağ-Kur Primi', oran: 1, aktif: bagkurAktif });
            yeniKesintiSatiriEkle({ ad: 'Mera Fonu', oran: 0.1, aktif: false });
        }
    }
    
    const lblTitle = document.getElementById("lblModalTitle");
    if (lblTitle) lblTitle.innerHTML = '<i class="fa-solid fa-user-pen me-2"></i>Kaydı Düzenle';

    // Tab'ı Sıfırla
    const firstTabBtn = document.querySelector('#memberTabs button[data-bs-target="#tab-genel"]');
    if (firstTabBtn) {
        try { bootstrap.Tab.getOrCreateInstance(firstTabBtn).show(); } catch(e) {}
    }

    const modalEl = document.getElementById('addMemberModal');
    if (modalEl) {
        document.body.appendChild(modalEl);
        bootstrap.Modal.getOrCreateInstance(modalEl).show();
    }
}


window.uyeKaydetSubmit = async function(e) {
    // 1. Sayfa yenilenmesini engelle
    if (e && e.preventDefault) e.preventDefault();

    // 2. YARDIMCI FONKSİYON: Değer Okuma
    const getVal = (id) => {
        const el = document.getElementById(id);
        return el ? el.value : "";
    };

    // 3. Form verilerini al
    const ad = getVal("uyeAd");
    const soyad = getVal("uyeSoyad");
    const tc = getVal("uyeTc");
    const tel = getVal("uyeTel");
    const email = getVal("uyeEmail"); 
    const koy = getVal("uyeKoy");
    const sira = getVal("uyeSira");
    const iban = getVal("uyeIban");

   if (!ad || !soyad) {
    Swal.showValidationMessage('Lütfen zorunlu alanları doldurun (Ad ve Soyad)');
    return false;
}

    try {
        Swal.showLoading();

        // Veritabanı verisi hazırlama
        const yeniUye = {
            ad: ad, soyad: soyad, tc: tc, telefon: tel, koy: koy, sira: sira, iban: iban,
            kurtarmaEmail: email, // Kritik alan
            isletmeNo: getVal("uyeIsletmeNo"), babaAdi: getVal("uyeBabaAdi"),
            dogumTarihi: getVal("uyeDogumTarihi"), anneAdi: getVal("uyeAnneAdi"),
            hayvanSayisi: getVal("uyeHayvanSayisi") || 0, aracPlaka: getVal("uyeAracPlaka"),
            notlar: getVal("uyeNotlar"), role: "member"
        };

        // --- GÖLGE UYGULAMA İLE KULLANICI OLUŞTURMA ---
        let authKaydiBasarili = false;
        let authHataMesaji = "";

        try {
            if (typeof firebaseConfig === 'undefined') {
                throw new Error("firebaseConfig bulunamadı. Lütfen import ayarlarını kontrol edin.");
            }

            // İkincil (Gölge) Uygulamayı Başlat
            const secondaryApp = initializeAppNew(firebaseConfig, "SecondaryApp");
            const secondaryAuth = getAuthNew(secondaryApp);

            // Kullanıcıyı oluştur (Şifre: 123456)
            await createUserWithEmailAndPassword(secondaryAuth, email, "123456");
            
            // Gölge uygulamadan çıkış yap ve temizle
            await signOutNew(secondaryAuth);
            await deleteApp(secondaryApp);

            authKaydiBasarili = true;

        } catch (authError) {
            console.error("Auth Hatası:", authError);
            if (authError.code === 'auth/email-already-in-use') {
                authHataMesaji = ""; // Zaten varsa hata sayma
                authKaydiBasarili = true;
            } else {
                authHataMesaji = " (Giriş yetkisi oluşturulamadı: " + authError.message + ")";
            }
        }

        // --- FİRESTORE KAYDI ---
        if (duzenlenecekId) {
            const docRef = doc(db, "members", duzenlenecekId);
            await updateDoc(docRef, yeniUye);
            
            Swal.fire({
                icon: 'success',
                title: 'Güncellendi',
                text: 'Bilgiler güncellendi.' + authHataMesaji
            });

        } else {
            const docId = tc ? tc : (new Date().getTime().toString()); 
            await setDoc(doc(db, "members", docId), {
                ...yeniUye,
                id: docId,
                createdAt: new Date(),
                guncelBakiye: 0
            });

            Swal.fire({ 
                icon: 'success', 
                title: 'Kayıt Başarılı', 
                text: authKaydiBasarili ? `Kayıt yapıldı. Şifre: 123456` : `Auth kaydı yapılamadı.${authHataMesaji}` 
            });
        }

        // --- TEMİZLİK (DÜZELTİLEN KISIM BURASI) ---
        
        // 1. Formu Temizle (ID: addMemberForm)
        const formEl = document.getElementById("addMemberForm");
        if (formEl) formEl.reset();

        duzenlenecekId = null;

        // 2. Modalı Kapat (ID: addMemberModal)
        const modalEl = document.getElementById('addMemberModal');
        if (modalEl) {
            const modal = bootstrap.Modal.getInstance(modalEl);
            if(modal) modal.hide();
        }
        
        // 3. Listeyi Yenile
        if (typeof verileriGetir === 'function') verileriGetir();
        if (typeof uyeleriGetir === 'function') uyeleriGetir(); // Sizin kodda bu isimde olabilir

    } catch (error) {
        console.error(error);
        Swal.fire("Hata", "İşlem sırasında hata: " + error.message, "error");
    }
}

// --- 2. Durum Değiştirme (AKILLI BORSA/STOPAJ KONTROLÜ EKLENDİ) ---
window.kesintiDurumDegisti = function(checkbox) {
    if (!checkbox) return;

    const row = checkbox.closest('.kesinti-satiri');
    if (!row) return;

    // Elementleri güvenli seç
    const nameInput = row.querySelector('.kesinti-adi');
    const rateWrapper = row.querySelector('.kesinti-oran-wrapper');
    
    // --- GÖRSEL AYARLAMALAR ---
    if (!checkbox.checked) {
        // Pasif Durum
        row.style.opacity = "0.6";
        row.style.backgroundColor = "#f9fafb";
        if (nameInput) nameInput.style.textDecoration = "line-through";
        if (rateWrapper) rateWrapper.style.opacity = "0.5";
    } else {
        // Aktif Durum
        row.style.opacity = "1";
        row.style.backgroundColor = "#fff";
        if (nameInput) nameInput.style.textDecoration = "none";
        if (rateWrapper) rateWrapper.style.opacity = "1";
    }

    // --- OTOMATİK ORAN AYARLAMA MANTIĞI (YENİ EKLENEN KISIM) ---
    // Eğer işlem yapılan satırın adı "Borsa" içeriyorsa
    if (nameInput && nameInput.value.toLowerCase().includes('borsa')) {
        
        // Tüm satırları tara ve "Stopaj" satırını bul
        const allRows = document.getElementById("kesintiListesiContainer").querySelectorAll('.kesinti-satiri');
        
        allRows.forEach(r => {
            const rName = r.querySelector('.kesinti-adi');
            const rRate = r.querySelector('.kesinti-oran');
            
            if (rName && rName.value.toLowerCase().includes('stopaj')) {
                // EĞER BORSA AKTİF İSE -> STOPAJ %1
                // EĞER BORSA PASİF İSE -> STOPAJ %2
                if (checkbox.checked) {
                    rRate.value = 1;
                    // Kullanıcı değiştiğini fark etsin diye minik bir animasyon/renk
                    rRate.style.color = "#16a34a"; // Yeşilimsi
                    setTimeout(() => rRate.style.color = "", 1000);
                } else {
                    rRate.value = 2;
                    rRate.style.color = "#dc2626"; // Kırmızımsı
                    setTimeout(() => rRate.style.color = "", 1000);
                }
            }
        });
    }
}

// Mevcut Firebase kayıt fonksiyonunuza entegre edilecek kısım:
async function firebaseKayitIslemi(veri, id) {
    try {
        if (id) {
            await updateDoc(doc(db, "members", id), veri);
            Swal.fire({ icon: 'success', title: 'Güncellendi', timer: 1000, showConfirmButton: false });
        } else {
            await addDoc(collection(db, "members"), veri);
            Swal.fire({ icon: 'success', title: 'Eklendi', timer: 1000, showConfirmButton: false });
        }
        uyeleriGetir(); // Listeyi yenile
        bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
    } catch (error) {
        Swal.fire("Hata", error.message, "error");
    }
}
// --- MÜŞAVİR BAĞLAMA FONKSİYONU ---
window.musavirBagla = async function() {
    const kodInput = document.getElementById("musavirBaglantiKodu");
    const kod = kodInput.value.trim().toUpperCase();

    if (kod.length < 6) {
        Swal.fire("Hata", "Lütfen 6 haneli geçerli bir kod giriniz.", "warning");
        return;
    }

    Swal.fire({title: 'Müşavir Aranıyor...', didOpen:()=>Swal.showLoading()});

    try {
        // 1. Koda sahip kullanıcıyı bul (Rolü musavir olan)
        const q = query(
            collection(db, "users"), 
            where("uniqueCode", "==", kod),
            where("rol", "==", "musavir")
        );
        
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            Swal.fire("Bulunamadı", "Bu koda sahip bir Müşavir hesabı bulunamadı.", "error");
            return;
        }

        const musavirDoc = snapshot.docs[0];
        const musavirData = musavirDoc.data();
        const musavirId = musavirDoc.id;

        // 2. Onay İste
        const confirm = await Swal.fire({
            title: 'Müşavir Yetkilendirmesi',
            html: `<b>${musavirData.adSoyad}</b> isimli müşavire, kooperatif verilerinizi görüntüleme yetkisi verilecek.<br>Onaylıyor musunuz?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Evet, Yetki Ver'
        });

        if (confirm.isConfirmed) {
            // 3. Müşavirin 'authorizedCoops' dizisine bu kooperatifi ekle
            // arrayUnion: Aynı kooperatif zaten varsa tekrar eklemez (Duplicate önler)
            await updateDoc(doc(db, "users", musavirId), {
                authorizedCoops: arrayUnion(currentCoopId)
            });

            kodInput.value = "";
            Swal.fire("İşlem Başarılı", "Müşavir yetkilendirildi.", "success");
        }

    } catch (error) {
        console.error(error);
        Swal.fire("Hata", error.message, "error");
    }
}

// --- SCRIPT'İN EN ALTINA YAPIŞTIRIN ---

// İkincil uygulama için config (Mevcut config ile aynı)
const secondaryConfig = {
    apiKey: "AIzaSyAMTYZGCkVv1QausRJSyutrSUUvJ0mkqD4", 
    authDomain: "koopplatform-dd9f8.firebaseapp.com",
    projectId: "koopplatform-dd9f8"
};

window.uyeGirisYetkisiVer = async function(memberId, telefon, adSoyad, coopId) {
    // Telefon Kontrolü
    if(!telefon || telefon.length < 10) {
        Swal.fire("Hata", "Üyenin geçerli bir telefon numarası yok. Lütfen önce düzenle diyerek telefon ekleyin.", "warning");
        return;
    }

    // Telefonu Temizle (Sadece rakam kalsın)
    let cleanPhone = telefon.replace(/\D/g, '');
    if (cleanPhone.startsWith('0')) cleanPhone = cleanPhone.substring(1);
    
    // Varsayılan Şifre ve Email
    const varsayilanSifre = "123456"; 
    const email = `${cleanPhone}@koop.com`; // Telefon numarası tabanlı sahte email

    // Onay İste
    const confirm = await Swal.fire({
        title: 'Giriş Yetkisi Verilsin mi?',
        html: `
            <div class="text-start fs-6">
                <b>${adSoyad}</b> için giriş hesabı oluşturulacak.<br><br>
                👤 Kullanıcı Adı: <b>${cleanPhone}</b><br>
                🔑 Şifre: <b>${varsayilanSifre}</b><br><br>
                <span class="text-muted small">Bu bilgileri üyeye iletmeniz gerekecek.</span>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Evet, Oluştur',
        confirmButtonColor: '#0f766e',
        cancelButtonText: 'Vazgeç'
    });

    if (!confirm.isConfirmed) return;

    Swal.fire({title: 'Hesap Oluşturuluyor...', allowOutsideClick: false, didOpen:()=>Swal.showLoading()});

    let secondaryApp = null;
    try {
        // 1. İkincil uygulama başlat (Yönetici çıkışı yapmamak için kritik nokta!)
        secondaryApp = initializeAppNew(secondaryConfig, "SecondaryMemberAuth");
        const secondaryAuth = getAuthNew(secondaryApp);

        // 2. Yeni Auth kullanıcısı oluştur
        const userCred = await createUserWithEmailAndPassword(secondaryAuth, email, varsayilanSifre);
        const newUid = userCred.user.uid;

        // 3. Users tablosuna kaydet (Member rolüyle)
        await setDoc(doc(db, "users", newUid), {
            email: email,
            adSoyad: adSoyad,
            rol: 'member', // Rol: Üye
            coopId: coopId,
            relatedMemberId: memberId, // Members tablosundaki asıl kayda bağladık
            createdAt: new Date()
        });

        // 4. Temizlik (İkincil uygulamayı kapat)
        await deleteApp(secondaryApp);

        Swal.fire({
            icon: 'success',
            title: 'Hesap Hazır!',
            html: `Üye artık şu bilgilerle giriş yapabilir:<br><br>
                   <b>No:</b> ${cleanPhone}<br>
                   <b>Şifre:</b> ${varsayilanSifre}`
        });

    } catch (error) {
        console.error(error);
        if (error.code === 'auth/email-already-in-use') {
            Swal.fire("Bilgi", "Bu numara için zaten bir giriş hesabı oluşturulmuş.", "info");
        } else {
            Swal.fire("Hata", "İşlem başarısız: " + error.message, "error");
        }
        // Hata olsa bile ikincil uygulamayı temizle
        if(secondaryApp) await deleteApp(secondaryApp);
    }
}




// --- SİPARİŞ YÖNETİMİ GÜNCEL KODLAR (items ve totalAmount uyumlu) ---

let siparisListener = null;

window.siparisleriGetir = function() {
    const tableBody = document.getElementById("siparis-tablosu");
    
    if(!currentCoopId) {
        console.warn("Kooperatif ID henüz yüklenmedi.");
        return; 
    }

    if (siparisListener) siparisListener();

    const q = query(
        collection(db, "orders"), 
        where("coopId", "==", currentCoopId),
        where("status", "==", "Bekliyor"), 
        orderBy("tarih", "desc")
    );

    siparisListener = onSnapshot(q, (snapshot) => {
        let html = "";
        
        if(snapshot.empty){
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted p-4">Bekleyen yeni sipariş yok.</td></tr>`;
            return;
        }

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const tarih = data.tarih ? data.tarih.toDate().toLocaleDateString('tr-TR') : '-';
            
            // DÜZELTİLEN SATIR: Değişken ismi birleşik olmalı
            let urunDetayiHtml = ""; 
            if (data.items && Array.isArray(data.items)) {
                urunDetayiHtml = data.items.map(item => 
                    `<div class="mb-1">
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary p-1 small">
                            ${item.urun}
                        </span>
                        <span class="ms-1 small fw-bold text-dark">x ${item.miktar}</span>
                    </div>`
                ).join('');
            } else {
                urunDetayiHtml = `<span class="text-muted small">Ürün bilgisi yok</span>`;
            }

            const tutarGoster = data.totalAmount ? data.totalAmount.toLocaleString('tr-TR') : '0';
            
            html += `
            <tr>
                <td>${tarih}</td>
                <td>
                    <div class="fw-bold text-dark">${data.memberName || 'İsimsiz'}</div>
                </td>
                <td>
                    ${urunDetayiHtml}
                </td>
                <td class="fw-bold text-danger">
                    ${tutarGoster} ₺
                </td>
                <td><span class="badge bg-warning text-dark">Onay Bekliyor</span></td>
                <td class="text-end">
                    <button class="btn btn-sm btn-success me-1" onclick="siparisIsle('${docSnap.id}', '${data.memberId}', ${data.totalAmount}, 'onayla')">
                        <i class="fa-solid fa-check"></i> Onayla
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="siparisIsle('${docSnap.id}', null, 0, 'reddet')">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>`;
        });
        
        tableBody.innerHTML = html;
    }, (err) => {
        console.error("Sipariş dinleme hatası:", err);
    });
}

// Sipariş Onay/Red İşlemi
window.siparisIsle = async function(orderId, memberId, tutar, islemTipi) {
    const title = islemTipi === 'onayla' ? "Siparişi Onayla" : "Siparişi Reddet";
    const text = islemTipi === 'onayla' 
        ? `Bu işlem üreticinin hesabına ${tutar} TL borç kaydedecek. Emin misiniz?` 
        : "Bu sipariş iptal edilecek.";

    const result = await Swal.fire({
        title: title,
        text: text,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Evet, İşle',
        cancelButtonText: 'Vazgeç',
        confirmButtonColor: islemTipi === 'onayla' ? '#198754' : '#dc3545'
    });

    if (!result.isConfirmed) return;

    try {
        const orderRef = doc(db, "orders", orderId);

        if (islemTipi === 'onayla') {
            const batch = writeBatch(db);
            
            // 1. Siparişi tamamla
            batch.update(orderRef, { status: "Tamamlandı", islemTarihi: new Date() });

            // 2. Cariye Borç İşle (Transaction Kaydı)
            const transRef = doc(collection(db, "transactions"));
            batch.set(transRef, {
                memberId: memberId,
                coopId: currentCoopId,
                type: 'borc',
                category: 'Market Siparişi',
                description: 'Uygulama üzerinden verilen malzeme siparişi',
                amount: Number(tutar),
                date: new Date(),
                createdAt: new Date()
            });

            // 3. Üyenin Bakiyesini Güncelle
            const memberRef = doc(db, "members", memberId);
            batch.update(memberRef, { 
                guncelBakiye: increment(Number(tutar)) 
            });

            await batch.commit();
            Swal.fire("Başarılı", "Sipariş onaylandı ve cariye işlendi.", "success");
        } else {
            await updateDoc(orderRef, { status: "İptal", islemTarihi: new Date() });
            Swal.fire("İptal", "Sipariş reddedildi.", "info");
        }
    } catch (error) {
        console.error("İşlem hatası:", error);
        Swal.fire("Hata", "İşlem sırasında bir sorun oluştu: " + error.message, "error");
    }
}

// 2. Durum Değiştirme (Onayla/İptal)
window.siparisDurumDegistir = async function(docId, yeniDurum) {
    try {
        await updateDoc(doc(db, "orders", docId), { durum: yeniDurum });
        const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
        Toast.fire({icon: 'success', title: 'Durum güncellendi: ' + yeniDurum});
    } catch (error) {
        Swal.fire("Hata", error.message, "error");
    }
}

// 3. Teslim Et ve Cariye İşle
window.siparisTeslimEt = async function(docId, memberId, memberName, urunAdi, miktar) {
    const { value: formValues } = await Swal.fire({
        title: 'Siparişi Teslim Et',
        html: `
            <div class="bg-light p-3 rounded border text-start">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="swal-cari-islesin" checked onchange="document.getElementById('fiyat-div').style.display = this.checked ? 'block' : 'none'">
                    <label class="form-check-label fw-bold" for="swal-cari-islesin">Cari Hesaba Borç İşle</label>
                </div>
                
                <div id="fiyat-div">
                    <label class="small fw-bold text-muted mb-1">Toplam Tutar (TL)</label>
                    <input type="number" id="swal-tutar" class="form-control fw-bold fs-5" placeholder="0.00">
                    <div class="form-text x-small text-danger">Bu tutar üyenin hesabına <b>BORÇ</b> olarak eklenecek.</div>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Teslim Et ve Bitir',
        confirmButtonColor: '#198754',
        preConfirm: () => {
            return {
                islesin: document.getElementById('swal-cari-islesin').checked,
                tutar: document.getElementById('swal-tutar').value
            }
        }
    });

    if (formValues) {
        if (formValues.islesin && (!formValues.tutar || Number(formValues.tutar) <= 0)) {
            return Swal.fire("Hata", "Cariye işlenecekse tutar girmelisiniz!", "warning");
        }

        Swal.fire({title: 'İşleniyor...', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});

        try {
            const batch = writeBatch(db);
            
            // 1. Sipariş Durumunu Güncelle
            const orderRef = doc(db, "orders", docId);
            batch.update(orderRef, { durum: 'Teslim Edildi', teslimTarihi: new Date() });

            // 2. Cariye İşle (Eğer seçildiyse)
            if (formValues.islesin) {
                const transRef = doc(collection(db, "transactions"));
                batch.set(transRef, {
                    memberId: memberId,
                    coopId: currentCoopId,
                    type: 'borc', // Borçlandırma
                    category: 'Malzeme Siparişi',
                    description: `Sipariş: ${urunAdi} (${miktar} Adet)`,
                    amount: Number(formValues.tutar),
                    date: new Date(),
                    createdAt: new Date()
                });
                
                // Üye bakiyesini güncelle
                const memberRef = doc(db, "members", memberId);
                batch.update(memberRef, {
                    guncelBakiye: increment(Number(formValues.tutar))
                });
            }

            await batch.commit();
            Swal.fire("Başarılı", "Sipariş teslim edildi.", "success");

        } catch (error) {
            Swal.fire("Hata", error.message, "error");
        }
    }
}
window.sifremiUnuttum = async function() {
    const { value: formValues } = await Swal.fire({
        title: '🔑 Şifre Kurtarma',
        html: `
            <div class="text-start">
                <label class="small fw-bold mb-1">T.C. Kimlik Numaranız</label>
                <input id="swal-tc" class="form-control mb-3" type="number" placeholder="11 haneli T.C. No">
                
                <label class="small fw-bold mb-1">İşletme Numaranız</label>
                <input id="swal-isletme" class="form-control" type="text" placeholder="Örn: TR-45...">
                <div class="form-text text-muted small">Kooperatif kaydındaki işletme numaranız.</div>
            </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Bilgileri Doğrula',
        cancelButtonText: 'Vazgeç',
        preConfirm: () => {
            const tc = document.getElementById('swal-tc').value;
            const isletme = document.getElementById('swal-isletme').value;
            if (!tc || !isletme) return Swal.showValidationMessage("Lütfen tüm alanları doldurun!");
            return { tc, isletme };
        }
    });

    if (formValues) {
        try {
            Swal.fire({ title: 'Kontrol ediliyor...', didOpen: () => Swal.showLoading() });

            // 1. Members koleksiyonunda bu üyeyi bul
            const q = query(collection(db, "members"), 
                        where("tc", "==", formValues.tc), 
                        where("isletmeNo", "==", formValues.isletme));
            
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                return Swal.fire("Hata", "Bilgiler eşleşmedi. Lütfen kooperatif ile iletişime geçin.", "error");
            }

            const uyeDoc = snapshot.docs[0];
            const uyeVeri = uyeDoc.data();

            // 2. Bilgiler doğruysa yeni şifre iste
            const { value: yeniSifre } = await Swal.fire({
                title: `Hoşgeldin ${uyeVeri.adSoyad}`,
                text: "Lütfen yeni şifrenizi belirleyin:",
                input: 'text', // Ahmet Amca yazdığını görsün diye text yaptık
                inputAttributes: { minlength: 6 },
                confirmButtonText: 'Talebi Gönder',
                showCancelButton: true
            });

            if (yeniSifre) {
                // 3. Admin'e şifre değiştirme talebi gönder
                await addDoc(collection(db, "password_requests"), {
                    memberId: uyeDoc.id,
                    adSoyad: uyeVeri.adSoyad,
                    yeniSifre: yeniSifre,
                    tarih: new Date(),
                    status: "Bekliyor"
                });

                Swal.fire("Talep Alındı", "Şifre değiştirme talebiniz kooperatife iletildi. Admin onayından sonra giriş yapabilirsiniz.", "success");
            }
        } catch (error) {
            Swal.fire("Hata", "Bir sorun oluştu: " + error.message, "error");
        }
    }
}

window.sifreTalepleriniTakipEt = function() {
    const container = document.getElementById('password-requests-container');
    const badge = document.getElementById('pass-req-badge');

    if (!container) return;

    const q = query(collection(db, "password_requests"), orderBy("tarih", "desc"));

    onSnapshot(q, (snapshot) => {
        const talepSayisi = snapshot.size;

        // 1. ÜSTTEKİ KÜÇÜK ROZETİ (BADGE) GÜNCELLE
        if (badge) {
            if (talepSayisi > 0) {
                badge.innerText = talepSayisi;
                badge.classList.remove('d-none');
            } else {
                badge.classList.add('d-none');
            }
        }

        // 2. ANA PANELİ GÖSTER VEYA TAMAMEN GİZLE
        // Eğer HİÇ TALEP YOKSA -> İçini tamamen boşalt (Ekranda yer kaplamasın)
        if (snapshot.empty) {
            container.innerHTML = ''; 
            return;
        }

        // Eğer talep VARSA -> Paneli oluştur ve göster
        let rowsHtml = '';
        snapshot.forEach((docSnap) => {
            const req = docSnap.data();
            const docId = docSnap.id;
            
            let tarihStr = '-';
            if(req.tarih && req.tarih.toDate) {
                 tarihStr = req.tarih.toDate().toLocaleDateString('tr-TR', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'});
            }

            rowsHtml += `
            <tr class="align-middle border-bottom">
                <td class="ps-3 py-3">
                    <div class="d-flex align-items-center">
                        <div class="bg-warning bg-opacity-10 text-warning rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                            <i class="fa-solid fa-user-lock"></i>
                        </div>
                        <div>
                            <div class="fw-bold text-dark">${req.adSoyad || 'İsimsiz Üye'}</div>
                            <div class="small text-muted">${tarihStr}</div>
                        </div>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge bg-light text-dark border px-2 py-1" style="font-family: monospace; font-size: 1rem;">
                        ${req.yeniSifre}
                    </span>
                </td>
                <td class="text-end pe-3">
                    <button class="btn btn-sm btn-success text-white shadow-sm px-3 rounded-pill" 
                            onclick="sifreDegisiminiOnayla('${docId}', '${req.userId}', '${req.yeniSifre}')">
                        <i class="fa-solid fa-check"></i> Onayla
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-1 rounded-circle" onclick="deleteDoc(doc(db, 'password_requests', '${docId}'))">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </td>
            </tr>`;
        });

        // Paneli ekrana bas
        container.innerHTML = `
        <div class="card border-0 shadow-sm overflow-hidden mb-4 animate__animated animate__fadeInDown" style="border-radius: 16px;">
            <div class="position-absolute top-0 start-0 h-100 bg-warning" style="width: 5px;"></div>
            <div class="card-header bg-white border-bottom-0 pt-4 pb-2 px-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold text-dark m-0"><i class="fa-solid fa-key text-warning me-2"></i>Bekleyen Şifre Talepleri</h6>
                    <span class="badge bg-danger">${talepSayisi} Yeni</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0"><tbody>${rowsHtml}</tbody></table>
                </div>
            </div>
        </div>`;
    });
};
// Sayfa yüklendiğinde çalıştır
sifreTalepleriniTakipEt();
// Uygulama başladığında bu takibi başlat
sifreTalepleriniTakipEt();
window.kurumBilgileriniKaydet = async function() {
    const name = document.getElementById('setting-coop-name').value;
    const address = document.getElementById('setting-coop-address').value;
    const phone = document.getElementById('setting-coop-phone').value;

    if(!name) { 
        Swal.fire("Hata", "Lütfen en azından kooperatif adını girin.", "warning");
        return; 
    }

    try {
        Swal.fire({ title: 'Kaydediliyor...', didOpen: () => Swal.showLoading() });
        
        // currentCoopId değişkeninin tanımlı olduğunu varsayıyoruz (Admin panelinde mevcuttur)
        const coopRef = doc(db, "cooperatives", currentCoopId);
        await updateDoc(coopRef, {
            name: name,
            address: address,
            telefon: phone // Üretici panelinin okuduğu alan budur
        });

        Swal.fire("Başarılı", "Kurum bilgileri güncellendi.", "success");
    } catch (error) {
        console.error("Hata:", error);
        Swal.fire("Hata", "Bilgiler kaydedilemedi.", "error");
    }
};

</script>
<div class="bottom-nav d-lg-none">
    <a class="b-nav-item active" onclick="switchTab('dashboard', this); closeSidebar()">
        <i class="fa-solid fa-chart-pie"></i>
        <span>Hızlı İşlemler</span>
    </a>
    <a class="b-nav-item" onclick="switchTab('members', this); closeSidebar()">
        <i class="fa-solid fa-users"></i>
        <span>Cariler</span>
    </a>
    <a class="b-nav-item" onclick="sutHesaplamaModalAc(); closeSidebar()">
        <div class="bg-warning text-dark rounded-circle d-flex align-items-center justify-content-center shadow-sm" 
             style="width: 45px; height: 45px; margin-top: -25px; border: 4px solid #f1f5f9;">
            <i class="fa-solid fa-calculator" style="font-size: 1.2rem; transform: none;"></i>
        </div>
    </a>
    <a class="b-nav-item" onclick="switchTab('milk-management', this); closeSidebar()">
        <i class="fa-solid fa-cow"></i>
        <span>Süt</span>
    </a>
    <a class="b-nav-item" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
        <span>Menü</span>
    </a>
</div>
</body>