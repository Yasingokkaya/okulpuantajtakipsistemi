<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Müşavir Kayıt - KoopSistem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); height: 100vh; display: flex; align-items: center; justify-content: center; font-family: 'Inter', sans-serif; }
        .card-custom { border: none; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 450px; overflow: hidden; }
        .header-bg { background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%); padding: 30px; text-align: center; color: white; }
    </style>
</head>
<body>

    <div class="card-custom bg-white">
        <div class="header-bg">
            <h4 class="fw-bold m-0">Yeni Müşavir Hesabı</h4>
            <small class="opacity-75">Sisteme kayıt olun ve kodunuzu alın.</small>
        </div>

        <div class="p-4">
            <form onsubmit="kayitOl(event)">
                <div class="mb-3">
                    <label class="fw-bold small text-muted">Ad Soyad</label>
                    <input type="text" id="regName" class="form-control" placeholder="Adınız Soyadınız" required>
                </div>
                <div class="mb-3">
                    <label class="fw-bold small text-muted">E-Posta</label>
                    <input type="email" id="regEmail" class="form-control" placeholder="mail@musavirlik.com" required>
                </div>
                <div class="mb-4">
                    <label class="fw-bold small text-muted">Şifre Belirleyin</label>
                    <input type="password" id="regPass" class="form-control" placeholder="******" minlength="6" required>
                </div>
                
                <button type="submit" class="btn w-100 py-3 fw-bold text-white shadow-sm mb-3" style="background-color: #4f46e5;">
                    HESABI OLUŞTUR
                </button>
            </form>
            
            <div class="text-center">
                <a href="musavir-giris.html" class="text-decoration-none small fw-bold text-primary">Zaten hesabınız var mı? Giriş Yapın</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // SİZİN CONFİG BURAYA
        const firebaseConfig = {
            apiKey: "AIzaSyAMTYZGCkVv1QausRJSyutrSUUvJ0mkqD4", 
            authDomain: "koopplatform-dd9f8.firebaseapp.com",
            projectId: "koopplatform-dd9f8",
            storageBucket: "koopplatform-dd9f8.firebasestorage.app",
            messagingSenderId: "757328538678",
            appId: "1:757328538678:web:ffc9994b42025765b1fc97"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Rastgele 6 Haneli Kod Üretici (Harf ve Rakam)
        function kodUret() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // Karışıklık olmasın diye I,O,1,0 çıkardım
            let result = "";
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        window.kayitOl = async function(e) {
            e.preventDefault();
            
            const ad = document.getElementById("regName").value;
            const email = document.getElementById("regEmail").value;
            const pass = document.getElementById("regPass").value;
            
            const uniqueCode = kodUret(); // Örn: X7K9M2

            Swal.fire({title: 'Hesap Oluşturuluyor...', didOpen:()=>Swal.showLoading()});

            try {
                // 1. Firebase Auth Kullanıcısı Oluştur
                const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCred.user;

                // 2. Firestore'a Kullanıcı Detaylarını Yaz
                await setDoc(doc(db, "users", user.uid), {
                    adSoyad: ad,
                    email: email,
                    rol: "musavir", // Rolü otomatik Müşavir yapıyoruz
                    uniqueCode: uniqueCode, // ÖZEL KODU ATADIK
                    authorizedCoops: [], // Henüz hiç firması yok
                    createdAt: new Date()
                });

                // Oturumu kapat (Güvenlik için tekrar giriş yapsın)
                await signOut(auth);

                await Swal.fire({
                    icon: 'success',
                    title: 'Kayıt Başarılı!',
                    html: `Hesabınız oluşturuldu.<br>Bağlantı Kodunuz: <b style="font-size:1.2em">${uniqueCode}</b><br><br>Bu kodu panelden de görebilirsiniz.`,
                    confirmButtonText: 'Giriş Ekranına Git'
                });

                window.location.href = "musavir-giris.html";

            } catch (error) {
                console.error(error);
                let msg = error.message;
                if(error.code === 'auth/email-already-in-use') msg = "Bu e-posta zaten kayıtlı.";
                Swal.fire("Hata", msg, "error");
            }
        }
    </script>
</body>
</html>