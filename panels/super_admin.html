<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Süper Admin Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/jpeg" href="app-logo.jpg">
    <link rel="apple-touch-icon" href="app-logo.jpg">
    <link rel="manifest" href="../manifest.json">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        .sidebar {
            width: 250px; height: 100vh; position: fixed; top: 0; left: 0;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); color: white;
            padding-top: 20px;
        }
        .main-content { margin-left: 250px; padding: 30px; }
        .nav-link { color: rgba(255,255,255,0.8); padding: 12px 20px; font-weight: 500; display: flex; align-items: center; gap: 10px; text-decoration: none; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .bg-active { background-color: #dcfce7; color: #166534; }
        .bg-expired { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="text-center mb-4">
        <h4 class="fw-bold"><i class="fa-solid fa-user-secret me-2"></i>SÜPER PANEL</h4>
        <small class="text-white-50">Sistem Yönetimi</small>
    </div>
    <a href="#" class="nav-link active"><i class="fa-solid fa-building"></i> Şirketler</a>
    <a href="#" class="nav-link" onclick="cikisYap()"><i class="fa-solid fa-right-from-bracket"></i> Çıkış</a>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark">Şirket Yönetimi</h3>
            <p class="text-muted">Kayıtlı kooperatif ve işletmelerin lisans durumları</p>
        </div>
        <button class="btn btn-primary fw-bold px-4 py-2" onclick="modalAc()">
            <i class="fa-solid fa-plus me-2"></i> YENİ ŞİRKET OLUŞTUR
        </button>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card p-3 border-start border-4 border-primary">
                <small class="text-muted fw-bold">TOPLAM ŞİRKET</small>
                <h3 class="fw-bold m-0" id="statTotal">0</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 border-start border-4 border-success">
                <small class="text-muted fw-bold">AKTİF LİSANS</small>
                <h3 class="fw-bold m-0 text-success" id="statActive">0</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 border-start border-4 border-danger">
                <small class="text-muted fw-bold">SÜRESİ DOLAN</small>
                <h3 class="fw-bold m-0 text-danger" id="statExpired">0</h3>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3">Kurum Adı</th>
                        <th>Yönetici Email</th>
                        <th>Bitiş Tarihi</th>
                        <th>Kalan Gün</th>
                        <th>Durum</th>
                        <th class="text-end pe-4">İşlem</th>
                    </tr>
                </thead>
                <tbody id="companyList">
                    <tr><td colspan="6" class="text-center py-4">Yükleniyor...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold">Yeni Kurum Oluştur</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="createForm">
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Kurum Adı</label>
                        <input type="text" class="form-control" id="kAdi" required placeholder="Örn: Akdağ Süt Koop.">
                    </div>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="fw-bold small text-muted">Yönetici Email</label>
                            <input type="email" class="form-control" id="kEmail" required placeholder="admin@firma.com">
                        </div>
                        <div class="col-6">
                            <label class="fw-bold small text-muted">Yönetici Şifre</label>
                            <input type="text" class="form-control" id="kPass" required placeholder="******">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Lisans Süresi</label>
                        <select class="form-select" id="kSure">
                            <option value="365">1 Yıl (365 Gün)</option>
                            <option value="180">6 Ay</option>
                            <option value="30">1 Ay (Deneme)</option>
                            <option value="1095">3 Yıl</option>
                            <option value="9999">Süresiz (Ömür Boyu)</option>
                        </select>
                    </div>

                    <div class="alert alert-info small mb-0">
                        <i class="fa-solid fa-info-circle me-1"></i> Şirket oluşturulurken yönetici hesabı da otomatik açılacaktır.
                    </div>
                    
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary fw-bold py-2">KAYDET VE OLUŞTUR</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ANA CONFİG
    const firebaseConfig = {
      apiKey: "AIzaSyAMTYZGCkVv1QausRJSyutrSUUvJ0mkqD4",
      authDomain: "koopplatform-dd9f8.firebaseapp.com",
      projectId: "koopplatform-dd9f8",
      storageBucket: "koopplatform-dd9f8.firebasestorage.app",
      messagingSenderId: "757328538678",
      appId: "1:757328538678:web:ffc9994b42025765b1fc97",
      measurementId: "G-R9K7G471FN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- GÜVENLİK KONTROLÜ VE SAYFA YÜKLEME ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // Kullanıcı var, peki SÜPER ADMIN mi?
            const docRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.rol === 'superadmin') {
                    // Evet, süper admin. Listeyi yükle.
                    sirketleriListele();
                } else {
                    // Hayır, yetkisiz.
                    window.location.href = "../index.html";
                }
            } else {
                window.location.href = "../index.html";
            }
        } else {
            // Giriş yapmamış.
            window.location.href = "../index.html";
        }
    });

    // 1. ŞİRKETLERİ LİSTELE
    async function sirketleriListele() {
        const tbody = document.getElementById("companyList");
        tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border text-primary"></div></td></tr>';

        try {
            const querySnapshot = await getDocs(collection(db, "cooperatives"));
            
            let html = "";
            let total = 0, active = 0, expired = 0;
            const bugun = new Date();

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const id = doc.id;
                
                let bitisTarihi = data.licenseEndDate ? data.licenseEndDate.toDate() : null;
                let tarihStr = bitisTarihi ? bitisTarihi.toLocaleDateString("tr-TR") : "Süresiz";
                
                let kalanGun = "-";
                let durumBadge = '<span class="status-badge bg-active">AKTİF</span>';
                
                if (bitisTarihi) {
                    const diffTime = bitisTarihi - bugun;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    kalanGun = diffDays > 0 ? diffDays + " Gün" : "Süre Doldu";

                    if(diffDays <= 0) {
                        durumBadge = '<span class="status-badge bg-expired">SÜRESİ BİTTİ</span>';
                        expired++;
                    } else {
                        active++;
                    }
                } else {
                    active++;
                }
                total++;

                html += `
                <tr>
                    <td class="ps-4">
                        <div class="fw-bold text-dark">${data.ad}</div>
                        <small class="text-muted" style="font-size:0.75rem">ID: ${id}</small>
                    </td>
                    <td>${data.managerEmail || '-'}</td>
                    <td><div class="fw-bold text-dark">${tarihStr}</div></td>
                    <td class="fw-bold ${kalanGun === 'Süre Doldu' ? 'text-danger' : 'text-success'}">${kalanGun}</td>
                    <td>${durumBadge}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-light border me-1" onclick="sureUzat('${id}', '${bitisTarihi ? bitisTarihi.toISOString() : ''}')" title="Süre Uzat"><i class="fa-solid fa-clock-rotate-left"></i></button>
                        <button class="btn btn-sm btn-light border text-danger" onclick="sirketSil('${id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            });

            if(total === 0) html = '<tr><td colspan="6" class="text-center py-4">Kayıtlı şirket yok.</td></tr>';
            
            tbody.innerHTML = html;
            
            document.getElementById("statTotal").innerText = total;
            document.getElementById("statActive").innerText = active;
            document.getElementById("statExpired").innerText = expired;

        } catch (error) {
            console.error(error);
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Veriler yüklenirken hata oluştu.</td></tr>';
        }
    }

    // 2. YENİ ŞİRKET OLUŞTURMA
    document.getElementById("createForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const ad = document.getElementById("kAdi").value;
        const email = document.getElementById("kEmail").value;
        const pass = document.getElementById("kPass").value;
        const sureGun = Number(document.getElementById("kSure").value);

        const now = new Date();
        now.setDate(now.getDate() + sureGun);

        Swal.fire({title: 'Kuruluyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

        let secondaryApp = null;
        try {
            const coopRef = await addDoc(collection(db, "cooperatives"), {
                ad: ad,
                managerEmail: email,
                createdAt: new Date(),
                licenseEndDate: now,
                isTaxInclusive: false,
                deviationLimit: 50,
                villages: ["Merkez"]
            });

            const newCoopId = coopRef.id;

            // İKİNCİL APP İLE YÖNETİCİ OLUŞTUR
            secondaryApp = initializeApp(firebaseConfig, "SecondaryManagerApp");
            const secondaryAuth = getAuth(secondaryApp);
            
            const userCred = await createUserWithEmailAndPassword(secondaryAuth, email, pass);
            const uid = userCred.user.uid;

            await setDoc(doc(db, "users", uid), {
                email: email,
                rol: "yonetici",
                kurumAdi: ad,
                coopId: newCoopId,
                kayitTarihi: new Date()
            });

            await signOut(secondaryAuth);
            if(secondaryApp) await deleteApp(secondaryApp);

            bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
            document.getElementById("createForm").reset();
            Swal.fire("Başarılı", "Şirket ve Yönetici oluşturuldu.", "success");
            
            sirketleriListele();

        } catch (error) {
            console.error(error);
            Swal.fire("Hata", error.message, "error");
            if(secondaryApp) await deleteApp(secondaryApp);
        }
    });

   // --- GELİŞMİŞ SÜRE UZATMA FONKSİYONU ---
    window.sureUzat = async function(coopId, mevcutTarihStr) {
        
        // 1. Referans Tarihi Belirle (Üzerine ekleme yapılacak tarih)
        let referansTarih = new Date(); // Varsayılan: Bugün
        
        if (mevcutTarihStr) {
            const mevcutTarih = new Date(mevcutTarihStr);
            // Eğer mevcut lisans tarihi gelecekteyse, onun üzerine ekle.
            // Eğer geçmişte bitmişse, bugünün üzerine ekle.
            if (mevcutTarih > new Date()) {
                referansTarih = mevcutTarih;
            }
        }

        // Tarihi YYYY-MM-DD formatına çeviren yardımcı
        const formatDate = (date) => {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        };

        const varsayilanBitis = formatDate(referansTarih); // Başlangıçta kutuda görünecek tarih

        // 2. SweetAlert Penceresi
        const { value: formValues } = await Swal.fire({
            title: 'Lisans Süresi Uzat',
            html: `
                <div class="text-start">
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">İşlem Seçeneği</label>
                        <select id="swal-sure-tip" class="form-select fw-bold text-dark">
                            <option value="365">1 Yıl Ekle (+365 Gün)</option>
                            <option value="180">6 Ay Ekle (+180 Gün)</option>
                            <option value="30">1 Ay Ekle (+30 Gün)</option>
                            <option value="custom">Özel Tarih Belirle</option>
                        </select>
                    </div>
                    
                    <div class="mb-1">
                        <label class="fw-bold small text-muted">Yeni Bitiş Tarihi</label>
                        <input type="date" id="swal-yeni-tarih" class="form-control fw-bold fs-5 text-primary" value="${varsayilanBitis}">
                    </div>
                    <small class="text-muted" id="bilgi-notu">Mevcut sürenin üzerine eklenir.</small>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Kaydet ve Uzat',
            confirmButtonColor: '#16a34a', // Yeşil
            didOpen: () => {
                const select = document.getElementById('swal-sure-tip');
                const dateInput = document.getElementById('swal-yeni-tarih');
                const bilgi = document.getElementById('bilgi-notu');

                // Fonksiyon: Seçime göre tarihi hesapla
                const tarihiGuncelle = () => {
                    const val = select.value;
                    
                    if (val === 'custom') {
                        // Özel tarihse kullanıcıya bırak, dokunma
                        bilgi.innerText = "İstediğiniz tarihi takvimden seçin.";
                        return; 
                    }

                    // Gün Ekleme Mantığı
                    const gunEkle = Number(val);
                    const yeniTarih = new Date(referansTarih); // Referans tarihi kopyala
                    yeniTarih.setDate(yeniTarih.getDate() + gunEkle);
                    
                    dateInput.value = formatDate(yeniTarih);
                    bilgi.innerText = `Referans tarihe ${gunEkle} gün eklendi.`;
                };

                // İlk açılışta hesapla (Varsayılan 1 Yıl)
                tarihiGuncelle();

                // Değişince tekrar hesapla
                select.addEventListener('change', tarihiGuncelle);
            },
            preConfirm: () => {
                const secilenTarih = document.getElementById('swal-yeni-tarih').value;
                if (!secilenTarih) {
                    Swal.showValidationMessage('Lütfen geçerli bir tarih seçiniz');
                }
                return secilenTarih;
            }
        });

        // 3. Kayıt İşlemi
        if (formValues) {
            try {
                // Seçilen tarihi gün sonuna (23:59) ayarla ki o gün tam kullanılabilsin
                const yeniBitis = new Date(formValues);
                yeniBitis.setHours(23, 59, 59, 999);

                await updateDoc(doc(db, "cooperatives", coopId), {
                    licenseEndDate: yeniBitis
                });

                Swal.fire({
                    icon: 'success',
                    title: 'Süre Uzatıldı',
                    text: `Yeni bitiş tarihi: ${yeniBitis.toLocaleDateString('tr-TR')}`,
                    timer: 2000,
                    showConfirmButton: false
                });

                sirketleriListele(); // Listeyi yenile

            } catch (e) {
                console.error(e);
                Swal.fire("Hata", e.message, "error");
            }
        }
    }
  
    
    window.sirketSil = async function(id) {
        if((await Swal.fire({title:'Silinsin mi?', text:'Bu işlem geri alınamaz.', icon:'warning', showCancelButton:true})).isConfirmed) {
            await deleteDoc(doc(db, "cooperatives", id));
            sirketleriListele();
            Swal.fire("Silindi", "", "success");
        }
    }

    window.modalAc = function() {
        const el = document.getElementById('createModal');
        new bootstrap.Modal(el).show();
    }
    
    window.cikisYap = async function() {
        await signOut(auth);
        window.location.href = "../index.html";
    }

</script>
</body>
</html>
